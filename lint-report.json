
> isri-shuangdi-spring-platform@0.1.0 lint
> eslint --format json

[{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/next.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/about/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/cad/export/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/fea/jobs/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/fea/run/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/freecad/drawing/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'stderr' is assigned a value but never used.","line":129,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":129,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { exec } from \"child_process\";\nimport { promisify } from \"util\";\nimport { writeFile, readFile, mkdir } from \"fs/promises\";\nimport { existsSync } from \"fs\";\nimport path from \"path\";\nimport { randomUUID } from \"crypto\";\n\nconst execAsync = promisify(exec);\n\n// FreeCAD Python 解释器路径\nconst FREECAD_PYTHON = process.platform === \"darwin\"\n  ? \"/Applications/FreeCAD.app/Contents/Resources/bin/python\"\n  : process.platform === \"win32\"\n    ? \"C:\\\\Program Files\\\\FreeCAD 0.21\\\\bin\\\\python.exe\"\n    : \"/usr/bin/python3\";\n\n// 脚本路径\nconst SCRIPT_PATH = path.join(process.cwd(), \"cad-worker/freecad/run_export.py\");\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { springType, geometry, material, analysis } = body;\n\n    // Check for CAD_WORKER_URL (Remote Worker)\n    const CAD_WORKER_URL = process.env.CAD_WORKER_URL;\n\n    // Prepare geometry with defaults\n    const processedGeometry = {\n      ...geometry,\n      // Ensure totalCoils is set (logic from original local implementation)\n      totalCoils: geometry.totalCoils || (geometry.activeCoils ? geometry.activeCoils + 2 : undefined),\n    };\n\n    if (CAD_WORKER_URL) {\n      try {\n        console.log(`[FreeCAD Drawing] Delegating to worker at ${CAD_WORKER_URL}`);\n\n        const workerPayload = {\n          springType,\n          geometry: processedGeometry,\n          export: {\n            formats: [\"SVG\"],\n            name: `drawing_${Date.now()}`,\n          },\n        };\n\n        const workerRes = await fetch(`${CAD_WORKER_URL}/generate`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(workerPayload),\n        });\n\n        if (!workerRes.ok) {\n          const errorText = await workerRes.text();\n          console.error(`[FreeCAD Drawing] Worker failed: ${workerRes.status} ${errorText}`);\n          throw new Error(`Cloud worker failed (${workerRes.status}): ${errorText.slice(0, 100)}`);\n        }\n\n        const workerData = await workerRes.json();\n\n        // Find SVG file\n        const svgFile = workerData.files?.find((f: { format: string }) => f.format === \"SVG\");\n\n        if (!svgFile || !svgFile.downloadUrl) {\n          throw new Error(\"Worker did not return SVG file\");\n        }\n\n        // Decode base64 SVG content\n        // downloadUrl is \"data:image/svg+xml;base64,...\" or similar\n        const base64Data = svgFile.downloadUrl.split(\",\")[1];\n        const svgContent = Buffer.from(base64Data, 'base64').toString('utf-8');\n\n        return NextResponse.json({\n          status: \"success\",\n          svg: svgContent,\n        });\n\n      } catch (e) {\n        console.error(`[FreeCAD Drawing] Worker error: ${e}`);\n        return NextResponse.json({\n          status: \"error\",\n          message: `Worker connection refused: ${e instanceof Error ? e.message : String(e)}`\n        }, { status: 502 });\n      }\n    }\n\n    // Local FreeCAD Fallback\n    // 检查 FreeCAD\n    if (!existsSync(FREECAD_PYTHON)) {\n      return NextResponse.json({\n        status: \"error\",\n        message: \"FreeCAD not installed (Local)\",\n      }, { status: 500 });\n    }\n\n    // 创建临时目录\n    const jobId = randomUUID();\n    const jobDir = path.join(process.cwd(), \".tmp/freecad-drawing\", jobId);\n    await mkdir(jobDir, { recursive: true });\n\n    // 准备设计文件\n    const exportName = `drawing_${jobId.slice(0, 8)}`;\n    const designFile = path.join(jobDir, \"design.json\");\n\n    await writeFile(designFile, JSON.stringify({\n      springType,\n      geometry: processedGeometry,\n      material,\n      analysis,\n      export: {\n        formats: [\"SVG\"],\n        name: exportName,\n      },\n    }, null, 2));\n\n    // 调用 FreeCAD\n    const command = `${FREECAD_PYTHON} ${SCRIPT_PATH} ${designFile} ${jobDir}`;\n    console.log(`[FreeCAD Drawing] Running: ${command}`);\n\n    let stdout: string, stderr: string;\n    try {\n      const result = await execAsync(command, {\n        timeout: 120000,\n        maxBuffer: 50 * 1024 * 1024,\n      });\n      stdout = result.stdout;\n      stderr = result.stderr;\n    } catch (execError) {\n      console.error(`[FreeCAD Drawing] Exec error:`, execError);\n      return NextResponse.json({\n        status: \"error\",\n        message: `FreeCAD execution failed: ${execError instanceof Error ? execError.message : 'Unknown error'}`,\n      }, { status: 500 });\n    }\n\n    console.log(`[FreeCAD Drawing] stdout: ${stdout}`);\n\n    // 查找生成的 SVG 文件\n    const svgPath = path.join(jobDir, `${exportName}.svg`);\n\n    if (!existsSync(svgPath)) {\n      return NextResponse.json({\n        status: \"error\",\n        message: \"SVG file not generated\",\n      }, { status: 500 });\n    }\n\n    // 读取 SVG 内容\n    const svgContent = await readFile(svgPath, \"utf-8\");\n\n    // 清理临时文件（延迟）\n    setTimeout(async () => {\n      try {\n        const { rm } = await import(\"fs/promises\");\n        await rm(jobDir, { recursive: true, force: true });\n      } catch (e) {\n        console.error(`[FreeCAD Drawing] Cleanup failed: ${e}`);\n      }\n    }, 30000);\n\n    return NextResponse.json({\n      status: \"success\",\n      svg: svgContent,\n    });\n\n  } catch (error) {\n    console.error(\"[FreeCAD Drawing] Error:\", error);\n    return NextResponse.json({\n      status: \"error\",\n      message: error instanceof Error ? error.message : \"Unknown error\",\n    }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/freecad/export/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FREECAD_PATHS_WINDOWS' is assigned a value but never used.","line":29,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FREECAD_PATHS_MACOS' is assigned a value but never used.","line":37,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":26},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":60,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":60,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'exportName' is assigned a value but never used.","line":226,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":226,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FreeCAD Export API\n * FreeCAD 导出 API\n * \n * POST /api/freecad/export\n * \n * 调用 FreeCAD 生成 STEP/IGES/STL 文件\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { exec } from \"child_process\";\nimport { promisify } from \"util\";\nimport { writeFile, readFile, mkdir } from \"fs/promises\";\nimport { existsSync } from \"fs\";\nimport path from \"path\";\n// Generate UUID without external dependency\nfunction generateUUID(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\nconst execAsync = promisify(exec);\n\n// FreeCAD 命令路径（根据系统配置）\n// Windows 默认安装路径\nconst FREECAD_PATHS_WINDOWS = [\n  \"C:\\\\Program Files\\\\FreeCAD 0.21\\\\bin\\\\FreeCADCmd.exe\",\n  \"C:\\\\Program Files\\\\FreeCAD 0.20\\\\bin\\\\FreeCADCmd.exe\",\n  \"C:\\\\Program Files\\\\FreeCAD\\\\bin\\\\FreeCADCmd.exe\",\n  \"C:\\\\Program Files (x86)\\\\FreeCAD\\\\bin\\\\FreeCADCmd.exe\",\n];\n\n// macOS 默认安装路径\nconst FREECAD_PATHS_MACOS = [\n  \"/Applications/FreeCAD.app/Contents/Resources/bin/freecadcmd\",\n  \"/Applications/FreeCAD.app/Contents/Resources/bin/freecad\",\n  \"/Applications/FreeCAD.app/Contents/MacOS/FreeCAD\",\n];\n\n// Linux 默认路径\nconst FREECAD_PATHS_LINUX = [\n  \"/usr/bin/freecadcmd\",\n  \"/usr/bin/freecad\",\n  \"/usr/local/bin/freecadcmd\",\n];\n\n// FreeCAD Python 解释器路径\nconst FREECAD_PYTHON_MACOS = \"/Applications/FreeCAD.app/Contents/Resources/bin/python\";\nconst FREECAD_PYTHON_WINDOWS = [\n  \"C:\\\\Program Files\\\\FreeCAD 0.21\\\\bin\\\\python.exe\",\n  \"C:\\\\Program Files\\\\FreeCAD 0.20\\\\bin\\\\python.exe\",\n  \"C:\\\\Program Files\\\\FreeCAD\\\\bin\\\\python.exe\",\n];\n\n// 获取 FreeCAD Python 解释器\nfunction getFreeCADPython(): string | null {\n  const fs = require(\"fs\");\n\n  if (process.env.FREECAD_PYTHON) {\n    return process.env.FREECAD_PYTHON;\n  }\n\n  if (process.platform === \"darwin\") {\n    if (fs.existsSync(FREECAD_PYTHON_MACOS)) {\n      return FREECAD_PYTHON_MACOS;\n    }\n  }\n\n  if (process.platform === \"win32\") {\n    for (const p of FREECAD_PYTHON_WINDOWS) {\n      if (fs.existsSync(p)) {\n        return `\"${p}\"`;\n      }\n    }\n  }\n\n  // Linux - 尝试系统 freecadcmd\n  for (const p of FREECAD_PATHS_LINUX) {\n    if (fs.existsSync(p)) {\n      return p;\n    }\n  }\n\n  return null;\n}\n\nconst FREECAD_PYTHON = getFreeCADPython();\nconst SCRIPT_PATH = path.join(process.cwd(), \"cad-worker/freecad/run_export.py\");\nconst TEMP_DIR = path.join(process.cwd(), \".tmp/freecad\");\n\ninterface ExportRequest {\n  springType: \"compression\" | \"extension\" | \"torsion\" | \"conical\";\n  geometry: {\n    wireDiameter: number;\n    meanDiameter?: number;\n    outerDiameter?: number;\n    activeCoils: number;\n    totalCoils?: number;\n    freeLength?: number;\n    bodyLength?: number;\n    // Extension\n    hookType?: string;\n    hookRadius?: number;\n    hookAngle?: number;\n    // Torsion\n    legLength1?: number;\n    legLength2?: number;\n    windingDirection?: \"left\" | \"right\";\n    freeAngle?: number;\n    // Conical\n    largeOuterDiameter?: number;\n    smallOuterDiameter?: number;\n  };\n  export: {\n    formats: (\"STEP\" | \"IGES\" | \"STL\" | \"FCStd\")[];\n    name?: string;\n  };\n}\n\ninterface ExportResponse {\n  status: \"success\" | \"error\" | \"unavailable\";\n  message?: string;\n  files?: {\n    format: string;\n    fileName: string;\n    downloadUrl: string;\n    fileSize?: number;\n  }[];\n  jobId?: string;\n}\n\n/**\n * 检查 FreeCAD 是否可用\n */\nasync function checkFreeCADAvailable(): Promise<boolean> {\n  if (!FREECAD_PYTHON) {\n    return false;\n  }\n  try {\n    await execAsync(`${FREECAD_PYTHON} --version`);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * POST /api/freecad/export\n */\nexport async function POST(request: NextRequest): Promise<NextResponse<ExportResponse>> {\n  try {\n    const body: ExportRequest = await request.json();\n\n    // Check if CAD_WORKER_URL is set\n    const CAD_WORKER_URL = process.env.CAD_WORKER_URL;\n\n    // If Worker URL is set, try to define to it first\n    if (CAD_WORKER_URL) {\n      try {\n        console.log(`[FreeCAD] Delegating to worker at ${CAD_WORKER_URL}`);\n        const workerRes = await fetch(`${CAD_WORKER_URL}/generate`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(body),\n        });\n\n        if (!workerRes.ok) {\n          const errorText = await workerRes.text();\n          throw new Error(`Worker returned ${workerRes.status}: ${errorText}`);\n        }\n\n        const workerData = await workerRes.json();\n        return NextResponse.json(workerData);\n      } catch (e) {\n        console.error(`[FreeCAD] Worker delegation failed: ${e}`);\n        // Return 502 Bad Gateway to indicate upstream worker failure\n        return NextResponse.json({\n          status: \"error\",\n          message: `Cloud CAD worker failed: ${e instanceof Error ? e.message : String(e)}`\n        }, { status: 502 });\n      }\n    }\n\n    // 验证请求\n    if (!body.springType || !body.geometry) {\n      return NextResponse.json({\n        status: \"error\",\n        message: \"Missing required fields: springType, geometry\",\n      }, { status: 400 });\n    }\n\n    // 检查 FreeCAD 是否可用\n    const freecadAvailable = await checkFreeCADAvailable();\n    if (!freecadAvailable) {\n      // FreeCAD 不可用，返回模拟响应\n      return NextResponse.json({\n        status: \"unavailable\",\n        message: \"FreeCAD is not installed locally and no remote worker configured.\",\n        files: body.export.formats.map(format => ({\n          format,\n          fileName: `${body.export.name || body.springType}_spring.${format.toLowerCase()}`,\n          downloadUrl: \"#\",\n          fileSize: 0,\n        })),\n      });\n    }\n\n    // 创建临时目录\n    if (!existsSync(TEMP_DIR)) {\n      await mkdir(TEMP_DIR, { recursive: true });\n    }\n\n    // 生成唯一 ID\n    const jobId = generateUUID();\n    const jobDir = path.join(TEMP_DIR, jobId);\n    await mkdir(jobDir, { recursive: true });\n\n    // 写入设计文件\n    const designFile = path.join(jobDir, \"design.json\");\n    await writeFile(designFile, JSON.stringify(body, null, 2));\n\n    // 调用 FreeCAD Python\n    const exportName = body.export.name || `${body.springType}_spring`;\n    const command = `${FREECAD_PYTHON} ${SCRIPT_PATH} ${designFile} ${jobDir}`;\n\n    console.log(`[FreeCAD] Running: ${command}`);\n\n    const { stdout, stderr } = await execAsync(command, {\n      timeout: 60000, // 60 秒超时\n      maxBuffer: 10 * 1024 * 1024, // 10MB\n    });\n\n    console.log(`[FreeCAD] stdout: ${stdout}`);\n    if (stderr) {\n      console.error(`[FreeCAD] stderr: ${stderr}`);\n    }\n\n    // 解析结果\n    const resultMatch = stdout.match(/RESULT_JSON:(.+)/);\n    if (!resultMatch) {\n      return NextResponse.json({\n        status: \"error\",\n        message: \"Failed to parse FreeCAD output\",\n      }, { status: 500 });\n    }\n\n    const result = JSON.parse(resultMatch[1]);\n\n    // 构建下载 URL\n    const files = await Promise.all(\n      result.files.map(async (file: { format: string; path: string }) => {\n        const filePath = file.path;\n        const fileName = path.basename(filePath);\n\n        // 读取文件并转为 base64 data URL\n        const fileBuffer = await readFile(filePath);\n        const base64 = fileBuffer.toString(\"base64\");\n\n        // 确定 MIME 类型\n        const mimeTypes: Record<string, string> = {\n          STEP: \"application/step\",\n          IGES: \"application/iges\",\n          STL: \"application/sla\",\n          FCSTD: \"application/octet-stream\",\n        };\n        const mimeType = mimeTypes[file.format] || \"application/octet-stream\";\n\n        return {\n          format: file.format,\n          fileName,\n          downloadUrl: `data:${mimeType};base64,${base64}`,\n          fileSize: fileBuffer.length,\n        };\n      })\n    );\n\n    // 清理临时文件（延迟执行）\n    setTimeout(async () => {\n      try {\n        const { rm } = await import(\"fs/promises\");\n        await rm(jobDir, { recursive: true, force: true });\n      } catch (e) {\n        console.error(`[FreeCAD] Cleanup failed: ${e}`);\n      }\n    }, 60000); // 1 分钟后清理\n\n    return NextResponse.json({\n      status: \"success\",\n      jobId,\n      files,\n    });\n\n  } catch (error) {\n    console.error(\"[FreeCAD] Export error:\", error);\n\n    return NextResponse.json({\n      status: \"error\",\n      message: error instanceof Error ? error.message : \"Unknown error\",\n    }, { status: 500 });\n  }\n}\n\n/**\n * GET /api/freecad/export\n * 检查 FreeCAD 状态\n */\nexport async function GET(): Promise<NextResponse> {\n  // Check if remote worker is configured\n  if (process.env.CAD_WORKER_URL) {\n    return NextResponse.json({\n      available: true,\n      version: \"Remote Worker (Fly.io)\",\n      capabilities: [\"STEP\", \"IGES\", \"STL\", \"FCStd\"],\n    });\n  }\n\n  const available = await checkFreeCADAvailable();\n\n  if (available && FREECAD_PYTHON) {\n    try {\n      const { stdout } = await execAsync(`${FREECAD_PYTHON} -c \"import FreeCAD; print(FreeCAD.Version())\"`);\n      return NextResponse.json({\n        available: true,\n        version: stdout.trim(),\n        capabilities: [\"STEP\", \"IGES\", \"STL\", \"FCStd\"],\n      });\n    } catch {\n      return NextResponse.json({\n        available: true,\n        version: \"FreeCAD (version check failed)\",\n        capabilities: [\"STEP\", \"IGES\", \"STL\", \"FCStd\"],\n      });\n    }\n  }\n\n  return NextResponse.json({\n    available: false,\n    message: \"FreeCAD is not installed. Please download and install FreeCAD to enable CAD export.\",\n    installInstructions: {\n      windows: {\n        url: \"https://github.com/FreeCAD/FreeCAD/releases/download/0.21.2/FreeCAD-0.21.2-WIN-x64-installer-1.exe\",\n        steps: [\n          \"1. Download FreeCAD installer from the link above\",\n          \"2. Run the installer and follow the prompts\",\n          \"3. Default install path: C:\\\\Program Files\\\\FreeCAD 0.21\",\n          \"4. Restart the application after installation\",\n        ],\n      },\n      macOS: {\n        command: \"brew install --cask freecad\",\n        url: \"https://github.com/FreeCAD/FreeCAD/releases/download/0.21.2/FreeCAD-0.21.2-macOS-arm64.dmg\",\n      },\n      linux: {\n        command: \"sudo apt install freecad\",\n        url: \"https://github.com/FreeCAD/FreeCAD/releases\",\n      },\n    },\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/freecad/preview/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FREECAD_PATHS_WINDOWS' is assigned a value but never used.","line":29,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FREECAD_PATHS_MACOS' is assigned a value but never used.","line":35,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":26},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":56,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":56,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FreeCAD Preview API\n * FreeCAD 预览 API\n * \n * POST /api/freecad/preview\n * \n * 调用 FreeCAD 生成 3D 模型并返回 OBJ/glTF 用于 Web 预览\n */\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { exec } from \"child_process\";\nimport { promisify } from \"util\";\nimport { writeFile, readFile, mkdir } from \"fs/promises\";\nimport { existsSync } from \"fs\";\nimport path from \"path\";\n\nconst execAsync = promisify(exec);\n\n// Generate UUID\nfunction generateUUID(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\n// FreeCAD 命令路径\nconst FREECAD_PATHS_WINDOWS = [\n  \"C:\\\\Program Files\\\\FreeCAD 0.21\\\\bin\\\\FreeCADCmd.exe\",\n  \"C:\\\\Program Files\\\\FreeCAD 0.20\\\\bin\\\\FreeCADCmd.exe\",\n  \"C:\\\\Program Files\\\\FreeCAD\\\\bin\\\\FreeCADCmd.exe\",\n];\n\nconst FREECAD_PATHS_MACOS = [\n  \"/Applications/FreeCAD.app/Contents/Resources/bin/freecadcmd\",\n  \"/Applications/FreeCAD.app/Contents/Resources/bin/freecad\",\n  \"/Applications/FreeCAD.app/Contents/MacOS/FreeCAD\",\n];\n\nconst FREECAD_PATHS_LINUX = [\n  \"/usr/bin/freecadcmd\",\n  \"/usr/bin/freecad\",\n  \"/usr/local/bin/freecadcmd\",\n];\n\n// FreeCAD Python 解释器路径\nconst FREECAD_PYTHON_MACOS = \"/Applications/FreeCAD.app/Contents/Resources/bin/python\";\nconst FREECAD_PYTHON_WINDOWS = [\n  \"C:\\\\Program Files\\\\FreeCAD 0.21\\\\bin\\\\python.exe\",\n  \"C:\\\\Program Files\\\\FreeCAD 0.20\\\\bin\\\\python.exe\",\n  \"C:\\\\Program Files\\\\FreeCAD\\\\bin\\\\python.exe\",\n];\n\nfunction getFreeCADPython(): string | null {\n  const fs = require(\"fs\");\n\n  if (process.env.FREECAD_PYTHON) {\n    return process.env.FREECAD_PYTHON;\n  }\n\n  if (process.platform === \"darwin\") {\n    if (fs.existsSync(FREECAD_PYTHON_MACOS)) {\n      return FREECAD_PYTHON_MACOS;\n    }\n  }\n\n  if (process.platform === \"win32\") {\n    for (const p of FREECAD_PYTHON_WINDOWS) {\n      if (fs.existsSync(p)) {\n        return `\"${p}\"`;\n      }\n    }\n  }\n\n  for (const p of FREECAD_PATHS_LINUX) {\n    if (fs.existsSync(p)) {\n      return p;\n    }\n  }\n\n  return null;\n}\n\nconst FREECAD_PYTHON = getFreeCADPython();\nconst SCRIPT_PATH = path.join(process.cwd(), \"cad-worker/freecad/run_export.py\");\nconst TEMP_DIR = path.join(process.cwd(), \".tmp/freecad-preview\");\n\ninterface PreviewRequest {\n  springType: \"compression\" | \"extension\" | \"torsion\" | \"conical\" | \"spiral_torsion\" | \"spiralTorsion\";\n  geometry: {\n    wireDiameter?: number;\n    meanDiameter?: number;\n    outerDiameter?: number;\n    activeCoils?: number;\n    totalCoils?: number;\n    freeLength?: number;\n    bodyLength?: number;\n    hookType?: string;\n    legLength1?: number;\n    legLength2?: number;\n    windingDirection?: \"left\" | \"right\";\n    // Torsion specific\n    freeAngle?: number;\n    workingAngle?: number;\n    // Conical specific\n    largeOuterDiameter?: number;\n    smallOuterDiameter?: number;\n    endType?: \"natural\" | \"closed\" | \"closed_ground\";\n    // Compression specific\n    topGround?: boolean;\n    bottomGround?: boolean;\n    // Spiral Torsion specific\n    innerDiameter?: number;\n    turns?: number;\n    stripWidth?: number;\n    stripThickness?: number;\n    handedness?: \"cw\" | \"ccw\";\n  };\n}\n\n/**\n * 检查 FreeCAD 是否可用\n */\nasync function checkFreeCADAvailable(): Promise<boolean> {\n  if (!FREECAD_PYTHON) {\n    return false;\n  }\n  try {\n    await execAsync(`${FREECAD_PYTHON} --version`);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * POST /api/freecad/preview\n * 生成 3D 预览模型\n */\nexport async function POST(request: NextRequest): Promise<NextResponse> {\n  try {\n    const body: PreviewRequest = await request.json();\n\n    if (!body.springType || !body.geometry) {\n      return NextResponse.json({\n        status: \"error\",\n        message: \"Missing required fields\",\n      }, { status: 400 });\n    }\n\n    // Check if CAD_WORKER_URL is set\n    const CAD_WORKER_URL = process.env.CAD_WORKER_URL;\n\n    // If Worker URL is set, try to define to it first\n    if (CAD_WORKER_URL) {\n      try {\n        console.log(`[FreeCAD Preview] Delegating to worker at ${CAD_WORKER_URL}`);\n\n        // Prepare payload for worker (same format as export but requesting STL)\n        // Note: The worker needs \"export\" field with formats=[\"STL\"]\n        const workerPayload = {\n          springType: body.springType === \"spiralTorsion\" ? \"spiral_torsion\" : body.springType,\n          geometry: body.geometry,\n          export: {\n            formats: [\"STL\"],\n            name: `preview_${Date.now()}`,\n          },\n        };\n\n        const workerRes = await fetch(`${CAD_WORKER_URL}/generate`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(workerPayload),\n        });\n\n        if (!workerRes.ok) {\n          const errorText = await workerRes.text();\n          console.error(`[FreeCAD Preview] Worker failed: ${workerRes.status} ${errorText}`);\n          return NextResponse.json({\n            status: \"error\",\n            message: `Cloud worker failed (${workerRes.status}): ${errorText.slice(0, 100)}`\n          }, { status: 500 });\n        }\n\n        const workerData = await workerRes.json();\n\n        // The worker returns { status: \"success\", files: [...] }\n        // We need to adapt it to the preview response format: { status: \"success\", data: base64 }\n\n        const stlFile = workerData.files?.find((f: { format: string }) => f.format === \"STL\");\n\n        if (!stlFile || !stlFile.downloadUrl) {\n          return NextResponse.json({\n            status: \"error\",\n            message: \"Worker did not return STL file\"\n          }, { status: 500 });\n        }\n\n        // downloadUrl is \"data:application/sla;base64,...\"\n        // We need just the base64 part\n        const base64Data = stlFile.downloadUrl.split(\",\")[1];\n\n        return NextResponse.json({\n          status: \"success\",\n          format: \"stl\",\n          data: base64Data,\n          mimeType: \"application/sla\",\n        });\n\n      } catch (e) {\n        console.error(`[FreeCAD Preview] Worker error: ${e}`);\n        // If the worker is configured but unreachable, we should probably fail rather than fallback, \n        // to avoid misleading \"Not Installed\" message.\n        return NextResponse.json({\n          status: \"error\", // Use error status, not unavailable\n          message: `Worker connection refused: ${e instanceof Error ? e.message : String(e)}`\n        }, { status: 502 });\n      }\n    }\n\n    // 检查 FreeCAD\n    const available = await checkFreeCADAvailable();\n    if (!available) {\n      return NextResponse.json({\n        status: \"unavailable\",\n        message: \"FreeCAD is not installed\",\n      });\n    }\n\n    // 创建临时目录\n    if (!existsSync(TEMP_DIR)) {\n      await mkdir(TEMP_DIR, { recursive: true });\n    }\n\n    const jobId = generateUUID();\n    const jobDir = path.join(TEMP_DIR, jobId);\n    await mkdir(jobDir, { recursive: true });\n\n    // 写入设计文件 - 请求 STL 格式用于预览\n    const designFile = path.join(jobDir, \"design.json\");\n    const exportName = `preview_${jobId}`;\n\n    // 标准化 springType: spiralTorsion -> spiral_torsion\n    const normalizedSpringType = body.springType === \"spiralTorsion\" ? \"spiral_torsion\" : body.springType;\n\n    const designData = {\n      springType: normalizedSpringType,\n      geometry: body.geometry,\n      export: {\n        formats: [\"STL\"],  // 使用 STL 格式，Three.js 可以直接加载\n        name: exportName,\n      },\n    };\n\n    console.log(`[FreeCAD Preview] Design data:`, JSON.stringify(designData, null, 2));\n\n    await writeFile(designFile, JSON.stringify(designData, null, 2));\n\n    // 调用 FreeCAD Python\n    const command = `${FREECAD_PYTHON} ${SCRIPT_PATH} ${designFile} ${jobDir}`;\n    console.log(`[FreeCAD Preview] Running: ${command}`);\n\n    let stdout: string, stderr: string;\n    try {\n      const result = await execAsync(command, {\n        timeout: 120000,  // 增加到 120 秒\n        maxBuffer: 50 * 1024 * 1024,  // 50MB\n      });\n      stdout = result.stdout;\n      stderr = result.stderr;\n    } catch (execError) {\n      console.error(`[FreeCAD Preview] Exec error:`, execError);\n      return NextResponse.json({\n        status: \"error\",\n        message: `FreeCAD execution failed: ${execError instanceof Error ? execError.message : 'Unknown error'}`,\n      }, { status: 500 });\n    }\n\n    console.log(`[FreeCAD Preview] stdout:\\n${stdout}`);\n    if (stderr) {\n      console.error(`[FreeCAD Preview] stderr:\\n${stderr}`);\n    }\n\n    // 检查是否执行了端面磨平\n    if (stdout.includes(\"should_grind=True\")) {\n      console.log(`[FreeCAD Preview] Ground ends should be applied`);\n    }\n    if (stdout.includes(\"Conical spring ground ends:\")) {\n      console.log(`[FreeCAD Preview] Ground ends were applied successfully`);\n    }\n\n    // 解析结果\n    const resultMatch = stdout.match(/RESULT_JSON:(.+)/);\n    if (!resultMatch) {\n      return NextResponse.json({\n        status: \"error\",\n        message: `Failed to parse FreeCAD output. stdout: ${stdout.slice(0, 500)}`,\n      }, { status: 500 });\n    }\n\n    const result = JSON.parse(resultMatch[1]);\n\n    // 读取生成的 STL 文件\n    const stlFile = result.files.find((f: { format: string }) => f.format === \"STL\");\n    if (!stlFile) {\n      return NextResponse.json({\n        status: \"error\",\n        message: \"STL file not generated\",\n      }, { status: 500 });\n    }\n\n    const stlBuffer = await readFile(stlFile.path);\n    const stlBase64 = stlBuffer.toString(\"base64\");\n\n    // 清理临时文件（延迟）\n    setTimeout(async () => {\n      try {\n        const { rm } = await import(\"fs/promises\");\n        await rm(jobDir, { recursive: true, force: true });\n      } catch (e) {\n        console.error(`[FreeCAD Preview] Cleanup failed: ${e}`);\n      }\n    }, 30000);\n\n    return NextResponse.json({\n      status: \"success\",\n      format: \"stl\",\n      data: stlBase64,\n      mimeType: \"application/sla\",\n    });\n\n  } catch (error) {\n    console.error(\"[FreeCAD Preview] Error:\", error);\n\n    return NextResponse.json({\n      status: \"error\",\n      message: error instanceof Error ? error.message : \"Unknown error\",\n    }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/manufacturing/summary/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/production/captures/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/production/dashboard/route.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/production/dashboard/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/production/state/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/quality/analyze/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2387,2390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2387,2390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\n\nimport {\n  analyzeDataset,\n  inferMapping,\n  loadDataset,\n  saveAnalysis,\n} from \"@/lib/quality\";\nimport type { FieldMapping, QualityAnalysisResult, QualityDataset } from \"@/lib/quality\";\n\ntype QualityAnalyzeRequest = {\n  datasetId?: string;\n  dataset?: QualityDataset;\n  mapping?: FieldMapping;\n  options?: {\n    stratifyBy?: string;\n  };\n};\n\ntype QualityAnalyzeResponse = {\n  analysis: QualityAnalysisResult;\n};\n\nfunction normalizeMapping(mapping: FieldMapping): FieldMapping {\n  const clean = (x: string | undefined) => {\n    const v = x?.trim();\n    return v ? v : undefined;\n  };\n\n  return {\n    value: mapping.value,\n    timestamp: clean(mapping.timestamp),\n    characteristic: clean(mapping.characteristic),\n    partId: clean(mapping.partId),\n    lot: clean(mapping.lot),\n    machine: clean(mapping.machine),\n    shift: clean(mapping.shift),\n    appraiser: clean(mapping.appraiser),\n    gage: clean(mapping.gage),\n    trial: clean(mapping.trial),\n    subgroupId: clean(mapping.subgroupId),\n    unit: clean(mapping.unit),\n    lsl: clean(mapping.lsl),\n    usl: clean(mapping.usl),\n    target: clean(mapping.target),\n    result: clean(mapping.result),\n    tagColumns: mapping.tagColumns?.map((c) => c.trim()).filter(Boolean),\n  };\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = (await req.json()) as QualityAnalyzeRequest;\n\n    // Support both inline dataset (serverless) and datasetId (persistent storage)\n    let dataset: QualityDataset | null = null;\n\n    if (body.dataset && body.dataset.headers && body.dataset.rows) {\n      dataset = body.dataset;\n    } else if (body.datasetId) {\n      dataset = await loadDataset(body.datasetId);\n    }\n\n    if (!dataset) {\n      return NextResponse.json(\n        {\n          error:\n            \"Dataset not found. Please provide dataset inline or re-upload if running on serverless.\",\n        },\n        { status: 404 }\n      );\n    }\n\n    const defaultMapping = dataset.inferredMapping ?? inferMapping(dataset.headers).mapping;\n    const mapping = normalizeMapping(body.mapping ?? defaultMapping);\n\n    if (!mapping.value) {\n      return NextResponse.json({ error: \"mapping.value is required\" }, { status: 400 });\n    }\n\n    const analysis = analyzeDataset({\n      dataset,\n      mapping,\n      options: {\n        stratifyBy: body.options?.stratifyBy as any,\n      },\n    });\n    // Try to save analysis (may fail on serverless)\n    try {\n      await saveAnalysis(analysis);\n    } catch {\n      // Ignore save errors on serverless\n    }\n\n    const response: QualityAnalyzeResponse = { analysis };\n    return NextResponse.json(response);\n  } catch (e: unknown) {\n    const message = e instanceof Error ? e.message : \"Unknown error\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/quality/ingest/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/reports/arc-spring/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":324,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":324,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9051,9054],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9051,9054],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { renderToBuffer } from \"@react-pdf/renderer\";\nimport { Document, Page, Text, View, StyleSheet, Svg, Path, Line } from \"@react-pdf/renderer\";\nimport { createElement } from \"react\";\n\nimport type { ArcSpringInput, ArcSpringResult } from \"@/lib/arcSpring\";\n\ntype ArcSpringReportPayload = {\n  input: ArcSpringInput;\n  result: ArcSpringResult;\n  meta?: {\n    title?: string;\n    projectName?: string;\n    engineer?: string;\n    language?: \"en\" | \"zh\" | \"bilingual\";\n  };\n};\n\nconst styles = StyleSheet.create({\n  page: {\n    padding: 40,\n    fontSize: 10,\n    fontFamily: \"Helvetica\",\n    color: \"#0f172a\",\n  },\n  header: {\n    marginBottom: 16,\n    borderBottom: \"2px solid #2563eb\",\n    paddingBottom: 10,\n  },\n  title: {\n    fontSize: 18,\n    fontWeight: \"bold\",\n    color: \"#1d4ed8\",\n  },\n  subtitle: {\n    fontSize: 9,\n    color: \"#64748b\",\n    marginTop: 4,\n  },\n  headerMetaRow: {\n    flexDirection: \"row\",\n    justifyContent: \"space-between\",\n    marginTop: 6,\n  },\n  headerMeta: {\n    fontSize: 9,\n    color: \"#64748b\",\n  },\n  section: {\n    marginBottom: 14,\n  },\n  sectionTitle: {\n    fontSize: 12,\n    fontWeight: \"bold\",\n    color: \"#1e293b\",\n    borderBottom: \"1px solid #e2e8f0\",\n    paddingBottom: 4,\n    marginBottom: 8,\n  },\n  grid2: {\n    flexDirection: \"row\",\n  },\n  card: {\n    flexGrow: 1,\n    border: \"1px solid #e2e8f0\",\n    borderRadius: 4,\n    padding: 8,\n    backgroundColor: \"#f8fafc\",\n  },\n  row: {\n    flexDirection: \"row\",\n    justifyContent: \"space-between\",\n    marginBottom: 3,\n  },\n  label: {\n    color: \"#64748b\",\n    flexGrow: 1,\n  },\n  value: {\n    fontWeight: \"bold\",\n    textAlign: \"right\",\n    flexShrink: 0,\n    marginLeft: 8,\n  },\n  badge: {\n    paddingHorizontal: 6,\n    paddingVertical: 2,\n    borderRadius: 10,\n    fontSize: 9,\n    color: \"#ffffff\",\n    alignSelf: \"flex-start\",\n    marginBottom: 6,\n  },\n  message: {\n    fontSize: 9,\n    color: \"#475569\",\n    marginBottom: 2,\n  },\n  footer: {\n    position: \"absolute\",\n    bottom: 28,\n    left: 40,\n    right: 40,\n    textAlign: \"center\",\n    color: \"#94a3b8\",\n    fontSize: 8,\n  },\n  chartWrap: {\n    marginTop: 6,\n    border: \"1px solid #e2e8f0\",\n    borderRadius: 4,\n    backgroundColor: \"#ffffff\",\n  },\n  chartTitle: {\n    fontSize: 9,\n    color: \"#334155\",\n    marginBottom: 4,\n    fontWeight: \"bold\",\n  },\n});\n\nfunction fmt(value: unknown, decimals = 2): string {\n  const n = typeof value === \"number\" ? value : Number.NaN;\n  if (!isFinite(n)) return \"—\";\n  return Number(n.toFixed(decimals)).toLocaleString();\n}\n\nfunction t(lang: NonNullable<ArcSpringReportPayload[\"meta\"]>[\"language\"], en: string, zh: string): string {\n  if (lang === \"zh\") return zh;\n  if (lang === \"en\") return en;\n  return `${en} / ${zh}`;\n}\n\nfunction kv(label: string, value: string) {\n  return createElement(\n    View,\n    { style: styles.row },\n    createElement(Text, { style: styles.label }, label),\n    createElement(Text, { style: styles.value }, value)\n  );\n}\n\ntype XY = { x: number; y: number };\n\nfunction linePath(points: XY[], xScale: (x: number) => number, yScale: (y: number) => number): string {\n  if (points.length < 2) return \"\";\n  return points\n    .map((p, i) => {\n      const x = xScale(p.x);\n      const y = yScale(p.y);\n      return `${i === 0 ? \"M\" : \"L\"} ${x.toFixed(1)} ${y.toFixed(1)}`;\n    })\n    .join(\" \");\n}\n\nfunction SimpleChart({\n  title,\n  load,\n  unload,\n}: {\n  title: string;\n  load: XY[];\n  unload: XY[];\n}) {\n  const width = 520;\n  const height = 220;\n  const padding = { left: 30, right: 10, top: 12, bottom: 22 };\n  const innerW = width - padding.left - padding.right;\n  const innerH = height - padding.top - padding.bottom;\n\n  const allPts = [...load, ...unload];\n  const xs = allPts.map((p) => p.x);\n  const ys = allPts.map((p) => p.y);\n  const xMin = xs.length ? Math.min(...xs) : 0;\n  const xMax = xs.length ? Math.max(...xs) : 1;\n  const yMin = ys.length ? Math.min(...ys) : 0;\n  const yMax = ys.length ? Math.max(...ys) : 1;\n\n  const xSpan = Math.max(1e-9, xMax - xMin);\n  const ySpan = Math.max(1e-9, yMax - yMin);\n\n  const xScale = (x: number) => padding.left + ((x - xMin) / xSpan) * innerW;\n  const yScale = (y: number) => padding.top + innerH - ((y - yMin) / ySpan) * innerH;\n\n  return createElement(\n    View,\n    { style: styles.chartWrap },\n    createElement(Text, { style: styles.chartTitle }, title),\n    createElement(\n      Svg,\n      { width, height, viewBox: `0 0 ${width} ${height}` },\n      createElement(Line, {\n        x1: padding.left,\n        y1: padding.top + innerH,\n        x2: width - padding.right,\n        y2: padding.top + innerH,\n        stroke: \"#94a3b8\",\n        strokeWidth: 1,\n      }),\n      createElement(Line, {\n        x1: padding.left,\n        y1: padding.top,\n        x2: padding.left,\n        y2: padding.top + innerH,\n        stroke: \"#94a3b8\",\n        strokeWidth: 1,\n      }),\n      createElement(Path, {\n        d: linePath(load, xScale, yScale),\n        fill: \"none\",\n        stroke: \"#2563eb\",\n        strokeWidth: 2,\n      }),\n      createElement(Path, {\n        d: linePath(unload, xScale, yScale),\n        fill: \"none\",\n        stroke: \"#ea580c\",\n        strokeWidth: 2,\n      })\n    )\n  );\n}\n\nfunction ArcSpringReportPDF({ data }: { data: ArcSpringReportPayload }) {\n  const input = data.input;\n  const result = data.result;\n  const lang = data.meta?.language ?? \"bilingual\";\n\n  const title = data.meta?.title ?? t(lang, \"Arc Spring Report\", \"弧形弹簧报告\");\n  const generatedAt = new Date().toLocaleString();\n  const project = data.meta?.projectName ?? \"—\";\n  const engineer = data.meta?.engineer ?? \"—\";\n\n  const badgeColor = (ryg: \"green\" | \"yellow\" | \"red\") => {\n    if (ryg === \"green\") return \"#16a34a\";\n    if (ryg === \"yellow\") return \"#f59e0b\";\n    return \"#dc2626\";\n  };\n\n  const tauMax = result.tauMax;\n  const status: \"green\" | \"yellow\" | \"red\" =\n    isFinite(tauMax) && tauMax > 0 && tauMax <= 800 ? \"green\" : isFinite(tauMax) && tauMax > 0 && tauMax <= 1000 ? \"yellow\" : \"red\";\n\n  const ptsLoad: XY[] = (result.curve ?? []).map((p) => ({ x: p.deltaDeg, y: p.M_load }));\n  const ptsUnload: XY[] = (result.curve ?? []).map((p) => ({ x: p.deltaDeg, y: p.M_unload }));\n\n  return createElement(\n    Document,\n    {},\n    createElement(\n      Page,\n      { size: \"A4\", style: styles.page },\n      createElement(\n        View,\n        { style: styles.header },\n        createElement(Text, { style: styles.title }, title),\n        createElement(Text, { style: styles.subtitle }, `${t(lang, \"Generated\", \"生成\")}: ${generatedAt}`),\n        createElement(\n          View,\n          { style: styles.headerMetaRow },\n          createElement(Text, { style: styles.headerMeta }, `${t(lang, \"Project\", \"项目\")}: ${project}`),\n          createElement(Text, { style: styles.headerMeta }, `${t(lang, \"Engineer\", \"工程师\")}: ${engineer}`)\n        )\n      ),\n\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, \"Inputs\", \"输入\")),\n        createElement(\n          View,\n          { style: styles.grid2 },\n          createElement(\n            View,\n            { style: styles.card },\n            createElement(Text, { style: [styles.badge, { backgroundColor: badgeColor(status) }] }, `${t(lang, \"Status\", \"判定\")}: ${status.toUpperCase()}`),\n            kv(\"d (mm)\", fmt(input.d, 2)),\n            kv(\"D (mm)\", fmt(input.D, 2)),\n            kv(\"n\", fmt(input.n, 2)),\n            kv(\"r (mm)\", fmt(input.r, 2)),\n            kv(\"alpha0 (deg)\", fmt(input.alpha0, 1)),\n            kv(\"alphaC (deg)\", fmt(input.alphaC, 1))\n          ),\n          createElement(\n            View,\n            { style: [styles.card, { marginLeft: 10 }] },\n            kv(\"k (N/mm)\", fmt(result.k, 2)),\n            kv(\"R (N·mm/deg)\", fmt(result.R_deg, 2)),\n            kv(\"MMax_load (N·mm)\", fmt(result.MMax_load, 0)),\n            kv(\"MMax_unload (N·mm)\", fmt(result.MMax_unload, 0)),\n            kv(\"tauMax (MPa)\", fmt(result.tauMax, 0)),\n            kv(\"springIndex C\", fmt(result.springIndex, 2))\n          )\n        )\n      ),\n\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, \"Torque-Angle\", \"扭矩-角度\")),\n        createElement(SimpleChart, {\n          title: t(lang, \"Torque vs. Delta Angle\", \"扭矩-转角曲线\"),\n          load: ptsLoad,\n          unload: ptsUnload,\n        })\n      ),\n\n      (result.warnings?.length ?? 0) > 0\n        ? createElement(\n            View,\n            { style: styles.section },\n            createElement(Text, { style: styles.sectionTitle }, t(lang, \"Warnings\", \"警告\")),\n            ...(result.warnings ?? []).slice(0, 8).map((w, i) => createElement(Text, { key: i, style: styles.message }, `- ${w}`))\n          )\n        : null,\n\n      createElement(\n        Text,\n        {\n          style: styles.footer,\n          render: ({ pageNumber, totalPages }: { pageNumber: number; totalPages: number }) => `${pageNumber} / ${totalPages}`,\n          fixed: true,\n        } as any,\n        \"\"\n      )\n    )\n  );\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const data = (await req.json()) as ArcSpringReportPayload;\n    if (!data?.input || !data?.result) {\n      return NextResponse.json({ error: \"Invalid payload\" }, { status: 400 });\n    }\n\n    const pdfElement = createElement(ArcSpringReportPDF, { data });\n    // @ts-expect-error - renderToBuffer types are not fully compatible with createElement\n    const pdfBuffer = await renderToBuffer(pdfElement);\n\n    return new NextResponse(Buffer.from(pdfBuffer), {\n      status: 200,\n      headers: {\n        \"Content-Type\": \"application/pdf\",\n        \"Content-Disposition\": `attachment; filename=\"arc-spring-report-${Date.now()}.pdf\"`,\n      },\n    });\n  } catch (e: unknown) {\n    const message = e instanceof Error ? e.message : \"Unknown error\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/reports/compression-ppap/route.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/reports/compression-ppap/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/reports/conical/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/reports/quality-analysis/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2667,2670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2667,2670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2716,2719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2716,2719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { renderToBuffer } from \"@react-pdf/renderer\";\nimport { createElement } from \"react\";\n\nimport {\n  analyzeDataset,\n  inferMapping,\n  loadAnalysis,\n  loadDataset,\n  saveAnalysis,\n} from \"@/lib/quality\";\nimport type { FieldMapping, QualityDataset } from \"@/lib/quality\";\nimport {\n  generateQualityAnalysisReportHTML,\n  QualityAnalysisReportPDF,\n  type QualityAnalysisReportModel,\n} from \"@/lib/quality\";\n\ntype QualityReportRequest = {\n  datasetId?: string;\n  dataset?: QualityDataset;\n  mapping?: FieldMapping;\n  meta?: QualityAnalysisReportModel[\"meta\"];\n  options?: {\n    stratifyBy?: string;\n  };\n};\n\nfunction normalizeMapping(mapping: FieldMapping): FieldMapping {\n  const clean = (x: string | undefined) => {\n    const v = x?.trim();\n    return v ? v : undefined;\n  };\n\n  return {\n    value: mapping.value,\n    timestamp: clean(mapping.timestamp),\n    characteristic: clean(mapping.characteristic),\n    partId: clean(mapping.partId),\n    lot: clean(mapping.lot),\n    machine: clean(mapping.machine),\n    shift: clean(mapping.shift),\n    appraiser: clean(mapping.appraiser),\n    gage: clean(mapping.gage),\n    trial: clean(mapping.trial),\n    subgroupId: clean(mapping.subgroupId),\n    unit: clean(mapping.unit),\n    lsl: clean(mapping.lsl),\n    usl: clean(mapping.usl),\n    target: clean(mapping.target),\n    result: clean(mapping.result),\n    tagColumns: mapping.tagColumns?.map((c) => c.trim()).filter(Boolean),\n  };\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const data = (await req.json()) as QualityReportRequest;\n\n    // Support both inline dataset (serverless) and datasetId (persistent storage)\n    let dataset: QualityDataset | null = null;\n\n    if (data.dataset && data.dataset.headers && data.dataset.rows) {\n      dataset = data.dataset;\n    } else if (data.datasetId) {\n      dataset = await loadDataset(data.datasetId);\n    }\n\n    if (!dataset) {\n      return NextResponse.json(\n        {\n          error:\n            \"Dataset not found. Please provide dataset inline or re-upload if running on serverless.\",\n        },\n        { status: 404 }\n      );\n    }\n\n    const defaultMapping = dataset.inferredMapping ?? inferMapping(dataset.headers).mapping;\n    const mapping = normalizeMapping(data.mapping ?? defaultMapping);\n\n    if (!mapping.value) {\n      return NextResponse.json({ error: \"mapping.value is required\" }, { status: 400 });\n    }\n\n    const format = req.nextUrl.searchParams.get(\"format\") ?? \"pdf\";\n\n    const existing = data.datasetId ? await loadAnalysis(data.datasetId) : null;\n    const requestedStratifyBy = (data.options?.stratifyBy ?? \"auto\") as any;\n    const existingStratifyBy = (existing as any)?.options?.stratifyBy ?? \"auto\";\n\n    const shouldReuse = !!existing && requestedStratifyBy === existingStratifyBy;\n    const analysis = shouldReuse\n      ? existing\n      : analyzeDataset({ dataset, mapping, options: { stratifyBy: requestedStratifyBy } });\n\n    if (!shouldReuse) {\n      try {\n        await saveAnalysis(analysis);\n      } catch {\n        // Ignore save errors on serverless\n      }\n    }\n\n    const model: QualityAnalysisReportModel = {\n      dataset: {\n        id: dataset.id,\n        name: dataset.name,\n        createdAtISO: dataset.createdAtISO,\n        source: dataset.source,\n        headers: dataset.headers,\n      },\n      mapping,\n      analysis,\n      meta: data.meta,\n    };\n\n    if (format === \"html\") {\n      const html = generateQualityAnalysisReportHTML(model);\n      return new NextResponse(html, {\n        status: 200,\n        headers: { \"Content-Type\": \"text/html; charset=utf-8\" },\n      });\n    }\n\n    const pdfElement = createElement(QualityAnalysisReportPDF, { model });\n    // @ts-expect-error - renderToBuffer types are not fully compatible with createElement\n    const pdfBuffer = await renderToBuffer(pdfElement);\n\n    return new NextResponse(Buffer.from(pdfBuffer), {\n      status: 200,\n      headers: {\n        \"Content-Type\": \"application/pdf\",\n        \"Content-Disposition\": `attachment; filename=\"quality-analysis-${Date.now()}.pdf\"`,\n      },\n    });\n  } catch (e: unknown) {\n    const message = e instanceof Error ? e.message : \"Unknown error\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/reports/spiral-torsion/route.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/reports/spiral-torsion/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":287,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":287,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7403,7406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7403,7406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":307,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":307,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7876,7879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7876,7879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":318,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":318,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8200,8203],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8200,8203],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":320,"column":98,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":320,"endColumn":101,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8319,8322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8319,8322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'title' is assigned a value but never used.","line":457,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":457,"endColumn":14},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":545,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":545,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17152,17155],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17152,17155],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":624,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":624,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21178,21181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21178,21181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":669,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":669,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23031,23034],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23031,23034],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":761,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":761,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26944,26947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26944,26947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport {\n  Circle,\n  Document,\n  Line,\n  Page,\n  Path,\n  Rect,\n  StyleSheet,\n  Svg,\n  Text,\n  View,\n  renderToBuffer,\n} from \"@react-pdf/renderer\";\nimport { createElement } from \"react\";\n\nimport type { SpiralReportModel } from \"@/lib/reports/SpiralSpringReportTemplate\";\n\nconst styles = StyleSheet.create({\n  page: {\n    padding: 40,\n    fontSize: 10,\n    fontFamily: \"Helvetica\",\n    color: \"#0f172a\",\n  },\n  header: {\n    marginBottom: 16,\n    borderBottom: \"2px solid #7c3aed\",\n    paddingBottom: 10,\n  },\n  headerMetaRow: {\n    flexDirection: \"row\",\n    justifyContent: \"space-between\",\n    marginTop: 6,\n  },\n  headerMeta: {\n    fontSize: 9,\n    color: \"#64748b\",\n  },\n  title: {\n    fontSize: 18,\n    fontWeight: \"bold\",\n    color: \"#5b21b6\",\n  },\n  subtitle: {\n    fontSize: 9,\n    color: \"#64748b\",\n    marginTop: 4,\n  },\n  section: {\n    marginBottom: 14,\n  },\n  sectionTitle: {\n    fontSize: 12,\n    fontWeight: \"bold\",\n    color: \"#1e293b\",\n    borderBottom: \"1px solid #e2e8f0\",\n    paddingBottom: 4,\n    marginBottom: 8,\n  },\n  grid2: {\n    flexDirection: \"row\",\n  },\n  card: {\n    flexGrow: 1,\n    border: \"1px solid #e2e8f0\",\n    borderRadius: 4,\n    padding: 8,\n    backgroundColor: \"#f8fafc\",\n  },\n  row: {\n    flexDirection: \"row\",\n    justifyContent: \"space-between\",\n    marginBottom: 3,\n  },\n  label: {\n    color: \"#64748b\",\n    flexGrow: 1,\n  },\n  value: {\n    fontWeight: \"bold\",\n    textAlign: \"right\",\n    flexShrink: 0,\n    marginLeft: 8,\n  },\n  badge: {\n    paddingHorizontal: 6,\n    paddingVertical: 2,\n    borderRadius: 10,\n    fontSize: 9,\n    color: \"#ffffff\",\n    alignSelf: \"flex-start\",\n    marginBottom: 6,\n  },\n  message: {\n    fontSize: 9,\n    color: \"#475569\",\n    marginBottom: 2,\n  },\n  footer: {\n    position: \"absolute\",\n    bottom: 28,\n    left: 40,\n    right: 40,\n    textAlign: \"center\",\n    color: \"#94a3b8\",\n    fontSize: 8,\n  },\n\n  chartWrap: {\n    marginTop: 6,\n    border: \"1px solid #e2e8f0\",\n    borderRadius: 4,\n    backgroundColor: \"#ffffff\",\n  },\n  chartTitle: {\n    fontSize: 9,\n    color: \"#334155\",\n    marginBottom: 4,\n    fontWeight: \"bold\",\n  },\n});\n\nfunction fmt(value: unknown, decimals = 2): string {\n  const n = typeof value === \"number\" ? value : Number.NaN;\n  if (!isFinite(n)) return \"—\";\n  return Number(n.toFixed(decimals)).toLocaleString();\n}\n\nfunction t(language: SpiralReportModel[\"meta\"][\"language\"], en: string, zh: string): string {\n  if (language === \"zh\") return zh;\n  if (language === \"en\") return en;\n  return `${en} / ${zh}`;\n}\n\nfunction Header({ data, pageTitle }: { data: SpiralReportModel; pageTitle: string }) {\n  const lang = data.meta.language ?? \"bilingual\";\n  const project = data.meta.projectName ?? \"—\";\n  const engineer = data.meta.engineer ?? \"—\";\n  const partNo = data.meta.partNo ?? \"—\";\n\n  return createElement(\n    View,\n    { style: styles.header },\n    createElement(Text, { style: styles.title }, pageTitle),\n    createElement(\n      Text,\n      { style: styles.subtitle },\n      `${t(lang, \"Generated\", \"生成\")} : ${data.meta.generatedAtISO}`\n    ),\n    createElement(\n      View,\n      { style: styles.headerMetaRow },\n      createElement(Text, { style: styles.headerMeta }, `${t(lang, \"Project\", \"项目\")}: ${project}`),\n      createElement(Text, { style: styles.headerMeta }, `${t(lang, \"Engineer\", \"工程师\")}: ${engineer}`),\n      createElement(Text, { style: styles.headerMeta }, `${t(lang, \"Part No.\", \"零件号\")}: ${partNo}`)\n    )\n  );\n}\n\ntype XY = { x: number; y: number };\n\nfunction clampFinite(n: number, fallback: number) {\n  return Number.isFinite(n) ? n : fallback;\n}\n\nfunction nearestPoint(points: XY[], xTarget: number): XY | null {\n  if (!points.length || !Number.isFinite(xTarget)) return null;\n  let best = points[0];\n  let bestDx = Math.abs(points[0].x - xTarget);\n  for (let i = 1; i < points.length; i++) {\n    const dx = Math.abs(points[i].x - xTarget);\n    if (dx < bestDx) {\n      best = points[i];\n      bestDx = dx;\n    }\n  }\n  return best;\n}\n\nfunction linePath(points: XY[], xScale: (x: number) => number, yScale: (y: number) => number): string {\n  if (points.length < 2) return \"\";\n  return points\n    .map((p, i) => {\n      const x = xScale(p.x);\n      const y = yScale(p.y);\n      return `${i === 0 ? \"M\" : \"L\"} ${x.toFixed(1)} ${y.toFixed(1)}`;\n    })\n    .join(\" \");\n}\n\nfunction SimpleLineChart({\n  width,\n  height,\n  series,\n  point,\n  annotations,\n  legend,\n}: {\n  width: number;\n  height: number;\n  series: Array<{ points: XY[]; stroke: string; strokeWidth?: number }>;\n  point?: { x: number; y: number; fill: string };\n  annotations?: Array<{ x: number; y: number; text: string; fill?: string }>;\n  legend?: Array<{ label: string; color: string }>;\n}) {\n  const padding = { left: 26, right: 10, top: 10, bottom: 18 };\n  const innerW = width - padding.left - padding.right;\n  const innerH = height - padding.top - padding.bottom;\n\n  const allPts = series.flatMap((s) => s.points);\n  const xs = allPts.map((p) => p.x);\n  const ys = allPts.map((p) => p.y);\n\n  const xMin = xs.length ? Math.min(...xs) : 0;\n  const xMax = xs.length ? Math.max(...xs) : 1;\n  const yMin = ys.length ? Math.min(...ys) : 0;\n  const yMax = ys.length ? Math.max(...ys) : 1;\n\n  const xSpan = Math.max(1e-9, xMax - xMin);\n  const ySpan = Math.max(1e-9, yMax - yMin);\n\n  const xScale = (x: number) => padding.left + ((x - xMin) / xSpan) * innerW;\n  const yScale = (y: number) => padding.top + innerH - ((y - yMin) / ySpan) * innerH;\n\n  const ptX = point ? xScale(clampFinite(point.x, xMin)) : null;\n  const ptY = point ? yScale(clampFinite(point.y, yMin)) : null;\n\n  return createElement(\n    View,\n    { style: styles.chartWrap },\n    createElement(\n      Svg,\n      { width, height, viewBox: `0 0 ${width} ${height}` },\n      createElement(Rect, { x: 0, y: 0, width, height, fill: \"#ffffff\" }),\n      createElement(Line, {\n        x1: padding.left,\n        y1: padding.top + innerH,\n        x2: width - padding.right,\n        y2: padding.top + innerH,\n        stroke: \"#94a3b8\",\n        strokeWidth: 1,\n      }),\n      createElement(Line, {\n        x1: padding.left,\n        y1: padding.top,\n        x2: padding.left,\n        y2: padding.top + innerH,\n        stroke: \"#94a3b8\",\n        strokeWidth: 1,\n      }),\n      ...series.map((s, idx) =>\n        createElement(Path, {\n          key: idx,\n          d: linePath(s.points, xScale, yScale),\n          fill: \"none\",\n          stroke: s.stroke,\n          strokeWidth: s.strokeWidth ?? 2,\n        })\n      ),\n      ...(annotations ?? []).flatMap((a, idx) => {\n        const ax = xScale(clampFinite(a.x, xMin));\n        const ay = yScale(clampFinite(a.y, yMin));\n        const fill = a.fill ?? \"#0f172a\";\n        const lines = (a.text ?? \"\").split(\"\\n\").filter((s) => s.trim().length > 0);\n        const lineStep = 8;\n        const startY = Math.max(8, ay - 4);\n        return [\n          createElement(Circle, {\n            key: `ann-dot-${idx}`,\n            cx: ax,\n            cy: ay,\n            r: 2.5,\n            fill,\n            stroke: \"#ffffff\",\n            strokeWidth: 1,\n          }),\n          ...lines.map((line, lineIdx) =>\n            createElement(\n              Text,\n              {\n                key: `ann-txt-${idx}-${lineIdx}`,\n                x: ax + 5,\n                y: startY + lineIdx * lineStep,\n                fontSize: 7,\n                fill,\n              } as any,\n              line\n            )\n          ),\n        ];\n      }),\n      point && ptX !== null && ptY !== null\n        ? createElement(Circle, {\n            cx: ptX,\n            cy: ptY,\n            r: 3.5,\n            fill: point.fill,\n            stroke: \"#ffffff\",\n            strokeWidth: 1.5,\n          })\n        : null\n    ),\n    legend?.length\n      ? createElement(\n          View,\n          { style: { flexDirection: \"row\", flexWrap: \"wrap\", padding: 6 } as any },\n          ...legend.map((l, i) =>\n            createElement(\n              View,\n              {\n                key: i,\n                style: {\n                  flexDirection: \"row\",\n                  alignItems: \"center\",\n                  marginRight: 10,\n                  marginBottom: 2,\n                } as any,\n              },\n              createElement(View, { style: { width: 10, height: 2, backgroundColor: l.color } as any }),\n              createElement(Text, { style: { fontSize: 8, color: \"#475569\", marginLeft: 4 } }, l.label)\n            )\n          )\n        )\n      : null\n  );\n}\n\nfunction rygColor(ryg?: string): string {\n  if (ryg === \"GREEN\") return \"#16a34a\";\n  if (ryg === \"YELLOW\") return \"#f59e0b\";\n  return \"#dc2626\";\n}\n\nfunction kv(label: string, value: string) {\n  return createElement(\n    View,\n    { style: styles.row },\n    createElement(Text, { style: styles.label }, label),\n    createElement(Text, { style: styles.value }, value)\n  );\n}\n\nfunction fatigueCriterionLabel(c?: SpiralReportModel[\"meta\"][\"fatigueCriterion\"]): string {\n  if (c === \"gerber\") return \"Gerber\";\n  if (c === \"soderberg\") return \"Soderberg\";\n  return \"Goodman\";\n}\n\nfunction buildFatigueLimitSeries(fatigue: SpiralReportModel[\"results\"][\"fatigue\"]): Array<{\n  points: XY[];\n  stroke: string;\n  strokeWidth?: number;\n}> {\n  const Se = fatigue.Se_MPa ?? null;\n  const Su = fatigue.Su_MPa ?? null;\n  const Sy = fatigue.Sy_MPa ?? null;\n\n  const isPos = (n: unknown): n is number => typeof n === \"number\" && Number.isFinite(n) && n > 0;\n  if (!isPos(Se)) return [];\n\n  const series: Array<{ points: XY[]; stroke: string; strokeWidth?: number }> = [];\n\n  if (isPos(Su)) {\n    series.push({ points: [{ x: 0, y: Se }, { x: Su, y: 0 }], stroke: \"#7c3aed\", strokeWidth: 2 });\n\n    const n = 60;\n    const gerberPts: XY[] = [];\n    for (let i = 0; i <= n; i++) {\n      const x = (i / n) * Su;\n      const y = Se * (1 - Math.pow(x / Su, 2));\n      gerberPts.push({ x, y: Math.max(0, y) });\n    }\n    series.push({ points: gerberPts, stroke: \"#2563eb\", strokeWidth: 2 });\n  }\n\n  if (isPos(Sy)) {\n    series.push({ points: [{ x: 0, y: Se }, { x: Sy, y: 0 }], stroke: \"#f59e0b\", strokeWidth: 2 });\n  }\n\n  return series;\n}\n\nfunction buildTorqueBandAnnotations(\n  torqueBand: NonNullable<SpiralReportModel[\"curves\"][\"torqueBand\"]>,\n  thetaMax_deg: number\n): Array<{ x: number; y: number; text: string; fill?: string }> {\n  const pMin = nearestPoint(torqueBand.min as XY[], thetaMax_deg);\n  const pNom = nearestPoint(torqueBand.nom as XY[], thetaMax_deg);\n  const pMax = nearestPoint(torqueBand.max as XY[], thetaMax_deg);\n  const anns: Array<{ x: number; y: number; text: string; fill?: string }> = [];\n  if (pMin) anns.push({ x: pMin.x, y: pMin.y, text: `Tmin=${fmt(pMin.y, 0)}`, fill: \"#94a3b8\" });\n  if (pNom) anns.push({ x: pNom.x, y: pNom.y, text: `Tnom=${fmt(pNom.y, 0)}`, fill: \"#2563eb\" });\n  if (pMax) anns.push({ x: pMax.x, y: pMax.y, text: `Tmax=${fmt(pMax.y, 0)}`, fill: \"#0f766e\" });\n  return anns;\n}\n\nfunction buildCloseoutAnnotations(params: {\n  closeout: NonNullable<SpiralReportModel[\"curves\"][\"closeout\"]>;\n  thetaContactStart_deg?: number | null;\n  thetaMax_deg: number;\n}): Array<{ x: number; y: number; text: string; fill?: string }> {\n  const { closeout, thetaContactStart_deg, thetaMax_deg } = params;\n  const anns: Array<{ x: number; y: number; text: string; fill?: string }> = [];\n\n  if (typeof thetaContactStart_deg === \"number\" && Number.isFinite(thetaContactStart_deg)) {\n    const pStart = nearestPoint(closeout.nonlinear as XY[], thetaContactStart_deg);\n    if (pStart) {\n      anns.push({\n        x: pStart.x,\n        y: pStart.y,\n        text: `thetaCs=${fmt(pStart.x, 1)} Tnl=${fmt(pStart.y, 0)}`,\n        fill: \"#7c3aed\",\n      });\n    }\n  }\n\n  const pMaxLin = nearestPoint(closeout.linear as XY[], thetaMax_deg);\n  const pMaxNl = nearestPoint(closeout.nonlinear as XY[], thetaMax_deg);\n  if (pMaxLin) {\n    anns.push({\n      x: pMaxLin.x,\n      y: pMaxLin.y,\n      text: `thetaMax=${fmt(pMaxLin.x, 1)} Tlin=${fmt(pMaxLin.y, 0)}`,\n      fill: \"#64748b\",\n    });\n  }\n  if (pMaxNl) {\n    anns.push({\n      x: pMaxNl.x,\n      y: pMaxNl.y,\n      text: `Tnl=${fmt(pMaxNl.y, 0)}`,\n      fill: \"#7c3aed\",\n    });\n  }\n\n  return anns;\n}\n\nfunction SpiralTorsionReportPDF({ data }: { data: SpiralReportModel }) {\n  const g = data.inputs.geometry;\n  const r = data.results;\n  const review = data.review;\n  const curves = data.curves;\n\n  const lang = data.meta.language ?? \"bilingual\";\n  const reportTitle = t(lang, \"Spiral Torsion Spring Report\", \"螺旋扭转弹簧工程报告\");\n\n  const selectedCriterion = data.meta.fatigueCriterion ?? \"goodman\";\n  const selectedCriterionLabel = fatigueCriterionLabel(selectedCriterion);\n\n  const titleInputs = t(lang, \"Inputs\", \"输入\");\n  const titleResults = t(lang, \"Results\", \"结果\");\n  const titleReview = t(lang, \"Engineering Review\", \"工程评审\");\n  const titleCurves = t(lang, \"Curves\", \"曲线\");\n\n  const title = \"Spiral Torsion Spring Report\";\n\n  return createElement(\n    Document,\n    {},\n    // Page 1: Cover + Inputs\n    createElement(\n      Page,\n      { size: \"A4\", style: styles.page },\n      createElement(Header, { data, pageTitle: reportTitle }),\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, titleInputs),\n        createElement(\n          View,\n          { style: styles.grid2 },\n          createElement(\n            View,\n            { style: styles.card },\n            createElement(Text, { style: { fontWeight: \"bold\", marginBottom: 6 } }, t(lang, \"Geometry\", \"几何\")),\n            kv(\"b (mm)\", fmt(g.stripWidth, 2)),\n            kv(\"t (mm)\", fmt(g.stripThickness, 3)),\n            kv(\"L (mm)\", fmt(g.activeLength, 1)),\n            kv(\"Di (mm)\", fmt(g.innerDiameter, 1)),\n            kv(\"Do (mm)\", fmt(g.outerDiameter, 1)),\n            kv(\"theta0 (deg)\", fmt(g.preloadAngle, 1)),\n            kv(\"thetaMin (deg)\", fmt(g.minWorkingAngle, 1)),\n            kv(\"thetaMax (deg)\", fmt(g.maxWorkingAngle, 1)),\n            kv(\"thetaCo (deg)\", fmt(g.closeOutAngle, 1))\n          ),\n          createElement(\n            View,\n            { style: [styles.card, { marginLeft: 10 }] },\n            createElement(Text, { style: { fontWeight: \"bold\", marginBottom: 6 } }, t(lang, \"Materials\", \"材料\")),\n            kv(t(lang, \"Calculator\", \"计算器\"), data.inputs.calculatorMaterial.id),\n            data.inputs.engineeringMaterial\n              ? createElement(\n                  View,\n                  {},\n                  kv(t(lang, \"Engineering\", \"工程\"), data.inputs.engineeringMaterial.materialId),\n                  kv(t(lang, \"Surface\", \"表面\"), data.inputs.engineeringMaterial.surface),\n                  kv(t(lang, \"Reliability\", \"可靠度\"), fmt(data.inputs.engineeringMaterial.reliability, 2)),\n                  kv(t(lang, \"Shot peened\", \"喷丸\"), data.inputs.engineeringMaterial.shotPeened ? \"Yes\" : \"No\"),\n                  data.inputs.engineeringMaterial.kPeen !== undefined\n                    ? kv(\"k_peen\", fmt(data.inputs.engineeringMaterial.kPeen, 3))\n                    : null,\n                  data.inputs.engineeringMaterial.shotPeenAssumptions?.length\n                    ? createElement(\n                        Text,\n                        { style: styles.message },\n                        `Shot peen assumptions: ${data.inputs.engineeringMaterial.shotPeenAssumptions.slice(0, 2).join(\" | \")}`\n                      )\n                    : null,\n                  data.inputs.engineeringMaterial.strengthBasis\n                    ? kv(\"Strength basis\", data.inputs.engineeringMaterial.strengthBasis)\n                    : null,\n                  data.inputs.engineeringMaterial.heatTreatment\n                    ? kv(\"Heat treatment\", data.inputs.engineeringMaterial.heatTreatment)\n                    : null,\n                  data.inputs.engineeringMaterial.kThickness !== undefined\n                    ? kv(\"k_thickness\", fmt(data.inputs.engineeringMaterial.kThickness, 3))\n                    : null,\n                  data.inputs.engineeringMaterial.kHeatTreatment !== undefined\n                    ? kv(\"k_heat_treatment\", fmt(data.inputs.engineeringMaterial.kHeatTreatment, 3))\n                    : null,\n                  data.inputs.engineeringMaterial.strengthAssumptions?.length\n                    ? createElement(\n                        Text,\n                        { style: styles.message },\n                        `Assumptions: ${data.inputs.engineeringMaterial.strengthAssumptions.slice(0, 4).join(\" | \")}`\n                      )\n                    : null,\n                  kv(\"Su (MPa)\", fmt(data.inputs.engineeringMaterial.Su_MPa, 0)),\n                  kv(\"Sy (MPa)\", fmt(data.inputs.engineeringMaterial.Sy_MPa, 0)),\n                  kv(\"Se' (MPa)\", fmt(data.inputs.engineeringMaterial.SePrime_MPa, 0))\n                )\n              : createElement(Text, { style: styles.message }, t(lang, \"No engineering material\", \"无工程材料\"))\n          )\n        )\n      ),\n      createElement(\n        Text,\n        {\n          style: styles.footer,\n          render: ({ pageNumber, totalPages }: { pageNumber: number; totalPages: number }) =>\n            `${pageNumber} / ${totalPages}`,\n          fixed: true,\n        } as any,\n        \"\"\n      )\n    ),\n\n    // Page 2: Results\n    createElement(\n      Page,\n      { size: \"A4\", style: styles.page },\n      createElement(Header, { data, pageTitle: reportTitle }),\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, titleResults),\n        createElement(\n          View,\n          { style: styles.grid2 },\n          createElement(\n            View,\n            { style: styles.card },\n            createElement(Text, { style: { fontWeight: \"bold\", marginBottom: 6 } }, t(lang, \"Core\", \"核心\")),\n            kv(\"k (N*mm/deg)\", fmt(r.springRate_NmmPerDeg, 4)),\n            kv(\"sigmaMax_bending (MPa)\", fmt(r.maxStress_MPa, 1)),\n            kv(\"sigmaVM (MPa)\", r.maxStress_MPa !== undefined ? fmt(Math.abs(r.maxStress_MPa), 1) : \"—\"),\n            kv(\"Static SF\", fmt(r.staticSafetyFactor, 2)),\n            kv(\"Yield SF (Sy/sigmaMax)\", data.review?.staticSF !== null && data.review?.staticSF !== undefined ? fmt(data.review.staticSF, 2) : \"—\"),\n            kv(\"thetaMax/thetaCo\", fmt(r.closeout.thetaMaxOverThetaCo, 2))\n          ),\n          createElement(\n            View,\n            { style: [styles.card, { marginLeft: 10 }] },\n            createElement(Text, { style: { fontWeight: \"bold\", marginBottom: 6 } }, t(lang, \"Fatigue (Criteria)\", \"疲劳（多准则）\")),\n            createElement(\n              Text,\n              { style: styles.message },\n              t(lang, `Selected criterion: ${selectedCriterionLabel}`, `当前选择准则：${selectedCriterionLabel}`)\n            ),\n            createElement(Text, { style: styles.message }, t(lang, \"Review basis: Goodman\", \"评审默认：Goodman\")),\n            kv(\"sigmaA (MPa)\", fmt(r.fatigue.sigmaA_MPa, 1)),\n            kv(\"sigmaM (MPa)\", fmt(r.fatigue.sigmaM_MPa, 1)),\n            kv(\"Se (MPa)\", r.fatigue.Se_MPa === null ? \"—\" : fmt(r.fatigue.Se_MPa, 0)),\n            kv(\"Su (MPa)\", r.fatigue.Su_MPa === null ? \"—\" : fmt(r.fatigue.Su_MPa, 0)),\n            kv(\"Sy (MPa)\", r.fatigue.Sy_MPa === null ? \"—\" : fmt(r.fatigue.Sy_MPa, 0)),\n            kv(\"SF (Goodman)\", r.fatigue.fatigueSF_Goodman === null ? \"—\" : fmt(r.fatigue.fatigueSF_Goodman, 2)),\n            kv(\"SF (Gerber)\", r.fatigue.fatigueSF_Gerber === null ? \"—\" : fmt(r.fatigue.fatigueSF_Gerber, 2)),\n            kv(\"SF (Soderberg)\", r.fatigue.fatigueSF_Soderberg === null ? \"—\" : fmt(r.fatigue.fatigueSF_Soderberg, 2)),\n            kv(\"Util (Goodman)\", r.fatigue.utilization_Goodman === null ? \"—\" : fmt(r.fatigue.utilization_Goodman, 3)),\n            kv(\"Util (Gerber)\", r.fatigue.utilization_Gerber === null ? \"—\" : fmt(r.fatigue.utilization_Gerber, 3)),\n            kv(\"Util (Soderberg)\", r.fatigue.utilization_Soderberg === null ? \"—\" : fmt(r.fatigue.utilization_Soderberg, 3))\n          )\n        ),\n        createElement(\n          View,\n          { style: [styles.grid2, { marginTop: 10 }] },\n          createElement(\n            View,\n            { style: styles.card },\n            createElement(Text, { style: { fontWeight: \"bold\", marginBottom: 6 } }, t(lang, \"Tolerance\", \"公差\")),\n            kv(\"kMin\", fmt(r.tolerance.kMin, 4)),\n            kv(\"kMax\", fmt(r.tolerance.kMax, 4)),\n            kv(\"TmaxBandMin (N*mm)\", fmt(r.tolerance.TmaxBandMin_Nmm, 1)),\n            kv(\"TmaxBandMax (N*mm)\", fmt(r.tolerance.TmaxBandMax_Nmm, 1))\n          ),\n          createElement(\n            View,\n            { style: [styles.card, { marginLeft: 10 }] },\n            createElement(Text, { style: { fontWeight: \"bold\", marginBottom: 6 } }, t(lang, \"Close-out\", \"贴合\")),\n            kv(\"thetaContactStartUsed (deg)\", fmt(r.closeout.thetaContactStartUsedDeg, 1)),\n            kv(\"nonlinearTorqueAtMax (N*mm)\", fmt(r.closeout.nonlinearTorqueAtMax_Nmm, 1))\n          )\n        )\n      ),\n      createElement(\n        Text,\n        {\n          style: styles.footer,\n          render: ({ pageNumber, totalPages }: { pageNumber: number; totalPages: number }) =>\n            `${pageNumber} / ${totalPages}`,\n          fixed: true,\n        } as any,\n        \"\"\n      )\n    ),\n\n    // Page 3: Review\n    createElement(\n      Page,\n      { size: \"A4\", style: styles.page },\n      createElement(Header, { data, pageTitle: reportTitle }),\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, titleReview),\n        review\n          ? createElement(\n              View,\n              { style: styles.grid2 },\n              createElement(\n                View,\n                { style: styles.card },\n                createElement(Text, { style: [styles.badge, { backgroundColor: rygColor(review.overall) }] }, `${t(lang, \"OVERALL\", \"总体\")}: ${review.overall}`),\n                kv(t(lang, \"Static\", \"静强度\"), review.staticRYG ?? \"—\"),\n                kv(t(lang, \"Fatigue\", \"疲劳\"), review.fatigueRYG ?? \"—\"),\n                kv(t(lang, \"Close-out\", \"贴合\"), review.closeoutRYG ?? \"—\"),\n                kv(t(lang, \"Geometry\", \"几何\"), review.geometryRYG ?? \"—\")\n              ),\n              createElement(\n                View,\n                { style: [styles.card, { marginLeft: 10 }] },\n                createElement(Text, { style: { fontWeight: \"bold\", marginBottom: 6 } }, t(lang, \"Messages\", \"信息\")),\n                ...(review.messages?.length\n                  ? review.messages.map((m, i) => createElement(Text, { key: i, style: styles.message }, `- ${m}`))\n                  : [createElement(Text, { key: \"none\", style: styles.message }, \"- None\")])\n              )\n            )\n          : createElement(Text, { style: styles.message }, \"- review not available\")\n      ),\n      createElement(\n        Text,\n        {\n          style: styles.footer,\n          render: ({ pageNumber, totalPages }: { pageNumber: number; totalPages: number }) =>\n            `${pageNumber} / ${totalPages}`,\n          fixed: true,\n        } as any,\n        \"\"\n      )\n    ),\n\n    // Page 4: Curves\n    createElement(\n      Page,\n      { size: \"A4\", style: styles.page },\n      createElement(Header, { data, pageTitle: reportTitle }),\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, titleCurves),\n        createElement(\n          View,\n          { style: styles.grid2 },\n          createElement(\n            View,\n            { style: styles.card },\n            createElement(Text, { style: styles.chartTitle }, \"Torque Band (T-Theta)\"),\n            curves.torqueBand\n              ? createElement(SimpleLineChart, {\n                  width: 250,\n                  height: 170,\n                  series: [\n                    { points: curves.torqueBand.min, stroke: \"#94a3b8\", strokeWidth: 1.5 },\n                    { points: curves.torqueBand.nom, stroke: \"#2563eb\" },\n                    { points: curves.torqueBand.max, stroke: \"#0f766e\", strokeWidth: 1.5 },\n                  ],\n                  annotations: buildTorqueBandAnnotations(curves.torqueBand, g.maxWorkingAngle),\n                })\n              : createElement(Text, { style: styles.message }, \"- torqueBand not available\")\n          ),\n          createElement(\n            View,\n            { style: [styles.card, { marginLeft: 10 }] },\n            createElement(Text, { style: styles.chartTitle }, \"Close-out (T-Theta)\"),\n            curves.closeout\n              ? createElement(SimpleLineChart, {\n                  width: 250,\n                  height: 170,\n                  series: [\n                    { points: curves.closeout.linear, stroke: \"#64748b\", strokeWidth: 1.5 },\n                    { points: curves.closeout.nonlinear, stroke: \"#7c3aed\" },\n                  ],\n                  annotations: buildCloseoutAnnotations({\n                    closeout: curves.closeout,\n                    thetaContactStart_deg: r.closeout.thetaContactStartUsedDeg ?? null,\n                    thetaMax_deg: g.maxWorkingAngle,\n                  }),\n                })\n              : createElement(Text, { style: styles.message }, \"- closeout not available\")\n          )\n        ),\n        createElement(\n          View,\n          { style: [styles.card, { marginTop: 10 }] },\n          createElement(Text, { style: styles.chartTitle }, \"Fatigue (sigmaA-sigmaM)\"),\n          createElement(SimpleLineChart, {\n            width: 520,\n            height: 220,\n            series: buildFatigueLimitSeries(r.fatigue),\n            point: curves.goodman?.point\n              ? { x: curves.goodman.point.sigmaM, y: curves.goodman.point.sigmaA, fill: \"#f59e0b\" }\n              : undefined,\n            annotations:\n              curves.goodman?.point\n                ? [\n                    {\n                      x: curves.goodman.point.sigmaM,\n                      y: curves.goodman.point.sigmaA,\n                      text: `sigmam=${fmt(curves.goodman.point.sigmaM, 0)} sigmaa=${fmt(curves.goodman.point.sigmaA, 0)}\\nSF: G=${fmt(r.fatigue.fatigueSF_Goodman, 2)} Ge=${fmt(r.fatigue.fatigueSF_Gerber, 2)} S=${fmt(r.fatigue.fatigueSF_Soderberg, 2)}`,\n                      fill: \"#0f172a\",\n                    },\n                  ]\n                : undefined,\n            legend: [\n              { label: `Goodman${selectedCriterion === \"goodman\" ? \" (selected)\" : \"\"}`, color: \"#7c3aed\" },\n              { label: `Gerber${selectedCriterion === \"gerber\" ? \" (selected)\" : \"\"}`, color: \"#2563eb\" },\n              { label: `Soderberg${selectedCriterion === \"soderberg\" ? \" (selected)\" : \"\"}`, color: \"#f59e0b\" },\n            ],\n          })\n        )\n      ),\n      createElement(\n        Text,\n        {\n          style: styles.footer,\n          render: ({ pageNumber, totalPages }: { pageNumber: number; totalPages: number }) =>\n            `${pageNumber} / ${totalPages}`,\n          fixed: true,\n        } as any,\n        \"\"\n      )\n    )\n  );\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const data = (await req.json()) as SpiralReportModel;\n\n    if (!data?.inputs?.geometry || !data?.results?.fatigue) {\n      return NextResponse.json({ error: \"Invalid report model\" }, { status: 400 });\n    }\n\n    const pdfElement = createElement(SpiralTorsionReportPDF, { data });\n    // @ts-expect-error - renderToBuffer types are not fully compatible with createElement\n    const pdfBuffer = await renderToBuffer(pdfElement);\n\n    return new NextResponse(Buffer.from(pdfBuffer), {\n      status: 200,\n      headers: {\n        \"Content-Type\": \"application/pdf\",\n        \"Content-Disposition\": `attachment; filename=\"spiral-torsion-report-${Date.now()}.pdf\"`,\n      },\n    });\n  } catch (e: unknown) {\n    const message = e instanceof Error ? e.message : \"Unknown error\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/api/reports/variable-pitch-compression/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":271,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":271,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7773,7776],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7773,7776],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { renderToBuffer } from \"@react-pdf/renderer\";\nimport { Document, Page, Text, View, StyleSheet, Svg, Path, Line } from \"@react-pdf/renderer\";\nimport { createElement } from \"react\";\n\nimport type { VariablePitchCompressionReportPayload } from \"@/lib/reports/variablePitchCompressionReport\";\n\ntype VariablePitchCompressionReportRequest = {\n  payload: VariablePitchCompressionReportPayload;\n  meta?: {\n    title?: string;\n    projectName?: string;\n    engineer?: string;\n    language?: \"en\" | \"zh\" | \"bilingual\";\n  };\n};\n\nconst styles = StyleSheet.create({\n  page: {\n    padding: 40,\n    fontSize: 10,\n    fontFamily: \"Helvetica\",\n    color: \"#0f172a\",\n  },\n  header: {\n    marginBottom: 16,\n    borderBottom: \"2px solid #2563eb\",\n    paddingBottom: 10,\n  },\n  title: {\n    fontSize: 18,\n    fontWeight: \"bold\",\n    color: \"#1d4ed8\",\n  },\n  subtitle: {\n    fontSize: 9,\n    color: \"#64748b\",\n    marginTop: 4,\n  },\n  headerMetaRow: {\n    flexDirection: \"row\",\n    justifyContent: \"space-between\",\n    marginTop: 6,\n  },\n  headerMeta: {\n    fontSize: 9,\n    color: \"#64748b\",\n  },\n  section: {\n    marginBottom: 14,\n  },\n  sectionTitle: {\n    fontSize: 12,\n    fontWeight: \"bold\",\n    color: \"#1e293b\",\n    borderBottom: \"1px solid #e2e8f0\",\n    paddingBottom: 4,\n    marginBottom: 8,\n  },\n  grid2: {\n    flexDirection: \"row\",\n  },\n  card: {\n    flexGrow: 1,\n    border: \"1px solid #e2e8f0\",\n    borderRadius: 4,\n    padding: 8,\n    backgroundColor: \"#f8fafc\",\n  },\n  row: {\n    flexDirection: \"row\",\n    justifyContent: \"space-between\",\n    marginBottom: 3,\n  },\n  label: {\n    color: \"#64748b\",\n    flexGrow: 1,\n  },\n  value: {\n    fontWeight: \"bold\",\n    textAlign: \"right\",\n    flexShrink: 0,\n    marginLeft: 8,\n  },\n  chartWrap: {\n    marginTop: 6,\n    border: \"1px solid #e2e8f0\",\n    borderRadius: 4,\n    backgroundColor: \"#ffffff\",\n    padding: 8,\n  },\n  chartTitle: {\n    fontSize: 9,\n    color: \"#334155\",\n    marginBottom: 4,\n    fontWeight: \"bold\",\n  },\n  footer: {\n    position: \"absolute\",\n    bottom: 28,\n    left: 40,\n    right: 40,\n    textAlign: \"center\",\n    color: \"#94a3b8\",\n    fontSize: 8,\n  },\n});\n\nfunction fmt(value: unknown, decimals = 2): string {\n  const n = typeof value === \"number\" ? value : Number.NaN;\n  if (!isFinite(n)) return \"—\";\n  return Number(n.toFixed(decimals)).toLocaleString();\n}\n\nfunction t(lang: NonNullable<VariablePitchCompressionReportRequest[\"meta\"]>[\"language\"], en: string, zh: string): string {\n  if (lang === \"zh\") return zh;\n  if (lang === \"en\") return en;\n  return `${en} / ${zh}`;\n}\n\nfunction kv(label: string, value: string) {\n  return createElement(\n    View,\n    { style: styles.row },\n    createElement(Text, { style: styles.label }, label),\n    createElement(Text, { style: styles.value }, value)\n  );\n}\n\ntype XY = { x: number; y: number };\n\nfunction linePath(points: XY[], xScale: (x: number) => number, yScale: (y: number) => number): string {\n  if (points.length < 2) return \"\";\n  return points\n    .map((p, i) => {\n      const x = xScale(p.x);\n      const y = yScale(p.y);\n      return `${i === 0 ? \"M\" : \"L\"} ${x.toFixed(1)} ${y.toFixed(1)}`;\n    })\n    .join(\" \");\n}\n\nfunction SimpleCurveChart({ title, points }: { title: string; points: XY[] }) {\n  const width = 520;\n  const height = 220;\n  const padding = { left: 30, right: 10, top: 12, bottom: 22 };\n  const innerW = width - padding.left - padding.right;\n  const innerH = height - padding.top - padding.bottom;\n\n  const xs = points.map((p) => p.x);\n  const ys = points.map((p) => p.y);\n  const xMin = xs.length ? Math.min(...xs) : 0;\n  const xMax = xs.length ? Math.max(...xs) : 1;\n  const yMin = ys.length ? Math.min(...ys) : 0;\n  const yMax = ys.length ? Math.max(...ys) : 1;\n\n  const xSpan = Math.max(1e-9, xMax - xMin);\n  const ySpan = Math.max(1e-9, yMax - yMin);\n\n  const xScale = (x: number) => padding.left + ((x - xMin) / xSpan) * innerW;\n  const yScale = (y: number) => padding.top + innerH - ((y - yMin) / ySpan) * innerH;\n\n  return createElement(\n    View,\n    { style: styles.chartWrap },\n    createElement(Text, { style: styles.chartTitle }, title),\n    createElement(\n      Svg,\n      { width, height, viewBox: `0 0 ${width} ${height}` },\n      createElement(Line, {\n        x1: padding.left,\n        y1: padding.top + innerH,\n        x2: width - padding.right,\n        y2: padding.top + innerH,\n        stroke: \"#94a3b8\",\n        strokeWidth: 1,\n      }),\n      createElement(Line, {\n        x1: padding.left,\n        y1: padding.top,\n        x2: padding.left,\n        y2: padding.top + innerH,\n        stroke: \"#94a3b8\",\n        strokeWidth: 1,\n      }),\n      createElement(Path, {\n        d: linePath(points, xScale, yScale),\n        fill: \"none\",\n        stroke: \"#2563eb\",\n        strokeWidth: 2,\n      })\n    )\n  );\n}\n\nfunction VariablePitchCompressionReportPDF({ data }: { data: VariablePitchCompressionReportRequest }) {\n  const lang = data.meta?.language ?? \"bilingual\";\n  const title = data.meta?.title ?? t(lang, \"Variable Pitch Compression Spring Report\", \"变节距压缩弹簧报告\");\n  const generatedAt = new Date().toLocaleString();\n  const project = data.meta?.projectName ?? \"—\";\n  const engineer = data.meta?.engineer ?? \"—\";\n\n  const payload = data.payload;\n  const spring = payload.spring;\n\n  const pts: XY[] = payload.curves.deflection\n    .map((x, i) => ({ x, y: payload.curves.load[i] ?? 0 }))\n    .filter((p) => isFinite(p.x) && isFinite(p.y));\n\n  return createElement(\n    Document,\n    {},\n    createElement(\n      Page,\n      { size: \"A4\", style: styles.page },\n      createElement(\n        View,\n        { style: styles.header },\n        createElement(Text, { style: styles.title }, title),\n        createElement(Text, { style: styles.subtitle }, `${t(lang, \"Generated\", \"生成\")}: ${generatedAt}`),\n        createElement(\n          View,\n          { style: styles.headerMetaRow },\n          createElement(Text, { style: styles.headerMeta }, `${t(lang, \"Project\", \"项目\")}: ${project}`),\n          createElement(Text, { style: styles.headerMeta }, `${t(lang, \"Engineer\", \"工程师\")}: ${engineer}`)\n        )\n      ),\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, \"Inputs\", \"输入\")),\n        createElement(\n          View,\n          { style: styles.grid2 },\n          createElement(\n            View,\n            { style: styles.card },\n            kv(\"d (mm)\", fmt(spring.wireDiameter, 2)),\n            kv(\"Dm (mm)\", fmt(spring.meanDiameter, 2)),\n            kv(\"Nt\", fmt(spring.totalCoils, 2)),\n            kv(\"Na0\", fmt(spring.activeCoils0, 2)),\n            kv(\"G (MPa)\", fmt(spring.shearModulus, 0)),\n            kv(\"L0 (mm)\", fmt(spring.freeLength, 2))\n          ),\n          createElement(\n            View,\n            { style: [styles.card, { marginLeft: 10 }] },\n            kv(\"Material\", spring.materialName ?? spring.materialId ?? \"—\"),\n            kv(\"C\", fmt(payload.summary.springIndex, 3)),\n            kv(\"Kw\", fmt(payload.summary.wahlFactor, 3)),\n            kv(\"deltaMax (mm)\", fmt(payload.summary.deltaMax, 2)),\n            kv(\"Issues\", String(payload.summary.issues.length))\n          )\n        )\n      ),\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, \"Force-Deflection\", \"力-位移\")),\n        createElement(SimpleCurveChart, {\n          title: t(lang, \"Force vs. Deflection\", \"载荷-位移曲线\"),\n          points: pts,\n        })\n      ),\n      createElement(\n        Text,\n        {\n          style: styles.footer,\n          render: ({ pageNumber, totalPages }: { pageNumber: number; totalPages: number }) => `${pageNumber} / ${totalPages}`,\n          fixed: true,\n        } as any,\n        \"\"\n      )\n    )\n  );\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const data = (await req.json()) as VariablePitchCompressionReportRequest;\n    if (!data?.payload) {\n      return NextResponse.json({ error: \"Invalid payload\" }, { status: 400 });\n    }\n\n    const pdfElement = createElement(VariablePitchCompressionReportPDF, { data });\n    // @ts-expect-error - renderToBuffer types are not fully compatible with createElement\n    const pdfBuffer = await renderToBuffer(pdfElement);\n\n    return new NextResponse(Buffer.from(pdfBuffer), {\n      status: 200,\n      headers: {\n        \"Content-Type\": \"application/pdf\",\n        \"Content-Disposition\": `attachment; filename=\"variable-pitch-compression-report-${Date.now()}.pdf\"`,\n      },\n    });\n  } catch (e: unknown) {\n    const message = e instanceof Error ? e.message : \"Unknown error\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/catalog/compression/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/catalog/extension/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/catalog/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/catalog/torsion/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/engineering/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/finder/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Box' is defined but never used.","line":8,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":470,"column":54,"nodeType":null,"messageId":"unusedVar","endLine":470,"endColumn":59}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { LanguageText } from \"@/components/language-context\";\n\nimport Link from \"next/link\";\nimport {\n  ArrowRight,\n  BarChart3,\n  ClipboardCheck,\n  Box,\n  Calculator,\n  FileCog,\n  Mail,\n  Move3D,\n  PackageSearch,\n  Cog,\n  Activity,\n  Shield,\n  type LucideIcon,\n} from \"lucide-react\";\n\nimport {\n  Card,\n  CardContent,\n  CardFooter,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { HomeRiskRadar } from \"@/components/home/HomeRiskRadar\";\nimport { HoverGlassCard } from \"@/components/home/HoverGlassCard\";\nimport { HeroSpline } from \"@/components/home/hero-spline\";\n\nconst features = [\n  {\n    title: { en: \"Spring Calculator\", zh: \"弹簧计算器\" },\n    description: {\n      en: \"Rapid stiffness, stress, and fatigue placeholders with ISRI best practices embedded.\",\n      zh: \"快速计算刚度、剪应力与疲劳安全系数，占位实现 ISRI 标准工程流程。\",\n    },\n    href: \"/tools/calculator\",\n    icon: Calculator,\n  },\n  {\n    title: { en: \"Engineering Analysis\", zh: \"工程分析\" },\n    description: {\n      en: \"Complete stress, S-N fatigue life, safety factor, and buckling analysis for all spring types.\",\n      zh: \"完整的应力、S-N 疲劳寿命、安全系数和屈曲分析，支持所有弹簧类型。\",\n    },\n    href: \"/tools/analysis\",\n    icon: BarChart3,\n  },\n  {\n    title: { en: \"Spring Simulator\", zh: \"弹簧仿真\" },\n    description: {\n      en: \"Interactive 3D modeling with pitch, free length, and bending foot presets.\",\n      zh: \"交互式 3D 建模，实时调整节距、自由长、脚位等参数。\",\n    },\n    href: \"/tools/simulator\",\n    icon: Move3D,\n  },\n  {\n    title: { en: \"CAD Export\", zh: \"CAD 导出\" },\n    description: {\n      en: \"Creo-ready PDF, STEP, and native files powered by automated drafting pipelines.\",\n      zh: \"自动生成 Creo PDF、STEP 以及原生模型文件。\",\n    },\n    href: \"/tools/cad-export\",\n    icon: FileCog,\n  },\n  {\n    title: { en: \"RFQ\", zh: \"询价\" },\n    description: {\n      en: \"Hand off validated designs directly to ISRI-SHUANGDI sourcing in one click.\",\n      zh: \"一键将设计结果推送至 ISRI-SHUANGDI 采购团队。\",\n    },\n    href: \"/rfq\",\n    icon: Mail,\n  },\n  {\n    title: { en: \"Spring Catalog\", zh: \"产品目录\" },\n    description: {\n      en: \"Search verified production springs with tolerance, finish, and load filters.\",\n      zh: \"检索量产弹簧，支持公差、表面处理、载荷等条件过滤。\",\n    },\n    href: \"/catalog\",\n    icon: PackageSearch,\n  },\n  {\n    title: { en: \"Quality Management\", zh: \"质量管理\" },\n    description: {\n      en: \"Import inspection data, run SPC/capability analytics, and export standardized reports (sidecar).\",\n      zh: \"导入质检数据，进行 SPC/过程能力分析，并导出标准化报告（旁路模块）。\",\n    },\n    href: \"/quality\",\n    icon: ClipboardCheck,\n  },\n];\n\ntype HomeFeature = {\n  title: { en: string; zh: string };\n  description: { en: string; zh: string };\n  href: string;\n  icon: LucideIcon;\n};\n\nexport default function Home() {\n  return (\n    <div className=\"space-y-12\">\n      <Card className=\"rounded-3xl\">\n        <div className=\"grid gap-10 px-6 py-8 md:grid-cols-[1.2fr_0.8fr] md:items-center md:px-10 md:py-10\">\n          <div className=\"min-w-0\">\n            <div className=\"inline-flex items-center gap-2 rounded-full border bg-background/70 px-3 py-1 text-xs font-semibold uppercase tracking-[0.22em] text-primary/80\">\n              <span className=\"h-1.5 w-1.5 rounded-full bg-primary\" />\n              <span>ISRI-SHUANGDI • Industry 4.0</span>\n            </div>\n            <h1 className=\"mt-5 text-4xl font-semibold tracking-tight sm:text-5xl\">\n              <LanguageText\n                en=\"Engineering-First Spring Design & Manufacturing Platform\"\n                zh=\"以工程为核心的弹簧设计与制造平台\"\n              />\n            </h1>\n            <p className=\"mt-4 max-w-2xl text-lg text-muted-foreground\">\n              <LanguageText\n                en=\"From Geometry → Risk → Production → Quality. Replace tribal knowledge with engineering certainty.\"\n                zh=\"从几何到风险，从设计到生产。用工程确定性替代‘老师傅经验’。\"\n              />\n            </p>\n            <div className=\"mt-7 flex flex-col gap-3 sm:flex-row\">\n              <Button asChild size=\"lg\" className=\"rounded-full\">\n                <Link href=\"/tools/calculator\">\n                  <Calculator className=\"mr-2 size-4\" />\n                  <LanguageText en=\"Try Engineering Calculator\" zh=\"使用工程计算器\" />\n                  <ArrowRight className=\"ml-2 size-4\" />\n                </Link>\n              </Button>\n              <Button asChild size=\"lg\" variant=\"outline\" className=\"rounded-full\">\n                <Link href=\"/production\">\n                  <Activity className=\"mr-2 size-4\" />\n                  <LanguageText en=\"See Manufacturing Dashboard Demo\" zh=\"查看制造看板演示\" />\n                </Link>\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"relative\">\n            <div className=\"aspect-[4/3] w-full overflow-hidden rounded-2xl border bg-muted/30 shadow-sm\">\n              <HeroSpline />\n            </div>\n          </div>\n        </div>\n      </Card>\n\n      <section className=\"rounded-3xl border bg-background p-6 sm:p-10\">\n        <div className=\"grid gap-10 md:grid-cols-[1.1fr_0.9fr] md:items-start\">\n          <div>\n            <div className=\"inline-flex items-center gap-2 rounded-full border bg-background/70 px-3 py-1 text-xs font-semibold uppercase tracking-[0.22em] text-primary/80\">\n              <span className=\"h-1.5 w-1.5 rounded-full bg-primary\" />\n              <span>\n                <LanguageText en=\"Engineering Risk Radar\" zh=\"工程风险雷达\" />\n              </span>\n            </div>\n\n            <h2 className=\"mt-5 text-3xl font-semibold tracking-tight sm:text-4xl\">\n              <LanguageText\n                en=\"Engineering Risk Radar for Spring Design\"\n                zh=\"工程风险雷达 · 面向制造的弹簧设计\"\n              />\n            </h2>\n\n            <p className=\"mt-4 max-w-2xl text-lg text-muted-foreground\">\n              <LanguageText\n                en=\"See engineering validity, manufacturing risk, and quality exposure — before production.\"\n                zh=\"在生产之前，看清工程合理性、制造风险与质量隐患。\"\n              />\n            </p>\n            <p className=\"mt-2 max-w-2xl text-lg text-muted-foreground\">\n              <LanguageText\n                en=\"Not just calculations. Built-in engineering rules transform spring designs into manufacturing-ready decisions.\"\n                zh=\"不只是计算结果，内置工程规则，把弹簧设计变成可制造的决策。\"\n              />\n            </p>\n            <p className=\"mt-2 max-w-2xl text-sm text-muted-foreground\">\n              <LanguageText\n                en=\"Rule-based, explainable. No black-box decisions.\"\n                zh=\"规则驱动，可解释；拒绝黑盒决策。\"\n              />\n            </p>\n\n            <div className=\"mt-7 grid gap-3 sm:grid-cols-3\">\n              <Card>\n                <CardHeader className=\"gap-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <BarChart3 className=\"size-4 text-primary\" />\n                    <CardTitle className=\"text-sm font-semibold\">\n                      <LanguageText en=\"Engineering OK\" zh=\"工程合理性\" />\n                    </CardTitle>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0 text-sm text-muted-foreground\">\n                  <LanguageText\n                    en=\"Physics-based validation ensures stress, deformation, and geometry are sound.\"\n                    zh=\"基于物理与工程经验，验证应力、变形与几何比例是否健康。\"\n                  />\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"gap-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <PackageSearch className=\"size-4 text-primary\" />\n                    <CardTitle className=\"text-sm font-semibold\">\n                      <LanguageText en=\"Manufacturing Risk\" zh=\"制造风险识别\" />\n                    </CardTitle>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0 text-sm text-muted-foreground\">\n                  <LanguageText\n                    en=\"Identify coil density, wire length, spacing, and process-sensitive designs early.\"\n                    zh=\"提前发现圈数、线长、间距与工艺敏感问题。\"\n                  />\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"gap-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Mail className=\"size-4 text-primary\" />\n                    <CardTitle className=\"text-sm font-semibold\">\n                      <LanguageText en=\"High Risk Alert\" zh=\"高风险预警\" />\n                    </CardTitle>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0 text-sm text-muted-foreground\">\n                  <LanguageText\n                    en=\"Catch unmanufacturable or failure-prone designs before drawings reach the shop floor.\"\n                    zh=\"在图纸下发前识别不可制造或高失败风险设计。\"\n                  />\n                </CardContent>\n              </Card>\n            </div>\n\n            <div className=\"mt-7 flex flex-col gap-3 sm:flex-row\">\n              <Button asChild size=\"lg\" className=\"rounded-full\">\n                <Link href=\"/tools/calculator\">\n                  <LanguageText en=\"Try the calculator\" zh=\"进入计算器\" />\n                  <ArrowRight className=\"size-4\" />\n                </Link>\n              </Button>\n              <Button asChild size=\"lg\" variant=\"outline\" className=\"rounded-full\">\n                <Link href=\"/tools/analysis\">\n                  <LanguageText en=\"View analysis\" zh=\"查看工程分析\" />\n                </Link>\n              </Button>\n            </div>\n          </div>\n\n          <HomeRiskRadar />\n        </div>\n      </section>\n\n      <section className=\"rounded-3xl border bg-background p-6 sm:p-10\">\n        <div className=\"text-center mb-8\">\n          <div className=\"inline-flex items-center gap-2 rounded-full border bg-background/70 px-3 py-1 text-xs font-semibold uppercase tracking-[0.22em] text-primary/80\">\n            <span className=\"h-1.5 w-1.5 rounded-full bg-primary\" />\n            <span>\n              <LanguageText en=\"Live Risk Brain\" zh=\"实时风险大脑\" />\n            </span>\n          </div>\n          <h2 className=\"mt-5 text-3xl font-semibold tracking-tight sm:text-4xl\">\n            <LanguageText\n              en=\"Design → Production → Quality: Closed Loop\"\n              zh=\"设计 → 生产 → 质量：闭环系统\"\n            />\n          </h2>\n          <p className=\"mt-4 mx-auto max-w-3xl text-lg text-muted-foreground\">\n            <LanguageText\n              en=\"Not just calculations. A unified intelligence layer that connects engineering design, real-time production monitoring, and quality analytics into one explainable decision system.\"\n              zh=\"不只是计算。统一的智能层将工程设计、实时生产监控和质量分析连接成一个可解释的决策系统。\"\n            />\n          </p>\n        </div>\n\n        <div className=\"grid gap-6 md:grid-cols-3\">\n          <Card className=\"relative overflow-hidden border-2 border-emerald-200 bg-gradient-to-br from-emerald-50 to-white\">\n            <div className=\"absolute top-0 right-0 w-24 h-24 bg-emerald-100/50 rounded-full -translate-y-1/2 translate-x-1/2\" />\n            <CardHeader className=\"relative\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-emerald-100\">\n                  <Cog\n                    className=\"h-5 w-5 text-emerald-700 motion-reduce:animate-none animate-spin\"\n                    style={{ animationDuration: \"3.5s\" }}\n                  />\n                </div>\n                <div>\n                  <p className=\"text-xs font-semibold uppercase tracking-wider text-emerald-600\">Step 1</p>\n                  <CardTitle className=\"text-lg\">\n                    <LanguageText en=\"Design\" zh=\"设计\" />\n                  </CardTitle>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"relative space-y-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                <LanguageText\n                  en=\"Engineering Risk Radar evaluates design feasibility before production starts.\"\n                  zh=\"工程风险雷达在生产开始前评估设计可行性。\"\n                />\n              </p>\n              <p className=\"text-xs text-muted-foreground\">\n                <LanguageText\n                  en=\"Rule-based, explainable. No black-box decisions.\"\n                  zh=\"规则驱动，可解释；拒绝黑盒决策。\"\n                />\n              </p>\n              <div className=\"flex flex-wrap gap-2\">\n                <span className=\"rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700\">\n                  <LanguageText en=\"Stress Analysis\" zh=\"应力分析\" />\n                </span>\n                <span className=\"rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700\">\n                  <LanguageText en=\"DFM Rules\" zh=\"DFM 规则\" />\n                </span>\n                <span className=\"rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700\">\n                  <LanguageText en=\"Risk Score\" zh=\"风险评分\" />\n                </span>\n              </div>\n            </CardContent>\n            <CardFooter>\n              <Button asChild variant=\"outline\" size=\"sm\" className=\"w-full rounded-full border-emerald-200 text-emerald-700 hover:bg-emerald-50\">\n                <Link href=\"/tools/calculator\">\n                  <LanguageText en=\"Open Calculator\" zh=\"打开计算器\" />\n                  <ArrowRight className=\"ml-2 h-4 w-4\" />\n                </Link>\n              </Button>\n            </CardFooter>\n          </Card>\n\n          <Card className=\"relative overflow-hidden border-2 border-amber-200 bg-gradient-to-br from-amber-50 to-white\">\n            <div className=\"absolute top-0 right-0 w-24 h-24 bg-amber-100/50 rounded-full -translate-y-1/2 translate-x-1/2\" />\n            <CardHeader className=\"relative\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"relative flex h-10 w-10 items-center justify-center rounded-full bg-amber-100\">\n                  <span className=\"pointer-events-none absolute inset-0 rounded-full bg-amber-200/50 motion-reduce:hidden animate-ping\" />\n                  <Activity className=\"relative h-5 w-5 text-amber-700 motion-reduce:animate-none animate-pulse\" />\n                </div>\n                <div>\n                  <p className=\"text-xs font-semibold uppercase tracking-wider text-amber-600\">Step 2</p>\n                  <CardTitle className=\"text-lg\">\n                    <LanguageText en=\"Production\" zh=\"生产\" />\n                  </CardTitle>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"relative space-y-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                <LanguageText\n                  en=\"Live monitoring with explainable risk drivers. Demo-first, production-ready.\"\n                  zh=\"实时监控与可解释的风险驱动因素。演示优先，生产就绪。\"\n                />\n              </p>\n              <p className=\"text-xs text-muted-foreground\">\n                <LanguageText\n                  en=\"Engineering assumptions validated by real production data.\"\n                  zh=\"用真实生产数据验证工程假设。\"\n                />\n              </p>\n              <div className=\"flex flex-wrap gap-2\">\n                <span className=\"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700\">\n                  <LanguageText en=\"Cycle Time\" zh=\"节拍\" />\n                </span>\n                <span className=\"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700\">\n                  <LanguageText en=\"Temp Drift\" zh=\"温度漂移\" />\n                </span>\n                <span className=\"rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700\">\n                  <LanguageText en=\"Alerts\" zh=\"告警\" />\n                </span>\n              </div>\n            </CardContent>\n            <CardFooter>\n              <Button asChild variant=\"outline\" size=\"sm\" className=\"w-full rounded-full border-amber-200 text-amber-700 hover:bg-amber-50\">\n                <Link href=\"/production\">\n                  <LanguageText en=\"Open Dashboard\" zh=\"打开看板\" />\n                  <ArrowRight className=\"ml-2 h-4 w-4\" />\n                </Link>\n              </Button>\n            </CardFooter>\n          </Card>\n\n          <Card className=\"relative overflow-hidden border-2 border-sky-200 bg-gradient-to-br from-sky-50 to-white\">\n            <div className=\"absolute top-0 right-0 w-24 h-24 bg-sky-100/50 rounded-full -translate-y-1/2 translate-x-1/2\" />\n            <CardHeader className=\"relative\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"relative flex h-10 w-10 items-center justify-center rounded-full bg-sky-100\">\n                  <span className=\"pointer-events-none absolute inset-0 rounded-full bg-sky-200/50 motion-reduce:hidden animate-ping\" />\n                  <Shield className=\"relative h-5 w-5 text-sky-700 motion-reduce:animate-none animate-pulse\" />\n                </div>\n                <div>\n                  <p className=\"text-xs font-semibold uppercase tracking-wider text-sky-600\">Step 3</p>\n                  <CardTitle className=\"text-lg\">\n                    <LanguageText en=\"Quality\" zh=\"质量\" />\n                  </CardTitle>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"relative space-y-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                <LanguageText\n                  en=\"SPC, Nelson rules, Cp/Cpk, MSA (Gage R&R), and PPAP-ready reports.\"\n                  zh=\"SPC、Nelson 规则、Cp/Cpk、MSA（Gage R&R）和 PPAP 报告。\"\n                />\n              </p>\n              <p className=\"text-xs text-muted-foreground\">\n                <LanguageText\n                  en=\"Fully traceable, explainable, and auditable.\"\n                  zh=\"可追溯、可解释、可审计。\"\n                />\n              </p>\n              <div className=\"flex flex-wrap gap-2\">\n                <span className=\"rounded-full bg-sky-100 px-2 py-0.5 text-xs font-medium text-sky-700\">\n                  <LanguageText en=\"I-MR / Xbar-R\" zh=\"I-MR / Xbar-R\" />\n                </span>\n                <span className=\"rounded-full bg-sky-100 px-2 py-0.5 text-xs font-medium text-sky-700\">\n                  <LanguageText en=\"MSA\" zh=\"MSA\" />\n                </span>\n                <span className=\"rounded-full bg-sky-100 px-2 py-0.5 text-xs font-medium text-sky-700\">\n                  <LanguageText en=\"PPAP\" zh=\"PPAP\" />\n                </span>\n              </div>\n            </CardContent>\n            <CardFooter>\n              <Button asChild variant=\"outline\" size=\"sm\" className=\"w-full rounded-full border-sky-200 text-sky-700 hover:bg-sky-50\">\n                <Link href=\"/quality\">\n                  <LanguageText en=\"Open Quality\" zh=\"打开质量\" />\n                  <ArrowRight className=\"ml-2 h-4 w-4\" />\n                </Link>\n              </Button>\n            </CardFooter>\n          </Card>\n        </div>\n\n        <div className=\"mt-8 rounded-xl border bg-muted/30 p-4\">\n          <div className=\"flex flex-col items-center gap-4 text-center sm:flex-row sm:text-left\">\n            <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10\">\n              <BarChart3 className=\"h-6 w-6 text-primary\" />\n            </div>\n            <div className=\"flex-1\">\n              <p className=\"font-semibold\">\n                <LanguageText en=\"Live Risk Brain: The Unified Intelligence\" zh=\"Live Risk Brain：统一智能\" />\n              </p>\n              <p className=\"text-sm text-muted-foreground\">\n                <LanguageText\n                  en=\"Combines Engineering Radar + Production State + Quality Analytics into one explainable score with actionable drivers.\"\n                  zh=\"将工程雷达 + 生产状态 + 质量分析合成一个可解释的评分，并提供可执行的驱动因素。\"\n                />\n              </p>\n            </div>\n            <Button asChild variant=\"default\" className=\"rounded-full\">\n              <Link href=\"/production\">\n                <LanguageText en=\"Explore live scenarios\" zh=\"探索真实场景\" />\n                <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Link>\n            </Button>\n          </div>\n        </div>\n      </section>\n\n      <section className=\"relative overflow-hidden rounded-3xl border bg-gradient-to-br from-indigo-50 via-white to-sky-50 p-4 sm:p-6\">\n        <div className=\"pointer-events-none absolute inset-0 opacity-70\" aria-hidden={true}>\n          <div className=\"absolute -top-24 -left-24 h-64 w-64 rounded-full bg-indigo-200/40 blur-3xl\" />\n          <div className=\"absolute -bottom-24 -right-24 h-64 w-64 rounded-full bg-sky-200/40 blur-3xl\" />\n        </div>\n\n        <div className=\"relative grid gap-6 md:grid-cols-2\">\n          {(features as HomeFeature[]).map((feature, index) => {\n            const Icon = feature.icon;\n\n            return (\n              <HoverGlassCard\n                key={feature.title.en}\n                href={feature.href}\n                title={<LanguageText en={feature.title.en} zh={feature.title.zh} />}\n                description={<LanguageText en={feature.description.en} zh={feature.description.zh} />}\n                icon={<Icon className=\"size-5\" />}\n                footer={\n                  <span className=\"inline-flex items-center gap-2 text-sm font-medium text-primary\">\n                    <LanguageText en=\"Open module\" zh=\"进入模块\" />\n                    <span className=\"text-muted-foreground transition-colors group-hover:text-primary\">→</span>\n                  </span>\n                }\n              />\n            );\n          })}\n        </div>\n      </section>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/production/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LanguageText' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata } from \"next\";\nimport { ProductionDashboard } from \"@/components/production/ProductionDashboard\";\nimport { LanguageText } from \"@/components/language-context\";\n\nexport const metadata: Metadata = {\n  title: \"Spring Manufacturing Dashboard | Production Monitoring & Quality Insights\",\n  description:\n    \"Visualize spring production with real-time dashboards, work orders linked to design data, and manufacturing status monitoring. Built for engineering-driven factories.\",\n  keywords: [\n    \"spring manufacturing dashboard\",\n    \"production monitoring\",\n    \"OEE dashboard\",\n    \"spring coil production\",\n    \"quality control software\",\n    \"manufacturing execution system\",\n  ],\n};\n\nexport default function ProductionPage() {\n  return <ProductionDashboard />;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/quality/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":330,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":330,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10777,10780],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10777,10780],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":515,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":515,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18452,18455],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18452,18455],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":579,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":579,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22345,22348],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22345,22348],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":632,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":632,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24855,24858],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24855,24858],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Link from \"next/link\";\nimport { useMemo, useState } from \"react\";\n\nimport { LanguageText } from \"@/components/language-context\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Textarea } from \"@/components/ui/textarea\";\n\nimport { QualityImrCharts } from \"@/components/quality/QualityImrCharts\";\nimport { QualityStratificationChart } from \"@/components/quality/QualityStratificationChart\";\nimport { QualityXbarRCharts } from \"@/components/quality/QualityXbarRCharts\";\n\nimport type { FieldMapping, IngestPreview, QualityAnalysisResult, QualityDataset } from \"@/lib/quality\";\n\nexport default function QualityPage() {\n  const [step, setStep] = useState<\"upload\" | \"mapping\" | \"analysis\">(\"upload\");\n  const [csvText, setCsvText] = useState<string>(\"\");\n  const [delimiter, setDelimiter] = useState<string>(\",\");\n\n  const [stratifyBy, setStratifyBy] = useState<\"auto\" | \"none\" | \"machine\" | \"lot\" | \"shift\" | \"appraiser\" | \"gage\">(\"auto\");\n\n  const [dataset, setDataset] = useState<QualityDataset | null>(null);\n  const [preview, setPreview] = useState<IngestPreview | null>(null);\n  const [mapping, setMapping] = useState<FieldMapping | null>(null);\n  const [analysis, setAnalysis] = useState<QualityAnalysisResult | null>(null);\n  const [reportHtml, setReportHtml] = useState<string | null>(null);\n\n  const [selectedCharacteristic, setSelectedCharacteristic] = useState<string | null>(null);\n\n  const [reportMeta, setReportMeta] = useState({\n    customer: \"\",\n    supplier: \"\",\n    partNumber: \"\",\n    partName: \"\",\n    rev: \"\",\n    preparedBy: \"\",\n    approvedBy: \"\",\n    approvedAtISO: \"\",\n  });\n\n  const [busy, setBusy] = useState<string | null>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  const headers = dataset?.headers ?? [];\n\n  const sampleCsv = useMemo(() => {\n    return [\n      \"timestamp,characteristic,value,lsl,usl,unit,lot,machine\",\n      \"2025-01-01 08:00:00,FreeLength,50.02,49.8,50.2,mm,L1,M01\",\n      \"2025-01-01 08:03:00,FreeLength,49.96,49.8,50.2,mm,L1,M01\",\n      \"2025-01-01 08:06:00,FreeLength,50.11,49.8,50.2,mm,L1,M02\",\n    ].join(\"\\n\");\n  }, []);\n\n  const sampleCsvLarge = useMemo(() => {\n    let seed = 42;\n    const rand = () => {\n      seed = (seed * 1664525 + 1013904223) >>> 0;\n      return seed / 4294967296;\n    };\n\n    const approxNormal = () => {\n      let s = 0;\n      for (let i = 0; i < 6; i++) s += rand();\n      return s - 3;\n    };\n\n    const pad2 = (n: number) => String(n).padStart(2, \"0\");\n    const fmtTs = (d: Date) => {\n      return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth() + 1)}-${pad2(d.getUTCDate())}T${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}Z`;\n    };\n\n    const cols = [\n      \"timestamp\",\n      \"characteristic\",\n      \"value\",\n      \"lsl\",\n      \"usl\",\n      \"target\",\n      \"unit\",\n      \"lot\",\n      \"machine\",\n      \"shift\",\n      \"appraiser\",\n      \"gage\",\n      \"partId\",\n      \"result\",\n    ];\n\n    const base = new Date(Date.UTC(2025, 0, 1, 8, 0, 0));\n    const lines: string[] = [cols.join(\",\")];\n\n    const characteristics = [\n      { name: \"FreeLength\", mean: 50.0, std: 0.035, lsl: 49.8, usl: 50.2, target: 50.0, unit: \"mm\" },\n      { name: \"WireDiameter\", mean: 3.2, std: 0.008, lsl: 3.15, usl: 3.25, target: 3.2, unit: \"mm\" },\n      { name: \"Load@10mm\", mean: 105.0, std: 1.2, lsl: 100.0, usl: 110.0, target: 105.0, unit: \"N\" },\n    ] as const;\n\n    const rowsPerChar = 40;\n    let globalIdx = 0;\n\n    for (let cIdx = 0; cIdx < characteristics.length; cIdx++) {\n      const c = characteristics[cIdx];\n      for (let i = 0; i < rowsPerChar; i++) {\n        const ts = new Date(base.getTime() + globalIdx * 3 * 60 * 1000);\n        const lot = ([\"L1\", \"L2\", \"L3\"][cIdx] ?? \"L1\") as string;\n        const machine = `M${pad2((globalIdx % 3) + 1)}`;\n        const shift = globalIdx % 60 < 30 ? \"A\" : \"B\";\n        const inspector = `I${pad2((globalIdx % 4) + 1)}`;\n        const gage = `G${pad2((globalIdx % 2) + 1)}`;\n        const partId = `SN${String(globalIdx + 1).padStart(4, \"0\")}`;\n\n        const drift = cIdx === 2 ? (globalIdx / 120) * 0.6 : cIdx === 0 ? (globalIdx / 120) * 0.05 : 0;\n        let valueNum = c.mean + drift + approxNormal() * c.std;\n\n        if (i === 9 && cIdx === 0) valueNum = c.usl + 0.25;\n        if (i === 27 && cIdx === 1) valueNum = c.lsl - 0.03;\n        if (i === 33 && cIdx === 2) valueNum = c.usl + 3.5;\n\n        const valueStr = (() => {\n          if (i === 5 && cIdx === 2) return \"\";\n          if (i === 18 && cIdx === 0) return \"abc\";\n          return valueNum.toFixed(cIdx === 1 ? 4 : 3);\n        })();\n\n        const tsStr = i === 12 && cIdx === 1 ? \"not-a-time\" : fmtTs(ts);\n\n        const parsedVal = Number(valueStr);\n        const pass = isFinite(parsedVal) && valueStr.trim() !== \"\" && parsedVal >= c.lsl && parsedVal <= c.usl;\n        const result = pass ? \"PASS\" : valueStr.trim() === \"\" || !isFinite(parsedVal) ? \"UNKNOWN\" : \"FAIL\";\n\n        lines.push(\n          [\n            tsStr,\n            c.name,\n            valueStr,\n            String(c.lsl),\n            String(c.usl),\n            String(c.target),\n            c.unit,\n            lot,\n            machine,\n            shift,\n            inspector,\n            gage,\n            partId,\n            result,\n          ].join(\",\")\n        );\n\n        globalIdx++;\n      }\n    }\n\n    return lines.join(\"\\n\");\n  }, []);\n\n  async function ingest() {\n    setError(null);\n    setReportHtml(null);\n    setAnalysis(null);\n    setBusy(\"ingest\");\n    try {\n      const res = await fetch(\"/api/quality/ingest\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ csvText, delimiter }),\n      });\n\n      const data = await res.json();\n      if (!res.ok) {\n        setError((data?.errors && Array.isArray(data.errors) ? data.errors.join(\"\\n\") : data?.error) ?? \"Ingest failed\");\n        return;\n      }\n\n      setDataset(data.dataset as QualityDataset);\n      setPreview(data.preview as IngestPreview);\n      setMapping(data.mappingInference?.mapping as FieldMapping);\n      setStep(\"mapping\");\n    } finally {\n      setBusy(null);\n    }\n  }\n\n  async function runAnalysis() {\n    setError(null);\n    setReportHtml(null);\n    setBusy(\"analyze\");\n    try {\n      if (!dataset?.id) {\n        setError(\"Dataset missing\");\n        return;\n      }\n      if (!mapping?.value) {\n        setError(\"Mapping missing: value column is required\");\n        return;\n      }\n\n      const res = await fetch(\"/api/quality/analyze\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ dataset, mapping, options: { stratifyBy } }),\n      });\n\n      const data = await res.json();\n      if (!res.ok) {\n        setError(data?.error ?? \"Analyze failed\");\n        return;\n      }\n\n      setAnalysis(data.analysis as QualityAnalysisResult);\n      setSelectedCharacteristic((data.analysis as QualityAnalysisResult)?.characteristics?.[0]?.name ?? null);\n      setStep(\"analysis\");\n    } finally {\n      setBusy(null);\n    }\n  }\n\n  async function previewReportHtml() {\n    setError(null);\n    setBusy(\"report_html\");\n    try {\n      if (!dataset?.id || !mapping?.value) {\n        setError(\"Dataset/mapping missing\");\n        return;\n      }\n\n      const res = await fetch(\"/api/reports/quality-analysis?format=html\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          dataset,\n          mapping,\n          meta: { language: \"bilingual\", ...reportMeta },\n          options: { stratifyBy },\n        }),\n      });\n\n      const text = await res.text();\n      if (!res.ok) {\n        try {\n          const parsed = JSON.parse(text) as { error?: string };\n          setError(parsed?.error || text || \"Failed to generate HTML report\");\n        } catch {\n          setError(text || \"Failed to generate HTML report\");\n        }\n        return;\n      }\n\n      setReportHtml(text);\n    } finally {\n      setBusy(null);\n    }\n  }\n\n  async function exportPdf() {\n    setError(null);\n    setBusy(\"report_pdf\");\n    try {\n      if (!dataset?.id || !mapping?.value) {\n        setError(\"Dataset/mapping missing\");\n        return;\n      }\n\n      const res = await fetch(\"/api/reports/quality-analysis\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          dataset,\n          mapping,\n          meta: { language: \"bilingual\", ...reportMeta },\n          options: { stratifyBy },\n        }),\n      });\n\n      if (!res.ok) {\n        const text = await res.text();\n        setError(text || \"Failed to generate PDF\");\n        return;\n      }\n\n      const blob = await res.blob();\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `quality-analysis-${Date.now()}.pdf`;\n      document.body.appendChild(a);\n      a.click();\n      a.remove();\n      URL.revokeObjectURL(url);\n    } finally {\n      setBusy(null);\n    }\n  }\n\n  const mappingFields: Array<{ key: keyof FieldMapping; label: { en: string; zh: string }; required?: boolean }> = [\n    { key: \"value\", label: { en: \"Value\", zh: \"测量值\" }, required: true },\n    { key: \"characteristic\", label: { en: \"Characteristic\", zh: \"特性/项目\" } },\n    { key: \"timestamp\", label: { en: \"Timestamp\", zh: \"时间\" } },\n    { key: \"lsl\", label: { en: \"LSL\", zh: \"下限\" } },\n    { key: \"usl\", label: { en: \"USL\", zh: \"上限\" } },\n    { key: \"target\", label: { en: \"Target\", zh: \"目标/名义\" } },\n    { key: \"unit\", label: { en: \"Unit\", zh: \"单位\" } },\n    { key: \"lot\", label: { en: \"Lot\", zh: \"批次\" } },\n    { key: \"machine\", label: { en: \"Machine\", zh: \"机台/设备\" } },\n    { key: \"shift\", label: { en: \"Shift\", zh: \"班次\" } },\n    { key: \"partId\", label: { en: \"Part/Serial\", zh: \"件号/序列\" } },\n    { key: \"appraiser\", label: { en: \"Appraiser/Inspector\", zh: \"检验员\" } },\n    { key: \"gage\", label: { en: \"Gage\", zh: \"量具\" } },\n    { key: \"trial\", label: { en: \"Trial\", zh: \"试次/重复\" } },\n    { key: \"subgroupId\", label: { en: \"Subgroup\", zh: \"子组/分组\" } },\n    { key: \"result\", label: { en: \"Result\", zh: \"判定\" } },\n  ];\n\n  function updateMappingField(key: keyof FieldMapping, column: string | undefined) {\n    setMapping((prev) => {\n      const next: FieldMapping = { ...(prev ?? { value: headers[0] ?? \"value\" }) };\n      (next as any)[key] = column;\n      return next;\n    });\n  }\n\n  function resetAll() {\n    setStep(\"upload\");\n    setDataset(null);\n    setPreview(null);\n    setMapping(null);\n    setAnalysis(null);\n    setReportHtml(null);\n    setError(null);\n    setBusy(null);\n  }\n\n  return (\n    <section className=\"space-y-6\">\n      <div className=\"space-y-3\">\n        <p className=\"text-sm uppercase tracking-[0.3em] text-primary/70\">\n          <LanguageText en=\"Module • Quality Management\" zh=\"模块 • 质量管理\" />\n        </p>\n        <h1 className=\"text-3xl font-semibold tracking-tight\">\n          <LanguageText en=\"Quality Management\" zh=\"质量管理\" />\n        </h1>\n        <p className=\"text-muted-foreground\">\n          <LanguageText\n            en=\"This is a sidecar module. It will import inspection data and generate analytics + reports without changing any spring geometry/calculation/3D.\"\n            zh=\"这是一个旁路模块：用于导入质检数据并生成分析与报告，不会影响任何弹簧几何/计算/3D。\"\n          />\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            <LanguageText en=\"Workflow\" zh=\"流程\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex flex-wrap gap-2\">\n            <Button\n              variant={step === \"upload\" ? \"default\" : \"outline\"}\n              onClick={() => setStep(\"upload\")}\n              disabled={busy !== null}\n            >\n              <LanguageText en=\"1) Upload\" zh=\"1）导入\" />\n            </Button>\n            <Button\n              variant={step === \"mapping\" ? \"default\" : \"outline\"}\n              onClick={() => setStep(\"mapping\")}\n              disabled={!dataset || busy !== null}\n            >\n              <LanguageText en=\"2) Mapping\" zh=\"2）映射\" />\n            </Button>\n            <Button\n              variant={step === \"analysis\" ? \"default\" : \"outline\"}\n              onClick={() => setStep(\"analysis\")}\n              disabled={!analysis || busy !== null}\n            >\n              <LanguageText en=\"3) Analysis\" zh=\"3）分析\" />\n            </Button>\n            <div className=\"flex-1\" />\n            <Button variant=\"outline\" onClick={resetAll} disabled={busy !== null}>\n              <LanguageText en=\"Reset\" zh=\"重置\" />\n            </Button>\n          </div>\n\n          {error && <pre className=\"rounded-md border bg-muted/30 p-3 text-sm text-destructive whitespace-pre-wrap\">{error}</pre>}\n\n          {step === \"upload\" && (\n            <div className=\"grid gap-4 lg:grid-cols-2\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base\">\n                    <LanguageText en=\"CSV Input\" zh=\"CSV 输入\" />\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"space-y-2\">\n                    <Label>\n                      <LanguageText en=\"Upload CSV file\" zh=\"上传 CSV 文件\" />\n                    </Label>\n                    <Input\n                      type=\"file\"\n                      accept=\".csv,text/csv\"\n                      onChange={(e) => {\n                        const f = e.target.files?.[0];\n                        if (!f) return;\n                        const reader = new FileReader();\n                        reader.onload = () => setCsvText(String(reader.result ?? \"\"));\n                        reader.readAsText(f);\n                      }}\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label>\n                      <LanguageText en=\"Delimiter\" zh=\"分隔符\" />\n                    </Label>\n                    <Input value={delimiter} onChange={(e) => setDelimiter(e.target.value || \",\")} placeholder=\",\" />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label>\n                      <LanguageText en=\"Or paste CSV text\" zh=\"或直接粘贴 CSV 文本\" />\n                    </Label>\n                    <Textarea\n                      value={csvText}\n                      onChange={(e) => setCsvText(e.target.value)}\n                      className=\"min-h-[240px] font-mono text-xs\"\n                      placeholder={sampleCsv}\n                    />\n                  </div>\n\n                  <div className=\"flex gap-2\">\n                    <Button onClick={ingest} disabled={busy !== null || !csvText.trim()}>\n                      <LanguageText en={busy === \"ingest\" ? \"Importing...\" : \"Import\"} zh={busy === \"ingest\" ? \"导入中...\" : \"导入\"} />\n                    </Button>\n                    <Button variant=\"outline\" onClick={() => setCsvText(sampleCsv)} disabled={busy !== null}>\n                      <LanguageText en=\"Use sample\" zh=\"使用示例\" />\n                    </Button>\n                    <Button variant=\"outline\" onClick={() => setCsvText(sampleCsvLarge)} disabled={busy !== null}>\n                      <LanguageText en=\"Use large sample\" zh=\"使用大样本\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base\">\n                    <LanguageText en=\"Notes\" zh=\"说明\" />\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-2 text-sm text-muted-foreground\">\n                  <p>\n                    <LanguageText\n                      en=\"V1 supports CSV only. Data is stored under .tmp/quality and is sidecar (no impact on spring calculations).\"\n                      zh=\"V1 仅支持 CSV。数据存储在 .tmp/quality，属于旁路模块（不影响弹簧计算）。\"\n                    />\n                  </p>\n                  <p>\n                    <LanguageText\n                      en=\"Required: a numeric value column. Optional: characteristic, timestamp, LSL/USL for Cp/Cpk.\"\n                      zh=\"必填：数值列。可选：特性列、时间列，以及 LSL/USL 用于 Cp/Cpk。\"\n                    />\n                  </p>\n                  <div className=\"flex gap-2\">\n                    <Button asChild variant=\"outline\">\n                      <Link href=\"/\">\n                        <LanguageText en=\"Back to Home\" zh=\"返回首页\" />\n                      </Link>\n                    </Button>\n                    <Button asChild variant=\"outline\">\n                      <Link href=\"/tools/analysis\">\n                        <LanguageText en=\"Engineering Analysis\" zh=\"工程分析\" />\n                      </Link>\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          )}\n\n          {step === \"mapping\" && dataset && mapping && (\n            <div className=\"grid gap-4 lg:grid-cols-2\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base\">\n                    <LanguageText en=\"Field Mapping\" zh=\"字段映射\" />\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"rounded-md border p-3 text-sm\">\n                    <div className=\"flex items-center justify-between gap-3\">\n                      <div className=\"truncate font-medium\">{dataset.name}</div>\n                      <div className=\"text-muted-foreground\">{dataset.id}</div>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 gap-2 sm:grid-cols-2 sm:items-center\">\n                    <Label className=\"text-sm\">\n                      <LanguageText en=\"Stratify By\" zh=\"分层维度\" />\n                    </Label>\n                    <Select value={stratifyBy} onValueChange={(v) => setStratifyBy(v as any)}>\n                      <SelectTrigger className=\"w-full\">\n                        <SelectValue placeholder=\"auto\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"auto\">auto</SelectItem>\n                        <SelectItem value=\"none\">none</SelectItem>\n                        <SelectItem value=\"machine\">machine</SelectItem>\n                        <SelectItem value=\"lot\">lot</SelectItem>\n                        <SelectItem value=\"shift\">shift</SelectItem>\n                        <SelectItem value=\"appraiser\">appraiser</SelectItem>\n                        <SelectItem value=\"gage\">gage</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"rounded-md border p-3 space-y-3\">\n                    <div className=\"text-sm font-medium\">\n                      <LanguageText en=\"PPAP / Report Info\" zh=\"PPAP / 报告信息\" />\n                    </div>\n                    <div className=\"grid gap-3 md:grid-cols-2\">\n                      <div className=\"space-y-2\">\n                        <Label>Customer / 客户</Label>\n                        <Input value={reportMeta.customer} onChange={(e) => setReportMeta((p) => ({ ...p, customer: e.target.value }))} />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Supplier / 供应商</Label>\n                        <Input value={reportMeta.supplier} onChange={(e) => setReportMeta((p) => ({ ...p, supplier: e.target.value }))} />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Part No. / 零件号</Label>\n                        <Input value={reportMeta.partNumber} onChange={(e) => setReportMeta((p) => ({ ...p, partNumber: e.target.value }))} />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Part Name / 零件名称</Label>\n                        <Input value={reportMeta.partName} onChange={(e) => setReportMeta((p) => ({ ...p, partName: e.target.value }))} />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Rev / 版本</Label>\n                        <Input value={reportMeta.rev} onChange={(e) => setReportMeta((p) => ({ ...p, rev: e.target.value }))} />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Prepared By / 编制</Label>\n                        <Input value={reportMeta.preparedBy} onChange={(e) => setReportMeta((p) => ({ ...p, preparedBy: e.target.value }))} />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Approved By / 批准</Label>\n                        <Input value={reportMeta.approvedBy} onChange={(e) => setReportMeta((p) => ({ ...p, approvedBy: e.target.value }))} />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label>Approved Date / 批准日期</Label>\n                        <Input value={reportMeta.approvedAtISO} onChange={(e) => setReportMeta((p) => ({ ...p, approvedAtISO: e.target.value }))} placeholder=\"YYYY-MM-DD\" />\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    {mappingFields.map((f) => (\n                      <div key={String(f.key)} className=\"grid grid-cols-1 gap-2 sm:grid-cols-2 sm:items-center\">\n                        <Label className=\"text-sm\">\n                          <LanguageText en={f.label.en} zh={f.label.zh} />\n                          {f.required ? <span className=\"text-destructive\"> *</span> : null}\n                        </Label>\n                        <Select\n                          value={(mapping[f.key] as any) ?? \"__none__\"}\n                          onValueChange={(v) => updateMappingField(f.key, v === \"__none__\" ? undefined : v)}\n                        >\n                          <SelectTrigger className=\"w-full\">\n                            <SelectValue placeholder=\"—\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {!f.required && <SelectItem value=\"__none__\">—</SelectItem>}\n                            {headers.map((h) => (\n                              <SelectItem key={h} value={h}>\n                                {h}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    ))}\n                  </div>\n\n                  <div className=\"flex gap-2\">\n                    <Button onClick={runAnalysis} disabled={busy !== null}>\n                      <LanguageText en={busy === \"analyze\" ? \"Analyzing...\" : \"Analyze\"} zh={busy === \"analyze\" ? \"分析中...\" : \"分析\"} />\n                    </Button>\n                    <Button variant=\"outline\" onClick={() => setStep(\"upload\")} disabled={busy !== null}>\n                      <LanguageText en=\"Back\" zh=\"返回\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base\">\n                    <LanguageText en=\"Preview\" zh=\"预览\" />\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"text-sm text-muted-foreground\">\n                    <LanguageText en=\"First 20 rows\" zh=\"前 20 行\" />\n                  </div>\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        {preview?.headers.slice(0, 6).map((h) => (\n                          <TableHead key={h}>{h}</TableHead>\n                        ))}\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {(preview?.sampleRows ?? []).slice(0, 10).map((r, idx) => (\n                        <TableRow key={idx}>\n                          {preview?.headers.slice(0, 6).map((h) => (\n                            <TableCell key={h} className=\"text-xs text-muted-foreground\">\n                              {(r as any)?.[h] ?? \"\"}\n                            </TableCell>\n                          ))}\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </CardContent>\n              </Card>\n            </div>\n          )}\n\n          {step === \"analysis\" && analysis && dataset && mapping && (\n            <div className=\"space-y-4\">\n              {(() => {\n                const selected =\n                  analysis.characteristics.find((c) => c.name === selectedCharacteristic) ??\n                  analysis.characteristics[0] ??\n                  null;\n\n                return selected ? (\n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-base\">\n                        <LanguageText en=\"Charts\" zh=\"图表\" />\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                      <div className=\"grid grid-cols-1 gap-2 sm:grid-cols-2 sm:items-center\">\n                        <Label className=\"text-sm\">\n                          <LanguageText en=\"Characteristic\" zh=\"特性\" />\n                        </Label>\n                        <Select\n                          value={selectedCharacteristic ?? selected.name}\n                          onValueChange={(v) => setSelectedCharacteristic(v)}\n                        >\n                          <SelectTrigger className=\"w-full\">\n                            <SelectValue placeholder=\"—\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {analysis.characteristics.map((c) => (\n                              <SelectItem key={c.name} value={c.name}>\n                                {c.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <QualityImrCharts imr={selected.imr} height={260} />\n\n                      {selected.xbarr && <QualityXbarRCharts xbarr={selected.xbarr} height={260} />}\n\n                      {analysis.stratification && (\n                        <div className=\"space-y-2\">\n                          <div className=\"text-sm text-muted-foreground\">\n                            <LanguageText en=\"Stratification score comparison\" zh=\"分层评分对比\" />\n                          </div>\n                          <QualityStratificationChart stratification={analysis.stratification} height={260} />\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                ) : null;\n              })()}\n\n              <div className=\"grid gap-4 md:grid-cols-3\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base\">\n                      <LanguageText en=\"Overall\" zh=\"总体\" />\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-1 text-sm\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-muted-foreground\">Status</span>\n                      <span className=\"font-medium\">{analysis.status}</span>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-muted-foreground\">Score</span>\n                      <span className=\"font-medium\">{analysis.score}</span>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-muted-foreground\">Rows</span>\n                      <span className=\"font-medium\">{analysis.dataQuality.stats.totalRows}</span>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-muted-foreground\">Valid</span>\n                      <span className=\"font-medium\">{analysis.dataQuality.stats.validMeasurements}</span>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"md:col-span-2\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base\">\n                      <LanguageText en=\"Key Findings\" zh=\"关键发现\" />\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2 text-sm\">\n                    {analysis.keyFindings.length === 0 ? (\n                      <div className=\"text-muted-foreground\">—</div>\n                    ) : (\n                      <div className=\"space-y-1\">\n                        {analysis.keyFindings.slice(0, 10).map((f, idx) => (\n                          <div key={`${f.id}-${idx}`} className=\"flex gap-2\">\n                            <span className=\"w-[64px] shrink-0 font-mono text-xs\">{f.severity}</span>\n                            <span className=\"text-muted-foreground\">{f.title.en} / {f.title.zh}</span>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base\">\n                    <LanguageText en=\"Capability Summary\" zh=\"过程能力汇总\" />\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {analysis.stratification && (\n                    <div className=\"rounded-md border p-3 text-sm\">\n                      <div className=\"font-medium\">\n                        <LanguageText en=\"Stratification\" zh=\"分层\" />: {analysis.stratification.by}\n                      </div>\n                      <div className=\"mt-2 grid gap-1\">\n                        {analysis.stratification.strata.slice(0, 8).map((s) => (\n                          <div key={s.key} className=\"flex items-center justify-between\">\n                            <span className=\"text-muted-foreground\">{s.key}</span>\n                            <span className=\"font-mono text-xs\">{s.status} / {s.score} / n={s.count}</span>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Characteristic</TableHead>\n                        <TableHead className=\"text-right\">n</TableHead>\n                        <TableHead className=\"text-right\">mean</TableHead>\n                        <TableHead className=\"text-right\">std</TableHead>\n                        <TableHead className=\"text-right\">Cp</TableHead>\n                        <TableHead className=\"text-right\">Cpk</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {analysis.characteristics.slice(0, 20).map((c) => (\n                        <TableRow key={c.name}>\n                          <TableCell className=\"font-medium\">{c.name}</TableCell>\n                          <TableCell className=\"text-right text-muted-foreground\">{c.count}</TableCell>\n                          <TableCell className=\"text-right text-muted-foreground\">{c.capability.mean.toFixed(4)}</TableCell>\n                          <TableCell className=\"text-right text-muted-foreground\">{c.capability.std.toFixed(4)}</TableCell>\n                          <TableCell className=\"text-right text-muted-foreground\">\n                            {c.capability.cp === null ? \"—\" : c.capability.cp.toFixed(3)}\n                          </TableCell>\n                          <TableCell className=\"text-right text-muted-foreground\">\n                            {c.capability.cpk === null ? \"—\" : c.capability.cpk.toFixed(3)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n\n                  <div className=\"flex flex-wrap gap-2\">\n                    <Button variant=\"default\" onClick={previewReportHtml} disabled={busy !== null}>\n                      <LanguageText en={busy === \"report_html\" ? \"Generating...\" : \"Preview HTML\"} zh={busy === \"report_html\" ? \"生成中...\" : \"预览 HTML\"} />\n                    </Button>\n                    <Button variant=\"outline\" onClick={exportPdf} disabled={busy !== null}>\n                      <LanguageText en={busy === \"report_pdf\" ? \"Generating...\" : \"Export PDF\"} zh={busy === \"report_pdf\" ? \"生成中...\" : \"导出 PDF\"} />\n                    </Button>\n                    <Button variant=\"outline\" onClick={() => setStep(\"mapping\")} disabled={busy !== null}>\n                      <LanguageText en=\"Back to mapping\" zh=\"返回映射\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n\n              {reportHtml && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base\">\n                      <LanguageText en=\"Report Preview\" zh=\"报告预览\" />\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"rounded-md border overflow-hidden\">\n                      <iframe title=\"quality-report\" srcDoc={reportHtml} className=\"h-[520px] w-full\" />\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/rfq/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringDesign' is defined but never used.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'designSummary' is assigned a value but never used.","line":91,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { Suspense, useMemo, useState } from \"react\";\nimport { useSearchParams } from \"next/navigation\";\nimport { useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\n\nimport { SpringDesign } from \"@/lib/springTypes\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { LanguageText } from \"@/components/language-context\";\n\nconst numberFromParams = (value: string | null, fallback?: number) => {\n  if (!value) return fallback;\n  const parsed = Number(value);\n  return Number.isFinite(parsed) ? parsed : fallback;\n};\n\nconst contactSchema = z.object({\n  company: z.string().min(1, \"Required\"),\n  contactPerson: z.string().min(1, \"Required\"),\n  email: z.string().email(\"Invalid email\"),\n  phone: z.string().min(3, \"Required\"),\n  country: z.string().min(1, \"Required\"),\n});\n\nconst projectSchema = z.object({\n  applicationType: z.string().min(1, \"Required\"),\n  annualVolume: z.string().min(1, \"Required\"),\n  sop: z.string().min(1, \"Required\"),\n  productionRegion: z.string().min(1, \"Required\"),\n});\n\nconst requirementsSchema = z.object({\n  notes: z.string().min(10, \"Please provide more context\"),\n});\n\nconst rfqSchema = z.object({\n  company: contactSchema.shape.company,\n  contactPerson: contactSchema.shape.contactPerson,\n  email: contactSchema.shape.email,\n  phone: contactSchema.shape.phone,\n  country: contactSchema.shape.country,\n  applicationType: projectSchema.shape.applicationType,\n  annualVolume: projectSchema.shape.annualVolume,\n  sop: projectSchema.shape.sop,\n  productionRegion: projectSchema.shape.productionRegion,\n  notes: requirementsSchema.shape.notes,\n});\n\ntype RfqFormValues = z.infer<typeof rfqSchema>;\n\n// Main page component with Suspense boundary\nexport default function RfqPage() {\n  return (\n    <Suspense fallback={<div className=\"p-8 text-center text-muted-foreground\">Loading RFQ form...</div>}>\n      <RfqPageContent />\n    </Suspense>\n  );\n}\n\nfunction RfqPageContent() {\n  const searchParams = useSearchParams();\n  const code = searchParams.get(\"code\") ?? undefined;\n  \n  // Check for conical spring type\n  const springType = searchParams.get(\"springType\") ?? \"compression\";\n  const isConical = springType === \"conical\";\n\n  // Common parameters\n  const wireDiameter = numberFromParams(searchParams.get(\"d\")) ?? 3;\n  const activeCoils = numberFromParams(searchParams.get(\"Na\")) ?? 8;\n  const shearModulus = numberFromParams(searchParams.get(\"G\")) ?? 79300;\n  const freeLength = numberFromParams(searchParams.get(\"L0\")) ?? 50;\n  const springRate = numberFromParams(searchParams.get(\"k\")) ?? numberFromParams(searchParams.get(\"finalK\"));\n  const maxDeflection = numberFromParams(searchParams.get(\"dx\")) ?? numberFromParams(searchParams.get(\"dxMax\"));\n\n  // Compression spring specific\n  const meanDiameter = numberFromParams(searchParams.get(\"Dm\")) ?? 22;\n  const pitch = numberFromParams(searchParams.get(\"pitch\"));\n\n  // Conical spring specific\n  const largeDiameter = numberFromParams(searchParams.get(\"D1\"));\n  const smallDiameter = numberFromParams(searchParams.get(\"D2\"));\n  const finalLoad = numberFromParams(searchParams.get(\"finalLoad\"));\n  const finalStress = numberFromParams(searchParams.get(\"finalStress\"));\n\n  const designSummary = useMemo(() => {\n    if (isConical) {\n      return {\n        code,\n        type: \"conical\" as const,\n        wireDiameter,\n        largeOuterDiameter: largeDiameter ?? 30,\n        smallOuterDiameter: smallDiameter ?? 15,\n        activeCoils,\n        shearModulus,\n        freeLength,\n        notes: undefined,\n      };\n    }\n    return {\n      code,\n      type: \"compression\" as const,\n      wireDiameter,\n      meanDiameter,\n      activeCoils,\n      shearModulus,\n      freeLength,\n      pitch,\n      notes: undefined,\n    };\n  }, [code, isConical, wireDiameter, meanDiameter, largeDiameter, smallDiameter, activeCoils, shearModulus, freeLength, pitch]);\n\n  // Generate pre-fill notes based on spring type\n  const generateDefaultNotes = () => {\n    if (isConical && largeDiameter && smallDiameter) {\n      return `Conical compression spring design:\n- Large OD D₁: ${largeDiameter} mm, Small OD D₂: ${smallDiameter} mm\n- Wire diameter d: ${wireDiameter} mm\n- Active coils Na: ${activeCoils}, Free length L₀: ${freeLength} mm\n- Max deflection: ${maxDeflection ?? \"?\"} mm\n- Final load: ${finalLoad?.toFixed(2) ?? \"?\"} N at k=${springRate?.toFixed(2) ?? \"?\"} N/mm\n- Progressive stiffness (nonlinear)\n- Shear stress: ${finalStress?.toFixed(1) ?? \"?\"} MPa\n\nPlease quote this conical spring with telescoping design capability.`;\n    }\n    return `Please quote spring ${code ?? \"design TBD\"} with d=${wireDiameter}mm, Dm=${meanDiameter}mm, Na=${activeCoils}, L0=${freeLength}mm, k=${springRate ?? \"?\"} N/mm, Δx=${maxDeflection ?? \"?\"}mm.`;\n  };\n\n  const form = useForm<RfqFormValues>({\n    resolver: zodResolver(rfqSchema),\n    defaultValues: {\n      company: \"ISRI-SHUANGDI OEM\",\n      contactPerson: \"Engineering Coordinator\",\n      email: \"engineering@example.com\",\n      phone: \"+86 21 1234 5678\",\n      country: \"China\",\n      applicationType: isConical ? \"Industrial Equipment\" : \"Suspension\",\n      annualVolume: \"120,000\",\n      sop: \"Q2 2026\",\n      productionRegion: \"Asia\",\n      notes: generateDefaultNotes(),\n    },\n  });\n\n  const [status, setStatus] = useState<string | null>(null);\n\n  const onSubmit = (values: RfqFormValues) => {\n    const payload = {\n      contact: {\n        company: values.company,\n        contactPerson: values.contactPerson,\n        email: values.email,\n        phone: values.phone,\n        country: values.country,\n      },\n      project: {\n        applicationType: values.applicationType,\n        annualVolume: values.annualVolume,\n        sop: values.sop,\n        productionRegion: values.productionRegion,\n      },\n      springDesign: {\n        code,\n        wireDiameter,\n        meanDiameter,\n        activeCoils,\n        shearModulus,\n        freeLength,\n        pitch,\n        springRate,\n        maxDeflection,\n      },\n      notes: values.notes,\n    };\n\n    console.log(\"RFQ payload\", payload);\n    setStatus(\"RFQ submitted (mock). In production this will call an API endpoint like POST /api/rfq.\");\n  };\n\n  const summaryItems = isConical ? [\n    { label: \"Type\", value: \"Conical\" },\n    { label: \"D₁ (mm)\", value: largeDiameter ?? \"—\" },\n    { label: \"D₂ (mm)\", value: smallDiameter ?? \"—\" },\n    { label: \"d (mm)\", value: wireDiameter },\n    { label: \"Na\", value: activeCoils },\n    { label: \"L₀ (mm)\", value: freeLength },\n    { label: \"G (MPa)\", value: shearModulus },\n    { label: \"k (N/mm)\", value: springRate?.toFixed(2) ?? \"—\" },\n    { label: \"F (N)\", value: finalLoad?.toFixed(2) ?? \"—\" },\n    { label: \"τ (MPa)\", value: finalStress?.toFixed(1) ?? \"—\" },\n    { label: \"Δx max (mm)\", value: maxDeflection ?? \"—\" },\n  ] : [\n    { label: \"Code\", value: code ?? \"—\" },\n    { label: \"d (mm)\", value: wireDiameter },\n    { label: \"Dm (mm)\", value: meanDiameter },\n    { label: \"Na\", value: activeCoils },\n    { label: \"G (MPa)\", value: shearModulus },\n    { label: \"L₀ (mm)\", value: freeLength },\n    { label: \"Pitch (mm)\", value: pitch ?? \"—\" },\n    { label: \"k (N/mm)\", value: springRate ?? \"—\" },\n    { label: \"Δx max (mm)\", value: maxDeflection ?? \"—\" },\n  ];\n\n  return (\n    <section className=\"space-y-6\">\n      <div className=\"space-y-3\">\n        <p className=\"text-sm uppercase tracking-[0.3em] text-primary/70\">\n          <LanguageText en=\"Workflow • RFQ\" zh=\"流程 • 询价\" />\n        </p>\n        <h1 className=\"text-3xl font-semibold tracking-tight\">\n          <LanguageText en=\"Request for Quotation\" zh=\"询价中心\" />\n        </h1>\n        <p className=\"text-muted-foreground\">\n          <LanguageText\n            en=\"Finalize your design parameters and send a consolidated RFQ to the ISRI-SHUANGDI sourcing team. \"\n            zh=\"此处占位一键询价，将计算、仿真、测试、CAD 的结果汇总成一份采供请求。\"\n          />\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Design Summary</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <dl className=\"grid gap-3 sm:grid-cols-3\">\n            {summaryItems.map((item) => (\n              <div key={item.label} className=\"rounded-md border border-slate-200 bg-slate-50 p-3 text-sm\">\n                <dt className=\"text-xs uppercase tracking-wide text-slate-500\">{item.label}</dt>\n                <dd className=\"text-base font-semibold text-slate-900\">{item.value}</dd>\n              </div>\n            ))}\n          </dl>\n        </CardContent>\n      </Card>\n\n      <form className=\"space-y-6\" onSubmit={form.handleSubmit(onSubmit)}>\n        <Card>\n          <CardHeader>\n            <CardTitle>Contact & Project Information</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              {(\n                [\n                  { name: \"company\" as const, label: \"Company Name\" },\n                  { name: \"contactPerson\" as const, label: \"Contact Person\" },\n                  { name: \"email\" as const, label: \"Email\" },\n                  { name: \"phone\" as const, label: \"Phone\" },\n                  { name: \"country\" as const, label: \"Country / Region\" },\n                ] as const\n              ).map((field) => (\n                <div key={field.name} className=\"space-y-2\">\n                  <Label htmlFor={field.name}>{field.label}</Label>\n                  <Input id={field.name} {...form.register(field.name)} />\n                  {form.formState.errors[field.name] && (\n                    <p className=\"text-sm text-red-500\">{form.formState.errors[field.name]?.message}</p>\n                  )}\n                </div>\n              ))}\n            </div>\n\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"applicationType\">Application Type</Label>\n                <select\n                  id=\"applicationType\"\n                  className=\"w-full rounded-md border border-slate-200 bg-white p-2 text-sm\"\n                  {...form.register(\"applicationType\")}\n                >\n                  {\"Engine Brake Suspension Seating Industrial Other\".split(\" \").map((option) => (\n                    <option key={option} value={option}>\n                      {option}\n                    </option>\n                  ))}\n                </select>\n                {form.formState.errors.applicationType && (\n                  <p className=\"text-sm text-red-500\">{form.formState.errors.applicationType?.message}</p>\n                )}\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"annualVolume\">Annual Volume (Estimated)</Label>\n                <Input id=\"annualVolume\" {...form.register(\"annualVolume\")} />\n                {form.formState.errors.annualVolume && (\n                  <p className=\"text-sm text-red-500\">{form.formState.errors.annualVolume?.message}</p>\n                )}\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"sop\">SOP / Start of Production</Label>\n                <Input id=\"sop\" {...form.register(\"sop\")} />\n                {form.formState.errors.sop && (\n                  <p className=\"text-sm text-red-500\">{form.formState.errors.sop?.message}</p>\n                )}\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"productionRegion\">Region of Production</Label>\n                <select\n                  id=\"productionRegion\"\n                  className=\"w-full rounded-md border border-slate-200 bg-white p-2 text-sm\"\n                  {...form.register(\"productionRegion\")}\n                >\n                  {[\"Asia\", \"Europe\", \"North America\", \"South America\", \"Other\"].map((region) => (\n                    <option key={region} value={region}>\n                      {region}\n                    </option>\n                  ))}\n                </select>\n                {form.formState.errors.productionRegion && (\n                  <p className=\"text-sm text-red-500\">{form.formState.errors.productionRegion?.message}</p>\n                )}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Spring Requirements</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"notes\">Requirement Details</Label>\n              <textarea\n                id=\"notes\"\n                rows={5}\n                className=\"w-full rounded-md border border-slate-200 bg-white p-3 text-sm\"\n                {...form.register(\"notes\")}\n              />\n              {form.formState.errors.notes && (\n                <p className=\"text-sm text-red-500\">{form.formState.errors.notes?.message}</p>\n              )}\n            </div>\n\n            <div className=\"rounded-md border border-dashed border-slate-300 bg-slate-50 p-4 text-sm text-slate-500\">\n              File upload placeholder — future versions will accept CAD references, test data, or PDF drawings with backend storage integration.\n            </div>\n          </CardContent>\n        </Card>\n\n        <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n          <div className=\"text-xs text-slate-500\">\n            RFQ submissions will be routed to ISRI-SHUANGDI sourcing and manufacturing teams.\n          </div>\n          <Button type=\"submit\" className=\"w-full sm:w-auto\">\n            Submit RFQ\n          </Button>\n        </div>\n      </form>\n\n      {status && <p className=\"rounded-md border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-700\">{status}</p>}\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/advanced-analysis/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'simulateCoating' is defined but never used.","line":55,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":55,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CoatingSimulationResult' is defined but never used.","line":63,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":63,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'simulationStore' is assigned a value but never used.","line":98,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":98,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3858,3861],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3858,3861],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4992,4995],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4992,4995],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":155,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5068,5071],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5068,5071],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":160,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5225,5228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5225,5228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":217,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":217,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7514,7517],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7514,7517],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":218,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":218,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7598,7601],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7598,7601],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":218,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":218,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7632,7635],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7632,7635],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":219,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7716,7719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7716,7719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":238,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8292,8295],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8292,8295],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":238,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8326,8329],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8326,8329],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8410,8413],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8410,8413],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":266,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":266,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9346,9349],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9346,9349],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":268,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":268,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9488,9491],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9488,9491],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":268,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":268,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9522,9525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9522,9525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":279,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":279,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9976,9979],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9976,9979],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":292,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10398,10401],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10398,10401],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":294,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":294,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10491,10494],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10491,10494],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":335,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":335,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11876,11879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11876,11879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":459,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":459,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15786,15789],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15786,15789],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":558,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":558,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19318,19321],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19318,19321],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":634,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":634,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22514,22517],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22514,22517],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":683,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":683,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24808,24811],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24808,24811],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":734,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":734,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26856,26859],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26856,26859],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":756,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":756,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27575,27578],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27575,27578],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":836,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":836,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31165,31168],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31165,31168],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useMemo\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":841,"column":24,"nodeType":"Identifier","endLine":841,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":991,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":991,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36848,36851],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36848,36851],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1020,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1020,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[37750,37753],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[37750,37753],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1033,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1033,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38445,38448],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38445,38448],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1033,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1033,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38479,38482],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38479,38482],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1034,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1034,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38566,38569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38566,38569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1258,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1258,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47418,47421],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47418,47421],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1265,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1265,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47726,47729],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47726,47729],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1265,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1265,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47760,47763],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47760,47763],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1266,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1266,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[47845,47848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[47845,47848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":35,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * Advanced Analysis Page - Phase 6 & 7\n * 高级分析页面 - 数字孪生系统\n * \n * Manufacturing simulation, AI recommendations, standards compliance, and Digital Twin\n */\n\nimport { useState, useMemo, useEffect } from 'react';\nimport { useSpringAnalysisStore } from '@/lib/stores/springAnalysisStore';\nimport { useSpringSimulationStore } from '@/lib/stores/springSimulationStore';\nimport { getSpringMaterial } from '@/lib/materials/springMaterials';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Progress } from '@/components/ui/progress';\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';\nimport { \n  Factory, \n  Shield, \n  Brain, \n  FileCheck, \n  AlertTriangle, \n  CheckCircle2, \n  XCircle,\n  Loader2,\n  ArrowLeft,\n  RefreshCw,\n  Download,\n  Cpu,\n  Activity,\n  DollarSign,\n  Waves,\n  Target\n} from 'lucide-react';\nimport Link from 'next/link';\n\n// Phase 6 engines\nimport { simulateCoilingProcess } from '@/lib/engine/coilingProcess';\nimport { simulateShotPeening } from '@/lib/engine/shotPeening';\nimport { simulateScragTest } from '@/lib/engine/scragTest';\nimport { checkManufacturability } from '@/lib/engine/manufacturabilityCheck';\nimport { runAllStandardChecks } from '@/lib/engine/standardsCheck';\nimport { recommendMaterials } from '@/lib/engine/materialRecommendation';\nimport { predictFatigueLife, createFeaturesFromSpring } from '@/lib/engine/mlFatiguePredictor';\n\n// Phase 7 engines\nimport {\n  generateFEAScripts,\n  downloadFEAScript,\n  calculateCrackInitiationProbability,\n  analyzeCorrosion,\n  simulateCoating,\n  predictCostAndYield,\n  analyzeHarmonicResponse,\n  modelHealthDegradation,\n  analyzeFractureHotspots,\n  type FEAScriptResult,\n  type CrackInitiationResult,\n  type CorrosionAnalysisResult,\n  type CoatingSimulationResult,\n  type CostYieldPredictionResult,\n  type HarmonicResponseResult,\n  type HealthDegradationResult,\n  type HotspotTrackingResult,\n} from '@/lib/engine/phase7';\n\n// Torsion spring advanced analysis\nimport {\n  runTorsionAdvancedAnalysis,\n  type TorsionAdvancedAnalysisResult,\n} from '@/lib/engine/torsionAdvancedAnalysis';\n\nexport default function AdvancedAnalysisPage() {\n  const [activeTab, setActiveTab] = useState('manufacturing');\n  const [isRunning, setIsRunning] = useState(false);\n  const [runProgress, setRunProgress] = useState(0);\n\n  // Global analysis store\n  const {\n    geometry,\n    workingConditions,\n    materialId,\n    analysisResult,\n    phase6Manufacturing,\n    phase6Quality,\n    phase6AI,\n    setPhase6Manufacturing,\n    setPhase6Quality,\n    setPhase6AI,\n    hasValidGeometry,\n    hasAnalysisResult,\n  } = useSpringAnalysisStore();\n\n  // Simulation store for 3D visualization sync\n  const simulationStore = useSpringSimulationStore();\n\n  // Get material data\n  const material = useMemo(() => {\n    return materialId ? getSpringMaterial(materialId) : null;\n  }, [materialId]);\n\n  // Check if we have valid data to analyze\n  const canAnalyze = hasValidGeometry() && hasAnalysisResult() && material !== null;\n\n  // Torsion spring advanced analysis state\n  const [torsionAnalysis, setTorsionAnalysis] = useState<TorsionAdvancedAnalysisResult | null>(null);\n\n  // Check if this is a torsion spring\n  const isTorsionSpring = geometry?.type === 'torsion';\n\n  // Run all Phase 6 analyses\n  const runPhase6Analysis = async () => {\n    if (!geometry || !analysisResult || !material || !workingConditions) return;\n\n    setIsRunning(true);\n    setRunProgress(0);\n\n    try {\n      // Special handling for torsion springs\n      if (geometry.type === 'torsion') {\n        setRunProgress(20);\n        \n        const torsionGeom = geometry as any;\n        const torsionResult = runTorsionAdvancedAnalysis({\n          wireDiameter: geometry.wireDiameter,\n          meanDiameter: torsionGeom.meanDiameter,\n          activeCoils: geometry.activeCoils,\n          bodyLength: torsionGeom.bodyLength || geometry.wireDiameter * geometry.activeCoils,\n          legLength1: torsionGeom.legLength1 || 25,\n          legLength2: torsionGeom.legLength2 || 25,\n          freeAngle: torsionGeom.legAngle || 90,\n          workingAngle: workingConditions.maxDeflection || 45,\n          materialId: geometry.materialId,\n        }, 20);\n        \n        setTorsionAnalysis(torsionResult);\n        setRunProgress(50);\n        \n        // Still run some generic analyses for torsion springs\n        const shotPeeningResult = simulateShotPeening({\n          wireDiameter: geometry.wireDiameter,\n          peakStress: 600,\n          attenuationDepth: 0.1,\n          coverage: 200,\n          shotDiameter: 0.6,\n          almenIntensity: '0.25A',\n        }, material.snCurve?.tau2 || 400, analysisResult.stress.tauEffective);\n        \n        setPhase6Manufacturing({\n          coilingProcess: null as any,\n          shotPeening: shotPeeningResult,\n          scragTest: null as any,\n        });\n        \n        // Run manufacturability check for torsion springs\n        setRunProgress(70);\n        const torsionGeometry = geometry as any;\n        const torsionMeanDiam = torsionGeometry.meanDiameter;\n        const torsionBodyLength = torsionGeometry.bodyLength || geometry.wireDiameter * geometry.activeCoils;\n        const torsionPitch = geometry.wireDiameter * 1.1; // Close-wound\n        \n        const torsionManufacturabilityResult = checkManufacturability({\n          wireDiameter: geometry.wireDiameter,\n          meanDiameter: torsionMeanDiam,\n          outerDiameter: torsionMeanDiam + geometry.wireDiameter,\n          innerDiameter: torsionMeanDiam - geometry.wireDiameter,\n          freeLength: torsionBodyLength,\n          activeCoils: geometry.activeCoils,\n          totalCoils: geometry.activeCoils + 2,\n          pitch: torsionPitch,\n          endType: 'closed',\n          springType: 'torsion',\n          productionVolume: 'medium',\n        });\n        \n        setRunProgress(85);\n        \n        const torsionStandardsResult = runAllStandardChecks({\n          wireDiameter: geometry.wireDiameter,\n          meanDiameter: torsionMeanDiam,\n          outerDiameter: torsionMeanDiam + geometry.wireDiameter,\n          freeLength: torsionBodyLength,\n          activeCoils: geometry.activeCoils,\n          totalCoils: geometry.activeCoils + 2,\n          springRate: analysisResult.springRate,\n          maxStress: analysisResult.stress.tauEffective,\n          meanStress: analysisResult.fatigue.tauMean,\n          alternatingStress: analysisResult.fatigue.tauAlt,\n          safetyFactor: analysisResult.safety.staticSafetyFactor,\n          materialId: geometry.materialId,\n          operatingTemperature: 20,\n          fatigueLife: analysisResult.fatigue.estimatedCycles,\n        });\n        \n        setPhase6Quality({\n          manufacturability: torsionManufacturabilityResult,\n          standardsCheck: {\n            asme: torsionStandardsResult.asme,\n            sae: torsionStandardsResult.sae,\n            din: torsionStandardsResult.din,\n          },\n        });\n        \n        setRunProgress(100);\n        setIsRunning(false);\n        return;\n      }\n\n      // 1. Manufacturing Analysis (30%) - for compression/extension springs\n      setRunProgress(10);\n      \n      const coilingResult = simulateCoilingProcess({\n        wireDiameter: geometry.wireDiameter,\n        mandrelDiameter: (geometry as any).meanDiameter - geometry.wireDiameter,\n        targetMeanDiameter: (geometry as any).meanDiameter || (geometry as any).largeOuterDiameter - geometry.wireDiameter,\n        targetPitch: ((geometry as any).freeLength - geometry.wireDiameter * 2) / geometry.activeCoils,\n        feedRate: 20,\n        pitchCamAngle: 15,\n        materialId: geometry.materialId,\n      });\n\n      setRunProgress(20);\n\n      const shotPeeningResult = simulateShotPeening({\n        wireDiameter: geometry.wireDiameter,\n        peakStress: 600,\n        attenuationDepth: 0.1,\n        coverage: 200,\n        shotDiameter: 0.6,\n        almenIntensity: '0.25A',\n      }, material.snCurve?.tau2 || 400, analysisResult.stress.tauEffective);\n\n      setRunProgress(30);\n\n      const meanDiam = (geometry as any).meanDiameter || (geometry as any).largeOuterDiameter - geometry.wireDiameter;\n      const freeLen = (geometry as any).freeLength;\n      const scragDeflection = freeLen * 0.3; // 30% deflection for scrag\n      const scragForce = analysisResult.springRate * scragDeflection;\n\n      const scragResult = simulateScragTest({\n        originalFreeLength: freeLen,\n        originalSpringRate: analysisResult.springRate,\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter: meanDiam,\n        activeCoils: geometry.activeCoils,\n        scragForce,\n        scragDeflection,\n        materialId: geometry.materialId,\n        scragCycles: 3,\n        scragTemperature: 20,\n      });\n\n      setPhase6Manufacturing({\n        coilingProcess: coilingResult,\n        shotPeening: shotPeeningResult,\n        scragTest: scragResult,\n      });\n\n      // 2. Quality & Standards (60%) - for compression/extension/conical springs\n      // Note: torsion springs are handled above and return early\n      setRunProgress(40);\n\n      const freeLength = (geometry as any).freeLength;\n      const pitch = (freeLength - geometry.wireDiameter * 2) / geometry.activeCoils;\n      const meanDiameter = (geometry as any).meanDiameter || (geometry as any).largeOuterDiameter - geometry.wireDiameter;\n      const outerDiameter = meanDiameter + geometry.wireDiameter;\n      const innerDiameter = meanDiameter - geometry.wireDiameter;\n\n      const manufacturabilityResult = checkManufacturability({\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter,\n        outerDiameter,\n        innerDiameter,\n        freeLength,\n        activeCoils: geometry.activeCoils,\n        totalCoils: (geometry as any).totalCoils || geometry.activeCoils + 2,\n        pitch,\n        endType: 'closed_ground',\n        springType: geometry.type as 'compression' | 'extension' | 'conical',\n        productionVolume: 'medium',\n      });\n\n      setRunProgress(50);\n\n      const standardsResult = runAllStandardChecks({\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter,\n        outerDiameter,\n        freeLength: (geometry as any).freeLength,\n        activeCoils: geometry.activeCoils,\n        totalCoils: (geometry as any).totalCoils || geometry.activeCoils + 2,\n        springRate: analysisResult.springRate,\n        maxStress: analysisResult.stress.tauEffective,\n        meanStress: analysisResult.fatigue.tauMean,\n        alternatingStress: analysisResult.fatigue.tauAlt,\n        safetyFactor: analysisResult.safety.staticSafetyFactor,\n        materialId: geometry.materialId,\n        operatingTemperature: 20,\n        fatigueLife: analysisResult.fatigue.estimatedCycles,\n      });\n\n      setRunProgress(60);\n\n      setPhase6Quality({\n        manufacturability: manufacturabilityResult,\n        standardsCheck: {\n          asme: standardsResult.asme,\n          sae: standardsResult.sae,\n          din: standardsResult.din,\n        },\n      });\n\n      // 3. AI/ML Analysis (100%)\n      setRunProgress(70);\n\n      const materialRecResult = recommendMaterials({\n        desiredFatigueLife: workingConditions.targetCycles || 1e6,\n        operatingTemperature: 20,\n        corrosionEnvironment: 'none',\n        targetSpringRate: analysisResult.springRate,\n        maxWorkingStress: analysisResult.stress.tauEffective,\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter,\n        budgetLevel: 'medium',\n      }, geometry.materialId);\n\n      setRunProgress(85);\n\n      const fatigueFeatures = createFeaturesFromSpring(\n        geometry.wireDiameter,\n        meanDiameter,\n        (geometry as any).totalCoils || geometry.activeCoils + 2,\n        geometry.activeCoils,\n        analysisResult.stress.tauEffective * 0.3,\n        geometry.materialId,\n        analysisResult.fatigue.tauMean,\n        analysisResult.fatigue.tauAlt,\n        20,\n        0,\n        shotPeeningResult ? 2 : 0\n      );\n\n      const mlPrediction = predictFatigueLife(fatigueFeatures, 'ensemble');\n\n      setRunProgress(100);\n\n      setPhase6AI({\n        materialRecommendation: materialRecResult,\n        mlFatiguePrediction: mlPrediction,\n      });\n\n    } catch (error) {\n      console.error('Phase 6 analysis error:', error);\n    } finally {\n      setIsRunning(false);\n    }\n  };\n\n  // Auto-run analysis if we have data but no Phase 6 results\n  useEffect(() => {\n    if (canAnalyze && !phase6Manufacturing && !isRunning) {\n      // Don't auto-run, let user trigger it\n    }\n  }, [canAnalyze, phase6Manufacturing, isRunning]);\n\n  // No data state\n  if (!canAnalyze) {\n    return (\n      <div className=\"container mx-auto p-6 max-w-6xl\">\n        <div className=\"flex items-center gap-2 mb-6\">\n          <Link href=\"/tools/analysis\">\n            <Button variant=\"ghost\" size=\"sm\">\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\n              返回工程分析\n            </Button>\n          </Link>\n        </div>\n\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertTitle>需要弹簧数据</AlertTitle>\n          <AlertDescription>\n            请先在计算器或工程分析页面设计弹簧，然后返回此页面进行高级分析。\n            <br />\n            <Link href=\"/tools/calculator\" className=\"text-blue-600 hover:underline\">\n              前往弹簧计算器 →\n            </Link>\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-7xl\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-6\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/tools/analysis\">\n            <Button variant=\"ghost\" size=\"sm\">\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\n              返回\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-2xl font-bold\">高级分析 Advanced Analysis</h1>\n            <p className=\"text-muted-foreground text-sm\">\n              Phase 6 & 7: 制造仿真 · AI推荐 · 数字孪生\n            </p>\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <Button \n            onClick={runPhase6Analysis} \n            disabled={isRunning}\n            className=\"gap-2\"\n          >\n            {isRunning ? (\n              <>\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                分析中... {runProgress}%\n              </>\n            ) : (\n              <>\n                <RefreshCw className=\"h-4 w-4\" />\n                {phase6Manufacturing ? '重新分析' : '开始分析'}\n              </>\n            )}\n          </Button>\n        </div>\n      </div>\n\n      {/* Progress bar when running */}\n      {isRunning && (\n        <Progress value={runProgress} className=\"mb-6 h-2\" />\n      )}\n\n      {/* Current Spring Summary */}\n      <Card className=\"mb-6\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-base\">当前弹簧 Current Spring</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm\">\n            <div>\n              <span className=\"text-muted-foreground\">类型</span>\n              <p className=\"font-medium\">{geometry?.type === 'compression' ? '压缩弹簧' : geometry?.type === 'conical' ? '锥形弹簧' : geometry?.type}</p>\n            </div>\n            <div>\n              <span className=\"text-muted-foreground\">线径 d</span>\n              <p className=\"font-medium\">{geometry?.wireDiameter} mm</p>\n            </div>\n            <div>\n              <span className=\"text-muted-foreground\">中径 Dm</span>\n              <p className=\"font-medium\">{(geometry as any)?.meanDiameter?.toFixed(2) || '-'} mm</p>\n            </div>\n            <div>\n              <span className=\"text-muted-foreground\">有效圈数</span>\n              <p className=\"font-medium\">{geometry?.activeCoils}</p>\n            </div>\n            <div>\n              <span className=\"text-muted-foreground\">材料</span>\n              <p className=\"font-medium\">{material?.nameZh || materialId}</p>\n            </div>\n            <div>\n              <span className=\"text-muted-foreground\">刚度 k</span>\n              <p className=\"font-medium\">{analysisResult?.springRate.toFixed(2)} N/mm</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Main Tabs */}\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-3 lg:grid-cols-6 mb-6\">\n          <TabsTrigger value=\"manufacturing\" className=\"gap-1\">\n            <Factory className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline text-xs\">制造工艺</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"quality\" className=\"gap-1\">\n            <FileCheck className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline text-xs\">质量标准</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"ai\" className=\"gap-1\">\n            <Brain className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline text-xs\">AI分析</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"digital-twin\" className=\"gap-1\">\n            <Cpu className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline text-xs\">数字孪生</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"fea\" className=\"gap-1\">\n            <Target className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline text-xs\">FEA仿真</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"summary\" className=\"gap-1\">\n            <Shield className=\"h-4 w-4\" />\n            <span className=\"hidden sm:inline text-xs\">综合报告</span>\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Manufacturing Tab */}\n        <TabsContent value=\"manufacturing\">\n          {isTorsionSpring && torsionAnalysis ? (\n            <TorsionAnalysisTab data={torsionAnalysis} isRunning={isRunning} />\n          ) : (\n            <ManufacturingTab data={phase6Manufacturing} isRunning={isRunning} />\n          )}\n        </TabsContent>\n\n        {/* Quality Tab */}\n        <TabsContent value=\"quality\">\n          <QualityTab data={phase6Quality} isRunning={isRunning} />\n        </TabsContent>\n\n        {/* AI Tab */}\n        <TabsContent value=\"ai\">\n          <AITab data={phase6AI} isRunning={isRunning} />\n        </TabsContent>\n\n        {/* Digital Twin Tab - Phase 7 */}\n        <TabsContent value=\"digital-twin\">\n          <DigitalTwinTab \n            geometry={geometry}\n            analysisResult={analysisResult}\n            material={material}\n          />\n        </TabsContent>\n\n        {/* FEA Tab - Phase 7 */}\n        <TabsContent value=\"fea\">\n          <FEATab \n            geometry={geometry}\n            analysisResult={analysisResult}\n            material={material}\n          />\n        </TabsContent>\n\n        {/* Summary Tab */}\n        <TabsContent value=\"summary\">\n          <SummaryTab \n            manufacturing={phase6Manufacturing}\n            quality={phase6Quality}\n            ai={phase6AI}\n            analysisResult={analysisResult}\n          />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\n// Manufacturing Tab Component\nfunction ManufacturingTab({ data, isRunning }: { data: any; isRunning: boolean }) {\n  if (isRunning) {\n    return <LoadingCard title=\"制造工艺分析\" />;\n  }\n\n  if (!data) {\n    return <EmptyCard title=\"制造工艺分析\" message='点击\"开始分析\"运行制造工艺仿真' />;\n  }\n\n  return (\n    <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n      {/* Coiling Process */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">卷绕工艺 Coiling</CardTitle>\n          <CardDescription>CNC卷绕残余应力分析</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          <DataRow label=\"残余弯曲应力\" value={`${data.coilingProcess?.residualBendingStress?.toFixed(1)} MPa`} />\n          <DataRow label=\"残余扭转应力\" value={`${data.coilingProcess?.residualTorsionalStress?.toFixed(1)} MPa`} />\n          <DataRow label=\"回弹角\" value={`${data.coilingProcess?.springbackAngle?.toFixed(2)}°`} />\n          <DataRow label=\"补偿芯棒直径\" value={`${data.coilingProcess?.compensatedMandrelDiameter?.toFixed(2)} mm`} />\n          <DataRow \n            label=\"疲劳寿命折减\" \n            value={`${((1 - data.coilingProcess?.fatigueLifeReductionFactor) * 100)?.toFixed(1)}%`}\n            status={data.coilingProcess?.fatigueLifeReductionFactor > 0.8 ? 'good' : 'warning'}\n          />\n        </CardContent>\n      </Card>\n\n      {/* Shot Peening */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">喷丸强化 Shot Peening</CardTitle>\n          <CardDescription>表面残余压应力分析</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          <DataRow \n            label=\"表面压应力\" \n            value={`${data.shotPeening?.surfaceStress?.toFixed(0)} MPa`}\n            status=\"good\"\n          />\n          <DataRow label=\"压应力层深度\" value={`${data.shotPeening?.effectiveDepth?.toFixed(3)} mm`} />\n          <DataRow \n            label=\"疲劳寿命提升\" \n            value={`${data.shotPeening?.enduranceEnhancementFactor?.toFixed(2)}×`}\n            status=\"good\"\n          />\n          <DataRow label=\"新疲劳极限\" value={`${data.shotPeening?.newEnduranceLimit?.toFixed(0)} MPa`} />\n          <DataRow label=\"修正有效应力\" value={`${data.shotPeening?.correctedEffectiveStress?.toFixed(0)} MPa`} />\n        </CardContent>\n      </Card>\n\n      {/* Scrag Test */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">立定处理 Scrag Test</CardTitle>\n          <CardDescription>预压稳定化分析</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          <DataRow label=\"塑性应变\" value={`${(data.scragTest?.residualPlasticStrain * 100)?.toFixed(3)}%`} />\n          <DataRow label=\"永久变形\" value={`${data.scragTest?.permanentSet?.toFixed(3)} mm`} />\n          <DataRow label=\"新自由长度\" value={`${data.scragTest?.newFreeLength?.toFixed(2)} mm`} />\n          <DataRow label=\"刚度变化\" value={`${data.scragTest?.springRateChange > 0 ? '+' : ''}${data.scragTest?.springRateChange?.toFixed(2)}%`} />\n          <DataRow \n            label=\"稳定化\" \n            value={data.scragTest?.stabilizationAchieved ? '已达成' : '未达成'}\n            status={data.scragTest?.stabilizationAchieved ? 'good' : 'warning'}\n          />\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\n// Quality Tab Component\nfunction QualityTab({ data, isRunning }: { data: any; isRunning: boolean }) {\n  if (isRunning) {\n    return <LoadingCard title=\"质量标准检查\" />;\n  }\n\n  if (!data) {\n    return <EmptyCard title=\"质量标准检查\" message='点击\"开始分析\"运行标准符合性检查' />;\n  }\n\n  return (\n    <div className=\"grid gap-6 lg:grid-cols-2\">\n      {/* Manufacturability */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            可制造性评估\n            <Badge variant={data.manufacturability?.isManufacturable ? 'default' : 'destructive'}>\n              {data.manufacturability?.isManufacturable ? '可制造' : '不可制造'}\n            </Badge>\n          </CardTitle>\n          <CardDescription>{data.manufacturability?.summary}</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-sm text-muted-foreground\">难度评分</span>\n            <div className=\"flex items-center gap-2\">\n              <Progress value={100 - data.manufacturability?.difficultyScore} className=\"w-24 h-2\" />\n              <span className=\"text-sm font-medium\">{data.manufacturability?.difficultyScore}/100</span>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-3 gap-2 text-center\">\n            <div className=\"p-2 rounded bg-red-50 dark:bg-red-950\">\n              <p className=\"text-2xl font-bold text-red-600\">{data.manufacturability?.criticalCount || 0}</p>\n              <p className=\"text-xs text-muted-foreground\">严重</p>\n            </div>\n            <div className=\"p-2 rounded bg-yellow-50 dark:bg-yellow-950\">\n              <p className=\"text-2xl font-bold text-yellow-600\">{data.manufacturability?.majorCount || 0}</p>\n              <p className=\"text-xs text-muted-foreground\">主要</p>\n            </div>\n            <div className=\"p-2 rounded bg-blue-50 dark:bg-blue-950\">\n              <p className=\"text-2xl font-bold text-blue-600\">{data.manufacturability?.minorCount || 0}</p>\n              <p className=\"text-xs text-muted-foreground\">次要</p>\n            </div>\n          </div>\n\n          {data.manufacturability?.issues?.length > 0 && (\n            <div className=\"space-y-2\">\n              <p className=\"text-sm font-medium\">问题清单:</p>\n              {data.manufacturability.issues.slice(0, 3).map((issue: any, i: number) => (\n                <div key={i} className={`text-xs p-2 rounded ${\n                  issue.severity === 'critical' ? 'bg-red-50 text-red-700 dark:bg-red-950 dark:text-red-300' :\n                  issue.severity === 'major' ? 'bg-yellow-50 text-yellow-700 dark:bg-yellow-950 dark:text-yellow-300' :\n                  'bg-gray-50 text-gray-700 dark:bg-gray-900 dark:text-gray-300'\n                }`}>\n                  <span className=\"font-medium\">{issue.severity.toUpperCase()}:</span> {issue.description}\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Standards Compliance */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">标准符合性</CardTitle>\n          <CardDescription>ASME / SAE J157 / DIN 2089</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {['asme', 'sae', 'din'].map((std) => {\n            const check = data.standardsCheck?.[std];\n            if (!check) return null;\n            \n            return (\n              <div key={std} className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"font-medium\">{check.standard}</span>\n                  <Badge variant={\n                    check.overallStatus === 'pass' ? 'default' :\n                    check.overallStatus === 'warning' ? 'secondary' : 'destructive'\n                  }>\n                    {check.overallStatus === 'pass' ? '通过' :\n                     check.overallStatus === 'warning' ? '警告' : '失败'}\n                  </Badge>\n                </div>\n                <Progress value={check.compliancePercent} className=\"h-2\" />\n                <p className=\"text-xs text-muted-foreground\">\n                  {check.passCount}/{check.checks.length} 项通过\n                </p>\n              </div>\n            );\n          })}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\n// AI Tab Component\nfunction AITab({ data, isRunning }: { data: any; isRunning: boolean }) {\n  if (isRunning) {\n    return <LoadingCard title=\"AI智能分析\" />;\n  }\n\n  if (!data) {\n    return <EmptyCard title=\"AI智能分析\" message='点击\"开始分析\"运行AI材料推荐和疲劳预测' />;\n  }\n\n  return (\n    <div className=\"grid gap-6 lg:grid-cols-2\">\n      {/* Material Recommendation */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <Brain className=\"h-4 w-4\" />\n            AI材料推荐\n          </CardTitle>\n          <CardDescription>{data.materialRecommendation?.summary}</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {data.materialRecommendation?.recommendations?.slice(0, 5).map((rec: any, i: number) => (\n              <div key={i} className={`p-3 rounded-lg border ${i === 0 ? 'border-blue-500 bg-blue-50 dark:bg-blue-950' : ''}`}>\n                <div className=\"flex items-center justify-between mb-1\">\n                  <span className=\"font-medium\">\n                    #{rec.rank} {rec.material.nameZh}\n                  </span>\n                  <Badge variant={rec.performance.meetsRequirements ? 'default' : 'secondary'}>\n                    {rec.performance.overallScore.toFixed(0)}分\n                  </Badge>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">{rec.material.nameEn}</p>\n                <div className=\"mt-2 grid grid-cols-2 gap-2 text-xs\">\n                  <span>安全系数: {rec.performance.safetyFactor.toFixed(2)}</span>\n                  <span>疲劳寿命: {rec.performance.predictedFatigueLife.toExponential(1)}</span>\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* ML Fatigue Prediction */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <Brain className=\"h-4 w-4\" />\n            ML疲劳寿命预测\n          </CardTitle>\n          <CardDescription>基于机器学习的疲劳寿命预测</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"text-center p-4 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-950 dark:to-purple-950 rounded-lg\">\n            <p className=\"text-3xl font-bold text-blue-600\">\n              {data.mlFatiguePrediction?.predictedCycles?.toExponential(2)}\n            </p>\n            <p className=\"text-sm text-muted-foreground\">预测疲劳寿命 (cycles)</p>\n          </div>\n\n          <div className=\"space-y-2\">\n            <DataRow \n              label=\"95%置信区间\" \n              value={`${data.mlFatiguePrediction?.confidenceInterval?.lower?.toExponential(1)} - ${data.mlFatiguePrediction?.confidenceInterval?.upper?.toExponential(1)}`}\n            />\n            <DataRow \n              label=\"传统计算值\" \n              value={`${data.mlFatiguePrediction?.comparison?.calculatedLife?.toExponential(2)}`}\n            />\n            <DataRow \n              label=\"差异\" \n              value={`${data.mlFatiguePrediction?.comparison?.differencePercent > 0 ? '+' : ''}${data.mlFatiguePrediction?.comparison?.differencePercent?.toFixed(1)}%`}\n            />\n            <DataRow \n              label=\"预测可靠度\" \n              value={`${data.mlFatiguePrediction?.reliabilityScore}/100`}\n              status={data.mlFatiguePrediction?.reliabilityScore >= 70 ? 'good' : 'warning'}\n            />\n          </div>\n\n          <div>\n            <p className=\"text-sm font-medium mb-2\">特征重要性:</p>\n            <div className=\"space-y-1\">\n              {Object.entries(data.mlFatiguePrediction?.featureImportance || {})\n                .sort(([, a], [, b]) => (b as number) - (a as number))\n                .slice(0, 5)\n                .map(([feature, importance]) => (\n                  <div key={feature} className=\"flex items-center gap-2\">\n                    <span className=\"text-xs w-28 truncate\">{feature}</span>\n                    <Progress value={(importance as number) * 100} className=\"flex-1 h-2\" />\n                    <span className=\"text-xs w-10\">{((importance as number) * 100).toFixed(0)}%</span>\n                  </div>\n                ))}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\n// Summary Tab Component\nfunction SummaryTab({ manufacturing, quality, ai, analysisResult }: any) {\n  if (!manufacturing && !quality && !ai) {\n    return <EmptyCard title=\"综合报告\" message=\"完成分析后查看综合报告\" />;\n  }\n\n  const overallScore = useMemo(() => {\n    let score = 100;\n    \n    // Critical: Manufacturability - if not manufacturable, major penalty\n    if (quality?.manufacturability) {\n      if (!quality.manufacturability.isManufacturable) {\n        // Not manufacturable = automatic fail (max 40 points)\n        score = Math.min(score, 40);\n      }\n      // Additional deductions for issues\n      score -= quality.manufacturability.criticalCount * 25;\n      score -= quality.manufacturability.majorCount * 10;\n      score -= quality.manufacturability.minorCount * 2;\n    }\n    \n    // Critical: Safety factor - if below 1.0, design is unsafe\n    const safetyFactor = analysisResult?.safety?.staticSafetyFactor;\n    if (safetyFactor !== undefined) {\n      if (safetyFactor < 1.0) {\n        // Unsafe design = automatic fail (max 30 points)\n        score = Math.min(score, 30);\n        score -= Math.round((1.0 - safetyFactor) * 30);\n      } else if (safetyFactor < 1.2) {\n        score -= 20; // Marginal safety\n      } else if (safetyFactor < 1.5) {\n        score -= 10; // Below recommended\n      }\n    }\n    \n    // Deduct for standards failures\n    if (quality?.standardsCheck) {\n      ['asme', 'sae', 'din'].forEach(std => {\n        const check = quality.standardsCheck[std];\n        if (check?.overallStatus === 'fail') score -= 15;\n        else if (check?.overallStatus === 'warning') score -= 5;\n      });\n    }\n    \n    // Bonus for good fatigue life\n    if (ai?.mlFatiguePrediction?.predictedCycles > 1e7) score += 5;\n    \n    return Math.max(0, Math.min(100, score));\n  }, [quality, ai, analysisResult]);\n\n  const getGrade = (score: number) => {\n    if (score >= 90) return { grade: 'A', color: 'text-green-600', bg: 'bg-green-100' };\n    if (score >= 80) return { grade: 'B', color: 'text-blue-600', bg: 'bg-blue-100' };\n    if (score >= 70) return { grade: 'C', color: 'text-yellow-600', bg: 'bg-yellow-100' };\n    if (score >= 60) return { grade: 'D', color: 'text-orange-600', bg: 'bg-orange-100' };\n    return { grade: 'F', color: 'text-red-600', bg: 'bg-red-100' };\n  };\n\n  const gradeInfo = getGrade(overallScore);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Overall Score */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex items-center justify-center gap-8\">\n            <div className={`w-24 h-24 rounded-full ${gradeInfo.bg} flex items-center justify-center`}>\n              <span className={`text-4xl font-bold ${gradeInfo.color}`}>{gradeInfo.grade}</span>\n            </div>\n            <div>\n              <p className=\"text-4xl font-bold\">{overallScore}</p>\n              <p className=\"text-muted-foreground\">综合评分 / 100</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Quick Summary */}\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <SummaryCard \n          title=\"可制造性\"\n          value={quality?.manufacturability?.isManufacturable ? '通过' : '不通过'}\n          icon={quality?.manufacturability?.isManufacturable ? CheckCircle2 : XCircle}\n          status={quality?.manufacturability?.isManufacturable ? 'good' : 'bad'}\n        />\n        <SummaryCard \n          title=\"标准符合\"\n          value={`${quality?.standardsCheck?.asme?.passCount || 0}/${quality?.standardsCheck?.asme?.checks?.length || 0}`}\n          icon={FileCheck}\n          status={quality?.standardsCheck?.asme?.overallStatus === 'pass' ? 'good' : 'warning'}\n        />\n        <SummaryCard \n          title=\"疲劳寿命\"\n          value={ai?.mlFatiguePrediction?.predictedCycles?.toExponential(1) || '-'}\n          icon={Brain}\n          status={ai?.mlFatiguePrediction?.predictedCycles > 1e6 ? 'good' : 'warning'}\n        />\n        <SummaryCard \n          title=\"安全系数\"\n          value={analysisResult?.safety?.staticSafetyFactor?.toFixed(2) || '-'}\n          icon={Shield}\n          status={analysisResult?.safety?.staticSafetyFactor >= 1.5 ? 'good' : 'warning'}\n        />\n      </div>\n\n      {/* Export Button */}\n      <div className=\"flex justify-end\">\n        <Button variant=\"outline\" className=\"gap-2\">\n          <Download className=\"h-4 w-4\" />\n          导出完整报告\n        </Button>\n      </div>\n    </div>\n  );\n}\n\n// Helper Components\nfunction DataRow({ label, value, status }: { label: string; value: string; status?: 'good' | 'warning' | 'bad' }) {\n  return (\n    <div className=\"flex justify-between items-center\">\n      <span className=\"text-sm text-muted-foreground\">{label}</span>\n      <span className={`text-sm font-medium ${\n        status === 'good' ? 'text-green-600' :\n        status === 'warning' ? 'text-yellow-600' :\n        status === 'bad' ? 'text-red-600' : ''\n      }`}>{value}</span>\n    </div>\n  );\n}\n\nfunction LoadingCard({ title }: { title: string }) {\n  return (\n    <Card>\n      <CardContent className=\"flex flex-col items-center justify-center py-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground mb-4\" />\n        <p className=\"text-muted-foreground\">正在分析 {title}...</p>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction EmptyCard({ title, message }: { title: string; message: string }) {\n  return (\n    <Card>\n      <CardContent className=\"flex flex-col items-center justify-center py-12\">\n        <AlertTriangle className=\"h-8 w-8 text-muted-foreground mb-4\" />\n        <p className=\"font-medium\">{title}</p>\n        <p className=\"text-sm text-muted-foreground\">{message}</p>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction SummaryCard({ title, value, icon: Icon, status }: { \n  title: string; \n  value: string; \n  icon: any;\n  status: 'good' | 'warning' | 'bad';\n}) {\n  return (\n    <Card>\n      <CardContent className=\"pt-4\">\n        <div className=\"flex items-center gap-3\">\n          <div className={`p-2 rounded-lg ${\n            status === 'good' ? 'bg-green-100 text-green-600' :\n            status === 'warning' ? 'bg-yellow-100 text-yellow-600' :\n            'bg-red-100 text-red-600'\n          }`}>\n            <Icon className=\"h-5 w-5\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">{title}</p>\n            <p className=\"font-semibold\">{value}</p>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\n// ============================================================\n// Phase 7 Components\n// ============================================================\n\n// Digital Twin Tab Component\nfunction DigitalTwinTab({ geometry, analysisResult, material }: any) {\n  const [crackResult, setCrackResult] = useState<CrackInitiationResult | null>(null);\n  const [corrosionResult, setCorrosionResult] = useState<CorrosionAnalysisResult | null>(null);\n  const [costResult, setCostResult] = useState<CostYieldPredictionResult | null>(null);\n  const [harmonicResult, setHarmonicResult] = useState<HarmonicResponseResult | null>(null);\n  const [healthResult, setHealthResult] = useState<HealthDegradationResult | null>(null);\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n\n  const runDigitalTwinAnalysis = () => {\n    if (!geometry || !analysisResult || !material) return;\n    setIsAnalyzing(true);\n\n    try {\n      const meanDiameter = (geometry as any).meanDiameter || (geometry as any).largeOuterDiameter - geometry.wireDiameter;\n      const freeLength = (geometry as any).freeLength || 50;\n\n      // Crack initiation probability\n      const crack = calculateCrackInitiationProbability(\n        {\n          meanStress: analysisResult.fatigue?.tauMean || 300,\n          alternatingStress: analysisResult.fatigue?.tauAlt || 200,\n          maxStress: analysisResult.stress?.tauEffective || 500,\n          residualStress: -100,\n        },\n        { roughnessRa: 1.6, shotPeened: false },\n        { corrosive: false, corrosionSeverity: 0, temperature: 20, humidity: 50 },\n        'music_wire',\n        material.tensileStrength || 1600\n      );\n      setCrackResult(crack);\n\n      // Corrosion analysis\n      const corrosion = analyzeCorrosion(\n        { type: 'indoor_humid', humidity: 60, temperature: 25 },\n        geometry.materialId,\n        geometry.wireDiameter,\n        material.snCurve?.tau2 || 400,\n        analysisResult.stress?.tauEffective || 500,\n        10\n      );\n      setCorrosionResult(corrosion);\n\n      // Cost prediction\n      const cost = predictCostAndYield({\n        materialGrade: 'music_wire',\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter,\n        activeCoils: geometry.activeCoils,\n        freeLength,\n        toleranceClass: 'standard',\n        surfaceTreatment: 'none',\n        shotPeening: false,\n        stressRelief: true,\n        batchVolume: 1000,\n        endType: 'closed_ground',\n      });\n      setCostResult(cost);\n\n      // Harmonic response\n      const harmonic = analyzeHarmonicResponse(\n        {\n          wireDiameter: geometry.wireDiameter,\n          meanDiameter,\n          activeCoils: geometry.activeCoils,\n          freeLength,\n          springRate: analysisResult.springRate,\n          density: material.density || 7850,\n          shearModulus: material.shearModulus || 79300,\n          elasticModulus: material.elasticModulus || 207000,\n        },\n        { frequencyRange: { min: 1, max: 500 }, operatingRPM: 3000 }\n      );\n      setHarmonicResult(harmonic);\n\n      // Health degradation\n      const health = modelHealthDegradation(\n        geometry.wireDiameter,\n        freeLength,\n        analysisResult.springRate,\n        material.tensileStrength || 1600,\n        material.snCurve?.tau2 || 400,\n        {\n          corrosionRate: 0.02,\n          temperature: 25,\n          meanStress: analysisResult.fatigue?.tauMean || 300,\n          alternatingStress: analysisResult.fatigue?.tauAlt || 200,\n          frequency: 10,\n          cyclesPerYear: 1e6,\n          humidity: 50,\n        },\n        'music_wire',\n        20\n      );\n      setHealthResult(health);\n\n    } finally {\n      setIsAnalyzing(false);\n    }\n  };\n\n  if (!geometry || !analysisResult) {\n    return <EmptyCard title=\"数字孪生分析\" message=\"需要弹簧数据\" />;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h3 className=\"text-lg font-semibold\">Phase 7: 数字孪生分析</h3>\n        <Button onClick={runDigitalTwinAnalysis} disabled={isAnalyzing} className=\"gap-2\">\n          {isAnalyzing ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <Cpu className=\"h-4 w-4\" />}\n          {crackResult ? '重新分析' : '运行分析'}\n        </Button>\n      </div>\n\n      {!crackResult && !isAnalyzing && (\n        <EmptyCard title=\"数字孪生\" message='点击\"运行分析\"开始数字孪生仿真' />\n      )}\n\n      {isAnalyzing && <LoadingCard title=\"数字孪生分析\" />}\n\n      {crackResult && (\n        <div className=\"grid gap-6 md:grid-cols-2\">\n          {/* Crack Initiation */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Activity className=\"h-4 w-4\" />\n                裂纹萌生概率\n              </CardTitle>\n              <CardDescription>Weibull分布疲劳分析</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <DataRow label=\"B10寿命\" value={`${crackResult.B10Life.toExponential(1)} cycles`} />\n              <DataRow label=\"B50寿命\" value={`${crackResult.B50Life.toExponential(1)} cycles`} />\n              <DataRow label=\"特征寿命\" value={`${crackResult.characteristicLife.toExponential(1)} cycles`} />\n              <DataRow \n                label=\"风险等级\" \n                value={crackResult.riskLevel.toUpperCase()}\n                status={crackResult.riskLevel === 'low' ? 'good' : crackResult.riskLevel === 'medium' ? 'warning' : 'bad'}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Corrosion */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base\">腐蚀分析</CardTitle>\n              <CardDescription>环境腐蚀影响评估</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <DataRow label=\"腐蚀速率\" value={`${corrosionResult?.effectiveCorrosionRate.toFixed(4)} mm/年`} />\n              <DataRow label=\"腐蚀疲劳因子\" value={`${corrosionResult?.corrosionFatigueFactor.toFixed(2)}`} />\n              <DataRow label=\"临界时间\" value={`${corrosionResult?.timeToCritical.toFixed(1)} 年`} />\n              <DataRow \n                label=\"点蚀风险\" \n                value={corrosionResult?.pittingRisk || '-'}\n                status={corrosionResult?.pittingRisk === 'low' ? 'good' : 'warning'}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Cost Prediction */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <DollarSign className=\"h-4 w-4\" />\n                成本与良率预测\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <DataRow label=\"单件成本\" value={`$${costResult?.costBreakdown.totalCostPerPiece.toFixed(3)}`} />\n              <DataRow label=\"预期良率\" value={`${costResult?.yieldPrediction.expectedYield.toFixed(1)}%`} status=\"good\" />\n              <DataRow label=\"Cpk\" value={`${costResult?.yieldPrediction.cpk.toFixed(2)}`} />\n              <DataRow \n                label=\"风险等级\" \n                value={costResult?.riskFactors.riskLevel || '-'}\n                status={costResult?.riskFactors.riskLevel === 'low' ? 'good' : 'warning'}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Harmonic Response */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Waves className=\"h-4 w-4\" />\n                共振分析\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <DataRow label=\"检测模态数\" value={`${harmonicResult?.detectedModes.length || 0}`} />\n              <DataRow \n                label=\"基频\" \n                value={`${harmonicResult?.detectedModes[0]?.frequency.toFixed(0) || '-'} Hz`} \n              />\n              <DataRow label=\"共振风险数\" value={`${harmonicResult?.resonanceRisks.length || 0}`} />\n              <DataRow \n                label=\"总体风险\" \n                value={harmonicResult?.overallRisk || '-'}\n                status={harmonicResult?.overallRisk === 'low' ? 'good' : 'warning'}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Health Degradation */}\n          <Card className=\"md:col-span-2\">\n            <CardHeader>\n              <CardTitle className=\"text-base\">结构健康退化预测</CardTitle>\n              <CardDescription>服役寿命预测</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                <div className=\"text-center p-3 bg-blue-50 dark:bg-blue-950 rounded-lg\">\n                  <p className=\"text-2xl font-bold text-blue-600\">{healthResult?.endOfLife.predictedEOL.toFixed(1)}</p>\n                  <p className=\"text-xs text-muted-foreground\">预测寿命 (年)</p>\n                </div>\n                <div className=\"text-center p-3 bg-green-50 dark:bg-green-950 rounded-lg\">\n                  <p className=\"text-2xl font-bold text-green-600\">{healthResult?.endOfLife.recommendedReplacement.toFixed(1)}</p>\n                  <p className=\"text-xs text-muted-foreground\">建议更换 (年)</p>\n                </div>\n                <div className=\"text-center p-3 bg-yellow-50 dark:bg-yellow-950 rounded-lg\">\n                  <p className=\"text-2xl font-bold text-yellow-600\">{healthResult?.endOfLife.limitingFactor}</p>\n                  <p className=\"text-xs text-muted-foreground\">限制因素</p>\n                </div>\n                <div className=\"text-center p-3 bg-purple-50 dark:bg-purple-950 rounded-lg\">\n                  <p className=\"text-2xl font-bold text-purple-600\">{(healthResult?.endOfLife.confidence || 0) * 100}%</p>\n                  <p className=\"text-xs text-muted-foreground\">置信度</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n}\n\n// FEA Tab Component\nfunction FEATab({ geometry, analysisResult, material }: any) {\n  const [feaScripts, setFeaScripts] = useState<FEAScriptResult | null>(null);\n  const [hotspotResult, setHotspotResult] = useState<HotspotTrackingResult | null>(null);\n\n  const generateScripts = () => {\n    if (!geometry || !analysisResult || !material) return;\n\n    const meanDiameter = (geometry as any).meanDiameter || (geometry as any).largeOuterDiameter - geometry.wireDiameter;\n    const freeLength = (geometry as any).freeLength || 50;\n\n    const scripts = generateFEAScripts({\n      geometry,\n      loadCases: [\n        { name: 'Preload', type: 'axial', axialDisplacement: freeLength * 0.1 },\n        { name: 'Working', type: 'axial', axialDisplacement: freeLength * 0.2 },\n        { name: 'Max_Load', type: 'axial', axialDisplacement: freeLength * 0.3 },\n      ],\n      meshSettings: {\n        globalSize: geometry.wireDiameter / 4,\n        refinementFactor: 3,\n        elementType: 'quadratic',\n        circumferentialDivisions: 16,\n      },\n      materialModel: 'elastoplastic',\n      outputRequests: {\n        stress: true,\n        displacement: true,\n        strain: true,\n        fatigueLife: true,\n        safetyFactor: true,\n        contourImages: true,\n      },\n    });\n    setFeaScripts(scripts);\n\n    // Hotspot analysis\n    const hotspots = analyzeFractureHotspots(\n      {\n        type: geometry.type,\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter,\n        activeCoils: geometry.activeCoils,\n        freeLength,\n        endType: 'closed_ground',\n      },\n      {\n        maxShearStress: analysisResult.stress?.tauEffective || 500,\n        meanShearStress: analysisResult.fatigue?.tauMean || 300,\n        alternatingShearStress: analysisResult.fatigue?.tauAlt || 200,\n      },\n      material.tensileStrength || 1600\n    );\n    setHotspotResult(hotspots);\n  };\n\n  if (!geometry || !analysisResult) {\n    return <EmptyCard title=\"FEA仿真\" message=\"需要弹簧数据\" />;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h3 className=\"text-lg font-semibold\">FEA 自动求解器</h3>\n        <Button onClick={generateScripts} className=\"gap-2\">\n          <Target className=\"h-4 w-4\" />\n          生成FEA脚本\n        </Button>\n      </div>\n\n      {!feaScripts && (\n        <EmptyCard title=\"FEA脚本生成\" message='点击\"生成FEA脚本\"创建Abaqus/ANSYS求解器脚本' />\n      )}\n\n      {feaScripts && (\n        <div className=\"grid gap-6 md:grid-cols-2\">\n          {/* Abaqus Script */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base\">Abaqus CAE 脚本</CardTitle>\n              <CardDescription>Python脚本用于Abaqus求解器</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"bg-slate-100 dark:bg-slate-800 p-3 rounded text-xs font-mono max-h-40 overflow-auto\">\n                {feaScripts.abaqusScript.slice(0, 500)}...\n              </div>\n              <Button \n                variant=\"outline\" \n                className=\"w-full gap-2\"\n                onClick={() => downloadFEAScript(feaScripts.abaqusScript, feaScripts.filename.abaqus, 'abaqus')}\n              >\n                <Download className=\"h-4 w-4\" />\n                下载 Abaqus 脚本 (.py)\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* ANSYS Script */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base\">ANSYS APDL 脚本</CardTitle>\n              <CardDescription>APDL命令文件用于ANSYS求解器</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"bg-slate-100 dark:bg-slate-800 p-3 rounded text-xs font-mono max-h-40 overflow-auto\">\n                {feaScripts.ansysScript.slice(0, 500)}...\n              </div>\n              <Button \n                variant=\"outline\" \n                className=\"w-full gap-2\"\n                onClick={() => downloadFEAScript(feaScripts.ansysScript, feaScripts.filename.ansys, 'ansys')}\n              >\n                <Download className=\"h-4 w-4\" />\n                下载 ANSYS 脚本 (.inp)\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* Hotspot Analysis */}\n          {hotspotResult && (\n            <Card className=\"md:col-span-2\">\n              <CardHeader>\n                <CardTitle className=\"text-base\">应力热点分析</CardTitle>\n                <CardDescription>断裂风险区域识别</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n                  <div className=\"text-center p-3 bg-slate-100 dark:bg-slate-800 rounded-lg\">\n                    <p className=\"text-2xl font-bold\">{hotspotResult.hotspots.length}</p>\n                    <p className=\"text-xs text-muted-foreground\">总热点数</p>\n                  </div>\n                  <div className=\"text-center p-3 bg-red-50 dark:bg-red-950 rounded-lg\">\n                    <p className=\"text-2xl font-bold text-red-600\">{hotspotResult.criticalHotspots.length}</p>\n                    <p className=\"text-xs text-muted-foreground\">高风险热点</p>\n                  </div>\n                  <div className=\"text-center p-3 bg-orange-50 dark:bg-orange-950 rounded-lg\">\n                    <p className=\"text-2xl font-bold text-orange-600\">{hotspotResult.nucleationSites.length}</p>\n                    <p className=\"text-xs text-muted-foreground\">裂纹萌生点</p>\n                  </div>\n                  <div className={`text-center p-3 rounded-lg ${\n                    hotspotResult.overallRisk === 'low' ? 'bg-green-50 dark:bg-green-950' :\n                    hotspotResult.overallRisk === 'medium' ? 'bg-yellow-50 dark:bg-yellow-950' :\n                    'bg-red-50 dark:bg-red-950'\n                  }`}>\n                    <p className={`text-2xl font-bold ${\n                      hotspotResult.overallRisk === 'low' ? 'text-green-600' :\n                      hotspotResult.overallRisk === 'medium' ? 'text-yellow-600' :\n                      'text-red-600'\n                    }`}>{hotspotResult.overallRisk.toUpperCase()}</p>\n                    <p className=\"text-xs text-muted-foreground\">总体风险</p>\n                  </div>\n                </div>\n\n                {hotspotResult.recommendations.length > 0 && (\n                  <div className=\"mt-4 p-3 bg-blue-50 dark:bg-blue-950 rounded-lg\">\n                    <p className=\"text-sm font-medium mb-2\">建议:</p>\n                    <ul className=\"text-xs space-y-1\">\n                      {hotspotResult.recommendations.map((rec, i) => (\n                        <li key={i}>• {rec}</li>\n                      ))}\n                    </ul>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// Torsion Spring Analysis Tab Component\nfunction TorsionAnalysisTab({ data, isRunning }: { data: TorsionAdvancedAnalysisResult | null; isRunning: boolean }) {\n  if (isRunning) {\n    return <LoadingCard title=\"扭簧高级分析\" />;\n  }\n\n  if (!data) {\n    return <EmptyCard title=\"扭簧高级分析\" message='点击\"开始分析\"运行扭簧高级分析' />;\n  }\n\n  const { mass, frequency, stressDistribution, dynamic, fatigue } = data;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Overall Status */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            高级工程分析\n            <Badge variant={data.overallStatus === 'PASS' ? 'default' : data.overallStatus === 'CAUTION' ? 'secondary' : 'destructive'}>\n              {data.overallStatus}\n            </Badge>\n          </CardTitle>\n          <CardDescription>动力学·温度·蠕变·环境判定</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n            <div className=\"text-center p-3 bg-slate-100 dark:bg-slate-800 rounded-lg\">\n              <p className=\"text-2xl font-bold\">{mass.totalMass.toFixed(2)} g</p>\n              <p className=\"text-xs text-muted-foreground\">弹簧质量</p>\n            </div>\n            <div className=\"text-center p-3 bg-slate-100 dark:bg-slate-800 rounded-lg\">\n              <p className=\"text-2xl font-bold\">{frequency.naturalFrequency.toFixed(1)} Hz</p>\n              <p className=\"text-xs text-muted-foreground\">固有频率 fn</p>\n            </div>\n            <div className=\"text-center p-3 bg-slate-100 dark:bg-slate-800 rounded-lg\">\n              <p className=\"text-2xl font-bold\">{frequency.shockWaveVelocity.toFixed(0)} m/s</p>\n              <p className=\"text-xs text-muted-foreground\">冲击波速度</p>\n            </div>\n            <div className={`text-center p-3 rounded-lg ${\n              dynamic.riskLevel === 'LOW RISK' ? 'bg-green-50 dark:bg-green-950' :\n              dynamic.riskLevel === 'MEDIUM RISK' ? 'bg-yellow-50 dark:bg-yellow-950' :\n              'bg-red-50 dark:bg-red-950'\n            }`}>\n              <p className={`text-lg font-bold ${\n                dynamic.riskLevel === 'LOW RISK' ? 'text-green-600' :\n                dynamic.riskLevel === 'MEDIUM RISK' ? 'text-yellow-600' :\n                'text-red-600'\n              }`}>{dynamic.riskLevel}</p>\n              <p className=\"text-xs text-muted-foreground\">智能诊断</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n        {/* Stress Distribution */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">应力分布分析</CardTitle>\n            <CardDescription>弯曲应力分布与热点识别</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <DataRow label=\"最大应力\" value={`${stressDistribution.maxStress.toFixed(0)} MPa`} />\n            <DataRow label=\"平均应力\" value={`${stressDistribution.avgStress.toFixed(0)} MPa`} />\n            <DataRow label=\"应力修正系数 Ki\" value={stressDistribution.stressCorrectionFactor.toFixed(3)} />\n            <DataRow \n              label=\"临界区域\" \n              value={`${stressDistribution.criticalRegions}`}\n              status={stressDistribution.criticalRegions === 0 ? 'good' : 'warning'}\n            />\n            <DataRow \n              label=\"热点数\" \n              value={`${stressDistribution.hotspotCount}`}\n              status={stressDistribution.hotspotCount === 0 ? 'good' : 'warning'}\n            />\n          </CardContent>\n        </Card>\n\n        {/* Fatigue Analysis */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">疲劳与安全</CardTitle>\n            <CardDescription>疲劳寿命与安全系数</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <DataRow \n              label=\"估计寿命\" \n              value={fatigue.estimatedLife >= 1e9 ? '∞ (无限)' : `${fatigue.estimatedLife.toExponential(2)} 次`}\n              status={fatigue.estimatedLife >= 1e6 ? 'good' : 'warning'}\n            />\n            <DataRow \n              label=\"安全系数\" \n              value={fatigue.safetyFactor.toFixed(2)}\n              status={fatigue.safetyFactor >= 1.5 ? 'good' : fatigue.safetyFactor >= 1.0 ? 'warning' : 'bad'}\n            />\n            <DataRow label=\"安全率\" value={`${fatigue.safetyFactorPercent.toFixed(0)}%`} />\n            <DataRow label=\"平均应力\" value={`${fatigue.meanStress.toFixed(1)} MPa`} />\n            <DataRow label=\"交变应力\" value={`${fatigue.alternatingStress.toFixed(1)} MPa`} />\n          </CardContent>\n        </Card>\n\n        {/* Mass & Geometry */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">质量与几何</CardTitle>\n            <CardDescription>弹簧质量分布</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <DataRow label=\"总质量\" value={`${mass.totalMass.toFixed(2)} g`} />\n            <DataRow label=\"线圈质量\" value={`${mass.bodyMass.toFixed(2)} g`} />\n            <DataRow label=\"腿1质量\" value={`${mass.leg1Mass.toFixed(2)} g`} />\n            <DataRow label=\"腿2质量\" value={`${mass.leg2Mass.toFixed(2)} g`} />\n            <DataRow label=\"总线长\" value={`${mass.totalWireLength.toFixed(1)} mm`} />\n          </CardContent>\n        </Card>\n\n        {/* Dynamic Analysis */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">动力学分析</CardTitle>\n            <CardDescription>频率与惯性</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <DataRow label=\"固有频率\" value={`${frequency.naturalFrequency.toFixed(1)} Hz`} />\n            <DataRow label=\"角频率\" value={`${frequency.angularFrequency.toFixed(1)} rad/s`} />\n            <DataRow label=\"转动惯量\" value={`${frequency.momentOfInertia.toFixed(4)} kg·mm²`} />\n            <DataRow label=\"扭转刚度\" value={`${frequency.torsionalStiffness.toFixed(2)} N·mm/rad`} />\n          </CardContent>\n        </Card>\n\n        {/* Environmental */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">环境影响</CardTitle>\n            <CardDescription>温度与蠕变</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <DataRow label=\"温度影响\" value={`${dynamic.temperatureEffect.toFixed(2)}%`} />\n            <DataRow label=\"蠕变系数\" value={dynamic.creepFactor.toFixed(4)} />\n            <DataRow \n              label=\"环境评级\" \n              value={dynamic.environmentalRating}\n              status={dynamic.environmentalRating === 'PASS' ? 'good' : dynamic.environmentalRating === 'CAUTION' ? 'warning' : 'bad'}\n            />\n          </CardContent>\n        </Card>\n\n        {/* Stress Hotspots Table */}\n        <Card className=\"md:col-span-2 lg:col-span-1\">\n          <CardHeader>\n            <CardTitle className=\"text-base\">应力热点</CardTitle>\n            <CardDescription>高应力区域位置</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-xs space-y-1 max-h-40 overflow-auto\">\n              <div className=\"grid grid-cols-3 font-medium border-b pb-1\">\n                <span>位置</span>\n                <span>圈数</span>\n                <span>应力</span>\n              </div>\n              {stressDistribution.points\n                .filter(p => p.isHotspot)\n                .slice(0, 5)\n                .map((point, i) => (\n                  <div key={i} className=\"grid grid-cols-3 py-1\">\n                    <span>θ = {point.theta.toFixed(0)}°</span>\n                    <span>{point.coilNumber.toFixed(1)}</span>\n                    <span className=\"text-red-600\">{point.bendingStress.toFixed(0)} MPa</span>\n                  </div>\n                ))}\n              {stressDistribution.hotspotCount === 0 && (\n                <p className=\"text-green-600 py-2\">无高应力热点 ✓</p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/analysis/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringMaterialId' is defined but never used.","line":14,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":51},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'EngineSpringGeometry' is defined but never used.","line":15,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":53},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringType' is defined but never used.","line":31,"column":62,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":72},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'freeLength'. Either include it or remove the dependency array.","line":395,"column":6,"nodeType":"ArrayExpression","endLine":420,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [activeCoils, analysisResult, bodyLength, conicalFreeLength, elasticModulus, hookType, initializeCompression, initializeConical, initializeExtension, initializeTorsion, initialTension, largeOD, legLength1, legLength2, maxDeflection, meanDiameter, outerDiameter, shearModulus, smallOD, springType, torsionBodyLength, torsionFreeAngle, torsionWindingDirection, wireDiameter, freeLength]","fix":{"range":[13750,14223],"text":"[activeCoils, analysisResult, bodyLength, conicalFreeLength, elasticModulus, hookType, initializeCompression, initializeConical, initializeExtension, initializeTorsion, initialTension, largeOD, legLength1, legLength2, maxDeflection, meanDiameter, outerDiameter, shearModulus, smallOD, springType, torsionBodyLength, torsionFreeAngle, torsionWindingDirection, wireDiameter, freeLength]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useMemo, useEffect, Suspense } from \"react\";\nimport dynamic from \"next/dynamic\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useLanguage } from \"@/components/language-context\";\nimport { UnifiedForceTester } from \"@/components/force-tester\";\nimport { AdvancedAnalysisPanel } from \"@/components/analysis/AdvancedAnalysisPanel\";\nimport { SmartAnalysisPanel } from \"@/components/analysis/SmartAnalysisPanel\";\nimport { AdvancedSimulationPanel } from \"@/components/analysis/AdvancedSimulationPanel\";\nimport { SpringTypeSpecificPanel } from \"@/components/analysis/SpringTypeSpecificPanel\";\nimport { FeaPanel } from \"@/components/analysis/FeaPanel\";\nimport { getMaterialOptions, type SpringMaterialId } from \"@/lib/materials/springMaterials\";\nimport type { SpringGeometry as EngineSpringGeometry, WorkingConditions } from \"@/lib/engine/types\";\nimport {\n  createReportData,\n  printReport,\n  downloadReportHTML,\n} from \"@/lib/reports/SpringReportGenerator\";\nimport { SpringAnalysisEngine } from \"@/lib/engine/SpringAnalysisEngine\";\nimport { useSpringSimulationStore } from \"@/lib/stores/springSimulationStore\";\nimport { useSpringAnalysisStore } from \"@/lib/stores/springAnalysisStore\";\nimport {\n  useSpringDesignStore,\n  type SpringGeometry as StoreSpringGeometry,\n  type MaterialInfo,\n  type AnalysisResult,\n} from \"@/lib/stores/springDesignStore\";\nimport { convertStoreGeometryToEngine } from \"@/lib/engine/geometryAdapters\";\nimport { EXTENSION_HOOK_LABELS, type ExtensionHookType, type SpringType } from \"@/lib/springTypes\";\nimport Link from \"next/link\";\nimport { Brain } from \"lucide-react\";\nimport { SpiralTorsionAnalysisPanel } from \"@/components/analysis/SpiralTorsionAnalysisPanel\";\nimport { SuspensionAnalysisPanel } from \"@/components/analysis/SuspensionAnalysisPanel\";\nimport { isSpiralTorsionDesign, isSuspensionDesign } from \"@/lib/stores/springDesignStore\";\n\n// Dynamic imports for 3D visualizers\nconst CompressionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/CompressionSpringVisualizer\").then(mod => mod.CompressionSpringVisualizer),\n  { ssr: false, loading: () => <div className=\"h-full w-full flex items-center justify-center bg-slate-900 text-slate-400 text-sm\">Loading 3D...</div> }\n);\n\nconst ConicalSpringVisualizer = dynamic(\n  () => import(\"@/components/three/ConicalSpringVisualizer\").then(mod => mod.ConicalSpringVisualizer),\n  { ssr: false, loading: () => <div className=\"h-full w-full flex items-center justify-center bg-slate-900 text-slate-400 text-sm\">Loading 3D...</div> }\n);\n\nconst ExtensionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/ExtensionSpringVisualizer\").then(mod => mod.ExtensionSpringVisualizer),\n  { ssr: false, loading: () => <div className=\"h-full w-full flex items-center justify-center bg-slate-900 text-slate-400 text-sm\">Loading 3D...</div> }\n);\n\nconst TorsionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/TorsionSpringVisualizer\").then(mod => mod.TorsionSpringVisualizer),\n  { ssr: false, loading: () => <div className=\"h-full w-full flex items-center justify-center bg-slate-900 text-slate-400 text-sm\">Loading 3D...</div> }\n);\n\nexport default function SpringAnalysisPage() {\n  return (\n    <Suspense fallback={<div className=\"p-8 text-center text-muted-foreground\">Loading...</div>}>\n      <AnalysisContent />\n    </Suspense>\n  );\n}\n\nfunction AnalysisContent() {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n  const materialOptions = getMaterialOptions();\n  const designGeometry = useSpringDesignStore(state => state.geometry);\n  const designMaterial = useSpringDesignStore(state => state.material);\n  const designAnalysis = useSpringDesignStore(state => state.analysisResult);\n\n  if (!designGeometry || !designMaterial || !designAnalysis) {\n    return (\n      <main className=\"container mx-auto py-8 px-4\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-2xl font-bold mb-2\">\n            {isZh ? \"弹簧工程分析\" : \"Spring Engineering Analysis\"}\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {isZh\n              ? \"请先在计算器中完成设计并保存到全局 store，再返回此处进行工程分析。\"\n              : \"Please finish your design in the Calculator (which saves into the global store) before running engineering analysis here.\"}\n          </p>\n        </div>\n\n        <Card className=\"max-w-xl\">\n          <CardHeader>\n            <CardTitle>{isZh ? \"未检测到设计数据\" : \"No Design Detected\"}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n            <p>\n              {isZh\n                ? \"当前没有有效的弹簧设计记录。请先在“弹簧计算器”输入参数并点击计算，系统会把结果保存到全局 store。\"\n                : \"No valid spring design is stored. Open the Calculator, enter your parameters and calculate—the system will save everything into the global store.\"}\n            </p>\n            <Button asChild variant=\"default\">\n              <a href=\"/tools/calculator\">{isZh ? \"前往弹簧计算器\" : \"Go to Calculator\"}</a>\n            </Button>\n          </CardContent>\n        </Card>\n      </main>\n    );\n  }\n\n  // ⚠️ 螺旋扭转弹簧使用独立的分析面板，不与 wire spring 混用\n  // 这是显式分支，不是 type guard 兼容\n  if (isSpiralTorsionDesign(designGeometry)) {\n    return (\n      <SpiralTorsionAnalysisPanel\n        isZh={isZh}\n        geometry={designGeometry}\n        material={designMaterial}\n        analysisResult={designAnalysis}\n      />\n    );\n  }\n\n  // Suspension Spring uses dedicated analysis panel\n  if (isSuspensionDesign(designGeometry)) {\n    return (\n      <SuspensionAnalysisPanel\n        isZh={isZh}\n        geometry={designGeometry}\n        material={designMaterial}\n        analysisResult={designAnalysis}\n      />\n    );\n  }\n\n  // Wire spring (compression/extension/torsion/conical) uses original analysis panel\n  return (\n    <AnalysisReady\n      isZh={isZh}\n      materialOptions={materialOptions}\n      designGeometry={designGeometry}\n      designMaterial={designMaterial}\n      designAnalysis={designAnalysis}\n    />\n  );\n}\n\ninterface AnalysisReadyProps {\n  isZh: boolean;\n  materialOptions: ReturnType<typeof getMaterialOptions>;\n  designGeometry: StoreSpringGeometry;\n  designMaterial: MaterialInfo;\n  designAnalysis: AnalysisResult;\n}\n\nfunction AnalysisReady({\n  isZh,\n  materialOptions,\n  designGeometry,\n  designMaterial,\n  designAnalysis,\n}: AnalysisReadyProps) {\n  // ⚠️ 注意：spiralTorsion 已在上层被拦截，此函数只处理 wire spring\n  // 不要在这里添加 spiralTorsion 的兼容代码\n  if (designGeometry.type === \"spiralTorsion\") {\n    throw new Error(\"spiralTorsion should be handled by SpiralTorsionAnalysisPanel\");\n  }\n  \n  const springType = designGeometry.type;\n  const materialId = designMaterial.id;\n  \n  // Wire spring 专用字段 - 不包含 spiralTorsion\n  const wireDiameter = designGeometry.wireDiameter;\n  const activeCoils = designGeometry.activeCoils;\n  const shearModulus = designGeometry.shearModulus ?? designMaterial.shearModulus;\n  const elasticModulus = designMaterial.elasticModulus ?? shearModulus * 2.5;\n\n  let meanDiameter: number | undefined;\n  let freeLength: number | undefined;\n  let bodyLength: number | undefined;\n  let initialTension: number | undefined;\n  let hookType: ExtensionHookType | undefined;\n  let outerDiameter: number | undefined;\n  let largeOD: number | undefined;\n  let smallOD: number | undefined;\n  let conicalFreeLength: number | undefined;\n  let torsionBodyLength: number | undefined;\n  let legLength1: number | undefined;\n  let legLength2: number | undefined;\n\n  switch (designGeometry.type) {\n    case \"compression\":\n      meanDiameter = designGeometry.meanDiameter;\n      freeLength = designGeometry.freeLength;\n      break;\n    case \"extension\":\n      meanDiameter =\n        designGeometry.meanDiameter ??\n        (designGeometry.outerDiameter - designGeometry.wireDiameter);\n      outerDiameter = designGeometry.outerDiameter;\n      bodyLength = designGeometry.bodyLength;\n      initialTension = designGeometry.initialTension ?? designAnalysis.initialTension ?? 0;\n      hookType = designGeometry.hookType ?? \"machine\";\n      break;\n    case \"torsion\":\n      meanDiameter = designGeometry.meanDiameter;\n      torsionBodyLength =\n        designGeometry.bodyLength ?? designGeometry.activeCoils * designGeometry.wireDiameter;\n      bodyLength = torsionBodyLength;\n      legLength1 = designGeometry.legLength1;\n      legLength2 = designGeometry.legLength2;\n      break;\n    case \"conical\":\n      largeOD = designGeometry.largeOuterDiameter;\n      smallOD = designGeometry.smallOuterDiameter;\n      conicalFreeLength = designGeometry.freeLength;\n      freeLength = conicalFreeLength;\n      break;\n    // ⚠️ spiralTorsion 已在上层被拦截，不会到达这里\n    // 不要添加 spiralTorsion case\n  }\n\n  const minDeflection = 0;\n  const maxDeflection = designAnalysis.maxDeflection ?? designAnalysis.workingDeflection ?? 0;\n  const torsionFreeAngle =\n    springType === \"torsion\"\n      ? designGeometry.freeAngle ?? designGeometry.workingAngle ?? 0\n      : 0;\n  const torsionWindingDirection =\n    springType === \"torsion\" ? designGeometry.windingDirection ?? \"right\" : \"right\";\n\n  const workingConditions: WorkingConditions = useMemo(\n    () => ({\n      minDeflection,\n      maxDeflection,\n    }),\n    [minDeflection, maxDeflection]\n  );\n\n  const engineGeometry = useMemo(\n    () => convertStoreGeometryToEngine(designGeometry, materialId),\n    [designGeometry, materialId]\n  );\n\n  const analysisResult = useMemo(() => {\n    try {\n      return SpringAnalysisEngine.analyze(engineGeometry, workingConditions);\n    } catch {\n      return null;\n    }\n  }, [engineGeometry, workingConditions]);\n\n  const { initializeCompression, initializeConical, initializeExtension, initializeTorsion } =\n    useSpringSimulationStore();\n\n  const {\n    setGeometry: setAnalysisGeometry,\n    setWorkingConditions,\n    setMaterialId: setGlobalMaterialId,\n    setAnalysisResult,\n  } = useSpringAnalysisStore();\n\n  useEffect(() => {\n    if (!analysisResult) return;\n    setAnalysisGeometry(engineGeometry);\n    setWorkingConditions(workingConditions);\n    setGlobalMaterialId(materialId);\n    setAnalysisResult(analysisResult);\n  }, [\n    analysisResult,\n    engineGeometry,\n    materialId,\n    setAnalysisGeometry,\n    setWorkingConditions,\n    setGlobalMaterialId,\n    setAnalysisResult,\n    workingConditions,\n  ]);\n\n  useEffect(() => {\n    if (!analysisResult) return;\n\n    if (springType === \"compression\" && meanDiameter && freeLength !== undefined) {\n      const springRate =\n        (shearModulus * Math.pow(wireDiameter, 4)) /\n        (8 * Math.pow(meanDiameter, 3) * activeCoils);\n      const curve = analysisResult.forceCurve.map(p => ({\n        deflection: p.deflection,\n        load: p.force,\n      }));\n      initializeCompression(\n        curve,\n        {\n          type: \"compression\",\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          freeLength,\n          shearModulus,\n          springRate,\n        },\n        maxDeflection\n      );\n    } else if (\n      springType === \"extension\" &&\n      meanDiameter &&\n      outerDiameter &&\n      bodyLength !== undefined\n    ) {\n      const springRate =\n        (shearModulus * Math.pow(wireDiameter, 4)) /\n        (8 * Math.pow(meanDiameter, 3) * activeCoils);\n      const curve = analysisResult.forceCurve.map(p => ({\n        deflection: p.deflection,\n        load: p.force,\n      }));\n      const effectiveHookType: ExtensionHookType = hookType ?? \"machine\";\n      initializeExtension(\n        curve,\n        {\n          type: \"extension\",\n          wireDiameter,\n          outerDiameter,\n          activeCoils,\n          bodyLength,\n          freeLengthInsideHooks: bodyLength,\n          initialTension: initialTension ?? 0,\n          shearModulus,\n          springRate,\n          hookType: effectiveHookType,\n        },\n        maxDeflection\n      );\n    } else if (\n      springType === \"conical\" &&\n      largeOD !== undefined &&\n      smallOD !== undefined &&\n      conicalFreeLength !== undefined\n    ) {\n      const curve = analysisResult.forceCurve.map(p => ({\n        x: p.deflection,\n        deflection: p.deflection,\n        load: p.force,\n        k: p.stiffness ?? 10,\n        activeCoils: p.activeCoils ?? activeCoils,\n        collapsedCoils: p.collapsedCoils ?? 0,\n        stiffness: p.stiffness ?? 10,\n      }));\n      initializeConical(\n        curve,\n        {\n          type: \"conical\",\n          wireDiameter,\n          largeOuterDiameter: largeOD,\n          smallOuterDiameter: smallOD,\n          activeCoils,\n          freeLength: conicalFreeLength,\n          solidHeight: (activeCoils + 2) * wireDiameter,\n          totalDeflectionCapacity: conicalFreeLength - (activeCoils + 2) * wireDiameter,\n        },\n        maxDeflection\n      );\n    } else if (\n      springType === \"torsion\" &&\n      meanDiameter &&\n      torsionBodyLength !== undefined &&\n      legLength1 !== undefined &&\n      legLength2 !== undefined\n    ) {\n      const springRate =\n        ((elasticModulus * Math.pow(wireDiameter, 4)) /\n          (64 * meanDiameter * activeCoils)) *\n        (Math.PI / 180);\n      const curve = analysisResult.forceCurve.map(p => ({\n        deflection: p.deflection,\n        load: p.force,\n      }));\n      const pitch = torsionBodyLength / activeCoils;\n      initializeTorsion(\n        curve,\n        {\n          type: \"torsion\",\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          bodyLength: torsionBodyLength,\n          pitch: pitch > wireDiameter ? pitch : wireDiameter,\n          legLength1,\n          legLength2,\n          freeAngle: torsionFreeAngle,\n          shearModulus,\n          springRate,\n          windingDirection: torsionWindingDirection,\n        },\n        maxDeflection\n      );\n    }\n  }, [\n    activeCoils,\n    analysisResult,\n    bodyLength,\n    conicalFreeLength,\n    elasticModulus,\n    hookType,\n    initializeCompression,\n    initializeConical,\n    initializeExtension,\n    initializeTorsion,\n    initialTension,\n    largeOD,\n    legLength1,\n    legLength2,\n    maxDeflection,\n    meanDiameter,\n    outerDiameter,\n    shearModulus,\n    smallOD,\n    springType,\n    torsionBodyLength,\n    torsionFreeAngle,\n    torsionWindingDirection,\n    wireDiameter,\n  ]);\n\n  if (!analysisResult) {\n    return (\n      <main className=\"container mx-auto py-8 px-4\">\n        <div className=\"space-y-2\">\n          <h1 className=\"text-2xl font-bold\">\n            {isZh ? \"分析失败\" : \"Analysis Unavailable\"}\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {isZh\n              ? \"我们无法根据当前设计生成工程分析，请返回计算器重新计算。\"\n              : \"We couldn’t generate an analysis for the current design. Please return to the Calculator and run the calculation again.\"}\n          </p>\n        </div>\n        <Button asChild className=\"mt-6\">\n          <Link href=\"/tools/calculator\">{isZh ? \"返回计算器\" : \"Back to Calculator\"}</Link>\n        </Button>\n      </main>\n    );\n  }\n\n  const handleExportPDF = () => {\n    try {\n      const results = SpringAnalysisEngine.analyze(engineGeometry, workingConditions);\n      const reportData = createReportData(engineGeometry, workingConditions, results, {\n        language: isZh ? \"zh\" : \"en\",\n      });\n      printReport(reportData);\n    } catch (error) {\n      console.error(\"Export error:\", error);\n    }\n  };\n\n  const handleDownloadHTML = () => {\n    try {\n      const results = SpringAnalysisEngine.analyze(engineGeometry, workingConditions);\n      const reportData = createReportData(engineGeometry, workingConditions, results, {\n        language: \"bilingual\",\n      });\n      downloadReportHTML(reportData);\n    } catch (error) {\n      console.error(\"Download error:\", error);\n    }\n  };\n\n  const getVisualizer = () => {\n    switch (springType) {\n      case \"compression\":\n        return <CompressionSpringVisualizer />;\n      case \"conical\":\n        return <ConicalSpringVisualizer />;\n      case \"extension\":\n        return <ExtensionSpringVisualizer />;\n      case \"torsion\":\n        return <TorsionSpringVisualizer />;\n      default:\n        return (\n          <div className=\"h-full w-full flex items-center justify center bg-slate-900 text-slate-400 text-sm\">\n            {isZh ? \"3D 视图开发中\" : \"3D View Coming Soon\"}\n          </div>\n        );\n    }\n  };\n\n  const safeHookType = hookType ?? \"machine\";\n  const hookLabel =\n    EXTENSION_HOOK_LABELS[safeHookType]?.[isZh ? \"zh\" : \"en\"] ??\n    (isZh ? \"默认钩型\" : \"Default Hook\");\n  const displayFreeLength =\n    springType === \"compression\"\n      ? freeLength ?? 0\n      : springType === \"conical\"\n      ? conicalFreeLength ?? 0\n      : 50;\n  const estimatedSpringRate =\n    analysisResult && meanDiameter\n      ? (shearModulus * Math.pow(wireDiameter, 4)) /\n        (8 * Math.pow(meanDiameter, 3) * activeCoils)\n      : 10;\n\n  return (\n    <main className=\"container mx\tauto py-8 px-4\">\n      <div className=\"mb-8 flex items-start justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold mb-2\">\n            {isZh ? \"弹簧工程分析\" : \"Spring Engineering Analysis\"}\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {isZh\n              ? \"完整的弹簧应力、疲劳、安全系数和屈曲分析\"\n              : \"Complete stress, fatigue, safety factor, and buckling analysis\"}\n          </p>\n        </div>\n        <Link href=\"/tools/advanced-analysis\">\n          <Button variant=\"outline\" className=\"gap-2\">\n            <Brain className=\"h-4 w-4\" />\n            {isZh ? \"高级分析\" : \"Advanced Analysis\"}\n          </Button>\n        </Link>\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-[350px,1fr]\">\n        {/* Input Panel - Read Only */}\n        <div className=\"space-y-4\">\n          {/* Spring Type - Read Only */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"弹簧类型\" : \"Spring Type\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"px-3 py-2 bg-slate-100 rounded-md text-sm font-medium\">\n                {springType === \"compression\" && (isZh ? \"压缩弹簧\" : \"Compression Spring\")}\n                {springType === \"extension\" && (isZh ? \"拉伸弹簧\" : \"Extension Spring\")}\n                {springType === \"torsion\" && (isZh ? \"扭转弹簧\" : \"Torsion Spring\")}\n                {springType === \"conical\" && (isZh ? \"锥形弹簧\" : \"Conical Spring\")}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Material - Read Only */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"材料\" : \"Material\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"px-3 py-2 bg-slate-100 rounded-md text-sm font-medium\">\n                {materialOptions.find(opt => opt.value === materialId)?.[isZh ? \"labelZh\" : \"labelEn\"] || materialId}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Geometry Parameters - Read Only */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"几何参数\" : \"Geometry\"}\n              </CardTitle>\n              <p className=\"text-xs text-muted-foreground\">\n                {isZh ? \"（从计算器传入，只读）\" : \"(From Calculator, Read-Only)\"}\n              </p>\n            </CardHeader>\n            <CardContent className=\"space-y-2 text-sm\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">d (mm):</span>\n                <span className=\"font-medium\">{wireDiameter}</span>\n              </div>\n              {springType !== \"conical\" ? (\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Dm (mm):</span>\n                  <span className=\"font-medium\">{meanDiameter ?? \"--\"}</span>\n                </div>\n              ) : (\n                <>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">D1 (mm):</span>\n                    <span className=\"font-medium\">{largeOD}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">D2 (mm):</span>\n                    <span className=\"font-medium\">{smallOD}</span>\n                  </div>\n                </>\n              )}\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">Na:</span>\n                <span className=\"font-medium\">{activeCoils}</span>\n              </div>\n\n              {/* Type-specific parameters */}\n              {springType === \"compression\" && (\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">L0 (mm):</span>\n                  <span className=\"font-medium\">{freeLength}</span>\n                </div>\n              )}\n\n              {springType === \"extension\" && (\n                <>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Lb (mm):</span>\n                    <span className=\"font-medium\">{bodyLength}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Fi (N):</span>\n                    <span className=\"font-medium\">{initialTension}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"钩型\" : \"Hook Type\"}:</span>\n                    <span className=\"font-medium\">{hookLabel}</span>\n                  </div>\n                </>\n              )}\n\n              {springType === \"torsion\" && (\n                <>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Lb (mm):</span>\n                    <span className=\"font-medium\">{torsionBodyLength}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">L1 (mm):</span>\n                    <span className=\"font-medium\">{legLength1}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">L2 (mm):</span>\n                    <span className=\"font-medium\">{legLength2}</span>\n                  </div>\n                </>\n              )}\n\n              {springType === \"conical\" && (\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">L0 (mm):</span>\n                  <span className=\"font-medium\">{conicalFreeLength}</span>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Working Conditions - Read Only */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"工作条件\" : \"Working Conditions\"}\n              </CardTitle>\n              <p className=\"text-xs text-muted-foreground\">\n                {isZh ? \"（从计算器传入，只读）\" : \"(From Calculator, Read-Only)\"}\n              </p>\n            </CardHeader>\n            <CardContent className=\"space-y-2 text-sm\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">\n                  {springType === \"torsion\" ? \"θ_min (°):\" : \"Δx_min (mm):\"}\n                </span>\n                <span className=\"font-medium\">{minDeflection}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">\n                  {springType === \"torsion\" ? \"θ_max (°):\" : \"Δx_max (mm):\"}\n                </span>\n                <span className=\"font-medium\">{maxDeflection}</span>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Export Buttons */}\n          <Card>\n            <CardContent className=\"pt-4 space-y-2\">\n              <Button className=\"w-full\" onClick={handleExportPDF}>\n                {isZh ? \"打印 PDF 报告\" : \"Print PDF Report\"}\n              </Button>\n              <Button variant=\"outline\" className=\"w-full\" onClick={handleDownloadHTML}>\n                {isZh ? \"下载 HTML 报告\" : \"Download HTML Report\"}\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* FEA Analysis Panel */}\n          <FeaPanel />\n        </div>\n\n        {/* Force Tester Panel */}\n        <UnifiedForceTester\n          geometry={engineGeometry}\n          workingConditions={workingConditions}\n          visualizer={getVisualizer()}\n          onExportPDF={handleExportPDF}\n        />\n      </div>\n\n      {/* Advanced Analysis Panel */}\n      {analysisResult && (\n        <div className=\"mt-6 space-y-6\">\n          {/* Type-Specific Analysis Panel */}\n          <SpringTypeSpecificPanel\n            geometry={engineGeometry}\n            analysisResult={analysisResult}\n            springRate={analysisResult.geometry.springIndex > 0 ? estimatedSpringRate : 10}\n            maxForce={estimatedSpringRate * maxDeflection}\n          />\n          \n          <AdvancedAnalysisPanel\n            geometry={engineGeometry}\n            analysisResult={analysisResult}\n            springRate={analysisResult.geometry.springIndex > 0 ? estimatedSpringRate : 10}\n            maxStress={analysisResult.stress.tauEffective}\n            freeLength={displayFreeLength}\n          />\n          \n          {/* Smart Diagnostics & Optimization Panel */}\n          <SmartAnalysisPanel\n            geometry={engineGeometry}\n            analysisResult={analysisResult}\n            workingConditions={workingConditions}\n            springRate={analysisResult.geometry.springIndex > 0 ? estimatedSpringRate : 10}\n            currentDeflection={maxDeflection}\n          />\n          \n          {/* Advanced Simulation Panel (Phase 5) */}\n          <AdvancedSimulationPanel\n            geometry={engineGeometry}\n            springRate={analysisResult.geometry.springIndex > 0 ? estimatedSpringRate : 10}\n            maxStress={analysisResult.stress.tauEffective}\n            naturalFrequency={50}\n            workingConditions={workingConditions}\n          />\n        </div>\n      )}\n    </main>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/arc-spring/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/cad-export/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LanguageText' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata } from \"next\";\nimport CadExportPageContent from \"@/components/cad/CadExportContent\";\nimport { LanguageText } from \"@/components/language-context\";\n\nexport const metadata: Metadata = {\n  title: \"Spring CAD Export | Generate Manufacturable Spring Geometry\",\n  description:\n    \"Export accurate spring geometry for CAD and manufacturing. Supports compression, extension, wave, and die springs with real-world constraints.\",\n  keywords: [\n    \"spring cad export\",\n    \"spring geometry generator\",\n    \"STEP file export\",\n    \"spring 3d model\",\n    \"freecad spring generator\",\n  ],\n};\n\nexport default function CadExportPage() {\n  return <CadExportPageContent />;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/calculator/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/compression-spring/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/die-spring/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/engineering-analysis/page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LanguageText' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata } from \"next\";\nimport AnalysisPageContent from \"@/components/analysis/AnalysisPageContent\";\nimport { LanguageText } from \"@/components/language-context\";\n\nexport const metadata: Metadata = {\n  title: \"Spring Engineering Analysis | Stress, Fatigue & FEA Simulation\",\n  description:\n    \"Advanced engineering analysis for springs. Calculate stress, fatigue life, Goodman diagrams, and run FEA simulations for compression, extension, and torsion springs.\",\n  keywords: [\n    \"spring stress analysis\",\n    \"spring fatigue calculation\",\n    \"spring FEA simulation\",\n    \"Goodman diagram spring\",\n    \"spring design validation\",\n    \"engineering spring analysis\",\n  ],\n};\n\nexport default function EngineeringAnalysisPage() {\n  return <AnalysisPageContent />;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/engineering/die-spring/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/extension-spring/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/simulator/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/suspension-spring/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/variable-pitch-compression/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/app/tools/wave-spring/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/AdvancedAnalysisPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'generateHarmonicScan' is defined but never used.","line":21,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'generateTemperatureDecayCurve' is defined but never used.","line":26,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useLanguage } from \"@/components/language-context\";\n\nimport type { SpringGeometry, SpringAnalysisResult } from \"@/lib/engine/types\";\nimport {\n  calculateDynamics,\n  generateHarmonicScan,\n  type DynamicsResult,\n} from \"@/lib/engine/dynamics\";\nimport {\n  calculateTemperatureEffects,\n  generateTemperatureDecayCurve,\n  type TemperatureEffectResult,\n} from \"@/lib/engine/temperature\";\nimport {\n  calculateCreepAnalysis,\n  type CreepResult,\n} from \"@/lib/engine/creep\";\nimport {\n  calculateEnvironmentEffects,\n  getEnvironmentOptions,\n  type EnvironmentType,\n  type EnvironmentEffectResult,\n} from \"@/lib/engine/environment\";\nimport {\n  calculateVerdict,\n  type VerdictResult,\n} from \"@/lib/engine/verdict\";\n\ninterface AdvancedAnalysisPanelProps {\n  geometry: SpringGeometry;\n  analysisResult: SpringAnalysisResult;\n  springRate: number;\n  maxStress: number;\n  freeLength: number;\n}\n\nexport function AdvancedAnalysisPanel({\n  geometry,\n  analysisResult,\n  springRate,\n  maxStress,\n  freeLength,\n}: AdvancedAnalysisPanelProps) {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  // Input states\n  const [workingFrequency, setWorkingFrequency] = useState<number>(0);\n  const [operatingTemperature, setOperatingTemperature] = useState<number>(20);\n  const [operatingTime, setOperatingTime] = useState<number>(1000);\n  const [environmentType, setEnvironmentType] = useState<EnvironmentType>(\"indoor\");\n\n  // Calculate dynamics\n  const dynamicsResult = useMemo<DynamicsResult | null>(() => {\n    try {\n      return calculateDynamics(geometry, springRate, workingFrequency > 0 ? workingFrequency : undefined);\n    } catch {\n      return null;\n    }\n  }, [geometry, springRate, workingFrequency]);\n\n  // Calculate temperature effects\n  const temperatureResult = useMemo<TemperatureEffectResult | null>(() => {\n    try {\n      return calculateTemperatureEffects(geometry.materialId, operatingTemperature);\n    } catch {\n      return null;\n    }\n  }, [geometry.materialId, operatingTemperature]);\n\n  // Calculate creep\n  const creepResult = useMemo<CreepResult | null>(() => {\n    try {\n      return calculateCreepAnalysis(\n        geometry.materialId,\n        maxStress,\n        freeLength,\n        operatingTime,\n        operatingTemperature\n      );\n    } catch {\n      return null;\n    }\n  }, [geometry.materialId, maxStress, freeLength, operatingTime, operatingTemperature]);\n\n  // Calculate environment effects\n  const environmentResult = useMemo<EnvironmentEffectResult | null>(() => {\n    try {\n      // Use mean stress as base for endurance calculation\n      const baseEndurance = analysisResult.fatigue.tauMean * analysisResult.fatigue.infiniteLifeSafetyFactor;\n      return calculateEnvironmentEffects(geometry.materialId, environmentType, baseEndurance);\n    } catch {\n      return null;\n    }\n  }, [geometry.materialId, environmentType, analysisResult.fatigue]);\n\n  // Calculate verdict\n  const verdictResult = useMemo<VerdictResult | null>(() => {\n    try {\n      return calculateVerdict(analysisResult, {\n        dynamics: dynamicsResult ?? undefined,\n        creep: creepResult ?? undefined,\n        environment: environmentResult ?? undefined,\n        temperature: temperatureResult ?? undefined,\n      });\n    } catch {\n      return null;\n    }\n  }, [analysisResult, dynamicsResult, creepResult, environmentResult, temperatureResult]);\n\n  const environmentOptions = getEnvironmentOptions();\n\n  return (\n    <Card className=\"w-full\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center justify-between\">\n          <span>{isZh ? \"高级工程分析\" : \"Advanced Engineering Analysis\"}</span>\n          {verdictResult && (\n            <span\n              className={`rounded-full px-3 py-1 text-sm font-bold ${\n                verdictResult.status === \"PASS\"\n                  ? \"bg-green-100 text-green-800\"\n                  : verdictResult.status === \"CONDITIONAL_PASS\"\n                  ? \"bg-yellow-100 text-yellow-800\"\n                  : \"bg-red-100 text-red-800\"\n              }`}\n            >\n              {verdictResult.status}\n            </span>\n          )}\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <Tabs defaultValue=\"dynamics\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-5\">\n            <TabsTrigger value=\"dynamics\">{isZh ? \"动力学\" : \"Dynamics\"}</TabsTrigger>\n            <TabsTrigger value=\"temperature\">{isZh ? \"温度\" : \"Temperature\"}</TabsTrigger>\n            <TabsTrigger value=\"creep\">{isZh ? \"蠕变\" : \"Creep\"}</TabsTrigger>\n            <TabsTrigger value=\"environment\">{isZh ? \"环境\" : \"Environment\"}</TabsTrigger>\n            <TabsTrigger value=\"verdict\">{isZh ? \"判定\" : \"Verdict\"}</TabsTrigger>\n          </TabsList>\n\n          {/* Dynamics Tab */}\n          <TabsContent value=\"dynamics\" className=\"space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label>{isZh ? \"工作频率 (Hz)\" : \"Working Frequency (Hz)\"}</Label>\n                <Input\n                  type=\"number\"\n                  value={workingFrequency}\n                  onChange={(e) => setWorkingFrequency(Number(e.target.value))}\n                  placeholder=\"0 = no check\"\n                />\n              </div>\n              {dynamicsResult && (\n                <div className=\"space-y-2 rounded-lg bg-slate-50 p-4\">\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"弹簧质量\" : \"Spring Mass\"}</span>\n                    <span className=\"font-medium\">{(dynamicsResult.springMass * 1000).toFixed(2)} g</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"固有频率 fn\" : \"Natural Frequency fn\"}</span>\n                    <span className=\"font-medium\">{dynamicsResult.naturalFrequency.toFixed(1)} Hz</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"冲击波速度\" : \"Surge Wave Velocity\"}</span>\n                    <span className=\"font-medium\">{dynamicsResult.surgeWaveVelocity.toFixed(0)} m/s</span>\n                  </div>\n                  {workingFrequency > 0 && (\n                    <div className={`mt-2 rounded p-2 text-sm ${\n                      dynamicsResult.resonanceStatus.isAtRisk \n                        ? \"bg-red-100 text-red-800\" \n                        : \"bg-green-100 text-green-800\"\n                    }`}>\n                      {isZh \n                        ? dynamicsResult.resonanceStatus.message.zh \n                        : dynamicsResult.resonanceStatus.message.en}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          </TabsContent>\n\n          {/* Temperature Tab */}\n          <TabsContent value=\"temperature\" className=\"space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label>{isZh ? \"工作温度 (°C)\" : \"Operating Temperature (°C)\"}</Label>\n                <Input\n                  type=\"number\"\n                  value={operatingTemperature}\n                  onChange={(e) => setOperatingTemperature(Number(e.target.value))}\n                />\n              </div>\n              {temperatureResult && (\n                <div className=\"space-y-2 rounded-lg bg-slate-50 p-4\">\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"强度损失\" : \"Strength Loss\"}</span>\n                    <span className={`font-medium ${temperatureResult.strengthLossPercent > 20 ? \"text-red-600\" : \"\"}`}>\n                      {temperatureResult.strengthLossPercent.toFixed(1)}%\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"模量损失\" : \"Modulus Loss\"}</span>\n                    <span className=\"font-medium\">{temperatureResult.modulusLossPercent.toFixed(1)}%</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"调整后许用应力\" : \"Adjusted Allowable\"}</span>\n                    <span className=\"font-medium\">{temperatureResult.adjustedAllowableStress.toFixed(0)} MPa</span>\n                  </div>\n                  {temperatureResult.warning && (\n                    <div className=\"mt-2 rounded bg-yellow-100 p-2 text-sm text-yellow-800\">\n                      {isZh ? temperatureResult.warning.zh : temperatureResult.warning.en}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          </TabsContent>\n\n          {/* Creep Tab */}\n          <TabsContent value=\"creep\" className=\"space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label>{isZh ? \"工作时间 (小时)\" : \"Operating Time (hours)\"}</Label>\n                <Input\n                  type=\"number\"\n                  value={operatingTime}\n                  onChange={(e) => setOperatingTime(Number(e.target.value))}\n                />\n              </div>\n              {creepResult && (\n                <div className=\"space-y-2 rounded-lg bg-slate-50 p-4\">\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"应力比 τ/Sy\" : \"Stress Ratio τ/Sy\"}</span>\n                    <span className={`font-medium ${creepResult.stressRatio > 0.75 ? \"text-red-600\" : \"\"}`}>\n                      {(creepResult.stressRatio * 100).toFixed(1)}%\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"永久变形\" : \"Permanent Set\"}</span>\n                    <span className=\"font-medium\">{creepResult.permanentSetPercent.toFixed(2)}%</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"蠕变寿命\" : \"Creep Lifetime\"}</span>\n                    <span className=\"font-medium\">\n                      {creepResult.creepLifetime > 1e8 ? \"∞\" : `${(creepResult.creepLifetime / 1000).toFixed(0)}k h`}\n                    </span>\n                  </div>\n                  <div className={`mt-2 rounded p-2 text-sm ${\n                    creepResult.riskLevel === \"low\" ? \"bg-green-100 text-green-800\" :\n                    creepResult.riskLevel === \"medium\" ? \"bg-yellow-100 text-yellow-800\" :\n                    creepResult.riskLevel === \"high\" ? \"bg-orange-100 text-orange-800\" :\n                    \"bg-red-100 text-red-800\"\n                  }`}>\n                    {isZh ? creepResult.message.zh : creepResult.message.en}\n                  </div>\n                </div>\n              )}\n            </div>\n          </TabsContent>\n\n          {/* Environment Tab */}\n          <TabsContent value=\"environment\" className=\"space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label>{isZh ? \"工作环境\" : \"Operating Environment\"}</Label>\n                <Select value={environmentType} onValueChange={(v) => setEnvironmentType(v as EnvironmentType)}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {environmentOptions.map((opt) => (\n                      <SelectItem key={opt.value} value={opt.value}>\n                        {isZh ? opt.labelZh : opt.labelEn}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              {environmentResult && (\n                <div className=\"space-y-2 rounded-lg bg-slate-50 p-4\">\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"腐蚀系数\" : \"Corrosion Factor\"}</span>\n                    <span className=\"font-medium\">{environmentResult.effectiveCorrosionFactor.toFixed(2)}</span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"疲劳衰减\" : \"Fatigue Reduction\"}</span>\n                    <span className={`font-medium ${environmentResult.fatigueReductionFactor < 0.8 ? \"text-red-600\" : \"\"}`}>\n                      {(environmentResult.fatigueReductionFactor * 100).toFixed(0)}%\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"SCC 风险\" : \"SCC Risk\"}</span>\n                    <span className={`font-medium ${\n                      environmentResult.sccRisk === \"high\" ? \"text-red-600\" :\n                      environmentResult.sccRisk === \"medium\" ? \"text-yellow-600\" : \"\"\n                    }`}>\n                      {environmentResult.sccRisk.toUpperCase()}\n                    </span>\n                  </div>\n                  {environmentResult.warning && (\n                    <div className=\"mt-2 rounded bg-red-100 p-2 text-sm text-red-800\">\n                      {isZh ? environmentResult.warning.zh : environmentResult.warning.en}\n                    </div>\n                  )}\n                  {environmentResult.recommendations.length > 0 && (\n                    <div className=\"mt-2 text-xs text-muted-foreground\">\n                      <strong>{isZh ? \"建议：\" : \"Recommendations:\"}</strong>\n                      <ul className=\"list-disc pl-4\">\n                        {environmentResult.recommendations.slice(0, 2).map((rec, i) => (\n                          <li key={i}>{rec}</li>\n                        ))}\n                      </ul>\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          </TabsContent>\n\n          {/* Verdict Tab */}\n          <TabsContent value=\"verdict\" className=\"space-y-4\">\n            {verdictResult && (\n              <div className=\"space-y-4\">\n                <div className={`rounded-lg p-4 text-center ${\n                  verdictResult.status === \"PASS\" ? \"bg-green-100\" :\n                  verdictResult.status === \"CONDITIONAL_PASS\" ? \"bg-yellow-100\" :\n                  \"bg-red-100\"\n                }`}>\n                  <div className={`text-2xl font-bold ${\n                    verdictResult.status === \"PASS\" ? \"text-green-800\" :\n                    verdictResult.status === \"CONDITIONAL_PASS\" ? \"text-yellow-800\" :\n                    \"text-red-800\"\n                  }`}>\n                    {verdictResult.status}\n                  </div>\n                  <p className=\"mt-1 text-sm\">\n                    {isZh ? verdictResult.message.zh : verdictResult.message.en}\n                  </p>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <h4 className=\"font-medium\">{isZh ? \"检查项目\" : \"Criteria Check\"}</h4>\n                  <div className=\"grid gap-2\">\n                    {verdictResult.criteria.map((criterion, i) => (\n                      <div\n                        key={i}\n                        className={`flex items-center justify-between rounded p-2 text-sm ${\n                          criterion.passed ? \"bg-green-50\" :\n                          criterion.severity === \"critical\" ? \"bg-red-50\" :\n                          \"bg-yellow-50\"\n                        }`}\n                      >\n                        <span className=\"flex items-center gap-2\">\n                          <span className={criterion.passed ? \"text-green-600\" : \"text-red-600\"}>\n                            {criterion.passed ? \"✓\" : \"✗\"}\n                          </span>\n                          {isZh ? criterion.nameZh : criterion.name}\n                        </span>\n                        <span className=\"text-muted-foreground\">\n                          {criterion.actualValue}\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                {verdictResult.recommendations.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <h4 className=\"font-medium\">{isZh ? \"改进建议\" : \"Recommendations\"}</h4>\n                    <ul className=\"list-disc space-y-1 pl-4 text-sm text-muted-foreground\">\n                      {verdictResult.recommendations.map((rec, i) => (\n                        <li key={i}>{rec}</li>\n                      ))}\n                    </ul>\n                  </div>\n                )}\n              </div>\n            )}\n          </TabsContent>\n        </Tabs>\n      </CardContent>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/AdvancedSimulationPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'generateHeatTreatmentCurve' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'generateBucklingCurve' is defined but never used.","line":46,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'findCriticalDeflection' is defined but never used.","line":47,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":47,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'bucklingResult' is assigned a value but never used.","line":182,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":182,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useMemo, useCallback } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useLanguage } from \"@/components/language-context\";\n\nimport type { SpringGeometry, CompressionSpringGeometry, WorkingConditions } from \"@/lib/engine/types\";\nimport {\n  calculateNonlinearStress,\n  calculateNonlinearFatigueLife,\n  calculateNonlinearSafetyFactor,\n} from \"@/lib/engine/nonlinearMaterial\";\nimport {\n  calculateHeatTreatmentRecovery,\n  calculateThermalCyclingFatigue,\n  generateHeatTreatmentCurve,\n} from \"@/lib/engine/thermalEffects\";\nimport {\n  evaluateShockFatigue,\n  parseShockLoadsCSV,\n  generateRandomShockSequence,\n  type ShockFatigueResult,\n} from \"@/lib/engine/shockFatigue\";\nimport {\n  calculateNVH,\n  type NVHResult,\n} from \"@/lib/engine/nvhModel\";\nimport {\n  calculateCyclicCreep,\n  type CyclicCreepResult,\n} from \"@/lib/engine/cyclicCreep\";\nimport {\n  calculateNonlinearBuckling,\n  generateBucklingCurve,\n  findCriticalDeflection,\n  type NonlinearBucklingResult,\n} from \"@/lib/engine/nonlinearBuckling\";\nimport {\n  exportFEAMesh,\n  downloadFEAMesh,\n  type FEAExportFormat,\n  type FEAMeshData,\n} from \"@/lib/engine/feaExport\";\n\ninterface AdvancedSimulationPanelProps {\n  geometry: SpringGeometry;\n  springRate: number;\n  maxStress: number;\n  naturalFrequency: number;\n  workingConditions: WorkingConditions;\n}\n\nexport function AdvancedSimulationPanel({\n  geometry,\n  springRate,\n  maxStress,\n  naturalFrequency,\n  workingConditions,\n}: AdvancedSimulationPanelProps) {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  // State for various inputs\n  const [soakTime, setSoakTime] = useState(2);\n  const [soakTemp, setSoakTemp] = useState(250);\n  const [minTemp, setMinTemp] = useState(20);\n  const [maxTemp, setMaxTemp] = useState(150);\n  const [shockCSV, setShockCSV] = useState(\"\");\n  const [operatingFreq, setOperatingFreq] = useState(10);\n  const [operatingHours, setOperatingHours] = useState(5000);\n  const [cyclesPerHour, setCyclesPerHour] = useState(100);\n  const [feaFormat, setFeaFormat] = useState<FEAExportFormat>(\"abaqus\");\n  const [nodesPerCoil, setNodesPerCoil] = useState(36);\n\n  // Nonlinear stress analysis\n  const nonlinearResult = useMemo(() => {\n    try {\n      const stressResult = calculateNonlinearStress(maxStress, geometry.materialId);\n      const fatigueResult = calculateNonlinearFatigueLife(\n        maxStress,\n        maxStress * 0.3,\n        geometry.materialId\n      );\n      const safetyResult = calculateNonlinearSafetyFactor(maxStress, geometry.materialId);\n      return { stressResult, fatigueResult, safetyResult };\n    } catch {\n      return null;\n    }\n  }, [maxStress, geometry.materialId]);\n\n  // Heat treatment recovery\n  const heatTreatmentResult = useMemo(() => {\n    try {\n      return calculateHeatTreatmentRecovery(springRate, soakTime, soakTemp, geometry.materialId);\n    } catch {\n      return null;\n    }\n  }, [springRate, soakTime, soakTemp, geometry.materialId]);\n\n  // Thermal cycling fatigue\n  const thermalCyclingResult = useMemo(() => {\n    try {\n      const strainAmplitude = maxStress / 207000; // Approximate\n      return calculateThermalCyclingFatigue(geometry.materialId, minTemp, maxTemp, strainAmplitude);\n    } catch {\n      return null;\n    }\n  }, [geometry.materialId, minTemp, maxTemp, maxStress]);\n\n  // Shock fatigue\n  const [shockResult, setShockResult] = useState<ShockFatigueResult | null>(null);\n  \n  const runShockAnalysis = useCallback(() => {\n    try {\n      let loads;\n      if (shockCSV.trim()) {\n        loads = parseShockLoadsCSV(shockCSV);\n      } else {\n        loads = generateRandomShockSequence(springRate * 10, springRate * 3, 100);\n      }\n      \n      const meanDiameter = 'meanDiameter' in geometry ? geometry.meanDiameter : 20;\n      const result = evaluateShockFatigue(\n        loads,\n        geometry.wireDiameter,\n        meanDiameter,\n        geometry.materialId\n      );\n      setShockResult(result);\n    } catch (error) {\n      console.error(\"Shock analysis error:\", error);\n    }\n  }, [shockCSV, geometry, springRate]);\n\n  // NVH analysis\n  const nvhResult = useMemo<NVHResult | null>(() => {\n    if (geometry.type !== 'compression') return null;\n    try {\n      return calculateNVH(\n        geometry,\n        workingConditions.maxDeflection,\n        springRate,\n        naturalFrequency,\n        operatingFreq\n      );\n    } catch {\n      return null;\n    }\n  }, [geometry, workingConditions.maxDeflection, springRate, naturalFrequency, operatingFreq]);\n\n  // Cyclic creep\n  const cyclicCreepResult = useMemo<CyclicCreepResult | null>(() => {\n    try {\n      const freeLength = 'freeLength' in geometry ? (geometry as CompressionSpringGeometry).freeLength : 50;\n      return calculateCyclicCreep(\n        maxStress,\n        maxStress * 0.3,\n        (minTemp + maxTemp) / 2,\n        operatingHours,\n        cyclesPerHour,\n        freeLength,\n        geometry.materialId\n      );\n    } catch {\n      return null;\n    }\n  }, [maxStress, minTemp, maxTemp, operatingHours, cyclesPerHour, geometry]);\n\n  // Nonlinear buckling\n  const bucklingResult = useMemo<NonlinearBucklingResult | null>(() => {\n    if (geometry.type !== 'compression') return null;\n    try {\n      return calculateNonlinearBuckling(\n        geometry as CompressionSpringGeometry,\n        springRate,\n        workingConditions.maxDeflection,\n        79300 // Shear modulus\n      );\n    } catch {\n      return null;\n    }\n  }, [geometry, springRate, workingConditions.maxDeflection]);\n\n  // FEA mesh preview\n  const [meshPreview, setMeshPreview] = useState<FEAMeshData | null>(null);\n  \n  const generateMeshPreview = useCallback(() => {\n    try {\n      const { mesh } = exportFEAMesh(geometry, feaFormat, { nodesPerCoil });\n      setMeshPreview(mesh);\n    } catch (error) {\n      console.error(\"Mesh generation error:\", error);\n    }\n  }, [geometry, feaFormat, nodesPerCoil]);\n\n  const handleDownloadFEA = useCallback(() => {\n    downloadFEAMesh(geometry, feaFormat, { nodesPerCoil });\n  }, [geometry, feaFormat, nodesPerCoil]);\n\n  return (\n    <Card className=\"w-full\">\n      <CardHeader>\n        <CardTitle>{isZh ? \"高级仿真分析\" : \"Advanced Simulation Analysis\"}</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <Tabs defaultValue=\"nonlinear\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-6 text-xs\">\n            <TabsTrigger value=\"nonlinear\">{isZh ? \"非线性\" : \"Nonlinear\"}</TabsTrigger>\n            <TabsTrigger value=\"thermal\">{isZh ? \"热效应\" : \"Thermal\"}</TabsTrigger>\n            <TabsTrigger value=\"shock\">{isZh ? \"冲击\" : \"Shock\"}</TabsTrigger>\n            <TabsTrigger value=\"nvh\">NVH</TabsTrigger>\n            <TabsTrigger value=\"creep\">{isZh ? \"蠕变\" : \"Creep\"}</TabsTrigger>\n            <TabsTrigger value=\"fea\">FEA</TabsTrigger>\n          </TabsList>\n\n          {/* Nonlinear Material Tab */}\n          <TabsContent value=\"nonlinear\" className=\"space-y-4\">\n            <div className=\"rounded-lg bg-slate-50 p-3\">\n              <h4 className=\"font-medium mb-2\">{isZh ? \"Ramberg-Osgood 非线性分析\" : \"Ramberg-Osgood Nonlinear Analysis\"}</h4>\n              <p className=\"text-sm text-muted-foreground\">\n                ε = σ/E + K×(σ)^n\n              </p>\n            </div>\n            \n            {nonlinearResult && (\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <h5 className=\"text-sm font-medium\">{isZh ? \"应力分析\" : \"Stress Analysis\"}</h5>\n                  <div className=\"rounded-lg border p-3 space-y-1 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"线性应力\" : \"Linear Stress\"}</span>\n                      <span className=\"font-mono\">{nonlinearResult.stressResult.linearStress.toFixed(1)} MPa</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"非线性应力\" : \"Nonlinear Stress\"}</span>\n                      <span className={`font-mono ${nonlinearResult.stressResult.isNonlinear ? \"text-orange-600\" : \"\"}`}>\n                        {nonlinearResult.stressResult.nonlinearStress.toFixed(1)} MPa\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"塑性应变\" : \"Plastic Strain\"}</span>\n                      <span className=\"font-mono\">{(nonlinearResult.stressResult.plasticStrain * 100).toFixed(4)}%</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"非线性区域\" : \"Nonlinear Region\"}</span>\n                      <span className={nonlinearResult.stressResult.isNonlinear ? \"text-orange-600\" : \"text-green-600\"}>\n                        {nonlinearResult.stressResult.isNonlinear ? (isZh ? \"是\" : \"Yes\") : (isZh ? \"否\" : \"No\")}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <h5 className=\"text-sm font-medium\">{isZh ? \"疲劳与安全\" : \"Fatigue & Safety\"}</h5>\n                  <div className=\"rounded-lg border p-3 space-y-1 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"线性寿命\" : \"Linear Life\"}</span>\n                      <span className=\"font-mono\">{nonlinearResult.fatigueResult.linearLife.toExponential(2)}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"非线性寿命\" : \"Nonlinear Life\"}</span>\n                      <span className=\"font-mono\">{nonlinearResult.fatigueResult.nonlinearLife.toExponential(2)}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"线性安全系数\" : \"Linear SF\"}</span>\n                      <span className=\"font-mono\">{nonlinearResult.safetyResult.linearSF.toFixed(2)}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"非线性安全系数\" : \"Nonlinear SF\"}</span>\n                      <span className=\"font-mono\">{nonlinearResult.safetyResult.nonlinearSF.toFixed(2)}</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n          </TabsContent>\n\n          {/* Thermal Effects Tab */}\n          <TabsContent value=\"thermal\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-3\">\n                <h5 className=\"text-sm font-medium\">{isZh ? \"热处理恢复\" : \"Heat Treatment Recovery\"}</h5>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  <div>\n                    <Label className=\"text-xs\">{isZh ? \"浸泡时间 (h)\" : \"Soak Time (h)\"}</Label>\n                    <Input type=\"number\" value={soakTime} onChange={e => setSoakTime(Number(e.target.value))} />\n                  </div>\n                  <div>\n                    <Label className=\"text-xs\">{isZh ? \"浸泡温度 (°C)\" : \"Soak Temp (°C)\"}</Label>\n                    <Input type=\"number\" value={soakTemp} onChange={e => setSoakTemp(Number(e.target.value))} />\n                  </div>\n                </div>\n                {heatTreatmentResult && (\n                  <div className=\"rounded-lg border p-3 space-y-1 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"恢复百分比\" : \"Recovery %\"}</span>\n                      <span className=\"font-mono text-green-600\">+{heatTreatmentResult.recoveryPercent.toFixed(2)}%</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"恢复刚度\" : \"Recovered k\"}</span>\n                      <span className=\"font-mono\">{heatTreatmentResult.recoveredStiffness.toFixed(2)} N/mm</span>\n                    </div>\n                  </div>\n                )}\n              </div>\n              \n              <div className=\"space-y-3\">\n                <h5 className=\"text-sm font-medium\">{isZh ? \"温度循环疲劳\" : \"Thermal Cycling Fatigue\"}</h5>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  <div>\n                    <Label className=\"text-xs\">{isZh ? \"最低温度 (°C)\" : \"Min Temp (°C)\"}</Label>\n                    <Input type=\"number\" value={minTemp} onChange={e => setMinTemp(Number(e.target.value))} />\n                  </div>\n                  <div>\n                    <Label className=\"text-xs\">{isZh ? \"最高温度 (°C)\" : \"Max Temp (°C)\"}</Label>\n                    <Input type=\"number\" value={maxTemp} onChange={e => setMaxTemp(Number(e.target.value))} />\n                  </div>\n                </div>\n                {thermalCyclingResult && (\n                  <div className=\"rounded-lg border p-3 space-y-1 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span>ΔT</span>\n                      <span className=\"font-mono\">{thermalCyclingResult.deltaT}°C</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"热应变范围\" : \"Thermal Strain\"}</span>\n                      <span className=\"font-mono\">{(thermalCyclingResult.thermalStrainRange * 1e6).toFixed(1)} µε</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"寿命降低\" : \"Life Reduction\"}</span>\n                      <span className={`font-mono ${thermalCyclingResult.lifeReductionFactor < 0.5 ? \"text-red-600\" : \"\"}`}>\n                        {(thermalCyclingResult.lifeReductionFactor * 100).toFixed(1)}%\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>{isZh ? \"风险等级\" : \"Risk Level\"}</span>\n                      <span className={`font-bold ${\n                        thermalCyclingResult.riskLevel === 'critical' ? 'text-red-600' :\n                        thermalCyclingResult.riskLevel === 'high' ? 'text-orange-600' :\n                        thermalCyclingResult.riskLevel === 'medium' ? 'text-yellow-600' : 'text-green-600'\n                      }`}>\n                        {thermalCyclingResult.riskLevel.toUpperCase()}\n                      </span>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          </TabsContent>\n\n          {/* Shock Fatigue Tab */}\n          <TabsContent value=\"shock\" className=\"space-y-4\">\n            <div className=\"space-y-3\">\n              <Label>{isZh ? \"冲击载荷数据 (CSV: 每行一个力值)\" : \"Shock Load Data (CSV: one force per line)\"}</Label>\n              <Textarea\n                placeholder=\"100&#10;150&#10;120&#10;...\"\n                value={shockCSV}\n                onChange={e => setShockCSV(e.target.value)}\n                rows={4}\n              />\n              <Button onClick={runShockAnalysis}>\n                {isZh ? \"运行冲击分析\" : \"Run Shock Analysis\"}\n              </Button>\n            </div>\n            \n            {shockResult && (\n              <div className={`rounded-lg p-4 ${\n                shockResult.status === 'pass' ? 'bg-green-100' :\n                shockResult.status === 'warning' ? 'bg-yellow-100' : 'bg-red-100'\n              }`}>\n                <div className=\"font-bold mb-2\">\n                  {isZh ? shockResult.message.zh : shockResult.message.en}\n                </div>\n                <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"冲击次数\" : \"Shock Count\"}</span>\n                    <div className=\"font-mono\">{shockResult.shockCount}</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"总损伤\" : \"Total Damage\"}</span>\n                    <div className=\"font-mono\">{shockResult.totalDamage.toFixed(4)}</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"最大应力\" : \"Max Stress\"}</span>\n                    <div className=\"font-mono\">{shockResult.maxStress.toFixed(0)} MPa</div>\n                  </div>\n                </div>\n              </div>\n            )}\n          </TabsContent>\n\n          {/* NVH Tab */}\n          <TabsContent value=\"nvh\" className=\"space-y-4\">\n            <div className=\"space-y-3\">\n              <div>\n                <Label className=\"text-xs\">{isZh ? \"工作频率 (Hz)\" : \"Operating Frequency (Hz)\"}</Label>\n                <Input type=\"number\" value={operatingFreq} onChange={e => setOperatingFreq(Number(e.target.value))} />\n              </div>\n            </div>\n            \n            {nvhResult && (\n              <div className={`rounded-lg p-4 ${\n                nvhResult.riskLevel === 'low' ? 'bg-green-100' :\n                nvhResult.riskLevel === 'medium' ? 'bg-yellow-100' :\n                nvhResult.riskLevel === 'high' ? 'bg-orange-100' : 'bg-red-100'\n              }`}>\n                <div className=\"font-bold mb-2\">\n                  {isZh ? nvhResult.message.zh : nvhResult.message.en}\n                </div>\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"预估噪声\" : \"Est. Noise\"}</span>\n                    <div className=\"font-mono text-xl\">{nvhResult.estimatedNoiseLevel.toFixed(0)} dB</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"谐波尖叫风险\" : \"Squeal Risk\"}</span>\n                    <div className={`font-bold ${\n                      nvhResult.harmonicSquealRisk === 'high' ? 'text-red-600' :\n                      nvhResult.harmonicSquealRisk === 'medium' ? 'text-yellow-600' : 'text-green-600'\n                    }`}>\n                      {nvhResult.harmonicSquealRisk.toUpperCase()}\n                    </div>\n                  </div>\n                </div>\n                {nvhResult.recommendations.length > 0 && (\n                  <div className=\"mt-3\">\n                    <span className=\"text-sm font-medium\">{isZh ? \"建议\" : \"Recommendations\"}:</span>\n                    <ul className=\"text-sm list-disc list-inside mt-1\">\n                      {nvhResult.recommendations.map((r, i) => <li key={i}>{r}</li>)}\n                    </ul>\n                  </div>\n                )}\n              </div>\n            )}\n          </TabsContent>\n\n          {/* Cyclic Creep Tab */}\n          <TabsContent value=\"creep\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label className=\"text-xs\">{isZh ? \"运行时间 (h)\" : \"Operating Hours\"}</Label>\n                <Input type=\"number\" value={operatingHours} onChange={e => setOperatingHours(Number(e.target.value))} />\n              </div>\n              <div>\n                <Label className=\"text-xs\">{isZh ? \"每小时循环数\" : \"Cycles/Hour\"}</Label>\n                <Input type=\"number\" value={cyclesPerHour} onChange={e => setCyclesPerHour(Number(e.target.value))} />\n              </div>\n            </div>\n            \n            {cyclicCreepResult && (\n              <div className={`rounded-lg p-4 ${\n                cyclicCreepResult.riskLevel === 'low' ? 'bg-green-100' :\n                cyclicCreepResult.riskLevel === 'medium' ? 'bg-yellow-100' :\n                cyclicCreepResult.riskLevel === 'high' ? 'bg-orange-100' : 'bg-red-100'\n              }`}>\n                <div className=\"font-bold mb-2\">\n                  {isZh ? cyclicCreepResult.message.zh : cyclicCreepResult.message.en}\n                </div>\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"蠕变应变\" : \"Creep Strain\"}</span>\n                    <div className=\"font-mono\">{(cyclicCreepResult.totalCreepStrain * 100).toFixed(4)}%</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"尺寸漂移\" : \"Dimensional Drift\"}</span>\n                    <div className=\"font-mono\">{cyclicCreepResult.dimensionalDrift.toFixed(3)} mm</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"维护间隔\" : \"Maintenance Interval\"}</span>\n                    <div className=\"font-mono\">{cyclicCreepResult.maintenanceInterval.toFixed(0)} h</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"稳定性评分\" : \"Stability Rating\"}</span>\n                    <div className=\"font-mono\">{cyclicCreepResult.stabilityRating}/100</div>\n                  </div>\n                </div>\n              </div>\n            )}\n          </TabsContent>\n\n          {/* FEA Export Tab */}\n          <TabsContent value=\"fea\" className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label className=\"text-xs\">{isZh ? \"导出格式\" : \"Export Format\"}</Label>\n                <Select value={feaFormat} onValueChange={(v) => setFeaFormat(v as FEAExportFormat)}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"abaqus\">Abaqus (.inp)</SelectItem>\n                    <SelectItem value=\"ansys\">ANSYS (.ans)</SelectItem>\n                    <SelectItem value=\"nastran\">NASTRAN (.bdf)</SelectItem>\n                    <SelectItem value=\"step\">STEP (.step)</SelectItem>\n                    <SelectItem value=\"iges\">IGES (.igs)</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label className=\"text-xs\">{isZh ? \"每圈节点数\" : \"Nodes per Coil\"}</Label>\n                <Input type=\"number\" value={nodesPerCoil} onChange={e => setNodesPerCoil(Number(e.target.value))} />\n              </div>\n            </div>\n            \n            <div className=\"flex gap-2\">\n              <Button variant=\"outline\" onClick={generateMeshPreview}>\n                {isZh ? \"预览网格\" : \"Preview Mesh\"}\n              </Button>\n              <Button onClick={handleDownloadFEA}>\n                {isZh ? \"下载 FEA 文件\" : \"Download FEA File\"}\n              </Button>\n            </div>\n            \n            {meshPreview && (\n              <div className=\"rounded-lg border p-4 space-y-2\">\n                <h5 className=\"font-medium\">{isZh ? \"网格预览\" : \"Mesh Preview\"}</h5>\n                <div className=\"grid grid-cols-3 gap-4 text-sm\">\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"节点数\" : \"Nodes\"}</span>\n                    <div className=\"font-mono text-lg\">{meshPreview.nodeCount}</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"单元数\" : \"Elements\"}</span>\n                    <div className=\"font-mono text-lg\">{meshPreview.elementCount}</div>\n                  </div>\n                  <div>\n                    <span className=\"text-muted-foreground\">{isZh ? \"线长\" : \"Wire Length\"}</span>\n                    <div className=\"font-mono text-lg\">{meshPreview.wireLength.toFixed(1)} mm</div>\n                  </div>\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {isZh ? \"网格质量\" : \"Mesh Quality\"}: \n                  {isZh ? \"最小单元\" : \"Min\"}: {meshPreview.quality.minElementLength.toFixed(2)}mm, \n                  {isZh ? \"最大单元\" : \"Max\"}: {meshPreview.quality.maxElementLength.toFixed(2)}mm, \n                  {isZh ? \"长宽比\" : \"Aspect\"}: {meshPreview.quality.aspectRatio.toFixed(2)}\n                </div>\n              </div>\n            )}\n          </TabsContent>\n        </Tabs>\n      </CardContent>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/AnalysisPageContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringMaterialId' is defined but never used.","line":14,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":51},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'EngineSpringGeometry' is defined but never used.","line":15,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":53},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringType' is defined but never used.","line":31,"column":62,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":72},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'freeLength'. Either include it or remove the dependency array.","line":382,"column":6,"nodeType":"ArrayExpression","endLine":407,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [activeCoils, analysisResult, bodyLength, conicalFreeLength, elasticModulus, hookType, initializeCompression, initializeConical, initializeExtension, initializeTorsion, initialTension, largeOD, legLength1, legLength2, maxDeflection, meanDiameter, outerDiameter, shearModulus, smallOD, springType, torsionBodyLength, torsionFreeAngle, torsionWindingDirection, wireDiameter, freeLength]","fix":{"range":[13332,13805],"text":"[activeCoils, analysisResult, bodyLength, conicalFreeLength, elasticModulus, hookType, initializeCompression, initializeConical, initializeExtension, initializeTorsion, initialTension, largeOD, legLength1, legLength2, maxDeflection, meanDiameter, outerDiameter, shearModulus, smallOD, springType, torsionBodyLength, torsionFreeAngle, torsionWindingDirection, wireDiameter, freeLength]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useMemo, useEffect, Suspense } from \"react\";\nimport dynamic from \"next/dynamic\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useLanguage } from \"@/components/language-context\";\nimport { UnifiedForceTester } from \"@/components/force-tester\";\nimport { AdvancedAnalysisPanel } from \"@/components/analysis/AdvancedAnalysisPanel\";\nimport { SmartAnalysisPanel } from \"@/components/analysis/SmartAnalysisPanel\";\nimport { AdvancedSimulationPanel } from \"@/components/analysis/AdvancedSimulationPanel\";\nimport { SpringTypeSpecificPanel } from \"@/components/analysis/SpringTypeSpecificPanel\";\nimport { FeaPanel } from \"@/components/analysis/FeaPanel\";\nimport { getMaterialOptions, type SpringMaterialId } from \"@/lib/materials/springMaterials\";\nimport type { SpringGeometry as EngineSpringGeometry, WorkingConditions } from \"@/lib/engine/types\";\nimport {\n  createReportData,\n  printReport,\n  downloadReportHTML,\n} from \"@/lib/reports/SpringReportGenerator\";\nimport { SpringAnalysisEngine } from \"@/lib/engine/SpringAnalysisEngine\";\nimport { useSpringSimulationStore } from \"@/lib/stores/springSimulationStore\";\nimport { useSpringAnalysisStore } from \"@/lib/stores/springAnalysisStore\";\nimport {\n  useSpringDesignStore,\n  type SpringGeometry as StoreSpringGeometry,\n  type MaterialInfo,\n  type AnalysisResult,\n} from \"@/lib/stores/springDesignStore\";\nimport { convertStoreGeometryToEngine } from \"@/lib/engine/geometryAdapters\";\nimport { EXTENSION_HOOK_LABELS, type ExtensionHookType, type SpringType } from \"@/lib/springTypes\";\nimport Link from \"next/link\";\nimport { Brain } from \"lucide-react\";\nimport { SpiralTorsionAnalysisPanel } from \"@/components/analysis/SpiralTorsionAnalysisPanel\";\nimport { isSpiralTorsionDesign } from \"@/lib/stores/springDesignStore\";\n\n// Dynamic imports for 3D visualizers\nconst CompressionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/CompressionSpringVisualizer\").then(mod => mod.CompressionSpringVisualizer),\n  { ssr: false, loading: () => <div className=\"h-full w-full flex items-center justify-center bg-slate-900 text-slate-400 text-sm\">Loading 3D...</div> }\n);\n\nconst ConicalSpringVisualizer = dynamic(\n  () => import(\"@/components/three/ConicalSpringVisualizer\").then(mod => mod.ConicalSpringVisualizer),\n  { ssr: false, loading: () => <div className=\"h-full w-full flex items-center justify-center bg-slate-900 text-slate-400 text-sm\">Loading 3D...</div> }\n);\n\nconst ExtensionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/ExtensionSpringVisualizer\").then(mod => mod.ExtensionSpringVisualizer),\n  { ssr: false, loading: () => <div className=\"h-full w-full flex items-center justify-center bg-slate-900 text-slate-400 text-sm\">Loading 3D...</div> }\n);\n\nconst TorsionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/TorsionSpringVisualizer\").then(mod => mod.TorsionSpringVisualizer),\n  { ssr: false, loading: () => <div className=\"h-full w-full flex items-center justify-center bg-slate-900 text-slate-400 text-sm\">Loading 3D...</div> }\n);\n\nexport default function AnalysisPageContent() {\n  return (\n    <Suspense fallback={<div className=\"p-8 text-center text-muted-foreground\">Loading...</div>}>\n      <AnalysisContent />\n    </Suspense>\n  );\n}\n\nfunction AnalysisContent() {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n  const materialOptions = getMaterialOptions();\n  const designGeometry = useSpringDesignStore(state => state.geometry);\n  const designMaterial = useSpringDesignStore(state => state.material);\n  const designAnalysis = useSpringDesignStore(state => state.analysisResult);\n\n  if (!designGeometry || !designMaterial || !designAnalysis) {\n    return (\n      <main className=\"container mx-auto py-8 px-4\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-2xl font-bold mb-2\">\n            {isZh ? \"弹簧工程分析\" : \"Spring Engineering Analysis\"}\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {isZh\n              ? \"请先在计算器中完成设计并保存到全局 store，再返回此处进行工程分析。\"\n              : \"Please finish your design in the Calculator (which saves into the global store) before running engineering analysis here.\"}\n          </p>\n        </div>\n\n        <Card className=\"max-w-xl\">\n          <CardHeader>\n            <CardTitle>{isZh ? \"未检测到设计数据\" : \"No Design Detected\"}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4 text-sm text-muted-foreground\">\n            <p>\n              {isZh\n                ? \"当前没有有效的弹簧设计记录。请先在“弹簧计算器”输入参数并点击计算，系统会把结果保存到全局 store。\"\n                : \"No valid spring design is stored. Open the Calculator, enter your parameters and calculate—the system will save everything into the global store.\"}\n            </p>\n            <Button asChild variant=\"default\">\n              <a href=\"/tools/calculator\">{isZh ? \"前往弹簧计算器\" : \"Go to Calculator\"}</a>\n            </Button>\n          </CardContent>\n        </Card>\n      </main>\n    );\n  }\n\n  // ⚠️ 螺旋扭转弹簧使用独立的分析面板，不与 wire spring 混用\n  // 这是显式分支，不是 type guard 兼容\n  if (isSpiralTorsionDesign(designGeometry)) {\n    return (\n      <SpiralTorsionAnalysisPanel\n        isZh={isZh}\n        geometry={designGeometry}\n        material={designMaterial}\n        analysisResult={designAnalysis}\n      />\n    );\n  }\n\n  // Wire spring (compression/extension/torsion/conical) 使用原有分析面板\n  return (\n    <AnalysisReady\n      isZh={isZh}\n      materialOptions={materialOptions}\n      designGeometry={designGeometry}\n      designMaterial={designMaterial}\n      designAnalysis={designAnalysis}\n    />\n  );\n}\n\ninterface AnalysisReadyProps {\n  isZh: boolean;\n  materialOptions: ReturnType<typeof getMaterialOptions>;\n  designGeometry: StoreSpringGeometry;\n  designMaterial: MaterialInfo;\n  designAnalysis: AnalysisResult;\n}\n\nfunction AnalysisReady({\n  isZh,\n  materialOptions,\n  designGeometry,\n  designMaterial,\n  designAnalysis,\n}: AnalysisReadyProps) {\n  // ⚠️ 注意：spiralTorsion 已在上层被拦截，此函数只处理 wire spring\n  // 不要在这里添加 spiralTorsion 的兼容代码\n  if (designGeometry.type === \"spiralTorsion\") {\n    throw new Error(\"spiralTorsion should be handled by SpiralTorsionAnalysisPanel\");\n  }\n  \n  const springType = designGeometry.type;\n  const materialId = designMaterial.id;\n  \n  // Wire spring 专用字段 - 不包含 spiralTorsion\n  const wireDiameter = designGeometry.wireDiameter;\n  const activeCoils = designGeometry.activeCoils;\n  const shearModulus = designGeometry.shearModulus ?? designMaterial.shearModulus;\n  const elasticModulus = designMaterial.elasticModulus ?? shearModulus * 2.5;\n\n  let meanDiameter: number | undefined;\n  let freeLength: number | undefined;\n  let bodyLength: number | undefined;\n  let initialTension: number | undefined;\n  let hookType: ExtensionHookType | undefined;\n  let outerDiameter: number | undefined;\n  let largeOD: number | undefined;\n  let smallOD: number | undefined;\n  let conicalFreeLength: number | undefined;\n  let torsionBodyLength: number | undefined;\n  let legLength1: number | undefined;\n  let legLength2: number | undefined;\n\n  switch (designGeometry.type) {\n    case \"compression\":\n      meanDiameter = designGeometry.meanDiameter;\n      freeLength = designGeometry.freeLength;\n      break;\n    case \"extension\":\n      meanDiameter =\n        designGeometry.meanDiameter ??\n        (designGeometry.outerDiameter - designGeometry.wireDiameter);\n      outerDiameter = designGeometry.outerDiameter;\n      bodyLength = designGeometry.bodyLength;\n      initialTension = designGeometry.initialTension ?? designAnalysis.initialTension ?? 0;\n      hookType = designGeometry.hookType ?? \"machine\";\n      break;\n    case \"torsion\":\n      meanDiameter = designGeometry.meanDiameter;\n      torsionBodyLength =\n        designGeometry.bodyLength ?? designGeometry.activeCoils * designGeometry.wireDiameter;\n      bodyLength = torsionBodyLength;\n      legLength1 = designGeometry.legLength1;\n      legLength2 = designGeometry.legLength2;\n      break;\n    case \"conical\":\n      largeOD = designGeometry.largeOuterDiameter;\n      smallOD = designGeometry.smallOuterDiameter;\n      conicalFreeLength = designGeometry.freeLength;\n      freeLength = conicalFreeLength;\n      break;\n    // ⚠️ spiralTorsion 已在上层被拦截，不会到达这里\n    // 不要添加 spiralTorsion case\n  }\n\n  const minDeflection = 0;\n  const maxDeflection = designAnalysis.maxDeflection ?? designAnalysis.workingDeflection ?? 0;\n  const torsionFreeAngle =\n    springType === \"torsion\"\n      ? designGeometry.freeAngle ?? designGeometry.workingAngle ?? 0\n      : 0;\n  const torsionWindingDirection =\n    springType === \"torsion\" ? designGeometry.windingDirection ?? \"right\" : \"right\";\n\n  const workingConditions: WorkingConditions = useMemo(\n    () => ({\n      minDeflection,\n      maxDeflection,\n    }),\n    [minDeflection, maxDeflection]\n  );\n\n  const engineGeometry = useMemo(\n    () => convertStoreGeometryToEngine(designGeometry, materialId),\n    [designGeometry, materialId]\n  );\n\n  const analysisResult = useMemo(() => {\n    try {\n      return SpringAnalysisEngine.analyze(engineGeometry, workingConditions);\n    } catch {\n      return null;\n    }\n  }, [engineGeometry, workingConditions]);\n\n  const { initializeCompression, initializeConical, initializeExtension, initializeTorsion } =\n    useSpringSimulationStore();\n\n  const {\n    setGeometry: setAnalysisGeometry,\n    setWorkingConditions,\n    setMaterialId: setGlobalMaterialId,\n    setAnalysisResult,\n  } = useSpringAnalysisStore();\n\n  useEffect(() => {\n    if (!analysisResult) return;\n    setAnalysisGeometry(engineGeometry);\n    setWorkingConditions(workingConditions);\n    setGlobalMaterialId(materialId);\n    setAnalysisResult(analysisResult);\n  }, [\n    analysisResult,\n    engineGeometry,\n    materialId,\n    setAnalysisGeometry,\n    setWorkingConditions,\n    setGlobalMaterialId,\n    setAnalysisResult,\n    workingConditions,\n  ]);\n\n  useEffect(() => {\n    if (!analysisResult) return;\n\n    if (springType === \"compression\" && meanDiameter && freeLength !== undefined) {\n      const springRate =\n        (shearModulus * Math.pow(wireDiameter, 4)) /\n        (8 * Math.pow(meanDiameter, 3) * activeCoils);\n      const curve = analysisResult.forceCurve.map(p => ({\n        deflection: p.deflection,\n        load: p.force,\n      }));\n      initializeCompression(\n        curve,\n        {\n          type: \"compression\",\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          freeLength,\n          shearModulus,\n          springRate,\n        },\n        maxDeflection\n      );\n    } else if (\n      springType === \"extension\" &&\n      meanDiameter &&\n      outerDiameter &&\n      bodyLength !== undefined\n    ) {\n      const springRate =\n        (shearModulus * Math.pow(wireDiameter, 4)) /\n        (8 * Math.pow(meanDiameter, 3) * activeCoils);\n      const curve = analysisResult.forceCurve.map(p => ({\n        deflection: p.deflection,\n        load: p.force,\n      }));\n      const effectiveHookType: ExtensionHookType = hookType ?? \"machine\";\n      initializeExtension(\n        curve,\n        {\n          type: \"extension\",\n          wireDiameter,\n          outerDiameter,\n          activeCoils,\n          bodyLength,\n          freeLengthInsideHooks: bodyLength,\n          initialTension: initialTension ?? 0,\n          shearModulus,\n          springRate,\n          hookType: effectiveHookType,\n        },\n        maxDeflection\n      );\n    } else if (\n      springType === \"conical\" &&\n      largeOD !== undefined &&\n      smallOD !== undefined &&\n      conicalFreeLength !== undefined\n    ) {\n      const curve = analysisResult.forceCurve.map(p => ({\n        x: p.deflection,\n        deflection: p.deflection,\n        load: p.force,\n        k: p.stiffness ?? 10,\n        activeCoils: p.activeCoils ?? activeCoils,\n        collapsedCoils: p.collapsedCoils ?? 0,\n        stiffness: p.stiffness ?? 10,\n      }));\n      initializeConical(\n        curve,\n        {\n          type: \"conical\",\n          wireDiameter,\n          largeOuterDiameter: largeOD,\n          smallOuterDiameter: smallOD,\n          activeCoils,\n          freeLength: conicalFreeLength,\n          solidHeight: (activeCoils + 2) * wireDiameter,\n          totalDeflectionCapacity: conicalFreeLength - (activeCoils + 2) * wireDiameter,\n        },\n        maxDeflection\n      );\n    } else if (\n      springType === \"torsion\" &&\n      meanDiameter &&\n      torsionBodyLength !== undefined &&\n      legLength1 !== undefined &&\n      legLength2 !== undefined\n    ) {\n      const springRate =\n        ((elasticModulus * Math.pow(wireDiameter, 4)) /\n          (64 * meanDiameter * activeCoils)) *\n        (Math.PI / 180);\n      const curve = analysisResult.forceCurve.map(p => ({\n        deflection: p.deflection,\n        load: p.force,\n      }));\n      const pitch = torsionBodyLength / activeCoils;\n      initializeTorsion(\n        curve,\n        {\n          type: \"torsion\",\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          bodyLength: torsionBodyLength,\n          pitch: pitch > wireDiameter ? pitch : wireDiameter,\n          legLength1,\n          legLength2,\n          freeAngle: torsionFreeAngle,\n          shearModulus,\n          springRate,\n          windingDirection: torsionWindingDirection,\n        },\n        maxDeflection\n      );\n    }\n  }, [\n    activeCoils,\n    analysisResult,\n    bodyLength,\n    conicalFreeLength,\n    elasticModulus,\n    hookType,\n    initializeCompression,\n    initializeConical,\n    initializeExtension,\n    initializeTorsion,\n    initialTension,\n    largeOD,\n    legLength1,\n    legLength2,\n    maxDeflection,\n    meanDiameter,\n    outerDiameter,\n    shearModulus,\n    smallOD,\n    springType,\n    torsionBodyLength,\n    torsionFreeAngle,\n    torsionWindingDirection,\n    wireDiameter,\n  ]);\n\n  if (!analysisResult) {\n    return (\n      <main className=\"container mx-auto py-8 px-4\">\n        <div className=\"space-y-2\">\n          <h1 className=\"text-2xl font-bold\">\n            {isZh ? \"分析失败\" : \"Analysis Unavailable\"}\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {isZh\n              ? \"我们无法根据当前设计生成工程分析，请返回计算器重新计算。\"\n              : \"We couldn’t generate an analysis for the current design. Please return to the Calculator and run the calculation again.\"}\n          </p>\n        </div>\n        <Button asChild className=\"mt-6\">\n          <Link href=\"/tools/calculator\">{isZh ? \"返回计算器\" : \"Back to Calculator\"}</Link>\n        </Button>\n      </main>\n    );\n  }\n\n  const handleExportPDF = () => {\n    try {\n      const results = SpringAnalysisEngine.analyze(engineGeometry, workingConditions);\n      const reportData = createReportData(engineGeometry, workingConditions, results, {\n        language: isZh ? \"zh\" : \"en\",\n      });\n      printReport(reportData);\n    } catch (error) {\n      console.error(\"Export error:\", error);\n    }\n  };\n\n  const handleDownloadHTML = () => {\n    try {\n      const results = SpringAnalysisEngine.analyze(engineGeometry, workingConditions);\n      const reportData = createReportData(engineGeometry, workingConditions, results, {\n        language: \"bilingual\",\n      });\n      downloadReportHTML(reportData);\n    } catch (error) {\n      console.error(\"Download error:\", error);\n    }\n  };\n\n  const getVisualizer = () => {\n    switch (springType) {\n      case \"compression\":\n        return <CompressionSpringVisualizer />;\n      case \"conical\":\n        return <ConicalSpringVisualizer />;\n      case \"extension\":\n        return <ExtensionSpringVisualizer />;\n      case \"torsion\":\n        return <TorsionSpringVisualizer />;\n      default:\n        return (\n          <div className=\"h-full w-full flex items-center justify center bg-slate-900 text-slate-400 text-sm\">\n            {isZh ? \"3D 视图开发中\" : \"3D View Coming Soon\"}\n          </div>\n        );\n    }\n  };\n\n  const safeHookType = hookType ?? \"machine\";\n  const hookLabel =\n    EXTENSION_HOOK_LABELS[safeHookType]?.[isZh ? \"zh\" : \"en\"] ??\n    (isZh ? \"默认钩型\" : \"Default Hook\");\n  const displayFreeLength =\n    springType === \"compression\"\n      ? freeLength ?? 0\n      : springType === \"conical\"\n      ? conicalFreeLength ?? 0\n      : 50;\n  const estimatedSpringRate =\n    analysisResult && meanDiameter\n      ? (shearModulus * Math.pow(wireDiameter, 4)) /\n        (8 * Math.pow(meanDiameter, 3) * activeCoils)\n      : 10;\n\n  return (\n    <main className=\"container mx\tauto py-8 px-4\">\n      <div className=\"mb-8 flex items-start justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold mb-2\">\n            {isZh ? \"弹簧工程分析\" : \"Spring Engineering Analysis\"}\n          </h1>\n          <p className=\"text-muted-foreground\">\n            {isZh\n              ? \"完整的弹簧应力、疲劳、安全系数和屈曲分析\"\n              : \"Complete stress, fatigue, safety factor, and buckling analysis\"}\n          </p>\n        </div>\n        <Link href=\"/tools/advanced-analysis\">\n          <Button variant=\"outline\" className=\"gap-2\">\n            <Brain className=\"h-4 w-4\" />\n            {isZh ? \"高级分析\" : \"Advanced Analysis\"}\n          </Button>\n        </Link>\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-[350px,1fr]\">\n        {/* Input Panel - Read Only */}\n        <div className=\"space-y-4\">\n          {/* Spring Type - Read Only */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"弹簧类型\" : \"Spring Type\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"px-3 py-2 bg-slate-100 rounded-md text-sm font-medium\">\n                {springType === \"compression\" && (isZh ? \"压缩弹簧\" : \"Compression Spring\")}\n                {springType === \"extension\" && (isZh ? \"拉伸弹簧\" : \"Extension Spring\")}\n                {springType === \"torsion\" && (isZh ? \"扭转弹簧\" : \"Torsion Spring\")}\n                {springType === \"conical\" && (isZh ? \"锥形弹簧\" : \"Conical Spring\")}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Material - Read Only */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"材料\" : \"Material\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"px-3 py-2 bg-slate-100 rounded-md text-sm font-medium\">\n                {materialOptions.find(opt => opt.value === materialId)?.[isZh ? \"labelZh\" : \"labelEn\"] || materialId}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Geometry Parameters - Read Only */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"几何参数\" : \"Geometry\"}\n              </CardTitle>\n              <p className=\"text-xs text-muted-foreground\">\n                {isZh ? \"（从计算器传入，只读）\" : \"(From Calculator, Read-Only)\"}\n              </p>\n            </CardHeader>\n            <CardContent className=\"space-y-2 text-sm\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">d (mm):</span>\n                <span className=\"font-medium\">{wireDiameter}</span>\n              </div>\n              {springType !== \"conical\" ? (\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Dm (mm):</span>\n                  <span className=\"font-medium\">{meanDiameter ?? \"--\"}</span>\n                </div>\n              ) : (\n                <>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">D1 (mm):</span>\n                    <span className=\"font-medium\">{largeOD}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">D2 (mm):</span>\n                    <span className=\"font-medium\">{smallOD}</span>\n                  </div>\n                </>\n              )}\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">Na:</span>\n                <span className=\"font-medium\">{activeCoils}</span>\n              </div>\n\n              {/* Type-specific parameters */}\n              {springType === \"compression\" && (\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">L0 (mm):</span>\n                  <span className=\"font-medium\">{freeLength}</span>\n                </div>\n              )}\n\n              {springType === \"extension\" && (\n                <>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Lb (mm):</span>\n                    <span className=\"font-medium\">{bodyLength}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Fi (N):</span>\n                    <span className=\"font-medium\">{initialTension}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">{isZh ? \"钩型\" : \"Hook Type\"}:</span>\n                    <span className=\"font-medium\">{hookLabel}</span>\n                  </div>\n                </>\n              )}\n\n              {springType === \"torsion\" && (\n                <>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Lb (mm):</span>\n                    <span className=\"font-medium\">{torsionBodyLength}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">L1 (mm):</span>\n                    <span className=\"font-medium\">{legLength1}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">L2 (mm):</span>\n                    <span className=\"font-medium\">{legLength2}</span>\n                  </div>\n                </>\n              )}\n\n              {springType === \"conical\" && (\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">L0 (mm):</span>\n                  <span className=\"font-medium\">{conicalFreeLength}</span>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Working Conditions - Read Only */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"工作条件\" : \"Working Conditions\"}\n              </CardTitle>\n              <p className=\"text-xs text-muted-foreground\">\n                {isZh ? \"（从计算器传入，只读）\" : \"(From Calculator, Read-Only)\"}\n              </p>\n            </CardHeader>\n            <CardContent className=\"space-y-2 text-sm\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">\n                  {springType === \"torsion\" ? \"θ_min (°):\" : \"Δx_min (mm):\"}\n                </span>\n                <span className=\"font-medium\">{minDeflection}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">\n                  {springType === \"torsion\" ? \"θ_max (°):\" : \"Δx_max (mm):\"}\n                </span>\n                <span className=\"font-medium\">{maxDeflection}</span>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Export Buttons */}\n          <Card>\n            <CardContent className=\"pt-4 space-y-2\">\n              <Button className=\"w-full\" onClick={handleExportPDF}>\n                {isZh ? \"打印 PDF 报告\" : \"Print PDF Report\"}\n              </Button>\n              <Button variant=\"outline\" className=\"w-full\" onClick={handleDownloadHTML}>\n                {isZh ? \"下载 HTML 报告\" : \"Download HTML Report\"}\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* FEA Analysis Panel */}\n          <FeaPanel />\n        </div>\n\n        {/* Force Tester Panel */}\n        <UnifiedForceTester\n          geometry={engineGeometry}\n          workingConditions={workingConditions}\n          visualizer={getVisualizer()}\n          onExportPDF={handleExportPDF}\n        />\n      </div>\n\n      {/* Advanced Analysis Panel */}\n      {analysisResult && (\n        <div className=\"mt-6 space-y-6\">\n          {/* Type-Specific Analysis Panel */}\n          <SpringTypeSpecificPanel\n            geometry={engineGeometry}\n            analysisResult={analysisResult}\n            springRate={analysisResult.geometry.springIndex > 0 ? estimatedSpringRate : 10}\n            maxForce={estimatedSpringRate * maxDeflection}\n          />\n          \n          <AdvancedAnalysisPanel\n            geometry={engineGeometry}\n            analysisResult={analysisResult}\n            springRate={analysisResult.geometry.springIndex > 0 ? estimatedSpringRate : 10}\n            maxStress={analysisResult.stress.tauEffective}\n            freeLength={displayFreeLength}\n          />\n          \n          {/* Smart Diagnostics & Optimization Panel */}\n          <SmartAnalysisPanel\n            geometry={engineGeometry}\n            analysisResult={analysisResult}\n            workingConditions={workingConditions}\n            springRate={analysisResult.geometry.springIndex > 0 ? estimatedSpringRate : 10}\n            currentDeflection={maxDeflection}\n          />\n          \n          {/* Advanced Simulation Panel (Phase 5) */}\n          <AdvancedSimulationPanel\n            geometry={engineGeometry}\n            springRate={analysisResult.geometry.springIndex > 0 ? estimatedSpringRate : 10}\n            maxStress={analysisResult.stress.tauEffective}\n            naturalFrequency={50}\n            workingConditions={workingConditions}\n          />\n        </div>\n      )}\n    </main>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/AnalysisResultPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/FeaColorLegend.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FeaColorMode' is defined but never used.","line":5,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useMemo } from \"react\";\nimport { useFeaStore } from \"@/lib/stores/feaStore\";\nimport { getFeaMinMax, type FeaColorMode } from \"@/lib/fea/feaTypes\";\n\ninterface FeaColorLegendProps {\n  allowableStress?: number;\n  className?: string;\n}\n\n/**\n * Vertical color legend for FEA visualization\n * Shows the color scale with min/max values and units\n */\nexport function FeaColorLegend({ allowableStress, className }: FeaColorLegendProps) {\n  const feaResult = useFeaStore((s) => s.feaResult);\n  const colorMode = useFeaStore((s) => s.colorMode);\n\n  const isFeaMode = colorMode !== \"formula\" && feaResult !== null;\n\n  const { min, max, title, unit } = useMemo(() => {\n    if (!feaResult || colorMode === \"formula\") {\n      return { min: 0, max: 0, title: \"\", unit: \"\" };\n    }\n\n    const { min: minVal, max: maxVal } = getFeaMinMax(\n      feaResult.nodes,\n      colorMode,\n      allowableStress\n    );\n\n    let title = \"\";\n    let unit = \"\";\n    switch (colorMode) {\n      case \"fea_sigma\":\n        title = \"FEA σ_vm\";\n        unit = \"MPa\";\n        break;\n      case \"fea_disp\":\n        title = \"FEA |u|\";\n        unit = \"mm\";\n        break;\n      case \"fea_sf\":\n        title = \"安全系数\";\n        unit = \"\";\n        break;\n    }\n\n    return { min: minVal, max: maxVal, title, unit };\n  }, [feaResult, colorMode, allowableStress]);\n\n  if (!isFeaMode) {\n    return null;\n  }\n\n  return (\n    <div className={`flex flex-col items-center gap-1 ${className || \"\"}`}>\n      {/* Title */}\n      <div className=\"text-xs font-medium text-muted-foreground whitespace-nowrap\">\n        {title} {unit && `(${unit})`}\n      </div>\n\n      {/* Max value */}\n      <div className=\"text-xs font-mono text-red-500\">\n        {max.toFixed(1)}\n      </div>\n\n      {/* Gradient bar */}\n      <div\n        className=\"w-4 h-32 rounded-sm border border-border\"\n        style={{\n          background: \"linear-gradient(to bottom, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff)\",\n        }}\n      />\n\n      {/* Min value */}\n      <div className=\"text-xs font-mono text-blue-500\">\n        {min.toFixed(1)}\n      </div>\n\n      {/* Allowable stress marker (optional) */}\n      {colorMode === \"fea_sigma\" && allowableStress && (\n        <div className=\"mt-2 text-xs text-muted-foreground\">\n          <span className=\"text-yellow-500\">—</span> σ_allow: {allowableStress.toFixed(0)}\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/FeaPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Info' is defined but never used.","line":19,"column":47,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useSpringDesignStore } from \"@/lib/stores/springDesignStore\";\nimport { useFeaStore } from \"@/lib/stores/feaStore\";\nimport { useLanguage } from \"@/components/language-context\";\nimport { Loader2, AlertTriangle, CheckCircle, Info } from \"lucide-react\";\nimport type { FEAResult, FeaColorMode } from \"@/lib/fea/feaTypes\";\nimport { cn } from \"@/lib/utils\";\n\nexport type { FEAResult, FeaColorMode };\n\ninterface FormulaComparison {\n  sigmaFormula: number;\n  sigmaFea: number;\n  errorPercent: number;\n  status: \"good\" | \"warning\" | \"error\";\n}\n\nexport function FeaPanel() {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  const springType = useSpringDesignStore((s) => s.springType);\n  const geometry = useSpringDesignStore((s) => s.geometry);\n  const material = useSpringDesignStore((s) => s.material);\n\n  // FEA store state\n  const feaResult = useFeaStore((s) => s.feaResult);\n  const colorMode = useFeaStore((s) => s.colorMode);\n  const isLoading = useFeaStore((s) => s.isLoading);\n  const error = useFeaStore((s) => s.error);\n  const setFeaResult = useFeaStore((s) => s.setFeaResult);\n  const setColorMode = useFeaStore((s) => s.setColorMode);\n  const setLoading = useFeaStore((s) => s.setLoading);\n  const setError = useFeaStore((s) => s.setError);\n\n  // Local state for load inputs\n  const [loadValue, setLoadValue] = useState(100);\n  const [leverArm, setLeverArm] = useState(20);\n\n  const runFea = async () => {\n    if (!springType || !geometry) {\n      setError(isZh ? \"缺少弹簧设计数据\" : \"Missing spring design data\");\n      return;\n    }\n\n    setLoading(true);\n    setError(null);\n\n    try {\n      const res = await fetch(\"/api/fea/run\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          springType,\n          geometry,\n          loadCase: {\n            springType,\n            loadValue,\n            leverArm: springType === \"torsion\" ? leverArm : undefined,\n          },\n        }),\n      });\n\n      const json = await res.json();\n\n      if (!json.ok) {\n        throw new Error(json.error || (isZh ? \"FEA 调用失败\" : \"FEA call failed\"));\n      }\n\n      const result = json.result as FEAResult;\n      setFeaResult(result);\n      // Auto-switch to FEA σ_vm mode so user immediately sees stress colors\n      setColorMode(\"fea_sigma\");\n    } catch (e: unknown) {\n      const message = e instanceof Error ? e.message : String(e);\n      setError(message);\n      setFeaResult(null);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleColorModeChange = (mode: FeaColorMode) => {\n    setColorMode(mode);\n  };\n\n  const loadUnit = springType === \"torsion\" ? \"N\" : \"N\";\n\n  // Calculate engineering formula stress for comparison\n  const formulaComparison = useMemo((): FormulaComparison | null => {\n    if (!feaResult || !geometry || !springType) return null;\n\n    // Simple engineering formula approximations\n    let sigmaFormula = 0;\n    const geom = geometry as unknown as Record<string, number>;\n    const d = geom.wireDiameter || 1.6;\n    const D = geom.meanDiameter || (geom.outerDiameter || 12) - d;\n    const C = D / d; // Spring index\n\n    // Wahl correction factor (with safety check for C > 1)\n    const Kw = C > 1 ? (4 * C - 1) / (4 * C - 4) + 0.615 / C : 1.0;\n\n    switch (springType) {\n      case \"compression\":\n      case \"extension\":\n        // τ = 8 * F * D * Kw / (π * d³)\n        sigmaFormula = (8 * loadValue * D * Kw) / (Math.PI * Math.pow(d, 3));\n        break;\n      case \"torsion\":\n        // Torsion spring bending stress with inner stress correction factor Ki\n        // σ = Ki * 32 * M / (π * d³) where M = F * leverArm\n        // Ki = (4C² - C - 1) / (4C * (C - 1)) for inner fiber (simplified)\n        // For typical C values, Ki ≈ 1.0 to 1.2\n        const Ki = C > 1 ? (4 * C * C - C - 1) / (4 * C * (C - 1)) : 1.0;\n        const M = loadValue * leverArm;\n        sigmaFormula = (Ki * 32 * M) / (Math.PI * Math.pow(d, 3));\n        break;\n      case \"conical\":\n        // Use large end diameter for max stress (same as Python FEA)\n        const D1Conical = (geom.largeOuterDiameter || geom.outerDiameter || 20) - d;\n        const C1 = D1Conical / d;\n        const KwConical = C1 > 1 ? (4 * C1 - 1) / (4 * C1 - 4) + 0.615 / C1 : 1.0;\n        sigmaFormula = (8 * loadValue * D1Conical * KwConical) / (Math.PI * Math.pow(d, 3));\n        break;\n    }\n\n    const sigmaFea = feaResult.maxSigma;\n    const errorPercent = sigmaFormula > 0 \n      ? ((sigmaFea - sigmaFormula) / sigmaFormula) * 100 \n      : 0;\n\n    let status: \"good\" | \"warning\" | \"error\" = \"good\";\n    if (Math.abs(errorPercent) > 20) status = \"error\";\n    else if (Math.abs(errorPercent) > 10) status = \"warning\";\n\n    return { sigmaFormula, sigmaFea, errorPercent, status };\n  }, [feaResult, geometry, springType, loadValue, leverArm]);\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-base\">\n          {isZh ? \"FEA 精确分析 (CalculiX Beam Model)\" : \"FEA Analysis (CalculiX Beam Model)\"}\n        </CardTitle>\n        {material && (\n          <p className=\"text-xs text-muted-foreground\">\n            {isZh ? \"材料\" : \"Material\"}: {material.name ?? \"-\"},{\" \"}\n            {isZh ? \"抗拉强度\" : \"Tensile Strength\"}:{\" \"}\n            {material.tensileStrength ?? \"-\"} MPa\n          </p>\n        )}\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {/* Load inputs */}\n        <div className=\"grid grid-cols-2 gap-3\">\n          <div className=\"space-y-1\">\n            <Label className=\"text-xs\">\n              {isZh ? `载荷大小 (${loadUnit})` : `Load Value (${loadUnit})`}\n            </Label>\n            <Input\n              type=\"number\"\n              value={loadValue}\n              onChange={(e) => setLoadValue(Number(e.target.value))}\n              className=\"h-8 text-sm\"\n            />\n          </div>\n\n          {springType === \"torsion\" && (\n            <div className=\"space-y-1\">\n              <Label className=\"text-xs\">\n                {isZh ? \"杆臂长度 (mm)\" : \"Lever Arm (mm)\"}\n              </Label>\n              <Input\n                type=\"number\"\n                value={leverArm}\n                onChange={(e) => setLeverArm(Number(e.target.value))}\n                className=\"h-8 text-sm\"\n              />\n            </div>\n          )}\n        </div>\n\n        {/* Run button */}\n        <Button\n          onClick={runFea}\n          disabled={isLoading}\n          className=\"w-full\"\n          size=\"sm\"\n        >\n          {isLoading ? (\n            <>\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              {isZh ? \"正在调用 CalculiX…\" : \"Running CalculiX…\"}\n            </>\n          ) : (\n            isZh ? \"运行 FEA 精确分析\" : \"Run FEA Analysis\"\n          )}\n        </Button>\n\n        {/* Error display */}\n        {error && (\n          <p className=\"text-sm text-destructive\">\n            {isZh ? \"FEA 出错\" : \"FEA Error\"}: {error}\n          </p>\n        )}\n\n        {/* Results display */}\n        {feaResult && (\n          <div className=\"space-y-3 pt-2 border-t\">\n            {/* Key results summary - 2x2 grid */}\n            <div className=\"grid grid-cols-2 gap-2 text-sm\">\n              <div className=\"p-2 rounded bg-muted/50\">\n                <div className=\"text-xs text-muted-foreground\">σ_vm,max</div>\n                <div className=\"font-mono font-medium text-red-500\">\n                  {feaResult.maxSigma.toFixed(1)} <span className=\"text-xs text-muted-foreground\">MPa</span>\n                </div>\n              </div>\n              <div className=\"p-2 rounded bg-muted/50\">\n                <div className=\"text-xs text-muted-foreground\">u_max</div>\n                <div className=\"font-mono font-medium text-blue-500\">\n                  {feaResult.maxDisplacement.toFixed(3)} <span className=\"text-xs text-muted-foreground\">mm</span>\n                </div>\n              </div>\n              <div className=\"p-2 rounded bg-muted/50\">\n                <div className=\"text-xs text-muted-foreground\">{isZh ? \"安全系数\" : \"Safety Factor\"}</div>\n                <div className={cn(\n                  \"font-mono font-medium\",\n                  feaResult.safetyFactor != null && feaResult.safetyFactor >= 1.5 ? \"text-green-500\" :\n                  feaResult.safetyFactor != null && feaResult.safetyFactor >= 1.0 ? \"text-yellow-500\" : \"text-red-500\"\n                )}>\n                  {feaResult.safetyFactor != null ? feaResult.safetyFactor.toFixed(2) : \"-\"}\n                </div>\n              </div>\n              <div className=\"p-2 rounded bg-muted/50\">\n                <div className=\"text-xs text-muted-foreground\">{isZh ? \"节点数\" : \"Nodes\"}</div>\n                <div className=\"font-mono font-medium\">\n                  {feaResult.nodes.length}\n                </div>\n              </div>\n            </div>\n\n            {/* Formula comparison */}\n            {formulaComparison && (\n              <div className={cn(\n                \"p-2 rounded border text-xs\",\n                formulaComparison.status === \"good\" && \"border-green-500/30 bg-green-500/5\",\n                formulaComparison.status === \"warning\" && \"border-yellow-500/30 bg-yellow-500/5\",\n                formulaComparison.status === \"error\" && \"border-red-500/30 bg-red-500/5\"\n              )}>\n                <div className=\"flex items-center gap-2 mb-1\">\n                  {formulaComparison.status === \"good\" && <CheckCircle className=\"h-3 w-3 text-green-500\" />}\n                  {formulaComparison.status === \"warning\" && <AlertTriangle className=\"h-3 w-3 text-yellow-500\" />}\n                  {formulaComparison.status === \"error\" && <AlertTriangle className=\"h-3 w-3 text-red-500\" />}\n                  <span className=\"font-medium\">{isZh ? \"工程公式对比\" : \"Formula Comparison\"}</span>\n                </div>\n                <div className=\"grid grid-cols-3 gap-2 text-muted-foreground\">\n                  <div>\n                    <span>σ_formula:</span>\n                    <span className=\"ml-1 font-mono\">{formulaComparison.sigmaFormula.toFixed(1)}</span>\n                  </div>\n                  <div>\n                    <span>σ_FEA:</span>\n                    <span className=\"ml-1 font-mono\">{formulaComparison.sigmaFea.toFixed(1)}</span>\n                  </div>\n                  <div>\n                    <span>{isZh ? \"误差\" : \"Error\"}:</span>\n                    <Badge variant=\"outline\" className={cn(\n                      \"ml-1 text-xs\",\n                      formulaComparison.status === \"good\" && \"text-green-500\",\n                      formulaComparison.status === \"warning\" && \"text-yellow-500\",\n                      formulaComparison.status === \"error\" && \"text-red-500\"\n                    )}>\n                      {formulaComparison.errorPercent >= 0 ? \"+\" : \"\"}{formulaComparison.errorPercent.toFixed(1)}%\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Color mode selector */}\n            <div className=\"flex items-center gap-2\">\n              <Label className=\"text-xs whitespace-nowrap\">\n                {isZh ? \"颜色模式\" : \"Color Mode\"}:\n              </Label>\n              <Select value={colorMode} onValueChange={handleColorModeChange}>\n                <SelectTrigger className=\"h-7 text-xs flex-1\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"formula\">\n                    {isZh ? \"工程公式近似\" : \"Engineering Formula\"}\n                  </SelectItem>\n                  <SelectItem value=\"fea_sigma\">FEA σ_vm</SelectItem>\n                  <SelectItem value=\"fea_disp\">\n                    {isZh ? \"FEA 位移\" : \"FEA Displacement\"}\n                  </SelectItem>\n                  <SelectItem value=\"fea_sf\">\n                    {isZh ? \"安全系数\" : \"Safety Factor\"}\n                  </SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Color legend */}\n            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n              <div\n                className=\"h-3 flex-1 rounded\"\n                style={{\n                  background: \"linear-gradient(to right, #0000ff, #00ffff, #00ff00, #ffff00, #ff0000)\",\n                }}\n              />\n              <span className=\"font-mono whitespace-nowrap\">\n                {colorMode === \"fea_sigma\" && `0 → ${feaResult.maxSigma.toFixed(0)} MPa`}\n                {colorMode === \"fea_disp\" && `0 → ${feaResult.maxDisplacement.toFixed(2)} mm`}\n                {colorMode === \"fea_sf\" && (feaResult.safetyFactor != null ? `SF: 0 → ${feaResult.safetyFactor.toFixed(1)}` : \"-\")}\n                {colorMode === \"formula\" && (isZh ? \"工程公式\" : \"Formula\")}\n              </span>\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SmartAnalysisPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Slider' is defined but never used.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DAMAGE_THRESHOLDS' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'onDeflectionChange' is defined but never used.","line":62,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":62,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useMemo, useCallback } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Slider } from \"@/components/ui/slider\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useLanguage } from \"@/components/language-context\";\n\nimport type { SpringGeometry, SpringAnalysisResult, WorkingConditions } from \"@/lib/engine/types\";\nimport {\n  calculateStressDistribution,\n  type StressDistributionResult,\n  STRESS_COLOR_THRESHOLDS,\n} from \"@/lib/engine/stressDistribution\";\nimport {\n  calculateFatigueDamage,\n  type FatigueDamageResult,\n  DAMAGE_THRESHOLDS,\n} from \"@/lib/engine/fatigueDamage\";\nimport {\n  diagnoseFailureModes,\n  getFailureModeIcon,\n  type DiagnosticsResult,\n} from \"@/lib/engine/failureDiagnostics\";\nimport {\n  generateDesignSuggestions,\n  type SuggestionsResult,\n} from \"@/lib/engine/designSuggestions\";\nimport {\n  optimizeSpringDesign,\n  DEFAULT_CONSTRAINTS,\n  DEFAULT_WEIGHTS,\n  type DesignTargets,\n  type OptimizationResult,\n} from \"@/lib/engine/optimizer\";\n\ninterface SmartAnalysisPanelProps {\n  geometry: SpringGeometry;\n  analysisResult: SpringAnalysisResult;\n  workingConditions: WorkingConditions;\n  springRate: number;\n  currentDeflection: number;\n  onDeflectionChange?: (deflection: number) => void;\n}\n\nexport function SmartAnalysisPanel({\n  geometry,\n  analysisResult,\n  workingConditions,\n  springRate,\n  currentDeflection,\n  onDeflectionChange,\n}: SmartAnalysisPanelProps) {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  // Optimization inputs\n  const [targetStiffness, setTargetStiffness] = useState<number>(springRate);\n  const [minFatigueLife, setMinFatigueLife] = useState<number>(1e6);\n  const [minSafetyFactor, setMinSafetyFactor] = useState<number>(1.5);\n  const [isOptimizing, setIsOptimizing] = useState(false);\n  const [optimizationResult, setOptimizationResult] = useState<OptimizationResult | null>(null);\n\n  // Calculate current force\n  const currentForce = springRate * currentDeflection;\n\n  // Calculate stress distribution\n  const stressDistribution = useMemo<StressDistributionResult | null>(() => {\n    try {\n      return calculateStressDistribution(geometry, currentForce, currentDeflection, 50);\n    } catch {\n      return null;\n    }\n  }, [geometry, currentForce, currentDeflection]);\n\n  // Calculate fatigue damage\n  const fatigueDamage = useMemo<FatigueDamageResult | null>(() => {\n    if (!stressDistribution) return null;\n    try {\n      const minStress = springRate * workingConditions.minDeflection;\n      const maxStress = springRate * workingConditions.maxDeflection;\n      return calculateFatigueDamage(\n        stressDistribution,\n        geometry.materialId,\n        1e6, // Default 1M cycles\n        minStress,\n        maxStress\n      );\n    } catch {\n      return null;\n    }\n  }, [stressDistribution, geometry.materialId, springRate, workingConditions]);\n\n  // Diagnose failure modes\n  const diagnostics = useMemo<DiagnosticsResult | null>(() => {\n    try {\n      return diagnoseFailureModes(geometry, analysisResult, { fatigueDamage: fatigueDamage ?? undefined });\n    } catch {\n      return null;\n    }\n  }, [geometry, analysisResult, fatigueDamage]);\n\n  // Generate suggestions\n  const suggestions = useMemo<SuggestionsResult | null>(() => {\n    if (!diagnostics) return null;\n    try {\n      return generateDesignSuggestions(geometry, analysisResult, diagnostics);\n    } catch {\n      return null;\n    }\n  }, [geometry, analysisResult, diagnostics]);\n\n  // Run optimization\n  const runOptimization = useCallback(() => {\n    setIsOptimizing(true);\n    \n    // Run in setTimeout to not block UI\n    setTimeout(() => {\n      try {\n        const targets: DesignTargets = {\n          targetStiffness,\n          minFatigueLife,\n          minSafetyFactor,\n        };\n        \n        const result = optimizeSpringDesign(\n          targets,\n          workingConditions,\n          DEFAULT_CONSTRAINTS,\n          DEFAULT_WEIGHTS,\n          { populationSize: 30, generations: 50 }\n        );\n        \n        setOptimizationResult(result);\n      } catch (error) {\n        console.error(\"Optimization error:\", error);\n      } finally {\n        setIsOptimizing(false);\n      }\n    }, 100);\n  }, [targetStiffness, minFatigueLife, minSafetyFactor, workingConditions]);\n\n  return (\n    <Card className=\"w-full\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center justify-between\">\n          <span>{isZh ? \"智能诊断与优化\" : \"Smart Diagnostics & Optimization\"}</span>\n          {diagnostics && (\n            <span\n              className={`rounded-full px-3 py-1 text-sm font-bold ${\n                diagnostics.overallRisk === \"low\"\n                  ? \"bg-green-100 text-green-800\"\n                  : diagnostics.overallRisk === \"medium\"\n                  ? \"bg-yellow-100 text-yellow-800\"\n                  : diagnostics.overallRisk === \"high\"\n                  ? \"bg-orange-100 text-orange-800\"\n                  : \"bg-red-100 text-red-800\"\n              }`}\n            >\n              {diagnostics.overallRisk.toUpperCase()} RISK\n            </span>\n          )}\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <Tabs defaultValue=\"stress\" className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-5\">\n            <TabsTrigger value=\"stress\">{isZh ? \"应力分布\" : \"Stress Map\"}</TabsTrigger>\n            <TabsTrigger value=\"damage\">{isZh ? \"损伤图\" : \"Damage Map\"}</TabsTrigger>\n            <TabsTrigger value=\"diagnosis\">{isZh ? \"诊断\" : \"Diagnosis\"}</TabsTrigger>\n            <TabsTrigger value=\"suggestions\">{isZh ? \"建议\" : \"Suggestions\"}</TabsTrigger>\n            <TabsTrigger value=\"optimize\">{isZh ? \"优化\" : \"Optimize\"}</TabsTrigger>\n          </TabsList>\n\n          {/* Stress Distribution Tab */}\n          <TabsContent value=\"stress\" className=\"space-y-4\">\n            {stressDistribution && (\n              <div className=\"space-y-4\">\n                {/* Color Legend */}\n                <div className=\"flex items-center gap-4 rounded-lg bg-slate-50 p-3\">\n                  <span className=\"text-sm font-medium\">{isZh ? \"应力图例\" : \"Stress Legend\"}:</span>\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"h-4 w-8 rounded bg-blue-500\" />\n                    <span className=\"text-xs\">&lt; {STRESS_COLOR_THRESHOLDS.BLUE_MAX * 100}%</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"h-4 w-8 rounded bg-green-500\" />\n                    <span className=\"text-xs\">{STRESS_COLOR_THRESHOLDS.BLUE_MAX * 100}-{STRESS_COLOR_THRESHOLDS.GREEN_MAX * 100}%</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"h-4 w-8 rounded bg-yellow-500\" />\n                    <span className=\"text-xs\">{STRESS_COLOR_THRESHOLDS.GREEN_MAX * 100}-{STRESS_COLOR_THRESHOLDS.YELLOW_MAX * 100}%</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"h-4 w-8 rounded bg-red-500\" />\n                    <span className=\"text-xs\">&gt; {STRESS_COLOR_THRESHOLDS.YELLOW_MAX * 100}%</span>\n                  </div>\n                </div>\n\n                {/* Stats */}\n                <div className=\"grid grid-cols-4 gap-4\">\n                  <div className=\"rounded-lg bg-slate-100 p-3 text-center\">\n                    <div className=\"text-2xl font-bold text-blue-600\">\n                      {stressDistribution.maxStress.toFixed(0)}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">{isZh ? \"最大应力 (MPa)\" : \"Max Stress (MPa)\"}</div>\n                  </div>\n                  <div className=\"rounded-lg bg-slate-100 p-3 text-center\">\n                    <div className=\"text-2xl font-bold text-green-600\">\n                      {stressDistribution.avgStress.toFixed(0)}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">{isZh ? \"平均应力 (MPa)\" : \"Avg Stress (MPa)\"}</div>\n                  </div>\n                  <div className=\"rounded-lg bg-slate-100 p-3 text-center\">\n                    <div className={`text-2xl font-bold ${stressDistribution.criticalZoneCount > 0 ? \"text-red-600\" : \"text-green-600\"}`}>\n                      {stressDistribution.criticalZoneCount}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">{isZh ? \"临界区域\" : \"Critical Zones\"}</div>\n                  </div>\n                  <div className=\"rounded-lg bg-slate-100 p-3 text-center\">\n                    <div className=\"text-2xl font-bold text-orange-600\">\n                      {stressDistribution.hotSpots.length}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">{isZh ? \"热点数\" : \"Hot Spots\"}</div>\n                  </div>\n                </div>\n\n                {/* Hot Spots Table */}\n                {stressDistribution.hotSpots.length > 0 && (\n                  <div className=\"rounded-lg border p-3\">\n                    <h4 className=\"mb-2 font-medium\">{isZh ? \"应力热点\" : \"Stress Hot Spots\"}</h4>\n                    <div className=\"max-h-32 overflow-y-auto\">\n                      <table className=\"w-full text-sm\">\n                        <thead>\n                          <tr className=\"border-b\">\n                            <th className=\"py-1 text-left\">{isZh ? \"位置\" : \"Location\"}</th>\n                            <th className=\"py-1 text-right\">{isZh ? \"圈数\" : \"Coil\"}</th>\n                            <th className=\"py-1 text-right\">{isZh ? \"应力\" : \"Stress\"}</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {stressDistribution.hotSpots.slice(0, 5).map((spot, i) => (\n                            <tr key={i} className=\"border-b border-slate-100\">\n                              <td className=\"py-1\">\n                                {geometry.type === \"torsion\" \n                                  ? `θ = ${(spot.theta * 180 / Math.PI).toFixed(0)}°`\n                                  : `${isZh ? \"圈\" : \"Coil\"} ${spot.coilNumber.toFixed(1)}`\n                                }\n                              </td>\n                              <td className=\"py-1 text-right\">{spot.coilNumber.toFixed(1)}</td>\n                              <td className=\"py-1 text-right text-red-600\">{spot.stress.toFixed(0)} MPa</td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  </div>\n                )}\n              </div>\n            )}\n          </TabsContent>\n\n          {/* Fatigue Damage Tab */}\n          <TabsContent value=\"damage\" className=\"space-y-4\">\n            {fatigueDamage && (\n              <div className=\"space-y-4\">\n                {/* Status Banner */}\n                <div className={`rounded-lg p-4 ${\n                  fatigueDamage.status === \"safe\" ? \"bg-green-100\" :\n                  fatigueDamage.status === \"warning\" ? \"bg-yellow-100\" :\n                  fatigueDamage.status === \"danger\" ? \"bg-orange-100\" :\n                  \"bg-red-100\"\n                }`}>\n                  <div className={`font-bold ${\n                    fatigueDamage.status === \"safe\" ? \"text-green-800\" :\n                    fatigueDamage.status === \"warning\" ? \"text-yellow-800\" :\n                    fatigueDamage.status === \"danger\" ? \"text-orange-800\" :\n                    \"text-red-800\"\n                  }`}>\n                    {isZh ? fatigueDamage.message.zh : fatigueDamage.message.en}\n                  </div>\n                </div>\n\n                {/* Damage Stats */}\n                <div className=\"grid grid-cols-4 gap-4\">\n                  <div className=\"rounded-lg bg-slate-100 p-3 text-center\">\n                    <div className={`text-2xl font-bold ${fatigueDamage.maxDamageIndex > 0.5 ? \"text-red-600\" : \"text-green-600\"}`}>\n                      {fatigueDamage.maxDamageIndex.toFixed(3)}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">{isZh ? \"最大损伤指数\" : \"Max Damage Index\"}</div>\n                  </div>\n                  <div className=\"rounded-lg bg-slate-100 p-3 text-center\">\n                    <div className=\"text-2xl font-bold\">\n                      {fatigueDamage.avgDamageIndex.toFixed(4)}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">{isZh ? \"平均损伤\" : \"Avg Damage\"}</div>\n                  </div>\n                  <div className=\"rounded-lg bg-slate-100 p-3 text-center\">\n                    <div className={`text-2xl font-bold ${fatigueDamage.highDamageZoneCount > 0 ? \"text-orange-600\" : \"text-green-600\"}`}>\n                      {fatigueDamage.highDamageZoneCount}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">{isZh ? \"高损伤区 (D>0.5)\" : \"High Damage (D>0.5)\"}</div>\n                  </div>\n                  <div className=\"rounded-lg bg-slate-100 p-3 text-center\">\n                    <div className={`text-2xl font-bold ${fatigueDamage.failurePredictedCount > 0 ? \"text-red-600\" : \"text-green-600\"}`}>\n                      {fatigueDamage.failurePredictedCount}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground\">{isZh ? \"预测失效\" : \"Failure Predicted\"}</div>\n                  </div>\n                </div>\n\n                {/* Miner Sum */}\n                <div className=\"rounded-lg border p-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"font-medium\">{isZh ? \"Miner 累积损伤\" : \"Miner Cumulative Damage\"}</span>\n                    <span className={`text-xl font-bold ${fatigueDamage.minerSum > 1 ? \"text-red-600\" : \"text-green-600\"}`}>\n                      {fatigueDamage.minerSum.toFixed(4)}\n                    </span>\n                  </div>\n                  <div className=\"mt-2 h-2 w-full rounded-full bg-slate-200\">\n                    <div \n                      className={`h-2 rounded-full ${fatigueDamage.minerSum > 1 ? \"bg-red-500\" : fatigueDamage.minerSum > 0.5 ? \"bg-yellow-500\" : \"bg-green-500\"}`}\n                      style={{ width: `${Math.min(100, fatigueDamage.minerSum * 100)}%` }}\n                    />\n                  </div>\n                </div>\n              </div>\n            )}\n          </TabsContent>\n\n          {/* Diagnosis Tab */}\n          <TabsContent value=\"diagnosis\" className=\"space-y-4\">\n            {diagnostics && (\n              <div className=\"space-y-4\">\n                <div className=\"rounded-lg bg-slate-50 p-3\">\n                  <p className=\"text-sm\">{isZh ? diagnostics.summary.zh : diagnostics.summary.en}</p>\n                </div>\n\n                {diagnostics.failureModes.length === 0 ? (\n                  <div className=\"rounded-lg bg-green-100 p-4 text-center text-green-800\">\n                    {isZh ? \"未检测到显著失效模式 ✓\" : \"No significant failure modes detected ✓\"}\n                  </div>\n                ) : (\n                  <div className=\"space-y-2\">\n                    {diagnostics.failureModes.map((mode, i) => (\n                      <div\n                        key={i}\n                        className={`rounded-lg border p-3 ${\n                          mode.severity === \"critical\" ? \"border-red-300 bg-red-50\" :\n                          mode.severity === \"high\" ? \"border-orange-300 bg-orange-50\" :\n                          mode.severity === \"medium\" ? \"border-yellow-300 bg-yellow-50\" :\n                          \"border-slate-200\"\n                        }`}\n                      >\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-xl\">{getFailureModeIcon(mode.type)}</span>\n                            <span className=\"font-medium\">{isZh ? mode.name.zh : mode.name.en}</span>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`rounded px-2 py-0.5 text-xs ${\n                              mode.severity === \"critical\" ? \"bg-red-200 text-red-800\" :\n                              mode.severity === \"high\" ? \"bg-orange-200 text-orange-800\" :\n                              \"bg-yellow-200 text-yellow-800\"\n                            }`}>\n                              {mode.severity.toUpperCase()}\n                            </span>\n                            <span className=\"text-sm font-bold\">{(mode.probability * 100).toFixed(0)}%</span>\n                          </div>\n                        </div>\n                        <p className=\"mt-1 text-sm text-muted-foreground\">\n                          {isZh ? mode.rootCause.zh : mode.rootCause.en}\n                        </p>\n                        <p className=\"mt-1 text-xs font-mono text-slate-600\">\n                          {mode.numericalJustification}\n                        </p>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            )}\n          </TabsContent>\n\n          {/* Suggestions Tab */}\n          <TabsContent value=\"suggestions\" className=\"space-y-4\">\n            {suggestions && (\n              <div className=\"space-y-4\">\n                <div className=\"rounded-lg bg-slate-50 p-3\">\n                  <p className=\"text-sm\">{isZh ? suggestions.summary.zh : suggestions.summary.en}</p>\n                </div>\n\n                {suggestions.quickWins.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <h4 className=\"font-medium text-green-700\">{isZh ? \"快速改进\" : \"Quick Wins\"}</h4>\n                    {suggestions.quickWins.map((suggestion, i) => (\n                      <div key={i} className=\"rounded-lg border border-green-200 bg-green-50 p-3\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"font-medium\">{isZh ? suggestion.title.zh : suggestion.title.en}</span>\n                          <span className=\"text-xs text-green-600\">\n                            {isZh ? \"简单\" : \"Easy\"} • {(suggestion.effectiveness * 100).toFixed(0)}% {isZh ? \"有效\" : \"effective\"}\n                          </span>\n                        </div>\n                        <p className=\"mt-1 text-sm text-muted-foreground\">\n                          {isZh ? suggestion.description.zh : suggestion.description.en}\n                        </p>\n                        {suggestion.parameterChange && (\n                          <p className=\"mt-1 text-xs font-mono text-green-700\">\n                            {suggestion.parameterChange.parameter}: {suggestion.parameterChange.currentValue.toFixed(2)} → {suggestion.parameterChange.suggestedValue.toFixed(2)} {suggestion.parameterChange.unit}\n                          </p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                )}\n\n                {suggestions.topPriority.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <h4 className=\"font-medium text-orange-700\">{isZh ? \"高优先级\" : \"Top Priority\"}</h4>\n                    {suggestions.topPriority.filter(s => !suggestions.quickWins.includes(s)).map((suggestion, i) => (\n                      <div key={i} className=\"rounded-lg border border-orange-200 bg-orange-50 p-3\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"font-medium\">{isZh ? suggestion.title.zh : suggestion.title.en}</span>\n                          <span className={`text-xs ${\n                            suggestion.difficulty === \"easy\" ? \"text-green-600\" :\n                            suggestion.difficulty === \"moderate\" ? \"text-yellow-600\" :\n                            \"text-red-600\"\n                          }`}>\n                            {suggestion.difficulty} • {suggestion.costImpact} cost\n                          </span>\n                        </div>\n                        <p className=\"mt-1 text-sm text-muted-foreground\">\n                          {isZh ? suggestion.expectedImprovement.zh : suggestion.expectedImprovement.en}\n                        </p>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            )}\n          </TabsContent>\n\n          {/* Optimization Tab */}\n          <TabsContent value=\"optimize\" className=\"space-y-4\">\n            <div className=\"grid gap-4 md:grid-cols-3\">\n              <div className=\"space-y-2\">\n                <Label>{isZh ? \"目标刚度 (N/mm)\" : \"Target Stiffness (N/mm)\"}</Label>\n                <Input\n                  type=\"number\"\n                  value={targetStiffness}\n                  onChange={(e) => setTargetStiffness(Number(e.target.value))}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>{isZh ? \"最小疲劳寿命\" : \"Min Fatigue Life\"}</Label>\n                <Select value={String(minFatigueLife)} onValueChange={(v) => setMinFatigueLife(Number(v))}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"100000\">10⁵ cycles</SelectItem>\n                    <SelectItem value=\"1000000\">10⁶ cycles</SelectItem>\n                    <SelectItem value=\"10000000\">10⁷ cycles</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>{isZh ? \"最小安全系数\" : \"Min Safety Factor\"}</Label>\n                <Input\n                  type=\"number\"\n                  value={minSafetyFactor}\n                  onChange={(e) => setMinSafetyFactor(Number(e.target.value))}\n                  step={0.1}\n                />\n              </div>\n            </div>\n\n            <Button \n              onClick={runOptimization} \n              disabled={isOptimizing}\n              className=\"w-full\"\n            >\n              {isOptimizing ? (isZh ? \"优化中...\" : \"Optimizing...\") : (isZh ? \"运行优化\" : \"Run Optimization\")}\n            </Button>\n\n            {optimizationResult && (\n              <div className=\"space-y-4\">\n                <div className={`rounded-lg p-4 ${\n                  optimizationResult.status === \"success\" ? \"bg-green-100\" :\n                  optimizationResult.status === \"partial\" ? \"bg-yellow-100\" :\n                  \"bg-red-100\"\n                }`}>\n                  <div className=\"font-bold\">\n                    {isZh ? optimizationResult.message.zh : optimizationResult.message.en}\n                  </div>\n                </div>\n\n                <div className=\"rounded-lg border p-4\">\n                  <h4 className=\"mb-3 font-medium\">{isZh ? \"最优解\" : \"Best Solution\"}</h4>\n                  <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">d:</span>\n                      <span className=\"font-mono\">{optimizationResult.bestSolution.wireDiameter} mm</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">Dm:</span>\n                      <span className=\"font-mono\">{optimizationResult.bestSolution.meanDiameter} mm</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">Na:</span>\n                      <span className=\"font-mono\">{optimizationResult.bestSolution.activeCoils}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">L0:</span>\n                      <span className=\"font-mono\">{optimizationResult.bestSolution.freeLength} mm</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">{isZh ? \"材料\" : \"Material\"}:</span>\n                      <span className=\"font-mono\">{optimizationResult.bestSolution.materialId}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">k:</span>\n                      <span className=\"font-mono\">{optimizationResult.expectedPerformance.springRate} N/mm</span>\n                    </div>\n                  </div>\n                </div>\n\n                {optimizationResult.paretoFront.length > 1 && (\n                  <div className=\"rounded-lg border p-4\">\n                    <h4 className=\"mb-3 font-medium\">{isZh ? \"Pareto 前沿解\" : \"Pareto Front Solutions\"}</h4>\n                    <div className=\"max-h-40 overflow-y-auto\">\n                      <table className=\"w-full text-xs\">\n                        <thead>\n                          <tr className=\"border-b\">\n                            <th className=\"py-1 text-left\">d</th>\n                            <th className=\"py-1 text-left\">Dm</th>\n                            <th className=\"py-1 text-left\">Na</th>\n                            <th className=\"py-1 text-right\">SF</th>\n                            <th className=\"py-1 text-right\">Mass</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {optimizationResult.paretoFront.slice(0, 5).map((sol, i) => (\n                            <tr key={i} className=\"border-b border-slate-100\">\n                              <td className=\"py-1\">{sol.solution.wireDiameter}</td>\n                              <td className=\"py-1\">{sol.solution.meanDiameter}</td>\n                              <td className=\"py-1\">{sol.solution.activeCoils}</td>\n                              <td className=\"py-1 text-right\">{sol.objectives.safety.toFixed(2)}</td>\n                              <td className=\"py-1 text-right\">{(sol.objectives.mass * 1000).toFixed(1)}g</td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                  </div>\n                )}\n              </div>\n            )}\n          </TabsContent>\n        </Tabs>\n      </CardContent>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SpiralAdvancedAnalysisPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SpiralFeaPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SpiralTorsionAnalysisPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":936,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":936,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[43135,43138],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[43135,43138],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":936,"column":91,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":936,"endColumn":94,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[43176,43179],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[43176,43179],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":938,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":938,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[43343,43346],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[43343,43346],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spiral Torsion Spring Analysis Panel\n * 螺旋扭转弹簧独立分析面板\n * \n * 与 wire spring 完全分离，只展示 spiral 专用字段：\n * - 输入：b, t, L, Di/Do(空间), θ0/θmin/θmax, θco\n * - 输出：k_deg, T0/Tmin/Tmax/Tco, σmax, σ_allow/source, safety factor, operatingStatus\n */\n\n\"use client\";\n\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { AlertTriangle, CheckCircle, XCircle, ArrowLeft, FileText, Loader2 } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport dynamic from \"next/dynamic\";\nimport type { SpiralTorsionGeometry, MaterialInfo, AnalysisResult } from \"@/lib/stores/springDesignStore\";\nimport { getSpringMaterial, type SpringMaterialId } from \"@/lib/materials/springMaterials\";\nimport { buildSpiralReportModel } from \"@/lib/reports/SpiralSpringReportTemplate\";\nimport { generateSpiralReportDraftHTML } from \"@/lib/reports/SpiralSpringReportDraftHtml\";\nimport {\n  END_KT_DEFAULTS,\n  END_KT_LABELS,\n  type EndKtType,\n} from \"@/lib/spring3d/spiralSpringFormulas\";\nimport { computeSpiralSpringAdvancedDerived } from \"@/lib/spring3d/spiralSpringAnalysis\";\nimport {\n  SPIRAL_SPRING_MATERIALS,\n  getSpiralSpringMaterial,\n  type SpiralHeatTreatment,\n  type SpiralReliability,\n  type SpiralSpringMaterial,\n  type SpiralStrengthBasis,\n  type SpiralSurfaceFinish,\n} from \"@/lib/spring3d/spiralSpringMaterials\";\nimport { GoodmanChart, SpiralCloseoutChart, SpiralTorqueBandChart } from \"@/components/charts\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { SpiralFeaPanel } from \"@/components/analysis/SpiralFeaPanel\";\nimport { SpiralAdvancedAnalysisPanel } from \"@/components/analysis/SpiralAdvancedAnalysisPanel\";\n\nconst SpiralTorsionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/SpiralTorsionSpringMesh\").then((mod) => mod.SpiralTorsionSpringVisualizer),\n  {\n    ssr: false,\n    loading: () => (\n      <div className=\"h-[420px] bg-slate-50 rounded-lg flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-slate-500\" />\n      </div>\n    ),\n  }\n);\n\ninterface SpiralTorsionAnalysisPanelProps {\n  isZh: boolean;\n  geometry: SpiralTorsionGeometry;\n  material: MaterialInfo;\n  analysisResult: AnalysisResult;\n}\n\nexport function SpiralTorsionAnalysisPanel({\n  isZh,\n  geometry,\n  material,\n  analysisResult,\n}: SpiralTorsionAnalysisPanelProps) {\n  // 从 analysisResult 中提取数据\n  const springRate = analysisResult.springRate;\n  const maxStress = analysisResult.maxStress ?? 0;\n  const safetyFactor = analysisResult.staticSafetyFactor ?? 1;\n  \n  // 从 geometry 中提取 spiral 专用字段\n  const {\n    stripWidth,\n    stripThickness,\n    activeLength,\n    innerDiameter,\n    outerDiameter,\n    preloadAngle,\n    minWorkingAngle,\n    maxWorkingAngle,\n    closeOutAngle,\n    windingDirection,\n    innerEndType,\n    outerEndType,\n  } = geometry;\n\n  // 计算 operatingStatus\n  const thetaRev = maxWorkingAngle / 360;\n  const closeOutRev = closeOutAngle / 360;\n  let operatingStatus: \"SAFE\" | \"WARNING\" | \"EXCEEDED\";\n  if (thetaRev <= 0.8 * closeOutRev) {\n    operatingStatus = \"SAFE\";\n  } else if (thetaRev <= closeOutRev) {\n    operatingStatus = \"WARNING\";\n  } else {\n    operatingStatus = \"EXCEEDED\";\n  }\n\n  // 计算扭矩（简化版，实际应从 store 读取完整结果）\n  const preloadTorque = springRate * preloadAngle;\n  const minTorque = preloadTorque + springRate * minWorkingAngle;\n  const thetaMaxUsed = operatingStatus === \"EXCEEDED\" ? closeOutAngle : maxWorkingAngle;\n  const maxTorque = preloadTorque + springRate * thetaMaxUsed;\n  const closeOutTorque = preloadTorque + springRate * closeOutAngle;\n\n  const allowableStress_MPa = useMemo(() => {\n    const sf = analysisResult.staticSafetyFactor;\n    const sigma = analysisResult.maxStress;\n    if (sf === undefined || sigma === undefined) return undefined;\n    if (!isFinite(sf) || !isFinite(sigma) || sf <= 0) return undefined;\n    return sf * sigma;\n  }, [analysisResult.maxStress, analysisResult.staticSafetyFactor]);\n\n  const unitSelfCheckWarnedRef = useRef(false);\n\n  const [innerEndKtType, setInnerEndKtType] = useState<EndKtType>(\"clamped\");\n  const [outerEndKtType, setOuterEndKtType] = useState<EndKtType>(\"clamped\");\n  const [innerKtOverride, setInnerKtOverride] = useState<number | null>(null);\n  const [outerKtOverride, setOuterKtOverride] = useState<number | null>(null);\n\n  const [toleranceT, setToleranceT] = useState(0.02);\n  const [toleranceB, setToleranceB] = useState(0.1);\n  const [toleranceL, setToleranceL] = useState(5);\n  const [toleranceE, setToleranceE] = useState(0);\n  const [toleranceEMode, setToleranceEMode] = useState<\"MPa\" | \"%\">(\"MPa\");\n  const [hardeningFactor, setHardeningFactor] = useState(8);\n\n  const [enableNonlinearCloseout, setEnableNonlinearCloseout] = useState(false);\n  const thetaContactStartTouchedRef = useRef(false);\n  const [thetaContactStartDeg, setThetaContactStartDeg] = useState(() => 0.85 * closeOutAngle);\n  const [hardeningA, setHardeningA] = useState(6.0);\n  const [hardeningP, setHardeningP] = useState(2.5);\n\n  const [spiralMatId, setSpiralMatId] = useState<SpiralSpringMaterial[\"id\"]>(() => geometry.spiralMaterialId ?? \"sae1095\");\n  const [spiralSurface, setSpiralSurface] = useState<SpiralSurfaceFinish>(\"as_rolled\");\n  const [spiralReliability, setSpiralReliability] = useState<SpiralReliability>(0.95);\n  const [shotPeened, setShotPeened] = useState(false);\n  const [strengthBasis, setStrengthBasis] = useState<SpiralStrengthBasis>(\"nominal\");\n  const [heatTreatment, setHeatTreatment] = useState<SpiralHeatTreatment>(\"default\");\n  const [isExportingPdf, setIsExportingPdf] = useState(false);\n  const [isExportingDraft, setIsExportingDraft] = useState(false);\n\n  const closeoutInputError =\n    !isFinite(closeOutAngle) || closeOutAngle <= 0\n      ? (isZh ? \"θco 必须 > 0\" : \"thetaCo must be > 0\")\n      : enableNonlinearCloseout && (thetaContactStartDeg < 0 || thetaContactStartDeg > closeOutAngle)\n        ? (isZh ? \"θ_contactStart 必须满足 0 ≤ θ_contactStart ≤ θco\" : \"thetaContactStart must satisfy 0 ≤ thetaContactStart ≤ thetaCo\")\n        : null;\n  const canExportReport = closeoutInputError === null;\n\n  const [reportProjectName, setReportProjectName] = useState(\"\");\n  const [reportEngineer, setReportEngineer] = useState(\"\");\n  const [reportPartNo, setReportPartNo] = useState(\"\");\n\n  const [fatigueCriterion, setFatigueCriterion] = useState<\"goodman\" | \"gerber\" | \"soderberg\">(\"goodman\");\n\n  useEffect(() => {\n    const m = getSpiralSpringMaterial(spiralMatId);\n    if (!m) return;\n    setSpiralSurface(m.defaultSurface);\n    setSpiralReliability(m.defaultReliability);\n  }, [spiralMatId]);\n\n  useEffect(() => {\n    if (thetaContactStartTouchedRef.current) return;\n    setThetaContactStartDeg(0.85 * closeOutAngle);\n  }, [closeOutAngle]);\n\n  const materialFull = useMemo(() => {\n    const id = geometry.materialId;\n    if (!id) return undefined;\n    return getSpringMaterial(id as SpringMaterialId);\n  }, [geometry.materialId]);\n\n  const derived = useMemo(() => {\n    return computeSpiralSpringAdvancedDerived({\n      springRate_NmmPerDeg: springRate,\n      preloadTorque_Nmm: preloadTorque,\n      minTorque_Nmm: minTorque,\n      maxTorque_Nmm: maxTorque,\n      b_mm: stripWidth,\n      t_mm: stripThickness,\n      L_mm: activeLength,\n      thetaMaxUsed_deg: thetaMaxUsed,\n      closeOutAngle_deg: closeOutAngle,\n      maxWorkingAngle_deg: maxWorkingAngle,\n      material,\n      materialFactors: {\n        surfaceFactor: materialFull?.surfaceFactor,\n        tempFactor: materialFull?.tempFactor,\n        sizeFactor: materialFull?.sizeFactor,\n      },\n      endKt: {\n        innerEndKtType,\n        outerEndKtType,\n        innerKtOverride,\n        outerKtOverride,\n      },\n      tolerance: {\n        toleranceT_mm: toleranceT,\n        toleranceB_mm: toleranceB,\n        toleranceL_mm: toleranceL,\n        toleranceE,\n        toleranceEMode,\n      },\n      closeout: {\n        enableNonlinearCloseout,\n        thetaContactStartDeg,\n        hardeningA,\n        hardeningP,\n        hardeningFactorLegacy: hardeningFactor,\n      },\n      engineeringMaterial: {\n        materialId: spiralMatId,\n        surface: spiralSurface,\n        reliability: spiralReliability,\n        shotPeened,\n        strengthBasis,\n        heatTreatment,\n      },\n    });\n  }, [\n    springRate,\n    preloadTorque,\n    minTorque,\n    maxTorque,\n    stripWidth,\n    stripThickness,\n    activeLength,\n    thetaMaxUsed,\n    closeOutAngle,\n    maxWorkingAngle,\n    material,\n    materialFull?.surfaceFactor,\n    materialFull?.tempFactor,\n    materialFull?.sizeFactor,\n    innerEndKtType,\n    outerEndKtType,\n    innerKtOverride,\n    outerKtOverride,\n    toleranceB,\n    toleranceT,\n    toleranceL,\n    toleranceE,\n    toleranceEMode,\n    hardeningFactor,\n    enableNonlinearCloseout,\n    thetaContactStartDeg,\n    hardeningA,\n    hardeningP,\n    spiralMatId,\n    spiralSurface,\n    spiralReliability,\n    shotPeened,\n    strengthBasis,\n    heatTreatment,\n  ]);\n\n  const resetEngineeringMaterial = useCallback(() => {\n    const m = getSpiralSpringMaterial(spiralMatId);\n    setSpiralSurface(m?.defaultSurface ?? \"as_rolled\");\n    setSpiralReliability(0.95);\n    setShotPeened(false);\n    setStrengthBasis(\"nominal\");\n    setHeatTreatment(\"default\");\n  }, [spiralMatId]);\n\n  const applyRecommendedEngineeringMaterial = useCallback(() => {\n    const m = getSpiralSpringMaterial(spiralMatId);\n    if (m?.defaultSurface) setSpiralSurface(m.defaultSurface);\n    setSpiralReliability(0.95);\n    setShotPeened(derived.review.fatigueRYG !== \"GREEN\");\n    setStrengthBasis(\"nominal\");\n    setHeatTreatment(\"default\");\n  }, [derived.review.fatigueRYG, spiralMatId]);\n\n  useEffect(() => {\n    if (unitSelfCheckWarnedRef.current) return;\n    const k = springRate;\n    if (!isFinite(k) || Math.abs(k) < 1e-12) return;\n\n    const thetaMaxUsed = operatingStatus === \"EXCEEDED\" ? closeOutAngle : maxWorkingAngle;\n    const points = [0, thetaMaxUsed / 2, thetaMaxUsed];\n    const eps = 1e-6;\n\n    const torqueAtTheta = (thetaDeg: number) => preloadTorque + k * thetaDeg;\n\n    const failed = points.some((thetaDeg) => {\n      const T = torqueAtTheta(thetaDeg);\n      const thetaBack = (T - preloadTorque) / k;\n      return !isFinite(thetaBack) || Math.abs(thetaBack - thetaDeg) > eps;\n    });\n\n    if (failed) {\n      unitSelfCheckWarnedRef.current = true;\n      console.warn(\"[SpiralTorsion] unit mismatch: expected (T - T0)/k ≈ θ\", {\n        springRate: k,\n        preloadTorque,\n        points,\n      });\n    }\n  }, [springRate, preloadTorque, maxWorkingAngle, closeOutAngle, operatingStatus]);\n\n  return (\n    <main className=\"container mx-auto py-8 px-4\">\n      {/* Header */}\n      <div className=\"mb-8\">\n        <div className=\"flex gap-2 mb-4\">\n          <Link href=\"/tools/analysis\">\n            <Button variant=\"outline\" size=\"sm\">\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              {isZh ? \"返回\" : \"Back\"}\n            </Button>\n          </Link>\n          <Button\n            variant=\"secondary\"\n            size=\"sm\"\n            disabled={isExportingPdf || !canExportReport}\n            onClick={() => {\n              void (async () => {\n                setIsExportingPdf(true);\n                try {\n                  const model = buildSpiralReportModel({\n                    geometry,\n                    calculatorMaterial: material,\n                    analysisResult,\n                    derived,\n                    extras: {\n                      reportMeta: {\n                        language: \"bilingual\",\n                        projectName: reportProjectName || undefined,\n                        engineer: reportEngineer || undefined,\n                        partNo: reportPartNo || undefined,\n                        fatigueCriterion,\n                      },\n                      innerEndKtType,\n                      outerEndKtType,\n                      toleranceT,\n                      toleranceB,\n                      toleranceL,\n                      toleranceE,\n                      toleranceEMode,\n                      hardeningFactor,\n                      enableNonlinearCloseout,\n                      thetaContactStartDeg,\n                      hardeningA,\n                      hardeningP,\n                      engineeringMaterial: {\n                        materialId: spiralMatId,\n                        surface: spiralSurface,\n                        reliability: spiralReliability,\n                        shotPeened,\n                        strengthBasis,\n                        heatTreatment,\n                      },\n                    },\n                  });\n\n                  const response = await fetch(\"/api/reports/spiral-torsion\", {\n                    method: \"POST\",\n                    headers: { \"Content-Type\": \"application/json\" },\n                    body: JSON.stringify(model),\n                  });\n\n                  if (!response.ok) {\n                    const err = await response.json().catch(() => null);\n                    throw new Error(err?.error ?? `HTTP ${response.status}`);\n                  }\n\n                  const blob = await response.blob();\n                  const cd = response.headers.get(\"content-disposition\");\n                  const match = cd ? /filename=\\\"?([^\\\";]+)\\\"?/i.exec(cd) : null;\n                  const filename = match?.[1] ?? \"spiral-torsion-report.pdf\";\n\n                  const url = URL.createObjectURL(blob);\n                  const a = document.createElement(\"a\");\n                  a.href = url;\n                  a.download = filename;\n                  document.body.appendChild(a);\n                  a.click();\n                  a.remove();\n                  URL.revokeObjectURL(url);\n                } catch (e) {\n                  console.error(\"[Spiral] PDF export failed\", e);\n                } finally {\n                  setIsExportingPdf(false);\n                }\n              })();\n            }}\n          >\n            <FileText className=\"w-4 h-4 mr-2\" />\n            {isExportingPdf ? (isZh ? \"导出中...\" : \"Exporting...\") : isZh ? \"导出 PDF\" : \"Export PDF\"}\n          </Button>\n\n          <Button\n            variant=\"secondary\"\n            size=\"sm\"\n            disabled={isExportingDraft || !canExportReport}\n            className=\"transition-colors hover:bg-purple-200 hover:text-purple-950 dark:hover:bg-purple-900/40 dark:hover:text-purple-100\"\n            title={isZh ? \"导出草稿：下载 JSON + 打开/下载 HTML 预览\" : \"Draft export: download JSON + open/download HTML preview\"}\n            onClick={() => {\n              setIsExportingDraft(true);\n              try {\n                const model = buildSpiralReportModel({\n                  geometry,\n                  calculatorMaterial: material,\n                  analysisResult,\n                  derived,\n                  extras: {\n                    reportMeta: {\n                      language: \"bilingual\",\n                      projectName: reportProjectName || undefined,\n                      engineer: reportEngineer || undefined,\n                      partNo: reportPartNo || undefined,\n                      fatigueCriterion,\n                    },\n                    innerEndKtType,\n                    outerEndKtType,\n                    toleranceT,\n                    toleranceB,\n                    toleranceL,\n                    toleranceE,\n                    toleranceEMode,\n                    hardeningFactor,\n                    enableNonlinearCloseout,\n                    thetaContactStartDeg,\n                    hardeningA,\n                    hardeningP,\n                    engineeringMaterial: {\n                      materialId: spiralMatId,\n                      surface: spiralSurface,\n                      reliability: spiralReliability,\n                      shotPeened,\n                      strengthBasis,\n                      heatTreatment,\n                    },\n                  },\n                });\n                console.log(\"[Spiral] Draft Report Model\", model);\n\n                const json = JSON.stringify(model, null, 2);\n                const blob = new Blob([json], { type: \"application/json\" });\n                const url = URL.createObjectURL(blob);\n                const a = document.createElement(\"a\");\n                a.href = url;\n                a.download = `spiral-torsion-report-model-${Date.now()}.json`;\n                document.body.appendChild(a);\n                a.click();\n                a.remove();\n                URL.revokeObjectURL(url);\n\n                const html = generateSpiralReportDraftHTML(model);\n                const htmlBlob = new Blob([html], { type: \"text/html\" });\n                const htmlUrl = URL.createObjectURL(htmlBlob);\n                const opened = window.open(htmlUrl, \"_blank\");\n                if (!opened) {\n                  const ah = document.createElement(\"a\");\n                  ah.href = htmlUrl;\n                  ah.download = `spiral-torsion-report-draft-${Date.now()}.html`;\n                  document.body.appendChild(ah);\n                  ah.click();\n                  ah.remove();\n                }\n                setTimeout(() => URL.revokeObjectURL(htmlUrl), 10_000);\n              } finally {\n                setIsExportingDraft(false);\n              }\n            }}\n          >\n            {isExportingDraft ? (isZh ? \"导出草稿...\" : \"Exporting draft...\") : isZh ? \"导出 PDF（草稿）\" : \"Export PDF (Draft)\"}\n          </Button>\n\n          {closeoutInputError && (\n            <div className=\"text-xs text-red-600 dark:text-red-300 mt-2\">{closeoutInputError}</div>\n          )}\n        </div>\n\n        <div className=\"grid gap-2 mb-4 md:grid-cols-3\">\n          <div className=\"space-y-1\">\n            <Label className=\"text-xs text-muted-foreground\">{isZh ? \"项目 / Project\" : \"Project\"}</Label>\n            <Input value={reportProjectName} onChange={(e) => setReportProjectName(e.target.value)} className=\"h-9\" />\n          </div>\n          <div className=\"space-y-1\">\n            <Label className=\"text-xs text-muted-foreground\">{isZh ? \"工程师 / Engineer\" : \"Engineer\"}</Label>\n            <Input value={reportEngineer} onChange={(e) => setReportEngineer(e.target.value)} className=\"h-9\" />\n          </div>\n          <div className=\"space-y-1\">\n            <Label className=\"text-xs text-muted-foreground\">{isZh ? \"零件号 / Part No.\" : \"Part No.\"}</Label>\n            <Input value={reportPartNo} onChange={(e) => setReportPartNo(e.target.value)} className=\"h-9\" />\n          </div>\n        </div>\n        <h1 className=\"text-2xl font-bold mb-2\">\n          {isZh ? \"螺旋扭转弹簧工程分析\" : \"Spiral Torsion Spring Engineering Analysis\"}\n        </h1>\n        <p className=\"text-muted-foreground\">\n          {isZh \n            ? \"带材卷绕式弹簧 - 独立分析面板（不使用 wire spring 字段）\" \n            : \"Flat strip wound spring - Independent analysis panel (no wire spring fields)\"}\n        </p>\n      </div>\n\n      {/* Operating Status Banner */}\n      <div className={`mb-6 p-4 rounded-lg border ${\n        operatingStatus === \"SAFE\" \n          ? \"bg-emerald-500/10 border-emerald-500/50\" \n          : operatingStatus === \"WARNING\"\n            ? \"bg-amber-500/10 border-amber-500/50\"\n            : \"bg-red-500/10 border-red-500/50\"\n      }`}>\n        <div className=\"flex items-center gap-3\">\n          {operatingStatus === \"SAFE\" && <CheckCircle className=\"w-6 h-6 text-emerald-500\" />}\n          {operatingStatus === \"WARNING\" && <AlertTriangle className=\"w-6 h-6 text-amber-500\" />}\n          {operatingStatus === \"EXCEEDED\" && <XCircle className=\"w-6 h-6 text-red-500\" />}\n          <div>\n            <p className={`font-medium ${\n              operatingStatus === \"SAFE\" ? \"text-emerald-400\" \n              : operatingStatus === \"WARNING\" ? \"text-amber-400\" \n              : \"text-red-400\"\n            }`}>\n              {operatingStatus === \"SAFE\" && (isZh ? \"✓ 安全 - 线性工作区\" : \"✓ SAFE - Linear operating range\")}\n              {operatingStatus === \"WARNING\" && (isZh ? \"⚠️ 警告 - 接近贴合区\" : \"⚠️ WARNING - Approaching close-out\")}\n              {operatingStatus === \"EXCEEDED\" && (isZh ? \"❌ 超限 - 已超过贴合点\" : \"❌ EXCEEDED - Close-out limit exceeded\")}\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              θ/θ_co = {(thetaRev / closeOutRev).toFixed(2)} ({(thetaRev / closeOutRev * 100).toFixed(0)}%)\n            </p>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        {/* Input Parameters - Spiral Specific */}\n        <Card>\n          <CardHeader>\n            <CardTitle>{isZh ? \"输入参数 (Spiral 专用)\" : \"Input Parameters (Spiral Specific)\"}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Strip Geometry */}\n            <div className=\"space-y-2\">\n              <p className=\"text-sm font-medium text-muted-foreground\">\n                {isZh ? \"带材几何\" : \"Strip Geometry\"}\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <span className=\"text-slate-400\">b (带材宽度):</span>\n                <span>{stripWidth} mm</span>\n                <span className=\"text-slate-400\">t (带材厚度):</span>\n                <span>{stripThickness} mm</span>\n                <span className=\"text-slate-400\">L (有效长度):</span>\n                <span className=\"font-medium text-blue-400\">{activeLength} mm</span>\n                <span className=\"text-slate-400\">b/t (宽厚比):</span>\n                <span>{(stripWidth / stripThickness).toFixed(1)}</span>\n              </div>\n            </div>\n\n            {/* Space Check */}\n            <div className=\"space-y-2\">\n              <p className=\"text-sm font-medium text-muted-foreground\">\n                {isZh ? \"空间校核\" : \"Space Check\"}\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <span className=\"text-slate-400\">Di (内径):</span>\n                <span>{innerDiameter} mm</span>\n                <span className=\"text-slate-400\">Do (外径):</span>\n                <span>{outerDiameter} mm</span>\n              </div>\n            </div>\n\n            {/* Working Angles */}\n            <div className=\"space-y-2\">\n              <p className=\"text-sm font-medium text-muted-foreground\">\n                {isZh ? \"工作角度\" : \"Working Angles\"}\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <span className=\"text-slate-400\">θ₀ (预紧角):</span>\n                <span>{preloadAngle}° ({(preloadAngle / 360).toFixed(3)} rev)</span>\n                <span className=\"text-slate-400\">θ_min:</span>\n                <span>{minWorkingAngle}° ({(minWorkingAngle / 360).toFixed(3)} rev)</span>\n                <span className=\"text-slate-400\">θ_max:</span>\n                <span className=\"font-medium\">{maxWorkingAngle}° ({(maxWorkingAngle / 360).toFixed(3)} rev)</span>\n                <span className=\"text-slate-400\">θ_co (close-out):</span>\n                <span className=\"text-amber-400\">{closeOutAngle}° ({(closeOutAngle / 360).toFixed(3)} rev)</span>\n              </div>\n            </div>\n\n            {/* End Conditions */}\n            <div className=\"space-y-2\">\n              <p className=\"text-sm font-medium text-muted-foreground\">\n                {isZh ? \"端部条件\" : \"End Conditions\"}\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <span className=\"text-slate-400\">{isZh ? \"内端\" : \"Inner End\"}:</span>\n                <span>{innerEndType ?? \"fixed\"}</span>\n                <span className=\"text-slate-400\">{isZh ? \"外端\" : \"Outer End\"}:</span>\n                <span>{outerEndType ?? \"fixed\"}</span>\n                <span className=\"text-slate-400\">{isZh ? \"绕向\" : \"Winding\"}:</span>\n                <span>{windingDirection === \"cw\" ? \"CW / 顺时针\" : \"CCW / 逆时针\"}</span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Output Results - Spiral Specific */}\n        <Card>\n          <CardHeader>\n            <CardTitle>{isZh ? \"计算结果 (Spiral 专用)\" : \"Calculation Results (Spiral Specific)\"}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Spring Rate */}\n            <div className=\"space-y-2 p-3 rounded-md bg-green-50 border border-green-200 dark:bg-green-900/30 dark:border-green-700\">\n              <p className=\"text-sm font-medium text-green-800 dark:text-green-300\">\n                {isZh ? \"扭转刚度\" : \"Spring Rate\"}\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <span className=\"text-slate-700 dark:text-slate-300\">k (corrected):</span>\n                <span className=\"font-medium text-green-700 dark:text-green-300\">{springRate.toFixed(4)} N·mm/°</span>\n              </div>\n            </div>\n\n            {/* Torque */}\n            <div className=\"space-y-2 p-3 rounded-md bg-cyan-50 border border-cyan-200 dark:bg-cyan-900/30 dark:border-cyan-700\">\n              <p className=\"text-sm font-medium text-cyan-800 dark:text-cyan-300\">\n                {isZh ? \"扭矩\" : \"Torque\"}\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <span className=\"text-slate-700 dark:text-slate-300\">T₀ (preload):</span>\n                <span>{preloadTorque.toFixed(2)} N·mm</span>\n                <span className=\"text-slate-700 dark:text-slate-300\">T(θ_min):</span>\n                <span>{minTorque.toFixed(2)} N·mm</span>\n                <span className=\"text-slate-700 dark:text-slate-300\">T(θ_max):</span>\n                <span\n                  className={`font-medium ${\n                    operatingStatus === \"EXCEEDED\" ? \"text-red-700 dark:text-red-300\" : \"text-cyan-700 dark:text-cyan-300\"\n                  }`}\n                >\n                  {maxTorque.toFixed(2)} N·mm\n                  {operatingStatus === \"EXCEEDED\" && \" (clamped)\"}\n                </span>\n                <span className=\"text-slate-700 dark:text-slate-300\">T(θ_co):</span>\n                <span className=\"text-amber-700 dark:text-amber-300\">{closeOutTorque.toFixed(2)} N·mm</span>\n              </div>\n            </div>\n\n            {/* Stress */}\n            <div className=\"space-y-2 p-3 rounded-md bg-blue-50 border border-blue-200 dark:bg-blue-900/30 dark:border-blue-700\">\n              <p className=\"text-sm font-medium text-blue-800 dark:text-blue-300\">\n                {isZh ? \"弯曲应力 (σ)\" : \"Bending Stress (σ)\"}\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <span className=\"text-slate-700 dark:text-slate-300\">σ_max:</span>\n                <span>{maxStress.toFixed(1)} MPa</span>\n                <span className=\"text-slate-700 dark:text-slate-300\">σ_allow:</span>\n                <span>{(material.tensileStrength ? material.tensileStrength * 0.45 : 0).toFixed(0)} MPa</span>\n              </div>\n              <p className=\"text-xs text-slate-600 dark:text-slate-400 mt-1\">\n                {isZh ? \"注：螺旋扭转弹簧主应力为弯曲应力 σ，非剪切应力 τ\" : \"Note: Primary stress is bending σ, not shear τ\"}\n              </p>\n            </div>\n\n            {/* Safety Factor */}\n            <div className={`space-y-2 p-3 rounded-md border ${\n              safetyFactor >= 1.2 \n                ? \"bg-emerald-50 border-emerald-200 dark:bg-emerald-900/30 dark:border-emerald-700\" \n                : safetyFactor >= 1.0 \n                  ? \"bg-amber-50 border-amber-200 dark:bg-amber-900/30 dark:border-amber-700\"\n                  : \"bg-red-50 border-red-200 dark:bg-red-900/30 dark:border-red-700\"\n            }`}>\n              <p className=\"text-sm font-medium text-slate-800 dark:text-slate-300\">\n                {isZh ? \"安全系数\" : \"Safety Factor\"}\n              </p>\n              <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                <span className=\"text-slate-700 dark:text-slate-300\">n (linear):</span>\n                <span className={`font-bold ${\n                  safetyFactor >= 1.2 ? \"text-emerald-400\" \n                  : safetyFactor >= 1.0 ? \"text-amber-400\"\n                  : \"text-red-400\"\n                }`}>\n                  {safetyFactor.toFixed(2)}\n                </span>\n              </div>\n            </div>\n\n            {/* Close-out Warning */}\n            {operatingStatus === \"EXCEEDED\" && (\n              <div className=\"p-3 rounded-md bg-red-50 border border-red-200 dark:bg-red-900/30 dark:border-red-700\">\n                <p className=\"text-sm font-medium text-red-800 dark:text-red-300 mb-2\">\n                  ⚠️ {isZh ? \"Close-out 警告\" : \"Close-out Warning\"}\n                </p>\n                <ul className=\"text-xs text-red-800 dark:text-red-200 space-y-1\">\n                  <li>• {isZh ? \"工作角度超过 close-out 限制 (θ > θ_co)\" : \"Working angle exceeds close-out limit (θ > θ_co)\"}</li>\n                  <li>• {isZh ? \"close-out 后扭矩急剧非线性增加，无法准确计算\" : \"Torque increases rapidly and non-linearly beyond close-out\"}</li>\n                  <li>• {isZh ? \"建议：工作角度应 ≤ 0.8 × θ_co，或咨询制造商\" : \"Recommendation: θ ≤ 0.8 × θ_co, or consult manufacturer\"}</li>\n                </ul>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card className=\"md:col-span-2\">\n          <CardHeader>\n            <CardTitle>{isZh ? \"工程级分析增强\" : \"Engineering Enhancements\"}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Tabs defaultValue=\"ends\" className=\"w-full\">\n              <TabsList className=\"mb-4 flex flex-wrap\">\n                <TabsTrigger value=\"preview\">{isZh ? \"预览\" : \"Preview\"}</TabsTrigger>\n                <TabsTrigger value=\"fea\">FEA</TabsTrigger>\n                <TabsTrigger value=\"material\">{isZh ? \"材料\" : \"Material\"}</TabsTrigger>\n                <TabsTrigger value=\"ends\">{isZh ? \"端部\" : \"Ends\"}</TabsTrigger>\n                <TabsTrigger value=\"fatigue\">{isZh ? \"疲劳\" : \"Fatigue\"}</TabsTrigger>\n                <TabsTrigger value=\"tolerance\">{isZh ? \"公差\" : \"Tolerance\"}</TabsTrigger>\n                <TabsTrigger value=\"closeout\">{isZh ? \"贴合/硬化\" : \"Close-out\"}</TabsTrigger>\n                <TabsTrigger value=\"review\">{isZh ? \"评审\" : \"Review\"}</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"preview\" className=\"space-y-3\">\n                <div className=\"h-[420px] rounded-lg overflow-hidden\">\n                  <SpiralTorsionSpringVisualizer\n                    innerDiameter={innerDiameter}\n                    outerDiameter={outerDiameter}\n                    turns={geometry.activeCoils}\n                    stripWidth={stripWidth}\n                    stripThickness={stripThickness}\n                    handedness={windingDirection ?? \"cw\"}\n                  />\n                </div>\n                <p className=\"text-xs text-muted-foreground text-center\">\n                  {isZh ? \"Three.js 预览：拖动旋转，滚轮缩放\" : \"Three.js preview: drag to rotate, scroll to zoom\"}\n                </p>\n              </TabsContent>\n\n              <TabsContent value=\"fea\" className=\"space-y-4\">\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <div className=\"rounded-lg overflow-hidden border border-border\">\n                    <div className=\"h-[420px] bg-slate-50\">\n                      <SpiralTorsionSpringVisualizer\n                        innerDiameter={innerDiameter}\n                        outerDiameter={outerDiameter}\n                        turns={geometry.activeCoils}\n                        stripWidth={stripWidth}\n                        stripThickness={stripThickness}\n                        handedness={windingDirection ?? \"cw\"}\n                      />\n                    </div>\n                  </div>\n\n                  <SpiralFeaPanel\n                    isZh={isZh}\n                    geometry={geometry}\n                    springRate_NmmPerDeg={springRate}\n                    preloadTorque_Nmm={preloadTorque}\n                    suggestedTorque_Nmm={maxTorque}\n                    suggestedAngle_deg={thetaMaxUsed}\n                    allowableStress_MPa={allowableStress_MPa}\n                  />\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"material\" className=\"space-y-4\">\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center justify-end gap-2\">\n                      <Button variant=\"outline\" size=\"sm\" onClick={resetEngineeringMaterial}>\n                        {isZh ? \"重置\" : \"Reset\"}\n                      </Button>\n                      <Button variant=\"secondary\" size=\"sm\" onClick={applyRecommendedEngineeringMaterial}>\n                        {isZh ? \"应用推荐\" : \"Apply recommended\"}\n                      </Button>\n                    </div>\n\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-xs text-muted-foreground\">{isZh ? \"工程材料\" : \"Engineering Material\"}</Label>\n                      <Select value={spiralMatId} onValueChange={(v) => setSpiralMatId(v as SpiralSpringMaterial[\"id\"])}>\n                        <SelectTrigger className=\"h-9\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {SPIRAL_SPRING_MATERIALS.map((m) => (\n                            <SelectItem key={m.id} value={m.id}>\n                              {m.name} ({m.standard})\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-3\">\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-muted-foreground\">{isZh ? \"强度基准\" : \"Strength basis\"}</Label>\n                        <Select value={strengthBasis} onValueChange={(v) => setStrengthBasis(v as SpiralStrengthBasis)}>\n                          <SelectTrigger className=\"h-9\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"nominal\">{isZh ? \"名义（不修正）\" : \"Nominal (no adjustment)\"}</SelectItem>\n                            <SelectItem value=\"thickness_heat_treatment\">{isZh ? \"按厚度/热处理修正\" : \"Adjusted by thickness/HT\"}</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-muted-foreground\">{isZh ? \"热处理状态\" : \"Heat treatment\"}</Label>\n                        <Select\n                          value={heatTreatment}\n                          onValueChange={(v) => setHeatTreatment(v as SpiralHeatTreatment)}\n                          disabled={strengthBasis === \"nominal\"}\n                        >\n                          <SelectTrigger className=\"h-9\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"default\">{isZh ? \"默认/未知\" : \"Default/Unknown\"}</SelectItem>\n                            <SelectItem value=\"spring_tempered\">{isZh ? \"弹簧回火\" : \"Spring tempered\"}</SelectItem>\n                            <SelectItem value=\"hardened_tempered\">{isZh ? \"淬火+回火\" : \"Hardened & tempered\"}</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-3\">\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-muted-foreground\">{isZh ? \"表面\" : \"Surface\"}</Label>\n                        <Select value={spiralSurface} onValueChange={(v) => setSpiralSurface(v as SpiralSurfaceFinish)}>\n                          <SelectTrigger className=\"h-9\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"polished\">{isZh ? \"抛光\" : \"Polished\"}</SelectItem>\n                            <SelectItem value=\"oil_tempered\">{isZh ? \"油淬回火\" : \"Oil Tempered\"}</SelectItem>\n                            <SelectItem value=\"as_rolled\">{isZh ? \"轧制态\" : \"As Rolled\"}</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-muted-foreground\">{isZh ? \"可靠度\" : \"Reliability\"}</Label>\n                        <Select value={String(spiralReliability)} onValueChange={(v) => setSpiralReliability(Number(v) as SpiralReliability)}>\n                          <SelectTrigger className=\"h-9\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"0.9\">90%</SelectItem>\n                            <SelectItem value=\"0.95\">95%</SelectItem>\n                            <SelectItem value=\"0.99\">99%</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n\n                    <div className=\"flex items-center justify-between rounded-md border border-border bg-muted/40 p-3\">\n                      <div>\n                        <div className=\"text-sm font-medium\">{isZh ? \"喷丸\" : \"Shot Peen\"}</div>\n                        <div className=\"text-xs text-muted-foreground\">\n                          {isZh ? \"用于提高疲劳极限（k_peen）\" : \"Improves endurance limit (k_peen)\"}\n                        </div>\n                        <div className=\"text-xs text-muted-foreground mt-1\">\n                          {isZh\n                            ? \"假设：仅通过 k_peen 作用于 Se′；不显式建模残余应力/均值应力迁移。\"\n                            : \"Assumption: k_peen applies to Se' only; residual stress / mean-stress shift not modeled.\"}\n                        </div>\n                      </div>\n                      <label className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <input\n                          type=\"checkbox\"\n                          checked={shotPeened}\n                          onChange={(e) => setShotPeened(e.target.checked)}\n                          className=\"size-4 rounded border-slate-300\"\n                        />\n                        {isZh ? \"启用\" : \"Enable\"}\n                      </label>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    <div className=\"rounded-md border border-border bg-muted/40 p-3\">\n                      <div className=\"text-sm font-medium mb-2\">{isZh ? \"材料属性（只读）\" : \"Material Properties (Read-only)\"}</div>\n                      <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                        <span className=\"text-muted-foreground\">E</span>\n                        <span>{getSpiralSpringMaterial(spiralMatId)?.elasticModulus_MPa.toFixed(0)} MPa</span>\n                        <span className=\"text-muted-foreground\">Su</span>\n                        <span>{getSpiralSpringMaterial(spiralMatId)?.ultimateStrength_MPa.toFixed(0)} MPa</span>\n                        <span className=\"text-muted-foreground\">Sy</span>\n                        <span>{getSpiralSpringMaterial(spiralMatId)?.yieldStrength_MPa.toFixed(0)} MPa</span>\n                        <span className=\"text-muted-foreground\">Se′</span>\n                        <span>{getSpiralSpringMaterial(spiralMatId)?.SePrime_MPa.toFixed(0)} MPa</span>\n                      </div>\n                    </div>\n\n                    <div className=\"rounded-md border border-border bg-muted/40 p-3\">\n                      <div className=\"text-sm font-medium mb-2\">{isZh ? \"疲劳修正（用于 Goodman）\" : \"Fatigue Corrections (for Goodman)\"}</div>\n                      <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                        <span className=\"text-muted-foreground\">k_surface</span>\n                        <span>{derived.kSurface !== null ? derived.kSurface.toFixed(3) : \"—\"}</span>\n                        <span className=\"text-muted-foreground\">k_reliability</span>\n                        <span>{derived.kReliability !== null ? derived.kReliability.toFixed(3) : \"—\"}</span>\n                        <span className=\"text-muted-foreground\">k_peen</span>\n                        <span>{derived.kPeen !== null ? derived.kPeen.toFixed(3) : \"—\"}</span>\n                        <span className=\"text-muted-foreground\">Se</span>\n                        <span className=\"font-medium\">{derived.Se !== null ? derived.Se.toFixed(0) : \"—\"} MPa</span>\n                      </div>\n                      <div className=\"text-xs text-muted-foreground mt-2\">\n                        {isZh\n                          ? \"Se = Se′ × k_surface × k_reliability × k_peen。\"\n                          : \"Se = Se′ × k_surface × k_reliability × k_peen.\"}\n                      </div>\n                    </div>\n\n                    <div className=\"rounded-md border border-border bg-muted/40 p-3\">\n                      <div className=\"text-sm font-medium mb-2\">{isZh ? \"强度修正（可选）\" : \"Strength Adjustment (Optional)\"}</div>\n                      <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                        <span className=\"text-muted-foreground\">basis</span>\n                        <span>{derived.strengthBasis ?? \"nominal\"}</span>\n                        <span className=\"text-muted-foreground\">heat treatment</span>\n                        <span>{derived.heatTreatment ?? \"default\"}</span>\n                        <span className=\"text-muted-foreground\">k_thickness</span>\n                        <span>{derived.kThickness !== undefined ? Number(derived.kThickness).toFixed(3) : \"1.000\"}</span>\n                        <span className=\"text-muted-foreground\">k_heat_treatment</span>\n                        <span>{derived.kHeatTreatment !== undefined ? Number(derived.kHeatTreatment).toFixed(3) : \"1.000\"}</span>\n                        <span className=\"text-muted-foreground\">Su_used</span>\n                        <span>{derived.Su !== null && derived.Su !== undefined ? Number(derived.Su).toFixed(0) : \"—\"} MPa</span>\n                        <span className=\"text-muted-foreground\">Sy_used</span>\n                        <span>{derived.Sy !== null && derived.Sy !== undefined ? Number(derived.Sy).toFixed(0) : \"—\"} MPa</span>\n                        <span className=\"text-muted-foreground\">Se′_used</span>\n                        <span>{derived.SePrime !== null && derived.SePrime !== undefined ? Number(derived.SePrime).toFixed(0) : \"—\"} MPa</span>\n                      </div>\n                      {Array.isArray((derived as any).strengthAssumptions) && (derived as any).strengthAssumptions.length > 0 && (\n                        <div className=\"text-xs text-muted-foreground mt-2 space-y-1\">\n                          {(derived as any).strengthAssumptions.slice(0, 6).map((s: string, idx: number) => (\n                            <div key={idx}>{s}</div>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"review\" className=\"space-y-4\">\n                <div className=\"flex items-center justify-between gap-3\">\n                  <div className=\"text-sm font-semibold\">{isZh ? \"工程评审\" : \"Engineering Review\"}</div>\n                  <Badge\n                    className={`${\n                      derived.review.overall === \"GREEN\"\n                        ? \"bg-emerald-600 text-white\"\n                        : derived.review.overall === \"YELLOW\"\n                          ? \"bg-amber-500 text-white\"\n                          : \"bg-red-600 text-white\"\n                    }`}\n                  >\n                    {derived.review.overall}\n                  </Badge>\n                </div>\n\n                <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-sm\">{isZh ? \"静强度\" : \"Static\"}</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      <Badge\n                        className={`${\n                          derived.review.staticRYG === \"GREEN\"\n                            ? \"bg-emerald-600 text-white\"\n                            : derived.review.staticRYG === \"YELLOW\"\n                              ? \"bg-amber-500 text-white\"\n                              : \"bg-red-600 text-white\"\n                        }`}\n                      >\n                        {derived.review.staticRYG}\n                      </Badge>\n                      <div className=\"text-xs text-muted-foreground\">Sy/σmax (bending)</div>\n                      <div className=\"text-sm font-medium\">\n                        {derived.review.staticSF !== null ? derived.review.staticSF.toFixed(2) : \"—\"}\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-sm\">{isZh ? \"疲劳\" : \"Fatigue\"}</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      <Badge\n                        className={`${\n                          derived.review.fatigueRYG === \"GREEN\"\n                            ? \"bg-emerald-600 text-white\"\n                            : derived.review.fatigueRYG === \"YELLOW\"\n                              ? \"bg-amber-500 text-white\"\n                              : \"bg-red-600 text-white\"\n                        }`}\n                      >\n                        {derived.review.fatigueRYG}\n                      </Badge>\n                      <div className=\"text-xs text-muted-foreground\">Goodman SF</div>\n                      <div className=\"text-sm font-medium\">\n                        {derived.review.fatigueSF !== null ? derived.review.fatigueSF.toFixed(2) : \"—\"}\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-sm\">{isZh ? \"贴合\" : \"Close-out\"}</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      <Badge\n                        className={`${\n                          derived.review.closeoutRYG === \"GREEN\"\n                            ? \"bg-emerald-600 text-white\"\n                            : derived.review.closeoutRYG === \"YELLOW\"\n                              ? \"bg-amber-500 text-white\"\n                              : \"bg-red-600 text-white\"\n                        }`}\n                      >\n                        {derived.review.closeoutRYG}\n                      </Badge>\n                      <div className=\"text-xs text-muted-foreground\">θmax/θco</div>\n                      <div className=\"text-sm font-medium\">\n                        {derived.review.closeoutRatio !== null ? derived.review.closeoutRatio.toFixed(2) : \"—\"}\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-sm\">{isZh ? \"几何\" : \"Geometry\"}</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      <Badge\n                        className={`${\n                          derived.review.geometryRYG === \"GREEN\"\n                            ? \"bg-emerald-600 text-white\"\n                            : derived.review.geometryRYG === \"YELLOW\"\n                              ? \"bg-amber-500 text-white\"\n                              : \"bg-red-600 text-white\"\n                        }`}\n                      >\n                        {derived.review.geometryRYG}\n                      </Badge>\n                      <div className=\"text-xs text-muted-foreground\">b/t</div>\n                      <div className=\"text-sm font-medium\">\n                        {derived.review.btRatio !== null ? derived.review.btRatio.toFixed(1) : \"—\"}\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-sm\">{isZh ? \"评审信息\" : \"Messages\"}</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {derived.review.messages.length === 0 ? (\n                      <div className=\"text-sm text-muted-foreground\">{isZh ? \"无\" : \"None\"}</div>\n                    ) : (\n                      <ul className=\"text-sm space-y-1\">\n                        {derived.review.messages.map((m, i) => (\n                          <li key={i} className=\"text-muted-foreground\">{m}</li>\n                        ))}\n                      </ul>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"ends\" className=\"space-y-4\">\n                <div className=\"space-y-2 rounded-md border border-border bg-muted/40 p-3\">\n                  <div className=\"text-sm font-medium\">{isZh ? \"端部应力集中 (Kt)\" : \"End Stress Concentration (Kt)\"}</div>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-xs text-muted-foreground\">{isZh ? \"内端\" : \"Inner End\"}</Label>\n                      <Select value={innerEndKtType} onValueChange={(v) => setInnerEndKtType(v as EndKtType)}>\n                        <SelectTrigger className=\"h-9\">\n                          <SelectValue placeholder={isZh ? \"选择端部形式\" : \"Select end type\"} />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {(Object.keys(END_KT_LABELS) as EndKtType[]).map((t) => {\n                            const label = isZh\n                              ? `${END_KT_LABELS[t].zh} / ${END_KT_LABELS[t].en}`\n                              : `${END_KT_LABELS[t].en} / ${END_KT_LABELS[t].zh}`;\n                            return (\n                              <SelectItem key={t} value={t}>\n                                {label}\n                              </SelectItem>\n                            );\n                          })}\n                        </SelectContent>\n                      </Select>\n                      <Input\n                        type=\"number\"\n                        step=\"0.1\"\n                        placeholder={END_KT_DEFAULTS[innerEndKtType].toString()}\n                        value={innerKtOverride ?? \"\"}\n                        onChange={(e) =>\n                          setInnerKtOverride(e.target.value === \"\" ? null : parseFloat(e.target.value) || null)\n                        }\n                        className=\"h-9\"\n                      />\n                    </div>\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-xs text-muted-foreground\">{isZh ? \"外端\" : \"Outer End\"}</Label>\n                      <Select value={outerEndKtType} onValueChange={(v) => setOuterEndKtType(v as EndKtType)}>\n                        <SelectTrigger className=\"h-9\">\n                          <SelectValue placeholder={isZh ? \"选择端部形式\" : \"Select end type\"} />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {(Object.keys(END_KT_LABELS) as EndKtType[]).map((t) => {\n                            const label = isZh\n                              ? `${END_KT_LABELS[t].zh} / ${END_KT_LABELS[t].en}`\n                              : `${END_KT_LABELS[t].en} / ${END_KT_LABELS[t].zh}`;\n                            return (\n                              <SelectItem key={t} value={t}>\n                                {label}\n                              </SelectItem>\n                            );\n                          })}\n                        </SelectContent>\n                      </Select>\n                      <Input\n                        type=\"number\"\n                        step=\"0.1\"\n                        placeholder={END_KT_DEFAULTS[outerEndKtType].toString()}\n                        value={outerKtOverride ?? \"\"}\n                        onChange={(e) =>\n                          setOuterKtOverride(e.target.value === \"\" ? null : parseFloat(e.target.value) || null)\n                        }\n                        className=\"h-9\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-2 text-sm mt-2\">\n                    <span className=\"text-muted-foreground\">governingKt:</span>\n                    <span className=\"font-medium\">{derived.governingKt.toFixed(2)}</span>\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">\n                    {isZh ? \"疲劳/峰值应力使用 governingKt × σ_nominal。\" : \"Fatigue and peak stress use governingKt × σ_nominal.\"}\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"fatigue\" className=\"space-y-4\">\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <div className=\"rounded-md border border-purple-200 bg-purple-50 p-4 text-slate-900 dark:border-purple-700 dark:bg-purple-950/30 dark:text-slate-100\">\n                    <div className=\"flex items-center justify-between gap-3\">\n                      <div className=\"text-sm font-semibold text-purple-900 dark:text-purple-200\">\n                        {isZh ? \"疲劳评估\" : \"Fatigue Assessment\"}\n                      </div>\n                      <div className=\"text-xs text-slate-600 dark:text-slate-300\">\n                        {isZh ? \"单位: MPa\" : \"Unit: MPa\"}\n                      </div>\n                    </div>\n\n                    <div className=\"mt-3 grid grid-cols-2 gap-3\">\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-slate-600 dark:text-slate-300\">{isZh ? \"准则\" : \"Criterion\"}</Label>\n                        <Select value={fatigueCriterion} onValueChange={(v) => setFatigueCriterion(v as typeof fatigueCriterion)}>\n                          <SelectTrigger className=\"h-9 bg-white/60 dark:bg-slate-950/20\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"goodman\">Goodman</SelectItem>\n                            <SelectItem value=\"gerber\">Gerber</SelectItem>\n                            <SelectItem value=\"soderberg\">Soderberg</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-slate-600 dark:text-slate-300\">{isZh ? \"选中准则 FoS\" : \"Selected FoS\"}</Label>\n                        <div\n                          className={`h-9 flex items-center rounded-md border px-3 text-sm font-semibold bg-white/60 dark:bg-slate-950/20 ${\n                            (derived.fatigueCriteria?.[fatigueCriterion] ?? null) !== null &&\n                            (derived.fatigueCriteria?.[fatigueCriterion] ?? 0) >= 1\n                              ? \"text-emerald-700 dark:text-emerald-300\"\n                              : \"text-amber-700 dark:text-amber-300\"\n                          }`}\n                        >\n                          {derived.fatigueCriteria?.[fatigueCriterion] !== null &&\n                          derived.fatigueCriteria?.[fatigueCriterion] !== undefined\n                            ? derived.fatigueCriteria[fatigueCriterion]!.toFixed(2)\n                            : \"—\"}\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"mt-3 grid grid-cols-2 gap-x-6 gap-y-2 text-sm\">\n                      <span className=\"text-slate-600 dark:text-slate-300\">σ_a (amplitude)</span>\n                      <span className=\"font-medium\">{derived.sigmaA.toFixed(1)}</span>\n                      <span className=\"text-slate-600 dark:text-slate-300\">σ_m (mean)</span>\n                      <span className=\"font-medium\">{derived.sigmaM.toFixed(1)}</span>\n                      <span className=\"text-slate-600 dark:text-slate-300\">Se (endurance)</span>\n                      <span className=\"font-medium\">{derived.Se !== null ? derived.Se.toFixed(0) : \"—\"}</span>\n                      <span className=\"text-slate-600 dark:text-slate-300\">Su (UTS)</span>\n                      <span className=\"font-medium\">{derived.Su !== null ? derived.Su.toFixed(0) : \"—\"}</span>\n                      <span className=\"text-slate-600 dark:text-slate-300\">FoS (Goodman)</span>\n                      <span className=\"font-medium\">{derived.fatigueCriteria?.goodman !== null ? derived.fatigueCriteria?.goodman?.toFixed(2) : \"—\"}</span>\n                      <span className=\"text-slate-600 dark:text-slate-300\">FoS (Gerber)</span>\n                      <span className=\"font-medium\">{derived.fatigueCriteria?.gerber !== null ? derived.fatigueCriteria?.gerber?.toFixed(2) : \"—\"}</span>\n                      <span className=\"text-slate-600 dark:text-slate-300\">FoS (Soderberg)</span>\n                      <span className=\"font-medium\">{derived.fatigueCriteria?.soderberg !== null ? derived.fatigueCriteria?.soderberg?.toFixed(2) : \"—\"}</span>\n                    </div>\n\n                    <div className=\"mt-3 text-xs text-slate-700 dark:text-slate-300\">\n                      {isZh\n                        ? \"默认评审使用 Goodman。σ 使用 governingKt×σ_nominal 修正。Goodman：σ_a/Se + σ_m/Su ≤ 1；Gerber：σ_a/Se + (σ_m/Su)^2 ≤ 1；Soderberg：σ_a/Se + σ_m/Sy ≤ 1。\"\n                        : \"Review uses Goodman by default. Stress is corrected using governingKt×σ_nominal. Goodman: σ_a/Se + σ_m/Su ≤ 1; Gerber: σ_a/Se + (σ_m/Su)^2 ≤ 1; Soderberg: σ_a/Se + σ_m/Sy ≤ 1.\"}\n                    </div>\n                  </div>\n\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-base\">{isZh ? \"疲劳图（σ_a–σ_m）\" : \"Fatigue Plot (σ_a–σ_m)\"}</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <GoodmanChart\n                        sigmaA={derived.sigmaA}\n                        sigmaM={derived.sigmaM}\n                        Se={derived.Se}\n                        Su={derived.Su}\n                        Sy={derived.Sy}\n                        criterion={fatigueCriterion}\n                        height={320}\n                      />\n                      <div className=\"mt-2 text-xs text-muted-foreground\">\n                        {fatigueCriterion === \"soderberg\"\n                          ? isZh\n                            ? \"当前选择为 Soderberg（需要 Sy）。\"\n                            : \"Current selection: Soderberg (requires Sy).\"\n                          : fatigueCriterion === \"gerber\"\n                            ? isZh\n                              ? \"当前选择为 Gerber。\"\n                              : \"Current selection: Gerber.\"\n                            : isZh\n                              ? \"当前选择为 Goodman。\"\n                              : \"Current selection: Goodman.\"}\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"tolerance\" className=\"space-y-4\">\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <div className=\"space-y-4\">\n                    <div className=\"grid grid-cols-2 gap-3\">\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-muted-foreground\">Δt (mm)</Label>\n                        <Input\n                          type=\"number\"\n                          step=\"0.01\"\n                          value={toleranceT}\n                          onChange={(e) => setToleranceT(parseFloat(e.target.value) || 0)}\n                        />\n                      </div>\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-muted-foreground\">Δb (mm)</Label>\n                        <Input\n                          type=\"number\"\n                          step=\"0.01\"\n                          value={toleranceB}\n                          onChange={(e) => setToleranceB(parseFloat(e.target.value) || 0)}\n                        />\n                      </div>\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-muted-foreground\">ΔL (mm)</Label>\n                        <Input\n                          type=\"number\"\n                          step=\"1\"\n                          value={toleranceL}\n                          onChange={(e) => setToleranceL(parseFloat(e.target.value) || 0)}\n                        />\n                      </div>\n                      <div className=\"space-y-1\">\n                        <Label className=\"text-xs text-muted-foreground\">ΔE</Label>\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          <Select value={toleranceEMode} onValueChange={(v) => setToleranceEMode(v as \"MPa\" | \"%\")}\n                          >\n                            <SelectTrigger className=\"h-9\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"MPa\">{isZh ? \"绝对值 (MPa)\" : \"Absolute (MPa)\"}</SelectItem>\n                              <SelectItem value=\"%\">{isZh ? \"百分比 (%)\" : \"Percent (%)\"}</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <Input\n                            type=\"number\"\n                            step={toleranceEMode === \"%\" ? 0.1 : 100}\n                            value={toleranceE}\n                            onChange={(e) => setToleranceE(parseFloat(e.target.value) || 0)}\n                            className=\"h-9\"\n                          />\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2 p-3 rounded-md bg-amber-900/30 border border-amber-700\">\n                      <div className=\"text-sm font-medium text-amber-300\">{isZh ? \"公差敏感性 (k ∝ b·t³/L)\" : \"Tolerance Sensitivity (k ∝ b·t³/L)\"}</div>\n                      <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                        <span className=\"text-slate-400\">k_min:</span>\n                        <span>{derived.kMin.toFixed(4)} N·mm/°</span>\n                        <span className=\"text-slate-400\">k_max:</span>\n                        <span>{derived.kMax.toFixed(4)} N·mm/°</span>\n                        <span className=\"text-slate-400\">T@θmax band:</span>\n                        <span>{derived.TMaxBandMin.toFixed(1)} ~ {derived.TMaxBandMax.toFixed(1)} N·mm</span>\n                      </div>\n                      <div className=\"text-xs text-slate-500\">\n                        {isZh ? \"敏感度排序：t(×3) > b(×1) ≈ L(×1)。\" : \"Sensitivity: t(×3) > b(×1) ≈ L(×1).\"}\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2 p-3 rounded-md bg-emerald-900/30 border border-emerald-700\">\n                      <div className=\"text-sm font-medium text-emerald-300\">{isZh ? \"公差敏感性\" : \"Tolerance Sensitivity\"}</div>\n                      <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                        <span className=\"text-slate-400\">k_min:</span>\n                        <span>{derived.kMin.toFixed(4)} N·mm/deg</span>\n                        <span className=\"text-slate-400\">k_max:</span>\n                        <span>{derived.kMax.toFixed(4)} N·mm/deg</span>\n                        <span className=\"text-slate-400\">T@θmax band:</span>\n                        <span>\n                          [{derived.TMaxBandMin.toFixed(1)} ~ {derived.TMaxBandMax.toFixed(1)}] N·mm\n                        </span>\n                        <span className=\"text-slate-400\">curve samples:</span>\n                        <span>{derived.torqueBandCurve.length}</span>\n                      </div>\n                      <div className=\"text-xs text-slate-500\">\n                        {isZh ? \"一阶近似：Δk/k ≈ Δb/b + 3Δt/t - ΔL/L。\" : \"First-order: Δk/k ≈ Δb/b + 3Δt/t - ΔL/L.\"}\n                      </div>\n                    </div>\n                  </div>\n\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-base\">{isZh ? \"扭矩-角度公差带\" : \"Torque–Angle Band\"}</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <SpiralTorqueBandChart data={derived.torqueBandCurve} height={320} />\n                    </CardContent>\n                  </Card>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"closeout\" className=\"space-y-4\">\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <div className=\"space-y-4\">\n                    <div className=\"space-y-1\">\n                      <Label className=\"text-xs text-muted-foreground\">Hardening Factor</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"1\"\n                        min={1}\n                        value={hardeningFactor}\n                        onChange={(e) => setHardeningFactor(Math.max(1, Math.round(parseFloat(e.target.value) || 1)))}\n                      />\n                    </div>\n\n                    <div className=\"space-y-2 p-3 rounded-md border border-border bg-muted/40\">\n                      <div className=\"flex items-center justify-between gap-3\">\n                        <div className=\"text-sm font-medium\">{isZh ? \"Close-out 渐进硬化模型\" : \"Close-out Progressive Hardening\"}</div>\n                        <label className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                          <input\n                            type=\"checkbox\"\n                            checked={enableNonlinearCloseout}\n                            onChange={(e) => setEnableNonlinearCloseout(e.target.checked)}\n                            className=\"size-4 rounded border-slate-300\"\n                          />\n                          {isZh ? \"启用\" : \"Enable\"}\n                        </label>\n                      </div>\n\n                      <div className=\"grid grid-cols-3 gap-3\">\n                        <div className=\"space-y-1\">\n                          <Label className=\"text-xs text-muted-foreground\">θ_contactStart (deg)</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"1\"\n                            min={0}\n                            max={Math.max(0, closeOutAngle)}\n                            value={thetaContactStartDeg}\n                            onChange={(e) => {\n                              thetaContactStartTouchedRef.current = true;\n                              setThetaContactStartDeg(parseFloat(e.target.value) || 0);\n                            }}\n                            className=\"h-9\"\n                          />\n                          {enableNonlinearCloseout &&\n                            (thetaContactStartDeg < 0 || thetaContactStartDeg > closeOutAngle) &&\n                            isFinite(closeOutAngle) &&\n                            closeOutAngle > 0 && (\n                              <div className=\"text-[11px] text-red-600 dark:text-red-300\">\n                                {isZh\n                                  ? \"要求：0 ≤ θ_contactStart ≤ θco\"\n                                  : \"Requirement: 0 ≤ thetaContactStart ≤ thetaCo\"}\n                              </div>\n                            )}\n                        </div>\n                        <div className=\"space-y-1\">\n                          <Label className=\"text-xs text-muted-foreground\">A</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"0.1\"\n                            value={hardeningA}\n                            onChange={(e) => setHardeningA(parseFloat(e.target.value) || 0)}\n                            className=\"h-9\"\n                          />\n                        </div>\n                        <div className=\"space-y-1\">\n                          <Label className=\"text-xs text-muted-foreground\">p</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"0.1\"\n                            value={hardeningP}\n                            onChange={(e) => setHardeningP(parseFloat(e.target.value) || 0)}\n                            className=\"h-9\"\n                          />\n                        </div>\n                      </div>\n\n                      {enableNonlinearCloseout && (\n                        <div className=\"grid grid-cols-2 gap-2 text-sm mt-2\">\n                          <span className=\"text-muted-foreground\">θ_contactStart_used:</span>\n                          <span>{derived.thetaContactStartUsed.toFixed(1)} deg</span>\n                          <span className=\"text-muted-foreground\">T@θmax (linear/clamped):</span>\n                          <span>{maxTorque.toFixed(1)} N·mm</span>\n                          <span className=\"text-muted-foreground\">T@θmax (nonlinear):</span>\n                          <span>{derived.nonlinearTorqueAtMax !== null ? derived.nonlinearTorqueAtMax.toFixed(1) : \"—\"} N·mm</span>\n                        </div>\n                      )}\n                      <div className=\"text-xs text-muted-foreground\">\n                        {isZh\n                          ? \"θ ≤ θ_contactStart 采用线性刚度；之后刚度按 k(θ)=k0·(1 + A·((θ-θc1)/(θco-θc1))^p) 增长，并数值积分得到 T(θ)。\"\n                          : \"For θ ≤ θ_contactStart, stiffness is linear; beyond that, k(θ)=k0·(1 + A·((θ-θc1)/(θco-θc1))^p) and T(θ) is obtained via numerical integration.\"}\n                      </div>\n                    </div>\n\n                    {derived.maxTorqueHardening !== null && (\n                      <div className=\"space-y-2 p-3 rounded-md bg-red-900/30 border border-red-700\">\n                        <div className=\"text-sm font-medium text-red-300\">{isZh ? \"Close-out 后非线性（估算）\" : \"Post Close-out Nonlinearity (Estimate)\"}</div>\n                        <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                          <span className=\"text-slate-400\">T_clamped:</span>\n                          <span>{maxTorque.toFixed(2)} N·mm</span>\n                          <span className=\"text-slate-400\">T_hardening:</span>\n                          <span className=\"font-medium text-red-200\">{derived.maxTorqueHardening.toFixed(2)} N·mm</span>\n                        </div>\n                        <div className=\"text-xs text-slate-500\">\n                          {isZh ? \"该值为分段硬化模型的粗略估算，用于风险提示，不作为供货图纸校核。\" : \"A rough piecewise hardening estimate for risk awareness; not for supplier drawing validation.\"}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-base\">{isZh ? \"贴合/硬化曲线\" : \"Close-out Curve\"}</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <SpiralCloseoutChart\n                        linear={derived.curveCloseoutLinear}\n                        nonlinear={derived.curveCloseoutNonlinear}\n                        thetaCoDeg={closeOutAngle}\n                        height={320}\n                      />\n                    </CardContent>\n                  </Card>\n                </div>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Advanced Analysis Panel */}\n      <SpiralAdvancedAnalysisPanel\n        isZh={isZh}\n        geometry={geometry}\n        springRate={springRate}\n        preloadTorque={preloadTorque}\n        maxTorque={maxTorque}\n        sigmaMin={derived.sigmaMin}\n        sigmaMax={derived.sigmaMax}\n        Su={derived.Su}\n        Se={derived.Se}\n      />\n\n      {/* Formula Reference */}\n      <Card className=\"mt-6\">\n        <CardHeader>\n          <CardTitle>{isZh ? \"公式参考 (Handbook of Spring Design)\" : \"Formula Reference (Handbook of Spring Design)\"}</CardTitle>\n        </CardHeader>\n        <CardContent className=\"text-sm text-slate-400 space-y-1\">\n          <p>M = πEbt³θ_rev/(6L)  (θ_rev in revolutions; θ_deg = 360·θ_rev)</p>\n          <p>k_rev = πEbt³/(6L), k_deg = k_rev/360</p>\n          <p>σ = 6M/(bt²) (弯曲应力, bending stress)</p>\n          <p className=\"text-amber-400\">⚠️ {isZh ? \"线性区仅在 θ ≤ θ_co 有效\" : \"Linear region valid only for θ ≤ θ_co\"}</p>\n        </CardContent>\n      </Card>\n    </main>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SpringTypeSpecificPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculateNominalShearStress' is defined but never used.","line":30,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":30,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'springRate' is defined but never used.","line":683,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":683,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\n/**\n * Spring Type Specific Analysis Panel\n * 弹簧类型特定分析面板\n * \n * Provides type-specific analysis for each spring type:\n * - Extension: Hook stress analysis\n * - Torsion: Leg stress analysis\n * - Conical: Per-coil stress distribution\n * - Compression: Buckling analysis (already in main panel)\n */\n\nimport { useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { AlertTriangle, CheckCircle, XCircle, Info } from \"lucide-react\";\nimport { useLanguage } from \"@/components/language-context\";\n\nimport type { SpringGeometry, SpringAnalysisResult } from \"@/lib/engine/types\";\nimport {\n  calculateHookStress,\n  type HookStressResult,\n  type HookType,\n  HOOK_FACTORS,\n} from \"@/lib/engine/hookStress\";\nimport {\n  calculateWahlFactor,\n  calculateNominalShearStress,\n} from \"@/lib/engine/stress\";\nimport { getSpringMaterial } from \"@/lib/materials/springMaterials\";\n\ninterface SpringTypeSpecificPanelProps {\n  geometry: SpringGeometry;\n  analysisResult: SpringAnalysisResult;\n  springRate: number;\n  maxForce: number;\n}\n\n// ============================================================================\n// Extension Spring Hook Analysis\n// ============================================================================\n\ninterface ExtensionHookAnalysisProps {\n  geometry: SpringGeometry & { type: \"extension\" };\n  maxForce: number;\n  bodyShearStress: number;\n  isZh: boolean;\n}\n\nfunction ExtensionHookAnalysis({\n  geometry,\n  maxForce,\n  bodyShearStress,\n  isZh,\n}: ExtensionHookAnalysisProps) {\n  const hookType = (geometry.hookType ?? \"machine\") as HookType;\n\n  const hookResult = useMemo<HookStressResult | null>(() => {\n    try {\n      return calculateHookStress(geometry, maxForce, bodyShearStress, hookType);\n    } catch {\n      return null;\n    }\n  }, [geometry, maxForce, bodyShearStress, hookType]);\n\n  if (!hookResult) {\n    return (\n      <div className=\"text-sm text-muted-foreground\">\n        {isZh ? \"无法计算钩环应力\" : \"Unable to calculate hook stress\"}\n      </div>\n    );\n  }\n\n  const statusColor =\n    hookResult.status === \"safe\"\n      ? \"bg-green-100 text-green-800\"\n      : hookResult.status === \"warning\"\n      ? \"bg-yellow-100 text-yellow-800\"\n      : \"bg-red-100 text-red-800\";\n\n  const StatusIcon =\n    hookResult.status === \"safe\"\n      ? CheckCircle\n      : hookResult.status === \"warning\"\n      ? AlertTriangle\n      : XCircle;\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Status Badge */}\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"text-sm font-medium\">\n          {isZh ? \"钩环应力分析\" : \"Hook Stress Analysis\"}\n        </h4>\n        <Badge className={statusColor}>\n          <StatusIcon className=\"mr-1 h-3 w-3\" />\n          {hookResult.status.toUpperCase()}\n        </Badge>\n      </div>\n\n      {/* Hook Type Info */}\n      <div className=\"rounded-lg bg-slate-50 p-3 text-sm\">\n        <div className=\"flex justify-between\">\n          <span className=\"text-muted-foreground\">{isZh ? \"钩型\" : \"Hook Type\"}</span>\n          <span className=\"font-medium\">\n            {isZh\n              ? HOOK_FACTORS[hookType].description.zh\n              : HOOK_FACTORS[hookType].description.en}\n          </span>\n        </div>\n        <div className=\"mt-1 flex justify-between\">\n          <span className=\"text-muted-foreground\">\n            {isZh ? \"应力集中系数 Kf\" : \"Stress Concentration Kf\"}\n          </span>\n          <span className=\"font-medium\">{hookResult.stressConcentrationFactor.toFixed(2)}</span>\n        </div>\n      </div>\n\n      {/* Stress Values */}\n      <div className=\"grid grid-cols-2 gap-3\">\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"text-xs text-muted-foreground\">\n            {isZh ? \"弯曲应力\" : \"Bending Stress\"}\n          </div>\n          <div className=\"text-lg font-semibold\">\n            {hookResult.bendingStress.toFixed(0)} <span className=\"text-sm font-normal\">MPa</span>\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"text-xs text-muted-foreground\">\n            {isZh ? \"扭转应力\" : \"Torsional Stress\"}\n          </div>\n          <div className=\"text-lg font-semibold\">\n            {hookResult.torsionalStress.toFixed(0)} <span className=\"text-sm font-normal\">MPa</span>\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"text-xs text-muted-foreground\">\n            {isZh ? \"组合应力 (von Mises)\" : \"Combined Stress (von Mises)\"}\n          </div>\n          <div className=\"text-lg font-semibold\">\n            {hookResult.combinedStress.toFixed(0)} <span className=\"text-sm font-normal\">MPa</span>\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"text-xs text-muted-foreground\">\n            {isZh ? \"本体剪应力\" : \"Body Shear Stress\"}\n          </div>\n          <div className=\"text-lg font-semibold\">\n            {bodyShearStress.toFixed(0)} <span className=\"text-sm font-normal\">MPa</span>\n          </div>\n        </div>\n      </div>\n\n      {/* Safety Factors Comparison */}\n      <div className=\"space-y-2\">\n        <div className=\"flex items-center justify-between text-sm\">\n          <span>{isZh ? \"钩环安全系数\" : \"Hook Safety Factor\"}</span>\n          <span\n            className={`font-medium ${\n              hookResult.hookSafetyFactor < 1.2 ? \"text-red-600\" : \"\"\n            }`}\n          >\n            {hookResult.hookSafetyFactor.toFixed(2)}\n          </span>\n        </div>\n        <Progress\n          value={Math.min(100, (hookResult.hookSafetyFactor / 3) * 100)}\n          className=\"h-2\"\n        />\n\n        <div className=\"flex items-center justify-between text-sm\">\n          <span>{isZh ? \"本体安全系数\" : \"Body Safety Factor\"}</span>\n          <span className=\"font-medium\">{hookResult.bodySafetyFactor.toFixed(2)}</span>\n        </div>\n        <Progress\n          value={Math.min(100, (hookResult.bodySafetyFactor / 3) * 100)}\n          className=\"h-2\"\n        />\n      </div>\n\n      {/* Critical Location */}\n      <div\n        className={`rounded-lg p-3 text-sm ${\n          hookResult.criticalLocation !== \"body\"\n            ? \"bg-yellow-50 text-yellow-800\"\n            : \"bg-green-50 text-green-800\"\n        }`}\n      >\n        <div className=\"flex items-start gap-2\">\n          <Info className=\"mt-0.5 h-4 w-4 flex-shrink-0\" />\n          <span>{isZh ? hookResult.message.zh : hookResult.message.en}</span>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Torsion Spring Leg Analysis\n// ============================================================================\n\ninterface TorsionLegAnalysisProps {\n  geometry: SpringGeometry & { type: \"torsion\" };\n  maxTorque: number;\n  bodyBendingStress: number;\n  isZh: boolean;\n}\n\nfunction TorsionLegAnalysis({\n  geometry,\n  maxTorque,\n  bodyBendingStress,\n  isZh,\n}: TorsionLegAnalysisProps) {\n  const material = getSpringMaterial(geometry.materialId);\n  const allowableStress = material?.allowShearStatic ?? 800;\n\n  // Calculate leg stresses\n  const legAnalysis = useMemo(() => {\n    const { wireDiameter, legLength1, legLength2 } = geometry;\n    const PI = Math.PI;\n\n    // Leg bending stress: σ = 32 * F * L / (π * d³)\n    // Force at leg tip = Torque / arm length\n    // For simplicity, assume force acts at leg tip\n\n    // Leg 1 stress (longer leg typically has higher stress)\n    const forceAtLeg1 = maxTorque / (legLength1 || wireDiameter * 5);\n    const leg1BendingStress = (32 * forceAtLeg1 * (legLength1 || wireDiameter * 5)) / \n                              (PI * Math.pow(wireDiameter, 3));\n\n    // Leg 2 stress\n    const forceAtLeg2 = maxTorque / (legLength2 || wireDiameter * 5);\n    const leg2BendingStress = (32 * forceAtLeg2 * (legLength2 || wireDiameter * 5)) / \n                              (PI * Math.pow(wireDiameter, 3));\n\n    // Apply stress concentration at leg root (typically 1.2-1.5)\n    const legStressConcentration = 1.3;\n    const leg1EffectiveStress = leg1BendingStress * legStressConcentration;\n    const leg2EffectiveStress = leg2BendingStress * legStressConcentration;\n\n    // Safety factors\n    const leg1SafetyFactor = allowableStress / leg1EffectiveStress;\n    const leg2SafetyFactor = allowableStress / leg2EffectiveStress;\n    const bodySafetyFactor = allowableStress / bodyBendingStress;\n\n    // Critical location\n    const minLegSF = Math.min(leg1SafetyFactor, leg2SafetyFactor);\n    const criticalLocation = minLegSF < bodySafetyFactor * 0.9 \n      ? (leg1SafetyFactor < leg2SafetyFactor ? \"leg1\" : \"leg2\")\n      : \"body\";\n\n    // Status\n    const minSF = Math.min(minLegSF, bodySafetyFactor);\n    const status = minSF >= 1.5 ? \"safe\" : minSF >= 1.2 ? \"warning\" : \"danger\";\n\n    return {\n      leg1: {\n        length: legLength1 || wireDiameter * 5,\n        bendingStress: leg1BendingStress,\n        effectiveStress: leg1EffectiveStress,\n        safetyFactor: leg1SafetyFactor,\n      },\n      leg2: {\n        length: legLength2 || wireDiameter * 5,\n        bendingStress: leg2BendingStress,\n        effectiveStress: leg2EffectiveStress,\n        safetyFactor: leg2SafetyFactor,\n      },\n      stressConcentration: legStressConcentration,\n      bodySafetyFactor,\n      criticalLocation,\n      status,\n    };\n  }, [geometry, maxTorque, bodyBendingStress, allowableStress]);\n\n  const statusColor =\n    legAnalysis.status === \"safe\"\n      ? \"bg-green-100 text-green-800\"\n      : legAnalysis.status === \"warning\"\n      ? \"bg-yellow-100 text-yellow-800\"\n      : \"bg-red-100 text-red-800\";\n\n  const StatusIcon =\n    legAnalysis.status === \"safe\"\n      ? CheckCircle\n      : legAnalysis.status === \"warning\"\n      ? AlertTriangle\n      : XCircle;\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Status Badge */}\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"text-sm font-medium\">\n          {isZh ? \"腿部应力分析\" : \"Leg Stress Analysis\"}\n        </h4>\n        <Badge className={statusColor}>\n          <StatusIcon className=\"mr-1 h-3 w-3\" />\n          {legAnalysis.status.toUpperCase()}\n        </Badge>\n      </div>\n\n      {/* Leg 1 */}\n      <div className=\"rounded-lg border p-3\">\n        <div className=\"mb-2 flex items-center justify-between\">\n          <span className=\"font-medium\">{isZh ? \"腿 1\" : \"Leg 1\"}</span>\n          <span className=\"text-sm text-muted-foreground\">\n            L = {legAnalysis.leg1.length.toFixed(1)} mm\n          </span>\n        </div>\n        <div className=\"grid grid-cols-2 gap-2 text-sm\">\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"弯曲应力\" : \"Bending Stress\"}</span>\n            <div className=\"font-semibold\">{legAnalysis.leg1.effectiveStress.toFixed(0)} MPa</div>\n          </div>\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"安全系数\" : \"Safety Factor\"}</span>\n            <div\n              className={`font-semibold ${\n                legAnalysis.leg1.safetyFactor < 1.2 ? \"text-red-600\" : \"\"\n              }`}\n            >\n              {legAnalysis.leg1.safetyFactor.toFixed(2)}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Leg 2 */}\n      <div className=\"rounded-lg border p-3\">\n        <div className=\"mb-2 flex items-center justify-between\">\n          <span className=\"font-medium\">{isZh ? \"腿 2\" : \"Leg 2\"}</span>\n          <span className=\"text-sm text-muted-foreground\">\n            L = {legAnalysis.leg2.length.toFixed(1)} mm\n          </span>\n        </div>\n        <div className=\"grid grid-cols-2 gap-2 text-sm\">\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"弯曲应力\" : \"Bending Stress\"}</span>\n            <div className=\"font-semibold\">{legAnalysis.leg2.effectiveStress.toFixed(0)} MPa</div>\n          </div>\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"安全系数\" : \"Safety Factor\"}</span>\n            <div\n              className={`font-semibold ${\n                legAnalysis.leg2.safetyFactor < 1.2 ? \"text-red-600\" : \"\"\n              }`}\n            >\n              {legAnalysis.leg2.safetyFactor.toFixed(2)}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Body Comparison */}\n      <div className=\"rounded-lg bg-slate-50 p-3\">\n        <div className=\"flex justify-between text-sm\">\n          <span className=\"text-muted-foreground\">{isZh ? \"本体弯曲应力\" : \"Body Bending Stress\"}</span>\n          <span className=\"font-medium\">{bodyBendingStress.toFixed(0)} MPa</span>\n        </div>\n        <div className=\"mt-1 flex justify-between text-sm\">\n          <span className=\"text-muted-foreground\">{isZh ? \"本体安全系数\" : \"Body Safety Factor\"}</span>\n          <span className=\"font-medium\">{legAnalysis.bodySafetyFactor.toFixed(2)}</span>\n        </div>\n        <div className=\"mt-1 flex justify-between text-sm\">\n          <span className=\"text-muted-foreground\">{isZh ? \"腿根应力集中系数\" : \"Leg Root Stress Concentration\"}</span>\n          <span className=\"font-medium\">{legAnalysis.stressConcentration.toFixed(2)}</span>\n        </div>\n      </div>\n\n      {/* Critical Location */}\n      <div\n        className={`rounded-lg p-3 text-sm ${\n          legAnalysis.criticalLocation !== \"body\"\n            ? \"bg-yellow-50 text-yellow-800\"\n            : \"bg-green-50 text-green-800\"\n        }`}\n      >\n        <div className=\"flex items-start gap-2\">\n          <Info className=\"mt-0.5 h-4 w-4 flex-shrink-0\" />\n          <span>\n            {legAnalysis.criticalLocation === \"body\"\n              ? isZh\n                ? \"本体为关键位置，腿部应力在安全范围内\"\n                : \"Body is critical location, leg stresses are within safe range\"\n              : isZh\n              ? `${legAnalysis.criticalLocation === \"leg1\" ? \"腿 1\" : \"腿 2\"} 为关键位置，建议增加腿长或减小载荷`\n              : `${legAnalysis.criticalLocation === \"leg1\" ? \"Leg 1\" : \"Leg 2\"} is critical, consider increasing leg length or reducing load`}\n          </span>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Conical Spring Per-Coil Analysis\n// ============================================================================\n\ninterface ConicalCoilAnalysisProps {\n  geometry: SpringGeometry & { type: \"conical\" };\n  maxForce: number;\n  isZh: boolean;\n}\n\nfunction ConicalCoilAnalysis({\n  geometry,\n  maxForce,\n  isZh,\n}: ConicalCoilAnalysisProps) {\n  const material = getSpringMaterial(geometry.materialId);\n  const allowableStress = material?.allowShearStatic ?? 800;\n\n  // Calculate per-coil stress distribution\n  const coilAnalysis = useMemo(() => {\n    const { wireDiameter, largeOuterDiameter, smallOuterDiameter, activeCoils } = geometry;\n    const PI = Math.PI;\n\n    const largeMean = largeOuterDiameter - wireDiameter;\n    const smallMean = smallOuterDiameter - wireDiameter;\n    const diameterStep = (largeMean - smallMean) / (activeCoils - 1 || 1);\n\n    const coils: Array<{\n      index: number;\n      meanDiameter: number;\n      springIndex: number;\n      wahlFactor: number;\n      shearStress: number;\n      safetyFactor: number;\n      isCollapsed: boolean;\n    }> = [];\n\n    // Calculate stress for each coil (from large to small)\n    for (let i = 0; i < activeCoils; i++) {\n      const meanDiameter = largeMean - i * diameterStep;\n      const springIndex = meanDiameter / wireDiameter;\n      const wahlFactor = calculateWahlFactor(springIndex);\n      const nominalStress = (8 * maxForce * meanDiameter) / (PI * Math.pow(wireDiameter, 3));\n      const shearStress = nominalStress * wahlFactor;\n      const safetyFactor = allowableStress / shearStress;\n\n      // Simplified collapse check (coil collapses when deflection exceeds pitch)\n      const isCollapsed = false; // Would need deflection info for accurate calculation\n\n      coils.push({\n        index: i + 1,\n        meanDiameter,\n        springIndex,\n        wahlFactor,\n        shearStress,\n        safetyFactor,\n        isCollapsed,\n      });\n    }\n\n    // Find critical coil (highest stress = largest diameter)\n    const criticalCoil = coils[0];\n    const minSafetyFactor = Math.min(...coils.map((c) => c.safetyFactor));\n    const status = minSafetyFactor >= 1.5 ? \"safe\" : minSafetyFactor >= 1.2 ? \"warning\" : \"danger\";\n\n    return {\n      coils,\n      criticalCoil,\n      minSafetyFactor,\n      status,\n      stressRatio: coils[coils.length - 1].shearStress / coils[0].shearStress,\n    };\n  }, [geometry, maxForce, allowableStress]);\n\n  const statusColor =\n    coilAnalysis.status === \"safe\"\n      ? \"bg-green-100 text-green-800\"\n      : coilAnalysis.status === \"warning\"\n      ? \"bg-yellow-100 text-yellow-800\"\n      : \"bg-red-100 text-red-800\";\n\n  const StatusIcon =\n    coilAnalysis.status === \"safe\"\n      ? CheckCircle\n      : coilAnalysis.status === \"warning\"\n      ? AlertTriangle\n      : XCircle;\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Status Badge */}\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"text-sm font-medium\">\n          {isZh ? \"逐圈应力分析\" : \"Per-Coil Stress Analysis\"}\n        </h4>\n        <Badge className={statusColor}>\n          <StatusIcon className=\"mr-1 h-3 w-3\" />\n          {coilAnalysis.status.toUpperCase()}\n        </Badge>\n      </div>\n\n      {/* Stress Distribution Summary */}\n      <div className=\"rounded-lg bg-slate-50 p-3\">\n        <div className=\"flex justify-between text-sm\">\n          <span className=\"text-muted-foreground\">{isZh ? \"大端应力（最大）\" : \"Large End Stress (Max)\"}</span>\n          <span className=\"font-medium text-red-600\">\n            {coilAnalysis.coils[0].shearStress.toFixed(0)} MPa\n          </span>\n        </div>\n        <div className=\"mt-1 flex justify-between text-sm\">\n          <span className=\"text-muted-foreground\">{isZh ? \"小端应力（最小）\" : \"Small End Stress (Min)\"}</span>\n          <span className=\"font-medium text-green-600\">\n            {coilAnalysis.coils[coilAnalysis.coils.length - 1].shearStress.toFixed(0)} MPa\n          </span>\n        </div>\n        <div className=\"mt-1 flex justify-between text-sm\">\n          <span className=\"text-muted-foreground\">{isZh ? \"应力比（小/大）\" : \"Stress Ratio (Small/Large)\"}</span>\n          <span className=\"font-medium\">{coilAnalysis.stressRatio.toFixed(2)}</span>\n        </div>\n      </div>\n\n      {/* Per-Coil Table */}\n      <div className=\"max-h-48 overflow-y-auto rounded-lg border\">\n        <table className=\"w-full text-sm\">\n          <thead className=\"sticky top-0 bg-slate-100\">\n            <tr>\n              <th className=\"px-2 py-1 text-left\">{isZh ? \"圈\" : \"Coil\"}</th>\n              <th className=\"px-2 py-1 text-right\">Dm (mm)</th>\n              <th className=\"px-2 py-1 text-right\">C</th>\n              <th className=\"px-2 py-1 text-right\">τ (MPa)</th>\n              <th className=\"px-2 py-1 text-right\">SF</th>\n            </tr>\n          </thead>\n          <tbody>\n            {coilAnalysis.coils.map((coil) => (\n              <tr\n                key={coil.index}\n                className={coil.index === 1 ? \"bg-red-50\" : \"\"}\n              >\n                <td className=\"px-2 py-1\">{coil.index}</td>\n                <td className=\"px-2 py-1 text-right\">{coil.meanDiameter.toFixed(1)}</td>\n                <td className=\"px-2 py-1 text-right\">{coil.springIndex.toFixed(1)}</td>\n                <td className=\"px-2 py-1 text-right\">{coil.shearStress.toFixed(0)}</td>\n                <td\n                  className={`px-2 py-1 text-right ${\n                    coil.safetyFactor < 1.2 ? \"text-red-600 font-medium\" : \"\"\n                  }`}\n                >\n                  {coil.safetyFactor.toFixed(2)}\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n\n      {/* Critical Coil Info */}\n      <div className=\"rounded-lg bg-yellow-50 p-3 text-sm text-yellow-800\">\n        <div className=\"flex items-start gap-2\">\n          <AlertTriangle className=\"mt-0.5 h-4 w-4 flex-shrink-0\" />\n          <span>\n            {isZh\n              ? `关键位置：第 1 圈（大端），应力 ${coilAnalysis.criticalCoil.shearStress.toFixed(0)} MPa，安全系数 ${coilAnalysis.criticalCoil.safetyFactor.toFixed(2)}`\n              : `Critical: Coil 1 (large end), stress ${coilAnalysis.criticalCoil.shearStress.toFixed(0)} MPa, SF ${coilAnalysis.criticalCoil.safetyFactor.toFixed(2)}`}\n          </span>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ============================================================================\n// Compression Spring Buckling Summary (Already in main panel, just summary here)\n// ============================================================================\n\ninterface CompressionBucklingSummaryProps {\n  analysisResult: SpringAnalysisResult;\n  isZh: boolean;\n}\n\nfunction CompressionBucklingSummary({\n  analysisResult,\n  isZh,\n}: CompressionBucklingSummaryProps) {\n  const buckling = analysisResult.buckling;\n\n  if (!buckling) {\n    return (\n      <div className=\"text-sm text-muted-foreground\">\n        {isZh ? \"屈曲分析不适用\" : \"Buckling analysis not applicable\"}\n      </div>\n    );\n  }\n\n  const statusColor =\n    buckling.status === \"safe\"\n      ? \"bg-green-100 text-green-800\"\n      : buckling.status === \"warning\"\n      ? \"bg-yellow-100 text-yellow-800\"\n      : \"bg-red-100 text-red-800\";\n\n  const StatusIcon =\n    buckling.status === \"safe\"\n      ? CheckCircle\n      : buckling.status === \"warning\"\n      ? AlertTriangle\n      : XCircle;\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Status Badge */}\n      <div className=\"flex items-center justify-between\">\n        <h4 className=\"text-sm font-medium\">\n          {isZh ? \"屈曲稳定性分析\" : \"Buckling Stability Analysis\"}\n        </h4>\n        <Badge className={statusColor}>\n          <StatusIcon className=\"mr-1 h-3 w-3\" />\n          {buckling.status.toUpperCase()}\n        </Badge>\n      </div>\n\n      {/* Buckling Parameters */}\n      <div className=\"grid grid-cols-2 gap-3\">\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"text-xs text-muted-foreground\">\n            {isZh ? \"细长比 λ\" : \"Slenderness Ratio λ\"}\n          </div>\n          <div className=\"text-lg font-semibold\">{buckling.slendernessRatio.toFixed(2)}</div>\n        </div>\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"text-xs text-muted-foreground\">\n            {isZh ? \"工作载荷\" : \"Working Load\"}\n          </div>\n          <div className=\"text-lg font-semibold\">\n            {buckling.workingLoad.toFixed(1)} <span className=\"text-sm font-normal\">N</span>\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"text-xs text-muted-foreground\">\n            {isZh ? \"临界载荷\" : \"Critical Load\"}\n          </div>\n          <div className=\"text-lg font-semibold\">\n            {buckling.criticalLoad.toFixed(1)} <span className=\"text-sm font-normal\">N</span>\n          </div>\n        </div>\n        <div className=\"rounded-lg border p-3\">\n          <div className=\"text-xs text-muted-foreground\">\n            {isZh ? \"屈曲安全系数\" : \"Buckling Safety Factor\"}\n          </div>\n          <div\n            className={`text-lg font-semibold ${\n              buckling.bucklingSafetyFactor < 1.2 ? \"text-red-600\" : \"\"\n            }`}\n          >\n            {buckling.bucklingSafetyFactor.toFixed(2)}\n          </div>\n        </div>\n      </div>\n\n      {/* Recommendation */}\n      {buckling.status !== \"safe\" && (\n        <div className=\"rounded-lg bg-yellow-50 p-3 text-sm text-yellow-800\">\n          <div className=\"flex items-start gap-2\">\n            <AlertTriangle className=\"mt-0.5 h-4 w-4 flex-shrink-0\" />\n            <span>\n              {isZh\n                ? \"建议：减小自由长度、增大平均直径、或使用导向装置\"\n                : \"Recommendation: Reduce free length, increase mean diameter, or use guide\"}\n            </span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function SpringTypeSpecificPanel({\n  geometry,\n  analysisResult,\n  springRate,\n  maxForce,\n}: SpringTypeSpecificPanelProps) {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  const bodyStress = analysisResult.stress.tauEffective;\n\n  // Render type-specific content\n  const renderContent = () => {\n    switch (geometry.type) {\n      case \"extension\":\n        return (\n          <ExtensionHookAnalysis\n            geometry={geometry}\n            maxForce={maxForce}\n            bodyShearStress={bodyStress}\n            isZh={isZh}\n          />\n        );\n\n      case \"torsion\":\n        return (\n          <TorsionLegAnalysis\n            geometry={geometry}\n            maxTorque={maxForce} // For torsion springs, \"force\" is actually torque\n            bodyBendingStress={analysisResult.stress.bendingStress ?? bodyStress}\n            isZh={isZh}\n          />\n        );\n\n      case \"conical\":\n        return (\n          <ConicalCoilAnalysis\n            geometry={geometry}\n            maxForce={maxForce}\n            isZh={isZh}\n          />\n        );\n\n      case \"compression\":\n        return (\n          <CompressionBucklingSummary\n            analysisResult={analysisResult}\n            isZh={isZh}\n          />\n        );\n\n      default:\n        return (\n          <div className=\"text-sm text-muted-foreground\">\n            {isZh ? \"无类型特定分析\" : \"No type-specific analysis available\"}\n          </div>\n        );\n    }\n  };\n\n  // Get title based on spring type\n  const getTitle = () => {\n    switch (geometry.type) {\n      case \"extension\":\n        return isZh ? \"拉伸弹簧 - 钩环分析\" : \"Extension Spring - Hook Analysis\";\n      case \"torsion\":\n        return isZh ? \"扭转弹簧 - 腿部分析\" : \"Torsion Spring - Leg Analysis\";\n      case \"conical\":\n        return isZh ? \"锥形弹簧 - 逐圈分析\" : \"Conical Spring - Per-Coil Analysis\";\n      case \"compression\":\n        return isZh ? \"压缩弹簧 - 屈曲分析\" : \"Compression Spring - Buckling Analysis\";\n      default:\n        return isZh ? \"类型特定分析\" : \"Type-Specific Analysis\";\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-lg\">{getTitle()}</CardTitle>\n      </CardHeader>\n      <CardContent>{renderContent()}</CardContent>\n    </Card>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/StressColorLegend.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SuspensionAnalysisPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'i' is defined but never used.","line":59,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":59,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":151,"column":134,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":137,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5883,5886],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5883,5886],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'geometry' is defined but never used.","line":235,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":235,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'material' is defined but never used.","line":235,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":235,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'analysis' is defined but never used.","line":357,"column":65,"nodeType":null,"messageId":"unusedVar","endLine":357,"endColumn":73},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SuspensionAnalysisPanel.tsx:373:9\n  371 |       if (cached) {\n  372 |         const parsedResult: FeaResult = JSON.parse(cached);\n> 373 |         setFeaResult(parsedResult);\n      |         ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  374 |         setFeaStatus(parsedResult.status === \"success\" ? \"done\" : \"error\");\n  375 |         // Also notify parent of cached force\n  376 |         if (parsedResult.status === \"success\" && parsedResult.results?.steps[0]?.reaction_force_z) {","line":373,"column":9,"nodeType":null,"endLine":373,"endColumn":21},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SuspensionAnalysisPanel.tsx:608:5\n  606 |   // Reset state if critical design parameters change\n  607 |   useEffect(() => {\n> 608 |     setIsDone(false);\n      |     ^^^^^^^^^ Avoid calling setState() directly within an effect\n  609 |     onFeaComplete?.(null);\n  610 |   }, [geometry.wireDiameter, geometry.activeCoils, geometry.diameterProfile?.DmStart, material.shearModulus]);\n  611 |","line":608,"column":5,"nodeType":null,"endLine":608,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'onFeaComplete'. Either include it or remove the dependency array. If 'onFeaComplete' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":610,"column":6,"nodeType":"ArrayExpression","endLine":610,"endColumn":109,"suggestions":[{"desc":"Update the dependencies array to be: [geometry.wireDiameter, geometry.activeCoils, geometry.diameterProfile.DmStart, material.shearModulus, onFeaComplete]","fix":{"range":[25153,25256],"text":"[geometry.wireDiameter, geometry.activeCoils, geometry.diameterProfile.DmStart, material.shearModulus, onFeaComplete]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'analysisResult' is defined but never used.","line":740,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":740,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showStressContour' is assigned a value but never used.","line":768,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":768,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setShowStressContour' is assigned a value but never used.","line":768,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":768,"endColumn":49},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/analysis/SuspensionAnalysisPanel.tsx:780:7\n  778 |   useEffect(() => {\n  779 |     if (feaForce !== null) {\n> 780 |       setDisplayMode(\"engineering\");\n      |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  781 |     }\n  782 |   }, [feaForce]);\n  783 |","line":780,"column":7,"nodeType":null,"endLine":780,"endColumn":21}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Suspension Spring Analysis Panel\n * 减震器弹簧工程分析面板\n * \n * MVP Features:\n * - Summary Bar with key KPIs\n * - k(x) nonlinear stiffness curve visualization\n * - Fatigue estimation (Goodman)\n * - Design rules summary\n */\n\n\"use client\";\n\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { ArrowLeft, AlertTriangle, CheckCircle, XCircle, Loader2 } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { useMemo, useState, useCallback, useEffect } from \"react\";\nimport dynamic from \"next/dynamic\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { SuspensionGeometry, MaterialInfo, AnalysisResult } from \"@/lib/stores/springDesignStore\";\nimport { runSuspensionAnalysis, type SuspensionAnalysisResult } from \"@/lib/suspensionSpring/analysis\";\nimport { calculateSuspensionSpring } from \"@/lib/suspensionSpring/math\";\nimport type { SuspensionSpringInput } from \"@/lib/suspensionSpring/types\";\n\nconst SuspensionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/SuspensionSpringVisualizer\").then((mod) => mod.SuspensionSpringVisualizer),\n  {\n    ssr: false,\n    loading: () => (\n      <div className=\"h-[350px] bg-slate-50 rounded-lg flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-slate-500\" />\n      </div>\n    ),\n  }\n);\n\ninterface SuspensionAnalysisPanelProps {\n  isZh: boolean;\n  geometry: SuspensionGeometry;\n  material: MaterialInfo;\n  analysisResult: AnalysisResult;\n}\n\n// Simple line chart component for k(x) curve\nfunction KxCurveChart({ data, isZh }: { data: { x: number; k: number; hasContact: boolean }[]; isZh: boolean }) {\n  if (data.length < 2) return null;\n\n  const maxX = Math.max(...data.map(d => d.x));\n  const maxK = Math.max(...data.map(d => d.k));\n  const minK = Math.min(...data.map(d => d.k));\n  const kRange = maxK - minK || 1;\n\n  const width = 400;\n  const height = 200;\n  const padding = 40;\n\n  const points = data.map((d, i) => {\n    const x = padding + (d.x / maxX) * (width - 2 * padding);\n    const y = height - padding - ((d.k - minK) / kRange) * (height - 2 * padding);\n    return `${x},${y}`;\n  }).join(' ');\n\n  // Find contact onset point\n  const contactIndex = data.findIndex(d => d.hasContact);\n  const contactPoint = contactIndex >= 0 ? data[contactIndex] : null;\n\n  return (\n    <div className=\"flex flex-col items-center\">\n      <svg viewBox={`0 0 ${width} ${height}`} className=\"w-full max-w-md\">\n        {/* Axes */}\n        <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke=\"#888\" strokeWidth=\"1\" />\n        <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke=\"#888\" strokeWidth=\"1\" />\n        \n        {/* Axis labels */}\n        <text x={width / 2} y={height - 8} textAnchor=\"middle\" className=\"text-xs fill-muted-foreground\">\n          {isZh ? \"变形 x (mm)\" : \"Deflection x (mm)\"}\n        </text>\n        <text x={12} y={height / 2} textAnchor=\"middle\" transform={`rotate(-90, 12, ${height / 2})`} className=\"text-xs fill-muted-foreground\">\n          k (N/mm)\n        </text>\n\n        {/* Grid lines */}\n        {[0.25, 0.5, 0.75, 1].map(t => (\n          <line key={t} x1={padding + t * (width - 2 * padding)} y1={padding} x2={padding + t * (width - 2 * padding)} y2={height - padding} stroke=\"#ddd\" strokeWidth=\"0.5\" />\n        ))}\n\n        {/* Contact zone shading */}\n        {contactPoint && (\n          <rect\n            x={padding + (contactPoint.x / maxX) * (width - 2 * padding)}\n            y={padding}\n            width={(1 - contactPoint.x / maxX) * (width - 2 * padding)}\n            height={height - 2 * padding}\n            fill=\"rgba(251, 191, 36, 0.1)\"\n          />\n        )}\n\n        {/* Curve */}\n        <polyline\n          points={points}\n          fill=\"none\"\n          stroke=\"#3b82f6\"\n          strokeWidth=\"2\"\n        />\n\n        {/* Contact onset marker */}\n        {contactPoint && (\n          <>\n            <circle\n              cx={padding + (contactPoint.x / maxX) * (width - 2 * padding)}\n              cy={height - padding - ((contactPoint.k - minK) / kRange) * (height - 2 * padding)}\n              r=\"4\"\n              fill=\"#f59e0b\"\n            />\n            <text\n              x={padding + (contactPoint.x / maxX) * (width - 2 * padding) + 8}\n              y={height - padding - ((contactPoint.k - minK) / kRange) * (height - 2 * padding) - 8}\n              className=\"text-xs fill-amber-600\"\n            >\n              {isZh ? \"接触起始\" : \"Contact\"}\n            </text>\n          </>\n        )}\n\n        {/* Value labels */}\n        <text x={padding - 5} y={height - padding + 5} textAnchor=\"end\" className=\"text-xs fill-muted-foreground\">0</text>\n        <text x={width - padding} y={height - padding + 15} textAnchor=\"middle\" className=\"text-xs fill-muted-foreground\">{maxX.toFixed(0)}</text>\n        <text x={padding - 5} y={padding + 5} textAnchor=\"end\" className=\"text-xs fill-muted-foreground\">{maxK.toFixed(1)}</text>\n        <text x={padding - 5} y={height - padding - 5} textAnchor=\"end\" className=\"text-xs fill-muted-foreground\">{minK.toFixed(1)}</text>\n      </svg>\n      <p className=\"text-xs text-muted-foreground mt-2\">\n        {isZh ? \"黄色区域：圈-圈接触开始，刚度非线性增加\" : \"Yellow zone: Coil contact begins, stiffness increases nonlinearly\"}\n      </p>\n    </div>\n  );\n}\n\n// FEA Tab Component\ninterface FeaTabProps {\n  isZh: boolean;\n  geometry: SuspensionGeometry;\n  material: MaterialInfo;\n  calcResult: ReturnType<typeof calculateSuspensionSpring>;\n  analysis: SuspensionAnalysisResult;\n  onFeaComplete?: (force: number | null) => void;\n}\n\n// Option A: NVH Analysis Tab\nfunction NvhTab({ isZh, calcResult, loadcase }: { isZh: boolean, calcResult: ReturnType<typeof calculateSuspensionSpring>, loadcase: any }) {\n  const dyn = calcResult.dynamics;\n  \n  if (!dyn) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-sm\">\n            {isZh ? \"NVH & 动态分析\" : \"NVH & Dynamic Analysis\"}\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-sm text-muted-foreground italic\">\n            {isZh ? \"请输入车辆簧下质量(Corner Mass)以进行频率分析\" : \"Please provide corner mass to enable frequency analysis\"}\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const rideFreq = dyn.naturalFreq_Hz;\n  const targetFreq = loadcase.targetFreq_Hz;\n  const diff = targetFreq ? Math.abs(rideFreq - targetFreq) : 0;\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-sm\">\n          {isZh ? \"NVH & 动态分析\" : \"NVH & Dynamic Analysis\"}\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        <div className=\"grid grid-cols-2 gap-6\">\n          <div className=\"space-y-1\">\n            <span className=\"text-xs text-muted-foreground\">{isZh ? \"车轮刚度 (Wheel Rate)\" : \"Wheel Rate\"}</span>\n            <p className=\"text-2xl font-mono font-bold text-primary\">\n              {dyn.wheelRate_N_per_mm.toFixed(1)} <span className=\"text-xs font-normal\">N/mm</span>\n            </p>\n          </div>\n          <div className=\"space-y-1\">\n            <span className=\"text-xs text-muted-foreground\">{isZh ? \"固有频率 (Natural Frequency)\" : \"Natural Frequency\"}</span>\n            <p className=\"text-2xl font-mono font-bold text-primary\">\n              {rideFreq.toFixed(2)} <span className=\"text-xs font-normal\">Hz</span>\n            </p>\n          </div>\n        </div>\n\n        {targetFreq && (\n          <div className={`p-3 rounded-lg flex items-center gap-3 ${diff < 0.2 ? 'bg-emerald-50 text-emerald-700' : 'bg-amber-50 text-amber-700'}`}>\n            {diff < 0.2 ? <CheckCircle className=\"w-5 h-5\" /> : <AlertTriangle className=\"w-5 h-5\" />}\n            <div className=\"text-xs\">\n              <p className=\"font-semibold\">{isZh ? \"目标频率对比\" : \"Target Frequency Comparison\"}</p>\n              <p className=\"opacity-90\">\n                {isZh \n                  ? `当前比目标 (${targetFreq}Hz) ${rideFreq > targetFreq ? \"偏高\" : \"偏低\"} ${diff.toFixed(2)}Hz` \n                  : `Currently ${diff.toFixed(2)}Hz ${rideFreq > targetFreq ? \"higher\" : \"lower\"} than target (${targetFreq}Hz)`}\n              </p>\n            </div>\n          </div>\n        )}\n\n        <div className=\"space-y-2\">\n          <h4 className=\"text-xs font-semibold\">{isZh ? \"NVH 风险提示\" : \"NVH Risk Profile\"}</h4>\n          <div className=\"grid grid-cols-3 gap-2 text-[10px] uppercase font-bold text-center\">\n            <div className={`p-2 rounded ${rideFreq < 1.0 ? 'bg-blue-100 text-blue-700' : 'bg-muted text-muted-foreground opacity-50'}`}>\n              Soft/Boat\n            </div>\n            <div className={`p-2 rounded ${rideFreq >= 1.0 && rideFreq <= 2.2 ? 'bg-emerald-100 text-emerald-700 border border-emerald-300' : 'bg-muted text-muted-foreground opacity-50'}`}>\n              Standard\n            </div>\n            <div className={`p-2 rounded ${rideFreq > 2.2 ? 'bg-red-100 text-red-700' : 'bg-muted text-muted-foreground opacity-50'}`}>\n              Stiff/Racing\n            </div>\n          </div>\n          <p className=\"text-[10px] text-muted-foreground italic mt-2\">\n            * {isZh ? \"基于单轮质量模型的估算值。1.0-2.2Hz 属于乘用车常规区间。\" : \"Estimated via quarter-car model. 1.0-2.2Hz is standard for passenger cars.\"}\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\n// Option A: Engineering Conclusion & Expert Designer Suggestions\nfunction ConclusionTab({ isZh, geometry, material, calcResult, analysis }: { isZh: boolean, geometry: SuspensionGeometry, material: MaterialInfo, calcResult: ReturnType<typeof calculateSuspensionSpring>, analysis: SuspensionAnalysisResult }) {\n  const sfBump = calcResult.stress.yieldSafetyFactor_bump;\n  const coilBindMargin = calcResult.bumpHeight_mm - calcResult.derived.solidHeight_Hs_mm;\n  const fatigueSF = analysis.fatigue?.fatigueSF ?? 0;\n  \n  const rules = [];\n  \n  if (sfBump < 1.1) {\n    rules.push({\n      status: \"fail\",\n      title: isZh ? \"屈服强度不足\" : \"Insufficent Yield Strength\",\n      desc: isZh ? `Bump 工况安全系数仅 ${sfBump.toFixed(2)}，远低于 1.1。` : `Safety factor at Bump is only ${sfBump.toFixed(2)}, well below 1.1.`,\n      advice: isZh ? \"建议：增加线径 d 或更换高等级材料（如 55CrSi）。\" : \"Advice: Increase wire diameter d or upgrade to higher grade material (e.g., 55CrSi).\"\n    });\n  } else if (sfBump < 1.3) {\n    rules.push({\n      status: \"warning\",\n      title: isZh ? \"强度余量较低\" : \"Low Strength Margin\",\n      desc: isZh ? `安全系数 ${sfBump.toFixed(2)} 勉强及格。` : `Safety factor ${sfBump.toFixed(2)} is marginal.`,\n      advice: isZh ? \"建议：优化卷数 Na 以降低应力水平。\" : \"Advice: Optimize active coils Na to lower stress levels.\"\n    });\n  }\n\n  if (coilBindMargin < 3) {\n    rules.push({\n      status: \"fail\",\n      title: isZh ? \"并紧余量过小\" : \"Low Coil Bind Margin\",\n      desc: isZh ? `最大压缩时余量仅 ${coilBindMargin.toFixed(1)}mm (标准 ≥3mm)。` : `Margin at max bump is only ${coilBindMargin.toFixed(1)}mm (Standard ≥3mm).`,\n      advice: isZh ? \"建议：增加自由长 Hf 或减少总圈数 Nt。\" : \"Advice: Increase free length Hf or reduce total coils Nt.\"\n    });\n  }\n\n  const fatiguePass = fatigueSF > 1.2;\n  if (!fatiguePass && fatigueSF > 0) {\n    rules.push({\n      status: \"warning\",\n      title: isZh ? \"疲劳寿命中等\" : \"Moderate Fatigue Life\",\n      desc: isZh ? \"Goodman 判定点接近包络线边缘。\" : \"Goodman point is near the envelope boundary.\",\n      advice: isZh ? \"建议：确保护油喷丸工艺(Shot Peened)或降低预载。\" : \"Advice: Ensure shot peening or reduce preload.\"\n    });\n  }\n\n  if (rules.length === 0) {\n    rules.push({\n      status: \"pass\",\n      title: isZh ? \"设计完美\" : \"Design Optimized\",\n      desc: isZh ? \"所有工程指标均在安全区间内。\" : \"All engineering metrics are within safety limits.\",\n      advice: isZh ? \"建议：可以尝试减轻重量以优化成本。\" : \"Advice: Consider weight reduction for cost optimization.\"\n    });\n  }\n\n  const overallStatus = rules.some(r => r.status === \"fail\") ? \"fail\" : rules.some(r => r.status === \"warning\") ? \"warning\" : \"pass\";\n\n  return (\n    <Card className={`border-2 ${overallStatus === \"fail\" ? \"border-red-200\" : overallStatus === \"warning\" ? \"border-amber-200\" : \"border-emerald-200\"}`}>\n      <CardHeader>\n        <CardTitle className=\"text-sm flex items-center justify-between\">\n          <span>{isZh ? \"工程结论 & 改进建议\" : \"Engineering Conclusion & Advice\"}</span>\n          <Badge className={overallStatus === \"fail\" ? \"bg-red-500\" : overallStatus === \"warning\" ? \"bg-amber-500\" : \"bg-emerald-500\"}>\n            {overallStatus === \"fail\" ? (isZh ? \"不合格\" : \"FAIL\") : overallStatus === \"warning\" ? (isZh ? \"临界\" : \"MARGINAL\") : (isZh ? \"合格\" : \"PASS\")}\n          </Badge>\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {rules.map((rule, i) => (\n          <div key={i} className={`p-3 rounded-lg border-l-4 ${rule.status === \"fail\" ? \"bg-red-50 border-red-500\" : rule.status === \"warning\" ? \"bg-amber-50 border-amber-500\" : \"bg-emerald-50 border-emerald-500\"}`}>\n            <h5 className=\"font-bold text-sm mb-1\">{rule.title}</h5>\n            <p className=\"text-xs opacity-80 mb-2\">{rule.desc}</p>\n            <p className=\"text-xs font-semibold text-primary\">{rule.advice}</p>\n          </div>\n        ))}\n        \n        <div className=\"pt-4 border-t text-[10px] text-muted-foreground italic\">\n          {isZh ? \"* 以上建议由 AI 设计专家系统基于标准底盘工程经验生成，仅供参考。\" : \"* Advice generated by AI Expert System based on chassis engineering best practices.\"}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\ninterface FeaResult {\n  job_id: string;\n  status: \"success\" | \"failed\" | \"error\";\n  elapsed_ms: number;\n  results?: {\n    success: boolean;\n    converged: boolean;\n    steps: Array<{\n      step_number: number;\n      step_name: string;\n      reaction_force_z: number;  // Axial reaction force in N\n      max_displacement_z: number;\n      max_stress: number;\n      max_stress_node: number;\n    }>;\n    node_stresses?: Array<{\n      nodeId: number;\n      vonMises: number;\n      x: number;\n      y: number;\n      z: number;\n    }>;\n    max_stress: number;\n  };\n  error_message?: string;\n}\n\n// Generate a stable cache key based on design parameters\nfunction generateFeaCacheKey(geometry: SuspensionGeometry, material: MaterialInfo, calcResult: ReturnType<typeof calculateSuspensionSpring>): string {\n  const keyData = {\n    wd: geometry.wireDiameter.toFixed(2),\n    dm: (geometry.diameterProfile?.DmStart ?? 100).toFixed(1),\n    na: geometry.activeCoils.toFixed(1),\n    nt: geometry.totalCoils.toFixed(1),\n    l0: geometry.freeLength.toFixed(1),\n    G: material.shearModulus,\n    rh: calcResult.rideHeight_mm.toFixed(1),\n    bh: calcResult.bumpHeight_mm.toFixed(1),\n  };\n  return `fea-cache-${JSON.stringify(keyData)}`;\n}\n\nfunction CalculixFeaTab({ isZh, geometry, material, calcResult, analysis, onFeaComplete }: FeaTabProps) {\n  const [feaStatus, setFeaStatus] = useState<\"idle\" | \"running\" | \"done\" | \"error\">(\"idle\");\n  const [feaResult, setFeaResult] = useState<FeaResult | null>(null);\n  const [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n  // Cache key based on design parameters\n  const cacheKey = useMemo(() => \n    generateFeaCacheKey(geometry, material, calcResult),\n  [geometry, material, calcResult]);\n\n  // Load cached result on mount or when cache key changes\n  useEffect(() => {\n    try {\n      const cached = localStorage.getItem(cacheKey);\n      if (cached) {\n        const parsedResult: FeaResult = JSON.parse(cached);\n        setFeaResult(parsedResult);\n        setFeaStatus(parsedResult.status === \"success\" ? \"done\" : \"error\");\n        // Also notify parent of cached force\n        if (parsedResult.status === \"success\" && parsedResult.results?.steps[0]?.reaction_force_z) {\n          onFeaComplete?.(parsedResult.results.steps[0].reaction_force_z);\n        }\n      } else {\n        // No cache for new design - reset state\n        setFeaResult(null);\n        setFeaStatus(\"idle\");\n        onFeaComplete?.(null);\n      }\n    } catch (e) {\n      // Ignore localStorage errors\n      console.warn(\"Failed to load FEA cache:\", e);\n    }\n  }, [cacheKey, onFeaComplete]);\n\n  const runFea = useCallback(async () => {\n    setFeaStatus(\"running\");\n    setErrorMsg(null);\n    \n    try {\n      const response = await fetch(\"/api/fea/jobs\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          design_code: `SUSP-${Date.now().toString(36).toUpperCase()}`,\n          geometry: {\n            wire_diameter: geometry.wireDiameter,\n            mean_diameter: geometry.diameterProfile?.DmStart ?? 100,\n            active_coils: geometry.activeCoils,\n            total_coils: geometry.totalCoils,\n            free_length: geometry.freeLength,\n            end_type: geometry.pitchProfile?.endType ?? \"closed_ground\",\n            dm_start: geometry.diameterProfile?.DmStart,\n            dm_mid: geometry.diameterProfile?.DmMid,\n            dm_end: geometry.diameterProfile?.DmEnd,\n          },\n          material: {\n            E: 206000,\n            nu: 0.3,\n            G: material.shearModulus,\n            name: \"STEEL\"\n          },\n          loadcases: [\n            { name: \"RIDE\", target_height: calcResult.rideHeight_mm },\n            { name: \"BUMP\", target_height: calcResult.bumpHeight_mm },\n          ],\n          mesh_level: \"medium\"\n        }),\n      });\n      \n      const result: FeaResult = await response.json();\n      setFeaResult(result);\n      setFeaStatus(result.status === \"success\" ? \"done\" : \"error\");\n      if (result.error_message) setErrorMsg(result.error_message);\n      \n      // Save to cache\n      try {\n        localStorage.setItem(cacheKey, JSON.stringify(result));\n      } catch (e) {\n        console.warn(\"Failed to save FEA cache:\", e);\n      }\n      \n      // Notify parent of FEA completion with reaction force\n      if (result.status === \"success\" && result.results?.steps[0]?.reaction_force_z) {\n        onFeaComplete?.(result.results.steps[0].reaction_force_z);\n      } else {\n        onFeaComplete?.(null);\n      }\n      \n    } catch (err) {\n      setFeaStatus(\"error\");\n      setErrorMsg(String(err));\n      onFeaComplete?.(null);\n    }\n  }, [geometry, material, calcResult, cacheKey, onFeaComplete]);\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center justify-between\">\n          <span>{isZh ? \"FEA 验证 (CalculiX)\" : \"FEA Validation (CalculiX)\"}</span>\n          <Button \n            onClick={runFea} \n            disabled={feaStatus === \"running\"}\n            size=\"sm\"\n          >\n            {feaStatus === \"running\" ? (\n              <>\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                {isZh ? \"运行中...\" : \"Running...\"}\n              </>\n            ) : (\n              isZh ? \"运行 FEA\" : \"Run FEA\"\n            )}\n          </Button>\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {feaStatus === \"idle\" && (\n          <p className=\"text-muted-foreground text-sm\">\n            {isZh \n              ? \"点击 \\\"运行 FEA\\\" 使用 CalculiX 进行静力分析验证\"\n              : \"Click \\\"Run FEA\\\" to validate with CalculiX static analysis\"\n            }\n          </p>\n        )}\n        \n        {feaStatus === \"error\" && (\n          <div className=\"p-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-sm text-red-700 dark:text-red-300\">\n            {errorMsg || (isZh ? \"FEA 分析失败\" : \"FEA analysis failed\")}\n          </div>\n        )}\n        \n        {feaStatus === \"done\" && feaResult?.results && (\n          <>\n            <div className=\"p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg text-sm\">\n              <p className=\"font-medium text-emerald-700 dark:text-emerald-300\">\n                ✓ {isZh ? \"FEA 完成\" : \"FEA Complete\"} ({feaResult.elapsed_ms}ms)\n              </p>\n            </div>\n            \n            {/* Comparison Table - Reaction Force based */}\n            {(() => {\n              // Spring geometry for stress calculation\n              const d = geometry.wireDiameter;  // mm\n              const D = geometry.diameterProfile?.DmStart ?? 100;  // mm\n              const c = D / d;  // Spring index\n              const K = (4 * c - 1) / (4 * c - 4) + 0.615 / c;  // Wahl correction factor\n              \n              // Get FEA reaction force (convert to same load case if available)\n              const feaRf = feaResult.results?.steps[0]?.reaction_force_z ?? 0;\n              \n              // Calculate shear stress from FEA force: τ = 8 * F * K * D / (π * d³)\n              const feaTau = feaRf > 0 ? (8 * feaRf * K * D) / (Math.PI * Math.pow(d, 3)) : 0;\n              \n              // Analytical values\n              const analyticTau = calcResult.stress.tauRide_MPa;\n              const analyticForce = calcResult.forces.ride_N;\n              \n              // Delta percentage\n              const deltaForce = analyticForce > 0 ? ((feaRf - analyticForce) / analyticForce * 100) : 0;\n              const deltaTau = analyticTau > 0 ? ((feaTau - analyticTau) / analyticTau * 100) : 0;\n              \n              return (\n                <div className=\"overflow-x-auto\">\n                  <table className=\"w-full text-sm\">\n                    <thead>\n                      <tr className=\"border-b\">\n                        <th className=\"text-left py-2\">{isZh ? \"指标\" : \"Metric\"}</th>\n                        <th className=\"text-right py-2\">{isZh ? \"解析\" : \"Analytic\"}</th>\n                        <th className=\"text-right py-2\">FEA</th>\n                        <th className=\"text-right py-2\">Δ%</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      <tr className=\"border-b\">\n                        <td className=\"py-2\">F_ride (N)</td>\n                        <td className=\"text-right font-mono\">{analyticForce.toFixed(1)}</td>\n                        <td className=\"text-right font-mono text-emerald-600 dark:text-emerald-400\">\n                          {feaRf > 0 ? feaRf.toFixed(1) : \"-\"}\n                        </td>\n                        <td className=\"text-right font-mono text-muted-foreground\">\n                          {feaRf > 0 ? `${deltaForce > 0 ? \"+\" : \"\"}${deltaForce.toFixed(1)}%` : \"-\"}\n                        </td>\n                      </tr>\n                      <tr className=\"border-b\">\n                        <td className=\"py-2\">τ_ride (MPa)</td>\n                        <td className=\"text-right font-mono\">{analyticTau.toFixed(0)}</td>\n                        <td className=\"text-right font-mono text-emerald-600 dark:text-emerald-400\">\n                          {feaTau > 0 ? feaTau.toFixed(0) : \"-\"}\n                        </td>\n                        <td className=\"text-right font-mono text-muted-foreground\">\n                          {feaTau > 0 ? `${deltaTau > 0 ? \"+\" : \"\"}${deltaTau.toFixed(1)}%` : \"-\"}\n                        </td>\n                      </tr>\n                      <tr>\n                        <td className=\"py-2\">{isZh ? \"偏差状态\" : \"Deviation Status\"}</td>\n                        <td className=\"text-right font-mono\">-</td>\n                        <td className=\"text-right font-mono\" colSpan={2}>\n                          {Math.abs(deltaForce) < 10 ? (\n                            <span className=\"text-emerald-600 dark:text-emerald-400\">\n                              ✓ {isZh ? \"在 ±10% 内\" : \"Within ±10%\"}\n                            </span>\n                          ) : Math.abs(deltaForce) < 20 ? (\n                            <span className=\"text-yellow-600 dark:text-yellow-400\">\n                              ⚠ {isZh ? \"偏差较大\" : \"Moderate deviation\"}\n                            </span>\n                          ) : (\n                            <span className=\"text-red-600 dark:text-red-400\">\n                              ✗ {isZh ? \"偏差过大\" : \"Large deviation\"}\n                            </span>\n                          )}\n                        </td>\n                      </tr>\n                    </tbody>\n                  </table>\n                </div>\n              );\n            })()}\n            \n            <p className=\"text-xs text-muted-foreground\">\n              {isZh \n                ? \"FEA 使用 B32 二次梁单元模型，应力由 τ = 8FKD/(πd³) 从反力计算\"\n                : \"FEA uses B32 quadratic beam model, stress calculated from τ = 8FKD/(πd³)\"\n              }\n            </p>\n          </>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction BeamTheoryTab({ isZh, geometry, material, calcResult, onFeaComplete }: FeaTabProps) {\n  const [isCalculating, setIsCalculating] = useState(false);\n  const [isDone, setIsDone] = useState(false);\n\n  const runEstimation = useCallback(() => {\n    setIsCalculating(true);\n    setIsDone(false);\n    \n    // Simulate a brief local calculation delay\n    setTimeout(() => {\n      setIsCalculating(false);\n      setIsDone(true);\n      // Automatically send analytical force to 3D preview\n      onFeaComplete?.(calcResult.forces.ride_N);\n    }, 600);\n  }, [calcResult.forces.ride_N, onFeaComplete]);\n\n  // Reset state if critical design parameters change\n  useEffect(() => {\n    setIsDone(false);\n    onFeaComplete?.(null);\n  }, [geometry.wireDiameter, geometry.activeCoils, geometry.diameterProfile?.DmStart, material.shearModulus]);\n\n  return (\n    <Card className=\"border-emerald-100 dark:border-emerald-900/30\">\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-base flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Badge variant=\"outline\" className=\"text-emerald-600 border-emerald-200 bg-emerald-50/50\">\n              {isZh ? \"快速估算\" : \"Quick Estimate\"}\n            </Badge>\n            <span>{isZh ? \"基于梁理论的应力分析\" : \"Beam Theory Stress Analysis\"}</span>\n          </div>\n          <Button \n            disabled={isCalculating} \n            onClick={runEstimation}\n            size=\"sm\"\n          >\n            {isCalculating ? (\n              <><Loader2 className=\"w-4 h-4 mr-2 animate-spin\" /> {isZh ? \"计算中...\" : \"Calculating...\"}</>\n            ) : (\n              isZh ? \"开始计算\" : \"Start Calculation\"\n            )}\n          </Button>\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {!isDone && !isCalculating && (\n          <div className=\"text-center py-6 text-muted-foreground border-2 border-dashed rounded-lg\">\n            <p className=\"text-sm\">{isZh ? \"点击计算以根据解析刚度生成应力云图\" : \"Click calculate to generate stress contour based on analytical stiffness\"}</p>\n          </div>\n        )}\n\n        {isCalculating && (\n          <div className=\"flex flex-col items-center justify-center py-10 space-y-3\">\n            <Loader2 className=\"w-8 h-8 text-primary animate-spin\" />\n            <p className=\"text-sm animate-pulse\">{isZh ? \"正在求解刚度矩阵...\" : \"Solving stiffness matrix...\"}</p>\n          </div>\n        )}\n\n        {isDone && (\n          <>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg\">\n                <p className=\"text-xs text-muted-foreground\">{isZh ? \"反力 (F_ride)\" : \"Reaction Force\"}</p>\n                <p className=\"text-xl font-bold font-mono text-emerald-700 dark:text-emerald-300\">\n                  {calcResult.forces.ride_N.toFixed(1)} N\n                </p>\n              </div>\n              <div className=\"p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg\">\n                <p className=\"text-xs text-muted-foreground\">{isZh ? \"最大剪应力 (τ_max)\" : \"Max Shear Stress\"}</p>\n                <p className=\"text-xl font-bold font-mono text-emerald-700 dark:text-emerald-300\">\n                  {calcResult.stress.tauRide_MPa.toFixed(0)} MPa\n                </p>\n              </div>\n            </div>\n\n            <div className=\"p-3 border rounded-lg bg-muted/30 text-xs space-y-2\">\n              <p className=\"font-semibold\">{isZh ? \"理论基础\" : \"Theoretical Basis\"}</p>\n              <ul className=\"list-disc list-inside space-y-1 opacity-80\">\n                <li>{isZh ? \"受载力: F = k * (L0 - L_ride)\" : \"Load: F = k * (L0 - L_ride)\"}</li>\n                <li>{isZh ? \"剪应力: τ = 8 * F * K * D / (π * d³)\" : \"Shear Stress: τ = 8 * F * K * D / (π * d³)\"}</li>\n                <li>{isZh ? \"死圈应力衰减模型 (20%-100%)\" : \"Dead coil stress attenuation model (20%-100%)\"}</li>\n              </ul>\n            </div>\n\n            <div className=\"flex items-center gap-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-xs text-blue-700 dark:text-blue-300\">\n              <CheckCircle className=\"w-4 h-4\" />\n              <span>{isZh ? \"数据已同步至 3D 预览\" : \"Data synchronized to 3D Preview\"}</span>\n            </div>\n          </>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction FeaTab({ isZh, geometry, material, calcResult, analysis, onFeaComplete }: FeaTabProps) {\n  const [method, setMethod] = useState<\"estimate\" | \"calculix\">(\"estimate\");\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex bg-muted p-1 rounded-md text-xs\">\n          <button \n            onClick={() => setMethod(\"estimate\")}\n            className={`px-3 py-1.5 rounded-sm transition-all ${method === \"estimate\" ? \"bg-background shadow-sm font-medium\" : \"text-muted-foreground hover:text-foreground\"}`}\n          >\n            {isZh ? \"快速估算\" : \"Quick Estimate\"}\n          </button>\n          <button \n            onClick={() => setMethod(\"calculix\")}\n            className={`px-3 py-1.5 rounded-sm transition-all ${method === \"calculix\" ? \"bg-background shadow-sm font-medium\" : \"text-muted-foreground hover:text-foreground\"}`}\n          >\n            {isZh ? \"CalculiX FEA (耗时)\" : \"CalculiX FEA\"}\n          </button>\n        </div>\n        <span className=\"text-[10px] text-muted-foreground italic\">\n          {method === \"estimate\" \n            ? (isZh ? \"无需服务器，即时响应\" : \"No server required, instant\")\n            : (isZh ? \"云端高精度计算\" : \"High precision cloud compute\")}\n        </span>\n      </div>\n\n      {method === \"estimate\" ? (\n        <BeamTheoryTab \n          isZh={isZh}\n          geometry={geometry}\n          material={material}\n          calcResult={calcResult}\n          analysis={analysis}\n          onFeaComplete={onFeaComplete}\n        />\n      ) : (\n        <CalculixFeaTab \n          isZh={isZh}\n          geometry={geometry}\n          material={material}\n          calcResult={calcResult}\n          analysis={analysis}\n          onFeaComplete={onFeaComplete}\n        />\n      )}\n    </div>\n  );\n}\n\nexport function SuspensionAnalysisPanel({\n  isZh,\n  geometry,\n  material,\n  analysisResult,\n}: SuspensionAnalysisPanelProps) {\n  // Build input for analysis\n  const input: SuspensionSpringInput = useMemo(() => ({\n    geometry: {\n      od_mm: geometry.wireDiameter + (geometry.diameterProfile?.DmStart ?? 100),\n      wireDiameter_mm: geometry.wireDiameter,\n      activeCoils_Na: geometry.activeCoils,\n      totalCoils_Nt: geometry.totalCoils,\n      freeLength_Hf_mm: geometry.freeLength,\n      endType: geometry.pitchProfile?.endType ?? \"closed_ground\",\n      guide: {},\n    },\n    material: {\n      shearModulus_G_MPa: material.shearModulus,\n      yieldStrength_MPa: material.tensileStrength ? material.tensileStrength * 0.7 : 1200,\n      fatigueLimit_MPa: material.tensileStrength ? material.tensileStrength * 0.4 : 600,\n    },\n    loadcase: {\n      preload_N: 500,\n      rideLoad_N: 2000,\n      bumpTravel_mm: 80,\n      solidMargin_mm: 3,\n    },\n  }), [geometry, material]);\n\n  // FEA stress visualization state\n  const [feaForce, setFeaForce] = useState<number | null>(null);\n  const [showStressContour, setShowStressContour] = useState(true);\n\n  const handleFeaComplete = useCallback((force: number | null) => {\n    setFeaForce(force);\n  }, []);\n\n  // 3D Preview Display Mode\n  const [displayMode, setDisplayMode] = useState<\"geometry\" | \"engineering\">(\"geometry\");\n  \n  // Update display mode automatically when FEA results arrive, but keep manual control\n  useEffect(() => {\n    if (feaForce !== null) {\n      setDisplayMode(\"engineering\");\n    }\n  }, [feaForce]);\n\n  const calcResult = useMemo(() => calculateSuspensionSpring(input), [input]);\n\n  // Run analysis\n  const analysis: SuspensionAnalysisResult | null = useMemo(() => {\n    if (calcResult.errors.length > 0) return null;\n    return runSuspensionAnalysis(input, calcResult);\n  }, [input, calcResult]);\n\n  // Determine overall status\n  const overallStatus = useMemo(() => {\n    if (!analysis) return \"error\";\n    if (analysis.summary.sfBump < 1.0) return \"fail\";\n    if (analysis.summary.coilBindMargin < 3) return \"warning\";\n    if (analysis.fatigue?.lifeClass === \"fail\") return \"fail\";\n    if (analysis.fatigue?.lifeClass === \"low\") return \"warning\";\n    return \"pass\";\n  }, [analysis]);\n\n  if (!analysis) {\n    return (\n      <main className=\"container mx-auto py-8 px-4\">\n        <div className=\"mb-4\">\n          <Link href=\"/tools/suspension-spring\">\n            <Button variant=\"outline\" size=\"sm\">\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              {isZh ? \"返回计算器\" : \"Back to Calculator\"}\n            </Button>\n          </Link>\n        </div>\n        <Card>\n          <CardContent className=\"py-8 text-center text-red-600\">\n            {isZh ? \"分析失败：无有效设计数据\" : \"Analysis failed: No valid design data\"}\n          </CardContent>\n        </Card>\n      </main>\n    );\n  }\n\n  return (\n    <main className=\"container mx-auto py-8 px-4\">\n      {/* Header */}\n      <div className=\"mb-6\">\n        <div className=\"flex gap-2 mb-4\">\n          <Link href=\"/tools/suspension-spring\">\n            <Button variant=\"outline\" size=\"sm\">\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              {isZh ? \"返回计算器\" : \"Back to Calculator\"}\n            </Button>\n          </Link>\n        </div>\n        <h1 className=\"text-2xl font-bold mb-2\">\n          {isZh ? \"减震器弹簧工程分析\" : \"Suspension Spring Engineering Analysis\"}\n        </h1>\n        <p className=\"text-muted-foreground\">\n          {isZh ? \"解析级分析 + k(x) 非线性刚度曲线 + 疲劳评估\" : \"Analytic analysis + k(x) nonlinear stiffness + Fatigue assessment\"}\n        </p>\n      </div>\n\n      {/* Summary Bar */}\n      <div className={`mb-6 p-4 rounded-lg border ${\n        overallStatus === \"pass\" \n          ? \"bg-emerald-500/10 border-emerald-500/50\" \n          : overallStatus === \"warning\"\n            ? \"bg-amber-500/10 border-amber-500/50\"\n            : \"bg-red-500/10 border-red-500/50\"\n      }`}>\n        <div className=\"flex items-center gap-3 mb-3\">\n          {overallStatus === \"pass\" && <CheckCircle className=\"w-6 h-6 text-emerald-500\" />}\n          {overallStatus === \"warning\" && <AlertTriangle className=\"w-6 h-6 text-amber-500\" />}\n          {overallStatus === \"fail\" && <XCircle className=\"w-6 h-6 text-red-500\" />}\n          <span className={`font-semibold ${\n            overallStatus === \"pass\" ? \"text-emerald-500\" \n            : overallStatus === \"warning\" ? \"text-amber-500\" \n            : \"text-red-500\"\n          }`}>\n            {overallStatus === \"pass\" && (isZh ? \"✓ 设计通过\" : \"✓ Design Passed\")}\n            {overallStatus === \"warning\" && (isZh ? \"⚠️ 需要注意\" : \"⚠️ Review Needed\")}\n            {overallStatus === \"fail\" && (isZh ? \"❌ 设计不合格\" : \"❌ Design Failed\")}\n          </span>\n        </div>\n\n        {/* KPI Grid */}\n        <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm\">\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"刚度\" : \"Rate\"} k₀</span>\n            <p className=\"font-mono font-semibold\">{analysis.summary.kFree.toFixed(1)} N/mm</p>\n          </div>\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"Bump刚度\" : \"k@Bump\"}</span>\n            <p className=\"font-mono font-semibold\">{analysis.summary.kBump.toFixed(1)} N/mm</p>\n          </div>\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"最大应力\" : \"Max τ\"}</span>\n            <p className=\"font-mono font-semibold\">{analysis.summary.maxStress.toFixed(0)} MPa</p>\n          </div>\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"安全系数\" : \"SF@Bump\"}</span>\n            <p className={`font-mono font-semibold ${analysis.summary.sfBump >= 1.2 ? \"text-emerald-500\" : analysis.summary.sfBump >= 1.0 ? \"text-amber-500\" : \"text-red-500\"}`}>\n              {analysis.summary.sfBump.toFixed(2)}\n            </p>\n          </div>\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"并紧余量\" : \"Bind Margin\"}</span>\n            <p className={`font-mono font-semibold ${analysis.summary.coilBindMargin >= 3 ? \"text-emerald-500\" : \"text-amber-500\"}`}>\n              {analysis.summary.coilBindMargin.toFixed(1)} mm\n            </p>\n          </div>\n          <div>\n            <span className=\"text-muted-foreground\">{isZh ? \"疲劳寿命\" : \"Fatigue\"}</span>\n            <Badge variant={\n              analysis.fatigue?.lifeClass === \"high\" ? \"default\" :\n              analysis.fatigue?.lifeClass === \"mid\" ? \"secondary\" :\n              analysis.fatigue?.lifeClass === \"low\" ? \"outline\" : \"destructive\"\n            }>\n              {analysis.fatigue?.lifeClass.toUpperCase() ?? \"N/A\"}\n            </Badge>\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content Tabs */}\n      <div className=\"grid gap-6 lg:grid-cols-3\">\n        <div className=\"lg:col-span-2\">\n          <Tabs defaultValue=\"curves\" className=\"w-full\">\n            <TabsList className=\"grid grid-cols-5 w-full\">\n              <TabsTrigger value=\"curves\">k(x)</TabsTrigger>\n              <TabsTrigger value=\"fatigue\">{isZh ? \"疲劳\" : \"Fatigue\"}</TabsTrigger>\n              <TabsTrigger value=\"nvh\">NVH</TabsTrigger>\n              <TabsTrigger value=\"fea\">FEA</TabsTrigger>\n              <TabsTrigger value=\"conclusion\">{isZh ? \"结论\" : \"Conclusion\"}</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"curves\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>{isZh ? \"非线性刚度曲线 k(x)\" : \"Nonlinear Stiffness k(x)\"}</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <KxCurveChart data={analysis.kxCurve} isZh={isZh} />\n                  {analysis.contactInfo && (\n                    <div className=\"mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg text-sm\">\n                      <p className=\"font-medium text-amber-700 dark:text-amber-300\">\n                        {isZh ? \"⚠️ 检测到圈-圈接触\" : \"⚠️ Coil Contact Detected\"}\n                      </p>\n                      <p className=\"text-muted-foreground mt-1\">\n                        {isZh \n                          ? `在变形 ${analysis.contactInfo.onsetDeflection.toFixed(1)}mm 处开始接触（${(analysis.contactInfo.onsetFraction * 100).toFixed(0)}% 行程）`\n                          : `Contact begins at ${analysis.contactInfo.onsetDeflection.toFixed(1)}mm deflection (${(analysis.contactInfo.onsetFraction * 100).toFixed(0)}% travel)`\n                        }\n                      </p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"stress\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>{isZh ? \"工况应力分析\" : \"Loadcase Stress Analysis\"}</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <div className=\"p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20\">\n                      <p className=\"text-xs text-muted-foreground mb-1\">Preload</p>\n                      <p className=\"font-mono text-lg\">{calcResult.forces.preload_N.toFixed(0)} N</p>\n                    </div>\n                    <div className=\"p-3 rounded-lg bg-green-50 dark:bg-green-900/20\">\n                      <p className=\"text-xs text-muted-foreground mb-1\">Ride</p>\n                      <p className=\"font-mono text-lg\">{calcResult.stress.tauRide_MPa.toFixed(0)} MPa</p>\n                      <p className=\"text-xs text-muted-foreground\">SF: {calcResult.stress.yieldSafetyFactor_ride.toFixed(2)}</p>\n                    </div>\n                    <div className=\"p-3 rounded-lg bg-orange-50 dark:bg-orange-900/20\">\n                      <p className=\"text-xs text-muted-foreground mb-1\">Bump</p>\n                      <p className=\"font-mono text-lg\">{calcResult.stress.tauBump_MPa.toFixed(0)} MPa</p>\n                      <p className=\"text-xs text-muted-foreground\">SF: {calcResult.stress.yieldSafetyFactor_bump.toFixed(2)}</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"fatigue\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>{isZh ? \"疲劳寿命评估 (Goodman)\" : \"Fatigue Assessment (Goodman)\"}</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  {analysis.fatigue && (\n                    <>\n                      <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                        <div>\n                          <span className=\"text-muted-foreground\">{isZh ? \"平均应力\" : \"Mean Stress\"}</span>\n                          <p className=\"font-mono\">{analysis.fatigue.meanStress.toFixed(0)} MPa</p>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">{isZh ? \"交变应力\" : \"Alternating Stress\"}</span>\n                          <p className=\"font-mono\">{analysis.fatigue.altStress.toFixed(0)} MPa</p>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">{isZh ? \"疲劳安全系数\" : \"Fatigue SF\"}</span>\n                          <p className={`font-mono font-semibold ${analysis.fatigue.fatigueSF >= 1.5 ? \"text-emerald-500\" : analysis.fatigue.fatigueSF >= 1.0 ? \"text-amber-500\" : \"text-red-500\"}`}>\n                            {analysis.fatigue.fatigueSF.toFixed(2)}\n                          </p>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">{isZh ? \"预估寿命\" : \"Est. Cycles\"}</span>\n                          <p className=\"font-mono\">{analysis.fatigue.estimatedCycles?.toExponential(1)}</p>\n                        </div>\n                      </div>\n                      <div className={`p-3 rounded-lg ${\n                        analysis.fatigue.lifeClass === \"high\" ? \"bg-emerald-50 dark:bg-emerald-900/20\" :\n                        analysis.fatigue.lifeClass === \"mid\" ? \"bg-blue-50 dark:bg-blue-900/20\" :\n                        analysis.fatigue.lifeClass === \"low\" ? \"bg-amber-50 dark:bg-amber-900/20\" :\n                        \"bg-red-50 dark:bg-red-900/20\"\n                      }`}>\n                        <p className=\"font-medium\">\n                          {isZh ? \"寿命等级: \" : \"Life Class: \"}\n                          <span className=\"uppercase\">{analysis.fatigue.lifeClass}</span>\n                        </p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          {analysis.fatigue.lifeClass === \"high\" && (isZh ? \"无限寿命 (>10⁷ 次)\" : \"Infinite life (>10⁷ cycles)\")}\n                          {analysis.fatigue.lifeClass === \"mid\" && (isZh ? \"高循环疲劳 (10⁵~10⁷ 次)\" : \"High cycle fatigue (10⁵~10⁷ cycles)\")}\n                          {analysis.fatigue.lifeClass === \"low\" && (isZh ? \"有限寿命 (<10⁵ 次)，建议复核\" : \"Limited life (<10⁵ cycles), review recommended\")}\n                          {analysis.fatigue.lifeClass === \"fail\" && (isZh ? \"不满足疲劳要求，需要重新设计\" : \"Fatigue requirements not met, redesign needed\")}\n                        </p>\n                      </div>\n                    </>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"nvh\">\n              <NvhTab isZh={isZh} calcResult={calcResult} loadcase={input.loadcase} />\n            </TabsContent>\n\n            <TabsContent value=\"conclusion\">\n              <ConclusionTab \n                isZh={isZh} \n                geometry={geometry} \n                material={material} \n                calcResult={calcResult} \n                analysis={analysis} \n              />\n            </TabsContent>\n\n            <TabsContent value=\"fea\">\n              <FeaTab\n                isZh={isZh}\n                geometry={geometry}\n                material={material}\n                calcResult={calcResult}\n                analysis={analysis}\n                onFeaComplete={handleFeaComplete}\n              />\n            </TabsContent>\n          </Tabs>\n        </div>\n\n        {/* 3D Preview Sidebar */}\n        <div>\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle>{isZh ? \"3D 预览\" : \"3D Preview\"}</CardTitle>\n              <div className=\"flex bg-muted p-1 rounded-md text-[10px]\">\n                <button \n                  onClick={() => setDisplayMode(\"geometry\")}\n                  className={`px-2 py-1 rounded-sm transition-all ${displayMode === \"geometry\" ? \"bg-background shadow-sm font-bold\" : \"text-muted-foreground hover:text-foreground\"}`}\n                >\n                  {isZh ? \"几何\" : \"Geom\"}\n                </button>\n                <button \n                  onClick={() => setDisplayMode(\"engineering\")}\n                  className={`px-2 py-1 rounded-sm transition-all ${displayMode === \"engineering\" ? \"bg-background shadow-sm font-bold\" : \"text-muted-foreground hover:text-foreground\"}`}\n                >\n                  {isZh ? \"工程\" : \"Eng\"}\n                </button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"h-[350px] rounded-lg overflow-hidden border bg-slate-50 dark:bg-slate-900/50\">\n                <SuspensionSpringVisualizer\n                  wireDiameter={geometry.wireDiameter}\n                  meanDiameter={geometry.diameterProfile?.DmStart ?? 100}\n                  activeCoils={geometry.activeCoils}\n                  totalCoils={geometry.totalCoils}\n                  freeLength={geometry.freeLength}\n                  currentDeflection={0}\n                  stressRatio={0.5}\n                  solidHeight={calcResult.derived.solidHeight_Hs_mm}\n                  currentLoad={0}\n                  springRate={calcResult.springRate_N_per_mm}\n                  pitchProfile={geometry.pitchProfile}\n                  diameterProfile={geometry.diameterProfile}\n                  feaForce={feaForce ?? undefined}\n                  showStressContour={(displayMode === \"engineering\") && (feaForce !== null || !!calcResult)}\n                  isZh={isZh}\n                  displayMode={displayMode}\n                />\n              </div>\n              <p className=\"text-xs text-muted-foreground text-center mt-2\">\n                {isZh ? \"拖动旋转，滚轮缩放\" : \"Drag to rotate, scroll to zoom\"}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </main>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/cad/CadExportContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DesignGeometry' is defined but never used.","line":32,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CompressionGeometry' is defined but never used.","line":33,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'generateSpringDrawingSpec' is defined but never used.","line":37,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'EngineeringDrawingCanvas' is assigned a value but never used.","line":68,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":68,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'fatigueLife' is assigned a value but never used.","line":167,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":167,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'geometry' is assigned a value but never used.","line":196,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":196,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'outer' is assigned a value but never used.","line":224,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":224,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'isSpiralTorsion'. Either include it or remove the dependency array.","line":364,"column":6,"nodeType":"ArrayExpression","endLine":382,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [isSpiralTorsion, storeGeometry, springType, materialId, bodyLength, activeCoils, wireDiameter, hookType, meanDiameter, initialTension, legLength1, legLength2, windingDirection, largeDiameter, smallDiameter, conicalTotalCoils, freeLength, totalCoils]","fix":{"range":[13118,13424],"text":"[isSpiralTorsion, storeGeometry, springType, materialId, bodyLength, activeCoils, wireDiameter, hookType, meanDiameter, initialTension, legLength1, legLength2, windingDirection, largeDiameter, smallDiameter, conicalTotalCoils, freeLength, totalCoils]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'springTypeLabels'. Either include it or remove the dependency array.","line":589,"column":6,"nodeType":"ArrayExpression","endLine":594,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [springTypeLabels, springType, code, wireDiameter, meanDiameter, activeCoils, bodyLength, hookType, initialTension, materialName, springRate, legLength1, legLength2, windingDirection, totalCoils, freeLength, safetyFactor, largeDiameter, smallDiameter, conicalTotalCoils, conicalEndType]","fix":{"range":[21322,21612],"text":"[springTypeLabels, springType, code, wireDiameter, meanDiameter, activeCoils, bodyLength, hookType, initialTension, materialName, springRate, legLength1, legLength2, windingDirection, totalCoils, freeLength, safetyFactor, largeDiameter, smallDiameter, conicalTotalCoils, conicalEndType]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { Suspense, useMemo, useState, useEffect } from \"react\";\nimport { useSearchParams } from \"next/navigation\";\nimport { Download, FileText, CheckCircle, AlertCircle, Loader2, Eye } from \"lucide-react\";\nimport dynamic from \"next/dynamic\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { LanguageText } from \"@/components/language-context\";\nimport type { \n  CadExportFormat, \n  SpringGeometry,\n  ExportedFile,\n} from \"@/lib/cad/types\";\nimport { \n  CAD_FORMAT_GROUPS, \n  CAD_FORMAT_META,\n} from \"@/lib/cad/types\";\nimport { requestCadExport } from \"@/lib/cad/exportService\";\nimport type {\n  CompressionSpringGeometry,\n  ExtensionSpringGeometry,\n  TorsionSpringGeometry,\n  ConicalSpringGeometry,\n  SpringGeometry as EngineSpringGeometry,\n} from \"@/lib/engine/types\";\nimport { \n  useSpringDesignStore,\n  getMeanDiameter,\n  type SpringGeometry as DesignGeometry,\n  type CompressionGeometry,\n} from \"@/lib/stores/springDesignStore\";\nimport { convertStoreGeometryToEngine } from \"@/lib/engine/geometryAdapters\";\nimport type { SpringMaterialId } from \"@/lib/materials/springMaterials\";\nimport { generateSpringDrawingSpec } from \"@/lib/drawing\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { FileCode, Box } from \"lucide-react\";\n\n// Dynamic import for 3D preview (client-side only)\nconst CadPreview3D = dynamic(\n  () => import(\"@/components/cad/CadPreview3D\").then(mod => mod.CadPreview3D),\n  { \n    ssr: false,\n    loading: () => (\n      <div className=\"h-[400px] bg-slate-900 rounded-lg flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-slate-400\" />\n      </div>\n    )\n  }\n);\n\n// Dynamic import for Spiral Torsion 3D preview\nconst SpiralTorsionSpringVisualizer = dynamic(\n  () => import(\"@/components/three/SpiralTorsionSpringMesh\").then(mod => mod.SpiralTorsionSpringVisualizer),\n  { \n    ssr: false,\n    loading: () => (\n      <div className=\"h-[400px] bg-slate-900 rounded-lg flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-slate-400\" />\n      </div>\n    )\n  }\n);\n\n// Dynamic import for 2D drawing canvas\nconst EngineeringDrawingCanvas = dynamic(\n  () => import(\"@/components/drawing/EngineeringDrawingCanvas\").then(mod => mod.EngineeringDrawingCanvas),\n  { \n    ssr: false,\n    loading: () => (\n      <div className=\"h-[400px] bg-white border rounded-lg flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-slate-400\" />\n      </div>\n    )\n  }\n);\n\n// Dynamic import for FreeCAD preview\nconst FreeCadPreview = dynamic(\n  () => import(\"@/components/cad/FreeCadPreview\").then(mod => mod.FreeCadPreview),\n  { \n    ssr: false,\n    loading: () => (\n      <div className=\"h-[400px] bg-slate-800 rounded-lg flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-slate-400\" />\n      </div>\n    )\n  }\n);\n\n// Dynamic import for FreeCAD 2D drawing\nconst FreeCadDrawing = dynamic(\n  () => import(\"@/components/cad/FreeCadDrawing\").then(mod => mod.FreeCadDrawing),\n  { \n    ssr: false,\n    loading: () => (\n      <div className=\"h-[500px] bg-white border rounded-lg flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-slate-400\" />\n      </div>\n    )\n  }\n);\n\nconst numberOrUndefined = (value: string | null) => {\n  if (!value) return undefined;\n  const parsed = Number(value);\n  return Number.isFinite(parsed) ? parsed : undefined;\n};\n\nexport default function SpringCadExportPage() {\n  return (\n    <Suspense fallback={<div className=\"p-8 text-center text-muted-foreground\">Loading CAD Export...</div>}>\n      <CadExportContent />\n    </Suspense>\n  );\n}\n\nfunction CadExportContent() {\n  const searchParams = useSearchParams();\n  \n  // 从全局 store 读取设计数据\n  const storeGeometry = useSpringDesignStore(state => state.geometry);\n  const storeMaterial = useSpringDesignStore(state => state.material);\n  const storeAnalysis = useSpringDesignStore(state => state.analysisResult);\n  const storeMeta = useSpringDesignStore(state => state.meta);\n  const hasValidDesign = useSpringDesignStore(state => state.hasValidDesign);\n  \n  // 检查是否有 URL 参数（作为备选）\n  const hasUrlParams = searchParams.has(\"d\") || searchParams.has(\"Dm\") || searchParams.has(\"Na\");\n  \n  // 优先使用 store 数据，否则使用 URL 参数\n  const hasParams = hasValidDesign || hasUrlParams;\n  \n  // 从 store 或 URL 获取数据\n  const code = storeMeta?.designCode ?? searchParams.get(\"code\") ?? undefined;\n  const springType = (storeGeometry?.type ?? searchParams.get(\"type\") ?? \"compression\") as SpringGeometry['type'] | \"spiralTorsion\";\n  \n  // 几何参数 - 优先从 store 读取\n  // 螺旋扭转弹簧没有 wireDiameter，使用 stripThickness 作为替代\n  const wireDiameter = storeGeometry?.type === \"spiralTorsion\" \n    ? storeGeometry.stripThickness \n    : (storeGeometry?.wireDiameter ?? numberOrUndefined(searchParams.get(\"d\")) ?? 3.2);\n  \n  // 螺旋扭转弹簧没有 meanDiameter 概念，getMeanDiameter 返回 null\n  // 对于 wire spring 使用 meanDiameter，对于 spiral 使用 fallback 值（仅用于显示）\n  const meanDiameterRaw = storeGeometry ? getMeanDiameter(storeGeometry) : null;\n  const meanDiameter = meanDiameterRaw ?? (numberOrUndefined(searchParams.get(\"Dm\")) ?? 24);\n  \n  // 标记是否为螺旋扭转弹簧\n  const isSpiralTorsion = storeGeometry?.type === \"spiralTorsion\" || springType === \"spiralTorsion\";\n  const activeCoils = storeGeometry?.activeCoils ?? numberOrUndefined(searchParams.get(\"Na\")) ?? 8;\n  const totalCoils = (storeGeometry?.type === \"compression\" ? storeGeometry.totalCoils : undefined) \n    ?? numberOrUndefined(searchParams.get(\"Nt\")) ?? activeCoils + 2;\n  const freeLength = (storeGeometry?.type === \"compression\" || storeGeometry?.type === \"conical\" \n    ? storeGeometry.freeLength : undefined) ?? numberOrUndefined(searchParams.get(\"L0\")) ?? 50;\n  \n  // 材料\n  const materialId = storeMaterial?.id ?? searchParams.get(\"material\") ?? \"music_wire_a228\";\n  const materialName = storeMaterial?.name ?? materialId;\n  \n  // 分析结果\n  const springRate = storeAnalysis?.springRate ?? numberOrUndefined(searchParams.get(\"k\")) ?? 10;\n  const maxDeflection = storeAnalysis?.maxDeflection ?? numberOrUndefined(searchParams.get(\"dx\"));\n  const safetyFactor = storeAnalysis?.staticSafetyFactor;\n  const fatigueLife = storeAnalysis?.fatigueLife;\n  \n  // Extension specific\n  const hookType = (storeGeometry?.type === \"extension\" ? storeGeometry.hookType : undefined) \n    ?? (searchParams.get(\"hookType\") ?? \"machine\") as \"machine\" | \"crossover\" | \"side\" | \"extended\" | \"doubleLoop\";\n  const initialTension = (storeGeometry?.type === \"extension\" ? storeGeometry.initialTension : undefined) \n    ?? numberOrUndefined(searchParams.get(\"Fi\")) ?? 5;\n  const bodyLength = (storeGeometry?.type === \"extension\" ? storeGeometry.bodyLength : undefined) \n    ?? numberOrUndefined(searchParams.get(\"Lb\"));\n  \n  // Torsion specific\n  const legLength1 = (storeGeometry?.type === \"torsion\" ? storeGeometry.legLength1 : undefined) \n    ?? numberOrUndefined(searchParams.get(\"L1\")) ?? 25;\n  const legLength2 = (storeGeometry?.type === \"torsion\" ? storeGeometry.legLength2 : undefined) \n    ?? numberOrUndefined(searchParams.get(\"L2\")) ?? 25;\n  const windingDirection = (storeGeometry?.type === \"torsion\" ? storeGeometry.windingDirection : undefined) \n    ?? (searchParams.get(\"hand\") ?? \"right\") as \"left\" | \"right\";\n  \n  // Conical specific\n  const largeDiameter = (storeGeometry?.type === \"conical\" ? storeGeometry.largeOuterDiameter : undefined) \n    ?? numberOrUndefined(searchParams.get(\"D1\"));\n  const smallDiameter = (storeGeometry?.type === \"conical\" ? storeGeometry.smallOuterDiameter : undefined) \n    ?? numberOrUndefined(searchParams.get(\"D2\"));\n  const conicalTotalCoils = (storeGeometry?.type === \"conical\" ? storeGeometry.totalCoils : undefined)\n    ?? numberOrUndefined(searchParams.get(\"Nt\"));\n  const conicalEndType = (storeGeometry?.type === \"conical\" ? storeGeometry.endType : undefined)\n    ?? (searchParams.get(\"endType\") as \"natural\" | \"closed\" | \"closed_ground\" | null) ?? \"closed_ground\";\n\n  // 构建几何参数 - 根据实际弹簧类型构建\n  const geometry = useMemo(() => {\n    if (storeGeometry) {\n      switch (storeGeometry.type) {\n        case \"conical\":\n          return {\n            ...storeGeometry,\n            endType: storeGeometry.endType ?? conicalEndType,\n            totalCoils: storeGeometry.totalCoils ?? conicalTotalCoils ?? storeGeometry.activeCoils,\n          };\n        case \"extension\":\n          return {\n            ...storeGeometry,\n            meanDiameter: storeGeometry.meanDiameter ?? storeGeometry.outerDiameter - storeGeometry.wireDiameter,\n          };\n        case \"torsion\":\n          return {\n            ...storeGeometry,\n            outerDiameter: storeGeometry.outerDiameter ?? storeGeometry.meanDiameter + storeGeometry.wireDiameter,\n            freeAngle: storeGeometry.freeAngle ?? storeGeometry.workingAngle ?? 90,\n            bodyLength: storeGeometry.bodyLength ?? storeGeometry.activeCoils * storeGeometry.wireDiameter,\n          };\n        default:\n          return storeGeometry;\n      }\n    }\n\n    switch (springType) {\n      case \"extension\": {\n        const outer = meanDiameter + wireDiameter;\n        const body = bodyLength ?? activeCoils * wireDiameter;\n        return {\n          type: \"extension\" as const,\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          bodyLength: body,\n          freeLength: body + wireDiameter * 4,\n          hookType: hookType ?? \"machine\",\n          initialTension: initialTension ?? 5,\n        };\n      }\n      case \"torsion\":\n        return {\n          type: \"torsion\" as const,\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          bodyLength: activeCoils * wireDiameter * 1.1,\n          legLength1,\n          legLength2,\n          freeAngle: 90,\n          windingDirection,\n        };\n      case \"conical\":\n        return {\n          type: \"conical\" as const,\n          wireDiameter,\n          largeOuterDiameter: largeDiameter ?? meanDiameter * 1.5,\n          smallOuterDiameter: smallDiameter ?? meanDiameter * 0.5,\n          activeCoils,\n          totalCoils: conicalTotalCoils ?? activeCoils,\n          freeLength,\n          endType: conicalEndType,\n        };\n      case \"compression\":\n      default:\n        return {\n          type: \"compression\" as const,\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          totalCoils,\n          freeLength,\n          topGround: true,\n          bottomGround: true,\n        };\n    }\n  }, [\n    storeGeometry,\n    springType,\n    wireDiameter,\n    meanDiameter,\n    activeCoils,\n    totalCoils,\n    freeLength,\n    bodyLength,\n    hookType,\n    initialTension,\n    legLength1,\n    legLength2,\n    windingDirection,\n    largeDiameter,\n    smallDiameter,\n    conicalTotalCoils,\n    conicalEndType,\n  ]);\n\n  const engineGeometry = useMemo<EngineSpringGeometry | null>(() => {\n    // 螺旋扭转弹簧现在支持 FreeCAD 导出\n    // 但不支持 engine geometry 转换，直接使用 storeGeometry\n    if (isSpiralTorsion) {\n      // 返回 null 让 FreeCAD 导出使用 storeGeometry\n      return null;\n    }\n    \n    if (storeGeometry) {\n      return convertStoreGeometryToEngine(storeGeometry, materialId as SpringMaterialId);\n    }\n\n    switch (springType) {\n      case \"extension\": {\n        const body = bodyLength ?? activeCoils * wireDiameter;\n        const safeHookType =\n          hookType === \"doubleLoop\" ? \"extended\" : (hookType ?? \"machine\");\n        const extGeom: ExtensionSpringGeometry = {\n          type: \"extension\",\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          totalCoils: activeCoils,\n          bodyLength: body,\n          initialTension: initialTension ?? 0,\n          hookType: safeHookType,\n          materialId: materialId as SpringMaterialId,\n        };\n        return extGeom;\n      }\n      case \"torsion\": {\n        const torGeom: TorsionSpringGeometry = {\n          type: \"torsion\",\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          bodyLength: activeCoils * wireDiameter * 1.1,\n          legLength1,\n          legLength2,\n          windDirection: windingDirection,\n          materialId: materialId as SpringMaterialId,\n        };\n        return torGeom;\n      }\n      case \"conical\": {\n        const cnGeom: ConicalSpringGeometry = {\n          type: \"conical\",\n          wireDiameter,\n          largeOuterDiameter: largeDiameter ?? meanDiameter * 1.5,\n          smallOuterDiameter: smallDiameter ?? meanDiameter * 0.5,\n          activeCoils,\n          totalCoils: conicalTotalCoils ?? activeCoils,\n          freeLength,\n          materialId: materialId as SpringMaterialId,\n        };\n        return cnGeom;\n      }\n      case \"compression\":\n      default: {\n        const compGeom: CompressionSpringGeometry = {\n          type: \"compression\",\n          wireDiameter,\n          meanDiameter,\n          activeCoils,\n          totalCoils,\n          freeLength,\n          materialId: materialId as SpringMaterialId,\n        };\n        return compGeom;\n      }\n    }\n  }, [\n    storeGeometry,\n    springType,\n    wireDiameter,\n    meanDiameter,\n    activeCoils,\n    totalCoils,\n    freeLength,\n    bodyLength,\n    hookType,\n    initialTension,\n    legLength1,\n    legLength2,\n    windingDirection,\n    largeDiameter,\n    smallDiameter,\n    conicalTotalCoils,\n    materialId,\n  ]);\n\n  const [selectedFormats, setSelectedFormats] = useState<CadExportFormat[]>([\"STEP\", \"PDF_2D\"]);\n  const [isExporting, setIsExporting] = useState(false);\n  const [exportedFiles, setExportedFiles] = useState<ExportedFile[]>([]);\n  const [error, setError] = useState<string | null>(null);\n  const [freecadStatus, setFreecadStatus] = useState<{ available: boolean; version?: string } | null>(null);\n  const [isExportingFreeCAD, setIsExportingFreeCAD] = useState(false);\n  \n  // 检查 FreeCAD 状态\n  useEffect(() => {\n    fetch(\"/api/freecad/export\")\n      .then(res => res.json())\n      .then(data => setFreecadStatus(data))\n      .catch(() => setFreecadStatus({ available: false }));\n  }, []);\n  \n  // FreeCAD 导出\n  const handleFreeCADExport = async () => {\n    setIsExportingFreeCAD(true);\n    setError(null);\n    \n    try {\n      // 构建几何参数 - 螺旋扭转弹簧使用特殊参数\n      const geometryParams = isSpiralTorsion && storeGeometry?.type === \"spiralTorsion\"\n        ? {\n            innerDiameter: storeGeometry.innerDiameter,\n            outerDiameter: storeGeometry.outerDiameter,\n            turns: storeGeometry.activeCoils,\n            stripWidth: storeGeometry.stripWidth,\n            stripThickness: storeGeometry.stripThickness,\n            handedness: \"ccw\",\n          }\n        : {\n            wireDiameter,\n            meanDiameter,\n            outerDiameter: meanDiameter + wireDiameter,\n            activeCoils,\n            totalCoils,\n            freeLength,\n            bodyLength,\n            hookType,\n            legLength1,\n            legLength2,\n            windingDirection,\n            largeOuterDiameter: largeDiameter,\n            smallOuterDiameter: smallDiameter,\n          };\n      \n      const response = await fetch(\"/api/freecad/export\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          springType: isSpiralTorsion ? \"spiral_torsion\" : springType,\n          geometry: geometryParams,\n          export: {\n            formats: [\"STEP\"],\n            name: `${springType}_spring_${Date.now()}`,\n          },\n        }),\n      });\n      \n      const result = await response.json();\n      \n      if (result.status === \"success\" && result.files) {\n        setExportedFiles(result.files.map((f: { format: string; fileName: string; downloadUrl: string; fileSize?: number }) => ({\n          format: f.format as CadExportFormat,\n          fileName: f.fileName,\n          downloadUrl: f.downloadUrl,\n          fileSize: f.fileSize,\n        })));\n      } else if (result.status === \"unavailable\") {\n        setError(result.message || \"FreeCAD is not available\");\n      } else {\n        setError(result.message || \"Export failed\");\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : \"Export failed\");\n    } finally {\n      setIsExportingFreeCAD(false);\n    }\n  };\n\n  const toggleFormat = (format: CadExportFormat) => {\n    setSelectedFormats((prev) =>\n      prev.includes(format) ? prev.filter((item) => item !== format) : [...prev, format],\n    );\n  };\n\n  const handleExport = async () => {\n    if (selectedFormats.length === 0) {\n      setError(\"请至少选择一种导出格式\");\n      return;\n    }\n    \n    // 螺旋扭转弹簧暂不支持 CAD 导出\n    if (!engineGeometry) {\n      setError(\"螺旋扭转弹簧暂不支持 CAD 导出 / Spiral torsion spring CAD export not yet supported\");\n      return;\n    }\n    \n    setIsExporting(true);\n    setError(null);\n    setExportedFiles([]);\n    \n    try {\n      const result = await requestCadExport(engineGeometry, selectedFormats, {\n        analysisResult: {\n          springRate: springRate ?? 0,\n          maxDeflection,\n        },\n      });\n      \n      if (result.status === 'failed') {\n        throw new Error(result.error?.message ?? 'Export failed');\n      }\n      \n      if (result.files) {\n        setExportedFiles(result.files);\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Unknown error');\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  const handleDownload = (file: ExportedFile) => {\n    // 对于 data URL，创建下载链接\n    const link = document.createElement('a');\n    link.href = file.downloadUrl;\n    link.download = file.fileName;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  const springTypeLabels: Record<string, string> = {\n    compression: \"Compression / 压缩弹簧\",\n    extension: \"Extension / 拉伸弹簧\",\n    torsion: \"Torsion / 扭转弹簧\",\n    conical: \"Conical / 锥形弹簧\",\n  };\n  \n  // 根据弹簧类型构建参数显示列表\n  const summaryItems = useMemo(() => {\n    const baseItems = [\n      { label: \"Spring Type / 类型\", value: springTypeLabels[springType] ?? springType },\n      { label: \"Design Code / 设计编号\", value: code ?? \"—\" },\n      { label: \"Wire Diameter d / 线径\", value: `${wireDiameter.toFixed(2)} mm` },\n    ];\n    \n    // 根据弹簧类型添加特定参数\n    switch (springType) {\n      case \"extension\":\n        return [\n          ...baseItems,\n          { label: \"Outer Diameter OD / 外径\", value: `${(meanDiameter + wireDiameter).toFixed(2)} mm` },\n          { label: \"Active Coils Na / 有效圈数\", value: activeCoils.toFixed(1) },\n          { label: \"Body Length Lb / 体长\", value: `${(bodyLength ?? activeCoils * wireDiameter).toFixed(1)} mm` },\n          { label: \"Hook Type / 钩子类型\", value: hookType ?? \"machine\" },\n          { label: \"Initial Tension Fi / 初张力\", value: `${(initialTension ?? 0).toFixed(1)} N` },\n          { label: \"Material / 材料\", value: materialName },\n          { label: \"Spring Rate k / 刚度\", value: springRate ? `${springRate.toFixed(2)} N/mm` : \"—\" },\n        ];\n      case \"torsion\":\n        return [\n          ...baseItems,\n          { label: \"Mean Diameter Dm / 中径\", value: `${meanDiameter.toFixed(2)} mm` },\n          { label: \"Active Coils Na / 有效圈数\", value: activeCoils.toFixed(1) },\n          { label: \"Leg Length 1 / 腿长1\", value: `${legLength1.toFixed(1)} mm` },\n          { label: \"Leg Length 2 / 腿长2\", value: `${legLength2.toFixed(1)} mm` },\n          { label: \"Winding / 旋向\", value: windingDirection === \"left\" ? \"Left / 左旋\" : \"Right / 右旋\" },\n          { label: \"Material / 材料\", value: materialName },\n          { label: \"Spring Rate k / 刚度\", value: springRate ? `${springRate.toFixed(2)} N·mm/°` : \"—\" },\n        ];\n      case \"conical\": {\n        const endTypeLabels: Record<string, string> = {\n          natural: \"Natural / 自然端\",\n          closed: \"Closed / 并紧\",\n          closed_ground: \"Closed & Ground / 并紧磨平\",\n        };\n        return [\n          ...baseItems,\n          { label: \"Large OD D1 / 大端外径\", value: `${(largeDiameter ?? meanDiameter * 1.5).toFixed(2)} mm` },\n          { label: \"Small OD D2 / 小端外径\", value: `${(smallDiameter ?? meanDiameter * 0.5).toFixed(2)} mm` },\n          { label: \"Active Coils Na / 有效圈数\", value: activeCoils.toFixed(1) },\n          { label: \"Total Coils Nt / 总圈数\", value: (conicalTotalCoils ?? activeCoils).toFixed(1) },\n          { label: \"Free Length L₀ / 自由长度\", value: `${freeLength.toFixed(1)} mm` },\n          { label: \"End Type / 端面形式\", value: endTypeLabels[conicalEndType] ?? conicalEndType },\n          { label: \"Material / 材料\", value: materialName },\n          { label: \"Spring Rate k / 刚度\", value: springRate ? `${springRate.toFixed(2)} N/mm` : \"—\" },\n        ];\n      }\n      case \"compression\":\n      default:\n        return [\n          ...baseItems,\n          { label: \"Mean Diameter Dm / 中径\", value: `${meanDiameter.toFixed(2)} mm` },\n          { label: \"Active Coils Na / 有效圈数\", value: activeCoils.toFixed(1) },\n          { label: \"Total Coils Nt / 总圈数\", value: totalCoils.toFixed(1) },\n          { label: \"Free Length L₀ / 自由长度\", value: `${freeLength.toFixed(1)} mm` },\n          { label: \"Material / 材料\", value: materialName },\n          { label: \"Spring Rate k / 刚度\", value: springRate ? `${springRate.toFixed(2)} N/mm` : \"—\" },\n          { label: \"Safety Factor / 安全系数\", value: safetyFactor ? safetyFactor.toFixed(2) : \"—\" },\n        ];\n    }\n  }, [\n    springType, code, wireDiameter, meanDiameter, activeCoils, totalCoils, \n    freeLength, bodyLength, hookType, initialTension, legLength1, legLength2, \n    windingDirection, largeDiameter, smallDiameter, materialName, springRate, safetyFactor,\n    conicalTotalCoils, conicalEndType\n  ]);\n\n  const rfqUrl = useMemo(() => {\n    const params = new URLSearchParams();\n    if (code) params.set(\"code\", code);\n    params.set(\"d\", wireDiameter.toString());\n    params.set(\"Dm\", meanDiameter.toString());\n    params.set(\"Na\", activeCoils.toString());\n    params.set(\"L0\", freeLength.toString());\n    if (springRate) params.set(\"k\", springRate.toString());\n    return `/rfq?${params.toString()}`;\n  }, [code, wireDiameter, meanDiameter, activeCoils, freeLength, springRate]);\n\n  // 如果没有参数，显示提示\n  if (!hasParams) {\n    return (\n      <section className=\"space-y-6\">\n        <div className=\"space-y-3\">\n          <p className=\"text-sm uppercase tracking-[0.3em] text-primary/70\">\n            <LanguageText en=\"Module • CAD Export\" zh=\"模块 • CAD 导出\" />\n          </p>\n          <h1 className=\"text-3xl font-semibold tracking-tight\">\n            <LanguageText en=\"CAD Export\" zh=\"CAD 导出\" />\n          </h1>\n        </div>\n        \n        <Card>\n          <CardContent className=\"p-8 text-center space-y-4\">\n            <AlertCircle className=\"w-12 h-12 mx-auto text-amber-500\" />\n            <h2 className=\"text-xl font-semibold\">\n              <LanguageText en=\"No Design Data\" zh=\"没有设计数据\" />\n            </h2>\n            <p className=\"text-muted-foreground\">\n              <LanguageText \n                en=\"Please start from the Calculator page to design your spring, then click 'Export CAD' to generate CAD files.\"\n                zh=\"请先从计算器页面设计您的弹簧，然后点击「导出 CAD」按钮生成 CAD 文件。\"\n              />\n            </p>\n            <Button asChild>\n              <a href=\"/tools/calculator\">\n                <LanguageText en=\"Go to Calculator\" zh=\"前往计算器\" />\n              </a>\n            </Button>\n          </CardContent>\n        </Card>\n      </section>\n    );\n  }\n\n  return (\n    <section className=\"space-y-6\">\n      <div className=\"space-y-3\">\n        <p className=\"text-sm uppercase tracking-[0.3em] text-primary/70\">\n          <LanguageText en=\"Module • CAD Export\" zh=\"模块 • CAD 导出\" />\n        </p>\n        <h1 className=\"text-3xl font-semibold tracking-tight\">\n          <LanguageText en=\"CAD Export\" zh=\"CAD 导出\" />\n        </h1>\n        <p className=\"text-muted-foreground\">\n          <LanguageText\n            en=\"Review your spring design parameters and export CAD files for manufacturing.\"\n            zh=\"查看您的弹簧设计参数，并导出 CAD 文件用于制造。\"\n          />\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            <LanguageText en=\"Spring Design Summary\" zh=\"弹簧设计概要\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {code && (\n            <p className=\"text-sm text-primary font-medium\">\n              <LanguageText en=\"Design Code\" zh=\"设计代码\" />: {code}\n            </p>\n          )}\n          <dl className=\"grid gap-3 sm:grid-cols-2\">\n            {summaryItems.map((item) => (\n              <div key={item.label} className=\"rounded-md border border-slate-200 bg-slate-50 p-3\">\n                <dt className=\"text-xs uppercase tracking-wide text-slate-500\">{item.label}</dt>\n                <dd className=\"text-base font-semibold text-slate-900\">{item.value}</dd>\n              </div>\n            ))}\n          </dl>\n        </CardContent>\n      </Card>\n\n      {/* Preview - 3D Model & 2D Drawing */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Eye className=\"w-5 h-5\" />\n            <LanguageText en=\"Preview\" zh=\"预览\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <Tabs defaultValue=\"3d\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3 mb-4\">\n              <TabsTrigger value=\"3d\" className=\"flex items-center gap-2\">\n                <Box className=\"w-4 h-4\" />\n                <LanguageText en=\"3D Preview\" zh=\"3D 预览\" />\n              </TabsTrigger>\n              <TabsTrigger value=\"cad\" className=\"flex items-center gap-2\">\n                <Box className=\"w-4 h-4\" />\n                <LanguageText en=\"FreeCAD\" zh=\"FreeCAD\" />\n              </TabsTrigger>\n              <TabsTrigger value=\"2d\" className=\"flex items-center gap-2\">\n                <FileCode className=\"w-4 h-4\" />\n                <LanguageText en=\"2D Drawing\" zh=\"2D 工程图\" />\n              </TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"3d\">\n              {isSpiralTorsion && storeGeometry?.type === \"spiralTorsion\" ? (\n                <>\n                  <div className=\"h-[400px] rounded-lg overflow-hidden\">\n                    <SpiralTorsionSpringVisualizer\n                      innerDiameter={storeGeometry.innerDiameter}\n                      outerDiameter={storeGeometry.outerDiameter}\n                      turns={storeGeometry.activeCoils}\n                      stripWidth={storeGeometry.stripWidth}\n                      stripThickness={storeGeometry.stripThickness}\n                      handedness={storeGeometry.windingDirection ?? \"cw\"}\n                    />\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2 text-center\">\n                    <LanguageText \n                      en=\"Spiral Torsion Spring • Archimedean spiral + rectangular cross-section\"\n                      zh=\"螺旋扭转弹簧 • 阿基米德螺线 + 矩形截面\"\n                    />\n                  </p>\n                </>\n              ) : (\n                <>\n                  <CadPreview3D \n                    params={{\n                      type: springType as \"compression\" | \"extension\" | \"torsion\" | \"conical\",\n                      wireDiameter,\n                      meanDiameter,\n                      activeCoils,\n                      totalCoils,\n                      freeLength,\n                      bodyLength,\n                      hookType,\n                      initialTension,\n                      legLength1,\n                      legLength2,\n                      windingDirection,\n                      largeDiameter,\n                      smallDiameter,\n                    }}\n                    className=\"h-[400px] rounded-lg overflow-hidden\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-2 text-center\">\n                    <LanguageText \n                      en=\"Three.js preview • Drag to rotate • Scroll to zoom\"\n                      zh=\"Three.js 预览 • 拖动旋转 • 滚轮缩放\"\n                    />\n                  </p>\n                </>\n              )}\n            </TabsContent>\n            \n            <TabsContent value=\"cad\">\n              <FreeCadPreview\n                springType={isSpiralTorsion ? \"spiral_torsion\" : springType}\n                geometry={isSpiralTorsion && storeGeometry?.type === \"spiralTorsion\" \n                  ? {\n                      innerDiameter: storeGeometry.innerDiameter,\n                      outerDiameter: storeGeometry.outerDiameter,\n                      turns: storeGeometry.activeCoils,\n                      stripWidth: storeGeometry.stripWidth,\n                      stripThickness: storeGeometry.stripThickness,\n                      handedness: \"ccw\",\n                    }\n                  : {\n                      wireDiameter,\n                      meanDiameter,\n                      outerDiameter: springType === \"extension\" || springType === \"torsion\" ? meanDiameter + wireDiameter : undefined,\n                      activeCoils,\n                      totalCoils: springType === \"conical\" ? conicalTotalCoils : totalCoils,\n                      freeLength,\n                      bodyLength,\n                      hookType,\n                      legLength1,\n                      legLength2,\n                      windingDirection,\n                      largeOuterDiameter: largeDiameter,\n                      smallOuterDiameter: smallDiameter,\n                      topGround: storeGeometry?.type === \"compression\" ? storeGeometry.topGround : undefined,\n                      bottomGround: storeGeometry?.type === \"compression\" ? storeGeometry.bottomGround : undefined,\n                      endType: springType === \"conical\" ? conicalEndType : undefined,\n                    }\n                }\n                className=\"h-[400px] rounded-lg overflow-hidden\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-2 text-center\">\n                <LanguageText \n                  en=\"Real CAD model generated by FreeCAD - Click Generate to create\"\n                  zh=\"由 FreeCAD 生成的真实 CAD 模型 - 点击生成按钮创建\"\n                />\n              </p>\n            </TabsContent>\n            \n            <TabsContent value=\"2d\">\n              <FreeCadDrawing\n                springType={springType as \"compression\" | \"extension\" | \"torsion\" | \"conical\"}\n                geometry={{\n                  wireDiameter,\n                  meanDiameter,\n                  outerDiameter: meanDiameter + wireDiameter,\n                  activeCoils,\n                  totalCoils,\n                  freeLength,\n                  bodyLength,\n                }}\n                material={storeMaterial ?? undefined}\n                analysis={storeAnalysis ? { springRate: storeAnalysis.springRate } : undefined}\n                className=\"min-h-[500px]\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-2 text-center\">\n                <LanguageText \n                  en=\"Professional engineering drawing generated by FreeCAD - Click Generate to create\"\n                  zh=\"由 FreeCAD 生成的专业工程图 - 点击生成按钮创建\"\n                />\n              </p>\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            <LanguageText en=\"Export Options\" zh=\"导出选项\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* 格式选择 */}\n          {Object.entries(CAD_FORMAT_GROUPS).map(([group, formats]) => (\n            <div key={group} className=\"space-y-2\">\n              <Label className=\"text-xs text-slate-500\">{group}</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {formats.map((format: CadExportFormat) => {\n                  const meta = CAD_FORMAT_META[format];\n                  const isSelected = selectedFormats.includes(format);\n                  \n                  return (\n                    <button\n                      key={format}\n                      onClick={() => toggleFormat(format)}\n                      className={`\n                        px-3 py-1.5 rounded-md text-sm font-medium transition-colors\n                        ${isSelected \n                          ? 'bg-blue-600 text-white' \n                          : 'bg-slate-100 text-slate-700 hover:bg-slate-200'\n                        }\n                      `}\n                    >\n                      {meta.label}\n                    </button>\n                  );\n                })}\n              </div>\n            </div>\n          ))}\n\n          {/* 错误提示 */}\n          {error && (\n            <div className=\"flex items-center gap-2 p-3 bg-red-50 text-red-700 rounded-lg\">\n              <AlertCircle className=\"w-4 h-4\" />\n              <span className=\"text-sm\">{error}</span>\n            </div>\n          )}\n\n          {/* 导出按钮 */}\n          <Button \n            onClick={handleExport} \n            disabled={isExporting || selectedFormats.length === 0}\n            className=\"w-full\"\n          >\n            {isExporting ? (\n              <>\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                <LanguageText en=\"Exporting...\" zh=\"导出中...\" />\n              </>\n            ) : (\n              <>\n                <Download className=\"w-4 h-4 mr-2\" />\n                <LanguageText en=\"Export CAD Files\" zh=\"导出 CAD 文件\" />\n              </>\n            )}\n          </Button>\n\n          {/* 导出结果 */}\n          {exportedFiles.length > 0 && (\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center gap-2 text-green-600\">\n                <CheckCircle className=\"w-4 h-4\" />\n                <span className=\"text-sm font-medium\">\n                  <LanguageText en=\"Export Successful\" zh=\"导出成功\" />\n                </span>\n              </div>\n              \n              <div className=\"space-y-2\">\n                {exportedFiles.map((file, i) => (\n                  <div \n                    key={i}\n                    className=\"flex items-center justify-between p-3 bg-slate-50 rounded-lg\"\n                  >\n                    <div className=\"flex items-center gap-2\">\n                      <FileText className=\"w-4 h-4 text-slate-500\" />\n                      <span className=\"text-sm\">{file.fileName}</span>\n                      {file.fileSize && (\n                        <span className=\"text-xs text-slate-400\">\n                          ({(file.fileSize / 1024).toFixed(1)} KB)\n                        </span>\n                      )}\n                    </div>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => handleDownload(file)}\n                    >\n                      <Download className=\"w-4 h-4 mr-1\" />\n                      <LanguageText en=\"Download\" zh=\"下载\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* FreeCAD 高级导出 */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Box className=\"w-5 h-5\" />\n            <LanguageText en=\"FreeCAD Export (STEP/STL)\" zh=\"FreeCAD 导出（STEP/STL）\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <p className=\"text-sm text-muted-foreground\">\n            <LanguageText \n              en=\"Generate parametric 3D CAD models using FreeCAD. These files can be opened in SolidWorks, NX, CATIA, and other CAD software.\"\n              zh=\"使用 FreeCAD 生成参数化 3D CAD 模型。这些文件可以在 SolidWorks、NX、CATIA 等 CAD 软件中打开。\"\n            />\n          </p>\n          \n          {freecadStatus && (\n            <div className={`p-3 rounded-lg ${\n              freecadStatus.available ? \"bg-green-50 text-green-700\" : \"bg-amber-50 text-amber-700\"\n            }`}>\n              {freecadStatus.available ? (\n                <div className=\"flex items-center gap-2\">\n                  <CheckCircle className=\"w-4 h-4\" />\n                  <span className=\"text-sm\">FreeCAD {freecadStatus.version || \"available\"}</span>\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <AlertCircle className=\"w-4 h-4\" />\n                    <span className=\"text-sm font-medium\">\n                      <LanguageText \n                        en=\"FreeCAD not installed\"\n                        zh=\"FreeCAD 未安装\"\n                      />\n                    </span>\n                  </div>\n                  <div className=\"text-xs space-y-1 ml-6\">\n                    <p className=\"font-medium\">Windows:</p>\n                    <a \n                      href=\"https://github.com/FreeCAD/FreeCAD/releases/download/0.21.2/FreeCAD-0.21.2-WIN-x64-installer-1.exe\"\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className=\"text-blue-600 hover:underline block\"\n                    >\n                      <LanguageText \n                        en=\"Download FreeCAD 0.21.2 for Windows (64-bit)\"\n                        zh=\"下载 FreeCAD 0.21.2 Windows 版（64位）\"\n                      />\n                    </a>\n                    <p className=\"text-amber-600\">\n                      <LanguageText \n                        en=\"Install to: C:\\\\Program Files\\\\FreeCAD 0.21\"\n                        zh=\"安装路径：C:\\\\Program Files\\\\FreeCAD 0.21\"\n                      />\n                    </p>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n          \n          <Button \n            onClick={handleFreeCADExport} \n            disabled={isExportingFreeCAD || !freecadStatus?.available}\n            className=\"w-full\"\n            variant=\"secondary\"\n          >\n            {isExportingFreeCAD ? (\n              <>\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                <LanguageText en=\"Generating 3D Model...\" zh=\"生成 3D 模型中...\" />\n              </>\n            ) : (\n              <>\n                <Box className=\"w-4 h-4 mr-2\" />\n                <LanguageText en=\"Export STEP + STL (FreeCAD)\" zh=\"导出 STEP + STL（FreeCAD）\" />\n              </>\n            )}\n          </Button>\n\n          {/* FreeCAD 导出结果 */}\n          {exportedFiles.length > 0 && (\n            <div className=\"space-y-3 mt-4\">\n              <div className=\"flex items-center gap-2 text-green-600\">\n                <CheckCircle className=\"w-4 h-4\" />\n                <span className=\"text-sm font-medium\">\n                  <LanguageText en=\"FreeCAD Export Successful\" zh=\"FreeCAD 导出成功\" />\n                </span>\n              </div>\n              \n              <div className=\"space-y-2\">\n                {exportedFiles.map((file, i) => (\n                  <div \n                    key={i}\n                    className=\"flex items-center justify-between p-3 bg-slate-50 rounded-lg\"\n                  >\n                    <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                      <FileText className=\"w-4 h-4 text-slate-500 flex-shrink-0\" />\n                      <div className=\"min-w-0\">\n                        <span className=\"text-sm font-medium block truncate\">{file.fileName}</span>\n                        {file.fileSize && (\n                          <span className=\"text-xs text-slate-400\">\n                            {file.fileSize > 1024 * 1024 \n                              ? `${(file.fileSize / 1024 / 1024).toFixed(1)} MB`\n                              : `${(file.fileSize / 1024).toFixed(1)} KB`\n                            }\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => handleDownload(file)}\n                    >\n                      <Download className=\"w-4 h-4 mr-1\" />\n                      <LanguageText en=\"Download\" zh=\"下载\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <div className=\"flex flex-col gap-2 sm:flex-row\">\n        <Button asChild variant=\"outline\">\n          <a href={rfqUrl}>\n            <LanguageText en=\"Add to RFQ\" zh=\"添加到 RFQ\" />\n          </a>\n        </Button>\n      </div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/cad/CadExportPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":157,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":157,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\n/**\n * CAD Export Panel Component\n * CAD 导出面板组件\n * \n * 功能：\n * 1. 显示当前设计参数\n * 2. 选择导出格式\n * 3. 配置图纸设置\n * 4. 发起导出请求\n * 5. 显示下载链接\n */\n\nimport React, { useState, useMemo } from 'react';\nimport { \n  Download, \n  FileText, \n  Box, \n  Settings, \n  CheckCircle, \n  AlertCircle,\n  Loader2,\n  ChevronDown,\n  ChevronUp,\n} from 'lucide-react';\nimport type { \n  CadExportFormat, \n  SpringGeometry,\n  AnalysisSummary,\n  DrawingSettings,\n  ExportedFile,\n} from '@/lib/cad/types';\nimport { \n  CAD_FORMAT_GROUPS, \n  CAD_FORMAT_META,\n  DEFAULT_DRAWING_SETTINGS,\n} from '@/lib/cad/types';\nimport { requestCadExport, downloadExportedFile } from '@/lib/cad/exportService';\n\ninterface CadExportPanelProps {\n  /** 弹簧几何参数 */\n  geometry: SpringGeometry;\n  /** 分析结果（可选） */\n  analysisResult?: Partial<AnalysisSummary>;\n  /** 语言 */\n  language?: 'zh' | 'en';\n  /** 导出成功回调 */\n  onExportSuccess?: (files: ExportedFile[]) => void;\n  /** 导出失败回调 */\n  onExportError?: (error: Error) => void;\n}\n\nexport function CadExportPanel({\n  geometry,\n  analysisResult,\n  language = 'zh',\n  onExportSuccess,\n  onExportError,\n}: CadExportPanelProps) {\n  const isZh = language === 'zh';\n  \n  // 状态\n  const [selectedFormats, setSelectedFormats] = useState<CadExportFormat[]>(['STEP', 'PDF_2D']);\n  const [isExporting, setIsExporting] = useState(false);\n  const [exportedFiles, setExportedFiles] = useState<ExportedFile[]>([]);\n  const [error, setError] = useState<string | null>(null);\n  const [showSettings, setShowSettings] = useState(false);\n  const [drawingSettings, setDrawingSettings] = useState<DrawingSettings>(DEFAULT_DRAWING_SETTINGS);\n  \n  // 计算设计参数显示\n  const designParams = useMemo(() => {\n    const params: { label: string; value: string }[] = [];\n    \n    params.push({\n      label: isZh ? '线径 d' : 'Wire Diameter d',\n      value: `${geometry.wireDiameter} mm`,\n    });\n    \n    if ('meanDiameter' in geometry) {\n      params.push({\n        label: isZh ? '中径 Dm' : 'Mean Diameter Dm',\n        value: `${geometry.meanDiameter} mm`,\n      });\n    }\n    \n    params.push({\n      label: isZh ? '有效圈数 Na' : 'Active Coils Na',\n      value: `${geometry.activeCoils}`,\n    });\n    \n    if ('freeLength' in geometry) {\n      params.push({\n        label: isZh ? '自由长度 L₀' : 'Free Length L₀',\n        value: `${geometry.freeLength} mm`,\n      });\n    }\n    \n    if (geometry.type === 'torsion') {\n      const torsion = geometry as { legLength1: number; legLength2: number };\n      params.push({\n        label: isZh ? '腿长 L1/L2' : 'Leg Length L1/L2',\n        value: `${torsion.legLength1} / ${torsion.legLength2} mm`,\n      });\n    }\n    \n    return params;\n  }, [geometry, isZh]);\n  \n  // 切换格式选择\n  const toggleFormat = (format: CadExportFormat) => {\n    setSelectedFormats(prev => \n      prev.includes(format)\n        ? prev.filter(f => f !== format)\n        : [...prev, format]\n    );\n  };\n  \n  // 执行导出\n  const handleExport = async () => {\n    if (selectedFormats.length === 0) {\n      setError(isZh ? '请至少选择一种导出格式' : 'Please select at least one export format');\n      return;\n    }\n    \n    setIsExporting(true);\n    setError(null);\n    setExportedFiles([]);\n    \n    try {\n      const result = await requestCadExport(geometry, selectedFormats, {\n        analysisResult,\n        drawingSettings,\n      });\n      \n      if (result.status === 'failed') {\n        throw new Error(result.error?.message ?? 'Export failed');\n      }\n      \n      if (result.files) {\n        setExportedFiles(result.files);\n        onExportSuccess?.(result.files);\n      }\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Unknown error';\n      setError(errorMessage);\n      onExportError?.(err instanceof Error ? err : new Error(errorMessage));\n    } finally {\n      setIsExporting(false);\n    }\n  };\n  \n  // 下载文件\n  const handleDownload = async (file: ExportedFile) => {\n    try {\n      await downloadExportedFile(file.downloadUrl, file.fileName);\n    } catch (err) {\n      setError(isZh ? '下载失败' : 'Download failed');\n    }\n  };\n  \n  return (\n    <div className=\"bg-white rounded-lg shadow-lg p-6 space-y-6\">\n      {/* 标题 */}\n      <div className=\"flex items-center gap-2\">\n        <Box className=\"w-5 h-5 text-blue-600\" />\n        <h2 className=\"text-lg font-semibold\">\n          {isZh ? 'CAD 导出' : 'CAD Export'}\n        </h2>\n      </div>\n      \n      {/* 设计参数预览 */}\n      <div className=\"bg-slate-50 rounded-lg p-4\">\n        <h3 className=\"text-sm font-medium text-slate-700 mb-3\">\n          {isZh ? '当前设计参数' : 'Current Design Parameters'}\n        </h3>\n        <div className=\"grid grid-cols-2 gap-2 text-sm\">\n          {designParams.map((param, i) => (\n            <div key={i} className=\"flex justify-between\">\n              <span className=\"text-slate-500\">{param.label}</span>\n              <span className=\"font-mono\">{param.value}</span>\n            </div>\n          ))}\n        </div>\n      </div>\n      \n      {/* 格式选择 */}\n      <div className=\"space-y-3\">\n        <h3 className=\"text-sm font-medium text-slate-700\">\n          {isZh ? '导出格式' : 'Export Formats'}\n        </h3>\n        \n        {Object.entries(CAD_FORMAT_GROUPS).map(([group, formats]) => (\n          <div key={group} className=\"space-y-2\">\n            <p className=\"text-xs text-slate-500\">{group}</p>\n            <div className=\"flex flex-wrap gap-2\">\n              {formats.map(format => {\n                const meta = CAD_FORMAT_META[format];\n                const isSelected = selectedFormats.includes(format);\n                \n                return (\n                  <button\n                    key={format}\n                    onClick={() => toggleFormat(format)}\n                    className={`\n                      px-3 py-1.5 rounded-md text-sm font-medium transition-colors\n                      ${isSelected \n                        ? 'bg-blue-600 text-white' \n                        : 'bg-slate-100 text-slate-700 hover:bg-slate-200'\n                      }\n                    `}\n                  >\n                    {meta.label}\n                  </button>\n                );\n              })}\n            </div>\n          </div>\n        ))}\n      </div>\n      \n      {/* 图纸设置（可折叠） */}\n      <div className=\"border rounded-lg\">\n        <button\n          onClick={() => setShowSettings(!showSettings)}\n          className=\"w-full flex items-center justify-between p-3 hover:bg-slate-50\"\n        >\n          <div className=\"flex items-center gap-2\">\n            <Settings className=\"w-4 h-4 text-slate-500\" />\n            <span className=\"text-sm font-medium\">\n              {isZh ? '图纸设置' : 'Drawing Settings'}\n            </span>\n          </div>\n          {showSettings ? (\n            <ChevronUp className=\"w-4 h-4 text-slate-500\" />\n          ) : (\n            <ChevronDown className=\"w-4 h-4 text-slate-500\" />\n          )}\n        </button>\n        \n        {showSettings && (\n          <div className=\"p-3 border-t space-y-3\">\n            <div className=\"grid grid-cols-2 gap-3\">\n              <div>\n                <label className=\"text-xs text-slate-500\">\n                  {isZh ? '图纸尺寸' : 'Paper Size'}\n                </label>\n                <select\n                  value={drawingSettings.size}\n                  onChange={e => setDrawingSettings(s => ({ ...s, size: e.target.value as DrawingSettings['size'] }))}\n                  className=\"w-full mt-1 px-2 py-1 border rounded text-sm\"\n                >\n                  <option value=\"A4\">A4</option>\n                  <option value=\"A3\">A3</option>\n                  <option value=\"A2\">A2</option>\n                </select>\n              </div>\n              <div>\n                <label className=\"text-xs text-slate-500\">\n                  {isZh ? '比例' : 'Scale'}\n                </label>\n                <select\n                  value={drawingSettings.scale}\n                  onChange={e => setDrawingSettings(s => ({ ...s, scale: e.target.value }))}\n                  className=\"w-full mt-1 px-2 py-1 border rounded text-sm\"\n                >\n                  <option value=\"1:1\">1:1</option>\n                  <option value=\"2:1\">2:1</option>\n                  <option value=\"1:2\">1:2</option>\n                  <option value=\"5:1\">5:1</option>\n                </select>\n              </div>\n            </div>\n            \n            <div className=\"flex flex-wrap gap-3\">\n              <label className=\"flex items-center gap-2 text-sm\">\n                <input\n                  type=\"checkbox\"\n                  checked={drawingSettings.showDimensions}\n                  onChange={e => setDrawingSettings(s => ({ ...s, showDimensions: e.target.checked }))}\n                  className=\"rounded\"\n                />\n                {isZh ? '显示尺寸' : 'Show Dimensions'}\n              </label>\n              <label className=\"flex items-center gap-2 text-sm\">\n                <input\n                  type=\"checkbox\"\n                  checked={drawingSettings.showTolerances}\n                  onChange={e => setDrawingSettings(s => ({ ...s, showTolerances: e.target.checked }))}\n                  className=\"rounded\"\n                />\n                {isZh ? '显示公差' : 'Show Tolerances'}\n              </label>\n            </div>\n          </div>\n        )}\n      </div>\n      \n      {/* 错误提示 */}\n      {error && (\n        <div className=\"flex items-center gap-2 p-3 bg-red-50 text-red-700 rounded-lg\">\n          <AlertCircle className=\"w-4 h-4\" />\n          <span className=\"text-sm\">{error}</span>\n        </div>\n      )}\n      \n      {/* 导出按钮 */}\n      <button\n        onClick={handleExport}\n        disabled={isExporting || selectedFormats.length === 0}\n        className={`\n          w-full flex items-center justify-center gap-2 py-3 rounded-lg font-medium transition-colors\n          ${isExporting || selectedFormats.length === 0\n            ? 'bg-slate-200 text-slate-500 cursor-not-allowed'\n            : 'bg-blue-600 text-white hover:bg-blue-700'\n          }\n        `}\n      >\n        {isExporting ? (\n          <>\n            <Loader2 className=\"w-5 h-5 animate-spin\" />\n            {isZh ? '导出中...' : 'Exporting...'}\n          </>\n        ) : (\n          <>\n            <Download className=\"w-5 h-5\" />\n            {isZh ? '导出 CAD 文件' : 'Export CAD Files'}\n          </>\n        )}\n      </button>\n      \n      {/* 导出结果 */}\n      {exportedFiles.length > 0 && (\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center gap-2 text-green-600\">\n            <CheckCircle className=\"w-4 h-4\" />\n            <span className=\"text-sm font-medium\">\n              {isZh ? '导出成功' : 'Export Successful'}\n            </span>\n          </div>\n          \n          <div className=\"space-y-2\">\n            {exportedFiles.map((file, i) => (\n              <div \n                key={i}\n                className=\"flex items-center justify-between p-3 bg-slate-50 rounded-lg\"\n              >\n                <div className=\"flex items-center gap-2\">\n                  <FileText className=\"w-4 h-4 text-slate-500\" />\n                  <span className=\"text-sm\">{file.fileName}</span>\n                  {file.fileSize && (\n                    <span className=\"text-xs text-slate-400\">\n                      ({(file.fileSize / 1024).toFixed(1)} KB)\n                    </span>\n                  )}\n                </div>\n                <button\n                  onClick={() => handleDownload(file)}\n                  className=\"px-3 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded\"\n                >\n                  {isZh ? '下载' : 'Download'}\n                </button>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default CadExportPanel;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/cad/CadPreview3D.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/cad/FreeCadDrawing.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/cad/FreeCadDrawing.tsx:103:7\n  101 |     const cached = drawingCache.get(cacheKey);\n  102 |     if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n> 103 |       setState({ status: \"success\", svgContent: cached.svg });\n      |       ^^^^^^^^ Avoid calling setState() directly within an effect\n  104 |     }\n  105 |   }, [cacheKey]);\n  106 |   ","line":103,"column":7,"nodeType":null,"endLine":103,"endColumn":15},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":213,"column":22,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6486,6520],"text":"Click &quot;Generate Drawing\" to create"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6486,6520],"text":"Click &ldquo;Generate Drawing\" to create"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6486,6520],"text":"Click &#34;Generate Drawing\" to create"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6486,6520],"text":"Click &rdquo;Generate Drawing\" to create"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":213,"column":39,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[6486,6520],"text":"Click \"Generate Drawing&quot; to create"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[6486,6520],"text":"Click \"Generate Drawing&ldquo; to create"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[6486,6520],"text":"Click \"Generate Drawing&#34; to create"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[6486,6520],"text":"Click \"Generate Drawing&rdquo; to create"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useState, useCallback, useEffect, useMemo } from \"react\";\nimport { Loader2, RefreshCw, Download, CheckCircle, AlertCircle } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface FreeCadDrawingProps {\n  springType: \"compression\" | \"extension\" | \"torsion\" | \"conical\";\n  geometry: {\n    wireDiameter: number;\n    meanDiameter?: number;\n    outerDiameter?: number;\n    activeCoils: number;\n    totalCoils?: number;\n    freeLength?: number;\n    bodyLength?: number;\n  };\n  material?: {\n    name: string;\n  };\n  analysis?: {\n    springRate?: number;\n  };\n  className?: string;\n}\n\ninterface DrawingState {\n  status: \"idle\" | \"loading\" | \"success\" | \"error\";\n  message?: string;\n  svgContent?: string;\n}\n\n// 缓存\nconst drawingCache = new Map<string, { svg: string; timestamp: number }>();\nconst CACHE_TTL = 10 * 60 * 1000;\n\nfunction getCacheKey(springType: string, geometry: Record<string, unknown>): string {\n  return JSON.stringify({ springType, geometry, type: \"drawing\" });\n}\n\n/**\n * 加载指示器 - 带倒计时\n */\nfunction LoadingIndicator({ message, estimatedTime = 10 }: { message: string; estimatedTime?: number }) {\n  const [elapsed, setElapsed] = useState(0);\n  \n  useEffect(() => {\n    const startTime = Date.now();\n    const interval = setInterval(() => {\n      setElapsed(Math.floor((Date.now() - startTime) / 1000));\n    }, 1000);\n    return () => clearInterval(interval);\n  }, []);\n  \n  const remaining = Math.max(0, estimatedTime - elapsed);\n  const progress = Math.min(100, (elapsed / estimatedTime) * 100);\n  \n  return (\n    <div className=\"flex flex-col items-center gap-3 min-w-[200px]\">\n      <Loader2 className=\"w-8 h-8 animate-spin text-blue-500\" />\n      <span className=\"text-sm font-medium text-muted-foreground\">{message}</span>\n      \n      {/* 进度条 */}\n      <div className=\"w-48 bg-gray-200 rounded-full h-2\">\n        <div \n          className=\"bg-blue-500 h-2 rounded-full transition-all duration-1000\"\n          style={{ width: `${progress}%` }}\n        />\n      </div>\n      \n      {/* 时间显示 */}\n      <div className=\"text-xs text-muted-foreground\">\n        {remaining > 0 ? (\n          <span>预计剩余 ~{remaining} 秒</span>\n        ) : (\n          <span>即将完成...</span>\n        )}\n        <span className=\"ml-2 text-gray-400\">({elapsed}s)</span>\n      </div>\n    </div>\n  );\n}\n\n/**\n * FreeCAD 2D 工程图组件\n * 调用后端生成专业的 SVG 工程图\n */\nexport function FreeCadDrawing({\n  springType,\n  geometry,\n  material,\n  analysis,\n  className = \"\",\n}: FreeCadDrawingProps) {\n  const [state, setState] = useState<DrawingState>({ status: \"idle\" });\n  \n  const cacheKey = useMemo(() => getCacheKey(springType, geometry), [springType, geometry]);\n  \n  // 检查缓存\n  useEffect(() => {\n    const cached = drawingCache.get(cacheKey);\n    if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n      setState({ status: \"success\", svgContent: cached.svg });\n    }\n  }, [cacheKey]);\n  \n  const generateDrawing = useCallback(async (forceRefresh = false) => {\n    // 检查缓存\n    if (!forceRefresh) {\n      const cached = drawingCache.get(cacheKey);\n      if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n        setState({ status: \"success\", svgContent: cached.svg });\n        return;\n      }\n    }\n    \n    setState({ status: \"loading\", message: \"Generating engineering drawing...\" });\n    \n    try {\n      const response = await fetch(\"/api/freecad/drawing\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          springType,\n          geometry,\n          material,\n          analysis,\n        }),\n      });\n      \n      const result = await response.json();\n      \n      if (result.status !== \"success\") {\n        setState({ status: \"error\", message: result.message || \"Failed to generate drawing\" });\n        return;\n      }\n      \n      // 保存到缓存\n      drawingCache.set(cacheKey, { svg: result.svg, timestamp: Date.now() });\n      \n      setState({ status: \"success\", svgContent: result.svg });\n      \n    } catch (error) {\n      setState({\n        status: \"error\",\n        message: error instanceof Error ? error.message : \"Unknown error\",\n      });\n    }\n  }, [springType, geometry, material, analysis, cacheKey]);\n  \n  const downloadSVG = useCallback(() => {\n    if (!state.svgContent) return;\n    \n    const blob = new Blob([state.svgContent], { type: \"image/svg+xml\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `${springType}_spring_drawing.svg`;\n    a.click();\n    URL.revokeObjectURL(url);\n  }, [state.svgContent, springType]);\n  \n  return (\n    <div className={`relative bg-white rounded-lg border ${className}`}>\n      {/* 控制按钮 */}\n      <div className=\"absolute top-2 right-2 z-10 flex gap-2\">\n        <Button\n          size=\"sm\"\n          variant=\"secondary\"\n          onClick={() => generateDrawing(state.status === \"success\")}\n          disabled={state.status === \"loading\"}\n        >\n          {state.status === \"loading\" ? (\n            <Loader2 className=\"w-4 h-4 animate-spin\" />\n          ) : (\n            <RefreshCw className=\"w-4 h-4\" />\n          )}\n          <span className=\"ml-1\">\n            {state.status === \"idle\" ? \"Generate Drawing\" : \"Refresh\"}\n          </span>\n        </Button>\n        \n        {state.status === \"success\" && (\n          <Button size=\"sm\" variant=\"outline\" onClick={downloadSVG}>\n            <Download className=\"w-4 h-4\" />\n            <span className=\"ml-1\">Download SVG</span>\n          </Button>\n        )}\n      </div>\n      \n      {/* 状态指示 */}\n      {state.status !== \"idle\" && state.status !== \"loading\" && (\n        <div className=\"absolute top-2 left-2 z-10\">\n          {state.status === \"success\" && (\n            <div className=\"flex items-center gap-1 bg-green-500/90 text-white px-2 py-1 rounded text-xs\">\n              <CheckCircle className=\"w-3 h-3\" />\n              <span>FreeCAD Drawing</span>\n            </div>\n          )}\n          {state.status === \"error\" && (\n            <div className=\"flex items-center gap-1 bg-red-500/90 text-white px-2 py-1 rounded text-xs\">\n              <AlertCircle className=\"w-3 h-3\" />\n              <span>Error</span>\n            </div>\n          )}\n        </div>\n      )}\n      \n      {/* 内容区域 */}\n      <div className=\"min-h-[500px] flex items-center justify-center p-4\">\n        {state.status === \"idle\" && (\n          <div className=\"text-center text-muted-foreground\">\n            <p>Click \"Generate Drawing\" to create</p>\n            <p className=\"text-sm mt-1\">a professional engineering drawing using FreeCAD</p>\n          </div>\n        )}\n        \n        {state.status === \"loading\" && (\n          <LoadingIndicator message={state.message || \"生成中...\"} estimatedTime={10} />\n        )}\n        \n        {state.status === \"error\" && (\n          <div className=\"text-center text-red-500\">\n            <AlertCircle className=\"w-8 h-8 mx-auto mb-2\" />\n            <p>{state.message}</p>\n          </div>\n        )}\n        \n        {state.status === \"success\" && state.svgContent && (\n          <div \n            className=\"w-full h-full\"\n            dangerouslySetInnerHTML={{ __html: state.svgContent }}\n          />\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default FreeCadDrawing;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/cad/FreeCadPreview.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'geometry'. Either include it or remove the dependency array.","line":226,"column":50,"nodeType":"ArrayExpression","endLine":226,"endColumn":64,"suggestions":[{"desc":"Update the dependencies array to be: [geometry]","fix":{"range":[6193,6207],"text":"[geometry]"}}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/cad/FreeCadPreview.tsx:236:7\n  234 |     if (cached) {\n  235 |       console.log(\"[FreeCadPreview] Using cached geometry\");\n> 236 |       setState({ status: \"cached\", geometry: cached });\n      |       ^^^^^^^^ Avoid calling setState() directly within an effect\n  237 |     }\n  238 |   }, [cacheKey]);\n  239 |   ","line":236,"column":7,"nodeType":null,"endLine":236,"endColumn":15},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":409,"column":44,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[12397,12435],"text":"Click &quot;Generate CAD Preview\" to create"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[12397,12435],"text":"Click &ldquo;Generate CAD Preview\" to create"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[12397,12435],"text":"Click &#34;Generate CAD Preview\" to create"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[12397,12435],"text":"Click &rdquo;Generate CAD Preview\" to create"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":409,"column":65,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[12397,12435],"text":"Click \"Generate CAD Preview&quot; to create"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[12397,12435],"text":"Click \"Generate CAD Preview&ldquo; to create"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[12397,12435],"text":"Click \"Generate CAD Preview&#34; to create"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[12397,12435],"text":"Click \"Generate CAD Preview&rdquo; to create"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useRef, useEffect, useState, useCallback, useMemo } from \"react\";\nimport { Canvas, useThree, useFrame } from \"@react-three/fiber\";\nimport { OrbitControls, Environment, Center, Html } from \"@react-three/drei\";\nimport * as THREE from \"three\";\nimport { STLLoader } from \"three/examples/jsm/loaders/STLLoader.js\";\nimport { Loader2, RefreshCw, AlertCircle, CheckCircle } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\n// ============================================================================\n// 缓存机制 - 保存生成的几何体，切换 Tab 后不需要重新生成\n// ============================================================================\n\ninterface CacheEntry {\n  geometry: THREE.BufferGeometry;\n  timestamp: number;\n}\n\n// 全局缓存 (模块级别，组件卸载后仍然保留)\nconst geometryCache = new Map<string, CacheEntry>();\nconst CACHE_TTL = 10 * 60 * 1000; // 10 分钟缓存有效期\n\nfunction getCacheKey(springType: string, geometry: Record<string, unknown>): string {\n  // 创建稳定的缓存键\n  const key = JSON.stringify({ springType, geometry });\n  return key;\n}\n\nfunction getCachedGeometry(key: string): THREE.BufferGeometry | null {\n  const entry = geometryCache.get(key);\n  if (entry && Date.now() - entry.timestamp < CACHE_TTL) {\n    return entry.geometry;\n  }\n  // 清理过期缓存\n  if (entry) {\n    geometryCache.delete(key);\n  }\n  return null;\n}\n\nfunction setCachedGeometry(key: string, geometry: THREE.BufferGeometry): void {\n  geometryCache.set(key, { geometry, timestamp: Date.now() });\n  \n  // 限制缓存大小 (最多保留 5 个)\n  if (geometryCache.size > 5) {\n    const oldestKey = geometryCache.keys().next().value;\n    if (oldestKey) {\n      geometryCache.delete(oldestKey);\n    }\n  }\n}\n\n/** 清除所有缓存 */\nexport function clearGeometryCache(): void {\n  geometryCache.clear();\n  console.log(\"[FreeCadPreview] Cache cleared\");\n}\n\n// ============================================================================\n\ninterface FreeCadPreviewProps {\n  springType: \"compression\" | \"extension\" | \"torsion\" | \"conical\" | \"spiral_torsion\";\n  geometry: {\n    wireDiameter?: number;\n    meanDiameter?: number;\n    outerDiameter?: number;\n    activeCoils?: number;\n    totalCoils?: number;\n    freeLength?: number;\n    bodyLength?: number;\n    hookType?: string;\n    legLength1?: number;\n    legLength2?: number;\n    windingDirection?: \"left\" | \"right\";\n    // Conical specific\n    largeOuterDiameter?: number;\n    smallOuterDiameter?: number;\n    endType?: \"natural\" | \"closed\" | \"closed_ground\";\n    // Compression specific\n    topGround?: boolean;\n    bottomGround?: boolean;\n    // Spiral Torsion specific\n    innerDiameter?: number;\n    turns?: number;\n    stripWidth?: number;\n    stripThickness?: number;\n    handedness?: \"cw\" | \"ccw\";\n  };\n  className?: string;\n}\n\ninterface PreviewState {\n  status: \"idle\" | \"loading\" | \"success\" | \"error\" | \"unavailable\" | \"cached\";\n  message?: string;\n  geometry?: THREE.BufferGeometry;\n}\n\n/**\n * STL 模型渲染组件\n */\nfunction STLModel({ geometry }: { geometry: THREE.BufferGeometry }) {\n  const meshRef = useRef<THREE.Mesh>(null);\n  \n  // 计算缩放因子使模型适合视图\n  const scale = useMemo(() => {\n    geometry.computeBoundingBox();\n    const bbox = geometry.boundingBox;\n    if (!bbox) return 1;\n    \n    const size = new THREE.Vector3();\n    bbox.getSize(size);\n    const maxDim = Math.max(size.x, size.y, size.z);\n    \n    // 目标大小约 30 单位\n    const targetSize = 30;\n    const scaleFactor = maxDim > 0 ? targetSize / maxDim : 1;\n    \n    console.log(\"[STLModel] Size:\", size, \"Scale:\", scaleFactor);\n    return scaleFactor;\n  }, [geometry]);\n  \n  // 自动旋转\n  useFrame((state) => {\n    if (meshRef.current) {\n      meshRef.current.rotation.y = state.clock.elapsedTime * 0.2;\n    }\n  });\n  \n  return (\n    <Center>\n      <mesh \n        ref={meshRef} \n        geometry={geometry} \n        scale={[scale, scale, scale]}\n        castShadow \n        receiveShadow\n      >\n        <meshStandardMaterial\n          color=\"#4a90d9\"\n          metalness={previewTheme.material.spring.metalness}\n          roughness={previewTheme.material.spring.roughness}\n          envMapIntensity={1}\n        />\n      </mesh>\n    </Center>\n  );\n}\n\n/**\n * 加载状态显示 - 带倒计时\n */\nfunction LoadingOverlay({ message, estimatedTime = 15 }: { message: string; estimatedTime?: number }) {\n  const [elapsed, setElapsed] = useState(0);\n  \n  useEffect(() => {\n    const startTime = Date.now();\n    const interval = setInterval(() => {\n      setElapsed(Math.floor((Date.now() - startTime) / 1000));\n    }, 1000);\n    return () => clearInterval(interval);\n  }, []);\n  \n  const remaining = Math.max(0, estimatedTime - elapsed);\n  const progress = Math.min(100, (elapsed / estimatedTime) * 100);\n  \n  return (\n    <Html center>\n      <div className=\"flex flex-col items-center gap-3 text-slate-900 bg-white/90 px-6 py-4 rounded-lg min-w-[200px] shadow\">\n        <Loader2 className=\"w-8 h-8 animate-spin\" />\n        <span className=\"text-sm font-medium\">{message}</span>\n        \n        {/* 进度条 */}\n        <div className=\"w-full bg-slate-200 rounded-full h-2\">\n          <div \n            className=\"bg-blue-500 h-2 rounded-full transition-all duration-1000\"\n            style={{ width: `${progress}%` }}\n          />\n        </div>\n        \n        {/* 时间显示 */}\n        <div className=\"text-xs text-slate-600\">\n          {remaining > 0 ? (\n            <span>预计剩余 ~{remaining} 秒</span>\n          ) : (\n            <span>即将完成...</span>\n          )}\n          <span className=\"ml-2 text-slate-500\">({elapsed}s)</span>\n        </div>\n      </div>\n    </Html>\n  );\n}\n\n/**\n * 场景设置\n */\nfunction SceneSetup() {\n  const { camera } = useThree();\n  \n  useEffect(() => {\n    camera.position.set(50, 30, 50);\n    camera.lookAt(0, 0, 0);\n  }, [camera]);\n  \n  return null;\n}\n\n/**\n * FreeCAD 3D 预览组件\n * \n * 调用后端 FreeCAD API 生成真正的 CAD 模型并在浏览器中预览\n */\nexport function FreeCadPreview({\n  springType,\n  geometry,\n  className = \"\",\n}: FreeCadPreviewProps) {\n  const [state, setState] = useState<PreviewState>({ status: \"idle\" });\n  const abortControllerRef = useRef<AbortController | null>(null);\n  \n  // 稳定化 geometry 引用，避免无限循环\n  const geometryJson = JSON.stringify(geometry);\n  const stableGeometry = useMemo(() => geometry, [geometryJson]);\n  \n  // 计算缓存键\n  const cacheKey = useMemo(() => getCacheKey(springType, stableGeometry), [springType, stableGeometry]);\n  \n  // 组件挂载时检查缓存\n  useEffect(() => {\n    const cached = getCachedGeometry(cacheKey);\n    if (cached) {\n      console.log(\"[FreeCadPreview] Using cached geometry\");\n      setState({ status: \"cached\", geometry: cached });\n    }\n  }, [cacheKey]);\n  \n  const loadPreview = useCallback(async (forceRefresh = false) => {\n    // 如果强制刷新，清除所有缓存\n    if (forceRefresh) {\n      geometryCache.clear();  // Clear ALL cache, not just current key\n      console.log(\"[FreeCadPreview] ALL cache cleared, forcing refresh\");\n    }\n    \n    // 如果不是强制刷新，先检查缓存\n    if (!forceRefresh) {\n      const cached = getCachedGeometry(cacheKey);\n      if (cached) {\n        setState({ status: \"cached\", geometry: cached });\n        return;\n      }\n    }\n    \n    // 取消之前的请求\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n    }\n    abortControllerRef.current = new AbortController();\n    \n    setState({ status: \"loading\", message: \"Generating CAD model...\" });\n    \n    try {\n      const response = await fetch(\"/api/freecad/preview\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ springType, geometry: stableGeometry }),\n        signal: abortControllerRef.current.signal,\n      });\n      \n      const result = await response.json();\n      \n      if (result.status === \"unavailable\") {\n        setState({ status: \"unavailable\", message: result.message });\n        return;\n      }\n      \n      if (result.status !== \"success\") {\n        setState({ status: \"error\", message: result.message || \"Failed to generate preview\" });\n        return;\n      }\n      \n      // 解析 STL 数据\n      console.log(\"[FreeCadPreview] Received data length:\", result.data?.length);\n      \n      const stlData = atob(result.data);\n      const stlBuffer = new ArrayBuffer(stlData.length);\n      const stlView = new Uint8Array(stlBuffer);\n      for (let i = 0; i < stlData.length; i++) {\n        stlView[i] = stlData.charCodeAt(i);\n      }\n      \n      console.log(\"[FreeCadPreview] STL buffer size:\", stlBuffer.byteLength);\n      \n      // 加载 STL\n      const loader = new STLLoader();\n      const stlGeometry = loader.parse(stlBuffer);\n      stlGeometry.computeVertexNormals();\n      \n      // 计算边界框\n      stlGeometry.computeBoundingBox();\n      const bbox = stlGeometry.boundingBox;\n      console.log(\"[FreeCadPreview] Geometry bounding box:\", bbox);\n      console.log(\"[FreeCadPreview] Vertex count:\", stlGeometry.attributes.position?.count);\n      \n      // 保存到缓存\n      setCachedGeometry(cacheKey, stlGeometry);\n      \n      setState({ status: \"success\", geometry: stlGeometry });\n      \n    } catch (error) {\n      if (error instanceof Error && error.name === \"AbortError\") {\n        return;\n      }\n      setState({ \n        status: \"error\", \n        message: error instanceof Error ? error.message : \"Unknown error\" \n      });\n    }\n  }, [springType, stableGeometry, cacheKey]);\n  \n  // 组件卸载时取消请求\n  useEffect(() => {\n    return () => {\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n      }\n    };\n  }, []);\n  \n  return (\n    <div className={`relative ${className}`}>\n      {/* 控制按钮 */}\n      <div className=\"absolute top-2 right-2 z-10 flex gap-2\">\n        <Button\n          size=\"sm\"\n          variant=\"secondary\"\n          onClick={() => loadPreview(true)}  // Always force refresh when clicking\n          disabled={state.status === \"loading\"}\n          className=\"bg-white/90 hover:bg-white\"\n        >\n          {state.status === \"loading\" ? (\n            <Loader2 className=\"w-4 h-4 animate-spin\" />\n          ) : (\n            <RefreshCw className=\"w-4 h-4\" />\n          )}\n          <span className=\"ml-1\">\n            {state.status === \"idle\" ? \"Generate CAD Preview\" : \"Refresh\"}\n          </span>\n        </Button>\n      </div>\n      \n      {/* 状态指示器 */}\n      {state.status !== \"idle\" && state.status !== \"loading\" && (\n        <div className=\"absolute top-2 left-2 z-10\">\n          {(state.status === \"success\" || state.status === \"cached\") && (\n            <div className=\"flex items-center gap-1 bg-green-500/90 text-white px-2 py-1 rounded text-xs\">\n              <CheckCircle className=\"w-3 h-3\" />\n              <span>{state.status === \"cached\" ? \"Cached\" : \"FreeCAD Model\"}</span>\n            </div>\n          )}\n          {state.status === \"error\" && (\n            <div className=\"flex items-center gap-1 bg-red-500/90 text-white px-2 py-1 rounded text-xs\">\n              <AlertCircle className=\"w-3 h-3\" />\n              <span>Error</span>\n            </div>\n          )}\n          {state.status === \"unavailable\" && (\n            <div className=\"flex items-center gap-1 bg-amber-500/90 text-white px-2 py-1 rounded text-xs\">\n              <AlertCircle className=\"w-3 h-3\" />\n              <span>FreeCAD Not Installed</span>\n            </div>\n          )}\n        </div>\n      )}\n      \n      {/* 3D 画布 */}\n      <Canvas\n        shadows\n        camera={{ position: [50, 30, 50], fov: 50 }}\n        className=\"rounded-lg\"\n      >\n        <SceneSetup />\n\n        <color attach=\"background\" args={[previewTheme.background]} />\n        \n        {/* 灯光 */}\n        <ambientLight intensity={previewTheme.lights.ambient} />\n        <directionalLight\n          position={previewTheme.lights.key.position}\n          intensity={previewTheme.lights.key.intensity}\n          castShadow\n          shadow-mapSize={[2048, 2048]}\n        />\n        <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n        \n        {/* 环境 */}\n        <Environment preset=\"studio\" />\n        \n        {/* 模型或占位符 */}\n        {(state.status === \"success\" || state.status === \"cached\") && state.geometry ? (\n          <STLModel geometry={state.geometry} />\n        ) : state.status === \"loading\" ? (\n          <LoadingOverlay message=\"正在生成 CAD 模型...\" estimatedTime={60} />\n        ) : state.status === \"idle\" ? (\n          <Html center>\n            <div className=\"text-center text-slate-700 px-4\">\n              <p className=\"text-sm\">Click \"Generate CAD Preview\" to create</p>\n              <p className=\"text-xs mt-1\">a real CAD model using FreeCAD</p>\n            </div>\n          </Html>\n        ) : state.status === \"error\" || state.status === \"unavailable\" ? (\n          <Html center>\n            <div className=\"text-center text-slate-700 px-4\">\n              <AlertCircle className=\"w-8 h-8 mx-auto mb-2 text-amber-400\" />\n              <p className=\"text-sm\">{state.message}</p>\n            </div>\n          </Html>\n        ) : null}\n        \n        {/* 控制器 */}\n        <OrbitControls\n          enablePan={true}\n          enableZoom={true}\n          enableRotate={true}\n          minDistance={20}\n          maxDistance={200}\n        />\n        \n        {/* 网格地面 */}\n        <gridHelper args={[100, 20, previewTheme.grid.major, previewTheme.grid.minor]} position={[0, -20, 0]} />\n      </Canvas>\n      \n      {/* 底部提示 */}\n      <div className=\"absolute bottom-2 left-2 right-2 text-center\">\n        <p className=\"text-xs text-slate-600\">\n          {state.status === \"success\" || state.status === \"cached\"\n            ? `Real CAD geometry from FreeCAD${state.status === \"cached\" ? \" (cached)\" : \"\"} • Drag to rotate • Scroll to zoom`\n            : \"Preview will show actual CAD model generated by FreeCAD\"\n          }\n        </p>\n      </div>\n    </div>\n  );\n}\n\nexport default FreeCadPreview;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ArcSpringAdvancedPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ArcSpringCalculator.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Legend' is defined but never used.","line":36,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":9},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'NumberInput' is defined but never used.","line":63,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":63,"endColumn":21},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ArcSpringCalculator.tsx:107:5\n  105 |\n  106 |   useEffect(() => {\n> 107 |     setExpandedMax((prev) => Math.max(prev, safeMax));\n      |     ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  108 |   }, [safeMax]);\n  109 |\n  110 |   useEffect(() => {","line":107,"column":5,"nodeType":null,"endLine":107,"endColumn":19},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ArcSpringCalculator.tsx:112:30\n  110 |   useEffect(() => {\n  111 |     if (!isFinite(value)) return;\n> 112 |     if (value > expandedMax) setExpandedMax(value);\n      |                              ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  113 |   }, [value, expandedMax]);\n  114 |\n  115 |   const effectiveMax = Math.max(min, expandedMax);","line":112,"column":30,"nodeType":null,"endLine":112,"endColumn":44},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ArcSpringCalculator.tsx:198:5\n  196 |\n  197 |   useEffect(() => {\n> 198 |     setMounted(true);\n      |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  199 |   }, []);\n  200 |\n  201 |   const fieldRefs = React.useRef<Partial<Record<ArcIssueField, HTMLDivElement | null>>>({});","line":198,"column":5,"nodeType":null,"endLine":198,"endColumn":15},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ArcSpringCalculator.tsx:255:5\n  253 |     if (!autoCalculate) return;\n  254 |     if (hasRuleError) return;\n> 255 |     setIsCalculating(true);\n      |     ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  256 |     const t = setTimeout(() => {\n  257 |       const newResult = computeArcSpringCurve(input);\n  258 |       setResult(newResult);","line":255,"column":5,"nodeType":null,"endLine":255,"endColumn":21},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":894,"column":45,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[33585,33610],"text":"请点击&quot;Calculate / 计算\"按钮查看结果"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[33585,33610],"text":"请点击&ldquo;Calculate / 计算\"按钮查看结果"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[33585,33610],"text":"请点击&#34;Calculate / 计算\"按钮查看结果"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[33585,33610],"text":"请点击&rdquo;Calculate / 计算\"按钮查看结果"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":894,"column":60,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[33585,33610],"text":"请点击\"Calculate / 计算&quot;按钮查看结果"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[33585,33610],"text":"请点击\"Calculate / 计算&ldquo;按钮查看结果"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[33585,33610],"text":"请点击\"Calculate / 计算&#34;按钮查看结果"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[33585,33610],"text":"请点击\"Calculate / 计算&rdquo;按钮查看结果"},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useEffect, useMemo, useState } from \"react\";\nimport dynamic from \"next/dynamic\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Button } from \"@/components/ui/button\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { AlertCircle, Settings2, Circle, Layers, Activity, FileText, Printer, Download } from \"lucide-react\";\nimport { DesignRulePanel } from \"@/components/design-rules/DesignRulePanel\";\nimport { ArcSpringAdvancedPanel } from \"@/components/calculators/ArcSpringAdvancedPanel\";\nimport {\n  ArcSpringInput,\n  ArcSpringResult,\n  HysteresisMode,\n  SystemMode,\n  MaterialKey,\n  computeArcSpringCurve,\n  getDefaultArcSpringInput,\n  ARC_SPRING_MATERIALS,\n  downloadArcSpringPDF,\n  printArcSpringReport,\n} from \"@/lib/arcSpring\";\nimport { buildArcSpringDesignRuleReport } from \"@/lib/designRules\";\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n  ReferenceLine,\n} from \"recharts\";\n\nconst ArcSpringVisualizer = dynamic(\n  () => import(\"@/components/three/ArcSpringMesh\").then((mod) => mod.ArcSpringVisualizer),\n  {\n    ssr: false,\n    loading: () => (\n      <div className=\"h-full w-full flex items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n        Loading 3D...\n      </div>\n    ),\n  }\n);\n\ninterface NumberInputProps {\n  label: string;\n  value: number;\n  onChange: (value: number) => void;\n  unit?: string;\n  min?: number;\n  step?: number;\n  disabled?: boolean;\n}\n\nfunction NumberInput({ label, value, onChange, unit, min = 0, step = 0.1, disabled }: NumberInputProps) {\n  return (\n    <div className=\"space-y-1\">\n      <Label className=\"text-sm text-muted-foreground\">\n        {label} {unit && <span className=\"text-xs\">({unit})</span>}\n      </Label>\n      <Input\n        type=\"number\"\n        value={value}\n        onChange={(e) => onChange(parseFloat(e.target.value) || 0)}\n        min={min}\n        step={step}\n        disabled={disabled}\n        className=\"h-9 arc-no-spinner\"\n      />\n    </div>\n  );\n}\n\ninterface SliderNumberInputProps {\n  label: string;\n  value: number;\n  onChange: (value: number) => void;\n  unit?: string;\n  min: number;\n  max: number;\n  step: number;\n  disabled?: boolean;\n}\n\nfunction SliderNumberInput({\n  label,\n  value,\n  onChange,\n  unit,\n  min,\n  max,\n  step,\n  disabled,\n}: SliderNumberInputProps) {\n  const safeMax = Math.max(min, max);\n  const [expandedMax, setExpandedMax] = useState(safeMax);\n\n  useEffect(() => {\n    setExpandedMax((prev) => Math.max(prev, safeMax));\n  }, [safeMax]);\n\n  useEffect(() => {\n    if (!isFinite(value)) return;\n    if (value > expandedMax) setExpandedMax(value);\n  }, [value, expandedMax]);\n\n  const effectiveMax = Math.max(min, expandedMax);\n  const sliderValue = Math.min(Math.max(value, min), effectiveMax);\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex items-end justify-between gap-2\">\n        <Label className=\"text-sm text-muted-foreground\">\n          {label} {unit && <span className=\"text-xs\">({unit})</span>}\n        </Label>\n        <Input\n          type=\"number\"\n          value={Number.isFinite(value) ? value : 0}\n          onChange={(e) => onChange(parseFloat(e.target.value) || 0)}\n          min={min}\n          step={step}\n          disabled={disabled}\n          className=\"h-9 w-28 arc-no-spinner\"\n        />\n      </div>\n      <Slider\n        value={[sliderValue]}\n        min={min}\n        max={effectiveMax}\n        step={step}\n        onValueChange={(v) => onChange(v[0] ?? 0)}\n        disabled={disabled}\n      />\n      <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n        <span>\n          {min}{unit ? ` ${unit}` : \"\"}\n        </span>\n        <span>\n          {effectiveMax}{unit ? ` ${unit}` : \"\"}\n        </span>\n      </div>\n    </div>\n  );\n}\ntype ArcIssueField =\n  | \"d\"\n  | \"D\"\n  | \"n\"\n  | \"r\"\n  | \"alpha0\"\n  | \"alphaC\"\n  | \"countParallel\"\n  | \"maxHousingDiameter\"\n  | \"minClearance\"\n  | \"hysteresisMode\"\n  | \"Tf_const\"\n  | \"cf\"\n  | \"systemMode\"\n  | \"engageAngle2\";\n\nexport function ArcSpringCalculator() {\n  const [input, setInput] = useState<ArcSpringInput>(getDefaultArcSpringInput());\n  const [mounted, setMounted] = useState(false);\n  const [calculated, setCalculated] = useState(true); // 默认显示示例数据的计算结果\n  const [isCalculating, setIsCalculating] = useState(false);\n  const [result, setResult] = useState<ArcSpringResult>(() => computeArcSpringCurve(getDefaultArcSpringInput()));\n  const [autoCalculate, setAutoCalculate] = useState(true);\n  const [highlightField, setHighlightField] = useState<ArcIssueField | null>(null);\n  const [highlightSeq, setHighlightSeq] = useState(0);\n  const [showDeadCoils, setShowDeadCoils] = useState(false);\n  const [deadCoilsPerEnd, setDeadCoilsPerEnd] = useState(1);\n  const [deadTightnessK, setDeadTightnessK] = useState(2);\n  const [deadTightnessSigma, setDeadTightnessSigma] = useState(0.08);\n  const [allowableTau, setAllowableTau] = useState(800);\n  const [allowableTauFatigue, setAllowableTauFatigue] = useState(500);\n  const [showStressColors, setShowStressColors] = useState(false);\n  const [stressBeta, setStressBeta] = useState(0.25);\n\n  const designRuleReport = useMemo(\n    () =>\n      buildArcSpringDesignRuleReport(input, {\n        showDeadCoils,\n        deadCoilsPerEnd,\n      }),\n    [input, showDeadCoils, deadCoilsPerEnd]\n  );\n\n  const hasRuleError = designRuleReport.summary.status === \"FAIL\";\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const fieldRefs = React.useRef<Partial<Record<ArcIssueField, HTMLDivElement | null>>>({});\n  const setFieldRef = (field: ArcIssueField) => (el: HTMLDivElement | null) => {\n    fieldRefs.current[field] = el;\n  };\n\n  const jumpToField = (field: ArcIssueField) => {\n    const el = fieldRefs.current[field];\n    if (!el) return;\n\n    el.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n\n    const focusable = el.querySelector<HTMLElement>(\"input, select, textarea, button\");\n    focusable?.focus();\n\n    setHighlightField(field);\n    setHighlightSeq((x) => x + 1);\n  };\n\n  const updateInput = <K extends keyof ArcSpringInput>(key: K, value: ArcSpringInput[K]) => {\n    setInput((prev) => ({ ...prev, [key]: value }));\n    setCalculated(false); // 参数变化后，标记为未计算\n  };\n\n  const updateSpring2 = <K extends keyof ArcSpringInput>(key: K, value: ArcSpringInput[K]) => {\n    setInput((prev) => ({\n      ...prev,\n      spring2: { ...prev.spring2, [key]: value },\n    }));\n    setCalculated(false);\n  };\n\n  const handleCalculate = () => {\n    setIsCalculating(true);\n    // 模拟短暂延迟，让用户看到计算状态\n    setTimeout(() => {\n      const newResult = computeArcSpringCurve(input);\n      setResult(newResult);\n      setCalculated(true);\n      setIsCalculating(false);\n    }, 100);\n  };\n\n  const fastCheck = useMemo(() => {\n    const tauMax = result?.tauMax;\n    const sf = isFinite(tauMax) && tauMax > 0 ? allowableTau / tauMax : NaN;\n    const sfFatigue = isFinite(tauMax) && tauMax > 0 ? allowableTauFatigue / tauMax : NaN;\n    const status: \"green\" | \"yellow\" | \"red\" =\n      isFinite(sf) && sf >= 1.5 ? \"green\" : isFinite(sf) && sf >= 1.0 ? \"yellow\" : \"red\";\n    return { tauMax, sf, sfFatigue, status };\n  }, [result, allowableTau, allowableTauFatigue]);\n\n  useEffect(() => {\n    if (!autoCalculate) return;\n    if (hasRuleError) return;\n    setIsCalculating(true);\n    const t = setTimeout(() => {\n      const newResult = computeArcSpringCurve(input);\n      setResult(newResult);\n      setCalculated(true);\n      setIsCalculating(false);\n    }, 300);\n    return () => clearTimeout(t);\n  }, [autoCalculate, input, hasRuleError]);\n\n  const chartData = useMemo(() => {\n    if (!calculated) return [];\n    return result.curve.map((p) => ({\n      deltaDeg: p.deltaDeg.toFixed(1),\n      M_load: p.M_load,\n      M_unload: p.M_unload,\n      alphaDeg: p.alphaDeg.toFixed(1),\n      F: p.F.toFixed(1),\n      x: p.x.toFixed(2),\n    }));\n  }, [result.curve, calculated]);\n\n  const isDual = input.systemMode === \"dual_parallel\" || input.systemMode === \"dual_staged\";\n\n  return (\n    <div className=\"space-y-6\">\n      <style jsx>{`\n        :global(.arc-no-spinner::-webkit-outer-spin-button),\n        :global(.arc-no-spinner::-webkit-inner-spin-button) {\n          -webkit-appearance: none;\n          margin: 0;\n        }\n        :global(.arc-no-spinner) {\n          appearance: textfield;\n          -moz-appearance: textfield;\n        }\n\n        @keyframes arcFieldFlash {\n          0% {\n            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.0);\n            background: transparent;\n          }\n          20% {\n            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.45);\n            background: rgba(59, 130, 246, 0.06);\n          }\n          100% {\n            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.0);\n            background: transparent;\n          }\n        }\n\n        :global(.arc-field-highlight) {\n          border-radius: 10px;\n          animation: arcFieldFlash 1600ms ease-out;\n        }\n      `}</style>\n\n      <DesignRulePanel\n        report={designRuleReport}\n        title=\"Design Rules / 设计规则\"\n        subheader={\n          <div className=\"flex items-center justify-between gap-3\">\n            <div className=\"text-xs text-muted-foreground\">\n              {autoCalculate ? \"Auto-calculate enabled (300ms debounce)\" : \"Manual calculate mode\"}\n            </div>\n            <label className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n              <input\n                type=\"checkbox\"\n                checked={autoCalculate}\n                onChange={(e) => setAutoCalculate(e.target.checked)}\n              />\n              Auto / 自动\n            </label>\n          </div>\n        }\n        onFindingClick={(f) => {\n          const field = (f.evidence as { field?: unknown } | undefined)?.field;\n          if (typeof field === \"string\") jumpToField(field as ArcIssueField);\n        }}\n      />\n\n      {/* Warnings */}\n      {result.warnings.length > 0 && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription>\n            {result.warnings.map((w, i) => (\n              <div key={i}>{w}</div>\n            ))}\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Left Column: Input Cards */}\n        <div className=\"space-y-4\">\n          {/* Geometry Card */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Circle className=\"w-4 h-4\" />\n                Geometry / 几何参数\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"grid grid-cols-3 gap-4\">\n              <div\n                ref={setFieldRef(\"d\")}\n                className={highlightField === \"d\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n              >\n                <SliderNumberInput\n                  label=\"Wire Diameter d\"\n                  value={input.d}\n                  onChange={(v) => updateInput(\"d\", v)}\n                  unit=\"mm\"\n                  min={0.5}\n                  max={10}\n                  step={0.1}\n                />\n              </div>\n              <div\n                ref={setFieldRef(\"D\")}\n                className={highlightField === \"D\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n              >\n                <SliderNumberInput\n                  label=\"Mean Coil Diameter D\"\n                  value={input.D}\n                  onChange={(v) => updateInput(\"D\", v)}\n                  unit=\"mm\"\n                  min={5}\n                  max={120}\n                  step={1}\n                />\n              </div>\n              <div\n                ref={setFieldRef(\"n\")}\n                className={highlightField === \"n\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n              >\n                <SliderNumberInput\n                  label=\"Active Coils n\"\n                  value={input.n}\n                  onChange={(v) => updateInput(\"n\", v)}\n                  min={1}\n                  max={30}\n                  step={0.5}\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Arc Layout Card */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Settings2 className=\"w-4 h-4\" />\n                Arc Layout / 弧形布局\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-4 gap-4\">\n                <div\n                  ref={setFieldRef(\"r\")}\n                  className={highlightField === \"r\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n                >\n                  <SliderNumberInput\n                    label=\"Working Radius r\"\n                    value={input.r}\n                    onChange={(v) => updateInput(\"r\", v)}\n                    unit=\"mm\"\n                    min={10}\n                    max={200}\n                    step={1}\n                  />\n                </div>\n                <div\n                  ref={setFieldRef(\"alpha0\")}\n                  className={highlightField === \"alpha0\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n                >\n                  <SliderNumberInput\n                    label=\"Free Angle α₀\"\n                    value={input.alpha0}\n                    onChange={(v) => updateInput(\"alpha0\", v)}\n                    unit=\"deg\"\n                    min={10}\n                    max={180}\n                    step={1}\n                  />\n                </div>\n                <div\n                  ref={setFieldRef(\"alphaC\")}\n                  className={highlightField === \"alphaC\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n                >\n                  <SliderNumberInput\n                    label=\"Coil Bind Angle αc\"\n                    value={input.alphaC}\n                    onChange={(v) => updateInput(\"alphaC\", v)}\n                    unit=\"deg\"\n                    min={0}\n                    max={Math.max(0, (input.alpha0 ?? 0) - 1)}\n                    step={1}\n                  />\n                </div>\n                <div\n                  ref={setFieldRef(\"countParallel\")}\n                  className={highlightField === \"countParallel\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n                >\n                  <SliderNumberInput\n                    label=\"Parallel Count\"\n                    value={input.countParallel ?? 1}\n                    onChange={(v) => updateInput(\"countParallel\", Math.max(1, Math.round(v)))}\n                    min={1}\n                    max={12}\n                    step={1}\n                  />\n                </div>\n              </div>\n              \n              {/* Space Constraints */}\n              <div className=\"pt-2 border-t\">\n                <Label className=\"text-xs text-muted-foreground mb-2 block\">Space Constraints / 空间约束 (可选)</Label>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div\n                    ref={setFieldRef(\"maxHousingDiameter\")}\n                    className={highlightField === \"maxHousingDiameter\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n                  >\n                    <SliderNumberInput\n                      label=\"Max Housing Diameter\"\n                      value={input.maxHousingDiameter ?? 0}\n                      onChange={(v) => updateInput(\"maxHousingDiameter\", v > 0 ? v : undefined)}\n                      unit=\"mm\"\n                      min={0}\n                      max={200}\n                      step={1}\n                    />\n                  </div>\n                  <div\n                    ref={setFieldRef(\"minClearance\")}\n                    className={highlightField === \"minClearance\" ? `arc-field-highlight arc-field-highlight-${highlightSeq}` : \"\"}\n                  >\n                    <SliderNumberInput\n                      label=\"Min Clearance\"\n                      value={input.minClearance ?? 1}\n                      onChange={(v) => updateInput(\"minClearance\", v)}\n                      unit=\"mm\"\n                      min={0}\n                      max={10}\n                      step={0.5}\n                    />\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Material Card */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Layers className=\"w-4 h-4\" />\n                Material / 材料\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-1\">\n                <Label className=\"text-sm text-muted-foreground\">Material Standard</Label>\n                <Select\n                  value={input.materialKey}\n                  onValueChange={(v) => updateInput(\"materialKey\", v as MaterialKey)}\n                >\n                  <SelectTrigger className=\"h-9\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {ARC_SPRING_MATERIALS.map((m) => (\n                      <SelectItem key={m.key} value={m.key}>\n                        {m.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              {input.materialKey === \"CUSTOM\" && (\n                <div>\n                  <SliderNumberInput\n                    label=\"Shear Modulus G\"\n                    value={input.G_override ?? 80000}\n                    onChange={(v) => updateInput(\"G_override\", v)}\n                    unit=\"N/mm²\"\n                    min={60000}\n                    max={90000}\n                    step={500}\n                  />\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Hysteresis & System Card */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Activity className=\"w-4 h-4\" />\n                Hysteresis & System / 迟滞与系统\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-1\">\n                  <Label className=\"text-sm text-muted-foreground\">Hysteresis Mode</Label>\n                  <Select\n                    value={input.hysteresisMode ?? \"none\"}\n                    onValueChange={(v) => updateInput(\"hysteresisMode\", v as HysteresisMode)}\n                  >\n                    <SelectTrigger className=\"h-9\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"none\">None (无迟滞)</SelectItem>\n                      <SelectItem value=\"constant\">Constant Tf (恒定摩擦)</SelectItem>\n                      <SelectItem value=\"proportional\">Proportional (比例摩擦)</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {input.hysteresisMode === \"constant\" && (\n                  <SliderNumberInput\n                    label=\"Friction Torque Tf\"\n                    value={input.Tf_const ?? 0}\n                    onChange={(v) => updateInput(\"Tf_const\", v)}\n                    unit=\"N·mm\"\n                    min={0}\n                    max={20000}\n                    step={100}\n                  />\n                )}\n\n                {input.hysteresisMode === \"proportional\" && (\n                  <SliderNumberInput\n                    label=\"Friction Coefficient cf\"\n                    value={input.cf ?? 0}\n                    onChange={(v) => updateInput(\"cf\", v)}\n                    min={0}\n                    max={1}\n                    step={0.01}\n                  />\n                )}\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-1\">\n                  <Label className=\"text-sm text-muted-foreground\">System Mode</Label>\n                  <Select\n                    value={input.systemMode ?? \"single\"}\n                    onValueChange={(v) => updateInput(\"systemMode\", v as SystemMode)}\n                  >\n                    <SelectTrigger className=\"h-9\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"single\">Single (单级)</SelectItem>\n                      <SelectItem value=\"dual_parallel\">Dual Parallel (双级并联)</SelectItem>\n                      <SelectItem value=\"dual_staged\">Dual Staged (双级分段)</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {input.systemMode === \"dual_staged\" && (\n                  <SliderNumberInput\n                    label=\"Engage Angle\"\n                    value={input.engageAngle2 ?? 0}\n                    onChange={(v) => updateInput(\"engageAngle2\", v)}\n                    unit=\"deg\"\n                    min={0}\n                    max={Math.max(0, (input.alpha0 ?? 0) - (input.alphaC ?? 0) - 1)}\n                    step={1}\n                  />\n                )}\n              </div>\n\n              {/* Spring 2 Parameters */}\n              {isDual && (\n                <div className=\"pt-4 border-t\">\n                  <Label className=\"text-sm font-medium mb-3 block\">Spring 2 Parameters / 第二弹簧参数</Label>\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <SliderNumberInput\n                      label=\"d₂\"\n                      value={input.spring2?.d ?? input.d}\n                      onChange={(v) => updateSpring2(\"d\", v)}\n                      unit=\"mm\"\n                      min={0.5}\n                      max={10}\n                      step={0.1}\n                    />\n                    <SliderNumberInput\n                      label=\"D₂\"\n                      value={input.spring2?.D ?? input.D}\n                      onChange={(v) => updateSpring2(\"D\", v)}\n                      unit=\"mm\"\n                      min={5}\n                      max={120}\n                      step={1}\n                    />\n                    <SliderNumberInput\n                      label=\"n₂\"\n                      value={input.spring2?.n ?? input.n}\n                      onChange={(v) => updateSpring2(\"n\", v)}\n                      min={1}\n                      max={30}\n                      step={0.5}\n                    />\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Calculate Button */}\n          <Button\n            className=\"w-full h-12 text-base\"\n            onClick={handleCalculate}\n            disabled={isCalculating || hasRuleError}\n          >\n            {isCalculating ? (\n              <>\n                <span className=\"mr-2 animate-spin\">⏳</span>\n                Calculating... / 计算中...\n              </>\n            ) : calculated ? (\n              <>\n                <span className=\"mr-2\">✓</span>\n                Calculated / 已计算\n              </>\n            ) : (\n              \"Calculate / 计算\"\n            )}\n          </Button>\n        </div>\n\n        {/* Right Column: Results */}\n        <div className=\"space-y-4\">\n          {/* 3D Preview */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">3D Preview / 三维预览</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex items-center justify-between gap-3 pb-3\">\n                <label className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                  <input\n                    type=\"checkbox\"\n                    checked={showDeadCoils}\n                    onChange={(e) => setShowDeadCoils(e.target.checked)}\n                  />\n                  Dead Coils / 两端接触圈\n                </label>\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"text-xs text-muted-foreground\">per end</div>\n                  <Input\n                    type=\"number\"\n                    value={deadCoilsPerEnd}\n                    onChange={(e) => setDeadCoilsPerEnd(Math.max(0, Math.round(parseFloat(e.target.value) || 0)))}\n                    min={0}\n                    step={1}\n                    disabled={!showDeadCoils}\n                    className=\"h-8 w-20 arc-no-spinner\"\n                  />\n                </div>\n              </div>\n              <div className=\"flex items-center justify-end gap-2 pb-3\">\n                <div className=\"text-xs text-muted-foreground\">k</div>\n                <Input\n                  type=\"number\"\n                  value={deadTightnessK}\n                  onChange={(e) => setDeadTightnessK(Math.max(0, parseFloat(e.target.value) || 0))}\n                  min={0}\n                  step={0.5}\n                  disabled={!showDeadCoils}\n                  className=\"h-8 w-20 arc-no-spinner\"\n                />\n                <div className=\"text-xs text-muted-foreground\">σ</div>\n                <Input\n                  type=\"number\"\n                  value={deadTightnessSigma}\n                  onChange={(e) => setDeadTightnessSigma(Math.max(0, parseFloat(e.target.value) || 0))}\n                  min={0}\n                  step={0.01}\n                  disabled={!showDeadCoils}\n                  className=\"h-8 w-20 arc-no-spinner\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between gap-3 pb-3\">\n                <label className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                  <input\n                    type=\"checkbox\"\n                    checked={showStressColors}\n                    onChange={(e) => setShowStressColors(e.target.checked)}\n                  />\n                  Stress Colors / 应力伪色\n                </label>\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"text-xs text-muted-foreground\">β</div>\n                  <Input\n                    type=\"number\"\n                    value={stressBeta}\n                    onChange={(e) => setStressBeta(Math.max(0, Math.min(0.9, parseFloat(e.target.value) || 0)))}\n                    min={0}\n                    max={0.9}\n                    step={0.05}\n                    disabled={!showStressColors}\n                    className=\"h-8 w-20 arc-no-spinner\"\n                  />\n                </div>\n              </div>\n              <div className=\"h-[360px] rounded-lg overflow-hidden bg-slate-50\">\n                <ArcSpringVisualizer\n                  d={input.d}\n                  D={input.D}\n                  n={input.n}\n                  r={input.r}\n                  alpha0Deg={input.alpha0}\n                  useDeadCoils={showDeadCoils}\n                  deadCoilsPerEnd={deadCoilsPerEnd}\n                  deadTightnessK={deadTightnessK}\n                  deadTightnessSigma={deadTightnessSigma}\n                  colorMode={showStressColors ? \"approx_stress\" : \"solid\"}\n                  approxTauMax={isFinite(result.tauMax) ? result.tauMax : undefined}\n                  approxStressBeta={stressBeta}\n                  autoRotate={false}\n                  wireframe={false}\n                  showCenterline={false}\n                />\n              </div>\n              <div className=\"mt-2 text-xs text-muted-foreground\">\n                d={input.d.toFixed(2)}mm, D={input.D.toFixed(1)}mm, n={input.n.toFixed(2)}, r={input.r.toFixed(1)}mm, α₀={input.alpha0.toFixed(1)}°\n                {showDeadCoils ? `, dead=${deadCoilsPerEnd}×2, k=${deadTightnessK.toFixed(2)}, σ=${deadTightnessSigma.toFixed(2)}` : \"\"}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3 flex flex-row items-center justify-between\">\n              <CardTitle className=\"text-base\">Fast Engineering Check / 快速工程判定</CardTitle>\n              {fastCheck.status === \"green\" && (\n                <Badge className=\"bg-emerald-600 text-white\">Green</Badge>\n              )}\n              {fastCheck.status === \"yellow\" && (\n                <Badge className=\"bg-amber-500 text-white\">Yellow</Badge>\n              )}\n              {fastCheck.status === \"red\" && (\n                <Badge variant=\"destructive\">Red</Badge>\n              )}\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div className=\"text-xs text-muted-foreground\">\n                Engineering approximation (spring theory + correction factors). For fast trend guidance, not full 3D FEA.\n              </div>\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div className=\"space-y-1\">\n                  <div className=\"text-xs text-muted-foreground\">Allowable τ (yield)</div>\n                  <Input\n                    type=\"number\"\n                    value={allowableTau}\n                    onChange={(e) => setAllowableTau(Math.max(0, parseFloat(e.target.value) || 0))}\n                    step={50}\n                    className=\"h-8 arc-no-spinner\"\n                  />\n                </div>\n                <div className=\"space-y-1\">\n                  <div className=\"text-xs text-muted-foreground\">Allowable τ (fatigue)</div>\n                  <Input\n                    type=\"number\"\n                    value={allowableTauFatigue}\n                    onChange={(e) => setAllowableTauFatigue(Math.max(0, parseFloat(e.target.value) || 0))}\n                    step={50}\n                    className=\"h-8 arc-no-spinner\"\n                  />\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-3 text-xs\">\n                <div className=\"p-2 bg-muted rounded\">\n                  <div className=\"text-muted-foreground\">τ_max (MPa)</div>\n                  <div className=\"font-medium\">{isFinite(result.tauMax) ? result.tauMax.toFixed(0) : \"—\"}</div>\n                </div>\n                <div className=\"p-2 bg-muted rounded\">\n                  <div className=\"text-muted-foreground\">SF (yield)</div>\n                  <div className=\"font-medium\">{isFinite(fastCheck.sf) ? fastCheck.sf.toFixed(2) : \"—\"}</div>\n                </div>\n                <div className=\"p-2 bg-muted rounded\">\n                  <div className=\"text-muted-foreground\">SF (fatigue)</div>\n                  <div className=\"font-medium\">{isFinite(fastCheck.sfFatigue) ? fastCheck.sfFatigue.toFixed(2) : \"—\"}</div>\n                </div>\n                <div className=\"p-2 bg-muted rounded\">\n                  <div className=\"text-muted-foreground\">k (N/mm)</div>\n                  <div className=\"font-medium\">{isFinite(result.k) ? result.k.toFixed(2) : \"—\"}</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Summary Card */}\n          <Card>\n            <CardHeader className=\"pb-3 flex flex-row items-center justify-between\">\n              <CardTitle className=\"text-base\">Results / 计算结果</CardTitle>\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => printArcSpringReport(input, result)}\n                  disabled={!calculated || (result.warnings.length > 0 && !isFinite(result.k))}\n                >\n                  <Printer className=\"w-4 h-4 mr-1\" />\n                  Print Report\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => downloadArcSpringPDF(input, result)}\n                  disabled={!calculated || (result.warnings.length > 0 && !isFinite(result.k))}\n                >\n                  <FileText className=\"w-4 h-4 mr-1\" />\n                  Export PDF\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  asChild\n                  disabled={!calculated || (result.warnings.length > 0 && !isFinite(result.k))}\n                  className=\"border-violet-500/50 text-violet-600 bg-violet-500/10 hover:bg-violet-500/20\"\n                >\n                  <a href={`/tools/cad-export?type=arcSpring&d=${input.d}&D=${input.D}&Na=${input.n}&alpha0=${input.alpha0}&r=${input.r}&mat=${input.materialKey}`}>\n                    <Download className=\"w-4 h-4 mr-1\" />\n                    Export CAD\n                  </a>\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {!calculated ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <p className=\"text-sm\">请点击\"Calculate / 计算\"按钮查看结果</p>\n                  <p className=\"text-xs mt-1\">Click the Calculate button to see results</p>\n                </div>\n              ) : (\n              <>\n              {/* Primary Results - Rotational Stiffness (核心参数) */}\n              <div className=\"p-3 bg-indigo-50 dark:bg-indigo-950 rounded-lg border border-indigo-200\">\n                <div className=\"text-xs text-indigo-600 font-medium\">Rotational Stiffness R / 旋转刚度 (核心参数)</div>\n                <div className=\"text-2xl font-bold text-indigo-700\">\n                  {isFinite(result.R_deg) ? result.R_deg.toFixed(2) : \"—\"} <span className=\"text-sm font-normal\">N·mm/deg</span>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div className=\"p-2 bg-muted rounded-lg\">\n                  <div className=\"text-xs text-muted-foreground\">Spring Rate k (切向)</div>\n                  <div className=\"text-sm font-semibold\">\n                    {isFinite(result.k) ? result.k.toFixed(2) : \"—\"} N/mm\n                  </div>\n                </div>\n                <div className=\"p-2 bg-muted rounded-lg\">\n                  <div className=\"text-xs text-muted-foreground\">Max Angle Δα</div>\n                  <div className=\"text-sm font-semibold\">\n                    {isFinite(result.deltaAlphaMax) ? result.deltaAlphaMax.toFixed(1) : \"—\"}°\n                  </div>\n                </div>\n                <div className=\"p-2 bg-blue-50 dark:bg-blue-950 rounded-lg\">\n                  <div className=\"text-xs text-muted-foreground\">Max Torque (Load)</div>\n                  <div className=\"text-sm font-semibold text-blue-600\">\n                    {isFinite(result.MMax_load) ? result.MMax_load.toFixed(0) : \"—\"} N·mm\n                  </div>\n                </div>\n                <div className=\"p-2 bg-orange-50 dark:bg-orange-950 rounded-lg\">\n                  <div className=\"text-xs text-muted-foreground\">Max Torque (Unload)</div>\n                  <div className=\"text-sm font-semibold text-orange-600\">\n                    {isFinite(result.MMax_unload) ? result.MMax_unload.toFixed(0) : \"—\"} N·mm\n                  </div>\n                </div>\n              </div>\n\n              {/* Geometry & Safety */}\n              <div className=\"pt-2 border-t\">\n                <div className=\"text-xs text-muted-foreground mb-2\">Geometry & Safety / 几何与安全</div>\n                <div className=\"grid grid-cols-3 gap-2 text-xs\">\n                  <div className=\"p-2 bg-slate-50 dark:bg-slate-900 rounded\">\n                    <div className=\"text-muted-foreground\">De (外径)</div>\n                    <div className=\"font-medium\">{isFinite(result.De) ? result.De.toFixed(1) : \"—\"} mm</div>\n                  </div>\n                  <div className=\"p-2 bg-slate-50 dark:bg-slate-900 rounded\">\n                    <div className=\"text-muted-foreground\">Di (内径)</div>\n                    <div className=\"font-medium\">{isFinite(result.Di) ? result.Di.toFixed(1) : \"—\"} mm</div>\n                  </div>\n                  <div className=\"p-2 bg-slate-50 dark:bg-slate-900 rounded\">\n                    <div className=\"text-muted-foreground\">Safety Margin</div>\n                    <div className=\"font-medium\">{isFinite(result.safetyMarginToSolid) ? result.safetyMarginToSolid.toFixed(1) : \"—\"}°</div>\n                  </div>\n                </div>\n                {result.housingClearance !== undefined && (\n                  <div className={`mt-2 p-2 rounded text-xs ${result.housingClearance < (input.minClearance ?? 1) ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}>\n                    Housing Clearance: {result.housingClearance.toFixed(1)} mm\n                    {result.housingClearance < (input.minClearance ?? 1) ? ' ⚠️ Too small!' : ' ✓ OK'}\n                  </div>\n                )}\n              </div>\n\n              {/* Stress Analysis (Wahl Factor) */}\n              <div className=\"pt-2 border-t\">\n                <div className=\"text-xs text-muted-foreground mb-2\">Stress Analysis / 应力分析</div>\n                <div className=\"grid grid-cols-3 gap-2 text-xs\">\n                  <div className=\"p-2 bg-rose-50 dark:bg-rose-950 rounded\">\n                    <div className=\"text-rose-600\">Spring Index C</div>\n                    <div className=\"font-medium text-rose-700\">{isFinite(result.springIndex) ? result.springIndex.toFixed(2) : \"—\"}</div>\n                  </div>\n                  <div className=\"p-2 bg-rose-50 dark:bg-rose-950 rounded\">\n                    <div className=\"text-rose-600\">Wahl Factor K_W</div>\n                    <div className=\"font-medium text-rose-700\">{isFinite(result.wahlFactor) ? result.wahlFactor.toFixed(3) : \"—\"}</div>\n                  </div>\n                  <div className=\"p-2 bg-rose-50 dark:bg-rose-950 rounded\">\n                    <div className=\"text-rose-600\">τ_max (剪切应力)</div>\n                    <div className=\"font-medium text-rose-700\">{isFinite(result.tauMax) ? result.tauMax.toFixed(0) : \"—\"} MPa</div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Hysteresis / Damping */}\n              {input.hysteresisMode !== \"none\" && (\n                <div className=\"pt-2 border-t\">\n                  <div className=\"text-xs text-muted-foreground mb-2\">Damping / 阻尼</div>\n                  <div className=\"grid grid-cols-2 gap-2\">\n                    <div className=\"p-2 bg-purple-50 dark:bg-purple-950 rounded\">\n                      <div className=\"text-xs text-purple-600\">Hysteresis Work (阻尼能量)</div>\n                      <div className=\"text-sm font-semibold text-purple-700\">\n                        {isFinite(result.hysteresisWork) ? result.hysteresisWork.toFixed(0) : \"—\"} N·mm·deg\n                      </div>\n                    </div>\n                    <div className=\"p-2 bg-purple-50 dark:bg-purple-950 rounded\">\n                      <div className=\"text-xs text-purple-600\">Damping Capacity (阻尼效率)</div>\n                      <div className=\"text-sm font-semibold text-purple-700\">\n                        {isFinite(result.dampingCapacity) ? result.dampingCapacity.toFixed(1) : \"—\"} %\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Dual System Info */}\n              {isDual && (\n                <div className=\"pt-2 border-t\">\n                  <div className=\"text-xs text-muted-foreground mb-2\">Dual System / 双级系统</div>\n                  <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                    {result.engageAngleMarker !== undefined && (\n                      <div className=\"p-2 bg-amber-50 dark:bg-amber-950 rounded\">\n                        <div className=\"text-amber-600\">Engage Angle (拐点)</div>\n                        <div className=\"font-medium text-amber-700\">{result.engageAngleMarker.toFixed(1)}°</div>\n                      </div>\n                    )}\n                    {result.spring2Clearance !== undefined && (\n                      <div className={`p-2 rounded ${result.spring2Clearance < (input.minClearance ?? 1) ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}>\n                        <div>Spring Clearance</div>\n                        <div className=\"font-medium\">{result.spring2Clearance.toFixed(1)} mm</div>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n              </>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Chart Card */}\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">Torque–Angle Curve / 扭矩-角度曲线</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"h-[400px]\">\n                {!mounted || !calculated ? (\n                  <div className=\"h-full w-full flex items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n                    {!calculated ? \"Click Calculate to view chart\" : \"Loading chart...\"}\n                  </div>\n                ) : (\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <LineChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>\n                      <CartesianGrid strokeDasharray=\"3 3\" />\n                      <XAxis\n                        dataKey=\"deltaDeg\"\n                        label={{ value: \"Δα (deg)\", position: \"insideBottom\", offset: -5 }}\n                      />\n                      <YAxis\n                        label={{ value: \"M (N·mm)\", angle: -90, position: \"insideLeft\" }}\n                      />\n                      <Tooltip\n                        content={({ active, payload }) => {\n                          if (active && payload && payload.length) {\n                            const data = payload[0].payload;\n                            return (\n                              <div className=\"bg-background border rounded p-2 shadow-sm text-xs\">\n                                <div>Δα: {data.deltaDeg}°</div>\n                                <div className=\"text-blue-600\">M_load: {Number(data.M_load).toFixed(0)} N·mm</div>\n                                <div className=\"text-orange-600\">M_unload: {Number(data.M_unload).toFixed(0)} N·mm</div>\n                                <div>F: {data.F} N</div>\n                                <div>x: {data.x} mm</div>\n                              </div>\n                            );\n                          }\n                          return null;\n                        }}\n                      />\n                      <Line\n                        type=\"monotone\"\n                        dataKey=\"M_load\"\n                        stroke=\"#2563eb\"\n                        strokeWidth={2}\n                        dot={false}\n                        name=\"Load\"\n                      />\n                      <Line\n                        type=\"monotone\"\n                        dataKey=\"M_unload\"\n                        stroke=\"#ea580c\"\n                        strokeWidth={2}\n                        dot={false}\n                        name=\"Unload\"\n                      />\n\n                      {/* Engage marker */}\n                      {result.engageAngleMarker !== undefined && (\n                        <ReferenceLine x={result.engageAngleMarker.toFixed(1)} stroke=\"#f59e0b\" strokeDasharray=\"4 4\" />\n                      )}\n                    </LineChart>\n                  </ResponsiveContainer>\n                )}\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-2 text-center\">\n                {input.hysteresisMode === \"none\"\n                  ? \"No hysteresis - Loading and Unloading curves overlap\"\n                  : \"Hysteresis loop shows friction effect between loading and unloading\"}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Advanced Analysis Panel */}\n      {calculated && isFinite(result.k) && (\n        <ArcSpringAdvancedPanel\n          isZh={false}\n          input={input}\n          result={result}\n          allowableTau={allowableTau}\n        />\n      )}\n    </div>\n  );\n}\n\nexport default ArcSpringCalculator;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/Calculator3DPreview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/CompressionCalculator.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringMaterialId' is defined but never used.","line":21,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used.","line":31,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Tabs' is defined but never used.","line":39,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":39,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsContent' is defined but never used.","line":39,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":39,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsList' is defined but never used.","line":39,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":39,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsTrigger' is defined but never used.","line":39,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":39,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'simulatorUrl' is assigned a value but never used.","line":155,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":155,"endColumn":21},{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/CompressionCalculator.tsx:173:25\n  171 |\n  172 |   // Watch form values for URL generation\n> 173 |   const watchedValues = form.watch();\n      |                         ^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  174 |\n  175 |   const analysisUrl = useMemo(() => {\n  176 |     const params = new URLSearchParams({","line":173,"column":25,"nodeType":null,"endLine":173,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Link from \"next/link\";\nimport { useMemo, useState } from \"react\";\nimport { type SubmitHandler, type Resolver, useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\n\nimport { \n  calculateLoadAndStress, \n  performStressAnalysis,\n  calculatePreload,\n  type StressAnalysisResult,\n  type PreloadResult,\n} from \"@/lib/springMath\";\nimport { \n  getDefaultSpringMaterial,\n  getSpringMaterial,\n  getSizeFactor,\n  type SpringMaterial,\n  type SpringMaterialId,\n} from \"@/lib/materials/springMaterials\";\nimport { SpringDesign } from \"@/lib/springTypes\";\nimport { resolveCompressionNominal } from \"@/lib/eds/compressionResolver\";\nimport { toEdsFromLegacyForm } from \"@/lib/eds/legacyAdapters\";\nimport { buildCompressionDesignRuleReport } from \"@/lib/designRules\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { DesignRulePanel } from \"@/components/design-rules/DesignRulePanel\";\nimport { buildCompressionPpapReport } from \"@/lib/reports/compressionPpapReport\";\nimport { DimensionHint } from \"./DimensionHint\";\nimport { MaterialSelector } from \"./MaterialSelector\";\nimport { StressAnalysisCard } from \"./StressAnalysisCard\";\nimport { Calculator3DPreview } from \"./Calculator3DPreview\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  useSpringDesignStore,\n  type CompressionGeometry,\n  type MaterialInfo,\n  type AnalysisResult,\n  generateDesignCode,\n} from \"@/lib/stores/springDesignStore\";\n\nconst formSchema = z\n  .object({\n    wireDiameter: z.coerce.number().positive(\"Wire diameter must be > 0\"),\n    meanDiameter: z.coerce.number().positive(\"Mean diameter must be > 0\"),\n    activeCoils: z.coerce.number().positive(\"Active coils must be > 0\"),\n    totalCoils: z.coerce.number().positive(\"Total coils must be > 0\"),\n    shearModulus: z.coerce.number().positive(\"Shear modulus must be > 0\"),\n    freeLength: z.coerce.number().positive(\"Free length must be > 0\").optional(),\n    deflection: z.coerce.number().nonnegative(\"Deflection must be ≥ 0\"),\n    preloadDeflection: z.coerce.number().nonnegative(\"Preload must be ≥ 0\").optional(),\n    stressRatio: z.coerce.number().min(0).max(1).optional(),\n    topGround: z.boolean().optional().default(false),\n    bottomGround: z.boolean().optional().default(false),\n  })\n  .refine((data) => data.totalCoils >= data.activeCoils, {\n    path: [\"totalCoils\"],\n    message: \"Total coils must be ≥ active coils\",\n  });\n\ntype FormValues = z.infer<typeof formSchema>;\ntype CalculationResult = ReturnType<typeof calculateLoadAndStress> | null;\n\nexport function CompressionCalculator() {\n  const [error, setError] = useState<string | null>(null);\n  const [stressAnalysis, setStressAnalysis] = useState<StressAnalysisResult | null>(null);\n  const [preloadResult, setPreloadResult] = useState<PreloadResult | null>(null);\n  \n  // 全局设计存储\n  const storedGeometry = useSpringDesignStore((state) => state.geometry);\n  const storedMaterial = useSpringDesignStore((state) => state.material);\n  const storedAnalysis = useSpringDesignStore((state) => state.analysisResult);\n  const storedEds = useSpringDesignStore((state) => state.eds);\n  const storedResolved = useSpringDesignStore((state) => state.resolved);\n  const setDesign = useSpringDesignStore((state) => state.setDesign);\n  const updateCompressionPpap = useSpringDesignStore((state) => state.updateCompressionPpap);\n  const updateCompressionProcessRoute = useSpringDesignStore((state) => state.updateCompressionProcessRoute);\n\n  const lastCompressionGeometry = storedGeometry?.type === \"compression\" ? storedGeometry : null;\n  const lastCompressionAnalysis = lastCompressionGeometry ? storedAnalysis : null;\n\n  const designRuleReport = useMemo(() => {\n    const eds = storedEds?.type === \"compression\" ? storedEds : null;\n    const resolved = storedResolved?.type === \"compression\" ? storedResolved : null;\n    return buildCompressionDesignRuleReport({\n      eds,\n      resolved,\n      analysisResult: lastCompressionAnalysis,\n    });\n  }, [storedEds, storedResolved, lastCompressionAnalysis]);\n  \n  // 从 store 恢复上次的计算结果\n  const initialResult = useMemo<CalculationResult>(() => {\n    if (lastCompressionGeometry && lastCompressionAnalysis) {\n      return {\n        k: lastCompressionAnalysis.springRate,\n        load: lastCompressionAnalysis.workingLoad ?? 0,\n        shearStress: lastCompressionAnalysis.shearStress ?? 0,\n        springIndex: lastCompressionAnalysis.springIndex ?? \n          lastCompressionGeometry.meanDiameter / lastCompressionGeometry.wireDiameter,\n        wahlFactor: lastCompressionAnalysis.wahlFactor ?? 1.2,\n      };\n    }\n    return null;\n  }, [lastCompressionGeometry, lastCompressionAnalysis]);\n  \n  const [result, setResult] = useState<CalculationResult>(initialResult);\n  const initialMaterial = useMemo(() => {\n    if (storedMaterial?.id) {\n      return getSpringMaterial(storedMaterial.id) ?? getDefaultSpringMaterial();\n    }\n    return getDefaultSpringMaterial();\n  }, [storedMaterial?.id]);\n  const [selectedMaterial, setSelectedMaterial] = useState<SpringMaterial>(initialMaterial);\n\n  const defaultDeflection = lastCompressionAnalysis?.workingDeflection ?? 10;\n  const defaultPreload =\n    lastCompressionAnalysis?.maxDeflection !== undefined && lastCompressionAnalysis?.workingDeflection !== undefined\n      ? Math.max(lastCompressionAnalysis.maxDeflection - lastCompressionAnalysis.workingDeflection, 0)\n      : 0;\n\n  const form = useForm<FormValues>({\n    resolver: zodResolver(formSchema) as Resolver<FormValues>,\n    defaultValues: {\n      wireDiameter: lastCompressionGeometry?.wireDiameter ?? 3.2,\n      meanDiameter: lastCompressionGeometry?.meanDiameter ?? 24,\n      activeCoils: lastCompressionGeometry?.activeCoils ?? 8,\n      totalCoils: lastCompressionGeometry?.totalCoils ?? 10,\n      shearModulus: lastCompressionGeometry?.shearModulus ?? initialMaterial.shearModulus,\n      freeLength: lastCompressionGeometry?.freeLength ?? 50,\n      deflection: defaultDeflection,\n      preloadDeflection: defaultPreload,\n      stressRatio: 0.3,\n      topGround: lastCompressionGeometry?.topGround ?? true,\n      bottomGround: lastCompressionGeometry?.bottomGround ?? true,\n    },\n  });\n\n  // Handle material change\n  const handleMaterialChange = (material: SpringMaterial) => {\n    setSelectedMaterial(material);\n    form.setValue(\"shearModulus\", material.shearModulus);\n\n    if (result) {\n      form.handleSubmit(onSubmit)();\n    }\n  };\n\n  const simulatorUrl = useMemo(() => {\n    if (!result) return \"\";\n    const values = form.getValues();\n    const params = new URLSearchParams({\n      type: \"compression\",\n      d: values.wireDiameter.toString(),\n      Dm: values.meanDiameter.toString(),\n      Na: values.activeCoils.toString(),\n      Nt: values.totalCoils.toString(),\n      G: values.shearModulus.toString(),\n      dx: values.deflection.toString(),\n      topGround: String(values.topGround ?? false),\n      bottomGround: String(values.bottomGround ?? false),\n    });\n    return `/tools/simulator?${params.toString()}`;\n  }, [result, form]);\n\n  // Watch form values for URL generation\n  const watchedValues = form.watch();\n\n  const analysisUrl = useMemo(() => {\n    const params = new URLSearchParams({\n      type: \"compression\",\n      d: watchedValues.wireDiameter?.toString() ?? \"3.2\",\n      Dm: watchedValues.meanDiameter?.toString() ?? \"24\",\n      Na: watchedValues.activeCoils?.toString() ?? \"8\",\n      L0: watchedValues.freeLength?.toString() ?? \"50\",\n      dxMin: \"0\",\n      dxMax: watchedValues.deflection?.toString() ?? \"10\",\n      material: selectedMaterial.id,\n    });\n    return `/tools/analysis?${params.toString()}`;\n  }, [watchedValues, selectedMaterial]);\n\n  const cadExportUrl = useMemo(() => {\n    const params = new URLSearchParams({\n      type: \"compression\",\n      d: watchedValues.wireDiameter?.toString() ?? \"3.2\",\n      Dm: watchedValues.meanDiameter?.toString() ?? \"24\",\n      Na: watchedValues.activeCoils?.toString() ?? \"8\",\n      Nt: watchedValues.totalCoils?.toString() ?? \"10\",\n      L0: watchedValues.freeLength?.toString() ?? \"50\",\n      material: selectedMaterial.id,\n      k: result?.k?.toString() ?? \"\",\n      dx: watchedValues.deflection?.toString() ?? \"10\",\n    });\n    return `/tools/cad-export?${params.toString()}`;\n  }, [watchedValues, selectedMaterial, result]);\n\n  const onSubmit: SubmitHandler<FormValues> = (values) => {\n    setError(null);\n    try {\n      const eds0 = toEdsFromLegacyForm({\n        wireDiameter: values.wireDiameter,\n        meanDiameter: values.meanDiameter,\n        activeCoils: values.activeCoils,\n        totalCoils: values.totalCoils,\n        shearModulus: values.shearModulus,\n        freeLength: values.freeLength,\n        topGround: values.topGround,\n        bottomGround: values.bottomGround,\n        materialId: selectedMaterial.id,\n      });\n\n      const eds =\n        storedEds && storedEds.type === \"compression\"\n          ? {\n              ...eds0,\n              quality: storedEds.quality,\n              process: storedEds.process,\n            }\n          : eds0;\n\n      const resolved = resolveCompressionNominal(eds);\n      const design: SpringDesign = resolved.design;\n\n      const calc = calculateLoadAndStress(design, values.deflection);\n      setResult(calc);\n\n      // Perform stress analysis\n      const sizeFactor = getSizeFactor(values.wireDiameter);\n      const analysis = performStressAnalysis({\n        materialId: selectedMaterial.id,\n        tauNominal: calc.shearStress / calc.wahlFactor, // Remove Wahl to get nominal\n        wahlFactor: calc.wahlFactor,\n        surfaceFactor: selectedMaterial.surfaceFactor,\n        sizeFactor,\n        tempFactor: selectedMaterial.tempFactor,\n        stressRatio: values.stressRatio,\n      });\n      setStressAnalysis(analysis);\n\n      // Calculate preload if specified\n      if (values.preloadDeflection && values.preloadDeflection > 0) {\n        const preload = calculatePreload({\n          springRate: calc.k,\n          preloadDeflection: values.preloadDeflection,\n          workingDeflection: values.deflection,\n        });\n        setPreloadResult(preload);\n      } else {\n        setPreloadResult(null);\n      }\n      \n      // 写入全局 store\n      const geometry: CompressionGeometry = {\n        type: \"compression\",\n        wireDiameter: design.wireDiameter,\n        meanDiameter: design.meanDiameter,\n        activeCoils: design.activeCoils,\n        totalCoils: design.totalCoils ?? values.totalCoils,\n        freeLength: design.freeLength ?? (values.freeLength ?? 50),\n        topGround: design.topGround ?? (values.topGround ?? false),\n        bottomGround: design.bottomGround ?? (values.bottomGround ?? false),\n        shearModulus: design.shearModulus,\n        materialId: design.materialId,\n      };\n      \n      const materialInfo: MaterialInfo = {\n        id: selectedMaterial.id,\n        name: selectedMaterial.nameEn,\n        shearModulus: design.shearModulus,\n        elasticModulus: selectedMaterial.elasticModulus ?? 200000,\n        density: selectedMaterial.density ?? 7850,\n        tensileStrength: selectedMaterial.tensileStrength,\n        surfaceFactor: selectedMaterial.surfaceFactor,\n        tempFactor: selectedMaterial.tempFactor,\n      };\n      \n      const analysisResultData: AnalysisResult = {\n        springRate: calc.k,\n        springRateUnit: \"N/mm\",\n        workingLoad: calc.load,\n        shearStress: calc.shearStress,\n        wahlFactor: calc.wahlFactor,\n        springIndex: calc.springIndex,\n        staticSafetyFactor: analysis.safetyFactor.sfStatic,\n        fatigueSafetyFactor: analysis.fatigueLife?.sfInfiniteLife,\n        fatigueLife: analysis.fatigueLife?.estimatedCycles,\n        workingDeflection: values.deflection,\n        maxDeflection: values.deflection,\n      };\n      \n      setDesign({\n        springType: \"compression\",\n        geometry,\n        material: materialInfo,\n        analysisResult: analysisResultData,\n        eds,\n        meta: {\n          designCode: generateDesignCode(geometry),\n        },\n      });\n      \n    } catch (err) {\n      setResult(null);\n      setStressAnalysis(null);\n      setPreloadResult(null);\n      setError(err instanceof Error ? err.message : \"Calculation failed\");\n    }\n  };\n\n  const formatNumber = (value: number) => Number(value.toFixed(2)).toLocaleString();\n\n  const compressionPpap = storedEds?.type === \"compression\" ? storedEds.quality?.ppap : undefined;\n  const compressionRoute = storedEds?.type === \"compression\" ? storedEds.process?.route ?? [] : [];\n  const compressionCtq = compressionPpap?.ctq ?? [];\n\n  const previewPpapHtml = async () => {\n    if (!storedEds || storedEds.type !== \"compression\" || !storedResolved || storedResolved.type !== \"compression\" || !storedAnalysis) {\n      alert(\"Please run Calculate once to generate analysisResult before previewing PPAP. / 请先计算一次（生成 analysisResult）后再预览 PPAP 报告。 \");\n      return;\n    }\n\n    const model = buildCompressionPpapReport(\n      storedEds,\n      { design: storedResolved.design, issues: storedResolved.issues },\n      storedAnalysis\n    );\n\n    const res = await fetch(\"/api/reports/compression-ppap?format=html\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(model),\n    });\n\n    if (!res.ok) {\n      const text = await res.text().catch(() => \"\");\n      throw new Error(text || `HTTP ${res.status}`);\n    }\n\n    const html = await res.text();\n    const w = window.open(\"\", \"_blank\");\n    if (!w) return;\n    w.document.open();\n    w.document.write(html);\n    w.document.close();\n  };\n\n  return (\n    <div className=\"grid gap-6 md:grid-cols-2\">\n      <div className=\"md:col-span-2\">\n        <DesignRulePanel report={designRuleReport} title=\"Design Rules / 设计规则\" />\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Input Parameters / 输入参数</CardTitle>\n          <p className=\"text-xs text-muted-foreground\">Helical Compression Spring / 圆柱压缩弹簧</p>\n        </CardHeader>\n        <CardContent>\n          <form className=\"space-y-4\" onSubmit={form.handleSubmit(onSubmit)}>\n            {/* Material Selector */}\n            <MaterialSelector\n              value={selectedMaterial.id}\n              onChange={handleMaterialChange}\n              showDetails={true}\n            />\n\n            {/* Wire Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"d\"\n                label=\"Wire Diameter\"\n                description=\"线径 d，弹簧钢丝的直径。\"\n              />\n              <Label htmlFor=\"wireDiameter\">Wire Diameter d (mm) / 线径</Label>\n              <Input\n                id=\"wireDiameter\"\n                type=\"number\"\n                step=\"0.01\"\n                {...form.register(\"wireDiameter\", { valueAsNumber: true })}\n              />\n              {form.formState.errors.wireDiameter && (\n                <p className=\"text-sm text-red-500\">{form.formState.errors.wireDiameter.message}</p>\n              )}\n            </div>\n\n            {/* Mean Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Dm\"\n                label=\"Mean Coil Diameter\"\n                description=\"中径 Dm = (外径 + 内径) / 2。\"\n              />\n              <Label htmlFor=\"meanDiameter\">Mean Diameter Dm (mm) / 中径</Label>\n              <Input\n                id=\"meanDiameter\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"meanDiameter\", { valueAsNumber: true })}\n              />\n              {form.formState.errors.meanDiameter && (\n                <p className=\"text-sm text-red-500\">{form.formState.errors.meanDiameter.message}</p>\n              )}\n            </div>\n\n            {/* Active Coils */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"activeCoils\">Active Coils Na / 有效圈数</Label>\n              <Input\n                id=\"activeCoils\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"activeCoils\", { valueAsNumber: true })}\n              />\n              {form.formState.errors.activeCoils && (\n                <p className=\"text-sm text-red-500\">{form.formState.errors.activeCoils.message}</p>\n              )}\n            </div>\n\n            {/* Total Coils */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"totalCoils\">Total Coils Nt / 总圈数</Label>\n              <Input\n                id=\"totalCoils\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"totalCoils\", { valueAsNumber: true })}\n              />\n              {form.formState.errors.totalCoils && (\n                <p className=\"text-sm text-red-500\">{form.formState.errors.totalCoils.message}</p>\n              )}\n            </div>\n\n            {/* Shear Modulus */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"shearModulus\">Shear Modulus G (MPa) / 剪切模量</Label>\n              <Input\n                id=\"shearModulus\"\n                type=\"number\"\n                step=\"100\"\n                {...form.register(\"shearModulus\", { valueAsNumber: true })}\n              />\n              {form.formState.errors.shearModulus && (\n                <p className=\"text-sm text-red-500\">{form.formState.errors.shearModulus.message}</p>\n              )}\n            </div>\n\n            {/* Free Length */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"freeLength\">Free Length L₀ (mm) / 自由长度 <span className=\"text-slate-400\">(optional)</span></Label>\n              <Input\n                id=\"freeLength\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"freeLength\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Working Deflection */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Δx\"\n                label=\"Working Deflection\"\n                description=\"工作压缩量，从自由长度压缩的行程。\"\n              />\n              <Label htmlFor=\"deflection\">Working Deflection Δx (mm) / 工作压缩量</Label>\n              <Input\n                id=\"deflection\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"deflection\", { valueAsNumber: true })}\n              />\n              {form.formState.errors.deflection && (\n                <p className=\"text-sm text-red-500\">{form.formState.errors.deflection.message}</p>\n              )}\n            </div>\n\n            {/* Preload Deflection */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"preloadDeflection\">\n                Preload x₀ (mm) / 预压缩量 <span className=\"text-slate-400\">(optional)</span>\n              </Label>\n              <Input\n                id=\"preloadDeflection\"\n                type=\"number\"\n                step=\"0.1\"\n                min=\"0\"\n                {...form.register(\"preloadDeflection\", { valueAsNumber: true })}\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Initial compression before working load / 工作载荷前的初始压缩量\n              </p>\n            </div>\n\n            {/* Stress Ratio for Fatigue */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"stressRatio\">\n                Stress Ratio τ_min/τ_max / 应力比 <span className=\"text-slate-400\">(for fatigue)</span>\n              </Label>\n              <Input\n                id=\"stressRatio\"\n                type=\"number\"\n                step=\"0.05\"\n                min=\"0\"\n                max=\"1\"\n                {...form.register(\"stressRatio\", { valueAsNumber: true })}\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                0 = pulsating, 0.5 = partial reversal / 0=脉动，0.5=部分反向\n              </p>\n            </div>\n\n            {error && <p className=\"text-sm text-red-500\">{error}</p>}\n\n            <div className=\"flex flex-wrap gap-4 text-sm\">\n              <label className=\"flex items-center gap-2\">\n                <input type=\"checkbox\" {...form.register(\"topGround\")} /> Top ground / 顶端磨平\n              </label>\n              <label className=\"flex items-center gap-2\">\n                <input type=\"checkbox\" {...form.register(\"bottomGround\")} /> Bottom ground / 底端磨平\n              </label>\n            </div>\n\n            <details className=\"rounded-md border border-slate-200 bg-slate-50 p-3\">\n              <summary className=\"cursor-pointer text-sm font-medium text-slate-700\">\n                PPAP / 工艺与质量\n              </summary>\n              <div className=\"mt-3 space-y-4\">\n                <div className=\"grid gap-3 md:grid-cols-2\">\n                  <div className=\"space-y-2\">\n                    <Label>Customer / 客户</Label>\n                    <Input\n                      value={compressionPpap?.customer ?? \"\"}\n                      onChange={(e) => updateCompressionPpap({ customer: e.target.value })}\n                      disabled={storedEds?.type !== \"compression\"}\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Part Number / 零件号</Label>\n                    <Input\n                      value={compressionPpap?.partNumber ?? \"\"}\n                      onChange={(e) => updateCompressionPpap({ partNumber: e.target.value })}\n                      disabled={storedEds?.type !== \"compression\"}\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Revision / 版本</Label>\n                    <Input\n                      value={compressionPpap?.rev ?? \"\"}\n                      onChange={(e) => updateCompressionPpap({ rev: e.target.value })}\n                      disabled={storedEds?.type !== \"compression\"}\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Submission Level / 提交等级</Label>\n                    <Input\n                      value={compressionPpap?.submissionLevel ?? \"\"}\n                      onChange={(e) => updateCompressionPpap({ submissionLevel: e.target.value })}\n                      disabled={storedEds?.type !== \"compression\"}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label>CTQ / 关键特性</Label>\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() =>\n                        updateCompressionPpap({\n                          ctq: [...compressionCtq, { characteristic: \"\", spec: \"\", method: \"\", frequency: \"\", reactionPlan: \"\" }],\n                        })\n                      }\n                      disabled={storedEds?.type !== \"compression\"}\n                    >\n                      Add / 添加\n                    </Button>\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    {compressionCtq.map((c, idx) => (\n                      <div key={idx} className=\"rounded-md border border-slate-200 bg-white p-3\">\n                        <div className=\"grid gap-3 md:grid-cols-2\">\n                          <div className=\"space-y-2\">\n                            <Label>Characteristic / 特性</Label>\n                            <Input\n                              value={c.characteristic ?? \"\"}\n                              onChange={(e) => {\n                                const next = compressionCtq.slice();\n                                next[idx] = { ...next[idx], characteristic: e.target.value };\n                                updateCompressionPpap({ ctq: next });\n                              }}\n                              disabled={storedEds?.type !== \"compression\"}\n                            />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <Label>Spec / 规范</Label>\n                            <Input\n                              value={c.spec ?? \"\"}\n                              onChange={(e) => {\n                                const next = compressionCtq.slice();\n                                next[idx] = { ...next[idx], spec: e.target.value };\n                                updateCompressionPpap({ ctq: next });\n                              }}\n                              disabled={storedEds?.type !== \"compression\"}\n                            />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <Label>Method / 方法</Label>\n                            <Input\n                              value={c.method ?? \"\"}\n                              onChange={(e) => {\n                                const next = compressionCtq.slice();\n                                next[idx] = { ...next[idx], method: e.target.value };\n                                updateCompressionPpap({ ctq: next });\n                              }}\n                              disabled={storedEds?.type !== \"compression\"}\n                            />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <Label>Frequency / 频次</Label>\n                            <Input\n                              value={c.frequency ?? \"\"}\n                              onChange={(e) => {\n                                const next = compressionCtq.slice();\n                                next[idx] = { ...next[idx], frequency: e.target.value };\n                                updateCompressionPpap({ ctq: next });\n                              }}\n                              disabled={storedEds?.type !== \"compression\"}\n                            />\n                          </div>\n                        </div>\n\n                        <div className=\"mt-3 space-y-2\">\n                          <Label>Reaction Plan / 反应计划</Label>\n                          <Textarea\n                            value={c.reactionPlan ?? \"\"}\n                            onChange={(e) => {\n                              const next = compressionCtq.slice();\n                              next[idx] = { ...next[idx], reactionPlan: e.target.value };\n                              updateCompressionPpap({ ctq: next });\n                            }}\n                            disabled={storedEds?.type !== \"compression\"}\n                          />\n                        </div>\n\n                        <div className=\"mt-3 flex justify-end\">\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => {\n                              const next = compressionCtq.slice();\n                              next.splice(idx, 1);\n                              updateCompressionPpap({ ctq: next });\n                            }}\n                            disabled={storedEds?.type !== \"compression\"}\n                          >\n                            Remove / 删除\n                          </Button>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label>Process Route / 工艺路线</Label>\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() =>\n                        updateCompressionProcessRoute([\n                          ...compressionRoute,\n                          { stepName: \"\", machine: \"\", keyParams: \"\", operatorCheck: \"\", inProcessCheck: \"\" },\n                        ])\n                      }\n                      disabled={storedEds?.type !== \"compression\"}\n                    >\n                      Add / 添加\n                    </Button>\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    {compressionRoute.map((s, idx) => (\n                      <div key={idx} className=\"rounded-md border border-slate-200 bg-white p-3\">\n                        <div className=\"grid gap-3 md:grid-cols-2\">\n                          <div className=\"space-y-2\">\n                            <Label>Step / 工序</Label>\n                            <Input\n                              value={s.stepName ?? \"\"}\n                              onChange={(e) => {\n                                const next = compressionRoute.slice();\n                                next[idx] = { ...next[idx], stepName: e.target.value };\n                                updateCompressionProcessRoute(next);\n                              }}\n                              disabled={storedEds?.type !== \"compression\"}\n                            />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <Label>Machine / 设备</Label>\n                            <Input\n                              value={s.machine ?? \"\"}\n                              onChange={(e) => {\n                                const next = compressionRoute.slice();\n                                next[idx] = { ...next[idx], machine: e.target.value };\n                                updateCompressionProcessRoute(next);\n                              }}\n                              disabled={storedEds?.type !== \"compression\"}\n                            />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <Label>Key Params / 关键参数</Label>\n                            <Input\n                              value={s.keyParams ?? \"\"}\n                              onChange={(e) => {\n                                const next = compressionRoute.slice();\n                                next[idx] = { ...next[idx], keyParams: e.target.value };\n                                updateCompressionProcessRoute(next);\n                              }}\n                              disabled={storedEds?.type !== \"compression\"}\n                            />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <Label>Operator Check / 操作员检查</Label>\n                            <Input\n                              value={s.operatorCheck ?? \"\"}\n                              onChange={(e) => {\n                                const next = compressionRoute.slice();\n                                next[idx] = { ...next[idx], operatorCheck: e.target.value };\n                                updateCompressionProcessRoute(next);\n                              }}\n                              disabled={storedEds?.type !== \"compression\"}\n                            />\n                          </div>\n                        </div>\n\n                        <div className=\"mt-3 space-y-2\">\n                          <Label>In-process Check / 过程检验</Label>\n                          <Textarea\n                            value={s.inProcessCheck ?? \"\"}\n                            onChange={(e) => {\n                              const next = compressionRoute.slice();\n                              next[idx] = { ...next[idx], inProcessCheck: e.target.value };\n                              updateCompressionProcessRoute(next);\n                            }}\n                            disabled={storedEds?.type !== \"compression\"}\n                          />\n                        </div>\n\n                        <div className=\"mt-3 flex justify-end\">\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => {\n                              const next = compressionRoute.slice();\n                              next.splice(idx, 1);\n                              updateCompressionProcessRoute(next);\n                            }}\n                            disabled={storedEds?.type !== \"compression\"}\n                          >\n                            Remove / 删除\n                          </Button>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                <div className=\"flex justify-end\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => {\n                      previewPpapHtml().catch((e) => {\n                        alert(\n                          e instanceof Error\n                            ? `${e.message} / 生成报告失败`\n                            : \"Failed to generate report / 生成报告失败\"\n                        );\n                      });\n                    }}\n                    disabled={storedEds?.type !== \"compression\" || !storedResolved || storedResolved.type !== \"compression\" || !storedAnalysis}\n                  >\n                    Preview PPAP (HTML) / 预览 PPAP（HTML）\n                  </Button>\n                </div>\n              </div>\n            </details>\n\n            <Button \n              type=\"submit\" \n              className=\"w-full transition-all duration-200 active:scale-95\"\n              disabled={form.formState.isSubmitting}\n            >\n              {form.formState.isSubmitting ? (\n                <>\n                  <span className=\"animate-spin mr-2\">⏳</span>\n                  Calculating... / 计算中...\n                </>\n              ) : form.formState.isSubmitSuccessful && result ? (\n                <>\n                  <span className=\"mr-2\">✓</span>\n                  Calculated / 已计算\n                </>\n              ) : (\n                \"Calculate / 计算\"\n              )}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-50\">\n        <CardHeader>\n          <CardTitle>Results / 计算结果</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {result ? (\n            <div className=\"space-y-3\">\n              <ResultRow label=\"Spring Rate k (N/mm) / 刚度\" value={formatNumber(result.k)} />\n              <ResultRow label=\"Force F at Δx (N) / 载荷\" value={formatNumber(result.load)} />\n              <ResultRow label=\"Shear Stress τ (MPa) / 剪应力\" value={formatNumber(result.shearStress)} />\n              <ResultRow label=\"Spring Index C / 旋绕比\" value={formatNumber(result.springIndex)} />\n              <ResultRow label=\"Wahl Factor Kw / 曲度系数\" value={formatNumber(result.wahlFactor)} />\n              <ResultRow label=\"Total Coils Nt / 总圈数\" value={formatNumber(form.getValues(\"totalCoils\"))} />\n              <ResultRow\n                label=\"Ground Ends / 磨平端\"\n                value={\n                  form.getValues(\"topGround\") || form.getValues(\"bottomGround\")\n                    ? `${form.getValues(\"topGround\") ? \"Top\" : \"\"}${\n                        form.getValues(\"topGround\") && form.getValues(\"bottomGround\") ? \" & \" : \"\"\n                      }${form.getValues(\"bottomGround\") ? \"Bottom\" : \"\"}`\n                    : \"None\"\n                }\n              />\n            </div>\n          ) : (\n            <p className=\"text-sm text-slate-700 dark:text-slate-200\">\n              Input parameters and run the calculation to view stiffness, load, and stress results.\n              <br />\n              <span className=\"text-slate-600 dark:text-slate-400\">输入参数并点击计算，查看刚度、载荷与应力结果。</span>\n            </p>\n          )}\n\n          {/* Action Buttons - 重新设计的按钮样式 */}\n          <div className=\"space-y-3\">\n            {/* Generate 3D Model button hidden for now\n            <Button \n              asChild \n              className=\"w-full bg-slate-700 hover:bg-slate-600 text-white border-0 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg\" \n              disabled={!result}\n            >\n              <a href={simulatorUrl || \"#\"}>Generate 3D Model / 生成3D模型</a>\n            </Button>\n            */}\n            <Button \n              asChild \n              variant=\"outline\" \n              className=\"w-full border-sky-500/50 text-sky-400 bg-sky-500/10 hover:bg-sky-500/20 hover:border-sky-400 hover:text-sky-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-sky-500/10\"\n            >\n              <a href={analysisUrl}>Send to Engineering Analysis / 发送到工程分析</a>\n            </Button>\n            <Button \n              asChild \n              variant=\"outline\" \n              className=\"w-full border-violet-500/50 text-violet-400 bg-violet-500/10 hover:bg-violet-500/20 hover:border-violet-400 hover:text-violet-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-violet-500/10\" \n              disabled={!result}\n            >\n              <a href={cadExportUrl}>Export CAD / 导出 CAD</a>\n            </Button>\n          </div>\n\n          <div className=\"pt-4 border-t border-slate-200 dark:border-slate-700\">\n            <p className=\"text-sm font-semibold text-slate-900 dark:text-slate-50\">3D Preview / 3D 预览</p>\n            <div className=\"mt-3\">\n              <Calculator3DPreview expectedType=\"compression\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Stress Analysis Card */}\n      {stressAnalysis && (\n        <div className=\"md:col-span-2\">\n          <StressAnalysisCard\n            stressCorrection={stressAnalysis.stressCorrection}\n            safetyFactor={stressAnalysis.safetyFactor}\n            fatigueLife={stressAnalysis.fatigueLife}\n            preload={preloadResult ?? undefined}\n          />\n        </div>\n      )}\n\n      <div className=\"md:col-span-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Variable Pitch Compression Spring / 变节距压缩弹簧</CardTitle>\n            <p className=\"text-xs text-muted-foreground\">\n              Moved to an independent tool page to avoid shared state conflicts.\n            </p>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <p className=\"text-sm text-slate-700 dark:text-slate-200\">\n              Use the dedicated tool for segmented pitch input, multi-point checks, curves, and report export.\n              <br />\n              <span className=\"text-slate-600 dark:text-slate-400\">请使用独立工具页进行分段节距输入、多工况校核、曲线与报告导出。</span>\n            </p>\n            <Button asChild variant=\"outline\">\n              <Link href=\"/tools/variable-pitch-compression\">Open Tool / 打开工具页</Link>\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nfunction ResultRow({ label, value }: { label: string; value: string }) {\n  return (\n    <div className=\"flex items-center justify-between text-sm\">\n      <span className=\"text-slate-700 dark:text-slate-300\">{label}</span>\n      <span className=\"font-semibold text-slate-900 dark:text-slate-50\">{value}</span>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ConicalCalculator.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ConicalNonlinearCurvePoint' is defined but never used.","line":10,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'simulatorUrl' is assigned a value but never used.","line":135,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":135,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'i' is defined but never used.","line":627,"column":36,"nodeType":null,"messageId":"unusedVar","endLine":627,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useMemo, useState, useCallback } from \"react\";\nimport { type SubmitHandler, useForm } from \"react-hook-form\";\n\nimport {\n  calculateLoadAndStress,\n  calculateConicalSpringNonlinear,\n  extractConicalStageTransitions,\n  type ConicalNonlinearCurvePoint,\n  type ConicalNonlinearResult,\n} from \"@/lib/springMath\";\nimport { SpringDesign } from \"@/lib/springTypes\";\nimport { buildConicalDesignRuleReport } from \"@/lib/designRules\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { DesignRulePanel } from \"@/components/design-rules/DesignRulePanel\";\nimport { DimensionHint } from \"./DimensionHint\";\nimport { MaterialSelector } from \"./MaterialSelector\";\nimport { Calculator3DPreview } from \"./Calculator3DPreview\";\nimport { \n  useSpringDesignStore,\n  type ConicalGeometry,\n  type ConicalEndType,\n  type MaterialInfo,\n  type AnalysisResult,\n  generateDesignCode,\n} from \"@/lib/stores/springDesignStore\";\nimport {\n  getDefaultSpringMaterial,\n  getSpringMaterial,\n  type SpringMaterial,\n} from \"@/lib/materials/springMaterials\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\ninterface FormValues {\n  wireDiameter: number;\n  largeDiameter: number;\n  smallDiameter: number;\n  activeCoils: number;\n  totalCoils: number;\n  freeLength: number;\n  shearModulus: number;\n  deflection: number;\n  endType: ConicalEndType;\n}\n\ntype CalculationResult = ReturnType<typeof calculateLoadAndStress> | null;\n\nexport function ConicalCalculator() {\n  const [nonlinearResult, setNonlinearResult] = useState<ConicalNonlinearResult | null>(null);\n  const [stageTransitions, setStageTransitions] = useState<ReturnType<typeof extractConicalStageTransitions> | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [mode, setMode] = useState<\"linear\" | \"nonlinear\">(\"linear\");\n  const [isCalculatingNonlinear, setIsCalculatingNonlinear] = useState(false);\n  \n  // 全局设计存储\n  const storedGeometry = useSpringDesignStore(state => state.geometry);\n  const storedMaterial = useSpringDesignStore(state => state.material);\n  const storedAnalysis = useSpringDesignStore(state => state.analysisResult);\n  const setDesign = useSpringDesignStore(state => state.setDesign);\n  const lastConicalGeometry = storedGeometry?.type === \"conical\" ? storedGeometry : null;\n  const lastConicalAnalysis = lastConicalGeometry ? storedAnalysis : null;\n\n  const designRuleReport = useMemo(() => {\n    return buildConicalDesignRuleReport({\n      geometry: lastConicalGeometry,\n      analysisResult: lastConicalAnalysis,\n      context: {\n        nonlinearResult,\n        nonlinearCurve: nonlinearResult?.curve ?? null,\n      },\n    });\n  }, [lastConicalGeometry, lastConicalAnalysis, nonlinearResult]);\n  \n  // 从 store 恢复上次的计算结果\n  const initialResult = useMemo<CalculationResult>(() => {\n    if (lastConicalGeometry && lastConicalAnalysis) {\n      const equivalentMeanDiameter = (lastConicalGeometry.largeOuterDiameter + lastConicalGeometry.smallOuterDiameter) / 2 \n        - lastConicalGeometry.wireDiameter;\n      return {\n        k: lastConicalAnalysis.springRate,\n        load: lastConicalAnalysis.workingLoad ?? 0,\n        shearStress: lastConicalAnalysis.shearStress ?? 0,\n        springIndex: lastConicalAnalysis.springIndex ?? equivalentMeanDiameter / lastConicalGeometry.wireDiameter,\n        wahlFactor: lastConicalAnalysis.wahlFactor ?? 1.2,\n      };\n    }\n    return null;\n  }, [lastConicalGeometry, lastConicalAnalysis]);\n  \n  const [result, setResult] = useState<CalculationResult>(initialResult);\n  const initialMaterial = useMemo<SpringMaterial>(() => {\n    if (storedMaterial?.id) {\n      return getSpringMaterial(storedMaterial.id) ?? getDefaultSpringMaterial();\n    }\n    return getDefaultSpringMaterial();\n  }, [storedMaterial?.id]);\n\n  const [selectedMaterial, setSelectedMaterial] = useState<SpringMaterial>(initialMaterial);\n  \n  // Derived: extract curve from nonlinear result\n  const nonlinearCurve = nonlinearResult?.curve ?? null;\n\n  const form = useForm<FormValues>({\n    defaultValues: {\n      wireDiameter: lastConicalGeometry?.wireDiameter ?? 3.0,\n      largeDiameter: lastConicalGeometry?.largeOuterDiameter ?? 30,\n      smallDiameter: lastConicalGeometry?.smallOuterDiameter ?? 15,\n      activeCoils: lastConicalGeometry?.activeCoils ?? 5,\n      totalCoils: lastConicalGeometry?.totalCoils ?? 7,\n      freeLength: lastConicalGeometry?.freeLength ?? 40,\n      shearModulus: lastConicalGeometry?.shearModulus ?? selectedMaterial.shearModulus ?? 79300,\n      deflection: lastConicalAnalysis?.workingDeflection ?? 15,\n      endType: lastConicalGeometry?.endType ?? \"closed_ground\",\n    },\n  });\n\n  const handleMaterialChange = useCallback(\n    (material: SpringMaterial) => {\n      setSelectedMaterial(material);\n      form.setValue(\"shearModulus\", material.shearModulus);\n    },\n    [form]\n  );\n\n  const simulatorUrl = useMemo(() => {\n    if (!result) return \"\";\n    const values = form.getValues();\n    // Use equivalent mean diameter for simulator\n    const equivalentMeanDiameter = (values.largeDiameter + values.smallDiameter) / 2 - values.wireDiameter;\n    const params = new URLSearchParams({\n      type: \"compression\", // Simulator uses compression for now\n      d: values.wireDiameter.toString(),\n      Dm: equivalentMeanDiameter.toString(),\n      Na: values.activeCoils.toString(),\n      G: values.shearModulus.toString(),\n      dx: values.deflection.toString(),\n    });\n    return `/tools/simulator?${params.toString()}`;\n  }, [result, form]);\n\n  // Watch form values for URL generation\n  const watchedValues = form.watch();\n\n  const analysisUrl = useMemo(() => {\n    const params = new URLSearchParams({\n      type: \"conical\",\n      d: watchedValues.wireDiameter?.toString() ?? \"3\",\n      D1: watchedValues.largeDiameter?.toString() ?? \"30\",\n      D2: watchedValues.smallDiameter?.toString() ?? \"15\",\n      Na: watchedValues.activeCoils?.toString() ?? \"6\",\n      L0: watchedValues.freeLength?.toString() ?? \"50\",\n      dxMin: \"0\",\n      dxMax: watchedValues.deflection?.toString() ?? \"15\",\n      material: selectedMaterial.id,\n    });\n    return `/tools/analysis?${params.toString()}`;\n  }, [watchedValues, selectedMaterial.id]);\n\n  const cadExportUrl = useMemo(() => {\n    const params = new URLSearchParams({\n      type: \"conical\",\n      d: watchedValues.wireDiameter?.toString() ?? \"3\",\n      D1: watchedValues.largeDiameter?.toString() ?? \"30\",\n      D2: watchedValues.smallDiameter?.toString() ?? \"15\",\n      Na: watchedValues.activeCoils?.toString() ?? \"6\",\n      Nt: watchedValues.totalCoils?.toString() ?? \"7\",\n      L0: watchedValues.freeLength?.toString() ?? \"50\",\n      endType: watchedValues.endType ?? \"closed_ground\",\n      material: selectedMaterial.id,\n      k: result?.k?.toString() ?? \"\",\n      dx: watchedValues.deflection?.toString() ?? \"15\",\n    });\n    return `/tools/cad-export?${params.toString()}`;\n  }, [watchedValues, result, selectedMaterial.id]);\n\n  // 保存设计到全局 store\n  const saveDesignToStore = useCallback((values: FormValues, calc: CalculationResult) => {\n    const geometry: ConicalGeometry = {\n      type: \"conical\",\n      wireDiameter: values.wireDiameter,\n      largeOuterDiameter: values.largeDiameter,\n      smallOuterDiameter: values.smallDiameter,\n      activeCoils: values.activeCoils,\n      totalCoils: values.totalCoils,\n      freeLength: values.freeLength,\n      endType: values.endType,\n      shearModulus: values.shearModulus,\n      materialId: selectedMaterial.id,\n    };\n    \n    const materialInfo: MaterialInfo = {\n      id: selectedMaterial.id,\n      name: selectedMaterial.nameEn,\n      shearModulus: values.shearModulus,\n      elasticModulus: selectedMaterial.elasticModulus ?? 207000,\n      density: selectedMaterial.density ?? 7850,\n    };\n    \n    const analysisResult: AnalysisResult = {\n      springRate: calc?.k ?? 0,\n      springRateUnit: \"N/mm\",\n      workingLoad: calc?.load,\n      shearStress: calc?.shearStress,\n      springIndex: calc?.springIndex,\n      wahlFactor: calc?.wahlFactor,\n      workingDeflection: values.deflection,\n    };\n    \n    setDesign({\n      springType: \"conical\",\n      geometry,\n      material: materialInfo,\n      analysisResult,\n      meta: {\n        designCode: generateDesignCode(geometry),\n      },\n    });\n  }, [selectedMaterial, setDesign]);\n\n  const onSubmitLinear: SubmitHandler<FormValues> = (values) => {\n    setError(null);\n    setMode(\"linear\");\n    setNonlinearResult(null);\n    setStageTransitions(null);\n    try {\n      // Calculate equivalent mean diameter for approximation\n      const equivalentMeanDiameter = (values.largeDiameter + values.smallDiameter) / 2 - values.wireDiameter;\n\n      const design: SpringDesign = {\n        type: \"compression\",\n        wireDiameter: values.wireDiameter,\n        meanDiameter: equivalentMeanDiameter,\n        activeCoils: values.activeCoils,\n        shearModulus: values.shearModulus,\n        freeLength: values.freeLength,\n      };\n\n      const calc = calculateLoadAndStress(design, values.deflection);\n      setResult(calc);\n      \n      // 保存到全局 store\n      saveDesignToStore(values, calc);\n    } catch (err) {\n      setResult(null);\n      setError(err instanceof Error ? err.message : \"Calculation failed\");\n    }\n  };\n\n  const onCalculateNonlinear = async () => {\n    setError(null);\n    setMode(\"nonlinear\");\n    setResult(null);\n    setIsCalculatingNonlinear(true);\n    const values = form.getValues();\n\n    try {\n      // 模拟异步计算延迟，让用户看到加载状态\n      await new Promise(resolve => setTimeout(resolve, 100));\n      \n      const nlResult = calculateConicalSpringNonlinear({\n        wireDiameter: values.wireDiameter,\n        largeOuterDiameter: values.largeDiameter,\n        smallOuterDiameter: values.smallDiameter,\n        activeCoils: values.activeCoils,\n        shearModulus: values.shearModulus,\n        freeLength: values.freeLength,\n        maxDeflection: values.deflection,\n        samplePoints: 50,\n      });\n\n      setNonlinearResult(nlResult);\n      setStageTransitions(extractConicalStageTransitions(nlResult.curve));\n    } catch (err) {\n      setNonlinearResult(null);\n      setStageTransitions(null);\n      setError(err instanceof Error ? err.message : \"Nonlinear calculation failed\");\n    } finally {\n      setIsCalculatingNonlinear(false);\n    }\n  };\n\n  const formatNumber = (value: number) => Number(value.toFixed(2)).toLocaleString();\n\n  return (\n    <div className=\"grid gap-6 md:grid-cols-2\">\n      <div className=\"md:col-span-2\">\n        <DesignRulePanel report={designRuleReport} title=\"Design Rules / 设计规则\" />\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Input Parameters / 输入参数</CardTitle>\n          <p className=\"text-xs text-muted-foreground\">Conical Spring / 圆锥弹簧</p>\n        </CardHeader>\n        <CardContent>\n          <form className=\"space-y-4\" onSubmit={form.handleSubmit(onSubmitLinear)}>\n            {/* Large Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"D₁\"\n                label=\"Large Outer Diameter\"\n                description=\"大端外径，锥形弹簧较大一端的外径。\"\n              />\n              <Label htmlFor=\"largeDiameter\">Large Diameter D₁ (mm) / 大端外径</Label>\n              <Input\n                id=\"largeDiameter\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"largeDiameter\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Small Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"D₂\"\n                label=\"Small Outer Diameter\"\n                description=\"小端外径，锥形弹簧较小一端的外径。\"\n              />\n              <Label htmlFor=\"smallDiameter\">Small Diameter D₂ (mm) / 小端外径</Label>\n              <Input\n                id=\"smallDiameter\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"smallDiameter\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Wire Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"d\"\n                label=\"Wire Diameter\"\n                description=\"线径，弹簧钢丝的直径。\"\n              />\n              <Label htmlFor=\"wireDiameter\">Wire Diameter d (mm) / 线径</Label>\n              <Input\n                id=\"wireDiameter\"\n                type=\"number\"\n                step=\"0.01\"\n                {...form.register(\"wireDiameter\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Free Length */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"L₀\"\n                label=\"Free Length\"\n                description=\"自由长度，弹簧未受力时的高度。\"\n              />\n              <Label htmlFor=\"freeLength\">Free Length L₀ (mm) / 自由长度</Label>\n              <Input\n                id=\"freeLength\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"freeLength\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Active Coils */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"activeCoils\">Active Coils Na / 有效圈数</Label>\n              <Input\n                id=\"activeCoils\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"activeCoils\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Total Coils */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Nt\"\n                label=\"Total Coils\"\n                description=\"总圈数，包括两端的死圈。通常 Nt = Na + 2（两端各 1 圈死圈）。\"\n              />\n              <Label htmlFor=\"totalCoils\">Total Coils Nt / 总圈数</Label>\n              <Input\n                id=\"totalCoils\"\n                type=\"number\"\n                step=\"0.5\"\n                {...form.register(\"totalCoils\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* End Type */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"End\"\n                label=\"End Type\"\n                description=\"端面形式：自然端（不磨平）、并紧（密绕但不磨平）、并紧磨平（密绕且磨平）。\"\n              />\n              <Label>End Type / 端面形式</Label>\n              <Select\n                value={form.watch(\"endType\")}\n                onValueChange={(value: ConicalEndType) => form.setValue(\"endType\", value)}\n              >\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Select end type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"natural\">Natural / 自然端</SelectItem>\n                  <SelectItem value=\"closed\">Closed / 并紧</SelectItem>\n                  <SelectItem value=\"closed_ground\">Closed & Ground / 并紧磨平</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <MaterialSelector value={selectedMaterial.id} onChange={handleMaterialChange} showDetails={true} />\n\n            {/* Shear Modulus */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"shearModulus\">Shear Modulus G (MPa) / 剪切模量</Label>\n              <Input\n                id=\"shearModulus\"\n                type=\"number\"\n                step=\"100\"\n                {...form.register(\"shearModulus\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Working Deflection */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Δx\"\n                label=\"Working Deflection\"\n                description=\"工作压缩量，从自由长度压缩的行程。\"\n              />\n              <Label htmlFor=\"deflection\">Working Deflection Δx (mm) / 工作压缩量</Label>\n              <Input\n                id=\"deflection\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"deflection\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {error && <p className=\"text-sm text-red-500\">{error}</p>}\n\n            <div className=\"flex gap-2\">\n              <Button \n                type=\"submit\" \n                className={`flex-1 transition-all duration-200 active:scale-95 ${\n                  mode === \"linear\" && result \n                    ? \"bg-emerald-600 hover:bg-emerald-700\" \n                    : \"\"\n                }`}\n                disabled={form.formState.isSubmitting || isCalculatingNonlinear}\n              >\n                {form.formState.isSubmitting ? (\n                  <>\n                    <span className=\"animate-spin mr-2\">⏳</span>\n                    计算中...\n                  </>\n                ) : mode === \"linear\" && result ? (\n                  <>\n                    <span className=\"mr-2\">✓</span>\n                    Linear / 已计算\n                  </>\n                ) : (\n                  \"Linear / 线性计算\"\n                )}\n              </Button>\n              <Button\n                type=\"button\"\n                variant={mode === \"nonlinear\" && nonlinearResult ? \"default\" : \"outline\"}\n                className={`flex-1 transition-all duration-200 active:scale-95 ${\n                  mode === \"nonlinear\" && nonlinearResult \n                    ? \"bg-emerald-600 hover:bg-emerald-700\" \n                    : \"\"\n                }`}\n                onClick={onCalculateNonlinear}\n                disabled={isCalculatingNonlinear || form.formState.isSubmitting}\n              >\n                {isCalculatingNonlinear ? (\n                  <>\n                    <span className=\"animate-spin mr-2\">⏳</span>\n                    计算中...\n                  </>\n                ) : mode === \"nonlinear\" && nonlinearResult ? (\n                  <>\n                    <span className=\"mr-2\">✓</span>\n                    Nonlinear / 已计算\n                  </>\n                ) : (\n                  \"Nonlinear / 非线性曲线\"\n                )}\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-50\">\n        <CardHeader>\n          <CardTitle>Results / 计算结果</CardTitle>\n          {(result || nonlinearCurve) && (\n            <p className=\"text-xs text-slate-600 dark:text-slate-400\">\n              Mode: {mode === \"linear\" ? \"Linear Approximation / 线性近似\" : \"Nonlinear Analysis / 非线性分析\"}\n            </p>\n          )}\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Linear Results */}\n          {mode === \"linear\" && result && (\n            <div className=\"space-y-4\">\n              {/* Approximation Notice */}\n              <div className=\"rounded-md border border-blue-500/30 bg-blue-500/10 p-3\">\n                <p className=\"text-xs text-blue-800 dark:text-blue-200\">\n                  Note: Linear approximation using equivalent mean diameter.\n                </p>\n                <p className=\"text-xs text-blue-700/80 dark:text-blue-300/80\">\n                  注意：使用等效中径的线性近似计算。\n                </p>\n              </div>\n\n              {/* Results */}\n              <div className=\"space-y-3\">\n                <ResultRow label=\"Spring Rate k (N/mm) / 刚度\" value={`≈ ${formatNumber(result.k)}`} />\n                <ResultRow label=\"Force F at Δx (N) / 载荷\" value={`≈ ${formatNumber(result.load)}`} />\n                <ResultRow label=\"Shear Stress τ (MPa) / 剪应力\" value={`≈ ${formatNumber(result.shearStress)}`} />\n                <ResultRow label=\"Spring Index C / 旋绕比\" value={formatNumber(result.springIndex)} />\n                <ResultRow label=\"Wahl Factor Kw / 曲度系数\" value={formatNumber(result.wahlFactor)} />\n              </div>\n            </div>\n          )}\n\n          {/* Nonlinear Results */}\n          {mode === \"nonlinear\" && nonlinearCurve && nonlinearResult && stageTransitions && (\n            <div className=\"space-y-4\">\n              {/* Warning if exceeded solid height */}\n              {nonlinearResult.exceededSolidHeight && (\n                <div className=\"rounded-md border border-amber-500/30 bg-amber-500/10 p-3\">\n                  <p className=\"text-xs font-medium text-amber-800 dark:text-amber-200\">\n                    ⚠️ Max deflection exceeds total available travel before solid height.\n                  </p>\n                  <p className=\"text-xs text-amber-700/80 dark:text-amber-300/80\">\n                    最大压缩量超过弹簧可压缩行程（到实心高度）。曲线已截止于 {nonlinearResult.clampedMaxDeflection.toFixed(2)} mm。\n                  </p>\n                </div>\n              )}\n\n              {/* Nonlinear Notice */}\n              <div className=\"rounded-md border border-green-500/30 bg-green-500/10 p-3\">\n                <p className=\"text-xs text-green-800 dark:text-green-200\">\n                  Nonlinear model: coils collapse progressively as deflection increases.\n                </p>\n                <p className=\"text-xs text-green-700/80 dark:text-green-300/80\">\n                  非线性模型：随压缩量增加，线圈逐步贴底。\n                </p>\n                <div className=\"mt-2 grid grid-cols-2 gap-2 text-xs text-green-700 dark:text-green-400\">\n                  <span>Solid Height: {nonlinearResult.solidHeight.toFixed(2)} mm</span>\n                  <span>Max Travel: {nonlinearResult.totalDeflectionCapacity.toFixed(2)} mm</span>\n                  <span>Pitch: {nonlinearResult.pitch.toFixed(2)} mm/coil</span>\n                </div>\n              </div>\n\n              {/* Final Point Summary */}\n              {nonlinearCurve.length > 0 && (\n                <div className=\"space-y-3\">\n                  <ResultRow\n                    label=\"Final Load F (N) / 最终载荷\"\n                    value={formatNumber(nonlinearCurve[nonlinearCurve.length - 1].load)}\n                    highlight\n                  />\n                  <ResultRow\n                    label=\"Final Stiffness k (N/mm) / 最终刚度\"\n                    value={formatNumber(nonlinearCurve[nonlinearCurve.length - 1].k)}\n                  />\n                  <ResultRow\n                    label=\"Active Coils / 有效圈数\"\n                    value={`${nonlinearCurve[nonlinearCurve.length - 1].activeCoils}`}\n                  />\n                  <ResultRow\n                    label=\"Collapsed Coils / 贴底圈数\"\n                    value={`${nonlinearCurve[nonlinearCurve.length - 1].collapsedCoils}`}\n                  />\n                </div>\n              )}\n\n              {/* Stage Transitions */}\n              <div className=\"space-y-2\">\n                <p className=\"text-xs font-medium text-slate-700 dark:text-slate-300\">Coil Collapse Stages / 圈贴底阶段:</p>\n                <div className=\"max-h-40 overflow-y-auto rounded-md border border-slate-200 bg-white p-2 text-xs dark:border-slate-700 dark:bg-slate-800\">\n                  {stageTransitions.map((stage, idx) => (\n                    <div key={idx} className=\"border-b border-slate-200 py-1.5 last:border-0 dark:border-slate-700\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"font-medium text-slate-900 dark:text-slate-200\">\n                          Stage {stage.stage}\n                        </span>\n                        <span className=\"text-emerald-700 dark:text-green-400\">\n                          k = {stage.stiffness.toFixed(2)} N/mm\n                        </span>\n                      </div>\n                      <div className=\"mt-0.5 text-slate-700 dark:text-slate-300\">\n                        x = {stage.deflection.toFixed(2)} mm, active coils = {stage.activeCoils}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {/* Curve Preview */}\n              <div className=\"space-y-2\">\n                <p className=\"text-xs font-medium text-slate-700 dark:text-slate-300\">F–Δx Curve Preview / 曲线预览:</p>\n                <div className=\"h-24 rounded-md border border-slate-200 bg-white p-2 dark:border-slate-700 dark:bg-slate-800\">\n                  <div className=\"relative h-full w-full\">\n                    {/* Simple SVG curve preview */}\n                    <svg viewBox=\"0 0 100 50\" className=\"h-full w-full\" preserveAspectRatio=\"none\">\n                      <polyline\n                        fill=\"none\"\n                        stroke=\"#22c55e\"\n                        strokeWidth=\"1\"\n                        points={nonlinearCurve\n                          .map((p, i) => {\n                            const maxLoad = nonlinearCurve[nonlinearCurve.length - 1].load || 1;\n                            const maxX = nonlinearCurve[nonlinearCurve.length - 1].x || 1;\n                            const x = (p.x / maxX) * 100;\n                            const y = 50 - (p.load / maxLoad) * 45;\n                            return `${x},${y}`;\n                          })\n                          .join(\" \")}\n                      />\n                    </svg>\n                    <div className=\"absolute bottom-0 left-0 text-[8px] text-slate-500 dark:text-slate-400\">0</div>\n                    <div className=\"absolute bottom-0 right-0 text-[8px] text-slate-500 dark:text-slate-400\">\n                      {nonlinearCurve[nonlinearCurve.length - 1]?.x.toFixed(1)}mm\n                    </div>\n                    <div className=\"absolute left-0 top-0 text-[8px] text-slate-500 dark:text-slate-400\">\n                      {nonlinearCurve[nonlinearCurve.length - 1]?.load.toFixed(0)}N\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Empty State */}\n          {!result && !nonlinearCurve && (\n            <p className=\"text-sm text-slate-700 dark:text-slate-200\">\n              Input parameters and choose a calculation mode.\n              <br />\n              <span className=\"text-slate-600 dark:text-slate-400\">输入参数并选择计算模式。</span>\n            </p>\n          )}\n\n          {/* Action Buttons - 重新设计的按钮样式 */}\n          <div className=\"space-y-3\">\n            {/* Generate 3D Model button hidden for now\n            <Button \n              asChild \n              className=\"w-full bg-slate-700 hover:bg-slate-600 text-white border-0 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg\" \n              disabled={!result && !nonlinearCurve}\n            >\n              <a href={simulatorUrl || \"#\"}>Generate 3D Model / 生成3D模型</a>\n            </Button>\n            */}\n            <Button \n              asChild \n              variant=\"outline\" \n              className=\"w-full border-sky-500/50 text-sky-400 bg-sky-500/10 hover:bg-sky-500/20 hover:border-sky-400 hover:text-sky-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-sky-500/10\"\n            >\n              <a href={analysisUrl}>Send to Engineering Analysis / 发送到工程分析</a>\n            </Button>\n            <Button \n              asChild \n              variant=\"outline\" \n              className=\"w-full border-violet-500/50 text-violet-400 bg-violet-500/10 hover:bg-violet-500/20 hover:border-violet-400 hover:text-violet-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-violet-500/10\" \n              disabled={!result && !nonlinearResult}\n            >\n              <a href={cadExportUrl}>Export CAD / 导出 CAD</a>\n            </Button>\n          </div>\n\n          <div className=\"pt-4 border-t border-slate-200 dark:border-slate-700\">\n            <p className=\"text-sm font-semibold text-slate-900 dark:text-slate-50\">3D Preview / 3D 预览</p>\n            <p className=\"mt-1 text-center text-xs text-slate-500\">\n              3D model uses equivalent cylindrical spring / 3D模型使用等效圆柱弹簧\n            </p>\n            <div className=\"mt-3\">\n              <Calculator3DPreview expectedType=\"conical\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction ResultRow({ label, value, highlight }: { label: string; value: string; highlight?: boolean }) {\n  return (\n    <div className=\"flex items-center justify-between text-sm\">\n      <span className={highlight ? \"text-slate-900 dark:text-slate-200 font-medium\" : \"text-slate-700 dark:text-slate-300\"}>\n        {label}\n      </span>\n      <span className={highlight ? \"font-bold text-emerald-700 dark:text-green-400\" : \"font-semibold text-slate-900 dark:text-slate-50\"}>\n        {value}\n      </span>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/DieSpringCalculator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/DimensionHint.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ExtensionCalculator.tsx","messages":[{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/ExtensionCalculator.tsx:193:25\n  191 |\n  192 |   // Watch form values for URL generation and live preview\n> 193 |   const watchedValues = form.watch();\n      |                         ^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  194 |\n  195 |   // Live preview: auto-update store when form values change (debounced)\n  196 |   useEffect(() => {","line":193,"column":25,"nodeType":null,"endLine":193,"endColumn":29},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'watchedValues'. Either include it or remove the dependency array.","line":263,"column":6,"nodeType":"ArrayExpression","endLine":275,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [watchedValues.outerDiameter, watchedValues.wireDiameter, watchedValues.activeCoils, watchedValues.bodyLength, watchedValues.freeLengthInsideHooks, watchedValues.shearModulus, watchedValues.initialTension, watchedValues.hookType, watchedValues.workingDeflection, selectedMaterial, setDesign, watchedValues]","fix":{"range":[9516,9856],"text":"[watchedValues.outerDiameter, watchedValues.wireDiameter, watchedValues.activeCoils, watchedValues.bodyLength, watchedValues.freeLengthInsideHooks, watchedValues.shearModulus, watchedValues.initialTension, watchedValues.hookType, watchedValues.workingDeflection, selectedMaterial, setDesign, watchedValues]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useMemo, useState, useCallback, useEffect } from \"react\";\nimport { type SubmitHandler, useForm } from \"react-hook-form\";\n\nimport { calculateExtensionSpring, type ExtensionSpringInput } from \"@/lib/springMath\";\nimport { buildExtensionDesignRuleReport } from \"@/lib/designRules\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { DesignRulePanel } from \"@/components/design-rules/DesignRulePanel\";\nimport { DimensionHint } from \"./DimensionHint\";\nimport { MaterialSelector } from \"./MaterialSelector\";\nimport { Calculator3DPreview } from \"./Calculator3DPreview\";\nimport { \n  EXTENSION_HOOK_TYPES, \n  EXTENSION_HOOK_LABELS, \n  type ExtensionHookType \n} from \"@/lib/springTypes\";\nimport {\n  getDefaultSpringMaterial,\n  getSpringMaterial,\n  type SpringMaterial,\n} from \"@/lib/materials/springMaterials\";\nimport { \n  useSpringDesignStore,\n  type ExtensionGeometry,\n  type MaterialInfo,\n  type AnalysisResult,\n  generateDesignCode,\n} from \"@/lib/stores/springDesignStore\";\n\ninterface FormValues {\n  outerDiameter: number;\n  wireDiameter: number;\n  activeCoils: number;\n  bodyLength: number;\n  freeLengthInsideHooks: number;\n  shearModulus: number;\n  initialTension: number;\n  hookType: ExtensionHookType;\n  workingDeflection: number;\n}\n\ntype CalculationResult = ReturnType<typeof calculateExtensionSpring> | null;\n\nexport function ExtensionCalculator() {\n  const [error, setError] = useState<string | null>(null);\n  \n  // 全局设计存储\n  const storedGeometry = useSpringDesignStore(state => state.geometry);\n  const storedMaterial = useSpringDesignStore(state => state.material);\n  const storedAnalysis = useSpringDesignStore(state => state.analysisResult);\n  const setDesign = useSpringDesignStore(state => state.setDesign);\n\n  const lastExtensionGeometry = storedGeometry?.type === \"extension\" ? storedGeometry : null;\n  const lastExtensionAnalysis = lastExtensionGeometry ? storedAnalysis : null;\n\n  const designRuleReport = useMemo(() => {\n    return buildExtensionDesignRuleReport({\n      geometry: lastExtensionGeometry,\n      analysisResult: lastExtensionAnalysis,\n    });\n  }, [lastExtensionGeometry, lastExtensionAnalysis]);\n  \n  // 从 store 恢复上次的计算结果\n  const initialResult = useMemo<CalculationResult>(() => {\n    if (lastExtensionGeometry && storedAnalysis) {\n      const meanDiameter = lastExtensionGeometry.meanDiameter ?? \n        (lastExtensionGeometry.outerDiameter - lastExtensionGeometry.wireDiameter);\n      return {\n        meanDiameter,\n        springIndex: storedAnalysis.springIndex ?? meanDiameter / lastExtensionGeometry.wireDiameter,\n        wahlFactor: storedAnalysis.wahlFactor ?? 1.2,\n        springRate: storedAnalysis.springRate,\n        initialTension: storedAnalysis.initialTension ?? 0,\n        workingDeflection: storedAnalysis.workingDeflection ?? 0,\n        elasticLoad: (storedAnalysis.workingLoad ?? 0) - (storedAnalysis.initialTension ?? 0),\n        totalLoad: storedAnalysis.workingLoad ?? 0,\n        shearStress: storedAnalysis.shearStress ?? 0,\n      };\n    }\n    return null;\n  }, [lastExtensionGeometry, storedAnalysis]);\n  \n  const [result, setResult] = useState<CalculationResult>(initialResult);\n  const initialMaterial = useMemo<SpringMaterial>(() => {\n    if (storedMaterial?.id) {\n      return getSpringMaterial(storedMaterial.id) ?? getDefaultSpringMaterial();\n    }\n    return getDefaultSpringMaterial();\n  }, [storedMaterial?.id]);\n  const [selectedMaterial, setSelectedMaterial] = useState<SpringMaterial>(initialMaterial);\n  const defaultDeflection = storedAnalysis?.maxDeflection ?? storedAnalysis?.workingDeflection ?? 15;\n\n  const form = useForm<FormValues>({\n    defaultValues: {\n      outerDiameter: lastExtensionGeometry?.outerDiameter ?? 12,\n      wireDiameter: lastExtensionGeometry?.wireDiameter ?? 1.5,\n      activeCoils: lastExtensionGeometry?.activeCoils ?? 10,\n      bodyLength: lastExtensionGeometry?.bodyLength ?? 25,\n      freeLengthInsideHooks: lastExtensionGeometry?.freeLength ?? 35,\n      shearModulus: lastExtensionGeometry?.shearModulus ?? selectedMaterial.shearModulus,\n      initialTension: lastExtensionGeometry?.initialTension ?? 3,\n      hookType: lastExtensionGeometry?.hookType ?? \"machine\",\n      workingDeflection: defaultDeflection,\n    },\n  });\n\n  const handleMaterialChange = useCallback(\n    (material: SpringMaterial) => {\n      setSelectedMaterial(material);\n      form.setValue(\"shearModulus\", material.shearModulus);\n    },\n    [form]\n  );\n\n  const persistDesign = useCallback(\n    (values: FormValues, calc: NonNullable<CalculationResult>) => {\n      const meanDiameter = values.outerDiameter - values.wireDiameter;\n\n      const geometry: ExtensionGeometry = {\n        type: \"extension\",\n        wireDiameter: values.wireDiameter,\n        outerDiameter: values.outerDiameter,\n        meanDiameter,\n        activeCoils: values.activeCoils,\n        bodyLength: values.bodyLength,\n        freeLength: values.freeLengthInsideHooks,\n        hookType: values.hookType,\n        initialTension: values.initialTension,\n        shearModulus: values.shearModulus,\n        materialId: selectedMaterial.id,\n      };\n\n      const material: MaterialInfo = {\n        id: selectedMaterial.id,\n        name: selectedMaterial.nameEn,\n        shearModulus: values.shearModulus,\n        elasticModulus: selectedMaterial.elasticModulus ?? 206000,\n        density: selectedMaterial.density ?? 7850,\n      };\n\n      const analysisResult: AnalysisResult = {\n        springRate: calc.springRate,\n        springRateUnit: \"N/mm\",\n        workingLoad: calc.totalLoad,\n        initialTension: calc.initialTension,\n        workingDeflection: calc.workingDeflection,\n        maxDeflection: values.workingDeflection,\n        shearStress: calc.shearStress,\n        springIndex: calc.springIndex,\n        wahlFactor: calc.wahlFactor,\n      };\n\n      setDesign({\n        springType: \"extension\",\n        geometry,\n        material,\n        analysisResult,\n        meta: {\n          designCode: generateDesignCode(geometry),\n        },\n      });\n    },\n    [selectedMaterial, setDesign]\n  );\n\n  const onSubmit: SubmitHandler<FormValues> = (values) => {\n    setError(null);\n    try {\n      const input: ExtensionSpringInput = {\n        outerDiameter: values.outerDiameter,\n        wireDiameter: values.wireDiameter,\n        activeCoils: values.activeCoils,\n        shearModulus: values.shearModulus,\n        initialTension: values.initialTension || 0,\n        workingDeflection: values.workingDeflection,\n      };\n\n      const calc = calculateExtensionSpring(input);\n      setResult(calc);\n\n      persistDesign(values, calc);\n    } catch (err) {\n      setResult(null);\n      setError(err instanceof Error ? err.message : \"Calculation failed\");\n    }\n  };\n\n  // Watch form values for URL generation and live preview\n  const watchedValues = form.watch();\n\n  // Live preview: auto-update store when form values change (debounced)\n  useEffect(() => {\n    const values = watchedValues;\n    if (!values.outerDiameter || !values.wireDiameter || !values.activeCoils) return;\n    \n    // Calculate for preview (without full validation)\n    try {\n      const input: ExtensionSpringInput = {\n        outerDiameter: values.outerDiameter,\n        wireDiameter: values.wireDiameter,\n        activeCoils: values.activeCoils,\n        shearModulus: values.shearModulus || 79300,\n        initialTension: values.initialTension || 0,\n        workingDeflection: values.workingDeflection || 10,\n      };\n      \n      const calc = calculateExtensionSpring(input);\n      const meanDiameter = values.outerDiameter - values.wireDiameter;\n      \n      // Update store for live 3D preview\n      // 拉簧本体长度 = Na × d（紧密贴合，无节距）\n      const solidBodyLength = values.activeCoils * values.wireDiameter;\n      const geometry: ExtensionGeometry = {\n        type: \"extension\",\n        wireDiameter: values.wireDiameter,\n        outerDiameter: values.outerDiameter,\n        meanDiameter,\n        activeCoils: values.activeCoils,\n        bodyLength: values.bodyLength || solidBodyLength,\n        freeLength: values.freeLengthInsideHooks || (solidBodyLength + values.wireDiameter * 4),\n        hookType: values.hookType || \"machine\",\n        initialTension: values.initialTension || 0,\n        shearModulus: values.shearModulus || 79300,\n        materialId: selectedMaterial.id,\n      };\n      \n      const material: MaterialInfo = {\n        id: selectedMaterial.id,\n        name: selectedMaterial.nameEn,\n        shearModulus: values.shearModulus || 79300,\n        elasticModulus: selectedMaterial.elasticModulus ?? 206000,\n        density: selectedMaterial.density ?? 7850,\n      };\n      \n      const analysisResult: AnalysisResult = {\n        springRate: calc.springRate,\n        springRateUnit: \"N/mm\",\n        workingLoad: calc.totalLoad,\n        initialTension: calc.initialTension,\n        workingDeflection: calc.workingDeflection,\n        maxDeflection: values.workingDeflection || 10,\n        shearStress: calc.shearStress,\n        springIndex: calc.springIndex,\n        wahlFactor: calc.wahlFactor,\n      };\n      \n      setDesign({\n        springType: \"extension\",\n        geometry,\n        material,\n        analysisResult,\n        meta: {\n          designCode: generateDesignCode(geometry),\n        },\n      });\n    } catch {\n      // Ignore calculation errors during live preview\n    }\n  }, [\n    watchedValues.outerDiameter,\n    watchedValues.wireDiameter,\n    watchedValues.activeCoils,\n    watchedValues.bodyLength,\n    watchedValues.freeLengthInsideHooks,\n    watchedValues.shearModulus,\n    watchedValues.initialTension,\n    watchedValues.hookType,\n    watchedValues.workingDeflection,\n    selectedMaterial,\n    setDesign,\n  ]);\n\n  const analysisUrl = useMemo(() => {\n    const meanDiameter = (watchedValues.outerDiameter ?? 20) - (watchedValues.wireDiameter ?? 2);\n    const params = new URLSearchParams({\n      type: \"extension\",\n      d: watchedValues.wireDiameter?.toString() ?? \"2\",\n      Dm: meanDiameter.toString(),\n      Na: watchedValues.activeCoils?.toString() ?? \"10\",\n      Lb: watchedValues.bodyLength?.toString() ?? \"40\",\n      Fi: watchedValues.initialTension?.toString() ?? \"5\",\n      dxMin: \"0\",\n      dxMax: watchedValues.workingDeflection?.toString() ?? \"10\",\n      material: selectedMaterial.id,\n      hookType: watchedValues.hookType ?? \"machine\",\n    });\n    return `/tools/analysis?${params.toString()}`;\n  }, [watchedValues, selectedMaterial.id]);\n\n  const cadExportUrl = useMemo(() => {\n    const meanDiameter = (watchedValues.outerDiameter ?? 20) - (watchedValues.wireDiameter ?? 2);\n    const params = new URLSearchParams({\n      type: \"extension\",\n      d: watchedValues.wireDiameter?.toString() ?? \"2\",\n      Dm: meanDiameter.toString(),\n      Na: watchedValues.activeCoils?.toString() ?? \"10\",\n      Lb: watchedValues.bodyLength?.toString() ?? \"40\",\n      Fi: watchedValues.initialTension?.toString() ?? \"5\",\n      material: selectedMaterial.id,\n      hookType: watchedValues.hookType ?? \"machine\",\n      k: result?.springRate?.toString() ?? \"\",\n      dx: watchedValues.workingDeflection?.toString() ?? \"10\",\n    });\n    return `/tools/cad-export?${params.toString()}`;\n  }, [watchedValues, result, selectedMaterial.id]);\n\n  const handleNavigateToCad = () => {\n    if (!result) return;\n    persistDesign(form.getValues(), result);\n  };\n\n  const formatNumber = (value: number) => Number(value.toFixed(2)).toLocaleString();\n\n  return (\n    <div className=\"grid gap-6 md:grid-cols-2\">\n      <div className=\"md:col-span-2\">\n        <DesignRulePanel report={designRuleReport} title=\"Design Rules / 设计规则\" />\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Input Parameters / 输入参数</CardTitle>\n          <p className=\"text-xs text-muted-foreground\">Extension Spring / 拉伸弹簧</p>\n          <div className=\"mt-2 rounded-md bg-slate-100 p-2 text-xs text-slate-600\">\n            <p>Spring rate is computed from the body coils using the same formula as compression springs.</p>\n            <p className=\"text-slate-500\">刚度按弹簧本体等效压缩弹簧公式计算，总载荷 = 初拉力 + k·工作伸长量。</p>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <form className=\"space-y-4\" onSubmit={form.handleSubmit(onSubmit)}>\n            {/* Outer Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"OD\"\n                label=\"Outer Diameter\"\n                description=\"外径，从线圈外缘到外缘的距离。\"\n              />\n              <Label htmlFor=\"outerDiameter\">Outer Diameter OD (mm) / 外径</Label>\n              <Input\n                id=\"outerDiameter\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"outerDiameter\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Wire Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"d\"\n                label=\"Wire Diameter\"\n                description=\"线径，弹簧钢丝的直径。\"\n              />\n              <Label htmlFor=\"wireDiameter\">Wire Diameter d (mm) / 线径</Label>\n              <Input\n                id=\"wireDiameter\"\n                type=\"number\"\n                step=\"0.01\"\n                {...form.register(\"wireDiameter\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Active Coils */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Na\"\n                label=\"Active Coils\"\n                description=\"有效圈数，参与弹性变形的线圈数量。\"\n              />\n              <Label htmlFor=\"activeCoils\">Active Coils Na / 有效圈数</Label>\n              <Input\n                id=\"activeCoils\"\n                type=\"number\"\n                step=\"0.5\"\n                {...form.register(\"activeCoils\", { valueAsNumber: true })}\n              />\n            </div>\n\n            <MaterialSelector value={selectedMaterial.id} onChange={handleMaterialChange} showDetails={true} />\n\n            {/* Shear Modulus */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"shearModulus\">Shear Modulus G (MPa) / 剪切模量</Label>\n              <Input\n                id=\"shearModulus\"\n                type=\"number\"\n                step=\"100\"\n                {...form.register(\"shearModulus\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Body Length */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Lb\"\n                label=\"Body Length\"\n                description=\"弹簧本体长度，不含钩子的线圈部分。\"\n              />\n              <Label htmlFor=\"bodyLength\">Body Length Lb (mm) / 本体长度 <span className=\"text-slate-400\">(reference)</span></Label>\n              <Input\n                id=\"bodyLength\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"bodyLength\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Free Length Inside Hooks */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Lᵢ\"\n                label=\"Free Length Inside Hooks\"\n                description=\"钩内自由长度，钩内到钩内的距离。\"\n              />\n              <Label htmlFor=\"freeLengthInsideHooks\">Free Length Inside Hooks Lᵢ (mm) / 钩内自由长度 <span className=\"text-slate-400\">(reference)</span></Label>\n              <Input\n                id=\"freeLengthInsideHooks\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"freeLengthInsideHooks\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Initial Tension */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Fᵢ\"\n                label=\"Initial Tension\"\n                description=\"初拉力，弹簧开始伸长前需要克服的预紧力。\"\n              />\n              <Label htmlFor=\"initialTension\">Initial Tension Fᵢ (N) / 初拉力 <span className=\"text-slate-400\">(optional, default 0)</span></Label>\n              <Input\n                id=\"initialTension\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"initialTension\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {/* Hook Type - uses EXTENSION_HOOK_TYPES from springTypes.ts */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"hookType\">Hook Type / 钩型 <span className=\"text-slate-400\">(reference)</span></Label>\n              <select\n                id=\"hookType\"\n                className=\"w-full rounded-md border border-slate-200 bg-white p-2 text-sm\"\n                {...form.register(\"hookType\")}\n              >\n                {EXTENSION_HOOK_TYPES.map((type) => (\n                  <option key={type} value={type}>\n                    {EXTENSION_HOOK_LABELS[type].en} / {EXTENSION_HOOK_LABELS[type].zh}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            {/* Working Deflection */}\n            <div className=\"space-y-2\">\n              <DimensionHint\n                code=\"Δx\"\n                label=\"Working Deflection\"\n                description=\"工作伸长量，从自由长度拉伸的行程。\"\n              />\n              <Label htmlFor=\"workingDeflection\">Working Deflection Δx (mm) / 工作伸长量</Label>\n              <Input\n                id=\"workingDeflection\"\n                type=\"number\"\n                step=\"0.1\"\n                {...form.register(\"workingDeflection\", { valueAsNumber: true })}\n              />\n            </div>\n\n            {error && <p className=\"text-sm text-red-500\">{error}</p>}\n\n            <Button \n              type=\"submit\" \n              className=\"w-full transition-all duration-200 active:scale-95\"\n              disabled={form.formState.isSubmitting}\n            >\n              {form.formState.isSubmitting ? (\n                <>\n                  <span className=\"animate-spin mr-2\">⏳</span>\n                  Calculating... / 计算中...\n                </>\n              ) : form.formState.isSubmitSuccessful && result ? (\n                <>\n                  <span className=\"mr-2\">✓</span>\n                  Calculated / 已计算\n                </>\n              ) : (\n                \"Calculate / 计算\"\n              )}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-50\">\n        <CardHeader>\n          <CardTitle>Results / 计算结果</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {result ? (\n            <div className=\"space-y-4\">\n              {/* Calculation Results */}\n              <div className=\"space-y-3\">\n                <ResultRow label=\"Spring Rate k (N/mm) / 弹簧刚度\" value={formatNumber(result.springRate)} />\n                <ResultRow label=\"Initial Tension Fᵢ (N) / 初拉力\" value={formatNumber(result.initialTension)} />\n                <ResultRow label=\"Working Deflection Δx (mm) / 工作伸长量\" value={formatNumber(result.workingDeflection)} />\n                <ResultRow label=\"Elastic Load k·Δx (N) / 弹性载荷\" value={formatNumber(result.elasticLoad)} />\n                <div className=\"border-t border-slate-200 pt-2 dark:border-slate-700\">\n                  <ResultRow label=\"Total Load F (N) / 总载荷\" value={formatNumber(result.totalLoad)} highlight />\n                </div>\n                <ResultRow label=\"Shear Stress τ (MPa) / 剪应力\" value={formatNumber(result.shearStress)} />\n                <ResultRow label=\"Spring Index C / 旋绕比\" value={formatNumber(result.springIndex)} />\n                <ResultRow label=\"Wahl Factor Kw / 曲度系数\" value={formatNumber(result.wahlFactor)} />\n                <ResultRow label=\"Mean Diameter Dm (mm) / 中径\" value={formatNumber(result.meanDiameter)} />\n              </div>\n\n              {/* Formula Note */}\n              <div className=\"rounded-md border border-slate-200 bg-white p-3 text-xs text-slate-700 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400\">\n                <p>F_total = Fᵢ + k·Δx</p>\n                <p>τ = Kw · 8·F·Dm / (π·d³)</p>\n              </div>\n            </div>\n          ) : (\n            <p className=\"text-sm text-slate-700 dark:text-slate-200\">\n              Input parameters and run the calculation to view spring rate, load, and stress results.\n              <br />\n              <span className=\"text-slate-600 dark:text-slate-400\">输入参数并点击计算，查看刚度、载荷与应力结果。</span>\n            </p>\n          )}\n\n          {/* Action Buttons - 重新设计的按钮样式 */}\n          <div className=\"space-y-3\">\n            {/* Generate 3D Model button hidden for now\n            <Button \n              asChild \n              className=\"w-full bg-slate-700 hover:bg-slate-600 text-white border-0 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg\" \n              disabled={!result}\n            >\n              <a href={simulatorUrl || \"#\"}>Generate 3D Model / 生成3D模型</a>\n            </Button>\n            */}\n            <Button \n              asChild \n              variant=\"outline\" \n              className=\"w-full border-sky-500/50 text-sky-400 bg-sky-500/10 hover:bg-sky-500/20 hover:border-sky-400 hover:text-sky-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-sky-500/10\"\n            >\n              <a href={analysisUrl}>Send to Engineering Analysis / 发送到工程分析</a>\n            </Button>\n            <Button \n              variant=\"outline\" \n              className=\"w-full border-violet-500/50 text-violet-400 bg-violet-500/10 hover:bg-violet-500/20 hover:border-violet-400 hover:text-violet-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-violet-500/10\" \n              disabled={!result}\n              onClick={handleNavigateToCad}\n            >\n              <a href={cadExportUrl}>Export CAD / 导出 CAD</a>\n            </Button>\n          </div>\n\n          <div className=\"pt-4 border-t border-slate-200 dark:border-slate-700\">\n            <p className=\"text-sm font-semibold text-slate-900 dark:text-slate-50\">3D Preview / 3D 预览</p>\n            <div className=\"mt-3\">\n              <Calculator3DPreview expectedType=\"extension\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction ResultRow({ label, value, highlight }: { label: string; value: string; highlight?: boolean }) {\n  return (\n    <div className=\"flex items-center justify-between text-sm\">\n      <span className={highlight ? \"text-slate-900 dark:text-slate-200 font-medium\" : \"text-slate-700 dark:text-slate-300\"}>\n        {label}\n      </span>\n      <span className={highlight ? \"font-bold text-emerald-700 dark:text-emerald-400\" : \"font-semibold text-slate-900 dark:text-slate-50\"}>\n        {value}\n      </span>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/MaterialSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/SpiralTorsionCalculator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/StressAnalysisCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/SuspensionSpringCalculator.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useRouter' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'dmEnd', 'dmMid', and 'dmStart'. Either include them or remove the dependency array.","line":85,"column":6,"nodeType":"ArrayExpression","endLine":85,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [dmEnd, dmMid, dmStart, od, wireDiameter]","fix":{"range":[3696,3714],"text":"[dmEnd, dmMid, dmStart, od, wireDiameter]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'handleLoadcaseChange', 'loadcaseMode', and 'result.errors.length'. Either include them or remove the dependency array.","line":216,"column":6,"nodeType":"ArrayExpression","endLine":216,"endColumn":73,"suggestions":[{"desc":"Update the dependencies array to be: [result.rideDeflection_mm, result.preloadDeflection_mm, bumpTravel, result.errors.length, handleLoadcaseChange, loadcaseMode]","fix":{"range":[7622,7689],"text":"[result.rideDeflection_mm, result.preloadDeflection_mm, bumpTravel, result.errors.length, handleLoadcaseChange, loadcaseMode]"}}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":871,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":871,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33623,33626],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33623,33626],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useState, useMemo, useCallback } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { ChevronDown, AlertCircle, AlertTriangle, CheckCircle2 } from \"lucide-react\";\nimport { SuspensionSpringVisualizer } from \"@/components/three/SuspensionSpringVisualizer\";\nimport { buildPipelineUrl } from \"@/lib/pipeline/springPipelines\";\nimport {\n  calculateSuspensionSpring,\n  calculateStressRatioAtDeflection,\n  checkSuspensionSpringDesignRules,\n  getOverallStatus,\n  SUSPENSION_SPRING_MATERIAL_PRESETS,\n  type SuspensionSpringInput,\n  type EndType,\n} from \"@/lib/suspensionSpring\";\nimport type { PitchMode, DiameterMode } from \"@/lib/springTypes\";\nimport { useSpringDesignStore, type SuspensionGeometry } from \"@/lib/stores/springDesignStore\";\n\ntype LoadcaseMode = \"preload\" | \"ride\" | \"bump\";\n\nexport function SuspensionSpringCalculator() {\n  const [wireDiameter, setWireDiameter] = useState(12);\n  const [od, setOd] = useState(100);\n  const [activeCoils, setActiveCoils] = useState(6);\n  const [freeLength, setFreeLength] = useState(300);\n  const [endType, setEndType] = useState<EndType>(\"closed_ground\");\n\n  const [holeDiameter, setHoleDiameter] = useState<number | undefined>(undefined);\n  const [rodDiameter, setRodDiameter] = useState<number | undefined>(undefined);\n\n  const [materialPreset, setMaterialPreset] = useState(SUSPENSION_SPRING_MATERIAL_PRESETS[0].name);\n  const material = SUSPENSION_SPRING_MATERIAL_PRESETS.find((m) => m.name === materialPreset) || SUSPENSION_SPRING_MATERIAL_PRESETS[0];\n\n  const [preloadN, setPreloadN] = useState(500);\n  const [rideLoadN, setRideLoadN] = useState(2000);\n  const [bumpTravel, setBumpTravel] = useState(80);\n  const [solidMargin, setSolidMargin] = useState(3);\n\n  const [cornerMass, setCornerMass] = useState<number | undefined>(undefined);\n  const [motionRatio, setMotionRatio] = useState(1);\n  const [targetFreq, setTargetFreq] = useState<number | undefined>(undefined);\n\n  const [dynamicsOpen, setDynamicsOpen] = useState(false);\n  const [guideOpen, setGuideOpen] = useState(false);\n  const [progressiveOpen, setProgressiveOpen] = useState(false);\n  const [variableDiameterOpen, setVariableDiameterOpen] = useState(false);\n\n  // Advanced Geometry State\n  const [pitchMode, setPitchMode] = useState<PitchMode>(\"uniform\");\n  const [pitchCenter, setPitchCenter] = useState<number>(0); // 0 means auto\n  const [pitchEnd, setPitchEnd] = useState<number>(0); \n  const [endClosedTurns, setEndClosedTurns] = useState<number>(1);\n  const [transitionTurns, setTransitionTurns] = useState<number>(0.75);\n  const [groundTurnsPerEnd, setGroundTurnsPerEnd] = useState<number>(0.5);\n\n  const [diameterMode, setDiameterMode] = useState<DiameterMode>(\"constant\");\n  const [dmStart, setDmStart] = useState<number>(0);\n  const [dmMid, setDmMid] = useState<number>(0);\n  const [dmEnd, setDmEnd] = useState<number>(0);\n\n  // Init/Update defaults\n  React.useEffect(() => {\n    // Only set if 0 (uninitialized)\n    const currentMean = od - wireDiameter;\n    if (dmStart === 0) setDmStart(currentMean);\n    if (dmMid === 0) setDmMid(currentMean * 1.1); // slightly barrel by default\n    if (dmEnd === 0) setDmEnd(currentMean);\n    \n    // Auto pitch estimation\n    // if pitchCenter is 0\n  }, [od, wireDiameter]);\n\n  const [currentDeflection, setCurrentDeflection] = useState(0);\n  const [loadcaseMode, setLoadcaseMode] = useState<LoadcaseMode>(\"ride\");\n\n  const meanDiameter = od - wireDiameter;\n  const totalCoils = activeCoils + 2;\n\n  const input: SuspensionSpringInput = useMemo(\n    () => ({\n      geometry: {\n        od_mm: od,\n        wireDiameter_mm: wireDiameter,\n        activeCoils_Na: activeCoils,\n        totalCoils_Nt: totalCoils,\n        freeLength_Hf_mm: freeLength,\n        endType,\n        guide: {\n          holeDiameter_mm: holeDiameter,\n          rodDiameter_mm: rodDiameter,\n        },\n      },\n      material: {\n        shearModulus_G_MPa: material.shearModulus_G_MPa,\n        yieldStrength_MPa: material.yieldStrength_MPa,\n        fatigueLimit_MPa: material.fatigueLimit_MPa,\n        preset: material.name,\n      },\n      loadcase: {\n        preload_N: preloadN,\n        rideLoad_N: rideLoadN,\n        bumpTravel_mm: bumpTravel,\n        solidMargin_mm: solidMargin,\n        cornerMass_kg: cornerMass,\n        motionRatio,\n        targetFreq_Hz: targetFreq,\n      },\n    }),\n    [\n      od,\n      wireDiameter,\n      activeCoils,\n      totalCoils,\n      freeLength,\n      endType,\n      holeDiameter,\n      rodDiameter,\n      material,\n      preloadN,\n      rideLoadN,\n      bumpTravel,\n      solidMargin,\n      cornerMass,\n      motionRatio,\n      targetFreq,\n    ]\n  );\n\n  const result = useMemo(() => calculateSuspensionSpring(input), [input]);\n  const findings = useMemo(\n    () => (result.errors.length === 0 ? checkSuspensionSpringDesignRules(input, result) : []),\n    [input, result]\n  );\n  const overallStatus = getOverallStatus(findings);\n\n  // Build URLs for pipeline navigation\n  const designParams = useMemo(() => ({\n    d: String(wireDiameter),\n    od: String(od),\n    Na: String(activeCoils),\n    Nt: String(totalCoils),\n    Hf: String(freeLength),\n    endType,\n    material: materialPreset,\n    preload: String(preloadN),\n    rideLoad: String(rideLoadN),\n    bumpTravel: String(bumpTravel),\n    solidMargin: String(solidMargin),\n    holeDia: holeDiameter !== undefined ? String(holeDiameter) : undefined,\n    rodDia: rodDiameter !== undefined ? String(rodDiameter) : undefined,\n    cornerMass: cornerMass !== undefined ? String(cornerMass) : undefined,\n    motionRatio: String(motionRatio),\n    targetFreq: targetFreq !== undefined ? String(targetFreq) : undefined,\n  }), [wireDiameter, od, activeCoils, totalCoils, freeLength, endType, materialPreset, preloadN, rideLoadN, bumpTravel, solidMargin, holeDiameter, rodDiameter, cornerMass, motionRatio, targetFreq]);\n\n  const analysisUrl = useMemo(() => \n    buildPipelineUrl(\"/tools/analysis?type=suspensionSpring\", designParams), \n    [designParams]\n  );\n\n  const cadExportUrl = useMemo(() => \n    buildPipelineUrl(\"/tools/cad-export?type=suspensionSpring\", designParams), \n    [designParams]\n  );\n\n  const currentStressRatio = useMemo(() => {\n    if (result.errors.length > 0) return 0;\n    return calculateStressRatioAtDeflection(\n      result.springRate_N_per_mm,\n      result.stress.wahlFactor_Kw,\n      result.derived.meanDiameter_mm,\n      input.geometry.wireDiameter_mm,\n      input.material.yieldStrength_MPa,\n      currentDeflection\n    );\n  }, [result, input, currentDeflection]);\n\n  const currentLoad = result.springRate_N_per_mm * currentDeflection;\n\n  const handleLoadcaseChange = useCallback(\n    (mode: LoadcaseMode) => {\n      setLoadcaseMode(mode);\n      switch (mode) {\n        case \"preload\":\n          setCurrentDeflection(result.preloadDeflection_mm);\n          break;\n        case \"ride\":\n          setCurrentDeflection(result.rideDeflection_mm);\n          break;\n        case \"bump\":\n          setCurrentDeflection(bumpTravel);\n          break;\n      }\n    },\n    [result, bumpTravel]\n  );\n\n  React.useEffect(() => {\n    if (result.errors.length === 0) {\n      handleLoadcaseChange(loadcaseMode);\n    }\n  }, [result.rideDeflection_mm, result.preloadDeflection_mm, bumpTravel]);\n\n  const getSeverityIcon = (severity: string) => {\n    switch (severity) {\n      case \"error\":\n        return <AlertCircle className=\"h-4 w-4 text-red-500\" />;\n      case \"warning\":\n        return <AlertTriangle className=\"h-4 w-4 text-amber-500\" />;\n      default:\n        return <CheckCircle2 className=\"h-4 w-4 text-green-500\" />;\n    }\n  };\n\n  const getStatusBadge = () => {\n    switch (overallStatus) {\n      case \"error\":\n        return <Badge variant=\"destructive\">Error</Badge>;\n      case \"warning\":\n        return <Badge variant=\"secondary\" className=\"bg-amber-100 text-amber-800\">Warning</Badge>;\n      default:\n        return <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800\">OK</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4 p-4\">\n      <div className=\"space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg\">几何参数 / Geometry</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"grid grid-cols-2 gap-3\">\n              <div>\n                <Label htmlFor=\"wireDiameter\">线径 d (mm)</Label>\n                <Input\n                  id=\"wireDiameter\"\n                  type=\"number\"\n                  value={wireDiameter}\n                  onChange={(e) => setWireDiameter(Number(e.target.value))}\n                  step={0.5}\n                  min={1}\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"od\">外径 OD (mm)</Label>\n                <Input\n                  id=\"od\"\n                  type=\"number\"\n                  value={od}\n                  onChange={(e) => setOd(Number(e.target.value))}\n                  step={1}\n                  min={10}\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"activeCoils\">有效圈数 Na</Label>\n                <Input\n                  id=\"activeCoils\"\n                  type=\"number\"\n                  value={activeCoils}\n                  onChange={(e) => setActiveCoils(Number(e.target.value))}\n                  step={0.5}\n                  min={1}\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"freeLength\">自由长度 Hf (mm)</Label>\n                <Input\n                  id=\"freeLength\"\n                  type=\"number\"\n                  value={freeLength}\n                  onChange={(e) => setFreeLength(Number(e.target.value))}\n                  step={5}\n                  min={10}\n                />\n              </div>\n            </div>\n            <div>\n              <Label>端部类型 / End Type</Label>\n              <Select value={endType} onValueChange={(v) => setEndType(v as EndType)}>\n                <SelectTrigger>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"closed_ground\">并紧磨平 / Closed & Ground</SelectItem>\n                  <SelectItem value=\"closed\">并紧 / Closed</SelectItem>\n                  <SelectItem value=\"open\">开放 / Open</SelectItem>\n                </SelectContent>\n              </Select>\n              {/* Design hint for end type */}\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {endType === \"closed_ground\" && \"端面贴平用于稳定接触/降低偏载\"}\n                {endType === \"closed\" && \"并紧端适合多数悬架弹簧座圈装配\"}\n                {endType === \"open\" && \"开放端更像通用弹簧，需注意座圈接触\"}\n              </p>\n            </div>\n            {/* Conditional groundTurnsPerEnd for Closed & Ground */}\n            {endType === \"closed_ground\" && (\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div>\n                  <Label htmlFor=\"groundTurns\">磨平影响圈数 / Ground Turns</Label>\n                  <Input\n                    id=\"groundTurns\"\n                    type=\"number\"\n                    value={groundTurnsPerEnd}\n                    onChange={(e) => setGroundTurnsPerEnd(Number(e.target.value))}\n                    step={0.25}\n                    min={0.25}\n                    max={1.5}\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">每端磨平影响范围（圈）</p>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg\">载荷工况 / Loadcase</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"grid grid-cols-2 gap-3\">\n              <div>\n                <Label htmlFor=\"preloadN\">预载 F₀ (N)</Label>\n                <Input\n                  id=\"preloadN\"\n                  type=\"number\"\n                  value={preloadN}\n                  onChange={(e) => setPreloadN(Number(e.target.value))}\n                  step={50}\n                  min={0}\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"rideLoadN\">行驶载荷 F_ride (N)</Label>\n                <Input\n                  id=\"rideLoadN\"\n                  type=\"number\"\n                  value={rideLoadN}\n                  onChange={(e) => setRideLoadN(Number(e.target.value))}\n                  step={100}\n                  min={0}\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"bumpTravel\">触底行程 x_bump (mm)</Label>\n                <Input\n                  id=\"bumpTravel\"\n                  type=\"number\"\n                  value={bumpTravel}\n                  onChange={(e) => setBumpTravel(Number(e.target.value))}\n                  step={5}\n                  min={1}\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"solidMargin\">固高余量 (mm)</Label>\n                <Input\n                  id=\"solidMargin\"\n                  type=\"number\"\n                  value={solidMargin}\n                  onChange={(e) => setSolidMargin(Number(e.target.value))}\n                  step={1}\n                  min={0}\n                />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg\">材料 / Material</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Select value={materialPreset} onValueChange={setMaterialPreset}>\n              <SelectTrigger>\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {SUSPENSION_SPRING_MATERIAL_PRESETS.map((m) => (\n                  <SelectItem key={m.name} value={m.name}>\n                    {m.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <div className=\"mt-2 text-xs text-muted-foreground\">\n              G = {material.shearModulus_G_MPa.toLocaleString()} MPa, Sy = {material.yieldStrength_MPa} MPa\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader \n            className=\"pb-3 cursor-pointer hover:bg-muted/50\"\n            onClick={() => setGuideOpen(!guideOpen)}\n          >\n            <CardTitle className=\"text-lg flex items-center justify-between\">\n              导向 / Guide\n              <ChevronDown className={`h-4 w-4 transition-transform ${guideOpen ? \"rotate-180\" : \"\"}`} />\n            </CardTitle>\n          </CardHeader>\n          {guideOpen && (\n            <CardContent className=\"space-y-3\">\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div>\n                  <Label htmlFor=\"holeDiameter\">导向孔径 (mm)</Label>\n                  <Input\n                    id=\"holeDiameter\"\n                    type=\"number\"\n                    value={holeDiameter ?? \"\"}\n                    onChange={(e) => setHoleDiameter(e.target.value ? Number(e.target.value) : undefined)}\n                    placeholder=\"可选\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"rodDiameter\">导向杆径 (mm)</Label>\n                  <Input\n                    id=\"rodDiameter\"\n                    type=\"number\"\n                    value={rodDiameter ?? \"\"}\n                    onChange={(e) => setRodDiameter(e.target.value ? Number(e.target.value) : undefined)}\n                    placeholder=\"可选\"\n                  />\n                </div>\n              </div>\n            </CardContent>\n          )}\n        </Card>\n\n        <Card>\n          <CardHeader \n            className=\"pb-3 cursor-pointer hover:bg-muted/50\"\n            onClick={() => setDynamicsOpen(!dynamicsOpen)}\n          >\n            <CardTitle className=\"text-lg flex items-center justify-between\">\n              动态参数 / Dynamics\n              <ChevronDown className={`h-4 w-4 transition-transform ${dynamicsOpen ? \"rotate-180\" : \"\"}`} />\n            </CardTitle>\n          </CardHeader>\n          {dynamicsOpen && (\n            <CardContent className=\"space-y-3\">\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div>\n                  <Label htmlFor=\"cornerMass\">簧下质量 (kg)</Label>\n                  <Input\n                    id=\"cornerMass\"\n                    type=\"number\"\n                    value={cornerMass ?? \"\"}\n                    onChange={(e) => setCornerMass(e.target.value ? Number(e.target.value) : undefined)}\n                    placeholder=\"可选\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"motionRatio\">运动比 MR</Label>\n                  <Input\n                    id=\"motionRatio\"\n                    type=\"number\"\n                    value={motionRatio}\n                    onChange={(e) => setMotionRatio(Number(e.target.value))}\n                    step={0.1}\n                    min={0.1}\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"targetFreq\">目标频率 (Hz)</Label>\n                  <Input\n                    id=\"targetFreq\"\n                    type=\"number\"\n                    value={targetFreq ?? \"\"}\n                    onChange={(e) => setTargetFreq(e.target.value ? Number(e.target.value) : undefined)}\n                    placeholder=\"可选\"\n                  />\n                </div>\n              </div>\n            </CardContent>\n          )}\n        </Card>\n\n        {/* Progressive Geometry Section */}\n        <Card>\n          <CardHeader \n            className=\"pb-3 cursor-pointer hover:bg-muted/50\"\n            onClick={() => setProgressiveOpen(!progressiveOpen)}\n          >\n            <CardTitle className=\"text-lg flex items-center justify-between\">\n              渐进节距 / Progressive Pitch\n              <ChevronDown className={`h-4 w-4 transition-transform ${progressiveOpen ? \"rotate-180\" : \"\"}`} />\n            </CardTitle>\n          </CardHeader>\n          {progressiveOpen && (\n            <CardContent className=\"space-y-3\">\n              <div>\n                <Label>模式 / Mode</Label>\n                <Select value={pitchMode} onValueChange={(v) => setPitchMode(v as PitchMode)}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"uniform\">均匀 (Uniform)</SelectItem>\n                    <SelectItem value=\"twoStage\">两段式 (Two-Stage)</SelectItem>\n                    <SelectItem value=\"threeStage\">三段式 (Three-Stage)</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              {pitchMode !== \"uniform\" && (\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <Label>端部并紧圈数</Label>\n                    <Input \n                      type=\"number\" \n                      value={endClosedTurns} \n                      onChange={e => setEndClosedTurns(Number(e.target.value))}\n                      step={0.25}\n                    />\n                  </div>\n                  <div>\n                    <Label>过渡圈数</Label>\n                    <Input \n                      type=\"number\" \n                      value={transitionTurns} \n                      onChange={e => setTransitionTurns(Number(e.target.value))}\n                      step={0.25}\n                    />\n                  </div>\n                  <div>\n                    <Label>中间节距 (mm)</Label>\n                    <Input \n                      type=\"number\" \n                      value={pitchCenter || \"\"} \n                      placeholder=\"Auto\"\n                      onChange={e => setPitchCenter(Number(e.target.value))}\n                    />\n                  </div>\n                  <div>\n                    <Label>端部节距 (mm)</Label>\n                    <Input \n                      type=\"number\" \n                      value={pitchEnd || \"\"} \n                      placeholder=\"Auto\"\n                      onChange={e => setPitchEnd(Number(e.target.value))}\n                    />\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          )}\n        </Card>\n\n        {/* Variable Diameter Section */}\n        <Card>\n          <CardHeader \n            className=\"pb-3 cursor-pointer hover:bg-muted/50\"\n            onClick={() => setVariableDiameterOpen(!variableDiameterOpen)}\n          >\n            <CardTitle className=\"text-lg flex items-center justify-between\">\n              变中径 / Variable Diameter\n              <ChevronDown className={`h-4 w-4 transition-transform ${variableDiameterOpen ? \"rotate-180\" : \"\"}`} />\n            </CardTitle>\n          </CardHeader>\n          {variableDiameterOpen && (\n            <CardContent className=\"space-y-3\">\n              <div>\n                <Label>模式 / Mode</Label>\n                <Select value={diameterMode} onValueChange={(v) => setDiameterMode(v as DiameterMode)}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"constant\">恒定 (Constant)</SelectItem>\n                    <SelectItem value=\"barrel\">桶形 (Barrel)</SelectItem>\n                    <SelectItem value=\"conical\">锥形 (Conical)</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {diameterMode !== \"constant\" && (\n                <div className=\"grid grid-cols-2 gap-3\">\n                   <div>\n                    <Label>起始中径 Dm_start</Label>\n                    <Input \n                      type=\"number\" \n                      value={dmStart} \n                      onChange={e => setDmStart(Number(e.target.value))}\n                    />\n                  </div>\n                  \n                  {diameterMode === \"barrel\" && (\n                    <div>\n                      <Label>中间中径 Dm_mid</Label>\n                      <Input \n                        type=\"number\" \n                        value={dmMid} \n                        onChange={e => setDmMid(Number(e.target.value))}\n                      />\n                    </div>\n                  )}\n\n                  <div>\n                    <Label>结束中径 Dm_end</Label>\n                    <Input \n                      type=\"number\" \n                      value={dmEnd} \n                      onChange={e => setDmEnd(Number(e.target.value))}\n                    />\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          )}\n        </Card>\n      </div>\n\n      <div className=\"space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg flex items-center justify-between\">\n              3D 预览\n              {getStatusBadge()}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-[350px] rounded-lg overflow-hidden border\">\n              {result.errors.length === 0 ? (\n                <SuspensionSpringVisualizer\n                  wireDiameter={wireDiameter}\n                  meanDiameter={meanDiameter}\n                  activeCoils={activeCoils}\n                  totalCoils={totalCoils}\n                  freeLength={freeLength}\n                  currentDeflection={currentDeflection}\n                  stressRatio={currentStressRatio}\n                  solidHeight={result.derived.solidHeight_Hs_mm}\n                  currentLoad={currentLoad}\n                  springRate={result.springRate_N_per_mm}\n                  pitchProfile={{\n                    mode: pitchMode,\n                    pitchCenter: pitchCenter || undefined,\n                    pitchEnd: pitchEnd || undefined,\n                    endClosedTurns,\n                    transitionTurns,\n                    endType,\n                    endSpec: {\n                      type: endType,\n                      closedTurnsPerEnd: endClosedTurns,\n                      groundTurnsPerEnd: endType === \"closed_ground\" ? groundTurnsPerEnd : 0,\n                      seatDrop: 0,\n                      endAngleExtra: endType === \"closed_ground\" ? 0.25 : 0, // Longer contact arc for ground ends\n                    },\n                  }}\n                  diameterProfile={{\n                    mode: diameterMode,\n                    DmStart: dmStart,\n                    DmMid: dmMid,\n                    DmEnd: dmEnd,\n                  }}\n                />\n              ) : (\n                <div className=\"h-full flex items-center justify-center bg-slate-100\">\n                  <div className=\"text-center text-red-600\">\n                    <AlertCircle className=\"h-8 w-8 mx-auto mb-2\" />\n                    <p className=\"text-sm\">{result.errors[0]}</p>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            <div className=\"mt-4 space-y-3\">\n              <div className=\"flex gap-2\">\n                <Button\n                  variant={loadcaseMode === \"preload\" ? \"default\" : \"outline\"}\n                  size=\"sm\"\n                  onClick={() => handleLoadcaseChange(\"preload\")}\n                  disabled={result.errors.length > 0}\n                >\n                  Preload\n                </Button>\n                <Button\n                  variant={loadcaseMode === \"ride\" ? \"default\" : \"outline\"}\n                  size=\"sm\"\n                  onClick={() => handleLoadcaseChange(\"ride\")}\n                  disabled={result.errors.length > 0}\n                >\n                  Ride\n                </Button>\n                <Button\n                  variant={loadcaseMode === \"bump\" ? \"default\" : \"outline\"}\n                  size=\"sm\"\n                  onClick={() => handleLoadcaseChange(\"bump\")}\n                  disabled={result.errors.length > 0}\n                >\n                  Bump\n                </Button>\n              </div>\n\n              <div>\n                <Label>压缩量 Δx: {currentDeflection.toFixed(1)} mm</Label>\n                <Slider\n                  value={[currentDeflection]}\n                  onValueChange={([v]) => {\n                    setCurrentDeflection(v);\n                    setLoadcaseMode(\"ride\");\n                  }}\n                  min={0}\n                  max={bumpTravel}\n                  step={0.5}\n                  disabled={result.errors.length > 0}\n                />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg\">计算结果 / Results</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {result.errors.length > 0 ? (\n              <div className=\"text-red-600 space-y-1\">\n                {result.errors.map((e, i) => (\n                  <div key={i} className=\"flex items-start gap-2\">\n                    <AlertCircle className=\"h-4 w-4 mt-0.5 flex-shrink-0\" />\n                    <span className=\"text-sm\">{e}</span>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <div className=\"grid grid-cols-2 gap-x-4 gap-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">刚度 k:</span>\n                  <span className=\"font-medium\">{result.springRate_N_per_mm.toFixed(2)} N/mm</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">弹簧指数 C:</span>\n                  <span className=\"font-medium\">{result.derived.springIndex_C.toFixed(1)}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">固体高度 Hs:</span>\n                  <span className=\"font-medium\">{result.derived.solidHeight_Hs_mm.toFixed(1)} mm</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Wahl 系数:</span>\n                  <span className=\"font-medium\">{result.stress.wahlFactor_Kw.toFixed(3)}</span>\n                </div>\n\n                <div className=\"col-span-2 border-t pt-2 mt-2\">\n                  <div className=\"font-medium mb-1\">工况应力</div>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">τ_ride:</span>\n                  <span className=\"font-medium\">{result.stress.tauRide_MPa.toFixed(0)} MPa</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">τ_bump:</span>\n                  <span className=\"font-medium\">{result.stress.tauBump_MPa.toFixed(0)} MPa</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">SF_ride:</span>\n                  <span className=\"font-medium\">{result.stress.yieldSafetyFactor_ride.toFixed(2)}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">SF_bump:</span>\n                  <span className={`font-medium ${result.stress.yieldSafetyFactor_bump < 1.2 ? \"text-amber-600\" : \"\"}`}>\n                    {result.stress.yieldSafetyFactor_bump.toFixed(2)}\n                  </span>\n                </div>\n\n                {result.dynamics && (\n                  <>\n                    <div className=\"col-span-2 border-t pt-2 mt-2\">\n                      <div className=\"font-medium mb-1\">动态特性</div>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">轮端刚度:</span>\n                      <span className=\"font-medium\">{result.dynamics.wheelRate_N_per_mm.toFixed(2)} N/mm</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">固有频率:</span>\n                      <span className=\"font-medium\">{result.dynamics.naturalFreq_Hz.toFixed(2)} Hz</span>\n                    </div>\n                  </>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {findings.length > 0 && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg\">设计规则 / Design Rules</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-2\">\n                {findings.map((f) => (\n                  <div key={f.id} className=\"flex items-start gap-2 text-sm\">\n                    {getSeverityIcon(f.severity)}\n                    <div>\n                      <span className=\"font-medium\">{f.name}:</span>{\" \"}\n                      <span className=\"text-muted-foreground\">{f.message}</span>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Action Buttons - 工程分析和CAD出图 */}\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg\">工程工具 / Engineering Tools</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <Button \n              variant=\"outline\" \n              className=\"w-full border-sky-500/50 text-sky-400 bg-sky-500/10 hover:bg-sky-500/20 hover:border-sky-400 hover:text-sky-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-sky-500/10\"\n              onClick={() => {\n                // Save to global store before navigation\n                const geo: SuspensionGeometry = {\n                  type: \"suspensionSpring\",\n                  wireDiameter,\n                  activeCoils,\n                  totalCoils,\n                  freeLength,\n                  pitchProfile: {\n                    mode: pitchMode,\n                    pitchCenter: pitchCenter || undefined,\n                    pitchEnd: pitchEnd || undefined,\n                    endClosedTurns,\n                    transitionTurns,\n                    endType,\n                    endSpec: {\n                      type: endType,\n                      closedTurnsPerEnd: endClosedTurns,\n                      groundTurnsPerEnd: endType === \"closed_ground\" ? groundTurnsPerEnd : 0,\n                      seatDrop: 0,\n                      endAngleExtra: endType === \"closed_ground\" ? 0.25 : 0,\n                    },\n                  },\n                  diameterProfile: {\n                    mode: diameterMode,\n                    DmStart: dmStart,\n                    DmMid: dmMid,\n                    DmEnd: dmEnd,\n                  },\n                };\n                useSpringDesignStore.getState().setGeometry(geo);\n                useSpringDesignStore.getState().setMaterial({\n                  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                  id: materialPreset as any, // Suspension material IDs differ from standard spring materials\n                  name: material.name,\n                  elasticModulus: 206000, // Typical steel E\n                  shearModulus: material.shearModulus_G_MPa,\n                  tensileStrength: material.yieldStrength_MPa,\n                  density: 7850, // Steel density kg/m³\n                });\n                useSpringDesignStore.getState().setAnalysisResult({\n                  springRate: result.springRate_N_per_mm,\n                  springRateUnit: \"N/mm\",\n                  maxStress: result.stress.tauBump_MPa,\n                  staticSafetyFactor: result.stress.yieldSafetyFactor_bump,\n                });\n                window.location.href = analysisUrl;\n              }}\n            >\n              Send to Engineering Analysis / 发送到工程分析\n            </Button>\n            <Button \n              asChild \n              variant=\"outline\" \n              className=\"w-full border-violet-500/50 text-violet-400 bg-violet-500/10 hover:bg-violet-500/20 hover:border-violet-400 hover:text-violet-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-violet-500/10\"\n              disabled={result.errors.length > 0}\n            >\n              <a href={cadExportUrl}>\n                Export CAD / 导出 CAD\n              </a>\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/TorsionCalculator.tsx","messages":[{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/TorsionCalculator.tsx:290:25\n  288 |   });\n  289 |\n> 290 |   const watchedValues = form.watch();\n      |                         ^^^^ React Hook Form's `useForm()` API returns a `watch()` function which cannot be memoized safely.\n  291 |\n  292 |   // Calculate results\n  293 |   const results = useMemo((): TorsionResults | null => {","line":290,"column":25,"nodeType":null,"endLine":290,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\n/**\n * Torsion Spring Calculator\n * 扭转弹簧计算器\n * \n * Engineering formulas:\n * - Spring rate: k = E·d⁴ / (64·Dm·Na) [N·mm/°] (converted from rad)\n * - Torque: M = k·θ [N·mm]\n * - Bending stress: σ = 32·M / (π·d³) [MPa]\n * - Stress correction factor: Ki = (4C² - C - 1) / (4C(C - 1)) (inner fiber)\n */\n\nimport { useState, useMemo } from \"react\";\nimport { useForm } from \"react-hook-form\";\n\nimport { buildTorsionDesignRuleReport } from \"@/lib/designRules\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { DesignRulePanel } from \"@/components/design-rules/DesignRulePanel\";\nimport { DimensionHint } from \"./DimensionHint\";\nimport { MaterialSelector } from \"./MaterialSelector\";\nimport { Calculator3DPreview } from \"./Calculator3DPreview\";\nimport { \n  type SpringMaterialId, \n  type SpringMaterial,\n  getSpringMaterial \n} from \"@/lib/materials/springMaterials\";\nimport { \n  useSpringDesignStore,\n  type TorsionGeometry,\n  type MaterialInfo,\n  type AnalysisResult,\n  generateDesignCode,\n} from \"@/lib/stores/springDesignStore\";\n\ninterface FormValues {\n  wireDiameter: number;        // d - 线径\n  outerDiameter: number;       // Do - 外径\n  totalCoils: number;          // N - 总圈数\n  activeCoils: number;         // Na - 有效圈数\n  armLength1: number;          // a1 - 臂长1\n  armLength2: number;          // a2 - 臂长2\n  loadRadius: number;          // R - 负载作用半径\n  bodyLength: number;          // Lmo - 簧体长度\n  installAngle: number;        // θdi - 装置扭转角度\n  workingAngle: number;        // θdo - 作用扭转角度\n  pitch: number;               // p - 节距\n  handOfCoil: \"right\" | \"left\";\n}\n\ninterface TorsionResults {\n  // Geometry\n  innerDiameter: number;       // Di - 内径 mm\n  meanDiameter: number;        // Dm - 平均直径 mm\n  springIndex: number;         // C = Dm/d\n  activeCoils: number;         // Na - 有效圈数\n  rotatedLength: number;       // L - 旋转后总长度 mm\n  rotatedInnerDiameter: number; // Ds - 旋转后内径 mm\n  // Material\n  elasticModulus: number;      // E - 弹性模量 MPa\n  shearModulus: number;        // G - 剪切模量 kg/mm²\n  maxAllowableStress: number;  // Smax - 最大许用应力 Pa\n  // Rate & Torque\n  springRate: number;          // k - N·mm/° \n  springRateGmm: number;       // K - g·mm/deg\n  installTorque: number;       // M1 - 安装扭矩 N·mm\n  workingTorque: number;       // M2 - 工作扭矩 N·mm\n  installTorqueGmm: number;    // M1 - g·mm\n  workingTorqueGmm: number;    // M2 - g·mm\n  installForce: number;        // P1 - 安装力 N\n  workingForce: number;        // P2 - 工作力 N\n  installForceG: number;       // P1 - g\n  workingForceG: number;       // P2 - g\n  // Stress\n  installStress: number;       // S1 - 安装应力 kg/mm²\n  workingStress: number;       // S2 - 工作应力 kg/mm²\n  bendingStress: number;       // σ - MPa\n  correctedStress: number;     // σ_corrected - MPa with Ki factor\n  stressCorrectionFactor: number; // Ki\n  // Safety & Weight\n  safetyFactor: number;        // n\n  safetyFactorPercent: number; // SF %\n  springWeight: number;        // M - 弹簧重量 g\n  isValid: boolean;\n  warnings: string[];\n}\n\n/**\n * Calculate torsion spring properties\n * \n * @param wireDiameter d - 线径 (mm)\n * @param outerDiameter Do - 外径 (mm)\n * @param activeCoils Na - 有效圈数\n * @param installAngle θdi - 装置扭转角度 A1 (°)\n * @param workingAngle θdo - 作用扭转角度 A2 (°)\n * @param loadRadius R - 负载作用半径 (mm)\n * @param armLength1 X1 - 固定侧力臂长 (mm)\n * @param armLength2 X2 - 施力侧力臂长 (mm)\n * @param bodyLength Lmo - 簧体长度 (mm)\n * @param material - 材料\n */\nfunction calculateTorsionSpring(\n  wireDiameter: number,\n  outerDiameter: number,\n  activeCoils: number,\n  installAngle: number,\n  workingAngle: number,\n  loadRadius: number,\n  armLength1: number,\n  armLength2: number,\n  bodyLength: number,\n  material: SpringMaterial\n): TorsionResults {\n  const warnings: string[] = [];\n  \n  // Calculate diameters\n  const innerDiameter = outerDiameter - 2 * wireDiameter; // Di = Do - 2d\n  const meanDiameter = outerDiameter - wireDiameter; // Dm = Do - d\n  \n  // Spring index C = Dm / d\n  const springIndex = meanDiameter / wireDiameter;\n  \n  // Validate spring index (typical range 4-12 for torsion springs)\n  if (springIndex < 3) {\n    warnings.push(\"弹簧指数过低 (C < 3)，制造困难\");\n  } else if (springIndex > 15) {\n    warnings.push(\"弹簧指数过高 (C > 15)，弹簧可能不稳定\");\n  }\n  \n  // Material properties\n  const elasticModulus = material.elasticModulus ?? material.shearModulus * 2.5;\n  const shearModulusKg = material.shearModulus / 9.80665; // MPa to kg/mm² (1 MPa ≈ 0.102 kg/mm²)\n  const maxAllowableStress = material.allowShearStatic * 1e6; // MPa to Pa\n  \n  // Spring rate in N·mm/rad: k = E·d⁴ / (64·Dm·Na)\n  const springRateRad = (elasticModulus * Math.pow(wireDiameter, 4)) / \n                        (64 * meanDiameter * activeCoils);\n  \n  // Convert to N·mm/° (multiply by π/180)\n  const springRate = springRateRad * (Math.PI / 180);\n  \n  // Convert to g·mm/deg (1 N = 101.97 g)\n  const springRateGmm = springRate * 101.97;\n  \n  // Total angles\n  const totalAngle = installAngle + workingAngle;\n  \n  // Torques\n  const installTorque = springRate * installAngle; // N·mm\n  const workingTorque = springRate * totalAngle;   // N·mm\n  const installTorqueGmm = installTorque * 101.97; // g·mm\n  const workingTorqueGmm = workingTorque * 101.97; // g·mm\n  \n  // Forces at load radius: P = M / R\n  const installForce = loadRadius > 0 ? installTorque / loadRadius : 0; // N\n  const workingForce = loadRadius > 0 ? workingTorque / loadRadius : 0; // N\n  const installForceG = installForce * 101.97; // g\n  const workingForceG = workingForce * 101.97; // g\n  \n  // Bending stress σ = 32·M / (π·d³)\n  const installBendingStress = (32 * installTorque) / (Math.PI * Math.pow(wireDiameter, 3)); // MPa\n  const workingBendingStress = (32 * workingTorque) / (Math.PI * Math.pow(wireDiameter, 3)); // MPa\n  \n  // Convert to kg/mm² (1 MPa = 0.10197 kg/mm²)\n  const installStress = installBendingStress * 0.10197;\n  const workingStress = workingBendingStress * 0.10197;\n  \n  // Stress correction factor Ki for inner fiber (Wahl factor for torsion)\n  // Ki = (4C² - C - 1) / (4C(C - 1))\n  const stressCorrectionFactor = (4 * springIndex * springIndex - springIndex - 1) / \n                                  (4 * springIndex * (springIndex - 1));\n  \n  // Corrected stress\n  const correctedStress = workingBendingStress * stressCorrectionFactor;\n  \n  // Allowable stress for torsion (bending)\n  const allowableStress = material.allowShearStatic * 1.25;\n  \n  // Safety factor\n  const safetyFactor = allowableStress / correctedStress;\n  const safetyFactorPercent = safetyFactor * 100;\n  \n  // Rotated inner diameter: Ds = Di - (θ/360) * d * Na / Na_original\n  // When spring is wound tighter, inner diameter decreases\n  const rotatedInnerDiameter = innerDiameter - (totalAngle / 360) * wireDiameter * 0.1;\n  \n  // Rotated length: L = Lmo + additional coil compression\n  const rotatedLength = bodyLength + (totalAngle / 360) * wireDiameter * 0.5;\n  \n  // Spring weight: M = ρ × V = ρ × π × (d/2)² × L_wire\n  // L_wire = π × Dm × Na + X1 + X2\n  const density = material.density ?? 7850; // kg/m³\n  const wireLength = Math.PI * meanDiameter * activeCoils + armLength1 + armLength2; // mm\n  const wireVolume = Math.PI * Math.pow(wireDiameter / 2, 2) * wireLength; // mm³\n  const springWeight = (density / 1e6) * wireVolume; // g (density in kg/m³, volume in mm³)\n  \n  // Validation\n  if (safetyFactor < 1.0) {\n    warnings.push(\"安全系数 < 1.0，应力超过许用值\");\n  } else if (safetyFactor < 1.2) {\n    warnings.push(\"安全系数较低 (< 1.2)，建议减小变形量\");\n  }\n  \n  if (totalAngle > 360) {\n    warnings.push(\"总扭转角 > 360°，可能需要多圈\");\n  }\n  \n  return {\n    // Geometry\n    innerDiameter,\n    meanDiameter,\n    springIndex,\n    activeCoils,\n    rotatedLength,\n    rotatedInnerDiameter,\n    // Material\n    elasticModulus,\n    shearModulus: shearModulusKg,\n    maxAllowableStress,\n    // Rate & Torque\n    springRate,\n    springRateGmm,\n    installTorque,\n    workingTorque,\n    installTorqueGmm,\n    workingTorqueGmm,\n    installForce,\n    workingForce,\n    installForceG,\n    workingForceG,\n    // Stress\n    installStress,\n    workingStress,\n    bendingStress: workingBendingStress,\n    correctedStress,\n    stressCorrectionFactor,\n    // Safety & Weight\n    safetyFactor,\n    safetyFactorPercent,\n    springWeight,\n    isValid: safetyFactor >= 1.0,\n    warnings,\n  };\n}\n\nexport function TorsionCalculator() {\n  // 全局设计存储\n  const setDesign = useSpringDesignStore(state => state.setDesign);\n  const designGeometry = useSpringDesignStore(state => state.geometry);\n  const storedAnalysis = useSpringDesignStore(state => state.analysisResult);\n  const storedMaterial = useSpringDesignStore(state => state.material);\n  const lastTorsion = designGeometry && designGeometry.type === \"torsion\" ? designGeometry : null;\n\n  const lastTorsionAnalysis = lastTorsion ? storedAnalysis : null;\n\n  const designRuleReport = useMemo(() => {\n    return buildTorsionDesignRuleReport({\n      geometry: lastTorsion,\n      analysisResult: lastTorsionAnalysis,\n    });\n  }, [lastTorsion, lastTorsionAnalysis]);\n  \n  // 如果 store 里有扭簧数据，则初始化为已提交状态\n  const [submitted, setSubmitted] = useState(!!lastTorsion && !!storedAnalysis);\n  const [materialId, setMaterialId] = useState<SpringMaterialId>(\n    storedMaterial?.id ?? \"music_wire_a228\"\n  );\n\n  const form = useForm<FormValues>({\n    defaultValues: {\n      wireDiameter: lastTorsion?.wireDiameter ?? 1.5,\n      outerDiameter: lastTorsion?.outerDiameter ?? 15,\n      totalCoils: lastTorsion?.activeCoils ?? 6,\n      activeCoils: lastTorsion?.activeCoils ?? 6,\n      armLength1: lastTorsion?.legLength1 ?? 25,\n      armLength2: lastTorsion?.legLength2 ?? 25,\n      loadRadius: 20,\n      bodyLength: lastTorsion?.bodyLength ?? 10,\n      // 由上次保存的 workingAngle 反推总转角，暂时全部放在 workingAngle，installAngle 保持 0\n      installAngle: 0,\n      workingAngle: lastTorsion?.workingAngle ?? 45,\n      pitch: 1.5,\n      handOfCoil: lastTorsion?.windingDirection ?? \"right\",\n    },\n  });\n\n  const watchedValues = form.watch();\n\n  // Calculate results\n  const results = useMemo((): TorsionResults | null => {\n    if (!submitted) return null;\n    \n    const material = getSpringMaterial(materialId);\n    if (!material) return null;\n    \n    return calculateTorsionSpring(\n      watchedValues.wireDiameter ?? 1.5,\n      watchedValues.outerDiameter ?? 15,\n      watchedValues.activeCoils ?? 6,\n      watchedValues.installAngle ?? 0,\n      watchedValues.workingAngle ?? 45,\n      watchedValues.loadRadius ?? 20,\n      watchedValues.armLength1 ?? 25,\n      watchedValues.armLength2 ?? 25,\n      watchedValues.bodyLength ?? 10,\n      material\n    );\n  }, [submitted, watchedValues, materialId]);\n\n  const onSubmit = () => {\n    setSubmitted(true);\n    \n    // 保存到全局 store\n    const values = form.getValues();\n    const material = getSpringMaterial(materialId);\n    if (!material) return;\n    \n    const meanDiameter = values.outerDiameter - values.wireDiameter;\n\n    // 将安装角 θdi、工作角 θdo 映射到几何使用的 freeAngle / workingAngle\n    const thetaDi = values.installAngle ?? 0;     // 安装扭转角 θdi\n    const thetaDo = values.workingAngle ?? 0;     // 作用扭转角 θdo\n    const thetaTot = thetaDi + thetaDo;           // 自由 → 工作 总转角\n    const thetaTarget = 0;                        // 工作状态腿夹角目标（0° = 两腿平行）\n\n    const freeAngle = thetaTot + thetaTarget;     // 自由角 θf\n    const workingAngle = thetaTot;                // 总工作角\n    \n    const geometry: TorsionGeometry = {\n      type: \"torsion\",\n      wireDiameter: values.wireDiameter,\n      outerDiameter: values.outerDiameter,\n      meanDiameter,\n      activeCoils: values.activeCoils,\n      bodyLength: values.bodyLength,\n      legLength1: values.armLength1,\n      legLength2: values.armLength2,\n      windingDirection: values.handOfCoil,\n      freeAngle,\n      workingAngle,\n      shearModulus: material.shearModulus,\n      materialId: material.id,\n    };\n    \n    const materialInfo: MaterialInfo = {\n      id: material.id,\n      name: material.nameEn,\n      shearModulus: material.shearModulus,\n      elasticModulus: material.elasticModulus ?? 207000,\n      density: material.density ?? 7850,\n    };\n    \n    // 计算结果（使用 results 如果已经计算）\n    const calcResults = calculateTorsionSpring(\n      values.wireDiameter,\n      values.outerDiameter,\n      values.activeCoils,\n      values.installAngle,\n      values.workingAngle,\n      values.loadRadius,\n      values.armLength1,\n      values.armLength2,\n      values.bodyLength,\n      material\n    );\n    \n    const analysisResult: AnalysisResult = {\n      springRate: calcResults.springRate,\n      springRateUnit: \"N·mm/deg\",\n      workingLoad: calcResults.workingForce,\n      shearStress: calcResults.bendingStress,\n      maxStress: calcResults.correctedStress,\n      springIndex: calcResults.springIndex,\n      staticSafetyFactor: calcResults.safetyFactor,\n      workingDeflection: values.workingAngle,\n    };\n    \n    setDesign({\n      springType: \"torsion\",\n      geometry,\n      material: materialInfo,\n      analysisResult,\n      meta: {\n        designCode: generateDesignCode(geometry),\n      },\n    });\n  };\n\n  const handleMaterialChange = (material: SpringMaterial) => {\n    setMaterialId(material.id);\n    if (submitted) {\n      setSubmitted(false);\n      setTimeout(() => setSubmitted(true), 0);\n    }\n  };\n\n  // Generate analysis URL with all parameters\n  const analysisUrl = useMemo(() => {\n    const meanDiameter = (watchedValues.outerDiameter ?? 15) - (watchedValues.wireDiameter ?? 1.5);\n    const params = new URLSearchParams({\n      type: \"torsion\",\n      d: (watchedValues.wireDiameter ?? 1.5).toString(),\n      Dm: meanDiameter.toString(),\n      Na: (watchedValues.activeCoils ?? 6).toString(),\n      L1: (watchedValues.armLength1 ?? 25).toString(),\n      L2: (watchedValues.armLength2 ?? 25).toString(),\n      Lb: (watchedValues.bodyLength ?? 10).toString(),\n      dxMin: (watchedValues.installAngle ?? 0).toString(),\n      dxMax: ((watchedValues.installAngle ?? 0) + (watchedValues.workingAngle ?? 45)).toString(),\n      hand: watchedValues.handOfCoil ?? \"right\",\n      material: materialId,\n    });\n    return `/tools/analysis?${params.toString()}`;\n  }, [watchedValues, materialId]);\n\n  const cadExportUrl = useMemo(() => {\n    const meanDiameter = (watchedValues.outerDiameter ?? 15) - (watchedValues.wireDiameter ?? 1.5);\n    const params = new URLSearchParams({\n      type: \"torsion\",\n      d: (watchedValues.wireDiameter ?? 1.5).toString(),\n      Dm: meanDiameter.toString(),\n      Na: (watchedValues.activeCoils ?? 6).toString(),\n      L1: (watchedValues.armLength1 ?? 25).toString(),\n      L2: (watchedValues.armLength2 ?? 25).toString(),\n      Lb: (watchedValues.bodyLength ?? 10).toString(),\n      hand: watchedValues.handOfCoil ?? \"right\",\n      material: materialId,\n      k: results?.springRate?.toString() ?? \"\",\n      dx: (watchedValues.workingAngle ?? 45).toString(),\n    });\n    return `/tools/cad-export?${params.toString()}`;\n  }, [watchedValues, materialId, results]);\n\n  return (\n    <div className=\"grid gap-6 md:grid-cols-2\">\n      <div className=\"md:col-span-2\">\n        <DesignRulePanel report={designRuleReport} title=\"Design Rules / 设计规则\" />\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Input Parameters / 输入参数</CardTitle>\n          <p className=\"text-xs text-muted-foreground\">Torsion Spring / 扭转弹簧</p>\n        </CardHeader>\n        <CardContent>\n          <form className=\"space-y-4\" onSubmit={form.handleSubmit(onSubmit)}>\n            {/* Wire Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint code=\"d\" label=\"Wire Diameter\" description=\"线径，弹簧钢丝的直径。\" />\n              <Label htmlFor=\"wireDiameter\">Wire Diameter d (mm) / 线径</Label>\n              <Input id=\"wireDiameter\" type=\"number\" step=\"0.01\" {...form.register(\"wireDiameter\", { valueAsNumber: true })} />\n            </div>\n\n            {/* Outer Diameter */}\n            <div className=\"space-y-2\">\n              <DimensionHint code=\"Do\" label=\"Outer Diameter\" description=\"外径，线圈外缘到外缘。\" />\n              <Label htmlFor=\"outerDiameter\">Outer Diameter Do (mm) / 外径</Label>\n              <Input id=\"outerDiameter\" type=\"number\" step=\"0.1\" {...form.register(\"outerDiameter\", { valueAsNumber: true })} />\n            </div>\n\n            {/* Coils */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"totalCoils\">Total Coils N / 总圈数</Label>\n                <Input id=\"totalCoils\" type=\"number\" step=\"0.25\" {...form.register(\"totalCoils\", { valueAsNumber: true })} />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"activeCoils\">Active Coils Na / 有效圈数</Label>\n                <Input id=\"activeCoils\" type=\"number\" step=\"0.25\" {...form.register(\"activeCoils\", { valueAsNumber: true })} />\n              </div>\n            </div>\n\n            {/* Arm Lengths */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <DimensionHint code=\"a1\" label=\"Arm Length 1\" description=\"臂长1，第一个脚的长度。\" />\n                <Label htmlFor=\"armLength1\">Arm 1 a1 (mm) / 臂长1</Label>\n                <Input id=\"armLength1\" type=\"number\" step=\"0.1\" {...form.register(\"armLength1\", { valueAsNumber: true })} />\n              </div>\n              <div className=\"space-y-2\">\n                <DimensionHint code=\"a2\" label=\"Arm Length 2\" description=\"臂长2，第二个脚的长度。\" />\n                <Label htmlFor=\"armLength2\">Arm 2 a2 (mm) / 臂长2</Label>\n                <Input id=\"armLength2\" type=\"number\" step=\"0.1\" {...form.register(\"armLength2\", { valueAsNumber: true })} />\n              </div>\n            </div>\n\n            {/* Load Radius */}\n            <div className=\"space-y-2\">\n              <DimensionHint code=\"R\" label=\"Load Radius\" description=\"负载作用半径，力臂长度。\" />\n              <Label htmlFor=\"loadRadius\">Load Radius R (mm) / 负载作用半径</Label>\n              <Input id=\"loadRadius\" type=\"number\" step=\"0.1\" {...form.register(\"loadRadius\", { valueAsNumber: true })} />\n            </div>\n\n            {/* Body Length & Pitch */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <DimensionHint code=\"Lmo\" label=\"Body Length\" description=\"簧体长度。\" />\n                <Label htmlFor=\"bodyLength\">Body Length Lmo (mm) / 簧体长度</Label>\n                <Input id=\"bodyLength\" type=\"number\" step=\"0.1\" {...form.register(\"bodyLength\", { valueAsNumber: true })} />\n              </div>\n              <div className=\"space-y-2\">\n                <DimensionHint code=\"p\" label=\"Pitch\" description=\"节距，≥线径。\" />\n                <Label htmlFor=\"pitch\">Pitch p (mm) / 节距</Label>\n                <Input id=\"pitch\" type=\"number\" step=\"0.1\" {...form.register(\"pitch\", { valueAsNumber: true })} />\n              </div>\n            </div>\n\n            {/* Angles */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <DimensionHint code=\"θdi\" label=\"Install Angle\" description=\"装置扭转角度，初始安装时的扭转角。\" />\n                <Label htmlFor=\"installAngle\">Install Angle θdi (°) / 装置扭转角</Label>\n                <Input id=\"installAngle\" type=\"number\" step=\"1\" {...form.register(\"installAngle\", { valueAsNumber: true })} />\n              </div>\n              <div className=\"space-y-2\">\n                <DimensionHint code=\"θdo\" label=\"Working Angle\" description=\"作用扭转角度，工作时的扭转角。\" />\n                <Label htmlFor=\"workingAngle\">Working Angle θdo (°) / 作用扭转角</Label>\n                <Input id=\"workingAngle\" type=\"number\" step=\"1\" {...form.register(\"workingAngle\", { valueAsNumber: true })} />\n              </div>\n            </div>\n\n            {/* Hand of Coil */}\n            <div className=\"space-y-2\">\n              <Label>Hand of Coil / 绕向</Label>\n              <div className=\"flex gap-4\">\n                <label className=\"flex items-center gap-2 text-sm\">\n                  <input type=\"radio\" value=\"right\" {...form.register(\"handOfCoil\")} />\n                  Right Hand / 右旋\n                </label>\n                <label className=\"flex items-center gap-2 text-sm\">\n                  <input type=\"radio\" value=\"left\" {...form.register(\"handOfCoil\")} />\n                  Left Hand / 左旋\n                </label>\n              </div>\n            </div>\n\n            {/* Material Selector */}\n            <MaterialSelector\n              value={materialId}\n              onChange={handleMaterialChange}\n            />\n\n            <Button \n              type=\"submit\" \n              className=\"w-full transition-all duration-200 active:scale-95\"\n              disabled={form.formState.isSubmitting}\n            >\n              {form.formState.isSubmitting ? (\n                <>\n                  <span className=\"animate-spin mr-2\">⏳</span>\n                  Calculating... / 计算中...\n                </>\n              ) : form.formState.isSubmitSuccessful && submitted ? (\n                <>\n                  <span className=\"mr-2\">✓</span>\n                  Calculated / 已计算\n                </>\n              ) : (\n                \"Calculate / 计算\"\n              )}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-50\">\n        <CardHeader>\n          <CardTitle>Results / 计算结果</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {submitted && results ? (\n            <div className=\"space-y-4\">\n              {/* Warnings */}\n              {results.warnings.length > 0 && (\n                <div className=\"rounded-md border border-amber-500/30 bg-amber-500/10 p-3\">\n                  {results.warnings.map((warning, i) => (\n                    <p key={i} className=\"text-xs text-amber-800 dark:text-amber-200\">⚠ {warning}</p>\n                  ))}\n                </div>\n              )}\n\n              {/* Material Properties */}\n              <div className=\"space-y-2 rounded-md border border-slate-200 bg-white p-3 dark:border-slate-700 dark:bg-slate-800\">\n                <p className=\"text-xs font-medium text-slate-700 dark:text-slate-400\">Material / 材料</p>\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                  <span className=\"text-slate-600 dark:text-slate-400\">Shear Modulus G:</span>\n                  <span>{results.shearModulus.toFixed(0)} kg/mm²</span>\n                  <span className=\"text-slate-600 dark:text-slate-400\">Max Stress Smax:</span>\n                  <span>{(results.maxAllowableStress / 1e6).toFixed(0)} MPa</span>\n                </div>\n              </div>\n\n              {/* Geometry Results */}\n              <div className=\"space-y-2 rounded-md border border-slate-200 bg-white p-3 dark:border-slate-700 dark:bg-slate-800\">\n                <p className=\"text-xs font-medium text-slate-700 dark:text-slate-400\">Geometry / 几何参数</p>\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                  <span className=\"text-slate-600 dark:text-slate-400\">Na (有效圈数):</span>\n                  <span>{results.activeCoils}</span>\n                  <span className=\"text-slate-600 dark:text-slate-400\">Rotated Length L:</span>\n                  <span>{results.rotatedLength.toFixed(2)} mm</span>\n                  <span className=\"text-slate-600 dark:text-slate-400\">Rotated Inner Ds:</span>\n                  <span>{results.rotatedInnerDiameter.toFixed(2)} mm</span>\n                </div>\n              </div>\n\n              {/* Spring Rate */}\n              <div className=\"space-y-2 rounded-md border border-green-200 bg-green-50 p-3 dark:border-green-700 dark:bg-green-900/30\">\n                <p className=\"text-xs font-medium text-green-800 dark:text-green-300\">Spring Rate / 弹簧系数</p>\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                  <span className=\"text-slate-700 dark:text-slate-300\">K =</span>\n                  <span className=\"text-green-700 dark:text-green-300 font-medium\">{results.springRateGmm.toFixed(2)} g·mm/deg</span>\n                </div>\n              </div>\n\n              {/* Force & Torque */}\n              <div className=\"space-y-2 rounded-md border border-cyan-200 bg-cyan-50 p-3 dark:border-cyan-700 dark:bg-cyan-900/30\">\n                <p className=\"text-xs font-medium text-cyan-800 dark:text-cyan-300\">Force & Torque / 力与扭矩</p>\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                  <span className=\"text-slate-700 dark:text-slate-300\">P1 (作用力量):</span>\n                  <span>{results.installForceG.toFixed(2)} g</span>\n                  <span className=\"text-slate-700 dark:text-slate-300\">P2 (作用力量):</span>\n                  <span className=\"text-cyan-700 dark:text-cyan-300 font-medium\">{results.workingForceG.toFixed(2)} g</span>\n                  <span className=\"text-slate-700 dark:text-slate-300\">M1 (力矩):</span>\n                  <span>{results.installTorqueGmm.toFixed(2)} g·mm</span>\n                  <span className=\"text-slate-700 dark:text-slate-300\">M2 (力矩):</span>\n                  <span className=\"text-cyan-700 dark:text-cyan-300 font-medium\">{results.workingTorqueGmm.toFixed(2)} g·mm</span>\n                </div>\n              </div>\n\n              {/* Stress Results */}\n              <div className=\"space-y-2 rounded-md border border-blue-200 bg-blue-50 p-3 dark:border-blue-700 dark:bg-blue-900/30\">\n                <p className=\"text-xs font-medium text-blue-800 dark:text-blue-300\">Stress / 应力</p>\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                  <span className=\"text-slate-700 dark:text-slate-300\">S1 (应力):</span>\n                  <span>{results.installStress.toFixed(3)} kg/mm²</span>\n                  <span className=\"text-slate-700 dark:text-slate-300\">S2 (应力):</span>\n                  <span className=\"text-blue-700 dark:text-blue-300 font-medium\">{results.workingStress.toFixed(3)} kg/mm²</span>\n                </div>\n              </div>\n\n              {/* Safety & Weight */}\n              <div className={`space-y-2 rounded-md border p-3 ${\n                results.safetyFactor >= 1.2 \n                  ? \"border-emerald-200 bg-emerald-50 dark:border-emerald-700 dark:bg-emerald-900/30\" \n                  : results.safetyFactor >= 1.0 \n                    ? \"border-amber-200 bg-amber-50 dark:border-amber-700 dark:bg-amber-900/30\"\n                    : \"border-red-200 bg-red-50 dark:border-red-700 dark:bg-red-900/30\"\n              }`}>\n                <p className=\"text-xs font-medium text-slate-800 dark:text-slate-300\">Safety & Weight / 安全与重量</p>\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                  <span className=\"text-slate-700 dark:text-slate-300\">SF (安全率):</span>\n                  <span className={`font-bold ${\n                    results.safetyFactor >= 1.2 \n                      ? \"text-emerald-700 dark:text-emerald-400\" \n                      : results.safetyFactor >= 1.0 \n                        ? \"text-amber-700 dark:text-amber-400\"\n                        : \"text-red-700 dark:text-red-400\"\n                  }`}>\n                    {results.safetyFactorPercent.toFixed(0)} %\n                  </span>\n                  <span className=\"text-slate-700 dark:text-slate-300\">M (弹簧重量):</span>\n                  <span>{results.springWeight.toFixed(2)} g</span>\n                </div>\n              </div>\n\n              {/* Formula Reference */}\n              <div className=\"space-y-1 text-xs text-slate-600 dark:text-slate-500 border-t border-slate-200 dark:border-slate-700 pt-2\">\n                <p>K = E·d⁴ / (64·D·Na) × (π/180)</p>\n                <p>M = K·θ, P = M/R</p>\n                <p>S = 32·M / (π·d³)</p>\n              </div>\n            </div>\n          ) : (\n            <p className=\"text-sm text-slate-700 dark:text-slate-200\">\n              Input parameters and run the calculation to view results.\n              <br />\n              <span className=\"text-slate-600 dark:text-slate-400\">输入参数并点击计算，查看结果。</span>\n            </p>\n          )}\n\n          {/* Action Buttons - 统一的按钮样式（与其他计算器一致） */}\n          <div className=\"space-y-3 pt-2\">\n            {/* Generate 3D Model button hidden for now\n            <Button \n              asChild \n              className=\"w-full bg-slate-700 hover:bg-slate-600 text-white border-0 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg\"\n            >\n              <a href={analysisUrl}>Generate 3D Model / 生成3D模型</a>\n            </Button>\n            */}\n            <Button \n              asChild \n              variant=\"outline\" \n              className=\"w-full border-sky-500/50 text-sky-400 bg-sky-500/10 hover:bg-sky-500/20 hover:border-sky-400 hover:text-sky-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-sky-500/10\"\n            >\n              <a href={analysisUrl}>Send to Engineering Analysis / 发送到工程分析</a>\n            </Button>\n            <Button \n              asChild \n              variant=\"outline\" \n              className=\"w-full border-violet-500/50 text-violet-400 bg-violet-500/10 hover:bg-violet-500/20 hover:border-violet-400 hover:text-violet-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-violet-500/10\" \n              disabled={!results}\n            >\n              <a href={cadExportUrl}>Export CAD / 导出 CAD</a>\n            </Button>\n          </div>\n\n          <div className=\"pt-4 border-t border-slate-200 dark:border-slate-700\">\n            <p className=\"text-sm font-semibold text-slate-900 dark:text-slate-50\">3D Preview / 3D 预览</p>\n            <div className=\"mt-3\">\n              <Calculator3DPreview expectedType=\"torsion\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/VariablePitchAdvancedPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/VariablePitchCompressionCalculator.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'formatNumber' function makes the dependencies of useMemo Hook (at line 179) change on every render. To fix this, wrap the definition of 'formatNumber' in its own useCallback() Hook.","line":64,"column":9,"nodeType":"VariableDeclarator","endLine":64,"endColumn":84,"suggestions":[{"desc":"Wrap the definition of 'formatNumber' in its own useCallback() Hook.","fix":{"range":[2300,2360],"text":"useCallback((value: number) => Number(value.toFixed(2)).toLocaleString())"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":587,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":587,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22367,22370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22367,22370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":868,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":868,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35186,35189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35186,35189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useMemo, useState } from \"react\";\nimport { FileText, Printer, Download } from \"lucide-react\";\n\nimport {\n  calculateVariablePitchCompressionAtDeflection,\n  generateVariablePitchForceDeflectionCurve,\n  invertVariablePitchCompressionForce,\n  type VariablePitchSegment,\n} from \"@/lib/springMath\";\nimport { buildVariablePitchCompressionDesignRuleReport } from \"@/lib/designRules\";\nimport {\n  getSpringMaterial,\n  getDefaultSpringMaterial,\n  type SpringMaterial,\n} from \"@/lib/materials/springMaterials\";\n\nimport { useVariablePitchCompressionStore } from \"@/lib/stores/variablePitchCompressionStore\";\n\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DesignRulePanel } from \"@/components/design-rules/DesignRulePanel\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\n\nimport { MaterialSelector } from \"@/components/calculators/MaterialSelector\";\n\nimport {\n  VariablePitchCurvesChart,\n  type VariablePitchCurveMode,\n} from \"@/components/charts/VariablePitchCurvesChart\";\n\nimport { VariablePitchCompressionSpringVisualizer } from \"@/components/three/VariablePitchCompressionSpringVisualizer\";\nimport { VariablePitchAdvancedPanel } from \"@/components/calculators/VariablePitchAdvancedPanel\";\n\nimport { mapToVariablePitchCompressionReportPayload } from \"@/lib/reports/variablePitchCompressionReport\";\nimport {\n  downloadVariablePitchCompressionPDF,\n  printVariablePitchCompressionReport,\n} from \"@/lib/reports/variablePitchCompressionReportGenerator\";\n\nfunction ResultRow({ label, value }: { label: string; value: string }) {\n  return (\n    <div className=\"flex items-center justify-between gap-4 text-sm\">\n      <span className=\"text-muted-foreground\">{label}</span>\n      <span className=\"font-medium tabular-nums\">{value}</span>\n    </div>\n  );\n}\n\nexport function VariablePitchCompressionCalculator() {\n  const formatNumber = (value: number) => Number(value.toFixed(2)).toLocaleString();\n\n  const [showStressColors, setShowStressColors] = useState(false);\n  const [stressBeta, setStressBeta] = useState(0.25);\n\n  const wireDiameter = useVariablePitchCompressionStore((s) => s.wireDiameter);\n  const meanDiameter = useVariablePitchCompressionStore((s) => s.meanDiameter);\n  const shearModulus = useVariablePitchCompressionStore((s) => s.shearModulus);\n  const activeCoils0 = useVariablePitchCompressionStore((s) => s.activeCoils0);\n  const totalCoils = useVariablePitchCompressionStore((s) => s.totalCoils);\n  const freeLength = useVariablePitchCompressionStore((s) => s.freeLength);\n  const materialId = useVariablePitchCompressionStore((s) => s.materialId);\n  const segments = useVariablePitchCompressionStore((s) => s.segments);\n  const mode = useVariablePitchCompressionStore((s) => s.mode);\n  const deflection = useVariablePitchCompressionStore((s) => s.deflection);\n  const load = useVariablePitchCompressionStore((s) => s.load);\n  const chartModeStore = useVariablePitchCompressionStore((s) => s.chartMode);\n  const workingPoints = useVariablePitchCompressionStore((s) => s.workingPoints);\n\n  const setWireDiameter = useVariablePitchCompressionStore((s) => s.setWireDiameter);\n  const setMeanDiameter = useVariablePitchCompressionStore((s) => s.setMeanDiameter);\n  const setShearModulus = useVariablePitchCompressionStore((s) => s.setShearModulus);\n  const setActiveCoils0 = useVariablePitchCompressionStore((s) => s.setActiveCoils0);\n  const setTotalCoils = useVariablePitchCompressionStore((s) => s.setTotalCoils);\n  const setFreeLength = useVariablePitchCompressionStore((s) => s.setFreeLength);\n  const setMaterialId = useVariablePitchCompressionStore((s) => s.setMaterialId);\n  const setMode = useVariablePitchCompressionStore((s) => s.setMode);\n  const setDeflection = useVariablePitchCompressionStore((s) => s.setDeflection);\n  const setLoad = useVariablePitchCompressionStore((s) => s.setLoad);\n  const setChartMode = useVariablePitchCompressionStore((s) => s.setChartMode);\n  const setSegmentValue = useVariablePitchCompressionStore((s) => s.setSegmentValue);\n  const addSegment = useVariablePitchCompressionStore((s) => s.addSegment);\n  const removeSegment = useVariablePitchCompressionStore((s) => s.removeSegment);\n  const addWorkingPoint = useVariablePitchCompressionStore((s) => s.addWorkingPoint);\n  const setWorkingPoint = useVariablePitchCompressionStore((s) => s.setWorkingPoint);\n  const removeWorkingPoint = useVariablePitchCompressionStore((s) => s.removeWorkingPoint);\n\n  const selectedMaterial: SpringMaterial = useMemo(() => {\n    return (materialId ? getSpringMaterial(materialId) : undefined) ?? getDefaultSpringMaterial();\n  }, [materialId]);\n\n  const handleMaterialChange = (material: SpringMaterial) => {\n    setMaterialId(material.id);\n    setShearModulus(material.shearModulus);\n  };\n\n  const coilsSum = useMemo(() => {\n    return segments.reduce((acc, s) => acc + (isFinite(s.coils) ? s.coils : 0), 0);\n  }, [segments]);\n\n  const freeLengthEstimate = useMemo(() => {\n    const d = wireDiameter;\n    if (!(isFinite(d) && d > 0)) return undefined;\n\n    const dead = Math.max(0, totalCoils - activeCoils0);\n    const segmentsLen = segments.reduce((acc, s) => {\n      const n = isFinite(s.coils) ? s.coils : 0;\n      const p = isFinite(s.pitch) ? s.pitch : 0;\n      return acc + n * p;\n    }, 0);\n\n    return segmentsLen + dead * d;\n  }, [wireDiameter, totalCoils, activeCoils0, segments]);\n\n  const l0Dominant = useMemo(() => {\n    const d = wireDiameter;\n    if (!(isFinite(d) && d > 0)) {\n      return { segmentsUsed: segments, pitchGapScale: undefined as number | undefined, issue: \"\" };\n    }\n\n    if (!(freeLength !== undefined && isFinite(freeLength))) {\n      return { segmentsUsed: segments, pitchGapScale: undefined as number | undefined, issue: \"\" };\n    }\n\n    // Only scale when segments fully cover Na0.\n    if (!(isFinite(activeCoils0) && Math.abs(coilsSum - activeCoils0) <= 1e-6)) {\n      return { segmentsUsed: segments, pitchGapScale: undefined as number | undefined, issue: \"\" };\n    }\n\n    const solidHeight = totalCoils * d;\n    if (freeLength < solidHeight - 1e-9) {\n      return {\n        segmentsUsed: segments,\n        pitchGapScale: undefined as number | undefined,\n        issue: `L0 < solid height (Nt*d = ${formatNumber(solidHeight)} mm)`,\n      };\n    }\n\n    const baseGap = segments.reduce((acc, s) => {\n      const n = isFinite(s.coils) ? s.coils : 0;\n      const p = isFinite(s.pitch) ? s.pitch : 0;\n      const gap = Math.max(0, p - d);\n      return acc + n * gap;\n    }, 0);\n\n    if (!(baseGap > 1e-12)) {\n      return {\n        segmentsUsed: segments,\n        pitchGapScale: undefined as number | undefined,\n        issue: \"No positive pitch gap to scale (all pitch ≤ d)\",\n      };\n    }\n\n    const targetGap = Math.max(0, freeLength - solidHeight);\n    const pitchGapScale = targetGap / baseGap;\n\n    const segmentsUsed: VariablePitchSegment[] = segments.map((s) => {\n      const n = isFinite(s.coils) ? s.coils : 0;\n      const p = isFinite(s.pitch) ? s.pitch : 0;\n      const gap0 = Math.max(0, p - d);\n      const pEff = d + gap0 * pitchGapScale;\n      return { coils: n, pitch: pEff };\n    });\n\n    return { segmentsUsed, pitchGapScale, issue: \"\" };\n  }, [wireDiameter, freeLength, segments, activeCoils0, coilsSum, totalCoils, formatNumber]);\n\n  const variablePitchBase = useMemo(() => {\n    return {\n      wireDiameter,\n      meanDiameter,\n      shearModulus,\n      activeCoils0,\n      totalCoils,\n      freeLength,\n      segments: l0Dominant.segmentsUsed,\n    };\n  }, [\n    wireDiameter,\n    meanDiameter,\n    shearModulus,\n    activeCoils0,\n    totalCoils,\n    freeLength,\n    l0Dominant.segmentsUsed,\n  ]);\n\n  const computedDeflection = useMemo(() => {\n    if (mode !== \"load\") return undefined;\n    const inv = invertVariablePitchCompressionForce({\n      ...variablePitchBase,\n      load,\n    });\n    return inv.deflection;\n  }, [variablePitchBase, load, mode]);\n\n  const deflectionUsed = mode === \"load\" ? computedDeflection ?? 0 : deflection;\n\n  const designRuleReport = useMemo(() => {\n    return buildVariablePitchCompressionDesignRuleReport({\n      wireDiameter,\n      meanDiameter,\n      totalCoils,\n      freeLength,\n      segments: l0Dominant.segmentsUsed,\n      context: {\n        deflection: deflectionUsed,\n      },\n    });\n  }, [wireDiameter, meanDiameter, totalCoils, freeLength, l0Dominant.segmentsUsed, deflectionUsed]);\n\n  const result = useMemo(() => {\n    return calculateVariablePitchCompressionAtDeflection({\n      ...variablePitchBase,\n      deflection: deflectionUsed,\n    });\n  }, [variablePitchBase, deflectionUsed]);\n\n  const chartData = useMemo(() => {\n    const maxDeflection =\n      result.deltaMax !== undefined ? result.deltaMax : Math.max(1, deflectionUsed * 1.3);\n    const step = Math.max(0.2, maxDeflection / 40);\n    return generateVariablePitchForceDeflectionCurve({\n      ...variablePitchBase,\n      maxDeflection,\n      step,\n    });\n  }, [variablePitchBase, deflectionUsed, result.deltaMax]);\n\n  const freeLengthMismatch = useMemo(() => {\n    if (freeLengthEstimate === undefined) return undefined;\n    if (freeLength === undefined) return undefined;\n    if (!isFinite(freeLength)) return undefined;\n    return freeLength - freeLengthEstimate;\n  }, [freeLength, freeLengthEstimate]);\n\n  const coilsMismatch =\n    isFinite(activeCoils0) && Math.abs(coilsSum - activeCoils0) > 1e-6;\n\n  const issues = useMemo(() => {\n    const set = new Set<string>();\n    for (const msg of result.issues) set.add(msg);\n    if (mode === \"load\") {\n      const inv = invertVariablePitchCompressionForce({\n        ...variablePitchBase,\n        load,\n      });\n      for (const msg of inv.issues) set.add(msg);\n    }\n    return Array.from(set);\n  }, [result.issues, mode, variablePitchBase, load]);\n\n  const eventMarkers = useMemo(() => {\n    const d = wireDiameter;\n    const sorted = l0Dominant.segmentsUsed\n      .map((s, idx) => ({ idx, coils: s.coils, pitch: s.pitch }))\n      .filter((s) => isFinite(s.coils) && isFinite(s.pitch) && s.coils > 0)\n      .sort((a, b) => a.pitch - b.pitch);\n\n    let cum = 0;\n    const markers: Array<{ deflection: number; label: string; color?: string }> = [];\n    let stage = 1;\n\n    for (const s of sorted) {\n      const spacing = s.pitch - d;\n      if (!(spacing > 0)) continue;\n      const cap = s.coils * spacing;\n      if (!(cap > 0)) continue;\n      cum += cap;\n      markers.push({\n        deflection: Number(cum.toFixed(6)),\n        label: `S${stage}`,\n        color: \"#94a3b8\",\n      });\n      stage += 1;\n    }\n\n    return markers;\n  }, [wireDiameter, l0Dominant.segmentsUsed]);\n\n  const checkRows = useMemo(() => {\n    const tauAllow = selectedMaterial.allowShearStatic;\n    const deltaMax = result.deltaMax;\n\n    const points = workingPoints\n      .map((x) => Number(x))\n      .filter((x) => isFinite(x) && x >= 0)\n      .sort((a, b) => a - b);\n\n    return points.map((dx) => {\n      const res = calculateVariablePitchCompressionAtDeflection({\n        ...variablePitchBase,\n        deflection: dx,\n      });\n\n      const sf = res.shearStress > 0 ? tauAllow / res.shearStress : Infinity;\n      const overSolid = deltaMax !== undefined ? dx > deltaMax + 1e-9 : false;\n\n      let status: \"PASS\" | \"WARN\" | \"FAIL\" = \"PASS\";\n      if (overSolid || sf < 1) status = \"FAIL\";\n      else if (sf < 1.2) status = \"WARN\";\n\n      return {\n        deflection: dx,\n        load: res.load,\n        springRate: res.springRate,\n        shearStress: res.shearStress,\n        sf,\n        overSolid,\n        status,\n      };\n    });\n  }, [selectedMaterial.allowShearStatic, result.deltaMax, workingPoints, variablePitchBase]);\n\n  const reportPayload = useMemo(() => {\n    const curve = (chartData ?? []).map((p) => ({\n      deflection: p.deflection,\n      load: p.load,\n      springRate: p.springRate,\n      shearStress: p.shearStress,\n      activeCoils: p.activeCoils,\n    }));\n\n    return mapToVariablePitchCompressionReportPayload({\n      spring: {\n        wireDiameter,\n        meanDiameter,\n        freeLength,\n        totalCoils,\n        activeCoils0,\n        shearModulus,\n        materialId: selectedMaterial.id,\n        materialName: selectedMaterial.nameEn,\n      },\n      segments: l0Dominant.segmentsUsed,\n      curve,\n      workingPoint: {\n        segmentStates: result.segmentStates,\n        springIndex: result.springIndex,\n        wahlFactor: result.wahlFactor,\n        deltaMax: result.deltaMax,\n        issues: result.issues,\n      },\n    });\n  }, [\n    chartData,\n    wireDiameter,\n    meanDiameter,\n    freeLength,\n    totalCoils,\n    activeCoils0,\n    shearModulus,\n    selectedMaterial.id,\n    selectedMaterial.nameEn,\n    l0Dominant.segmentsUsed,\n    result.segmentStates,\n    result.springIndex,\n    result.wahlFactor,\n    result.deltaMax,\n    result.issues,\n  ]);\n\n  const chartMode = chartModeStore as VariablePitchCurveMode;\n\n  const setSegment = (index: number, patch: Partial<VariablePitchSegment>) => {\n    setSegmentValue(index, patch);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <DesignRulePanel report={designRuleReport} title=\"Design Rules / 设计规则\" />\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Variable Pitch Compression Spring / 变节距压缩弹簧</CardTitle>\n          <p className=\"text-xs text-muted-foreground\">\n            Progressive rate via coil-to-coil contact (engineering approximation)\n          </p>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"grid gap-6 lg:grid-cols-2\">\n            <div className=\"space-y-5\">\n              <div className=\"space-y-2\">\n                <MaterialSelector\n                  value={selectedMaterial.id}\n                  onChange={handleMaterialChange}\n                  showDetails={true}\n                />\n              </div>\n\n              <div className=\"grid gap-3 rounded-md border bg-muted/20 p-4\">\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div className=\"space-y-1\">\n                    <Label>Wire Diameter d (mm)</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.01\"\n                      min=\"0\"\n                      value={wireDiameter}\n                      onChange={(e) => setWireDiameter(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>Mean Diameter Dm (mm)</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={meanDiameter}\n                      onChange={(e) => setMeanDiameter(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div className=\"space-y-1\">\n                    <Label>Active Coils Na0</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={activeCoils0}\n                      onChange={(e) => setActiveCoils0(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>Total Coils Nt</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={totalCoils}\n                      onChange={(e) => setTotalCoils(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div className=\"space-y-1\">\n                    <Label>Shear Modulus G (MPa)</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"100\"\n                      min=\"0\"\n                      value={shearModulus}\n                      onChange={(e) => setShearModulus(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>Free Length L0 (mm)</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={freeLength ?? \"\"}\n                      onChange={(e) => {\n                        const v = e.target.value;\n                        setFreeLength(v === \"\" ? undefined : parseFloat(v) || 0);\n                      }}\n                    />\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Segments / 节距分段</Label>\n                <div className=\"rounded-md border\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead className=\"w-[180px]\">Coils Ni</TableHead>\n                        <TableHead className=\"w-[180px]\">Pitch pi (mm)</TableHead>\n                        <TableHead>Quick check</TableHead>\n                        <TableHead className=\"w-[120px]\" />\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {segments.map((seg, idx) => {\n                        const gap = seg.pitch - wireDiameter;\n                        const okPitch = gap > 0;\n                        return (\n                          <TableRow key={idx}>\n                            <TableCell>\n                              <Input\n                                type=\"number\"\n                                step=\"0.25\"\n                                min=\"0\"\n                                value={seg.coils}\n                                onChange={(e) =>\n                                  setSegment(idx, {\n                                    coils: parseFloat(e.target.value) || 0,\n                                  })\n                                }\n                              />\n                            </TableCell>\n                            <TableCell>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                min=\"0\"\n                                value={seg.pitch}\n                                onChange={(e) =>\n                                  setSegment(idx, {\n                                    pitch: parseFloat(e.target.value) || 0,\n                                  })\n                                }\n                              />\n                            </TableCell>\n                            <TableCell className=\"text-xs\">\n                              {okPitch ? (\n                                <span className=\"text-emerald-700\">pitch &gt; d (bindable)</span>\n                              ) : (\n                                <span className=\"text-amber-700\">pitch ≤ d (solid)</span>\n                              )}\n                            </TableCell>\n                            <TableCell className=\"text-right\">\n                              <Button\n                                type=\"button\"\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => removeSegment(idx)}\n                                disabled={segments.length <= 1}\n                              >\n                                Remove\n                              </Button>\n                            </TableCell>\n                          </TableRow>\n                        );\n                      })}\n                    </TableBody>\n                  </Table>\n                </div>\n\n                <div className=\"flex flex-wrap items-center justify-between gap-2\">\n                  <p className=\"text-xs text-muted-foreground\">\n                    Na0 = {formatNumber(activeCoils0)} (Nt={formatNumber(totalCoils)})\n                  </p>\n                  <Button type=\"button\" variant=\"outline\" onClick={addSegment}>\n                    Add segment\n                  </Button>\n                </div>\n\n                {coilsMismatch && (\n                  <Alert>\n                    <AlertTitle>Coils mismatch</AlertTitle>\n                    <AlertDescription>\n                      Segment coils sum = <b>{formatNumber(coilsSum)}</b>, but Na0 = <b>{formatNumber(activeCoils0)}</b>.\n                      Provide <b>Free Length</b> to auto-fill remaining coils, or adjust segments.\n                    </AlertDescription>\n                  </Alert>\n                )}\n\n                {typeof freeLengthMismatch === \"number\" &&\n                  isFinite(freeLengthMismatch) &&\n                  Math.abs(freeLengthMismatch) > 1 && (\n                    <Alert>\n                      <AlertTitle>Plausibility Check / 合理性检查</AlertTitle>\n                      <AlertDescription>\n                        L0-dominant mode: your input pitches imply L0≈<b>{formatNumber(freeLengthEstimate ?? 0)}</b> mm, but\n                        target L0=<b>{formatNumber(freeLength ?? 0)}</b> mm (Δ=<b>{formatNumber(freeLengthMismatch)}</b> mm).\n                        To satisfy L0, the tool scales pitch gaps (p-d) by\n                        {typeof l0Dominant.pitchGapScale === \"number\" && isFinite(l0Dominant.pitchGapScale)\n                          ? ` ×${formatNumber(l0Dominant.pitchGapScale)}`\n                          : \" a factor\"}\n                        and uses the scaled pitches for calculation + 3D.\n                        {l0Dominant.issue ? ` Not feasible: ${l0Dominant.issue}.` : \"\"}\n                      </AlertDescription>\n                    </Alert>\n                  )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Working condition / 工况</Label>\n                <Tabs value={mode} onValueChange={(v) => setMode(v as any)}>\n                  <TabsList className=\"w-fit\">\n                    <TabsTrigger value=\"deflection\">By deflection</TabsTrigger>\n                    <TabsTrigger value=\"load\">By load</TabsTrigger>\n                  </TabsList>\n                  <TabsContent value=\"deflection\" className=\"mt-3 space-y-2\">\n                    <Label>Deflection Δx (mm)</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={deflection}\n                      onChange={(e) => setDeflection(parseFloat(e.target.value) || 0)}\n                    />\n                  </TabsContent>\n                  <TabsContent value=\"load\" className=\"mt-3 space-y-2\">\n                    <Label>Load F (N)</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"1\"\n                      min=\"0\"\n                      value={load}\n                      onChange={(e) => setLoad(parseFloat(e.target.value) || 0)}\n                    />\n                    <p className=\"text-xs text-muted-foreground\">\n                      Solved deflection: {formatNumber(computedDeflection ?? 0)} mm\n                    </p>\n                  </TabsContent>\n                </Tabs>\n              </div>\n\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between gap-2\">\n                  <Label>Working points Δx (mm) / 多工况点</Label>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => addWorkingPoint(deflectionUsed)}\n                  >\n                    Add point\n                  </Button>\n                </div>\n                <div className=\"rounded-md border\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead className=\"w-[180px]\">Δx (mm)</TableHead>\n                        <TableHead>Result</TableHead>\n                        <TableHead className=\"w-[120px]\" />\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {workingPoints.map((dx, idx) => (\n                        <TableRow key={idx}>\n                          <TableCell>\n                            <Input\n                              type=\"number\"\n                              step=\"0.1\"\n                              min=\"0\"\n                              value={dx}\n                              onChange={(e) =>\n                                setWorkingPoint(idx, parseFloat(e.target.value) || 0)\n                              }\n                            />\n                          </TableCell>\n                          <TableCell className=\"text-xs text-muted-foreground\">\n                            τ_allow = {selectedMaterial.allowShearStatic} MPa\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <Button\n                              type=\"button\"\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => removeWorkingPoint(idx)}\n                              disabled={workingPoints.length <= 1}\n                            >\n                              Remove\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              </div>\n\n              {issues.length > 0 && (\n                <Alert variant=\"destructive\">\n                  <AlertTitle>Issues</AlertTitle>\n                  <AlertDescription>\n                    <div className=\"mt-1 space-y-1 text-xs\">\n                      {issues.map((m, i) => (\n                        <div key={i}>{m}</div>\n                      ))}\n                    </div>\n                  </AlertDescription>\n                </Alert>\n              )}\n            </div>\n\n            <div className=\"space-y-5\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>3D Preview / 三维预览</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex items-center justify-between gap-3 pb-3\">\n                    <label className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                      <input\n                        type=\"checkbox\"\n                        checked={showStressColors}\n                        onChange={(e) => setShowStressColors(e.target.checked)}\n                      />\n                      Stress Colors / 应力伪色\n                    </label>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"text-xs text-muted-foreground\">β</div>\n                      <Input\n                        type=\"number\"\n                        value={stressBeta}\n                        onChange={(e) =>\n                          setStressBeta(Math.max(0, Math.min(0.9, parseFloat(e.target.value) || 0)))\n                        }\n                        min={0}\n                        max={0.9}\n                        step={0.05}\n                        disabled={!showStressColors}\n                        className=\"h-8 w-20\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"h-[420px] w-full overflow-hidden rounded-md border bg-background\">\n                    <VariablePitchCompressionSpringVisualizer\n                      wireDiameter={wireDiameter}\n                      meanDiameter={meanDiameter}\n                      shearModulus={shearModulus}\n                      activeCoils0={activeCoils0}\n                      totalCoils={totalCoils}\n                      freeLength={freeLength}\n                      segments={l0Dominant.segmentsUsed}\n                      deflection={deflectionUsed}\n                      showStressColors={showStressColors}\n                      stressBeta={stressBeta}\n                      stressUtilization={\n                        selectedMaterial.allowShearStatic > 0\n                          ? result.shearStress / selectedMaterial.allowShearStatic\n                          : 0\n                      }\n                    />\n                  </div>\n                  <p className=\"mt-2 text-xs text-muted-foreground\">\n                    Ends are squared & ground via clipping planes; solid coils lock to Δz=d.\n                  </p>\n                  {showStressColors && (\n                    <p className=\"mt-2 text-xs text-muted-foreground\">\n                      τ={formatNumber(result.shearStress)} MPa, τ_allow={formatNumber(selectedMaterial.allowShearStatic)} MPa,\n                      utilization={\n                        selectedMaterial.allowShearStatic > 0\n                          ? formatNumber(result.shearStress / selectedMaterial.allowShearStatic)\n                          : \"-\"\n                      }\n                    </p>\n                  )}\n                </CardContent>\n              </Card>\n\n              <div className=\"flex items-center justify-end gap-2\">\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => printVariablePitchCompressionReport(reportPayload)}\n                  disabled={issues.length > 0}\n                >\n                  <Printer className=\"w-4 h-4 mr-1\" />\n                  Print Report\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => downloadVariablePitchCompressionPDF(reportPayload)}\n                  disabled={issues.length > 0}\n                >\n                  <FileText className=\"w-4 h-4 mr-1\" />\n                  Export PDF\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  asChild\n                  disabled={issues.length > 0}\n                  className=\"border-violet-500/50 text-violet-600 bg-violet-500/10 hover:bg-violet-500/20\"\n                >\n                  <a href={`/tools/cad-export?type=variablePitchCompression&d=${wireDiameter}&Dm=${meanDiameter}&Na=${activeCoils0}&L0=${freeLength}&G=${shearModulus}&mat=${materialId}`}>\n                    <Download className=\"w-4 h-4 mr-1\" />\n                    Export CAD\n                  </a>\n                </Button>\n              </div>\n\n              <div className=\"grid gap-3 rounded-md border bg-muted/20 p-4\">\n                <ResultRow label=\"Active coils Na(Δx) / 活圈\" value={formatNumber(result.activeCoils)} />\n                <ResultRow label=\"Spring rate k(Δx) (N/mm) / 刚度\" value={formatNumber(result.springRate)} />\n                <ResultRow label=\"Load F(Δx) (N) / 载荷\" value={formatNumber(result.load)} />\n                <ResultRow label=\"Shear stress τ (MPa) / 剪应力\" value={formatNumber(result.shearStress)} />\n                <ResultRow label=\"τ_allow (MPa) / 许用\" value={formatNumber(selectedMaterial.allowShearStatic)} />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Multi-point check / 多工况校核</Label>\n                <div className=\"rounded-md border\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead className=\"w-[120px]\">Δx</TableHead>\n                        <TableHead>F (N)</TableHead>\n                        <TableHead>k (N/mm)</TableHead>\n                        <TableHead>τ (MPa)</TableHead>\n                        <TableHead>SF</TableHead>\n                        <TableHead className=\"w-[110px]\">Status</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {checkRows.map((r) => (\n                        <TableRow key={r.deflection}>\n                          <TableCell>{formatNumber(r.deflection)}</TableCell>\n                          <TableCell>{formatNumber(r.load)}</TableCell>\n                          <TableCell>{formatNumber(r.springRate)}</TableCell>\n                          <TableCell>{formatNumber(r.shearStress)}</TableCell>\n                          <TableCell>{Number.isFinite(r.sf) ? formatNumber(r.sf) : \"∞\"}</TableCell>\n                          <TableCell>\n                            <Badge\n                              className={\n                                r.status === \"PASS\"\n                                  ? \"bg-green-500 text-white\"\n                                  : r.status === \"WARN\"\n                                    ? \"bg-amber-500 text-white\"\n                                    : \"bg-red-500 text-white\"\n                              }\n                            >\n                              {r.status}\n                            </Badge>\n                            {r.overSolid && (\n                              <span className=\"ml-2 text-xs text-red-600\">SOLID</span>\n                            )}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Solid / coil contact state</Label>\n                <div className=\"rounded-md border\">\n                  <div className=\"grid grid-cols-[auto_1fr_auto] gap-2 border-b bg-muted/40 px-3 py-2 text-xs font-medium text-muted-foreground\">\n                    <span>#</span>\n                    <span>Pitch</span>\n                    <span className=\"text-right\">Solid</span>\n                  </div>\n                  <div className=\"space-y-1 p-3 text-xs\">\n                    {result.segmentStates.map((st) => (\n                      <div key={st.index} className=\"grid grid-cols-[auto_1fr_auto] items-center gap-2\">\n                        <span className=\"w-6 text-muted-foreground\">{st.index + 1}</span>\n                        <span>\n                          p={formatNumber(st.pitch)} mm, Ni={formatNumber(st.coils)}\n                        </span>\n                        <span className=\"text-right\">\n                          {formatNumber(st.solidCoils)} / {formatNumber(st.coils)}\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Curves / 曲线</Label>\n                <Tabs\n                  value={chartMode}\n                  onValueChange={(v) => setChartMode(v as any)}\n                >\n                  <TabsList className=\"w-fit flex-wrap\">\n                    <TabsTrigger value=\"force\">F-Δx</TabsTrigger>\n                    <TabsTrigger value=\"stiffness\">k-Δx</TabsTrigger>\n                    <TabsTrigger value=\"stress\">τ-Δx</TabsTrigger>\n                    <TabsTrigger value=\"overlay_force_stress\">F+τ</TabsTrigger>\n                    <TabsTrigger value=\"overlay_force_stiffness\">F+k</TabsTrigger>\n                  </TabsList>\n                  <TabsContent value={chartMode} className=\"mt-3\">\n                    <div className=\"h-[340px] rounded-md border bg-background p-3\">\n                      <VariablePitchCurvesChart data={chartData} mode={chartMode} markers={eventMarkers} />\n                    </div>\n                  </TabsContent>\n                </Tabs>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <VariablePitchAdvancedPanel\n        wireDiameter={wireDiameter}\n        meanDiameter={meanDiameter}\n        shearModulus={shearModulus}\n        activeCoils={activeCoils0}\n        freeLength={freeLength}\n        segments={l0Dominant.segmentsUsed}\n        currentDeflection={deflectionUsed}\n        currentLoad={result.load}\n        currentSpringRate={result.springRate}\n        currentShearStress={result.shearStress}\n        allowableShearStress={selectedMaterial.allowShearStatic}\n      />\n    </div>\n  );\n}\n\nexport default VariablePitchCompressionCalculator;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/WaveSpringCalculator.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getDefaultWaveSpringInput' is defined but never used.","line":35,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'WaveSpringGeometry' is defined but never used.","line":38,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setMode' is assigned a value but never used.","line":78,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":78,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Wave Spring Calculator V1\n * 波形弹簧计算器 V1\n * \n * Features:\n * - Input form for wave spring geometry\n * - DesignRulePanel integration\n * - RiskRadar integration\n * - Key derived outputs: travel, k, load@Hw\n */\n\n\"use client\";\n\nimport { useMemo, useState, lazy, Suspense } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Waves, AlertTriangle, CheckCircle, XCircle } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\nimport { DesignRulePanel } from \"@/components/design-rules/DesignRulePanel\";\nimport { buildPipelineUrl } from \"@/lib/pipeline/springPipelines\";\n\nimport {\n  calculateWaveSpring,\n  getDefaultWaveSpringInput,\n  DEFAULT_WAVE_SPRING_MATERIAL,\n  type WaveSpringInput,\n  type WaveSpringGeometry,\n  type WaveSpringMode,\n} from \"@/lib/waveSpring/math\";\nimport { buildWaveSpringDesignRuleReport } from \"@/lib/designRules/waveSpringRules\";\nimport { buildWaveRiskRadar } from \"@/lib/riskRadar/builders\";\n\nconst WaveSpringVisualizer = lazy(() => import(\"@/components/three/WaveSpringVisualizer\"));\n\ninterface WaveSpringCalculatorProps {\n  isZh?: boolean;\n}\n\nfunction ResultRow({ label, value, unit }: { label: string; value: string; unit?: string }) {\n  return (\n    <div className=\"flex items-center justify-between gap-4 text-sm\">\n      <span className=\"text-muted-foreground\">{label}</span>\n      <span className=\"font-mono font-medium\">\n        {value}\n        {unit && <span className=\"ml-1 text-muted-foreground\">{unit}</span>}\n      </span>\n    </div>\n  );\n}\n\nexport function WaveSpringCalculator({ isZh = false }: WaveSpringCalculatorProps) {\n  // Geometry state\n  const [id, setId] = useState(20);\n  const [od, setOd] = useState(30);\n  const [thickness_t, setThickness] = useState(0.5);\n  const [radialWall_b, setRadialWall] = useState(4);\n  const [turns_Nt, setTurns] = useState(5);\n  const [wavesPerTurn_Nw, setWavesPerTurn] = useState(3);\n  const [freeHeight_Hf, setFreeHeight] = useState(10);\n  const [workingHeight_Hw, setWorkingHeight] = useState(7);\n\n  // Material state\n  const [materialId, setMaterialId] = useState(DEFAULT_WAVE_SPRING_MATERIAL.id);\n  const [E_MPa, setE] = useState(DEFAULT_WAVE_SPRING_MATERIAL.E_MPa);\n\n  // Mode state (for future use)\n  const [mode, setMode] = useState<WaveSpringMode>(\"loadAtWorkingHeight\");\n\n  // Build input object\n  const input = useMemo<WaveSpringInput>(() => ({\n    units: \"mm\",\n    geometry: {\n      id,\n      od,\n      thickness_t,\n      radialWall_b,\n      turns_Nt,\n      wavesPerTurn_Nw,\n      freeHeight_Hf,\n      workingHeight_Hw,\n    },\n    material: {\n      id: materialId,\n      E_MPa,\n      name: DEFAULT_WAVE_SPRING_MATERIAL.name,\n    },\n    targets: {\n      mode,\n    },\n  }), [id, od, thickness_t, radialWall_b, turns_Nt, wavesPerTurn_Nw, freeHeight_Hf, workingHeight_Hw, materialId, E_MPa, mode]);\n\n  // Calculate result\n  const result = useMemo(() => calculateWaveSpring(input), [input]);\n\n  // Design rules report\n  const designRuleReport = useMemo(() => buildWaveSpringDesignRuleReport({ input, result }), [input, result]);\n\n  // Risk radar\n  const riskRadar = useMemo(() => buildWaveRiskRadar({ input, result }), [input, result]);\n\n  // Build URLs for pipeline navigation\n  const designParams = useMemo(() => ({\n    id: String(id),\n    od: String(od),\n    t: String(thickness_t),\n    b: String(radialWall_b),\n    Nt: String(turns_Nt),\n    Nw: String(wavesPerTurn_Nw),\n    Hf: String(freeHeight_Hf),\n    Hw: String(workingHeight_Hw),\n    E: String(E_MPa),\n    material: materialId,\n  }), [id, od, thickness_t, radialWall_b, turns_Nt, wavesPerTurn_Nw, freeHeight_Hf, workingHeight_Hw, E_MPa, materialId]);\n\n  const analysisUrl = useMemo(() => \n    buildPipelineUrl(\"/tools/analysis?type=wave\", designParams), \n    [designParams]\n  );\n\n  const cadExportUrl = useMemo(() => \n    buildPipelineUrl(\"/tools/cad-export?type=wave\", designParams), \n    [designParams]\n  );\n\n  // Format number helper\n  const fmt = (n: number, decimals = 2) => {\n    if (!isFinite(n)) return \"—\";\n    return n.toFixed(decimals);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Design Rules Panel */}\n      <DesignRulePanel\n        report={designRuleReport}\n        title={isZh ? \"设计规则 / Design Rules\" : \"Design Rules\"}\n      />\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Waves className=\"w-5 h-5\" />\n            {isZh ? \"波形弹簧计算器\" : \"Wave Spring Calculator\"}\n            <Badge variant=\"outline\" className=\"ml-2\">V1</Badge>\n          </CardTitle>\n          <p className=\"text-xs text-muted-foreground\">\n            {isZh\n              ? \"轴向承载，超薄安装高度 / Crest-to-crest wave spring\"\n              : \"Axial load, ultra-low height / Crest-to-crest wave spring\"}\n          </p>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"grid gap-6 lg:grid-cols-2\">\n            {/* Left: Input Form */}\n            <div className=\"space-y-5\">\n              {/* Geometry Section */}\n              <div className=\"space-y-3\">\n                <h3 className=\"text-sm font-medium\">\n                  {isZh ? \"几何参数\" : \"Geometry\"}\n                </h3>\n                <div className=\"grid grid-cols-2 gap-3 rounded-md border bg-muted/20 p-4\">\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"内径 ID (mm)\" : \"Inner Diameter ID (mm)\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={id}\n                      onChange={(e) => setId(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"外径 OD (mm)\" : \"Outer Diameter OD (mm)\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={od}\n                      onChange={(e) => setOd(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"厚度 t (mm)\" : \"Thickness t (mm)\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.01\"\n                      min=\"0\"\n                      value={thickness_t}\n                      onChange={(e) => setThickness(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"径向壁宽 b (mm)\" : \"Radial Wall b (mm)\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={radialWall_b}\n                      onChange={(e) => setRadialWall(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"圈数 Nt\" : \"Turns Nt\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"1\"\n                      min=\"1\"\n                      value={turns_Nt}\n                      onChange={(e) => setTurns(parseFloat(e.target.value) || 1)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"每圈波数 Nw\" : \"Waves/Turn Nw\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"1\"\n                      min=\"1\"\n                      value={wavesPerTurn_Nw}\n                      onChange={(e) => setWavesPerTurn(parseFloat(e.target.value) || 1)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"自由高度 Hf (mm)\" : \"Free Height Hf (mm)\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={freeHeight_Hf}\n                      onChange={(e) => setFreeHeight(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"工作高度 Hw (mm)\" : \"Working Height Hw (mm)\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"0.1\"\n                      min=\"0\"\n                      value={workingHeight_Hw}\n                      onChange={(e) => setWorkingHeight(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                </div>\n              </div>\n\n              {/* Material Section */}\n              <div className=\"space-y-3\">\n                <h3 className=\"text-sm font-medium\">\n                  {isZh ? \"材料\" : \"Material\"}\n                </h3>\n                <div className=\"grid grid-cols-2 gap-3 rounded-md border bg-muted/20 p-4\">\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"材料\" : \"Material\"}</Label>\n                    <Select value={materialId} onValueChange={setMaterialId}>\n                      <SelectTrigger>\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"17-7PH\">17-7PH Stainless Steel</SelectItem>\n                        <SelectItem value=\"302SS\">302 Stainless Steel</SelectItem>\n                        <SelectItem value=\"Inconel\">Inconel X-750</SelectItem>\n                        <SelectItem value=\"BeCu\">Beryllium Copper</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"space-y-1\">\n                    <Label>{isZh ? \"弹性模量 E (MPa)\" : \"Elastic Modulus E (MPa)\"}</Label>\n                    <Input\n                      type=\"number\"\n                      step=\"1000\"\n                      min=\"0\"\n                      value={E_MPa}\n                      onChange={(e) => setE(parseFloat(e.target.value) || 0)}\n                    />\n                  </div>\n                </div>\n              </div>\n\n              {/* Errors and Warnings */}\n              {result.errors.length > 0 && (\n                <Alert variant=\"destructive\">\n                  <XCircle className=\"w-4 h-4\" />\n                  <AlertTitle>{isZh ? \"错误\" : \"Errors\"}</AlertTitle>\n                  <AlertDescription>\n                    <ul className=\"mt-1 space-y-1 text-xs\">\n                      {result.errors.map((err, i) => (\n                        <li key={i}>• {err}</li>\n                      ))}\n                    </ul>\n                  </AlertDescription>\n                </Alert>\n              )}\n\n              {result.warnings.length > 0 && (\n                <Alert>\n                  <AlertTriangle className=\"w-4 h-4\" />\n                  <AlertTitle>{isZh ? \"警告\" : \"Warnings\"}</AlertTitle>\n                  <AlertDescription>\n                    <ul className=\"mt-1 space-y-1 text-xs\">\n                      {result.warnings.map((warn, i) => (\n                        <li key={i}>• {warn}</li>\n                      ))}\n                    </ul>\n                  </AlertDescription>\n                </Alert>\n              )}\n\n              {/* V2 Placeholder */}\n              <div className=\"rounded-md border border-dashed p-3 text-center text-xs text-muted-foreground\">\n                {isZh\n                  ? \"V2 预留：子类型选择（波形垫圈 / 多圈嵌套）\"\n                  : \"V2 Reserved: Subtype selection (wave washer / multi-turn nested)\"}\n              </div>\n\n              {/* Action Buttons - 工程分析和CAD出图 */}\n              <div className=\"space-y-3 pt-4 border-t\">\n                <Button \n                  asChild \n                  variant=\"outline\" \n                  className=\"w-full border-sky-500/50 text-sky-400 bg-sky-500/10 hover:bg-sky-500/20 hover:border-sky-400 hover:text-sky-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-sky-500/10\"\n                >\n                  <a href={analysisUrl}>\n                    {isZh ? \"发送到工程分析 / Engineering Analysis\" : \"Send to Engineering Analysis / 发送到工程分析\"}\n                  </a>\n                </Button>\n                <Button \n                  asChild \n                  variant=\"outline\" \n                  className=\"w-full border-violet-500/50 text-violet-400 bg-violet-500/10 hover:bg-violet-500/20 hover:border-violet-400 hover:text-violet-300 transition-all duration-200 hover:scale-[1.02] hover:shadow-lg hover:shadow-violet-500/10\"\n                  disabled={!result.isValid}\n                >\n                  <a href={cadExportUrl}>\n                    {isZh ? \"导出 CAD / Export CAD\" : \"Export CAD / 导出 CAD\"}\n                  </a>\n                </Button>\n              </div>\n            </div>\n\n            {/* Right: Results and Risk Radar */}\n            <div className=\"space-y-5\">\n              {/* Key Results */}\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    {result.isValid ? (\n                      <CheckCircle className=\"w-4 h-4 text-green-600\" />\n                    ) : (\n                      <XCircle className=\"w-4 h-4 text-red-600\" />\n                    )}\n                    {isZh ? \"计算结果\" : \"Results\"}\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <ResultRow\n                    label={isZh ? \"行程 (Hf - Hw)\" : \"Travel (Hf - Hw)\"}\n                    value={fmt(result.travel_mm)}\n                    unit=\"mm\"\n                  />\n                  <ResultRow\n                    label={isZh ? \"刚度 k\" : \"Spring Rate k\"}\n                    value={fmt(result.springRate_Nmm, 3)}\n                    unit=\"N/mm\"\n                  />\n                  <ResultRow\n                    label={isZh ? \"工作高度载荷\" : \"Load @ Hw\"}\n                    value={fmt(result.loadAtWorkingHeight_N)}\n                    unit=\"N\"\n                  />\n                  <div className=\"border-t pt-3 mt-3\">\n                    <ResultRow\n                      label={isZh ? \"中径 Dm\" : \"Mean Diameter Dm\"}\n                      value={fmt(result.meanDiameter_mm)}\n                      unit=\"mm\"\n                    />\n                    <ResultRow\n                      label={isZh ? \"波幅\" : \"Wave Amplitude\"}\n                      value={fmt(result.waveAmplitude_mm, 3)}\n                      unit=\"mm\"\n                    />\n                    <ResultRow\n                      label={isZh ? \"总波数\" : \"Total Waves\"}\n                      value={result.totalWaves.toString()}\n                    />\n                    <ResultRow\n                      label={isZh ? \"最大应力 σ\" : \"Max Stress σ\"}\n                      value={fmt(result.stressMax_MPa, 1)}\n                      unit=\"MPa\"\n                    />\n                  </div>\n                </CardContent>\n              </Card>\n\n              {/* 3D Preview */}\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base\">\n                    {isZh ? \"3D 预览\" : \"3D Preview\"}\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"h-[300px] rounded-md border bg-slate-50\">\n                    <Suspense fallback={\n                      <div className=\"flex h-full items-center justify-center text-muted-foreground\">\n                        {isZh ? \"加载中...\" : \"Loading...\"}\n                      </div>\n                    }>\n                      <WaveSpringVisualizer\n                        meanDiameter={result.meanDiameter_mm}\n                        thickness={thickness_t}\n                        width={radialWall_b}\n                        amplitude={result.waveAmplitude_mm}\n                        waves={wavesPerTurn_Nw}\n                        turns={turns_Nt}\n                        phase={0}\n                        color=\"#6b9bd1\"\n                      />\n                    </Suspense>\n                  </div>\n                </CardContent>\n              </Card>\n\n              {/* Risk Radar Summary */}\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-base\">\n                    {isZh ? \"风险雷达\" : \"Risk Radar\"}\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">\n                      {isZh ? \"总体状态\" : \"Overall Status\"}\n                    </span>\n                    <Badge\n                      className={\n                        riskRadar.overallStatus === \"ENGINEERING_OK\"\n                          ? \"bg-green-600\"\n                          : riskRadar.overallStatus === \"MANUFACTURING_RISK\"\n                          ? \"bg-yellow-500 text-black\"\n                          : \"bg-red-600\"\n                      }\n                    >\n                      {riskRadar.overallStatus === \"ENGINEERING_OK\"\n                        ? isZh ? \"工程通过\" : \"OK\"\n                        : riskRadar.overallStatus === \"MANUFACTURING_RISK\"\n                        ? isZh ? \"制造风险\" : \"Mfg Risk\"\n                        : isZh ? \"高风险\" : \"High Risk\"}\n                    </Badge>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-2 text-center text-xs\">\n                    <div className=\"rounded border p-2\">\n                      <div className=\"text-muted-foreground\">{isZh ? \"工程\" : \"Eng\"}</div>\n                      <Badge\n                        variant=\"outline\"\n                        className={\n                          riskRadar.dimensions.engineering.status === \"OK\"\n                            ? \"border-green-500 text-green-600\"\n                            : riskRadar.dimensions.engineering.status === \"WARN\"\n                            ? \"border-yellow-500 text-yellow-600\"\n                            : \"border-red-500 text-red-600\"\n                        }\n                      >\n                        {riskRadar.dimensions.engineering.status}\n                      </Badge>\n                    </div>\n                    <div className=\"rounded border p-2\">\n                      <div className=\"text-muted-foreground\">{isZh ? \"制造\" : \"Mfg\"}</div>\n                      <Badge\n                        variant=\"outline\"\n                        className={\n                          riskRadar.dimensions.manufacturing.status === \"OK\"\n                            ? \"border-green-500 text-green-600\"\n                            : riskRadar.dimensions.manufacturing.status === \"WARN\"\n                            ? \"border-yellow-500 text-yellow-600\"\n                            : \"border-red-500 text-red-600\"\n                        }\n                      >\n                        {riskRadar.dimensions.manufacturing.status}\n                      </Badge>\n                    </div>\n                    <div className=\"rounded border p-2\">\n                      <div className=\"text-muted-foreground\">{isZh ? \"质量\" : \"Quality\"}</div>\n                      <Badge\n                        variant=\"outline\"\n                        className={\n                          riskRadar.dimensions.quality.status === \"OK\"\n                            ? \"border-green-500 text-green-600\"\n                            : riskRadar.dimensions.quality.status === \"WARN\"\n                            ? \"border-yellow-500 text-yellow-600\"\n                            : \"border-red-500 text-red-600\"\n                        }\n                      >\n                        {riskRadar.dimensions.quality.status}\n                      </Badge>\n                    </div>\n                  </div>\n                  {riskRadar.findings.length > 0 && (\n                    <div className=\"mt-2 space-y-1 text-xs\">\n                      {riskRadar.findings.slice(0, 3).map((f, i) => (\n                        <div key={i} className=\"flex items-start gap-2\">\n                          <Badge\n                            variant=\"outline\"\n                            className={\n                              f.level === \"ERROR\"\n                                ? \"border-red-500 text-red-600\"\n                                : f.level === \"WARNING\"\n                                ? \"border-yellow-500 text-yellow-600\"\n                                : \"border-blue-500 text-blue-600\"\n                            }\n                          >\n                            {f.level}\n                          </Badge>\n                          <span>{isZh ? f.title.zh : f.title.en}</span>\n                        </div>\n                      ))}\n                      {riskRadar.findings.length > 3 && (\n                        <div className=\"text-muted-foreground\">\n                          +{riskRadar.findings.length - 3} {isZh ? \"更多\" : \"more\"}\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nexport default WaveSpringCalculator;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/shared/SpringActionButtons.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/shared/SpringResultCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'springType' is defined but never used.","line":58,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":58,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\nimport type { SpringType } from \"@/lib/springTypes\";\nimport type { SafetyFactorResult } from \"@/lib/springMath\";\n\ninterface ResultRowProps {\n  label: string;\n  value: string | number;\n  unit?: string;\n  highlight?: boolean;\n  status?: \"safe\" | \"warning\" | \"danger\";\n}\n\n/**\n * Single result row with label and value\n */\nexport function ResultRow({ label, value, unit, highlight, status }: ResultRowProps) {\n  const statusColors = {\n    safe: \"text-emerald-700 dark:text-emerald-400\",\n    warning: \"text-amber-700 dark:text-amber-400\",\n    danger: \"text-red-700 dark:text-red-400\",\n  };\n\n  return (\n    <div className=\"flex items-center justify-between text-sm\">\n      <span className={cn(\"text-slate-700 dark:text-slate-300\", highlight && \"font-medium\")}>{label}</span>\n      <span className={cn(\n        \"font-semibold\",\n        status ? statusColors[status] : \"text-slate-900 dark:text-slate-50\",\n        highlight && \"text-emerald-700 dark:text-emerald-400\"\n      )}>\n        {typeof value === \"number\" ? value.toLocaleString(undefined, { maximumFractionDigits: 2 }) : value}\n        {unit && <span className=\"ml-1 text-slate-500 dark:text-slate-400 font-normal\">{unit}</span>}\n      </span>\n    </div>\n  );\n}\n\ninterface SpringResultCardProps {\n  title?: string;\n  subtitle?: string;\n  springType: SpringType;\n  children: React.ReactNode;\n  className?: string;\n  safetyFactor?: SafetyFactorResult;\n}\n\n/**\n * Unified result card for all spring calculators\n * 所有弹簧计算器的统一结果卡片\n */\nexport function SpringResultCard({\n  title = \"Results / 计算结果\",\n  subtitle,\n  springType,\n  children,\n  className,\n  safetyFactor,\n}: SpringResultCardProps) {\n  const getSafetyBadge = () => {\n    if (!safetyFactor) return null;\n    \n    const colors = {\n      safe: \"bg-green-500\",\n      warning: \"bg-amber-500\",\n      danger: \"bg-red-500\",\n    };\n\n    return (\n      <Badge className={cn(\"text-white text-xs\", colors[safetyFactor.status])}>\n        SF = {safetyFactor.sfStatic.toFixed(2)}\n      </Badge>\n    );\n  };\n\n  return (\n    <Card className={cn(className)}>\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"text-lg\">{title}</CardTitle>\n            {subtitle && (\n              <p className=\"text-xs text-slate-600 dark:text-slate-400 mt-1\">{subtitle}</p>\n            )}\n          </div>\n          {getSafetyBadge()}\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {children}\n      </CardContent>\n    </Card>\n  );\n}\n\ninterface ResultSectionProps {\n  title: string;\n  children: React.ReactNode;\n  className?: string;\n}\n\n/**\n * Section within a result card\n */\nexport function ResultSection({ title, children, className }: ResultSectionProps) {\n  return (\n    <div className={cn(\"space-y-2\", className)}>\n      <h4 className=\"text-xs font-medium text-slate-700 dark:text-slate-400 uppercase tracking-wide\">\n        {title}\n      </h4>\n      <div className=\"space-y-1\">\n        {children}\n      </div>\n    </div>\n  );\n}\n\ninterface EmptyResultProps {\n  message?: string;\n  messageZh?: string;\n}\n\n/**\n * Empty state for result card\n */\nexport function EmptyResult({ \n  message = \"Input parameters and run the calculation to view results.\",\n  messageZh = \"输入参数并点击计算，查看结果。\"\n}: EmptyResultProps) {\n  return (\n    <p className=\"text-sm text-slate-700 dark:text-slate-200\">\n      {message}\n      <br />\n      <span className=\"text-slate-600 dark:text-slate-400\">{messageZh}</span>\n    </p>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/calculators/shared/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/CurrentPointCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/ForceDeflectionChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/ForceDeflectionChart.tsx:28:5\n  26 |\n  27 |   useEffect(() => {\n> 28 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  29 |   }, []);\n  30 |\n  31 |   if (!mounted) {","line":28,"column":5,"nodeType":null,"endLine":28,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\n import { useEffect, useState } from \"react\";\n\nimport {\n  ResponsiveContainer,\n  LineChart,\n  CartesianGrid,\n  XAxis,\n  YAxis,\n  Tooltip,\n  Line,\n} from \"recharts\";\n\nexport interface ForceDeflectionPoint {\n  deflection: number;\n  load: number;\n}\n\ninterface Props {\n  data: ForceDeflectionPoint[];\n}\n\nexport function ForceDeflectionChart({ data }: Props) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  if (!mounted) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n        Loading chart...\n      </div>\n    );\n  }\n\n  if (data.length === 0) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n        No data yet. Generate a curve to see the chart.\n      </div>\n    );\n  }\n\n  return (\n    <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <LineChart data={data} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>\n        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n        <XAxis\n          dataKey=\"deflection\"\n          label={{ value: \"Deflection (mm)\", position: \"insideBottom\", offset: -10 }}\n          tick={{ fontSize: 12 }}\n          stroke=\"#64748b\"\n        />\n        <YAxis\n          dataKey=\"load\"\n          label={{ value: \"Force (N)\", angle: -90, position: \"insideLeft\", offset: 10 }}\n          tick={{ fontSize: 12 }}\n          stroke=\"#64748b\"\n        />\n        <Tooltip\n          contentStyle={{\n            backgroundColor: \"#fff\",\n            border: \"1px solid #e2e8f0\",\n            borderRadius: \"6px\",\n            fontSize: \"12px\",\n          }}\n          formatter={(value: number) => [`${value.toFixed(2)} N`, \"Force\"]}\n          labelFormatter={(label: number) => `Deflection: ${label.toFixed(2)} mm`}\n        />\n        <Line\n          type=\"monotone\"\n          dataKey=\"load\"\n          stroke=\"#3b82f6\"\n          strokeWidth={2}\n          dot={false}\n          activeDot={{ r: 4, fill: \"#3b82f6\" }}\n        />\n      </LineChart>\n    </ResponsiveContainer>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/GoodmanChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/GoodmanChart.tsx:43:5\n  41 |\n  42 |   useEffect(() => {\n> 43 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  44 |   }, []);\n  45 |\n  46 |   const chartData = useMemo(() => {","line":43,"column":5,"nodeType":null,"endLine":43,"endColumn":15},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/GoodmanChart.tsx:175:30\n  173 |           />\n  174 |\n> 175 |           <Tooltip content={<CustomTooltip />} />\n      |                              ^^^^^^^^^^^^^ This component is created during render\n  176 |\n  177 |           <Line\n  178 |             type={criterion === \"gerber\" ? \"monotone\" : \"linear\"}\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/GoodmanChart.tsx:104:25\n  102 |   const yMax = Math.max(limitYMax, sigmaA, 1);\n  103 |\n> 104 |   const CustomTooltip = ({\n      |                         ^^\n> 105 |     active,\n      | ^^^^^^^^^^^\n> 106 |     payload,\n      …\n      | ^^^^^^^^^^^\n> 120 |     return null;\n      | ^^^^^^^^^^^\n> 121 |   };\n      | ^^^^ The component is created during render here\n  122 |\n  123 |   const utilization = (() => {\n  124 |     if (!Se || !isFinite(Se) || Se <= 0) return null;","line":175,"column":30,"nodeType":null,"endLine":175,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport {\n  CartesianGrid,\n  Line,\n  LineChart,\n  ReferenceDot,\n  ReferenceLine,\n  ResponsiveContainer,\n  Tooltip,\n  XAxis,\n  YAxis,\n} from \"recharts\";\nimport { useLanguage } from \"@/components/language-context\";\n\nexport type MeanStressFatigueCriterion = \"goodman\" | \"gerber\" | \"soderberg\";\n\ninterface GoodmanChartProps {\n  sigmaA: number;\n  sigmaM: number;\n  Se: number | null;\n  Su: number | null;\n  Sy?: number | null;\n  criterion?: MeanStressFatigueCriterion;\n  height?: number;\n}\n\nexport function GoodmanChart({\n  sigmaA,\n  sigmaM,\n  Se,\n  Su,\n  Sy = null,\n  criterion = \"goodman\",\n  height = 320,\n}: GoodmanChartProps) {\n  const [mounted, setMounted] = useState(false);\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const chartData = useMemo(() => {\n    if (!Se || !isFinite(Se) || Se <= 0) return [];\n\n    if (criterion === \"soderberg\") {\n      if (!Sy || !isFinite(Sy) || Sy <= 0) return [];\n      return [\n        { sigmaM: 0, sigmaA: Se },\n        { sigmaM: Sy, sigmaA: 0 },\n      ];\n    }\n\n    if (!Su || !isFinite(Su) || Su <= 0) return [];\n\n    if (criterion === \"gerber\") {\n      const n = 60;\n      const pts: Array<{ sigmaM: number; sigmaA: number }> = [];\n      for (let i = 0; i <= n; i++) {\n        const x = (i / n) * Su;\n        const y = Se * (1 - Math.pow(x / Su, 2));\n        pts.push({ sigmaM: x, sigmaA: Math.max(0, y) });\n      }\n      return pts;\n    }\n\n    // goodman\n    return [\n      { sigmaM: 0, sigmaA: Se },\n      { sigmaM: Su, sigmaA: 0 },\n    ];\n  }, [Se, Su, Sy, criterion]);\n\n  if (!mounted) {\n    return (\n      <div className=\"w-full flex items-center justify-center text-muted-foreground text-sm\" style={{ height }}>\n        Loading chart...\n      </div>\n    );\n  }\n\n  if (chartData.length === 0) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        {criterion === \"soderberg\"\n          ? isZh\n            ? \"缺少 Sy/Se，无法绘制 Soderberg 图\"\n            : \"Missing Sy/Se; cannot draw Soderberg chart\"\n          : isZh\n            ? \"缺少 Su/Se，无法绘制疲劳图\"\n            : \"Missing Su/Se; cannot draw fatigue chart\"}\n      </div>\n    );\n  }\n\n  const limitXMax = chartData.length ? Math.max(...chartData.map((p) => p.sigmaM)) : 0;\n  const limitYMax = chartData.length ? Math.max(...chartData.map((p) => p.sigmaA)) : 0;\n  const xMax = Math.max(limitXMax, sigmaM, 1);\n  const yMax = Math.max(limitYMax, sigmaA, 1);\n\n  const CustomTooltip = ({\n    active,\n    payload,\n  }: {\n    active?: boolean;\n    payload?: Array<{ payload: { sigmaM: number; sigmaA: number } }>;\n  }) => {\n    if (active && payload && payload.length) {\n      const p = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <p className=\"font-medium\">σ_m = {p.sigmaM.toFixed(1)} MPa</p>\n          <p className=\"text-slate-700\">σ_a = {p.sigmaA.toFixed(1)} MPa</p>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  const utilization = (() => {\n    if (!Se || !isFinite(Se) || Se <= 0) return null;\n    if (criterion === \"soderberg\") {\n      if (!Sy || !isFinite(Sy) || Sy <= 0) return null;\n      return sigmaA / Se + sigmaM / Sy;\n    }\n    if (!Su || !isFinite(Su) || Su <= 0) return null;\n    if (criterion === \"gerber\") return sigmaA / Se + Math.pow(sigmaM / Su, 2);\n    return sigmaA / Se + sigmaM / Su;\n  })();\n\n  const isSafe = utilization !== null ? utilization <= 1 : null;\n\n  const criterionLabel =\n    criterion === \"gerber\"\n      ? \"Gerber\"\n      : criterion === \"soderberg\"\n        ? \"Soderberg\"\n        : \"Goodman\";\n\n  return (\n    <div className=\"w-full\" style={{ height }}>\n      <ResponsiveContainer width=\"100%\" height=\"100%\">\n        <LineChart data={chartData} margin={{ top: 10, right: 22, left: 10, bottom: 30 }}>\n          <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n\n          <XAxis\n            dataKey=\"sigmaM\"\n            type=\"number\"\n            domain={[0, xMax * 1.05]}\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"平均应力 σ_m (MPa)\" : \"Mean stress σ_m (MPa)\",\n              position: \"bottom\",\n              offset: 15,\n              fontSize: 12,\n            }}\n          />\n          <YAxis\n            dataKey=\"sigmaA\"\n            type=\"number\"\n            domain={[0, yMax * 1.05]}\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"应力幅值 σ_a (MPa)\" : \"Stress amplitude σ_a (MPa)\",\n              angle: -90,\n              position: \"insideLeft\",\n              offset: 10,\n              fontSize: 12,\n            }}\n          />\n\n          <Tooltip content={<CustomTooltip />} />\n\n          <Line\n            type={criterion === \"gerber\" ? \"monotone\" : \"linear\"}\n            dataKey=\"sigmaA\"\n            stroke=\"#8b5cf6\"\n            strokeWidth={2}\n            dot={false}\n            name={criterionLabel}\n          />\n\n          <ReferenceLine x={0} stroke=\"#94a3b8\" strokeOpacity={0.4} />\n          <ReferenceLine y={0} stroke=\"#94a3b8\" strokeOpacity={0.4} />\n\n          <ReferenceDot\n            x={sigmaM}\n            y={sigmaA}\n            r={6}\n            fill={isSafe === null ? \"#64748b\" : isSafe ? \"#22c55e\" : \"#f59e0b\"}\n            stroke=\"#fff\"\n            strokeWidth={2}\n          />\n        </LineChart>\n      </ResponsiveContainer>\n\n      <div className=\"flex items-center justify-center gap-6 mt-2 text-xs\">\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5\" style={{ backgroundColor: \"#8b5cf6\" }} />\n          <span>\n            {isZh ? `${criterionLabel} 极限线` : `${criterionLabel} limit`}\n          </span>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <div\n            className=\"w-3 h-3 rounded-full\"\n            style={{ backgroundColor: isSafe === null ? \"#64748b\" : isSafe ? \"#22c55e\" : \"#f59e0b\" }}\n          />\n          <span>{isZh ? \"当前点\" : \"Current\"}</span>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/InteractiveForceChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/InteractiveForceChart.tsx:68:5\n  66 |\n  67 |   useEffect(() => {\n> 68 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  69 |   }, []);\n  70 |\n  71 |   const currentPoint = useMemo(","line":68,"column":5,"nodeType":null,"endLine":68,"endColumn":15}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":97,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2329,2332],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2329,2332],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport {\n  ResponsiveContainer,\n  LineChart,\n  CartesianGrid,\n  XAxis,\n  YAxis,\n  Tooltip,\n  Line,\n  ReferenceLine,\n  ReferenceDot,\n} from \"recharts\";\n\nexport interface ForceDeflectionPoint {\n  deflection: number;\n  load: number;\n}\n\ninterface InteractiveForceChartProps {\n  data: ForceDeflectionPoint[];\n  currentDeflection: number;\n  onDeflectionChange?: (deflection: number) => void;\n  xAxisLabel?: string;\n  yAxisLabel?: string;\n  lineColor?: string;\n  markerColor?: string;\n  showMarker?: boolean;\n}\n\n/**\n * Find the nearest point in the data array to the target deflection.\n */\nexport function findNearestPoint(\n  data: ForceDeflectionPoint[],\n  targetDeflection: number\n): ForceDeflectionPoint | null {\n  if (data.length === 0) return null;\n\n  let nearest = data[0];\n  let minDiff = Math.abs(data[0].deflection - targetDeflection);\n\n  for (const point of data) {\n    const diff = Math.abs(point.deflection - targetDeflection);\n    if (diff < minDiff) {\n      minDiff = diff;\n      nearest = point;\n    }\n  }\n\n  return nearest;\n}\n\nexport function InteractiveForceChart({\n  data,\n  currentDeflection,\n  onDeflectionChange,\n  xAxisLabel = \"Deflection (mm)\",\n  yAxisLabel = \"Force (N)\",\n  lineColor = \"#3b82f6\",\n  markerColor = \"#ef4444\",\n  showMarker = true,\n}: InteractiveForceChartProps) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const currentPoint = useMemo(\n    () => findNearestPoint(data, currentDeflection),\n    [data, currentDeflection]\n  );\n\n  if (!mounted) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n        Loading chart...\n        <br />\n        <span className=\"text-xs\">图表加载中...</span>\n      </div>\n    );\n  }\n\n  if (data.length === 0) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n        No data yet. Generate a curve to see the chart.\n        <br />\n        <span className=\"text-xs\">暂无数据，请生成曲线。</span>\n      </div>\n    );\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const handleChartClick = (e: any) => {\n    if (e?.activePayload && e.activePayload.length > 0 && onDeflectionChange) {\n      const clickedPoint = e.activePayload[0].payload as ForceDeflectionPoint;\n      onDeflectionChange(clickedPoint.deflection);\n    }\n  };\n\n  return (\n    <ResponsiveContainer width=\"100%\" height=\"100%\">\n      <LineChart\n        data={data}\n        margin={{ top: 20, right: 30, left: 20, bottom: 20 }}\n        onClick={handleChartClick}\n      >\n        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n        <XAxis\n          dataKey=\"deflection\"\n          label={{ value: xAxisLabel, position: \"insideBottom\", offset: -10 }}\n          tick={{ fontSize: 12 }}\n          stroke=\"#64748b\"\n        />\n        <YAxis\n          dataKey=\"load\"\n          label={{ value: yAxisLabel, angle: -90, position: \"insideLeft\", offset: 10 }}\n          tick={{ fontSize: 12 }}\n          stroke=\"#64748b\"\n        />\n        <Tooltip\n          contentStyle={{\n            backgroundColor: \"#fff\",\n            border: \"1px solid #e2e8f0\",\n            borderRadius: \"6px\",\n            fontSize: \"12px\",\n          }}\n          formatter={(value: number) => [`${value.toFixed(2)} N`, \"Force\"]}\n          labelFormatter={(label: number) => `Deflection: ${label.toFixed(2)} mm`}\n        />\n        <Line\n          type=\"monotone\"\n          dataKey=\"load\"\n          stroke={lineColor}\n          strokeWidth={2}\n          dot={false}\n          activeDot={{ r: 5, fill: lineColor }}\n        />\n\n        {/* Vertical reference line at current deflection */}\n        {showMarker && currentPoint && (\n          <ReferenceLine\n            x={currentPoint.deflection}\n            stroke={markerColor}\n            strokeWidth={1.5}\n            strokeDasharray=\"4 4\"\n          />\n        )}\n\n        {/* Marker dot at current point */}\n        {showMarker && currentPoint && (\n          <ReferenceDot\n            x={currentPoint.deflection}\n            y={currentPoint.load}\n            r={6}\n            fill={markerColor}\n            stroke=\"#fff\"\n            strokeWidth={2}\n          />\n        )}\n      </LineChart>\n    </ResponsiveContainer>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SNcurveChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SNcurveChart.tsx:52:5\n  50 |\n  51 |   useEffect(() => {\n> 52 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  53 |   }, []);\n  54 |\n  55 |   const { language } = useLanguage();","line":52,"column":5,"nodeType":null,"endLine":52,"endColumn":15},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SNcurveChart.tsx:148:30\n  146 |           />\n  147 |           \n> 148 |           <Tooltip content={<CustomTooltip />} />\n      |                              ^^^^^^^^^^^^^ This component is created during render\n  149 |           \n  150 |           {/* S-N Curve */}\n  151 |           <Line\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SNcurveChart.tsx:83:25\n   81 |\n   82 |   // Custom tooltip\n>  83 |   const CustomTooltip = ({ active, payload }: { active?: boolean; payload?: Array<{ payload: { cycles: number; stress: number } }> }) => {\n      |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  84 |     if (active && payload && payload.length) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  85 |       const data = payload[0].payload;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 102 |     return null;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 103 |   };\n      | ^^^^ The component is created during render here\n  104 |\n  105 |   // Calculate current point position\n  106 |   const currentPointData = currentPoint ? {","line":148,"column":30,"nodeType":null,"endLine":148,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer,\n  ReferenceLine,\n  ReferenceDot,\n} from \"recharts\";\nimport { useLanguage } from \"@/components/language-context\";\n\ninterface SNcurveChartProps {\n  /** S-N curve data points */\n  curveData: Array<{ cycles: number; stress: number }>;\n  /** Current operating point */\n  currentPoint?: {\n    cycles: number;\n    stress: number;\n  };\n  /** Endurance limit stress */\n  enduranceLimit?: number;\n  /** Chart height */\n  height?: number;\n  /** Line color */\n  lineColor?: string;\n  /** Current point color */\n  pointColor?: string;\n}\n\n/**\n * S-N Fatigue Curve Chart\n * S-N 疲劳曲线图\n * \n * Displays logarithmic S-N curve with current operating point\n */\nexport function SNcurveChart({\n  curveData,\n  currentPoint,\n  enduranceLimit,\n  height = 300,\n  lineColor = \"#3b82f6\",\n  pointColor = \"#ef4444\",\n}: SNcurveChartProps) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  if (!mounted) {\n    return (\n      <div className=\"w-full flex items-center justify-center text-muted-foreground text-sm\" style={{ height }}>\n        Loading chart...\n      </div>\n    );\n  }\n\n  // Transform data for log scale display\n  const chartData = curveData.map((point) => ({\n    logCycles: Math.log10(point.cycles),\n    stress: point.stress,\n    cycles: point.cycles,\n  }));\n\n  // Format axis labels\n  const formatLogCycles = (value: number) => {\n    const cycles = Math.pow(10, value);\n    if (cycles >= 1e6) return `10^${value.toFixed(0)}`;\n    return `10^${value.toFixed(0)}`;\n  };\n\n  const formatStress = (value: number) => `${value.toFixed(0)}`;\n\n  // Custom tooltip\n  const CustomTooltip = ({ active, payload }: { active?: boolean; payload?: Array<{ payload: { cycles: number; stress: number } }> }) => {\n    if (active && payload && payload.length) {\n      const data = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <p className=\"font-medium\">\n            N = {data.cycles >= 1e6 \n              ? `${(data.cycles / 1e6).toFixed(1)}M` \n              : data.cycles >= 1e3 \n                ? `${(data.cycles / 1e3).toFixed(0)}k`\n                : data.cycles.toFixed(0)\n            } {isZh ? \"次\" : \"cycles\"}\n          </p>\n          <p className=\"text-blue-600\">\n            τ = {data.stress.toFixed(1)} MPa\n          </p>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  // Calculate current point position\n  const currentPointData = currentPoint ? {\n    logCycles: Math.log10(Math.max(currentPoint.cycles, 100)),\n    stress: currentPoint.stress,\n  } : null;\n\n  return (\n    <div className=\"w-full\" style={{ height }}>\n      <ResponsiveContainer width=\"100%\" height=\"100%\">\n        <LineChart\n          data={chartData}\n          margin={{ top: 10, right: 30, left: 10, bottom: 30 }}\n        >\n          <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n          \n          <XAxis\n            dataKey=\"logCycles\"\n            type=\"number\"\n            domain={[3, 8]}\n            tickFormatter={formatLogCycles}\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"循环次数 N (log)\" : \"Cycles N (log)\",\n              position: \"bottom\",\n              offset: 15,\n              fontSize: 12,\n            }}\n          />\n          \n          <YAxis\n            dataKey=\"stress\"\n            type=\"number\"\n            tickFormatter={formatStress}\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"应力幅值 τ (MPa)\" : \"Stress Amplitude τ (MPa)\",\n              angle: -90,\n              position: \"insideLeft\",\n              offset: 10,\n              fontSize: 12,\n            }}\n          />\n          \n          <Tooltip content={<CustomTooltip />} />\n          \n          {/* S-N Curve */}\n          <Line\n            type=\"monotone\"\n            dataKey=\"stress\"\n            stroke={lineColor}\n            strokeWidth={2}\n            dot={false}\n            name={isZh ? \"S-N 曲线\" : \"S-N Curve\"}\n          />\n          \n          {/* Endurance limit line */}\n          {enduranceLimit && (\n            <ReferenceLine\n              y={enduranceLimit}\n              stroke=\"#22c55e\"\n              strokeDasharray=\"5 5\"\n              label={{\n                value: isZh ? `疲劳极限 ${enduranceLimit} MPa` : `Endurance ${enduranceLimit} MPa`,\n                position: \"right\",\n                fontSize: 10,\n                fill: \"#22c55e\",\n              }}\n            />\n          )}\n          \n          {/* Current operating point */}\n          {currentPointData && (\n            <ReferenceDot\n              x={currentPointData.logCycles}\n              y={currentPointData.stress}\n              r={6}\n              fill={pointColor}\n              stroke=\"#fff\"\n              strokeWidth={2}\n            />\n          )}\n        </LineChart>\n      </ResponsiveContainer>\n      \n      {/* Legend */}\n      <div className=\"flex items-center justify-center gap-6 mt-2 text-xs\">\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5\" style={{ backgroundColor: lineColor }} />\n          <span>{isZh ? \"S-N 曲线\" : \"S-N Curve\"}</span>\n        </div>\n        {enduranceLimit && (\n          <div className=\"flex items-center gap-1\">\n            <div className=\"w-4 h-0.5 border-t-2 border-dashed border-green-500\" />\n            <span>{isZh ? \"疲劳极限\" : \"Endurance Limit\"}</span>\n          </div>\n        )}\n        {currentPoint && (\n          <div className=\"flex items-center gap-1\">\n            <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: pointColor }} />\n            <span>{isZh ? \"当前工况\" : \"Current Point\"}</span>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpiralCloseoutChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpiralCloseoutChart.tsx:34:5\n  32 |\n  33 |   useEffect(() => {\n> 34 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  35 |   }, []);\n  36 |\n  37 |   if (!mounted) {","line":34,"column":5,"nodeType":null,"endLine":34,"endColumn":15},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpiralCloseoutChart.tsx:108:30\n  106 |             }}\n  107 |           />\n> 108 |           <Tooltip content={<CustomTooltip />} />\n      |                              ^^^^^^^^^^^^^ This component is created during render\n  109 |\n  110 |           <ReferenceLine\n  111 |             x={thetaCoDeg}\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpiralCloseoutChart.tsx:59:25\n  57 |   }\n  58 |\n> 59 |   const CustomTooltip = ({\n     |                         ^^\n> 60 |     active,\n     | ^^^^^^^^^^^\n> 61 |     payload,\n     …\n     | ^^^^^^^^^^^\n> 78 |     return null;\n     | ^^^^^^^^^^^\n> 79 |   };\n     | ^^^^ The component is created during render here\n  80 |\n  81 |   return (\n  82 |     <div className=\"w-full\" style={{ height }}>","line":108,"column":30,"nodeType":null,"endLine":108,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport {\n  ResponsiveContainer,\n  LineChart,\n  CartesianGrid,\n  XAxis,\n  YAxis,\n  Tooltip,\n  Line,\n  ReferenceLine,\n} from \"recharts\";\nimport { useLanguage } from \"@/components/language-context\";\n\nexport interface SpiralCloseoutPoint {\n  thetaDeg: number;\n  torque: number;\n}\n\ninterface SpiralCloseoutChartProps {\n  linear: SpiralCloseoutPoint[];\n  nonlinear: SpiralCloseoutPoint[];\n  thetaCoDeg: number;\n  height?: number;\n}\n\nexport function SpiralCloseoutChart({ linear, nonlinear, thetaCoDeg, height = 260 }: SpiralCloseoutChartProps) {\n  const [mounted, setMounted] = useState(false);\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  if (!mounted) {\n    return (\n      <div className=\"w-full flex items-center justify-center text-muted-foreground text-sm\" style={{ height }}>\n        Loading chart...\n      </div>\n    );\n  }\n\n  const data = (linear || []).map((p, idx) => ({\n    thetaDeg: p.thetaDeg,\n    torqueLinear: p.torque,\n    torqueNonlinear: nonlinear && nonlinear[idx] ? nonlinear[idx].torque : null,\n  }));\n\n  if (data.length === 0) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        {isZh ? \"暂无曲线数据\" : \"No curve data\"}\n      </div>\n    );\n  }\n\n  const CustomTooltip = ({\n    active,\n    payload,\n  }: {\n    active?: boolean;\n    payload?: Array<{ payload: { thetaDeg: number; torqueLinear: number; torqueNonlinear: number | null } }>;\n  }) => {\n    if (active && payload && payload.length) {\n      const p = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <p className=\"font-medium\">θ = {p.thetaDeg.toFixed(1)}°</p>\n          <p className=\"text-slate-700\">T_linear = {p.torqueLinear.toFixed(1)} N·mm</p>\n          <p className=\"text-purple-700\">\n            T_nonlinear = {p.torqueNonlinear !== null ? p.torqueNonlinear.toFixed(1) : \"—\"} N·mm\n          </p>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <div className=\"w-full\" style={{ height }}>\n      <ResponsiveContainer width=\"100%\" height=\"100%\">\n        <LineChart data={data} margin={{ top: 10, right: 22, left: 10, bottom: 30 }}>\n          <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n          <XAxis\n            dataKey=\"thetaDeg\"\n            type=\"number\"\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"角度 θ (deg)\" : \"Angle θ (deg)\",\n              position: \"bottom\",\n              offset: 15,\n              fontSize: 12,\n            }}\n          />\n          <YAxis\n            type=\"number\"\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"扭矩 T (N·mm)\" : \"Torque T (N·mm)\",\n              angle: -90,\n              position: \"insideLeft\",\n              offset: 10,\n              fontSize: 12,\n            }}\n          />\n          <Tooltip content={<CustomTooltip />} />\n\n          <ReferenceLine\n            x={thetaCoDeg}\n            stroke=\"#f59e0b\"\n            strokeDasharray=\"5 5\"\n            label={{\n              value: isZh ? \"θ_co\" : \"θ_co\",\n              position: \"top\",\n              fontSize: 10,\n              fill: \"#f59e0b\",\n            }}\n          />\n\n          <Line type=\"monotone\" dataKey=\"torqueLinear\" stroke=\"#3b82f6\" strokeWidth={2} dot={false} name=\"Linear\" />\n          <Line type=\"monotone\" dataKey=\"torqueNonlinear\" stroke=\"#a855f7\" strokeWidth={2} dot={false} name=\"Nonlinear\" />\n        </LineChart>\n      </ResponsiveContainer>\n\n      <div className=\"flex items-center justify-center gap-6 mt-2 text-xs\">\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5\" style={{ backgroundColor: \"#3b82f6\" }} />\n          <span>{isZh ? \"线性\" : \"Linear\"}</span>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5\" style={{ backgroundColor: \"#a855f7\" }} />\n          <span>{isZh ? \"渐进硬化\" : \"Nonlinear\"}</span>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5 border-t-2 border-dashed\" style={{ borderColor: \"#f59e0b\" }} />\n          <span>{isZh ? \"贴合角\" : \"Close-out\"}</span>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpiralTorqueBandChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpiralTorqueBandChart.tsx:33:5\n  31 |\n  32 |   useEffect(() => {\n> 33 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  34 |   }, []);\n  35 |\n  36 |   if (!mounted) {","line":33,"column":5,"nodeType":null,"endLine":33,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'label' is defined but never used.","line":55,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":55,"endColumn":10},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpiralTorqueBandChart.tsx:102:30\n  100 |             }}\n  101 |           />\n> 102 |           <Tooltip content={<CustomTooltip />} />\n      |                              ^^^^^^^^^^^^^ This component is created during render\n  103 |           <Line type=\"monotone\" dataKey=\"torqueNom\" stroke=\"#3b82f6\" strokeWidth={2} dot={false} name=\"Nominal\" />\n  104 |           <Line type=\"monotone\" dataKey=\"torqueMin\" stroke=\"#10b981\" strokeWidth={2} dot={false} name=\"Min\" />\n  105 |           <Line type=\"monotone\" dataKey=\"torqueMax\" stroke=\"#f59e0b\" strokeWidth={2} dot={false} name=\"Max\" />\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpiralTorqueBandChart.tsx:52:25\n  50 |   }\n  51 |\n> 52 |   const CustomTooltip = ({\n     |                         ^^\n> 53 |     active,\n     | ^^^^^^^^^^^\n> 54 |     payload,\n     …\n     | ^^^^^^^^^^^\n> 72 |     return null;\n     | ^^^^^^^^^^^\n> 73 |   };\n     | ^^^^ The component is created during render here\n  74 |\n  75 |   return (\n  76 |     <div className=\"w-full\" style={{ height }}>","line":102,"column":30,"nodeType":null,"endLine":102,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport {\n  ResponsiveContainer,\n  LineChart,\n  CartesianGrid,\n  XAxis,\n  YAxis,\n  Tooltip,\n  Line,\n} from \"recharts\";\nimport { useLanguage } from \"@/components/language-context\";\n\nexport interface SpiralTorqueBandPoint {\n  thetaDeg: number;\n  torqueNom: number;\n  torqueMin: number;\n  torqueMax: number;\n}\n\ninterface SpiralTorqueBandChartProps {\n  data: SpiralTorqueBandPoint[];\n  height?: number;\n}\n\nexport function SpiralTorqueBandChart({ data, height = 260 }: SpiralTorqueBandChartProps) {\n  const [mounted, setMounted] = useState(false);\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  if (!mounted) {\n    return (\n      <div className=\"w-full flex items-center justify-center text-muted-foreground text-sm\" style={{ height }}>\n        Loading chart...\n      </div>\n    );\n  }\n\n  if (!data || data.length === 0) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        {isZh ? \"暂无曲线数据\" : \"No curve data\"}\n      </div>\n    );\n  }\n\n  const CustomTooltip = ({\n    active,\n    payload,\n    label,\n  }: {\n    active?: boolean;\n    payload?: Array<{ name?: string; value?: number; payload: SpiralTorqueBandPoint }>;\n    label?: number;\n  }) => {\n    if (active && payload && payload.length) {\n      const p = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <p className=\"font-medium\">θ = {p.thetaDeg.toFixed(1)}°</p>\n          <p className=\"text-slate-700\">T_nom = {p.torqueNom.toFixed(1)} N·mm</p>\n          <p className=\"text-emerald-700\">T_min = {p.torqueMin.toFixed(1)} N·mm</p>\n          <p className=\"text-amber-700\">T_max = {p.torqueMax.toFixed(1)} N·mm</p>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <div className=\"w-full\" style={{ height }}>\n      <ResponsiveContainer width=\"100%\" height=\"100%\">\n        <LineChart data={data} margin={{ top: 10, right: 22, left: 10, bottom: 30 }}>\n          <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n          <XAxis\n            dataKey=\"thetaDeg\"\n            type=\"number\"\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"角度 θ (deg)\" : \"Angle θ (deg)\",\n              position: \"bottom\",\n              offset: 15,\n              fontSize: 12,\n            }}\n          />\n          <YAxis\n            type=\"number\"\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"扭矩 T (N·mm)\" : \"Torque T (N·mm)\",\n              angle: -90,\n              position: \"insideLeft\",\n              offset: 10,\n              fontSize: 12,\n            }}\n          />\n          <Tooltip content={<CustomTooltip />} />\n          <Line type=\"monotone\" dataKey=\"torqueNom\" stroke=\"#3b82f6\" strokeWidth={2} dot={false} name=\"Nominal\" />\n          <Line type=\"monotone\" dataKey=\"torqueMin\" stroke=\"#10b981\" strokeWidth={2} dot={false} name=\"Min\" />\n          <Line type=\"monotone\" dataKey=\"torqueMax\" stroke=\"#f59e0b\" strokeWidth={2} dot={false} name=\"Max\" />\n        </LineChart>\n      </ResponsiveContainer>\n\n      <div className=\"flex items-center justify-center gap-6 mt-2 text-xs\">\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5\" style={{ backgroundColor: \"#3b82f6\" }} />\n          <span>{isZh ? \"名义\" : \"Nom\"}</span>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5\" style={{ backgroundColor: \"#10b981\" }} />\n          <span>{isZh ? \"下界\" : \"Min\"}</span>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5\" style={{ backgroundColor: \"#f59e0b\" }} />\n          <span>{isZh ? \"上界\" : \"Max\"}</span>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpringDeflectionSlider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/SpringForceTable.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'containerRect' is assigned a value but never used.","line":59,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":59,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'rowRect' is assigned a value but never used.","line":60,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":60,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useMemo, useRef, useEffect } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { useLanguage } from \"@/components/language-context\";\n\nexport interface ForceDeflectionPoint {\n  deflection: number;\n  load: number;\n}\n\ninterface SpringForceTableProps {\n  data: ForceDeflectionPoint[];\n  currentDeflection: number;\n  onRowClick?: (deflection: number) => void;\n  maxHeight?: string;\n}\n\nexport function SpringForceTable({\n  data,\n  currentDeflection,\n  onRowClick,\n  maxHeight = \"max-h-64\",\n}: SpringForceTableProps) {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n  const deflectionLabel = isZh ? \"位移 (mm)\" : \"Deflection (mm)\";\n  const forceLabel = isZh ? \"载荷 (N)\" : \"Force (N)\";\n  const tableRef = useRef<HTMLDivElement>(null);\n\n  // Find the index of the nearest row to currentDeflection\n  const nearestIndex = useMemo(() => {\n    if (data.length === 0) return -1;\n\n    let nearestIdx = 0;\n    let minDiff = Math.abs(data[0].deflection - currentDeflection);\n\n    for (let i = 1; i < data.length; i++) {\n      const diff = Math.abs(data[i].deflection - currentDeflection);\n      if (diff < minDiff) {\n        minDiff = diff;\n        nearestIdx = i;\n      }\n    }\n\n    return nearestIdx;\n  }, [data, currentDeflection]);\n\n  // Auto-scroll to the highlighted row within the table container only\n  // This prevents the page from scrolling when the slider is moved\n  useEffect(() => {\n    if (nearestIndex >= 0 && tableRef.current) {\n      const container = tableRef.current;\n      const rows = container.querySelectorAll(\"tbody tr\");\n      const targetRow = rows[nearestIndex] as HTMLElement;\n      \n      if (targetRow) {\n        // Calculate scroll position within the container\n        const containerRect = container.getBoundingClientRect();\n        const rowRect = targetRow.getBoundingClientRect();\n        \n        // Only scroll if the row is outside the visible area of the container\n        const rowTop = targetRow.offsetTop;\n        const rowHeight = targetRow.offsetHeight;\n        const containerScrollTop = container.scrollTop;\n        const containerHeight = container.clientHeight;\n        \n        // Check if row is above visible area\n        if (rowTop < containerScrollTop) {\n          container.scrollTo({\n            top: rowTop - rowHeight,\n            behavior: \"smooth\",\n          });\n        }\n        // Check if row is below visible area\n        else if (rowTop + rowHeight > containerScrollTop + containerHeight) {\n          container.scrollTo({\n            top: rowTop - containerHeight + rowHeight * 2,\n            behavior: \"smooth\",\n          });\n        }\n      }\n    }\n  }, [nearestIndex]);\n\n  const formatNumber = (value: number) => Number(value.toFixed(2)).toLocaleString();\n\n  if (data.length === 0) {\n    return (\n      <div className=\"flex h-32 items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n        {isZh ? \"暂无数据\" : \"No data available\"}\n      </div>\n    );\n  }\n\n  return (\n    <div ref={tableRef} className={cn(\"overflow-x-auto overflow-y-auto rounded-lg border\", maxHeight)}>\n      <table className=\"w-full text-sm\">\n        <thead className=\"bg-slate-100 text-left sticky top-0 z-10\">\n          <tr>\n            <th className=\"px-4 py-2 font-medium\">{deflectionLabel}</th>\n            <th className=\"px-4 py-2 font-medium\">{forceLabel}</th>\n          </tr>\n        </thead>\n        <tbody>\n          {data.map((row, idx) => {\n            const isHighlighted = idx === nearestIndex;\n            const isLast = idx === data.length - 1;\n\n            return (\n              <tr\n                key={idx}\n                onClick={() => onRowClick?.(row.deflection)}\n                className={cn(\n                  \"border-t transition-colors cursor-pointer hover:bg-slate-50\",\n                  isHighlighted && \"bg-blue-50 hover:bg-blue-100\",\n                  isLast && !isHighlighted && \"bg-green-50\"\n                )}\n              >\n                <td className={cn(\"px-4 py-2\", isHighlighted && \"text-blue-700 font-medium\")}>\n                  {formatNumber(row.deflection)}\n                  {isHighlighted && (\n                    <span className=\"ml-2 text-xs text-blue-500\">◀</span>\n                  )}\n                </td>\n                <td className={cn(\"px-4 py-2\", isHighlighted && \"text-blue-700 font-medium\")}>\n                  {formatNumber(row.load)}\n                </td>\n              </tr>\n            );\n          })}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/StressDeflectionChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/StressDeflectionChart.tsx:51:5\n  49 |\n  50 |   useEffect(() => {\n> 51 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  52 |   }, []);\n  53 |\n  54 |   const { language } = useLanguage();","line":51,"column":5,"nodeType":null,"endLine":51,"endColumn":15},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/StressDeflectionChart.tsx:141:30\n  139 |           />\n  140 |           \n> 141 |           <Tooltip content={<CustomTooltip />} />\n      |                              ^^^^^^^^^^^^^ This component is created during render\n  142 |           \n  143 |           {/* Stress curve */}\n  144 |           <Line\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/StressDeflectionChart.tsx:91:25\n   89 |\n   90 |   // Custom tooltip\n>  91 |   const CustomTooltip = ({ active, payload }: { active?: boolean; payload?: Array<{ payload: { deflection: number; stress: number; force: number } }> }) => {\n      |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  92 |     if (active && payload && payload.length) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  93 |       const d = payload[0].payload;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 102 |     return null;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 103 |   };\n      | ^^^^ The component is created during render here\n  104 |\n  105 |   const defaultXLabel = isZh ? \"位移 Δx (mm)\" : \"Deflection Δx (mm)\";\n  106 |","line":141,"column":30,"nodeType":null,"endLine":141,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport {\n  LineChart,\n  Line,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer,\n  ReferenceLine,\n  ReferenceDot,\n} from \"recharts\";\nimport { useLanguage } from \"@/components/language-context\";\nimport type { ForceDeflectionPoint } from \"@/lib/engine/types\";\n\ninterface StressDeflectionChartProps {\n  /** Force-deflection curve data with stress */\n  data: ForceDeflectionPoint[];\n  /** Current deflection position */\n  currentDeflection?: number;\n  /** Allowable stress limit */\n  allowableStress?: number;\n  /** Chart height */\n  height?: number;\n  /** Line color */\n  lineColor?: string;\n  /** Marker color */\n  markerColor?: string;\n  /** X-axis label (for torsion springs: angle) */\n  xAxisLabel?: string;\n}\n\n/**\n * Stress vs Deflection Chart\n * 应力-位移曲线图\n */\nexport function StressDeflectionChart({\n  data,\n  currentDeflection,\n  allowableStress,\n  height = 300,\n  lineColor = \"#8b5cf6\",\n  markerColor = \"#ef4444\",\n  xAxisLabel,\n}: StressDeflectionChartProps) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  if (!mounted) {\n    return (\n      <div className=\"w-full flex items-center justify-center text-muted-foreground text-sm\" style={{ height }}>\n        Loading chart...\n      </div>\n    );\n  }\n\n  // Filter data to only include points with stress\n  const chartData = data.filter((p) => p.stress !== undefined).map((p) => ({\n    deflection: p.deflection,\n    stress: p.stress!,\n    force: p.force,\n  }));\n\n  if (chartData.length === 0) {\n    return (\n      <div className=\"flex items-center justify-center h-full text-muted-foreground text-sm\">\n        {isZh ? \"暂无应力数据\" : \"No stress data available\"}\n      </div>\n    );\n  }\n\n  // Find current point\n  const currentPoint = currentDeflection !== undefined\n    ? chartData.find((p) => Math.abs(p.deflection - currentDeflection) < 0.01) ||\n      chartData.reduce((prev, curr) =>\n        Math.abs(curr.deflection - currentDeflection) < Math.abs(prev.deflection - currentDeflection)\n          ? curr\n          : prev\n      )\n    : null;\n\n  // Custom tooltip\n  const CustomTooltip = ({ active, payload }: { active?: boolean; payload?: Array<{ payload: { deflection: number; stress: number; force: number } }> }) => {\n    if (active && payload && payload.length) {\n      const d = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <p>Δx = {d.deflection.toFixed(2)} mm</p>\n          <p className=\"text-purple-600 font-medium\">τ = {d.stress.toFixed(1)} MPa</p>\n          <p className=\"text-blue-600\">F = {d.force.toFixed(1)} N</p>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  const defaultXLabel = isZh ? \"位移 Δx (mm)\" : \"Deflection Δx (mm)\";\n\n  return (\n    <div className=\"w-full\" style={{ height }}>\n      <ResponsiveContainer width=\"100%\" height=\"100%\">\n        <LineChart\n          data={chartData}\n          margin={{ top: 10, right: 30, left: 10, bottom: 30 }}\n        >\n          <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n          \n          <XAxis\n            dataKey=\"deflection\"\n            type=\"number\"\n            tick={{ fontSize: 11 }}\n            label={{\n              value: xAxisLabel || defaultXLabel,\n              position: \"bottom\",\n              offset: 15,\n              fontSize: 12,\n            }}\n          />\n          \n          <YAxis\n            dataKey=\"stress\"\n            type=\"number\"\n            tick={{ fontSize: 11 }}\n            label={{\n              value: isZh ? \"剪应力 τ (MPa)\" : \"Shear Stress τ (MPa)\",\n              angle: -90,\n              position: \"insideLeft\",\n              offset: 10,\n              fontSize: 12,\n            }}\n          />\n          \n          <Tooltip content={<CustomTooltip />} />\n          \n          {/* Stress curve */}\n          <Line\n            type=\"monotone\"\n            dataKey=\"stress\"\n            stroke={lineColor}\n            strokeWidth={2}\n            dot={false}\n            name={isZh ? \"应力曲线\" : \"Stress Curve\"}\n          />\n          \n          {/* Allowable stress limit */}\n          {allowableStress && (\n            <ReferenceLine\n              y={allowableStress}\n              stroke=\"#ef4444\"\n              strokeDasharray=\"5 5\"\n              label={{\n                value: isZh ? `许用 ${allowableStress} MPa` : `Allow ${allowableStress} MPa`,\n                position: \"right\",\n                fontSize: 10,\n                fill: \"#ef4444\",\n              }}\n            />\n          )}\n          \n          {/* Current point marker */}\n          {currentPoint && (\n            <ReferenceDot\n              x={currentPoint.deflection}\n              y={currentPoint.stress}\n              r={6}\n              fill={markerColor}\n              stroke=\"#fff\"\n              strokeWidth={2}\n            />\n          )}\n        </LineChart>\n      </ResponsiveContainer>\n      \n      {/* Legend */}\n      <div className=\"flex items-center justify-center gap-6 mt-2 text-xs\">\n        <div className=\"flex items-center gap-1\">\n          <div className=\"w-4 h-0.5\" style={{ backgroundColor: lineColor }} />\n          <span>{isZh ? \"应力曲线\" : \"Stress Curve\"}</span>\n        </div>\n        {allowableStress && (\n          <div className=\"flex items-center gap-1\">\n            <div className=\"w-4 h-0.5 border-t-2 border-dashed border-red-500\" />\n            <span>{isZh ? \"许用应力\" : \"Allowable\"}</span>\n          </div>\n        )}\n        {currentPoint && (\n          <div className=\"flex items-center gap-1\">\n            <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: markerColor }} />\n            <span>{isZh ? \"当前点\" : \"Current\"}</span>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/VariablePitchCurvesChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/VariablePitchCurvesChart.tsx:47:5\n  45 |\n  46 |   useEffect(() => {\n> 47 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  48 |   }, []);\n  49 |\n  50 |   const hasK = useMemo(() => data.some((p) => typeof p.springRate === \"number\"), [data]);","line":47,"column":5,"nodeType":null,"endLine":47,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showTau' is assigned a value but never used.","line":71,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":71,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport {\n  ResponsiveContainer,\n  LineChart,\n  CartesianGrid,\n  XAxis,\n  YAxis,\n  Tooltip,\n  Line,\n  Legend,\n  ReferenceLine,\n} from \"recharts\";\n\nexport type VariablePitchCurvePoint = {\n  deflection: number;\n  load: number;\n  springRate?: number;\n  shearStress?: number;\n  activeCoils?: number;\n};\n\nexport type VariablePitchCurveMode =\n  | \"force\"\n  | \"stiffness\"\n  | \"stress\"\n  | \"overlay_force_stress\"\n  | \"overlay_force_stiffness\";\n\nexport type VariablePitchEventMarker = {\n  deflection: number;\n  label: string;\n  color?: string;\n};\n\ninterface Props {\n  data: VariablePitchCurvePoint[];\n  mode: VariablePitchCurveMode;\n  markers?: VariablePitchEventMarker[];\n}\n\nexport function VariablePitchCurvesChart({ data, mode, markers }: Props) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const hasK = useMemo(() => data.some((p) => typeof p.springRate === \"number\"), [data]);\n  const hasTau = useMemo(() => data.some((p) => typeof p.shearStress === \"number\"), [data]);\n\n  if (!mounted) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n        Loading chart...\n      </div>\n    );\n  }\n\n  if (data.length === 0) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\">\n        No data yet. Generate a curve to see the chart.\n      </div>\n    );\n  }\n\n  const showForce = mode === \"force\" || mode.startsWith(\"overlay_force_\");\n  const showK = mode === \"stiffness\" || mode === \"overlay_force_stiffness\";\n  const showTau = mode === \"stress\" || mode === \"overlay_force_stress\";\n\n  const primaryKey = showForce ? \"load\" : showK ? \"springRate\" : \"shearStress\";\n  const primaryLabel = showForce\n    ? \"Force (N)\"\n    : showK\n      ? \"Stiffness (N/mm)\"\n      : \"Shear Stress (MPa)\";\n\n  return (\n    <ResponsiveContainer width=\"100%\" height=\"100%\" minWidth={0} minHeight={240}>\n      <LineChart data={data} margin={{ top: 40, right: 24, left: 16, bottom: 18 }}>\n        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n        <XAxis\n          dataKey=\"deflection\"\n          label={{ value: \"Deflection (mm)\", position: \"insideBottom\", offset: -10 }}\n          tick={{ fontSize: 12 }}\n          stroke=\"#64748b\"\n        />\n        <YAxis\n          yAxisId=\"left\"\n          dataKey={primaryKey}\n          label={{ value: primaryLabel, angle: -90, position: \"insideLeft\", offset: 10 }}\n          tick={{ fontSize: 12 }}\n          stroke=\"#64748b\"\n        />\n\n        {mode === \"overlay_force_stress\" && hasTau && (\n          <YAxis\n            yAxisId=\"right\"\n            orientation=\"right\"\n            dataKey=\"shearStress\"\n            label={{ value: \"Shear Stress (MPa)\", angle: -90, position: \"insideRight\", offset: 10 }}\n            tick={{ fontSize: 12 }}\n            stroke=\"#64748b\"\n          />\n        )}\n\n        {mode === \"overlay_force_stiffness\" && hasK && (\n          <YAxis\n            yAxisId=\"right\"\n            orientation=\"right\"\n            dataKey=\"springRate\"\n            label={{ value: \"Stiffness (N/mm)\", angle: -90, position: \"insideRight\", offset: 10 }}\n            tick={{ fontSize: 12 }}\n            stroke=\"#64748b\"\n          />\n        )}\n\n        <Tooltip\n          contentStyle={{\n            backgroundColor: \"#fff\",\n            border: \"1px solid #e2e8f0\",\n            borderRadius: \"6px\",\n            fontSize: \"12px\",\n          }}\n          labelFormatter={(label: number) => `Deflection: ${label.toFixed(2)} mm`}\n        />\n        <Legend\n          verticalAlign=\"top\"\n          align=\"right\"\n          wrapperStyle={{ fontSize: 12, paddingBottom: 8 }}\n        />\n\n        {(markers ?? [])\n          .filter((m) => isFinite(m.deflection))\n          .map((m, idx) => (\n            <ReferenceLine\n              key={`${m.deflection}-${idx}`}\n              x={m.deflection}\n              stroke={m.color ?? \"#94a3b8\"}\n              strokeDasharray=\"4 4\"\n              strokeWidth={1.5}\n              label={{\n                value: m.label,\n                position: \"top\",\n                fontSize: 11,\n                fill: m.color ?? \"#64748b\",\n              }}\n            />\n          ))}\n\n        {showForce && (\n          <Line\n            yAxisId=\"left\"\n            type=\"monotone\"\n            dataKey=\"load\"\n            name=\"Force\"\n            stroke=\"#3b82f6\"\n            strokeWidth={2}\n            dot={false}\n          />\n        )}\n\n        {mode === \"stiffness\" && (\n          <Line\n            yAxisId=\"left\"\n            type=\"stepAfter\"\n            dataKey=\"springRate\"\n            name=\"Stiffness\"\n            stroke=\"#10b981\"\n            strokeWidth={2}\n            dot={false}\n            connectNulls\n          />\n        )}\n\n        {mode === \"stress\" && (\n          <Line\n            yAxisId=\"left\"\n            type=\"monotone\"\n            dataKey=\"shearStress\"\n            name=\"Shear Stress\"\n            stroke=\"#8b5cf6\"\n            strokeWidth={2}\n            dot={false}\n            connectNulls\n          />\n        )}\n\n        {mode === \"overlay_force_stress\" && hasTau && (\n          <Line\n            yAxisId=\"right\"\n            type=\"monotone\"\n            dataKey=\"shearStress\"\n            name=\"Shear Stress\"\n            stroke=\"#8b5cf6\"\n            strokeWidth={2}\n            dot={false}\n            connectNulls\n          />\n        )}\n\n        {mode === \"overlay_force_stiffness\" && hasK && (\n          <Line\n            yAxisId=\"right\"\n            type=\"stepAfter\"\n            dataKey=\"springRate\"\n            name=\"Stiffness\"\n            stroke=\"#10b981\"\n            strokeWidth={2}\n            dot={false}\n            connectNulls\n          />\n        )}\n      </LineChart>\n    </ResponsiveContainer>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/charts/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/design-rules/DesignRulePanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/drawing/EngineeringDrawingCanvas.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SHEET_SIZES' is defined but never used.","line":12,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useRef, useEffect, useMemo } from \"react\";\nimport type {\n  SpringDrawingSpec,\n  ViewGeometry,\n  GeometryElement,\n  DimensionSpec,\n  Line2D,\n  Arc2D,\n  Circle2D,\n  SHEET_SIZES,\n} from \"@/lib/drawing/types\";\n\ninterface EngineeringDrawingCanvasProps {\n  spec: SpringDrawingSpec;\n  width?: number;\n  height?: number;\n  className?: string;\n}\n\n// 线型样式\nconst LINE_STYLES = {\n  solid: [],\n  dashed: [8, 4],\n  centerline: [16, 4, 4, 4],\n  hidden: [4, 4],\n};\n\n// 颜色\nconst COLORS = {\n  geometry: \"#000000\",\n  dimension: \"#0066cc\",\n  centerline: \"#cc0000\",\n  hidden: \"#666666\",\n  titleBlock: \"#000000\",\n  grid: \"#e0e0e0\",\n};\n\n/**\n * 2D 工程图 Canvas 渲染组件\n */\nexport function EngineeringDrawingCanvas({\n  spec,\n  width = 800,\n  height = 566,\n  className = \"\",\n}: EngineeringDrawingCanvasProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  \n  // 计算缩放比例\n  const scale = useMemo(() => {\n    const sheetWidth = spec.sheetSize === \"A4\" ? 297 : spec.sheetSize === \"A3\" ? 420 : 594;\n    const sheetHeight = spec.sheetSize === \"A4\" ? 210 : spec.sheetSize === \"A3\" ? 297 : 420;\n    \n    if (spec.orientation === \"landscape\") {\n      return Math.min(width / sheetWidth, height / sheetHeight);\n    } else {\n      return Math.min(width / sheetHeight, height / sheetWidth);\n    }\n  }, [spec.sheetSize, spec.orientation, width, height]);\n  \n  useEffect(() => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n    \n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n    \n    // 清空画布\n    ctx.fillStyle = \"#ffffff\";\n    ctx.fillRect(0, 0, width, height);\n    \n    // 绘制边框\n    drawBorder(ctx, width, height, scale);\n    \n    // 绘制视图几何\n    if (spec.viewGeometries) {\n      for (const viewGeom of spec.viewGeometries) {\n        const view = spec.views.find(v => v.id === viewGeom.viewId);\n        if (view) {\n          drawViewGeometry(ctx, viewGeom, view.position, scale);\n        }\n      }\n    }\n    \n    // 绘制尺寸标注\n    for (const dim of spec.dimensions) {\n      const view = spec.views.find(v => v.id === dim.viewId);\n      if (view) {\n        drawDimension(ctx, dim, view.position, scale);\n      }\n    }\n    \n    // 绘制标题栏\n    drawTitleBlock(ctx, spec.titleBlock, width, height, scale);\n    \n    // 绘制技术要求\n    drawTechnicalNotes(ctx, spec.technicalNotes, width, height, scale);\n    \n  }, [spec, width, height, scale]);\n  \n  return (\n    <canvas\n      ref={canvasRef}\n      width={width}\n      height={height}\n      className={`border border-slate-300 bg-white ${className}`}\n    />\n  );\n}\n\n/**\n * 绘制边框\n */\nfunction drawBorder(\n  ctx: CanvasRenderingContext2D,\n  width: number,\n  height: number,\n  scale: number\n) {\n  const margin = 10 * scale;\n  \n  ctx.strokeStyle = COLORS.titleBlock;\n  ctx.lineWidth = 2;\n  ctx.strokeRect(margin, margin, width - 2 * margin, height - 2 * margin);\n  \n  // 内框\n  ctx.lineWidth = 0.5;\n  ctx.strokeRect(margin + 5, margin + 5, width - 2 * margin - 10, height - 2 * margin - 10);\n}\n\n/**\n * 绘制视图几何\n */\nfunction drawViewGeometry(\n  ctx: CanvasRenderingContext2D,\n  viewGeom: ViewGeometry,\n  position: { x: number; y: number },\n  scale: number\n) {\n  ctx.save();\n  ctx.translate(position.x * scale, position.y * scale);\n  \n  for (const element of viewGeom.elements) {\n    drawElement(ctx, element, scale);\n  }\n  \n  ctx.restore();\n}\n\n/**\n * 绘制几何元素\n */\nfunction drawElement(\n  ctx: CanvasRenderingContext2D,\n  element: GeometryElement,\n  scale: number\n) {\n  ctx.beginPath();\n  \n  // 设置线型\n  const style = element.style || \"solid\";\n  ctx.setLineDash(LINE_STYLES[style] || []);\n  ctx.lineWidth = (element.weight || 0.35) * scale;\n  \n  // 设置颜色\n  if (style === \"centerline\") {\n    ctx.strokeStyle = COLORS.centerline;\n  } else if (style === \"hidden\") {\n    ctx.strokeStyle = COLORS.hidden;\n  } else {\n    ctx.strokeStyle = COLORS.geometry;\n  }\n  \n  if (\"start\" in element && \"end\" in element) {\n    // Line\n    const line = element as Line2D;\n    ctx.moveTo(line.start.x, line.start.y);\n    ctx.lineTo(line.end.x, line.end.y);\n  } else if (\"center\" in element && \"radius\" in element) {\n    if (\"startAngle\" in element) {\n      // Arc\n      const arc = element as Arc2D;\n      const startRad = (arc.startAngle * Math.PI) / 180;\n      const endRad = (arc.endAngle * Math.PI) / 180;\n      ctx.arc(arc.center.x, arc.center.y, arc.radius, startRad, endRad);\n    } else {\n      // Circle\n      const circle = element as Circle2D;\n      ctx.arc(circle.center.x, circle.center.y, circle.radius, 0, Math.PI * 2);\n    }\n  }\n  \n  ctx.stroke();\n  ctx.setLineDash([]);\n}\n\n/**\n * 绘制尺寸标注\n */\nfunction drawDimension(\n  ctx: CanvasRenderingContext2D,\n  dim: DimensionSpec,\n  viewPosition: { x: number; y: number },\n  scale: number\n) {\n  ctx.save();\n  ctx.translate(viewPosition.x * scale, viewPosition.y * scale);\n  \n  ctx.strokeStyle = COLORS.dimension;\n  ctx.fillStyle = COLORS.dimension;\n  ctx.lineWidth = 0.25 * scale;\n  ctx.font = `${10 * scale}px Arial`;\n  \n  const from = typeof dim.fromPoint === \"object\" ? dim.fromPoint : { x: 0, y: 0 };\n  const to = typeof dim.toPoint === \"object\" ? dim.toPoint : { x: 0, y: 0 };\n  const offset = dim.offset || 10;\n  \n  if (dim.orientation === \"horizontal\") {\n    const y = from.y - offset * scale;\n    \n    // 尺寸线\n    ctx.beginPath();\n    ctx.moveTo(from.x, y);\n    ctx.lineTo(to.x, y);\n    ctx.stroke();\n    \n    // 延伸线\n    ctx.beginPath();\n    ctx.moveTo(from.x, from.y);\n    ctx.lineTo(from.x, y - 3 * scale);\n    ctx.moveTo(to.x, to.y);\n    ctx.lineTo(to.x, y - 3 * scale);\n    ctx.stroke();\n    \n    // 箭头\n    drawArrow(ctx, from.x, y, \"left\", scale);\n    drawArrow(ctx, to.x, y, \"right\", scale);\n    \n    // 文字\n    const text = formatDimensionText(dim);\n    const textWidth = ctx.measureText(text).width;\n    ctx.fillText(text, (from.x + to.x) / 2 - textWidth / 2, y - 3 * scale);\n    \n  } else if (dim.orientation === \"vertical\") {\n    const x = from.x + offset * scale;\n    \n    // 尺寸线\n    ctx.beginPath();\n    ctx.moveTo(x, from.y);\n    ctx.lineTo(x, to.y);\n    ctx.stroke();\n    \n    // 延伸线\n    ctx.beginPath();\n    ctx.moveTo(from.x, from.y);\n    ctx.lineTo(x + 3 * scale, from.y);\n    ctx.moveTo(to.x, to.y);\n    ctx.lineTo(x + 3 * scale, to.y);\n    ctx.stroke();\n    \n    // 箭头\n    drawArrow(ctx, x, from.y, \"down\", scale);\n    drawArrow(ctx, x, to.y, \"up\", scale);\n    \n    // 文字（旋转）\n    const text = formatDimensionText(dim);\n    ctx.save();\n    ctx.translate(x + 10 * scale, (from.y + to.y) / 2);\n    ctx.rotate(-Math.PI / 2);\n    ctx.fillText(text, -ctx.measureText(text).width / 2, 0);\n    ctx.restore();\n  }\n  \n  ctx.restore();\n}\n\n/**\n * 绘制箭头\n */\nfunction drawArrow(\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  direction: \"left\" | \"right\" | \"up\" | \"down\",\n  scale: number\n) {\n  const size = 3 * scale;\n  ctx.beginPath();\n  \n  switch (direction) {\n    case \"left\":\n      ctx.moveTo(x, y);\n      ctx.lineTo(x + size, y - size / 2);\n      ctx.lineTo(x + size, y + size / 2);\n      break;\n    case \"right\":\n      ctx.moveTo(x, y);\n      ctx.lineTo(x - size, y - size / 2);\n      ctx.lineTo(x - size, y + size / 2);\n      break;\n    case \"up\":\n      ctx.moveTo(x, y);\n      ctx.lineTo(x - size / 2, y + size);\n      ctx.lineTo(x + size / 2, y + size);\n      break;\n    case \"down\":\n      ctx.moveTo(x, y);\n      ctx.lineTo(x - size / 2, y - size);\n      ctx.lineTo(x + size / 2, y - size);\n      break;\n  }\n  \n  ctx.closePath();\n  ctx.fill();\n}\n\n/**\n * 格式化尺寸文字\n */\nfunction formatDimensionText(dim: DimensionSpec): string {\n  let text = \"\";\n  \n  if (dim.prefix) text += dim.prefix;\n  if (dim.isReference) text += \"(\";\n  \n  text += dim.value.toFixed(dim.type === \"angular\" ? 0 : 2);\n  \n  if (dim.tolerance) {\n    if (dim.tolerance.type === \"symmetric\" && dim.tolerance.symmetric) {\n      text += ` ±${dim.tolerance.symmetric}`;\n    } else if (dim.tolerance.type === \"deviation\") {\n      text += ` +${dim.tolerance.upper}/-${Math.abs(dim.tolerance.lower || 0)}`;\n    }\n  }\n  \n  if (dim.isReference) text += \")\";\n  if (dim.suffix) text += dim.suffix;\n  \n  return text;\n}\n\n/**\n * 绘制标题栏\n */\nfunction drawTitleBlock(\n  ctx: CanvasRenderingContext2D,\n  titleBlock: SpringDrawingSpec[\"titleBlock\"],\n  width: number,\n  height: number,\n  scale: number\n) {\n  const blockWidth = 180 * scale;\n  const blockHeight = 50 * scale;\n  const x = width - blockWidth - 15 * scale;\n  const y = height - blockHeight - 15 * scale;\n  \n  ctx.strokeStyle = COLORS.titleBlock;\n  ctx.fillStyle = COLORS.titleBlock;\n  ctx.lineWidth = 1;\n  \n  // 外框\n  ctx.strokeRect(x, y, blockWidth, blockHeight);\n  \n  // 分隔线\n  ctx.beginPath();\n  ctx.moveTo(x, y + blockHeight / 2);\n  ctx.lineTo(x + blockWidth, y + blockHeight / 2);\n  ctx.moveTo(x + blockWidth / 2, y);\n  ctx.lineTo(x + blockWidth / 2, y + blockHeight);\n  ctx.stroke();\n  \n  // 文字\n  ctx.font = `bold ${8 * scale}px Arial`;\n  ctx.fillText(titleBlock.partName, x + 5 * scale, y + 12 * scale);\n  \n  ctx.font = `${6 * scale}px Arial`;\n  if (titleBlock.partNameZh) {\n    ctx.fillText(titleBlock.partNameZh, x + 5 * scale, y + 22 * scale);\n  }\n  \n  ctx.fillText(`Part No: ${titleBlock.partNumber}`, x + blockWidth / 2 + 5 * scale, y + 12 * scale);\n  ctx.fillText(`Material: ${titleBlock.material}`, x + blockWidth / 2 + 5 * scale, y + 22 * scale);\n  \n  ctx.fillText(`Scale: ${titleBlock.scale}`, x + 5 * scale, y + blockHeight / 2 + 12 * scale);\n  ctx.fillText(`Drawn: ${titleBlock.drawnBy}`, x + 5 * scale, y + blockHeight / 2 + 22 * scale);\n  ctx.fillText(`Date: ${titleBlock.drawnDate}`, x + blockWidth / 2 + 5 * scale, y + blockHeight / 2 + 12 * scale);\n}\n\n/**\n * 绘制技术要求\n */\nfunction drawTechnicalNotes(\n  ctx: CanvasRenderingContext2D,\n  notes: SpringDrawingSpec[\"technicalNotes\"],\n  width: number,\n  height: number,\n  scale: number\n) {\n  const x = 20 * scale;\n  let y = height - 80 * scale;\n  \n  ctx.fillStyle = COLORS.titleBlock;\n  ctx.font = `bold ${8 * scale}px Arial`;\n  ctx.fillText(\"Technical Notes / 技术要求:\", x, y);\n  \n  ctx.font = `${6 * scale}px Arial`;\n  y += 12 * scale;\n  \n  for (const note of notes.slice(0, 5)) {\n    const text = `${note.index}. ${note.textEn}`;\n    ctx.fillText(text, x, y);\n    y += 10 * scale;\n  }\n}\n\nexport default EngineeringDrawingCanvas;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/engineering/die-spring/DieSpringEngineeringPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/engineering/rules-visualizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowRight' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { LanguageText } from \"@/components/language-context\";\nimport { ArrowRight, Ruler, Scale, Activity, ShieldCheck } from \"lucide-react\";\n\nexport function RulesVisualizer() {\n  const steps = [\n    {\n      icon: Ruler,\n      title: { en: \"Geometry (V1)\", zh: \"几何校验 (V1)\" },\n      desc: { \n        en: \"Physical constraints, manufacturing ratios (Index, aspect ratio), and coil bind gaps.\",\n        zh: \"物理约束、制造比例（旋绕比、高径比）与并紧间隙。\"\n      },\n      color: \"text-blue-600\",\n      bg: \"bg-blue-50\",\n      border: \"border-blue-200\"\n    },\n    {\n      icon: Scale,\n      title: { en: \"Load & Stress (V2)\", zh: \"载荷与应力 (V2)\" },\n      desc: {\n        en: \"Corrected stress (Wahl), static safety factor, and setting loss risks.\",\n        zh: \"修正应力（Wahl）、静态安全系数与松弛风险。\"\n      },\n      color: \"text-purple-600\",\n      bg: \"bg-purple-50\",\n      border: \"border-purple-200\"\n    },\n    {\n      icon: Activity,\n      title: { en: \"Fatigue Life\", zh: \"疲劳寿命\" },\n      desc: {\n        en: \"Goodman diagrams, S-N curves, and cycle life prediction reliability.\",\n        zh: \"Goodman 图、S-N 曲线与循环寿命预测可靠性。\"\n      },\n      color: \"text-amber-600\",\n      bg: \"bg-amber-50\",\n      border: \"border-amber-200\"\n    },\n    {\n      icon: ShieldCheck,\n      title: { en: \"Quality Risk\", zh: \"质量风险\" },\n      desc: {\n        en: \"Process capability (Cpk) estimation based on tolerance class.\",\n        zh: \"基于公差等级的过程能力（Cpk）预估。\"\n      },\n      color: \"text-emerald-600\",\n      bg: \"bg-emerald-50\",\n      border: \"border-emerald-200\"\n    }\n  ];\n\n  return (\n    <div className=\"relative\">\n      {/* Connector Line (Desktop) */}\n      <div className=\"absolute top-8 left-0 hidden w-full -translate-y-1/2 md:block\">\n        <div className=\"h-0.5 w-full border-t-2 border-dashed border-muted-foreground/30\" />\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-4\">\n        {steps.map((step, i) => {\n          const Icon = step.icon;\n          return (\n            <div key={i} className=\"relative z-10 flex flex-col items-center text-center\">\n              <div\n                className={`flex h-16 w-16 items-center justify-center rounded-2xl border-2 ${step.bg} ${step.border} shadow-sm transition-transform hover:scale-105`}\n              >\n                <Icon className={`h-8 w-8 ${step.color}`} />\n              </div>\n              <h3 className=\"mt-4 font-semibold text-foreground\">\n                <LanguageText en={step.title.en} zh={step.title.zh} />\n              </h3>\n              <p className=\"mt-2 text-sm text-muted-foreground\">\n                <LanguageText en={step.desc.en} zh={step.desc.zh} />\n              </p>\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/force-tester/UnifiedForceTester.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardDescription' is defined but never used.","line":4,"column":52,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":67},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CurrentPointCard' is defined but never used.","line":15,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringAnalysisResult' is defined but never used.","line":24,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ForceDeflectionPoint' is defined but never used.","line":25,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":23},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/force-tester/UnifiedForceTester.tsx:129:5\n  127 |   // Reset deflection when geometry changes\n  128 |   useEffect(() => {\n> 129 |     setCurrentDeflection(0);\n      |     ^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  130 |     setLinearDeflection(0);\n  131 |   }, [geometry, setLinearDeflection]);\n  132 |","line":129,"column":5,"nodeType":null,"endLine":129,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState, useMemo, useCallback, useEffect } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useLanguage } from \"@/components/language-context\";\nimport { cn } from \"@/lib/utils\";\n\nimport {\n  InteractiveForceChart,\n  SpringForceTable,\n  SpringDeflectionSlider,\n  CurrentPointCard,\n  SNcurveChart,\n  StressDeflectionChart,\n} from \"@/components/charts\";\n\nimport { SpringAnalysisEngine } from \"@/lib/engine/SpringAnalysisEngine\";\nimport type {\n  SpringGeometry,\n  WorkingConditions,\n  SpringAnalysisResult,\n  ForceDeflectionPoint,\n} from \"@/lib/engine/types\";\nimport { getSpringMaterial } from \"@/lib/materials/springMaterials\";\nimport { useSpringSimulationStore } from \"@/lib/stores/springSimulationStore\";\n\ninterface UnifiedForceTesterProps {\n  /** Spring geometry */\n  geometry: SpringGeometry;\n  /** Working conditions */\n  workingConditions: WorkingConditions;\n  /** 3D visualization component */\n  visualizer?: React.ReactNode;\n  /** Callback when deflection changes */\n  onDeflectionChange?: (deflection: number) => void;\n  /** Callback for CAD export */\n  onExportCAD?: () => void;\n  /** Callback for PDF report */\n  onExportPDF?: () => void;\n  /** Additional class name */\n  className?: string;\n}\n\n/**\n * Unified Force Tester Component\n * 统一力-位移测试组件\n * \n * Provides consistent UI for all spring types:\n * - Compression springs\n * - Extension springs\n * - Torsion springs\n * - Conical springs\n */\nexport function UnifiedForceTester({\n  geometry,\n  workingConditions,\n  visualizer,\n  onDeflectionChange,\n  onExportCAD,\n  onExportPDF,\n  className,\n}: UnifiedForceTesterProps) {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n\n  // Current deflection state\n  const [currentDeflection, setCurrentDeflection] = useState(0);\n\n  // Run analysis\n  const analysisResult = useMemo(() => {\n    try {\n      return SpringAnalysisEngine.analyze(geometry, workingConditions);\n    } catch (error) {\n      console.error(\"Analysis error:\", error);\n      return null;\n    }\n  }, [geometry, workingConditions]);\n\n  // Get material info\n  const material = useMemo(() => {\n    return getSpringMaterial(geometry.materialId);\n  }, [geometry.materialId]);\n\n  // Current state at deflection\n  const currentState = useMemo(() => {\n    if (!analysisResult) return null;\n    \n    const point = analysisResult.forceCurve.find(\n      (p) => Math.abs(p.deflection - currentDeflection) < 0.01\n    ) || analysisResult.forceCurve.reduce((prev, curr) =>\n      Math.abs(curr.deflection - currentDeflection) < Math.abs(prev.deflection - currentDeflection)\n        ? curr\n        : prev\n    );\n\n    return {\n      deflection: currentDeflection,\n      force: point?.force ?? 0,\n      stiffness: point?.stiffness ?? analysisResult.springRate,\n      stress: point?.stress ?? 0,\n      activeCoils: point?.activeCoils,\n      collapsedCoils: point?.collapsedCoils,\n    };\n  }, [analysisResult, currentDeflection]);\n\n  // Get store actions for syncing deflection\n  const setStoreDeflection = useSpringSimulationStore((state) => state.setDeflection);\n  const setLinearDeflection = useSpringSimulationStore((state) => state.setLinearDeflection);\n  const storeMode = useSpringSimulationStore((state) => state.mode);\n\n  // Handle deflection change\n  const handleDeflectionChange = useCallback((value: number) => {\n    setCurrentDeflection(value);\n    onDeflectionChange?.(value);\n    \n    // Sync with store for 3D visualization\n    if (storeMode === \"conical-nonlinear\") {\n      setStoreDeflection(value);\n    } else {\n      setLinearDeflection(value);\n    }\n  }, [onDeflectionChange, storeMode, setStoreDeflection, setLinearDeflection]);\n\n  // Reset deflection when geometry changes\n  useEffect(() => {\n    setCurrentDeflection(0);\n    setLinearDeflection(0);\n  }, [geometry, setLinearDeflection]);\n\n  // Format helpers\n  const formatNumber = (n: number, decimals = 2) =>\n    Number(n.toFixed(decimals)).toLocaleString();\n\n  const formatCycles = (n: number) => {\n    if (!isFinite(n)) return \"∞\";\n    if (n >= 1e7) return `${(n / 1e6).toFixed(1)}M`;\n    if (n >= 1e6) return `${(n / 1e6).toFixed(2)}M`;\n    if (n >= 1e3) return `${(n / 1e3).toFixed(1)}k`;\n    return n.toString();\n  };\n\n  const getSafetyColor = (status: \"safe\" | \"warning\" | \"danger\") => {\n    switch (status) {\n      case \"safe\": return \"bg-green-500\";\n      case \"warning\": return \"bg-amber-500\";\n      case \"danger\": return \"bg-red-500\";\n    }\n  };\n\n  // Get spring type label\n  const getSpringTypeLabel = () => {\n    switch (geometry.type) {\n      case \"compression\": return isZh ? \"压缩弹簧\" : \"Compression Spring\";\n      case \"extension\": return isZh ? \"拉伸弹簧\" : \"Extension Spring\";\n      case \"torsion\": return isZh ? \"扭转弹簧\" : \"Torsion Spring\";\n      case \"conical\": return isZh ? \"锥形弹簧\" : \"Conical Spring\";\n    }\n  };\n\n  // Get deflection label based on spring type\n  const getDeflectionLabel = () => {\n    if (geometry.type === \"torsion\") {\n      return { en: \"Rotation Angle (°)\", zh: \"扭转角度 (°)\" };\n    }\n    if (geometry.type === \"extension\") {\n      return { en: \"Extension Δx (mm)\", zh: \"伸长量 Δx (mm)\" };\n    }\n    return { en: \"Deflection Δx (mm)\", zh: \"压缩量 Δx (mm)\" };\n  };\n\n  // Get force label based on spring type\n  const getForceLabel = () => {\n    if (geometry.type === \"torsion\") {\n      return { en: \"Torque (N·mm)\", zh: \"扭矩 (N·mm)\" };\n    }\n    return { en: \"Force (N)\", zh: \"载荷 (N)\" };\n  };\n\n  if (!analysisResult) {\n    return (\n      <Card className={className}>\n        <CardContent className=\"flex items-center justify-center h-64\">\n          <p className=\"text-muted-foreground\">\n            {isZh ? \"分析计算中...\" : \"Analyzing...\"}\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const deflectionLabel = getDeflectionLabel();\n  const forceLabel = getForceLabel();\n\n  return (\n    <div className={cn(\"space-y-6\", className)}>\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-xl font-semibold\">\n            {isZh ? \"力-位移测试\" : \"Force-Deflection Tester\"}\n          </h2>\n          <p className=\"text-sm text-muted-foreground\">\n            {getSpringTypeLabel()} • {material?.nameZh || material?.nameEn}\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          {onExportCAD && (\n            <Button variant=\"outline\" size=\"sm\" onClick={onExportCAD}>\n              {isZh ? \"CAD 导出\" : \"CAD Export\"}\n            </Button>\n          )}\n          {onExportPDF && (\n            <Button variant=\"outline\" size=\"sm\" onClick={onExportPDF}>\n              {isZh ? \"PDF 报告\" : \"PDF Report\"}\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {/* Main Content Grid */}\n      <div className=\"grid gap-6 lg:grid-cols-[1fr,320px]\">\n        {/* Left Column - Charts and Controls */}\n        <div className=\"space-y-4\">\n          {/* Deflection Slider */}\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"位移控制\" : \"Deflection Control\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <SpringDeflectionSlider\n                min={workingConditions.minDeflection}\n                max={workingConditions.maxDeflection}\n                value={currentDeflection}\n                onChange={handleDeflectionChange}\n                labelEn={deflectionLabel.en}\n                labelZh={deflectionLabel.zh}\n              />\n            </CardContent>\n          </Card>\n\n          {/* 3D Visualization + Current State */}\n          <div className=\"grid gap-4 md:grid-cols-[1fr,160px]\">\n            {/* 3D View */}\n            <Card className=\"overflow-hidden\">\n              <div className=\"h-[420px] bg-slate-50\">\n                {visualizer || (\n                  <div className=\"flex items-center justify-center h-full text-slate-500 text-sm\">\n                    {isZh ? \"3D 视图\" : \"3D View\"}\n                  </div>\n                )}\n              </div>\n            </Card>\n\n            {/* Current State Panel - Compact */}\n            <Card className=\"bg-slate-50 h-fit\">\n              <CardHeader className=\"pb-1 pt-3 px-3\">\n                <CardTitle className=\"text-xs font-medium text-muted-foreground\">\n                  {isZh ? \"当前状态\" : \"Current State\"}\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-2 text-sm px-3 pb-3\">\n                <div className=\"flex justify-between items-baseline\">\n                  <span className=\"text-xs text-muted-foreground\">Δx</span>\n                  <span className=\"font-semibold text-blue-600\">\n                    {formatNumber(currentDeflection)} {geometry.type === \"torsion\" ? \"°\" : \"mm\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between items-baseline\">\n                  <span className=\"text-xs text-muted-foreground\">\n                    {geometry.type === \"torsion\" ? \"M\" : \"F\"}\n                  </span>\n                  <span className=\"font-semibold text-green-600\">\n                    {formatNumber(currentState?.force ?? 0)} {geometry.type === \"torsion\" ? \"N·mm\" : \"N\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between items-baseline\">\n                  <span className=\"text-xs text-muted-foreground\">k</span>\n                  <span className=\"font-medium\">\n                    {formatNumber(currentState?.stiffness ?? 0)} {geometry.type === \"torsion\" ? \"N·mm/°\" : \"N/mm\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between items-baseline\">\n                  <span className=\"text-xs text-muted-foreground\">\n                    {geometry.type === \"torsion\" ? \"σ\" : \"τ\"}\n                  </span>\n                  <span className=\"font-medium text-purple-600\">\n                    {formatNumber(currentState?.stress ?? 0)} MPa\n                  </span>\n                </div>\n                {currentState?.activeCoils !== undefined && (\n                  <>\n                    <div className=\"border-t pt-2 flex justify-between items-baseline\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {isZh ? \"有效圈\" : \"Active\"}\n                      </span>\n                      <span className=\"font-medium\">{currentState.activeCoils}</span>\n                    </div>\n                    <div className=\"flex justify-between items-baseline\">\n                      <span className=\"text-xs text-muted-foreground\">\n                        {isZh ? \"贴底圈\" : \"Collapsed\"}\n                      </span>\n                      <span className=\"font-medium text-slate-500\">\n                        {currentState.collapsedCoils ?? 0}\n                      </span>\n                    </div>\n                  </>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Charts Tabs */}\n          <Card>\n            <CardContent className=\"pt-4\">\n              <Tabs defaultValue=\"force\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-3\">\n                  <TabsTrigger value=\"force\">\n                    {isZh ? \"力-位移\" : \"F-Δx\"}\n                  </TabsTrigger>\n                  <TabsTrigger value=\"stress\">\n                    {isZh ? \"应力\" : \"Stress\"}\n                  </TabsTrigger>\n                  <TabsTrigger value=\"fatigue\">\n                    {isZh ? \"S-N 曲线\" : \"S-N Curve\"}\n                  </TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"force\" className=\"pt-4\">\n                  <div className=\"h-[280px]\">\n                    <InteractiveForceChart\n                      data={analysisResult.forceCurve.map((p) => ({\n                        deflection: p.deflection,\n                        load: p.force,\n                      }))}\n                      currentDeflection={currentDeflection}\n                      onDeflectionChange={handleDeflectionChange}\n                      xAxisLabel={isZh ? deflectionLabel.zh : deflectionLabel.en}\n                      yAxisLabel={isZh ? forceLabel.zh : forceLabel.en}\n                      lineColor=\"#3b82f6\"\n                      markerColor=\"#ef4444\"\n                      showMarker={true}\n                    />\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"stress\" className=\"pt-4\">\n                  <StressDeflectionChart\n                    data={analysisResult.forceCurve}\n                    currentDeflection={currentDeflection}\n                    allowableStress={analysisResult.safety.allowableStress}\n                    height={280}\n                    xAxisLabel={isZh ? deflectionLabel.zh : deflectionLabel.en}\n                  />\n                </TabsContent>\n\n                <TabsContent value=\"fatigue\" className=\"pt-4\">\n                  {analysisResult.fatigue.snCurveData && (\n                    <SNcurveChart\n                      curveData={analysisResult.fatigue.snCurveData}\n                      currentPoint={{\n                        cycles: analysisResult.fatigue.estimatedCycles,\n                        stress: analysisResult.fatigue.tauAlt,\n                      }}\n                      enduranceLimit={material?.snCurve.tau2}\n                      height={280}\n                    />\n                  )}\n                </TabsContent>\n              </Tabs>\n            </CardContent>\n          </Card>\n\n          {/* Force Table */}\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"力-位移数据表\" : \"Force-Deflection Table\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <SpringForceTable\n                data={analysisResult.forceCurve.map((p) => ({\n                  deflection: p.deflection,\n                  load: p.force,\n                }))}\n                currentDeflection={currentDeflection}\n                onRowClick={handleDeflectionChange}\n                maxHeight=\"max-h-48\"\n              />\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Right Column - Analysis Results */}\n        <div className=\"space-y-4\">\n          {/* Safety Summary */}\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm flex items-center justify-between\">\n                <span>{isZh ? \"安全评估\" : \"Safety Assessment\"}</span>\n                <Badge className={cn(\"text-white\", getSafetyColor(analysisResult.safety.status))}>\n                  SF = {formatNumber(analysisResult.safety.staticSafetyFactor)}\n                </Badge>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2 text-sm\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">τ_max</span>\n                <span className=\"font-medium\">{formatNumber(analysisResult.stress.tauEffective)} MPa</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">τ_allow</span>\n                <span>{formatNumber(analysisResult.safety.allowableStress)} MPa</span>\n              </div>\n              <p className=\"text-xs text-muted-foreground pt-1\">\n                {isZh ? analysisResult.safety.message.zh : analysisResult.safety.message.en}\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* Fatigue Summary */}\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm flex items-center justify-between\">\n                <span>{isZh ? \"疲劳寿命\" : \"Fatigue Life\"}</span>\n                <Badge variant=\"outline\">\n                  {formatCycles(analysisResult.fatigue.estimatedCycles)}\n                </Badge>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2 text-sm\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">τ_mean</span>\n                <span>{formatNumber(analysisResult.fatigue.tauMean)} MPa</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">τ_alt</span>\n                <span>{formatNumber(analysisResult.fatigue.tauAlt)} MPa</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">SF_∞</span>\n                <span>{formatNumber(analysisResult.fatigue.infiniteLifeSafetyFactor)}</span>\n              </div>\n              <p className=\"text-xs text-muted-foreground pt-1\">\n                {isZh ? analysisResult.fatigue.message.zh : analysisResult.fatigue.message.en}\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* Buckling (compression only) */}\n          {analysisResult.buckling && (\n            <Card>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm flex items-center justify-between\">\n                  <span>{isZh ? \"屈曲分析\" : \"Buckling\"}</span>\n                  <Badge className={cn(\"text-white\", getSafetyColor(analysisResult.buckling.status))}>\n                    SF = {formatNumber(analysisResult.buckling.bucklingSafetyFactor)}\n                  </Badge>\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">λ</span>\n                  <span>{formatNumber(analysisResult.buckling.slendernessRatio)}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">P_cr</span>\n                  <span>{formatNumber(analysisResult.buckling.criticalLoad)} N</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">P_work</span>\n                  <span>{formatNumber(analysisResult.buckling.workingLoad)} N</span>\n                </div>\n                <p className=\"text-xs text-muted-foreground pt-1\">\n                  {isZh ? analysisResult.buckling.message.zh : analysisResult.buckling.message.en}\n                </p>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Stress Details */}\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"应力修正\" : \"Stress Correction\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-1 text-xs\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">K_w (Wahl)</span>\n                <span>{formatNumber(analysisResult.stress.wahlFactor, 3)}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">K_surface</span>\n                <span>{formatNumber(analysisResult.stress.surfaceFactor, 3)}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">K_size</span>\n                <span>{formatNumber(analysisResult.stress.sizeFactor, 3)}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">K_temp</span>\n                <span>{formatNumber(analysisResult.stress.tempFactor, 3)}</span>\n              </div>\n              <div className=\"flex justify-between font-medium pt-1 border-t\">\n                <span>K_total</span>\n                <span>{formatNumber(analysisResult.stress.totalCorrectionFactor, 3)}</span>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Geometry Summary */}\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm\">\n                {isZh ? \"几何参数\" : \"Geometry\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-1 text-xs\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">C (index)</span>\n                <span>{formatNumber(analysisResult.geometry.springIndex)}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">Dm</span>\n                <span>{formatNumber(analysisResult.geometry.meanDiameter)} mm</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">d</span>\n                <span>{formatNumber(analysisResult.geometry.wireDiameter)} mm</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">Na</span>\n                <span>{analysisResult.geometry.activeCoils}</span>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-muted-foreground\">Nt</span>\n                <span>{analysisResult.geometry.totalCoils}</span>\n              </div>\n              {analysisResult.geometry.solidHeight && (\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Hs</span>\n                  <span>{formatNumber(analysisResult.geometry.solidHeight)} mm</span>\n                </div>\n              )}\n              <div className=\"flex justify-between font-medium pt-1 border-t\">\n                <span>k</span>\n                <span>{formatNumber(analysisResult.springRate)} {geometry.type === \"torsion\" ? \"N·mm/°\" : \"N/mm\"}</span>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Warnings */}\n          {analysisResult.warnings.length > 0 && (\n            <Card className=\"border-amber-200 bg-amber-50\">\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-sm text-amber-700\">\n                  {isZh ? \"警告\" : \"Warnings\"}\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <ul className=\"text-xs text-amber-600 space-y-1\">\n                  {analysisResult.warnings.map((w, i) => (\n                    <li key={i}>⚠ {w}</li>\n                  ))}\n                </ul>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/force-tester/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/home/HomeRiskRadar.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/home/HomeRiskRadar.tsx:140:5\n  138 |\n  139 |   useEffect(() => {\n> 140 |     setMounted(true);\n      |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  141 |   }, []);\n  142 |\n  143 |   const radar = useMemo((): EngineeringRiskRadar => {","line":140,"column":5,"nodeType":null,"endLine":140,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\n\nimport {\n  PolarAngleAxis,\n  PolarGrid,\n  PolarRadiusAxis,\n  Radar,\n  RadarChart,\n  ResponsiveContainer,\n  Tooltip,\n} from \"recharts\";\n\nimport type { DesignRuleReport } from \"@/lib/designRules\";\nimport {\n  buildCompressionRiskRadar,\n  buildConicalRiskRadar,\n  buildExtensionRiskRadar,\n  buildSpiralRiskRadar,\n  buildTorsionRiskRadar,\n  radarFromDesignRuleReport,\n} from \"@/lib/riskRadar\";\nimport type { EngineeringRiskRadar, RadarOverallStatus } from \"@/lib/riskRadar\";\nimport { useSpringDesignStore } from \"@/lib/stores/springDesignStore\";\n\nimport { LanguageText, useLanguage } from \"@/components/language-context\";\n\nfunction overallStatusLabel(status: RadarOverallStatus): { en: string; zh: string } {\n  switch (status) {\n    case \"ENGINEERING_OK\":\n      return { en: \"Engineering OK\", zh: \"工程通过\" };\n    case \"MANUFACTURING_RISK\":\n      return { en: \"Manufacturing Risk\", zh: \"制造风险\" };\n    case \"HIGH_RISK\":\n      return { en: \"High Risk\", zh: \"高风险\" };\n  }\n}\n\nfunction springTypeLabel(geometryType: string | null | undefined): { en: string; zh: string } {\n  switch (geometryType) {\n    case \"compression\":\n      return { en: \"Compression Spring\", zh: \"压缩弹簧\" };\n    case \"extension\":\n      return { en: \"Extension Spring\", zh: \"拉伸弹簧\" };\n    case \"torsion\":\n      return { en: \"Torsion Spring\", zh: \"扭转弹簧\" };\n    case \"conical\":\n      return { en: \"Conical Spring\", zh: \"圆锥弹簧\" };\n    case \"spiralTorsion\":\n      return { en: \"Spiral Torsion Spring\", zh: \"螺旋扭簧\" };\n    default:\n      return { en: \"Unknown Spring\", zh: \"未知弹簧\" };\n  }\n}\n\nfunction overallStatusTone(status: RadarOverallStatus): { bg: string; text: string; border: string } {\n  switch (status) {\n    case \"ENGINEERING_OK\":\n      return { bg: \"bg-emerald-50\", text: \"text-emerald-700\", border: \"border-emerald-200\" };\n    case \"MANUFACTURING_RISK\":\n      return { bg: \"bg-amber-50\", text: \"text-amber-700\", border: \"border-amber-200\" };\n    case \"HIGH_RISK\":\n      return { bg: \"bg-rose-50\", text: \"text-rose-700\", border: \"border-rose-200\" };\n  }\n}\n\nfunction dimensionBadgeTone(status: \"OK\" | \"WARN\" | \"FAIL\"): { bg: string; text: string; border: string } {\n  switch (status) {\n    case \"OK\":\n      return { bg: \"bg-emerald-50\", text: \"text-emerald-700\", border: \"border-emerald-200\" };\n    case \"WARN\":\n      return { bg: \"bg-amber-50\", text: \"text-amber-700\", border: \"border-amber-200\" };\n    case \"FAIL\":\n      return { bg: \"bg-rose-50\", text: \"text-rose-700\", border: \"border-rose-200\" };\n  }\n}\n\nfunction buildDemoRadar(): EngineeringRiskRadar {\n  const report: DesignRuleReport = {\n    summary: { status: \"OK\" },\n    metrics: {},\n    findings: [\n      {\n        id: \"COMP_SPRING_INDEX_LOW\",\n        level: \"warning\",\n        titleEn: \"Spring index is low\",\n        titleZh: \"旋绕比偏低\",\n        detailEn: \"C is near lower limit.\",\n        detailZh: \"旋绕比 C 接近下限。\",\n      },\n      {\n        id: \"COMP_COIL_BIND_MARGIN_LOW\",\n        level: \"warning\",\n        titleEn: \"Coil bind margin is low\",\n        titleZh: \"贴圈余量偏小\",\n        detailEn: \"Clearance to solid height is small.\",\n        detailZh: \"并紧余量偏小。\",\n      },\n      {\n        id: \"COMP_PITCH_EST_TIGHT\",\n        level: \"warning\",\n        titleEn: \"Pitch estimate is tight\",\n        titleZh: \"估算节距偏紧\",\n        detailEn: \"Pitch/spacing may be difficult to manufacture.\",\n        detailZh: \"节距/间隙可能偏难制造。\",\n      },\n      {\n        id: \"COMP_READ_ONLY_WARN_READ_ONLY\",\n        level: \"warning\",\n        titleEn: \"Quality exposure requires review\",\n        titleZh: \"质量风险需复核\",\n        detailEn: \"Validate tolerance / inspection plan before release.\",\n        detailZh: \"发布前建议复核公差/检验方案。\",\n      },\n      {\n        id: \"COMP_RULES_READ_ONLY\",\n        level: \"info\",\n        titleEn: \"Rules are read-only\",\n        titleZh: \"规则为只读旁路\",\n        detailEn: \"This panel evaluates inputs/results and does not change geometry, calculation, or 3D.\",\n        detailZh: \"该面板仅分析输入与结果，不会修改几何/计算/3D。\",\n      },\n    ],\n  };\n\n  return radarFromDesignRuleReport({ springType: \"compression\", report });\n}\n\nexport function HomeRiskRadar() {\n  const { language } = useLanguage();\n  const [mounted, setMounted] = useState(false);\n\n  const geometry = useSpringDesignStore((s) => s.geometry);\n  const analysisResult = useSpringDesignStore((s) => s.analysisResult);\n  const eds = useSpringDesignStore((s) => s.eds);\n  const resolved = useSpringDesignStore((s) => s.resolved);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const radar = useMemo((): EngineeringRiskRadar => {\n    if (!geometry) return buildDemoRadar();\n\n    if (geometry.type === \"compression\") {\n      const compressionEds = eds?.type === \"compression\" ? eds : null;\n      const compressionResolved =\n        resolved?.type === \"compression\"\n          ? {\n              design: resolved.design,\n              issues: resolved.issues,\n            }\n          : null;\n\n      return buildCompressionRiskRadar({\n        eds: compressionEds,\n        resolved: compressionResolved,\n        analysisResult,\n      });\n    }\n\n    if (geometry.type === \"extension\") {\n      return buildExtensionRiskRadar({\n        geometry,\n        analysisResult,\n      });\n    }\n\n    if (geometry.type === \"torsion\") {\n      return buildTorsionRiskRadar({\n        geometry,\n        analysisResult,\n      });\n    }\n\n    if (geometry.type === \"conical\") {\n      return buildConicalRiskRadar({\n        geometry,\n        analysisResult,\n      });\n    }\n\n    if (geometry.type === \"spiralTorsion\") {\n      return buildSpiralRiskRadar({\n        geometry,\n        analysisResult,\n      });\n    }\n\n    return buildDemoRadar();\n  }, [geometry, analysisResult, eds, resolved]);\n\n  const isDemo = !geometry;\n  const currentSpringTypeLabel = useMemo(() => {\n    if (!geometry) return null;\n    return springTypeLabel(geometry.type);\n  }, [geometry]);\n\n  const chartData = useMemo(() => {\n    const labels =\n      language === \"en\"\n        ? { engineering: \"Engineering\", manufacturing: \"Manufacturing\", quality: \"Quality\" }\n        : { engineering: \"工程\", manufacturing: \"制造\", quality: \"质量\" };\n\n    return [\n      { subject: labels.engineering, score: radar.dimensions.engineering.score, fullMark: 100 },\n      { subject: labels.manufacturing, score: radar.dimensions.manufacturing.score, fullMark: 100 },\n      { subject: labels.quality, score: radar.dimensions.quality.score, fullMark: 100 },\n    ];\n  }, [language, radar]);\n\n  const overallTone = overallStatusTone(radar.overallStatus);\n  const overallLabel = overallStatusLabel(radar.overallStatus);\n\n  const keyFindings = useMemo(() => {\n    const rank = (level: EngineeringRiskRadar[\"findings\"][number][\"level\"]) =>\n      level === \"ERROR\" ? 2 : level === \"WARNING\" ? 1 : 0;\n\n    return radar.findings\n      .filter((f) => f.level !== \"INFO\")\n      .slice()\n      .sort((a, b) => rank(b.level) - rank(a.level))\n      .slice(0, 3);\n  }, [radar]);\n\n  if (!mounted) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-2xl border bg-muted/20 p-5 text-sm text-muted-foreground\">\n        Loading...\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"rounded-2xl border bg-muted/20 p-5\">\n      <div className=\"flex items-start justify-between gap-4\">\n        <div>\n          <p className=\"text-sm font-semibold\">\n            <LanguageText\n              en={isDemo ? \"Radar demo\" : `Radar (live: ${currentSpringTypeLabel?.en ?? \"Unknown Spring\"})`}\n              zh={isDemo ? \"雷达示例\" : `雷达（当前设计：${currentSpringTypeLabel?.zh ?? \"未知弹簧\"}）`}\n            />\n          </p>\n          <p className=\"mt-1 text-sm text-muted-foreground\">\n            <LanguageText\n              en={\n                isDemo\n                  ? \"Showing a demo radar. Run a calculator to see live risk.\"\n                  : `Built from the current ${currentSpringTypeLabel?.en ?? \"spring\"} in SpringDesignStore.`\n              }\n              zh={\n                isDemo\n                  ? \"当前显示示例雷达。请在任一计算器计算后查看实时风险。\"\n                  : `基于 SpringDesignStore 的当前设计（${currentSpringTypeLabel?.zh ?? \"未知弹簧\"}）生成。`\n              }\n            />\n          </p>\n        </div>\n\n        <div\n          className={`rounded-full border px-3 py-1 text-sm font-semibold ${overallTone.bg} ${overallTone.text} ${overallTone.border}`}\n        >\n          <LanguageText en={`Score: ${radar.summary.score}`} zh={`得分：${radar.summary.score}`} />\n        </div>\n      </div>\n\n      <div className=\"mt-4 grid gap-3\">\n        <div className=\"rounded-xl border bg-background/70 p-4\">\n          <p className=\"text-xs font-semibold uppercase tracking-[0.22em] text-muted-foreground\">\n            <LanguageText en=\"Overall\" zh=\"总体\" />\n          </p>\n          <p className=\"mt-1 text-base font-semibold\">\n            <LanguageText en={overallLabel.en} zh={overallLabel.zh} />\n          </p>\n\n          <div className=\"mt-4 h-52 w-full\">\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\n              <RadarChart data={chartData} margin={{ top: 8, right: 16, bottom: 8, left: 16 }}>\n                <PolarGrid stroke=\"#e2e8f0\" />\n                <PolarAngleAxis dataKey=\"subject\" tick={{ fontSize: 12 }} />\n                <PolarRadiusAxis domain={[0, 100]} tick={{ fontSize: 11 }} />\n                <Tooltip\n                  formatter={(value: number) => [Number(value).toFixed(0), language === \"en\" ? \"Score\" : \"得分\"]}\n                />\n                <Radar\n                  dataKey=\"score\"\n                  stroke={radar.overallStatus === \"HIGH_RISK\" ? \"#e11d48\" : radar.overallStatus === \"MANUFACTURING_RISK\" ? \"#f59e0b\" : \"#10b981\"}\n                  fill={radar.overallStatus === \"HIGH_RISK\" ? \"#fb7185\" : radar.overallStatus === \"MANUFACTURING_RISK\" ? \"#fbbf24\" : \"#34d399\"}\n                  fillOpacity={0.35}\n                />\n              </RadarChart>\n            </ResponsiveContainer>\n          </div>\n\n          <div className=\"mt-4 grid gap-2 text-sm\">\n            {(\n              [\n                {\n                  key: \"engineering\" as const,\n                  label: <LanguageText en=\"Engineering\" zh=\"工程\" />,\n                  status: radar.dimensions.engineering.status,\n                },\n                {\n                  key: \"manufacturing\" as const,\n                  label: <LanguageText en=\"Manufacturing\" zh=\"制造\" />,\n                  status: radar.dimensions.manufacturing.status,\n                },\n                {\n                  key: \"quality\" as const,\n                  label: <LanguageText en=\"Quality\" zh=\"质量\" />,\n                  status: radar.dimensions.quality.status,\n                },\n              ] as const\n            ).map((row) => {\n              const tone = dimensionBadgeTone(row.status);\n              return (\n                <div key={row.key} className=\"flex items-center justify-between gap-4\">\n                  <span className=\"text-muted-foreground\">{row.label}</span>\n                  <span className={`rounded-full border px-2 py-0.5 text-xs font-semibold ${tone.bg} ${tone.text} ${tone.border}`}>\n                    {row.status}\n                  </span>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n\n        <div className=\"rounded-xl border bg-background/70 p-4\">\n          <p className=\"text-xs font-semibold uppercase tracking-[0.22em] text-muted-foreground\">\n            <LanguageText en=\"Key risks\" zh=\"关键风险\" />\n          </p>\n          <div className=\"mt-2 space-y-2 text-sm\">\n            {keyFindings.length === 0 ? (\n              <p className=\"text-muted-foreground\">\n                <LanguageText en=\"No notable risks.\" zh=\"暂无显著风险。\" />\n              </p>\n            ) : (\n              keyFindings.map((f, idx) => (\n                <p key={f.ruleId}>\n                  <span className=\"font-semibold\">{idx + 1}.</span>{\" \"}\n                  <LanguageText en={f.title.en} zh={f.title.zh} />\n                </p>\n              ))\n            )}\n          </div>\n        </div>\n\n        <div className=\"rounded-xl border bg-background/70 p-4\">\n          <p className=\"text-xs font-semibold uppercase tracking-[0.22em] text-muted-foreground\">\n            <LanguageText en=\"What makes this different\" zh=\"差异点\" />\n          </p>\n          <div className=\"mt-2 grid gap-2 text-sm text-muted-foreground\">\n            <p>\n              <LanguageText en=\"Calculates + Engineering Risk Radar\" zh=\"不仅计算，更提供工程风险雷达\" />\n            </p>\n            <p>\n              <LanguageText en=\"3D visualization + manufacturing insight\" zh=\"3D 可视化 + 制造可行性洞察\" />\n            </p>\n            <p>\n              <LanguageText en=\"PPAP / DFM ready outputs\" zh=\"面向 PPAP / DFM 的输出\" />\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/home/HoverGlassCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/home/hero-spline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/language-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/main-nav.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LanguageText' is defined but never used.","line":10,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":22},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":51,"column":11,"nodeType":"JSXOpeningElement","endLine":51,"endColumn":69},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":89,"column":19,"nodeType":"JSXOpeningElement","endLine":89,"endColumn":76}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { usePathname, useRouter } from \"next/navigation\";\nimport { MenuIcon } from \"lucide-react\";\n\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport { LanguageText, useLanguage } from \"@/components/language-context\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetTrigger,\n} from \"@/components/ui/sheet\";\n\nconst navItems = [\n  { href: \"/\", label: { en: \"Home\", zh: \"首页\" } },\n  { href: \"/tools/calculator\", label: { en: \"Spring Calculator\", zh: \"弹簧计算\" } },\n  { href: \"/tools/arc-spring\", label: { en: \"Arc Spring\", zh: \"弧形弹簧\" } },\n  {\n    href: \"/tools/variable-pitch-compression\",\n    label: { en: \"Variable Pitch\", zh: \"变节距压缩\" },\n  },\n  { href: \"/tools/analysis\", label: { en: \"Engineering Analysis\", zh: \"工程分析\" } },\n  { href: \"/production\", label: { en: \"Production\", zh: \"生产监控\" } },\n  { href: \"/quality\", label: { en: \"Quality Management\", zh: \"质量管理\" } },\n  { href: \"/tools/cad-export\", label: { en: \"CAD Export\", zh: \"CAD 导出\" } },\n  { href: \"/about\", label: { en: \"About\", zh: \"关于\" } },\n  { href: \"/engineering\", label: { en: \"Engineering\", zh: \"工程核心\" } },\n  { href: \"/rfq\", label: { en: \"RFQ\", zh: \"询价\" } },\n  { href: \"/catalog\", label: { en: \"Catalog\", zh: \"产品目录\" } },\n];\n\nexport function MainNav() {\n  const pathname = usePathname();\n  const router = useRouter();\n  const { language, toggleLanguage } = useLanguage();\n  const [open, setOpen] = useState(false);\n  const isActive = (href: string) => {\n    if (href === \"/\") return pathname === \"/\";\n    return pathname.startsWith(href);\n  };\n\n  return (\n    <header className=\"sticky top-0 z-40 border-b border-slate-200 bg-slate-50/95 backdrop-blur\">\n      <div className=\"mx-auto flex h-16 w-full max-w-6xl items-center justify-between px-4\">\n        <Link href=\"/\" className=\"flex items-center text-base font-semibold tracking-tight\">\n          <img src=\"/logo.png\" alt=\"Logo\" className=\"h-10 w-auto\" />\n          <span className=\"sr-only\">ISRI-SHUANGDI Spring Engineering</span>\n        </Link>\n\n        <nav className=\"hidden items-center gap-4 text-sm font-medium md:flex\">\n          {navItems.map((item) => (\n            <Link\n              key={item.href}\n              href={item.href}\n              className={cn(\n                \"rounded-md px-3 py-2 transition-colors\",\n                isActive(item.href)\n                  ? \"bg-slate-900/5 text-slate-900\"\n                  : \"text-slate-500 hover:text-slate-900\"\n              )}\n            >\n              {language === \"en\" ? item.label.en : item.label.zh}\n            </Link>\n          ))}\n        </nav>\n\n        <div className=\"hidden items-center gap-3 md:flex\">\n          <Button variant=\"outline\" size=\"sm\" onClick={toggleLanguage} className=\"text-xs\">\n            {language === \"en\" ? \"中文\" : \"EN\"}\n          </Button>\n        </div>\n\n        <Sheet open={open} onOpenChange={setOpen}>\n          <SheetTrigger asChild>\n            <Button variant=\"outline\" size=\"icon\" className=\"md:hidden\">\n              <MenuIcon className=\"size-4\" />\n              <span className=\"sr-only\">Toggle navigation</span>\n            </Button>\n          </SheetTrigger>\n          <SheetContent side=\"right\" className=\"w-full max-w-xs\">\n            <SheetHeader>\n              <SheetTitle>\n                <span className=\"flex items-center\">\n                  <img src=\"/logo.png\" alt=\"Logo\" className=\"h-8 w-auto\" />\n                  <span className=\"sr-only\">ISRI-SHUANGDI Spring Engineering</span>\n                </span>\n              </SheetTitle>\n            </SheetHeader>\n            <div className=\"mt-4 flex flex-col gap-2\">\n              {navItems.map((item) => (\n                <Link\n                  key={item.href}\n                  href={item.href}\n                  onClick={(e) => {\n                    e.preventDefault();\n                    setOpen(false);\n                    router.push(item.href);\n                  }}\n                  className={cn(\n                    \"rounded-md px-3 py-2 text-sm font-medium transition-colors\",\n                    isActive(item.href)\n                      ? \"bg-slate-900/5 text-slate-900\"\n                      : \"text-slate-500 hover:text-slate-900\"\n                  )}\n                >\n                  {language === \"en\" ? item.label.en : item.label.zh}\n                </Link>\n              ))}\n            </div>\n            <div className=\"mt-4\">\n              <Button variant=\"outline\" size=\"sm\" onClick={toggleLanguage} className=\"w-full\">\n                {language === \"en\" ? \"切换到中文\" : \"Switch to English\"}\n              </Button>\n            </div>\n          </SheetContent>\n        </Sheet>\n      </div>\n    </header>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/AndonFeed.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/DashboardHeader.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'shifts' is defined but never used.","line":44,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":44,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\n/**\n * Dashboard Header Component\n * 仪表板头部组件\n * \n * 包含筛选器：工厂、产线、班次、时间范围\n */\n\nimport { Factory, RefreshCw } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { TimeRange, PlantConfig, ShiftConfig } from \"@/lib/manufacturing/types\";\nimport { TIME_RANGE_OPTIONS } from \"@/lib/manufacturing/types\";\n\ninterface DashboardHeaderProps {\n  plants: PlantConfig[];\n  shifts: ShiftConfig[];\n  selectedPlantId: string;\n  selectedLineId?: string;\n  selectedShiftId?: string;\n  selectedRange: TimeRange;\n  currentShift?: { id: string; name: string };\n  onPlantChange: (plantId: string) => void;\n  onLineChange: (lineId: string | undefined) => void;\n  onShiftChange: (shiftId: string | undefined) => void;\n  onRangeChange: (range: TimeRange) => void;\n  onRefresh: () => void;\n  autoRefresh: boolean;\n  onAutoRefreshChange: (enabled: boolean) => void;\n  loading?: boolean;\n  lastUpdated?: string;\n}\n\nexport function DashboardHeader({\n  plants,\n  shifts,\n  selectedPlantId,\n  selectedLineId,\n  selectedRange,\n  currentShift,\n  onPlantChange,\n  onLineChange,\n  onRangeChange,\n  onRefresh,\n  autoRefresh,\n  onAutoRefreshChange,\n  loading,\n  lastUpdated,\n}: DashboardHeaderProps) {\n  const selectedPlant = plants.find((p) => p.plantId === selectedPlantId);\n  const lines = selectedPlant?.lines ?? [];\n\n  return (\n    <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n      <div className=\"flex items-center gap-2\">\n        <Factory className=\"h-5 w-5 text-muted-foreground\" />\n        <h1 className=\"text-xl font-semibold\">\n          Production Dashboard / 生产监控\n        </h1>\n        {currentShift && (\n          <Badge variant=\"outline\" className=\"ml-2\">\n            {currentShift.name}\n          </Badge>\n        )}\n      </div>\n\n      <div className=\"flex flex-wrap items-center gap-2\">\n        {/* Plant Selector */}\n        <Select value={selectedPlantId} onValueChange={onPlantChange}>\n          <SelectTrigger className=\"w-[140px] h-9\">\n            <SelectValue placeholder=\"工厂\" />\n          </SelectTrigger>\n          <SelectContent>\n            {plants.map((plant) => (\n              <SelectItem key={plant.plantId} value={plant.plantId}>\n                {plant.name.zh}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n\n        {/* Line Selector */}\n        <Select \n          value={selectedLineId ?? \"all\"} \n          onValueChange={(v) => onLineChange(v === \"all\" ? undefined : v)}\n        >\n          <SelectTrigger className=\"w-[160px] h-9\">\n            <SelectValue placeholder=\"产线\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">全部产线</SelectItem>\n            {lines.map((line) => (\n              <SelectItem key={line.lineId} value={line.lineId}>\n                {line.name.zh}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n\n        {/* Time Range Selector */}\n        <Select value={selectedRange} onValueChange={(v) => onRangeChange(v as TimeRange)}>\n          <SelectTrigger className=\"w-[130px] h-9\">\n            <SelectValue placeholder=\"时间范围\" />\n          </SelectTrigger>\n          <SelectContent>\n            {TIME_RANGE_OPTIONS.map((opt) => (\n              <SelectItem key={opt.value} value={opt.value}>\n                {opt.label.zh}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n\n        {/* Auto Refresh Toggle */}\n        <Button\n          variant={autoRefresh ? \"default\" : \"outline\"}\n          size=\"sm\"\n          className=\"h-9\"\n          onClick={() => onAutoRefreshChange(!autoRefresh)}\n        >\n          <RefreshCw className={`h-4 w-4 mr-1 ${autoRefresh ? \"animate-spin\" : \"\"}`} />\n          {autoRefresh ? \"自动刷新\" : \"手动\"}\n        </Button>\n\n        {/* Manual Refresh */}\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          className=\"h-9\"\n          onClick={onRefresh}\n          disabled={loading}\n        >\n          <RefreshCw className={`h-4 w-4 ${loading ? \"animate-spin\" : \"\"}`} />\n        </Button>\n\n        {/* Last Updated */}\n        {lastUpdated && (\n          <span className=\"text-xs text-muted-foreground hidden sm:inline\">\n            {new Date(lastUpdated).toLocaleTimeString(\"zh-CN\")}\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default DashboardHeader;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/KpiStrip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/MachineStatusGrid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/WorkOrderTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/charts/CycleTimeTrend.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/charts/DowntimePareto.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/charts/ThroughputTrend.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/manufacturing/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/production/CameraMonitorCard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Label' is defined but never used.","line":35,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\n/**\n * Camera Monitor Card Component\n * 摄像头监控卡片组件\n * \n * 用于生产监控的现场画面卡片\n * 支持：本机摄像头、IP Camera (HLS)、演示视频\n */\n\nimport { useState, useRef, useEffect, useCallback } from \"react\";\nimport {\n  Camera,\n  CameraOff,\n  Video,\n  VideoOff,\n  RefreshCw,\n  FlipHorizontal,\n  SwitchCamera,\n  Aperture,\n  AlertTriangle,\n  Lock,\n  Settings,\n} from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\n\nimport { useCameraStream, captureFrame } from \"@/lib/camera\";\nimport type { CaptureMeta, CameraSourceMode, UserRole } from \"@/lib/production/types\";\nimport { hasPermission, CAMERA_SOURCE_LABELS } from \"@/lib/production/types\";\nimport { CaptureGallery } from \"./CaptureGallery\";\n\ninterface CameraMonitorCardProps {\n  lineId?: string;\n  stationId?: string;\n  workOrderId?: string;\n  className?: string;\n  initialMode?: CameraSourceMode;\n}\n\nexport function CameraMonitorCard({\n  lineId,\n  stationId,\n  workOrderId,\n  className = \"\",\n  initialMode = \"local\",\n}: CameraMonitorCardProps) {\n  // Demo role - in production, get from auth context\n  const role: UserRole = \"manager\";\n  const canAccessCamera = hasPermission(role);\n\n  // Camera stream hook\n  const { stream, status, error, devices, start, stop, refreshDevices } = useCameraStream();\n\n  // State\n  const [sourceMode, setSourceMode] = useState<CameraSourceMode>(initialMode);\n  const [selectedDeviceId, setSelectedDeviceId] = useState<string>(\"\");\n  const [facingMode, setFacingMode] = useState<\"user\" | \"environment\">(\"environment\");\n  const [isMirrored, setIsMirrored] = useState(false);\n  const [captures, setCaptures] = useState<CaptureMeta[]>([]);\n  const [hlsUrl, setHlsUrl] = useState(\"\");\n  const [hlsError, setHlsError] = useState<string | null>(null);\n  const [autoCapture, setAutoCapture] = useState(false);\n\n  // Refs\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const hlsVideoRef = useRef<HTMLVideoElement>(null);\n  const demoVideoRef = useRef<HTMLVideoElement>(null);\n\n  // Attach stream to video element\n  useEffect(() => {\n    if (videoRef.current && stream) {\n      videoRef.current.srcObject = stream;\n    }\n  }, [stream]);\n\n  // Handle device selection\n  const handleDeviceChange = useCallback((deviceId: string) => {\n    setSelectedDeviceId(deviceId);\n    if (status === \"live\") {\n      start({ deviceId });\n    }\n  }, [status, start]);\n\n  // Handle facing mode toggle\n  const handleFacingModeToggle = useCallback(() => {\n    const newMode = facingMode === \"user\" ? \"environment\" : \"user\";\n    setFacingMode(newMode);\n    if (status === \"live\") {\n      start({ facingMode: newMode });\n    }\n  }, [facingMode, status, start]);\n\n  // Handle start camera\n  const handleStart = useCallback(() => {\n    if (selectedDeviceId) {\n      start({ deviceId: selectedDeviceId });\n    } else {\n      start({ facingMode });\n    }\n  }, [selectedDeviceId, facingMode, start]);\n\n  // Handle capture\n  const handleCapture = useCallback(async () => {\n    const videoEl = sourceMode === \"local\" ? videoRef.current \n      : sourceMode === \"ip_hls\" ? hlsVideoRef.current \n      : demoVideoRef.current;\n\n    if (!videoEl) return;\n\n    try {\n      const result = await captureFrame(videoEl, { mimeType: \"image/jpeg\", quality: 0.9 });\n      \n      const newCapture: CaptureMeta = {\n        id: crypto.randomUUID(),\n        createdAt: new Date().toISOString(),\n        source: sourceMode,\n        lineId,\n        stationId,\n        workOrderId,\n        width: result.width,\n        height: result.height,\n        mimeType: \"image/jpeg\",\n        dataUrl: result.dataUrl,\n        blob: result.blob,\n      };\n\n      setCaptures((prev) => [newCapture, ...prev]);\n    } catch (err) {\n      console.error(\"Capture failed:\", err);\n    }\n  }, [sourceMode, lineId, stationId, workOrderId]);\n\n  // Handle upload\n  const handleUpload = useCallback(async (item: CaptureMeta) => {\n    if (!item.blob) return;\n\n    try {\n      const formData = new FormData();\n      formData.append(\"file\", item.blob, `capture-${item.id}.jpg`);\n      if (item.lineId) formData.append(\"lineId\", item.lineId);\n      if (item.stationId) formData.append(\"stationId\", item.stationId);\n      if (item.workOrderId) formData.append(\"workOrderId\", item.workOrderId);\n\n      const res = await fetch(\"/api/production/captures\", {\n        method: \"POST\",\n        body: formData,\n      });\n\n      if (res.ok) {\n        const data = await res.json();\n        setCaptures((prev) =>\n          prev.map((c) => (c.id === item.id ? { ...c, url: data.url } : c))\n        );\n      }\n    } catch (err) {\n      console.error(\"Upload failed:\", err);\n    }\n  }, []);\n\n  // Handle delete capture\n  const handleDeleteCapture = useCallback((id: string) => {\n    setCaptures((prev) => prev.filter((c) => c.id !== id));\n  }, []);\n\n  // Handle HLS URL change\n  const handleHlsUrlChange = useCallback((url: string) => {\n    setHlsUrl(url);\n    setHlsError(null);\n  }, []);\n\n  // Handle HLS video error\n  const handleHlsError = useCallback(() => {\n    setHlsError(\"无法播放此视频流。浏览器可能不支持 HLS 格式，请尝试 Demo 模式。\");\n  }, []);\n\n  return (\n    <Card className={className}>\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-base flex items-center gap-2\">\n          <Camera className=\"h-4 w-4\" />\n          Live Camera / 现场画面\n        </CardTitle>\n        <p className=\"text-xs text-muted-foreground\">\n          ⚠️ Demo only - do not capture personal information / 仅用于演示，请勿拍摄个人信息\n        </p>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        <Tabs value={sourceMode} onValueChange={(v) => setSourceMode(v as CameraSourceMode)}>\n          <TabsList className=\"grid w-full grid-cols-3\">\n            <TabsTrigger value=\"local\">{CAMERA_SOURCE_LABELS.local.zh}</TabsTrigger>\n            <TabsTrigger value=\"ip_hls\">{CAMERA_SOURCE_LABELS.ip_hls.zh}</TabsTrigger>\n            <TabsTrigger value=\"demo\">{CAMERA_SOURCE_LABELS.demo.zh}</TabsTrigger>\n          </TabsList>\n\n          {/* Local Camera Tab */}\n          <TabsContent value=\"local\" className=\"space-y-3 mt-3\">\n            {!canAccessCamera ? (\n              <div className=\"flex items-center gap-2 p-4 bg-amber-50 border border-amber-200 rounded-lg text-amber-800\">\n                <Lock className=\"h-4 w-4\" />\n                <span className=\"text-sm\">No permission to access camera. / 无权限访问摄像头</span>\n              </div>\n            ) : (\n              <>\n                {/* Control Bar */}\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  {status === \"live\" ? (\n                    <Button size=\"sm\" variant=\"destructive\" onClick={stop}>\n                      <CameraOff className=\"h-4 w-4 mr-1\" />\n                      停止\n                    </Button>\n                  ) : (\n                    <Button size=\"sm\" onClick={handleStart} disabled={status === \"starting\"}>\n                      <Camera className=\"h-4 w-4 mr-1\" />\n                      {status === \"starting\" ? \"启动中...\" : \"启动\"}\n                    </Button>\n                  )}\n\n                  {/* Device Select */}\n                  {devices.length > 0 && (\n                    <Select value={selectedDeviceId || undefined} onValueChange={handleDeviceChange}>\n                      <SelectTrigger className=\"w-40 h-8 text-xs\">\n                        <SelectValue placeholder=\"选择摄像头\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {devices\n                          .filter((device) => device.deviceId)\n                          .map((device) => (\n                            <SelectItem key={device.deviceId} value={device.deviceId}>\n                              {device.label}\n                            </SelectItem>\n                          ))}\n                      </SelectContent>\n                    </Select>\n                  )}\n\n                  {/* Facing Mode Toggle */}\n                  <Button size=\"icon\" variant=\"outline\" className=\"h-8 w-8\" onClick={handleFacingModeToggle}>\n                    <SwitchCamera className=\"h-4 w-4\" />\n                  </Button>\n\n                  {/* Mirror Toggle */}\n                  <Button\n                    size=\"icon\"\n                    variant={isMirrored ? \"default\" : \"outline\"}\n                    className=\"h-8 w-8\"\n                    onClick={() => setIsMirrored(!isMirrored)}\n                    title=\"镜像\"\n                  >\n                    <FlipHorizontal className=\"h-4 w-4\" />\n                  </Button>\n\n                  {/* Capture Button */}\n                  <Button\n                    size=\"sm\"\n                    variant=\"secondary\"\n                    onClick={handleCapture}\n                    disabled={status !== \"live\"}\n                  >\n                    <Aperture className=\"h-4 w-4 mr-1\" />\n                    截图\n                  </Button>\n\n                  {/* Refresh Devices */}\n                  <Button size=\"icon\" variant=\"ghost\" className=\"h-8 w-8\" onClick={refreshDevices}>\n                    <RefreshCw className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n\n                {/* Error Display */}\n                {error && (\n                  <div className=\"flex items-center gap-2 p-2 bg-rose-50 border border-rose-200 rounded text-rose-700 text-xs\">\n                    <AlertTriangle className=\"h-4 w-4\" />\n                    {error}\n                  </div>\n                )}\n\n                {/* Video Preview */}\n                <div className=\"relative aspect-video bg-slate-900 rounded-lg overflow-hidden\">\n                  {status === \"live\" ? (\n                    <video\n                      ref={videoRef}\n                      autoPlay\n                      playsInline\n                      muted\n                      className={`w-full h-full object-cover ${isMirrored ? \"scale-x-[-1]\" : \"\"}`}\n                    />\n                  ) : (\n                    <div className=\"absolute inset-0 flex items-center justify-center text-slate-500\">\n                      <div className=\"text-center\">\n                        <VideoOff className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                        <p className=\"text-sm\">\n                          {status === \"starting\" ? \"正在启动摄像头...\" : \"点击「启动」开始预览\"}\n                        </p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n\n                {/* Auto Capture on Andon (TODO) */}\n                <div className=\"flex items-center justify-between p-2 bg-slate-50 rounded border\">\n                  <div className=\"flex items-center gap-2\">\n                    <Settings className=\"h-4 w-4 text-muted-foreground\" />\n                    <span className=\"text-xs\">Auto Capture on Andon / Andon 自动抓拍</span>\n                  </div>\n                  <Button\n                    size=\"sm\"\n                    variant={autoCapture ? \"default\" : \"outline\"}\n                    onClick={() => setAutoCapture(!autoCapture)}\n                    disabled\n                    className=\"text-xs\"\n                  >\n                    {autoCapture ? \"ON\" : \"OFF\"}\n                  </Button>\n                  {/* TODO: Implement auto capture when STOP event > 3 minutes */}\n                </div>\n              </>\n            )}\n          </TabsContent>\n\n          {/* IP Camera Tab */}\n          <TabsContent value=\"ip_hls\" className=\"space-y-3 mt-3\">\n            <div className=\"flex gap-2\">\n              <Input\n                placeholder=\"输入 HLS URL (例如 https://...m3u8)\"\n                value={hlsUrl}\n                onChange={(e) => handleHlsUrlChange(e.target.value)}\n                className=\"flex-1\"\n              />\n              <Button size=\"sm\" onClick={handleCapture} disabled={!hlsUrl}>\n                <Aperture className=\"h-4 w-4 mr-1\" />\n                截图\n              </Button>\n            </div>\n\n            {hlsError && (\n              <div className=\"flex items-center gap-2 p-2 bg-amber-50 border border-amber-200 rounded text-amber-700 text-xs\">\n                <AlertTriangle className=\"h-4 w-4\" />\n                {hlsError}\n              </div>\n            )}\n\n            <div className=\"relative aspect-video bg-slate-900 rounded-lg overflow-hidden\">\n              {hlsUrl ? (\n                <video\n                  ref={hlsVideoRef}\n                  src={hlsUrl}\n                  controls\n                  autoPlay\n                  playsInline\n                  muted\n                  className=\"w-full h-full object-cover\"\n                  onError={handleHlsError}\n                />\n              ) : (\n                <div className=\"absolute inset-0 flex items-center justify-center text-slate-500\">\n                  <div className=\"text-center\">\n                    <Video className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                    <p className=\"text-sm\">输入 HLS/MP4 URL 开始播放</p>\n                  </div>\n                </div>\n              )}\n            </div>\n          </TabsContent>\n\n          {/* Demo Tab */}\n          <TabsContent value=\"demo\" className=\"space-y-3 mt-3\">\n            <div className=\"flex justify-end items-center gap-2 mb-2\">\n              <span className=\"flex items-center gap-1.5 rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700 animate-pulse\">\n                <span className=\"h-1.5 w-1.5 rounded-full bg-emerald-600\" />\n                AI Analysis Active\n              </span>\n              <Button size=\"sm\" variant=\"secondary\" onClick={handleCapture}>\n                <Aperture className=\"h-4 w-4 mr-1\" />\n                截图\n              </Button>\n            </div>\n\n            <div className=\"relative aspect-video bg-slate-900 rounded-lg overflow-hidden group\">\n              {/* Simulated Camera Feed (Spring Coiling Machine) */}\n              <iframe \n                className=\"w-full h-full object-cover scale-150 pointer-events-none\"\n                src=\"https://www.youtube.com/embed/5T7Mv-2XN6s?autoplay=1&mute=1&controls=0&loop=1&playlist=5T7Mv-2XN6s&start=30\" \n                title=\"Spring Coiling Machine Demo\"\n                allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" \n              />\n              \n              {/* AI Overlay Layer */}\n              <div className=\"absolute inset-0 pointer-events-none\">\n                {/* Simulated Bounding Box */}\n                <div className=\"absolute top-1/4 left-1/3 w-32 h-32 border-2 border-emerald-500/70 rounded-sm\">\n                   <div className=\"absolute -top-6 left-0 bg-emerald-500/70 text-white text-[10px] px-1 py-0.5\">\n                      Spring OD: 24.02mm (OK)\n                   </div>\n                </div>\n                \n                {/* Tech Grid Overlay */}\n                <div className=\"absolute inset-0 bg-[linear-gradient(rgba(16,185,129,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(16,185,129,0.03)_1px,transparent_1px)] bg-[size:20px_20px]\" />\n                \n                {/* Timestamp */}\n                <div className=\"absolute bottom-2 right-2 font-mono text-xs text-emerald-500/80 bg-black/50 px-2 rounded\">\n                  CAM-02 | {new Date().toLocaleTimeString()} | 30FPS\n                </div>\n              </div>\n            </div>\n          </TabsContent>\n        </Tabs>\n\n        {/* Capture Gallery */}\n        {captures.length > 0 && (\n          <div className=\"border-t pt-3\">\n            <h4 className=\"text-xs font-medium mb-2 text-muted-foreground\">\n              截图记录 ({captures.length})\n            </h4>\n            <CaptureGallery\n              items={captures}\n              maxItems={8}\n              onDelete={handleDeleteCapture}\n              onUpload={handleUpload}\n            />\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default CameraMonitorCard;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/production/CaptureGallery.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":68,"column":15,"nodeType":"JSXOpeningElement","endLine":72,"endColumn":17,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":169,"column":17,"nodeType":"JSXOpeningElement","endLine":173,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/production/ProductionDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MOCK_PLANTS' is defined but never used.","line":20,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport { AlertTriangle, Cog, RefreshCw } from \"lucide-react\";\n\nimport { LanguageText } from \"@/components/language-context\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\n\nimport type { DashboardVM, LiveRiskStatus, MachineRiskCard, Alert } from \"@/lib/liveRiskBrain/types\";\nimport type { DashboardSummaryResponse, TimeRange } from \"@/lib/manufacturing/types\";\nimport { TIME_RANGE_OPTIONS, MOCK_PLANTS } from \"@/lib/manufacturing\";\nimport {\n  KpiStrip,\n  MachineStatusGrid,\n  AndonFeed,\n  WorkOrderTable,\n  CycleTimeTrend,\n  ThroughputTrend,\n  DowntimePareto,\n} from \"@/components/manufacturing\";\nimport { CameraMonitorCard } from \"@/components/production\";\n\nfunction riskBadgeColor(status: LiveRiskStatus): string {\n  switch (status) {\n    case \"ENGINEERING_OK\":\n      return \"bg-emerald-100 text-emerald-800 border-emerald-200\";\n    case \"MANUFACTURING_RISK\":\n      return \"bg-amber-100 text-amber-800 border-amber-200\";\n    case \"HIGH_RISK\":\n      return \"bg-rose-100 text-rose-800 border-rose-200\";\n  }\n}\n\nfunction statusIndicatorClass(status: string): string {\n  const base = \"h-2 w-2 rounded-full\";\n  switch (status) {\n    case \"RUNNING\":\n      return `${base} bg-emerald-600`;\n    case \"STOPPED\":\n      return `${base} bg-slate-400`;\n    case \"ALARM\":\n      return `${base} bg-rose-600`;\n    case \"SETUP\":\n      return `${base} bg-blue-600`;\n    default:\n      return `${base} bg-slate-400`;\n  }\n}\n\nfunction machineIconClass(status: string): string {\n  switch (status) {\n    case \"RUNNING\":\n      return \"text-emerald-700 motion-reduce:animate-none animate-spin\";\n    case \"ALARM\":\n      return \"text-rose-700\";\n    case \"SETUP\":\n      return \"text-blue-700\";\n    case \"STOPPED\":\n    default:\n      return \"text-slate-500\";\n  }\n}\n\nfunction statusBadgeColor(status: string): string {\n  switch (status) {\n    case \"RUNNING\":\n      return \"bg-emerald-100 text-emerald-800\";\n    case \"STOPPED\":\n      return \"bg-slate-100 text-slate-600\";\n    case \"ALARM\":\n      return \"bg-rose-100 text-rose-800\";\n    case \"SETUP\":\n      return \"bg-blue-100 text-blue-800\";\n    default:\n      return \"bg-slate-100 text-slate-600\";\n  }\n}\n\nfunction severityBadgeColor(severity: string): string {\n  switch (severity) {\n    case \"ERROR\":\n      return \"bg-rose-100 text-rose-800 border-rose-200\";\n    case \"WARNING\":\n      return \"bg-amber-100 text-amber-800 border-amber-200\";\n    case \"INFO\":\n      return \"bg-blue-100 text-blue-800 border-blue-200\";\n    default:\n      return \"bg-slate-100 text-slate-600 border-slate-200\";\n  }\n}\n\nfunction MachineCardComponent({ machine }: { machine: MachineRiskCard }) {\n  return (\n    <div className=\"relative rounded-lg border bg-background p-4 space-y-3\">\n      {machine.status === \"ALARM\" ? (\n        <div className=\"pointer-events-none absolute inset-0 rounded-lg ring-2 ring-rose-200 motion-reduce:hidden animate-pulse\" />\n      ) : null}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2 min-w-0\">\n          <div className=\"flex h-8 w-8 items-center justify-center rounded-md border bg-muted/30\">\n            <Cog\n              className={`h-4 w-4 ${machineIconClass(machine.status)}`}\n              style={\n                machine.status === \"RUNNING\"\n                  ? ({ animationDuration: \"2.2s\" } as React.CSSProperties)\n                  : undefined\n              }\n            />\n          </div>\n          <div className=\"font-semibold truncate\">{machine.machineId}</div>\n        </div>\n        <div className={`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium ${statusBadgeColor(machine.status)}`}>\n          {(machine.status === \"RUNNING\" || machine.status === \"ALARM\") && (\n            <span className=\"relative flex h-2 w-2\">\n              <span\n                className={`absolute inline-flex h-full w-full rounded-full opacity-60 motion-reduce:hidden animate-ping ${\n                  machine.status === \"ALARM\" ? \"bg-rose-400\" : \"bg-emerald-400\"\n                }`}\n              />\n              <span className={`relative inline-flex ${statusIndicatorClass(machine.status)}`} />\n            </span>\n          )}\n          {machine.status !== \"RUNNING\" && machine.status !== \"ALARM\" && (\n            <span className={statusIndicatorClass(machine.status)} />\n          )}\n          {machine.status}\n        </div>\n      </div>\n\n      <div className=\"flex items-center justify-between text-sm\">\n        <span className=\"text-muted-foreground\">\n          <LanguageText en=\"Risk\" zh=\"风险\" />\n        </span>\n        <span className={`rounded-full border px-2 py-0.5 text-xs font-medium ${riskBadgeColor(machine.liveRiskStatus)}`}>\n          {machine.liveRiskScore}\n        </span>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-2 text-sm\">\n        <div>\n          <span className=\"text-muted-foreground\">\n            <LanguageText en=\"Cycle\" zh=\"节拍\" />\n          </span>\n          <div className=\"font-medium\">\n            {machine.cycleTimeMs}ms\n            {machine.cycleTimeDeltaPct > 0.05 && (\n              <span className=\"ml-1 text-amber-600\">+{(machine.cycleTimeDeltaPct * 100).toFixed(0)}%</span>\n            )}\n          </div>\n        </div>\n        <div>\n          <span className=\"text-muted-foreground\">Cpk</span>\n          <div className={`font-medium ${machine.lastCpk !== null && machine.lastCpk < 1.0 ? \"text-rose-600\" : machine.lastCpk !== null && machine.lastCpk < 1.33 ? \"text-amber-600\" : \"\"}`}>\n            {machine.lastCpk?.toFixed(2) ?? \"—\"}\n          </div>\n        </div>\n        <div>\n          <span className=\"text-muted-foreground\">\n            <LanguageText en=\"Scrap\" zh=\"报废\" />\n          </span>\n          <div className={`font-medium ${machine.scrapRate > 0.03 ? \"text-rose-600\" : machine.scrapRate > 0.01 ? \"text-amber-600\" : \"\"}`}>\n            {(machine.scrapRate * 100).toFixed(1)}%\n          </div>\n        </div>\n        <div>\n          <span className=\"text-muted-foreground\">Nelson</span>\n          <div className={`font-medium ${machine.lastNelsonViolations >= 2 ? \"text-rose-600\" : machine.lastNelsonViolations >= 1 ? \"text-amber-600\" : \"\"}`}>\n            {machine.lastNelsonViolations}\n          </div>\n        </div>\n      </div>\n\n      {machine.tempDrift && (\n        <div className=\"text-xs text-amber-600 flex items-center gap-1\">\n          <AlertTriangle className=\"h-3 w-3\" />\n          <LanguageText en=\"Temperature drift\" zh=\"温度漂移\" />\n        </div>\n      )}\n\n      {machine.topDrivers.length > 0 && (\n        <div className=\"border-t pt-2 space-y-1\">\n          <div className=\"text-xs text-muted-foreground font-medium\">\n            <LanguageText en=\"Top Drivers\" zh=\"主要原因\" />\n          </div>\n          {machine.topDrivers.slice(0, 2).map((d, idx) => (\n            <div key={idx} className=\"text-xs text-muted-foreground\">\n              • <LanguageText en={d.title.en} zh={d.title.zh} />\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction AlertCard({ alert }: { alert: Alert }) {\n  return (\n    <div className={`rounded-lg border p-3 space-y-1 ${severityBadgeColor(alert.severity)}`}>\n      <div className=\"flex items-center justify-between\">\n        <span className=\"font-medium text-sm\">\n          <LanguageText en={alert.title.en} zh={alert.title.zh} />\n        </span>\n        <span className=\"text-xs\">{alert.machineId}</span>\n      </div>\n      <div className=\"text-xs opacity-80\">\n        <LanguageText en={alert.evidence.en} zh={alert.evidence.zh} />\n      </div>\n      {alert.suggestedActions.length > 0 && (\n        <div className=\"text-xs\">\n          → <LanguageText en={alert.suggestedActions[0].en} zh={alert.suggestedActions[0].zh} />\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport function ProductionDashboard() {\n  // Live Risk Brain state\n  const [dashboard, setDashboard] = useState<DashboardVM | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [riskPreset, setRiskPreset] = useState<\"OK\" | \"WARN\" | \"HIGH\">(\"OK\");\n  const [autoRefresh, setAutoRefresh] = useState(false);\n\n  // Manufacturing Dashboard state\n  const [mfgData, setMfgData] = useState<DashboardSummaryResponse | null>(null);\n  const [mfgLoading, setMfgLoading] = useState(false);\n  const [timeRange, setTimeRange] = useState<TimeRange>(\"1h\");\n  const [activeTab, setActiveTab] = useState<string>(\"risk\");\n\n  // Fetch Live Risk Brain data\n  const fetchDashboard = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      const res = await fetch(`/api/production/dashboard?mode=demo&risk=${riskPreset}&seed=${Date.now()}`);\n      if (!res.ok) {\n        const text = await res.text();\n        throw new Error(text || \"Failed to fetch dashboard\");\n      }\n      const data = await res.json();\n      setDashboard(data);\n    } catch (e) {\n      setError(e instanceof Error ? e.message : \"Unknown error\");\n    } finally {\n      setLoading(false);\n    }\n  }, [riskPreset]);\n\n  // Fetch Manufacturing Dashboard data\n  const fetchMfgData = useCallback(async () => {\n    setMfgLoading(true);\n    try {\n      const riskLevel = riskPreset === \"OK\" ? \"low\" : riskPreset === \"WARN\" ? \"medium\" : \"high\";\n      const res = await fetch(`/api/manufacturing/summary?plantId=P01&range=${timeRange}&risk=${riskLevel}&seed=${Date.now()}`);\n      if (!res.ok) throw new Error(\"Failed to fetch manufacturing data\");\n      const data = await res.json();\n      setMfgData(data);\n    } catch (e) {\n      console.error(\"Manufacturing data fetch error:\", e);\n    } finally {\n      setMfgLoading(false);\n    }\n  }, [riskPreset, timeRange]);\n\n  // Fetch both on mount and when params change\n  useEffect(() => {\n    fetchDashboard();\n    fetchMfgData();\n  }, [fetchDashboard, fetchMfgData]);\n\n  // Auto refresh\n  useEffect(() => {\n    if (!autoRefresh) return;\n    const interval = setInterval(() => {\n      fetchDashboard();\n      fetchMfgData();\n    }, 5000);\n    return () => clearInterval(interval);\n  }, [autoRefresh, fetchDashboard, fetchMfgData]);\n\n  return (\n    <section className=\"space-y-6\">\n      <div className=\"space-y-3\">\n        <p className=\"text-sm uppercase tracking-[0.3em] text-primary/70\">\n          <LanguageText en=\"Module • Production Monitoring\" zh=\"模块 • 生产监控\" />\n        </p>\n        <h1 className=\"text-3xl font-semibold tracking-tight\">\n          <LanguageText en=\"Production Monitoring\" zh=\"生产监控\" />\n        </h1>\n        <p className=\"text-muted-foreground\">\n          <LanguageText\n            en=\"Real-time shopfloor status with Live Risk Brain integration. Demo mode generates realistic production data.\"\n            zh=\"实时车间状态与 Live Risk Brain 集成。演示模式生成逼真的生产数据。\"\n          />\n        </p>\n      </div>\n\n      <div className=\"flex flex-wrap items-center gap-3\">\n        <Select value={riskPreset} onValueChange={(v) => setRiskPreset(v as \"OK\" | \"WARN\" | \"HIGH\")}>\n          <SelectTrigger className=\"w-40\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"OK\">\n              <LanguageText en=\"Normal (OK)\" zh=\"正常 (OK)\" />\n            </SelectItem>\n            <SelectItem value=\"WARN\">\n              <LanguageText en=\"Warning (WARN)\" zh=\"警告 (WARN)\" />\n            </SelectItem>\n            <SelectItem value=\"HIGH\">\n              <LanguageText en=\"High Risk (HIGH)\" zh=\"高风险 (HIGH)\" />\n            </SelectItem>\n          </SelectContent>\n        </Select>\n\n        <Select value={timeRange} onValueChange={(v) => setTimeRange(v as TimeRange)}>\n          <SelectTrigger className=\"w-36\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            {TIME_RANGE_OPTIONS.map((opt) => (\n              <SelectItem key={opt.value} value={opt.value}>\n                {opt.label.zh}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n\n        <Button onClick={() => { fetchDashboard(); fetchMfgData(); }} disabled={loading || mfgLoading} variant=\"outline\">\n          <RefreshCw className={`h-4 w-4 mr-1 ${loading || mfgLoading ? \"animate-spin\" : \"\"}`} />\n          <LanguageText en=\"Refresh\" zh=\"刷新\" />\n        </Button>\n\n        <Button\n          onClick={() => {\n            // Demo Scenario Trigger\n            setRiskPreset(\"HIGH\");\n            setAutoRefresh(true);\n            setActiveTab(\"operations\");\n            fetchDashboard();\n            fetchMfgData();\n          }}\n          className=\"bg-emerald-600 hover:bg-emerald-700 text-white\"\n        >\n          <LanguageText en=\"▶ Start Live Demo\" zh=\"▶ 启动现场演示\" />\n        </Button>\n      </div>\n\n      {error && (\n        <div className=\"rounded-lg border border-rose-200 bg-rose-50 p-4 text-rose-800\">\n          {error}\n        </div>\n      )}\n\n      {/* Shift Badge + KPI Strip */}\n      {mfgData && (\n        <div className=\"space-y-4\">\n          {/* Current Shift Badge */}\n          {mfgData.shift && (\n            <div className=\"flex items-center gap-3\">\n              <div className={`inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm font-medium ${\n                mfgData.shift.id === \"NIGHT\" \n                  ? \"bg-indigo-100 text-indigo-800 border border-indigo-200\" \n                  : \"bg-amber-100 text-amber-800 border border-amber-200\"\n              }`}>\n                <span className={`h-2 w-2 rounded-full ${mfgData.shift.id === \"NIGHT\" ? \"bg-indigo-500\" : \"bg-amber-500\"}`} />\n                <span>{mfgData.shift.name}</span>\n                <span className=\"text-xs opacity-70\">\n                  ({mfgData.shift.startTime} - {mfgData.shift.endTime})\n                </span>\n              </div>\n              <span className=\"text-xs text-muted-foreground\">\n                <LanguageText \n                  en={mfgData.shift.id === \"NIGHT\" ? \"Night shift: slightly lower targets\" : \"Day shift: standard targets\"} \n                  zh={mfgData.shift.id === \"NIGHT\" ? \"夜班：目标略低\" : \"白班：标准目标\"} \n                />\n              </span>\n            </div>\n          )}\n          <KpiStrip kpis={mfgData.kpis} />\n        </div>\n      )}\n\n      {/* Tabs for switching between Risk View and Operations View */}\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n        <TabsList className=\"grid w-full max-w-md grid-cols-2\">\n          <TabsTrigger value=\"risk\">\n            <LanguageText en=\"Risk Analysis\" zh=\"风险分析\" />\n          </TabsTrigger>\n          <TabsTrigger value=\"operations\">\n            <LanguageText en=\"Operations\" zh=\"生产运营\" />\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Risk Analysis Tab - Original Live Risk Brain content */}\n        <TabsContent value=\"risk\" className=\"mt-6\">\n          {dashboard && (\n            <div className=\"grid gap-6 lg:grid-cols-[1fr_320px]\">\n              <div className=\"space-y-6\">\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-lg\">\n                      <LanguageText en=\"Factory Overview\" zh=\"全厂概览\" />\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"grid grid-cols-2 gap-4 sm:grid-cols-4\">\n                      <div className=\"rounded-lg border bg-emerald-50 p-3 text-center\">\n                        <div className=\"text-2xl font-bold text-emerald-700\">{dashboard.factorySummary.runningCount}</div>\n                        <div className=\"text-xs text-emerald-600\">\n                          <LanguageText en=\"Running\" zh=\"运行中\" />\n                        </div>\n                      </div>\n                      <div className=\"rounded-lg border bg-slate-50 p-3 text-center\">\n                        <div className=\"text-2xl font-bold text-slate-600\">{dashboard.factorySummary.stoppedCount}</div>\n                        <div className=\"text-xs text-slate-500\">\n                          <LanguageText en=\"Stopped\" zh=\"停机\" />\n                        </div>\n                      </div>\n                      <div className=\"rounded-lg border bg-rose-50 p-3 text-center\">\n                        <div className=\"text-2xl font-bold text-rose-700\">{dashboard.factorySummary.alarmCount}</div>\n                        <div className=\"text-xs text-rose-600\">\n                          <LanguageText en=\"Alarm\" zh=\"报警\" />\n                        </div>\n                      </div>\n                      <div className=\"rounded-lg border bg-blue-50 p-3 text-center\">\n                        <div className=\"text-2xl font-bold text-blue-700\">{dashboard.factorySummary.setupCount}</div>\n                        <div className=\"text-xs text-blue-600\">\n                          <LanguageText en=\"Setup\" zh=\"调机\" />\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"mt-4 flex items-center justify-between rounded-lg border p-3\">\n                      <div>\n                        <div className=\"text-sm text-muted-foreground\">\n                          <LanguageText en=\"Overall Live Risk\" zh=\"总体实时风险\" />\n                        </div>\n                        <div className={`mt-1 inline-block rounded-full border px-3 py-1 text-sm font-semibold ${riskBadgeColor(dashboard.factorySummary.overallLiveRisk)}`}>\n                          {dashboard.factorySummary.overallLiveRisk} ({dashboard.factorySummary.overallScore})\n                        </div>\n                      </div>\n                      <div className=\"text-right\">\n                        <div className=\"text-sm text-muted-foreground\">\n                          <LanguageText en=\"Throughput\" zh=\"产量\" />\n                        </div>\n                        <div className=\"text-lg font-semibold\">{dashboard.factorySummary.throughputNow.toLocaleString()}/h</div>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-lg\">\n                      <LanguageText en=\"Machine Status (Risk View)\" zh=\"机台状态（风险视图）\" />\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4\">\n                      {dashboard.machines.map((m) => (\n                        <MachineCardComponent key={m.machineId} machine={m} />\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"space-y-4\">\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-base\">\n                      <LanguageText en=\"Risk Alerts\" zh=\"风险告警\" />\n                      {dashboard.alerts.length > 0 && (\n                        <span className=\"ml-2 rounded-full bg-rose-100 px-2 py-0.5 text-xs text-rose-700\">\n                          {dashboard.alerts.length}\n                        </span>\n                      )}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    {dashboard.alerts.length === 0 ? (\n                      <div className=\"text-sm text-muted-foreground\">\n                        <LanguageText en=\"No active alerts\" zh=\"暂无告警\" />\n                      </div>\n                    ) : (\n                      dashboard.alerts.slice(0, 8).map((a) => (\n                        <AlertCard key={a.id} alert={a} />\n                      ))\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-base\">\n                      <LanguageText en=\"Live Risk Brain\" zh=\"实时风险大脑\" />\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2 text-sm text-muted-foreground\">\n                    <p>\n                      <LanguageText\n                        en=\"✓ Production + Quality + Engineering\"\n                        zh=\"✓ 生产 + 质量 + 工程\"\n                      />\n                    </p>\n                    <p>\n                      <LanguageText\n                        en=\"✓ Explainable drivers\"\n                        zh=\"✓ 可解释的原因\"\n                      />\n                    </p>\n                    <p>\n                      <LanguageText\n                        en=\"✓ Real-time risk scoring\"\n                        zh=\"✓ 实时风险评分\"\n                      />\n                    </p>\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n          )}\n        </TabsContent>\n\n        {/* Operations Tab - New Manufacturing Dashboard content */}\n        <TabsContent value=\"operations\" className=\"mt-6\">\n          {mfgData && (\n            <div className=\"space-y-6\">\n              {/* Machine Status Grid */}\n              <div className=\"space-y-2\">\n                <h3 className=\"text-lg font-semibold\">\n                  <LanguageText en=\"Machine Status\" zh=\"设备状态\" />\n                </h3>\n                <MachineStatusGrid machines={mfgData.machines} />\n              </div>\n\n              {/* Charts Row */}\n              <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\n                <CycleTimeTrend data={mfgData.ctTrend} targetCt={3.0} />\n                <ThroughputTrend data={mfgData.throughputTrend} />\n                <DowntimePareto data={mfgData.downtimePareto} />\n              </div>\n\n              {/* Andon & Work Orders Row */}\n              <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\n                <AndonFeed\n                  events={mfgData.andon}\n                  maxHeight=\"350px\"\n                  className=\"lg:col-span-1\"\n                />\n                <WorkOrderTable\n                  workOrders={mfgData.workOrders}\n                  className=\"lg:col-span-2\"\n                />\n              </div>\n\n              {/* Camera & Engineering Specs Row */}\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <CameraMonitorCard\n                  lineId={mfgData.machines[0]?.lineId}\n                  workOrderId={mfgData.workOrders[0]?.workOrderId}\n                  className=\"md:col-span-2\"\n                  initialMode={autoRefresh ? \"demo\" : \"local\"}\n                />\n                <Card>\n                  <CardHeader className=\"pb-3\">\n                    <CardTitle className=\"text-base\">\n                      <LanguageText en=\"Engineering Specs vs Actual\" zh=\"工程规格 vs 实测\" />\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"text-sm space-y-4\">\n                    <div className=\"rounded-lg bg-muted/40 p-3\">\n                       <div className=\"flex justify-between items-center mb-1\">\n                          <span className=\"text-muted-foreground\"><LanguageText en=\"Part Name\" zh=\"零件名称\" /></span>\n                          <span className=\"font-semibold\">C-291-Custom</span>\n                       </div>\n                       <div className=\"flex justify-between items-center text-xs text-muted-foreground\">\n                          <span>Rev: 2.1</span>\n                          <span>Mat: SUS304</span>\n                       </div>\n                    </div>\n                    \n                    <div className=\"space-y-3\">\n                       <div>\n                          <div className=\"flex justify-between mb-1\">\n                             <span>OD <span className=\"text-muted-foreground\">(Outer Dia)</span></span>\n                             <span className=\"font-mono text-emerald-600\">24.02 mm</span>\n                          </div>\n                          <div className=\"h-1.5 w-full bg-slate-100 rounded-full overflow-hidden\">\n                             <div className=\"h-full bg-emerald-500 w-[55%] relative\">\n                                <div className=\"absolute top-0 right-0 w-0.5 h-full bg-black/20\" /> {/* Center mark */}\n                             </div>\n                          </div>\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground mt-0.5\">\n                             <span>23.80</span>\n                             <span className=\"font-semibold text-primary\">Target: 24.00</span>\n                             <span>24.20</span>\n                          </div>\n                       </div>\n                       \n                       <div>\n                          <div className=\"flex justify-between mb-1\">\n                             <span>FL <span className=\"text-muted-foreground\">(Free Len)</span></span>\n                             <span className=\"font-mono text-amber-600\">45.88 mm</span>\n                          </div>\n                          <div className=\"h-1.5 w-full bg-slate-100 rounded-full overflow-hidden\">\n                             <div className=\"h-full bg-amber-500 w-[85%] relative\" />\n                          </div>\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground mt-0.5\">\n                             <span>44.00</span>\n                             <span>Target: 45.00</span>\n                             <span>46.00</span>\n                          </div>\n                       </div>\n                    </div>\n                    \n                    <div className=\"pt-2 border-t text-xs text-muted-foreground\">\n                       <p>\n                          <LanguageText \n                            en=\"Connects directly to Engineering Calculator V2.1 rules.\"\n                            zh=\"直接关联工程计算器 V2.1 规则。\" \n                          />\n                       </p>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/production/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityImrCharts.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[425,428],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[425,428],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityImrCharts.tsx:41:5\n  39 |\n  40 |   useEffect(() => {\n> 41 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  42 |   }, []);\n  43 |\n  44 |   const iData = useMemo(() => {","line":41,"column":5,"nodeType":null,"endLine":41,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2357,2360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2357,2360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":110,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2846,2849],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2846,2849],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityImrCharts.tsx:133:32\n  131 |             <XAxis dataKey=\"x\" tick={{ fontSize: 11 }} />\n  132 |             <YAxis tick={{ fontSize: 11 }} />\n> 133 |             <Tooltip content={<ITooltip />} />\n      |                                ^^^^^^^^ This component is created during render\n  134 |             <ReferenceLine y={imr.ucl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n  135 |             <ReferenceLine y={imr.mean} stroke=\"#64748b\" strokeDasharray=\"2 2\" />\n  136 |             <ReferenceLine y={imr.lcl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityImrCharts.tsx:96:20\n   94 |   }\n   95 |\n>  96 |   const ITooltip = ({ active, payload }: any) => {\n      |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  97 |     if (active && payload && payload.length) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  98 |       const p = payload[0].payload;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 107 |     return null;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 108 |   };\n      | ^^^^ The component is created during render here\n  109 |\n  110 |   const MRTooltip = ({ active, payload }: any) => {\n  111 |     if (active && payload && payload.length) {","line":133,"column":32,"nodeType":null,"endLine":133,"endColumn":40},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityImrCharts.tsx:149:32\n  147 |             <XAxis dataKey=\"x\" tick={{ fontSize: 11 }} />\n  148 |             <YAxis tick={{ fontSize: 11 }} />\n> 149 |             <Tooltip content={<MRTooltip />} />\n      |                                ^^^^^^^^^ This component is created during render\n  150 |             <ReferenceLine y={mrLimits.ucl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n  151 |             <ReferenceLine y={mrLimits.cl} stroke=\"#64748b\" strokeDasharray=\"2 2\" />\n  152 |             <ReferenceLine y={mrLimits.lcl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityImrCharts.tsx:110:21\n  108 |   };\n  109 |\n> 110 |   const MRTooltip = ({ active, payload }: any) => {\n      |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 111 |     if (active && payload && payload.length) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 112 |       const p = payload[0].payload;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 121 |     return null;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 122 |   };\n      | ^^^^ The component is created during render here\n  123 |\n  124 |   return (\n  125 |     <div className=\"grid gap-3 md:grid-cols-2\">","line":149,"column":32,"nodeType":null,"endLine":149,"endColumn":41}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport {\n  CartesianGrid,\n  Line,\n  LineChart,\n  ReferenceLine,\n  ResponsiveContainer,\n  Tooltip,\n  XAxis,\n  YAxis,\n} from \"recharts\";\n\nimport type { ImrChart } from \"@/lib/quality\";\n\nfunction fmt(n: number, decimals = 3) {\n  if (!isFinite(n)) return \"—\";\n  return Number(n.toFixed(decimals)).toLocaleString();\n}\n\nfunction Dot({ cx, cy, payload, stroke }: any) {\n  if (!(typeof cx === \"number\" && typeof cy === \"number\")) return null;\n  const ooc = !!payload?.outOfControl;\n  return (\n    <circle\n      cx={cx}\n      cy={cy}\n      r={ooc ? 3.5 : 2.5}\n      fill={ooc ? \"#ef4444\" : stroke ?? \"#2563eb\"}\n      stroke=\"#fff\"\n      strokeWidth={1}\n    />\n  );\n}\n\nexport function QualityImrCharts({ imr, height = 260 }: { imr: ImrChart; height?: number }) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const iData = useMemo(() => {\n    return (imr.points ?? []).map((p) => ({\n      x: p.x,\n      value: p.value,\n      cl: p.cl,\n      ucl: p.ucl,\n      lcl: p.lcl,\n      outOfControl: p.outOfControl,\n    }));\n  }, [imr.points]);\n\n  const mrLimits = useMemo(() => {\n    const mrBar = imr.mrBar ?? 0;\n    const d3 = 0;\n    const d4 = 3.267;\n    return {\n      cl: mrBar,\n      ucl: d4 * mrBar,\n      lcl: d3 * mrBar,\n    };\n  }, [imr.mrBar]);\n\n  const mrData = useMemo(() => {\n    const xs = (imr.points ?? []).map((p) => p.value);\n    const out: Array<{ x: number; mr: number; outOfControl: boolean }> = [];\n    for (let i = 1; i < xs.length; i++) {\n      const mr = Math.abs(xs[i] - xs[i - 1]);\n      out.push({\n        x: i + 1,\n        mr,\n        outOfControl: mr > mrLimits.ucl || mr < mrLimits.lcl,\n      });\n    }\n    return out;\n  }, [imr.points, mrLimits.lcl, mrLimits.ucl]);\n\n  if (!mounted) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        Loading chart...\n      </div>\n    );\n  }\n\n  if (!iData.length) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        No data\n      </div>\n    );\n  }\n\n  const ITooltip = ({ active, payload }: any) => {\n    if (active && payload && payload.length) {\n      const p = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <div className=\"font-medium\">i = {p.x}</div>\n          <div>Value = {fmt(p.value, 4)}</div>\n          <div className=\"text-slate-600\">CL/UCL/LCL = {fmt(p.cl, 4)} / {fmt(p.ucl, 4)} / {fmt(p.lcl, 4)}</div>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  const MRTooltip = ({ active, payload }: any) => {\n    if (active && payload && payload.length) {\n      const p = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <div className=\"font-medium\">i = {p.x}</div>\n          <div>MR = {fmt(p.mr, 4)}</div>\n          <div className=\"text-slate-600\">CL/UCL/LCL = {fmt(mrLimits.cl, 4)} / {fmt(mrLimits.ucl, 4)} / {fmt(mrLimits.lcl, 4)}</div>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <div className=\"grid gap-3 md:grid-cols-2\">\n      <div className=\"w-full\" style={{ height }}>\n        <div className=\"text-xs text-muted-foreground mb-2\">I Chart</div>\n        <ResponsiveContainer width=\"100%\" height=\"100%\">\n          <LineChart data={iData} margin={{ top: 12, right: 18, left: 6, bottom: 18 }}>\n            <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n            <XAxis dataKey=\"x\" tick={{ fontSize: 11 }} />\n            <YAxis tick={{ fontSize: 11 }} />\n            <Tooltip content={<ITooltip />} />\n            <ReferenceLine y={imr.ucl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n            <ReferenceLine y={imr.mean} stroke=\"#64748b\" strokeDasharray=\"2 2\" />\n            <ReferenceLine y={imr.lcl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n            <Line type=\"monotone\" dataKey=\"value\" stroke=\"#2563eb\" strokeWidth={2} dot={<Dot />} activeDot={{ r: 4 }} />\n          </LineChart>\n        </ResponsiveContainer>\n      </div>\n\n      <div className=\"w-full\" style={{ height }}>\n        <div className=\"text-xs text-muted-foreground mb-2\">MR Chart</div>\n        <ResponsiveContainer width=\"100%\" height=\"100%\">\n          <LineChart data={mrData} margin={{ top: 12, right: 18, left: 6, bottom: 18 }}>\n            <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n            <XAxis dataKey=\"x\" tick={{ fontSize: 11 }} />\n            <YAxis tick={{ fontSize: 11 }} />\n            <Tooltip content={<MRTooltip />} />\n            <ReferenceLine y={mrLimits.ucl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n            <ReferenceLine y={mrLimits.cl} stroke=\"#64748b\" strokeDasharray=\"2 2\" />\n            <ReferenceLine y={mrLimits.lcl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n            <Line type=\"monotone\" dataKey=\"mr\" stroke=\"#8b5cf6\" strokeWidth={2} dot={<Dot />} activeDot={{ r: 4 }} />\n          </LineChart>\n        </ResponsiveContainer>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityStratificationChart.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityStratificationChart.tsx:27:5\n  25 |\n  26 |   useEffect(() => {\n> 27 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  28 |   }, []);\n  29 |\n  30 |   const data = useMemo(() => {","line":27,"column":5,"nodeType":null,"endLine":27,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1451,1454],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1451,1454],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityStratificationChart.tsx:77:30\n  75 |           <XAxis dataKey=\"key\" tick={{ fontSize: 11 }} interval={0} angle={-20} textAnchor=\"end\" height={46} />\n  76 |           <YAxis domain={[0, 100]} tick={{ fontSize: 11 }} />\n> 77 |           <Tooltip content={<CustomTooltip />} />\n     |                              ^^^^^^^^^^^^^ This component is created during render\n  78 |           <Bar dataKey=\"score\" radius={[6, 6, 0, 0]}>\n  79 |             {data.map((entry, idx) => (\n  80 |               <Cell key={`${entry.key}-${idx}`} fill={statusColor(entry.status)} />\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityStratificationChart.tsx:55:25\n  53 |   }\n  54 |\n> 55 |   const CustomTooltip = ({ active, payload }: any) => {\n     |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 56 |     if (active && payload && payload.length) {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 57 |       const p = payload[0].payload;\n     …\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 67 |     return null;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 68 |   };\n     | ^^^^ The component is created during render here\n  69 |\n  70 |   return (\n  71 |     <div className=\"w-full\" style={{ height }}>","line":77,"column":30,"nodeType":null,"endLine":77,"endColumn":43}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport {\n  Bar,\n  BarChart,\n  CartesianGrid,\n  Cell,\n  ResponsiveContainer,\n  Tooltip,\n  XAxis,\n  YAxis,\n} from \"recharts\";\n\nimport type { QualityStratificationResult } from \"@/lib/quality\";\n\nfunction statusColor(status: string) {\n  if (status === \"HIGH_RISK\") return \"#ef4444\";\n  if (status === \"MANUFACTURING_RISK\") return \"#f59e0b\";\n  return \"#22c55e\";\n}\n\nexport function QualityStratificationChart({ stratification, height = 260 }: { stratification: QualityStratificationResult; height?: number }) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const data = useMemo(() => {\n    return (stratification.strata ?? []).map((s) => ({\n      key: s.key,\n      score: s.score,\n      status: s.status,\n      n: s.count,\n    }));\n  }, [stratification.strata]);\n\n  if (!mounted) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        Loading chart...\n      </div>\n    );\n  }\n\n  if (!data.length) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        No stratification data\n      </div>\n    );\n  }\n\n  const CustomTooltip = ({ active, payload }: any) => {\n    if (active && payload && payload.length) {\n      const p = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <div className=\"font-medium\">{p.key}</div>\n          <div>Score = {p.score}</div>\n          <div>Status = {p.status}</div>\n          <div>n = {p.n}</div>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <div className=\"w-full\" style={{ height }}>\n      <ResponsiveContainer width=\"100%\" height=\"100%\">\n        <BarChart data={data} margin={{ top: 12, right: 18, left: 6, bottom: 30 }}>\n          <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n          <XAxis dataKey=\"key\" tick={{ fontSize: 11 }} interval={0} angle={-20} textAnchor=\"end\" height={46} />\n          <YAxis domain={[0, 100]} tick={{ fontSize: 11 }} />\n          <Tooltip content={<CustomTooltip />} />\n          <Bar dataKey=\"score\" radius={[6, 6, 0, 0]}>\n            {data.map((entry, idx) => (\n              <Cell key={`${entry.key}-${idx}`} fill={statusColor(entry.status)} />\n            ))}\n          </Bar>\n        </BarChart>\n      </ResponsiveContainer>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityXbarRCharts.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[433,436],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[433,436],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityXbarRCharts.tsx:41:5\n  39 |\n  40 |   useEffect(() => {\n> 41 |     setMounted(true);\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  42 |   }, []);\n  43 |\n  44 |   const data = useMemo(() => {","line":41,"column":5,"nodeType":null,"endLine":41,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1930,1933],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1930,1933],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2431,2434],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2431,2434],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityXbarRCharts.tsx:114:32\n  112 |             <XAxis dataKey=\"x\" tick={{ fontSize: 11 }} />\n  113 |             <YAxis tick={{ fontSize: 11 }} />\n> 114 |             <Tooltip content={<XTooltip />} />\n      |                                ^^^^^^^^ This component is created during render\n  115 |             <ReferenceLine y={data[0].xucl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n  116 |             <ReferenceLine y={data[0].xcl} stroke=\"#64748b\" strokeDasharray=\"2 2\" />\n  117 |             <ReferenceLine y={data[0].xlcl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityXbarRCharts.tsx:77:20\n  75 |   }\n  76 |\n> 77 |   const XTooltip = ({ active, payload }: any) => {\n     |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 78 |     if (active && payload && payload.length) {\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 79 |       const p = payload[0].payload;\n     …\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 88 |     return null;\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 89 |   };\n     | ^^^^ The component is created during render here\n  90 |\n  91 |   const RTooltip = ({ active, payload }: any) => {\n  92 |     if (active && payload && payload.length) {","line":114,"column":32,"nodeType":null,"endLine":114,"endColumn":40},{"ruleId":"react-hooks/static-components","severity":2,"message":"Error: Cannot create components during render\n\nComponents created during render will reset their state each time they are created. Declare components outside of render.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityXbarRCharts.tsx:130:32\n  128 |             <XAxis dataKey=\"x\" tick={{ fontSize: 11 }} />\n  129 |             <YAxis tick={{ fontSize: 11 }} />\n> 130 |             <Tooltip content={<RTooltip />} />\n      |                                ^^^^^^^^ This component is created during render\n  131 |             <ReferenceLine y={data[0].rucl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n  132 |             <ReferenceLine y={data[0].rcl} stroke=\"#64748b\" strokeDasharray=\"2 2\" />\n  133 |             <ReferenceLine y={data[0].rlcl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/quality/QualityXbarRCharts.tsx:91:20\n   89 |   };\n   90 |\n>  91 |   const RTooltip = ({ active, payload }: any) => {\n      |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  92 |     if (active && payload && payload.length) {\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>  93 |       const p = payload[0].payload;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 102 |     return null;\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 103 |   };\n      | ^^^^ The component is created during render here\n  104 |\n  105 |   return (\n  106 |     <div className=\"grid gap-3 md:grid-cols-2\">","line":130,"column":32,"nodeType":null,"endLine":130,"endColumn":40}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport {\n  CartesianGrid,\n  Line,\n  LineChart,\n  ReferenceLine,\n  ResponsiveContainer,\n  Tooltip,\n  XAxis,\n  YAxis,\n} from \"recharts\";\n\nimport type { XbarRChart } from \"@/lib/quality\";\n\nfunction fmt(n: number, decimals = 3) {\n  if (!isFinite(n)) return \"—\";\n  return Number(n.toFixed(decimals)).toLocaleString();\n}\n\nfunction Dot({ cx, cy, payload, stroke, kind }: any) {\n  if (!(typeof cx === \"number\" && typeof cy === \"number\")) return null;\n  const ooc = kind === \"x\" ? !!payload?.xOutOfControl : !!payload?.rOutOfControl;\n  return (\n    <circle\n      cx={cx}\n      cy={cy}\n      r={ooc ? 3.5 : 2.5}\n      fill={ooc ? \"#ef4444\" : stroke ?? \"#2563eb\"}\n      stroke=\"#fff\"\n      strokeWidth={1}\n    />\n  );\n}\n\nexport function QualityXbarRCharts({ xbarr, height = 260 }: { xbarr: XbarRChart; height?: number }) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  const data = useMemo(() => {\n    return (xbarr.points ?? []).map((p) => ({\n      x: p.index,\n      subgroupId: p.subgroupId,\n      mean: p.mean,\n      range: p.range,\n      xcl: p.xcl,\n      xucl: p.xucl,\n      xlcl: p.xlcl,\n      rcl: p.rcl,\n      rucl: p.rucl,\n      rlcl: p.rlcl,\n      xOutOfControl: p.xOutOfControl,\n      rOutOfControl: p.rOutOfControl,\n    }));\n  }, [xbarr.points]);\n\n  if (!mounted) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        Loading chart...\n      </div>\n    );\n  }\n\n  if (!data.length) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-400\" style={{ height }}>\n        No Xbar-R data\n      </div>\n    );\n  }\n\n  const XTooltip = ({ active, payload }: any) => {\n    if (active && payload && payload.length) {\n      const p = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <div className=\"font-medium\">Subgroup {p.subgroupId}</div>\n          <div>X\u001f = {fmt(p.mean, 4)}</div>\n          <div className=\"text-slate-600\">CL/UCL/LCL = {fmt(p.xcl, 4)} / {fmt(p.xucl, 4)} / {fmt(p.xlcl, 4)}</div>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  const RTooltip = ({ active, payload }: any) => {\n    if (active && payload && payload.length) {\n      const p = payload[0].payload;\n      return (\n        <div className=\"bg-white p-2 border rounded shadow-sm text-xs\">\n          <div className=\"font-medium\">Subgroup {p.subgroupId}</div>\n          <div>R = {fmt(p.range, 4)}</div>\n          <div className=\"text-slate-600\">CL/UCL/LCL = {fmt(p.rcl, 4)} / {fmt(p.rucl, 4)} / {fmt(p.rlcl, 4)}</div>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <div className=\"grid gap-3 md:grid-cols-2\">\n      <div className=\"w-full\" style={{ height }}>\n        <div className=\"text-xs text-muted-foreground mb-2\">Xbar Chart (n={xbarr.subgroupSize})</div>\n        <ResponsiveContainer width=\"100%\" height=\"100%\">\n          <LineChart data={data} margin={{ top: 12, right: 18, left: 6, bottom: 18 }}>\n            <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n            <XAxis dataKey=\"x\" tick={{ fontSize: 11 }} />\n            <YAxis tick={{ fontSize: 11 }} />\n            <Tooltip content={<XTooltip />} />\n            <ReferenceLine y={data[0].xucl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n            <ReferenceLine y={data[0].xcl} stroke=\"#64748b\" strokeDasharray=\"2 2\" />\n            <ReferenceLine y={data[0].xlcl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n            <Line type=\"monotone\" dataKey=\"mean\" stroke=\"#2563eb\" strokeWidth={2} dot={<Dot kind=\"x\" />} activeDot={{ r: 4 }} />\n          </LineChart>\n        </ResponsiveContainer>\n      </div>\n\n      <div className=\"w-full\" style={{ height }}>\n        <div className=\"text-xs text-muted-foreground mb-2\">R Chart</div>\n        <ResponsiveContainer width=\"100%\" height=\"100%\">\n          <LineChart data={data} margin={{ top: 12, right: 18, left: 6, bottom: 18 }}>\n            <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e2e8f0\" />\n            <XAxis dataKey=\"x\" tick={{ fontSize: 11 }} />\n            <YAxis tick={{ fontSize: 11 }} />\n            <Tooltip content={<RTooltip />} />\n            <ReferenceLine y={data[0].rucl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n            <ReferenceLine y={data[0].rcl} stroke=\"#64748b\" strokeDasharray=\"2 2\" />\n            <ReferenceLine y={data[0].rlcl} stroke=\"#ef4444\" strokeDasharray=\"4 4\" />\n            <Line type=\"monotone\" dataKey=\"range\" stroke=\"#8b5cf6\" strokeWidth={2} dot={<Dot kind=\"r\" />} activeDot={{ r: 4 }} />\n          </LineChart>\n        </ResponsiveContainer>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/reports/ConicalDesignReportPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/seo/SpringSeoContent.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createFallback' is assigned a value but never used.","line":20,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useLanguage } from \"@/components/language-context\";\nimport { SpringType } from \"@/lib/springTypes\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { cn } from \"@/lib/utils\";\n\ntype SeoContentBlock = {\n  h1: string;\n  sections: { title: string; content: string }[];\n  faqs: { q: string; a: string }[];\n};\n\ntype SeoData = {\n  en: SeoContentBlock;\n  zh: SeoContentBlock;\n};\n\n// Helper: fallback sections for unpopulated types\nconst createFallback = (h2s: string[]): { title: string; content: string }[] => {\n  return h2s.map(h2 => ({\n    title: h2,\n    content: `Technical analysis and engineering definitions for ${h2.toLowerCase()}.`\n  }));\n};\n\nconst seoContent: Record<string, SeoData> = {\n  compression: {\n    en: {\n      h1: \"Compression Spring Calculator & Engineering Design\",\n      sections: [\n        {\n          title: \"What Is a Compression Spring?\",\n          content: \"A compression spring is an open-coil helical spring that offers resistance to a compressive force applied axially. They are the most common metal spring configuration. As the spring is compressed, the wire itself is subjected to torsional stress (shear) despite the linear motion of the spring.\"\n        },\n        {\n          title: \"Spring Rate & Stiffness Formula\",\n          content: \"The spring rate (k) represents the force required to compress the spring by one unit of distance. The physics formula is: k = Gd⁴ / 8D³Nₐ. \\n• G: Shear Modulus (Material Prop)\\n• d: Wire Diameter\\n• D: Mean Diameter\\n• Nₐ: Active Coils. \\nNote strictly: Stiffness increases with the 4th power of wire diameter, making small wire changes effectively double or triple the force.\"\n        },\n        {\n          title: \"Buckling & Slenderness Ratio\",\n          content: \"Long, slender springs are unstable. The 'Slenderness Ratio' is defined as Free Length (L₀) divided by Mean Diameter (D). If L₀/D > 4, the spring will buckle (bow sideways) under load unless supported by a rod or a tube. Engineering best practice is to keep L₀/D < 3.5 for self-stability, or use guide mandates.\"\n        },\n        {\n          title: \"Solid Height & Coil Bind\",\n          content: \"Solid height (L_solid) is the length of the spring when all coils are effectively touching. It acts as a mechanical stop. Compressing a spring to solid height causes 'Coil Bind', leading to infinite stress spikes and immediate failure. Safe design limits max working deflection to roughly 85-90% of the travel to solid.\"\n        },\n        {\n          title: \"End Types: Stability & Cost\",\n          content: \"• Open Ends: Cheapest, but unstable; spring will tip over.\\n• Closed Ends: Last coils touch; better stability.\\n• Closed & Ground Ends: Last coils are ground flat 270-330°. Provides the most vertical squareness and seating stability, preventing eccentric loading (side loads) on the mechanism.\"\n        },\n        {\n          title: \"Stress Analysis: Wahl Factor\",\n          content: \"Simple stress calculations underestimate the shear stress on the inner coil surface. We apply the Wahl Curvature Correction Factor (K_w) to account for this. K_w depends on the Spring Index (C = D/d). Lower indices (tight coils) result in drastically higher local stress peaks.\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"How do you calculate compression spring rate?\",\n          a: \"Rate k = G*d^4 / (8*D^3*Na). Stiffness is driven heavily by wire diameter.\"\n        },\n        {\n          q: \"What causes a compression spring to buckle?\",\n          a: \"A slenderness ratio (Length/Diameter) greater than 4 usually causes buckling unless the spring is supported by a rod or bore.\"\n        },\n        {\n          q: \"What is the difference between closed and ground ends?\",\n          a: \"Ground ends (square ends) stand vertically straight (90°) on a flat surface, ensuring the load is applied axially without tilting forces.\"\n        }\n      ]\n    },\n    zh: {\n      h1: \"压缩弹簧计算器与工程设计工具\",\n      sections: [\n        {\n          title: \"什么是压缩弹簧？\",\n          content: \"压缩弹簧（Compression Spring）是一种承受轴向压力的开放式螺旋弹簧。它是最常见的弹簧形式。虽然弹簧产生直线运动，但从微观力学角度来看，线材截面实际上承受的是“扭转剪切应力” (Torsional Stress)，而非压缩应力。\"\n        },\n        {\n          title: \"刚度计算公式 (Spring Rate)\",\n          content: \"刚度 (k) 定义为每压缩单位距离所需的力。物理公式为：k = Gd⁴ / 8D³Nₐ。\\n• G: 剪切模量 (材料属性)\\n• d: 线径\\n• D: 中径\\n• Nₐ: 有效圈数\\n请注意：刚度与线径的 **4次方** 成正比。这意味着线径微小的增加（如 10%）会导致力度大幅提升（约 46%）。\"\n        },\n        {\n          title: \"屈曲风险与细长比 (Buckling & Slenderness)\",\n          content: \"细长的弹簧在受压时容易发生侧弯（Buckling）。工程上定义“细长比”为自由长 (L₀) 除以中径 (D)。当 L₀/D > 4 时，除非有导杆或导孔支撑，否则弹簧极易失稳侧弯。设计建议保持细长比 < 3.5 以确保自稳性。\"\n        },\n        {\n          title: \"压并高度 (Solid Height) 与安全行程\",\n          content: \"压并高度是指弹簧所有线圈紧密接触时的长度。此时弹簧失去弹性，刚度趋于无穷大。严禁在设计中将工作载荷设定在压并高度！这会导致灾难性的应力峰值和断裂。通常建议最大工作行程不超过总间隙的 85%。\"\n        },\n        {\n          title: \"端部结构：磨平 vs 不磨平\",\n          content: \"• 开口端 (Open Ends)：成本最低，但无法直立，受力不均。\\n• 并紧端 (Closed Ends)：由于螺旋角存在，端面并非绝对平面。\\n• 并紧磨平 (Closed & Ground)：将两端磨平 270°~330°，提供最佳的垂直度，防止弹簧在工作时产生侧向分力 (Side Loading)，是精密机械的首选。\"\n        },\n        {\n          title: \"应力修正：Wahl 修正系数\",\n          content: \"基础公式会低估线圈内侧的剪切应力。工程计算必须引入 Wahl 修正系数 (K_w)。该系数由旋绕比 (Index C) 决定。C 值越小（线圈越紧凑），内侧应力集中越严重，疲劳寿命越短。\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"如何计算压缩弹簧的刚度？\",\n          a: \"刚度 k = Gd^4 / (8D^3*Na)。其中线径 d 的影响最大（四次方关系）。\"\n        },\n        {\n          q: \"压缩弹簧为什么会侧弯（屈曲）？\",\n          a: \"当自由长与直径的比值（细长比）大于 4 时，弹簧就像细长的柱子一样不稳定。此时必须使用导杆或孔来约束。\"\n        },\n        {\n          q: \"磨平端（Ground Ends）有什么好处？\",\n          a: \"磨平端能确保弹簧垂直站立，使接触面受力均匀，避免偏心载荷损坏机械结构。\"\n        }\n      ]\n    }\n  },\n  extension: {\n    en: {\n      h1: \"Extension Spring Calculator with Hook Types & Initial Tension\",\n      sections: [\n        {\n          title: \"What Is an Extension Spring?\",\n          content: \"An extension spring is a helical spring designed to store energy and resist a pulling force. Unlike compression springs, which have zero load at zero deflection, extension springs are wound with 'Initial Tension'—an internal force that keeps the coils tightly closed together. This initial tension must be overcome before the spring begins to extend.\"\n        },\n        {\n          title: \"Extension Spring Rate vs Compression Spring Rate\",\n          content: \"Physically, the spring rate factor (k) formula is identical: k = Gd⁴ / 8D³Nₐ. However, the Force behavior differs significantly. For a compression spring, Force F = kx. For an extension spring, Total Force = Initial Tension (Pᵢ) + kx. This means an extension spring requires a specific threshold force just to start opening.\"\n        },\n        {\n          title: \"Initial Tension Explained\",\n          content: \"Initial Tension (Pᵢ) is the preload force resulting from the coiling process (twisting the wire against the bending direction). It is strictly limited by the Spring Index (C). Higher indices (C > 12) enable less initial tension. Engineering formula: Pᵢ ≈ (π d³ / 8 D) * Initial Stress. Verification: Measure loads at two lengths (L₁ and L₂) where coils are open, then extrapolate back to zero deflection: Pᵢ = 2L₁ - L₂.\"\n        },\n        {\n          title: \"Hook Types: Machine, Cross-Over, Full Loop\",\n          content: \"• Machine Hook: Formed by bending ~75% of a coil directly outwards. Strongest standard hook due to larger bend radii.\\n• Cross-Over Center (Side Loop): Last coil twisted to the center. Most common, cheap, but higher stress concentration.\\n• Full Loop: A complete 360° closed circle. Prevents slip-off, widely used in safety-critical assemblies.\"\n        },\n        {\n          title: \"Stress Concentration at Hooks\",\n          content: \"Hooks are the Achilles' heel of extension springs. While the body only sees torsional stress, the hook bend sees both Bending Stress and Torsional Stress. Local stress at the hook transition can be 2-3x higher than body stress. We apply separate stress correction factors (K₁ for bending, K₂ for torsion) based on the bend radius ratio (r/d).\"\n        },\n        {\n          title: \"Working Deflection & Total Load Calculation\",\n          content: \"Total Load P = Pᵢ + k(L - L₀), where Pᵢ is Initial Tension, k is Rate, L is extended length, L₀ is free length inside hooks. Do not simply use k * deflection. Ensure the max working load stays below the 'Proportional Limit' of the hook bending stress, not just the body torsional stress.\"\n        },\n        {\n          title: \"3D Extension Spring with Proportional Hooks\",\n          content: \"Our 3D visualizer generates physically accurate hooks relative to the body diameter. It checks for 'Body Length' vs 'Free Length' constraints to ensure hooks fit within the specified L₀ envelope.\"\n        },\n        {\n          title: \"Engineering Design Rules for Extension Springs\",\n          content: \"1. Always account for Initial Tension (±15% variance manufacturing tolerance).\\n2. Hooks often fail before the body; reduce hook stress by increasing bend radius.\\n3. Avoid 'Hard Drawing' plated wire if possible; plating inside coils is difficult.\\n4. Design for a Spring Index (C) between 5 and 15 for optimal specific tension control.\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"What is initial tension in an extension spring?\",\n          a: \"Initial tension is the preload force that must be overcome before the spring begins to extend.\"\n        },\n        {\n          q: \"Do hooks affect extension spring strength?\",\n          a: \"Yes. Hooks are the highest stress regions and often govern fatigue life and failure.\"\n        },\n        {\n          q: \"How is total load calculated for extension springs?\",\n          a: \"Total load equals initial tension plus spring rate multiplied by working deflection.\"\n        }\n      ]\n    },\n    zh: {\n      h1: \"拉伸弹簧计算器：钩环类型与初张力分析\",\n      sections: [\n        {\n          title: \"什么是拉伸弹簧？\",\n          content: \"拉伸弹簧（Extension Spring）是一种旨在承受轴向拉力的螺旋弹簧。与压缩弹簧不同，拉伸弹簧在卷绕时具有“初张力”（Initial Tension），这是一种使线圈在无外力状态下紧密闭合的内部预紧力。施加的拉力必须先克服这一初张力，弹簧才会开始发生弹性变形。\"\n        },\n        {\n          title: \"拉伸弹簧与压缩弹簧的刚度对比\",\n          content: \"虽然刚度系数 (k) 的理论公式是相同的：k = Gd⁴ / 8D³Nₐ，但力学行为截然不同。压缩弹簧的力与位移关系为 F = kx；而拉伸弹簧的总拉力公式为 F_total = 初张力 (Pᵢ) + kx。这意味着拉伸弹簧并不是从零力开始变形的，它有一个“启动门槛”。\"\n        },\n        {\n          title: \"初张力 (Initial Tension) 详解\",\n          content: \"初张力 (Pᵢ) 是在冷卷过程中，通过反向扭转线材产生的内应力。其大小受限于旋绕比 (Index C)。旋绕比越大 (C > 12)，难以产生较大的初张力。工程验证方法：测量弹簧拉开后的两个不同长度 L₁ 和 L₂ 对应的载荷，利用线性回归外推至零位移点计算 Pᵢ。标准公差通常为 ±10%~15%。\"\n        },\n        {\n          title: \"钩环类型：机械钩、侧钩、满环\",\n          content: \"• 机械钩 (Machine Hook)：直接将约 3/4 圈线圈向外折弯而成，过渡半径大，强度最高。\\n• 侧钩/过中钩 (Cross-Over Center)：末圈扭转至中心。最常见且成本低，但根部应力集中最严重。\\n• 满环 (Full Loop)：完全闭合的 360° 圆环，安全性高，防止挂钩脱落。\"\n        },\n        {\n          title: \"钩环处的应力集中\",\n          content: \"钩环是拉伸弹簧的“阿喀琉斯之踵”。弹簧体主要承受剪切应力 (Torsional Stress)，而钩环根部同时承受极高的弯曲应力 (Bending Stress)。局部的应力集中系数可能是簧身的 2-3 倍。工程计算必须对钩环进行单独的应力校核（基于弯曲半径比 r/d 的 K₁ 修正系数）。\"\n        },\n        {\n          title: \"工作变形量与总载荷计算\",\n          content: \"计算总载荷 P = Pᵢ + k(L - L₀)。其中 Pᵢ 为初张力，k 为刚度，L 为拉伸后长度，L₀ 为含钩自由长。切勿简单地用 刚度 × 变形量。安全系数校核应基于钩环的断裂强度，而非仅仅是弹簧身的屈服极限。\"\n        },\n        {\n          title: \"3D 拉伸弹簧与标准钩环\",\n          content: \"此工具生成的 3D 模型具备精确的工程比例。它会根据线径和中径自动生成符合制造标准的钩环几何（如过中钩的扭转半径），并校验“体长” (Body Length) 是否在自由长范围内。\"\n        },\n        {\n          title: \"拉伸弹簧工程设计准则\",\n          content: \"1. 务必在设计中预留初张力的制造公差。\\n2. 优先通过增大钩环根部过渡半径 (Bend Radius) 来降低应力，而非仅仅增加线径。\\n3. 高频疲劳应用应慎用拉伸弹簧，或采用“活塞式压簧”替代方案，因为钩环几乎总是疲劳失效点。\\n4. 推荐旋绕比 (Index) 控制在 5-15 之间以获得最佳的初张力控制能力。\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"什么是拉伸弹簧的初张力？\",\n          a: \"初张力是在弹簧开始拉伸之前必须克服的预紧力，由卷绕工艺中线圈紧密接触产生。\"\n        },\n        {\n          q: \"钩环会影响拉伸弹簧的强度吗？（重点）\",\n          a: \"是影响最大的因素。钩环根部的弯曲应力远高于簧身的剪切应力，90% 的拉伸弹簧失效都发生在钩环根部。必须进行独立的应力验算。\"\n        },\n        {\n          q: \"如何计算拉伸弹簧的总载荷？\",\n          a: \"总载荷 P = 初张力 (Pi) + (刚度 k × 变形量 F)。\"\n        }\n      ]\n    }\n  },\n  torsion: {\n    en: {\n      h1: \"Torsion Spring Calculator & Bending Stress Analysis\",\n      sections: [\n        {\n          title: \"It's Actually 'Bending', Not Torsion\",\n          content: \"Despite the name, a helical 'Torsion Spring' subjects its wire to Bending Stress, not Torsional Stress. When you twist the legs, the wire is effectively being 'coiled tighter' (or looser), causing the wire material to flex in bending. This means we use Young's Modulus (E) for calculation, NOT Shear Modulus (G).\"\n        },\n        {\n          title: \"Torque Formula & Spring Constant\",\n          content: \"Torque M = E * d⁴ * θ / (10.8 * D * Nₐ). \\nNote the use of E (Elastic Modulus). The 10.8 constant is empirical for round wire. The torque is linear with angle θ up to the elastic limit.\"\n        },\n        {\n          title: \"Diameter Shrinkage (Crucial!)\",\n          content: \"As a torsion spring is wound up (tightened), its coil diameter decreases and its body length increases. \\nFormula: D_new = (N * D) / (N + θ_revolutions). \\nDesign Rule: You MUST leave sufficient clearance between the mandrel (shaft) and the spring's ID. If the spring bites onto the mandrel, it will lock up and fail instantly.\"\n        },\n        {\n          title: \"Direction of Winding\",\n          content: \"Torsion springs must always be loaded in the direction that 'winds them up' (decreases diameter). Loading them to 'open' leads to erratic residual stress behavior and premature failure. Always specify Left Hand (LH) or Right Hand (RH) wound to match the force direction.\"\n        },\n        {\n          title: \"Leg Configurations\",\n          content: \"Legs transmit the torque. Common types: Tangential Legs (straight off the coil), Axial Legs (bent parallel to axis), or Radial Legs (bent towards center). The bending radius where the leg leaves the body is a high-stress point.\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"Why do torsion springs use Young's Modulus (E) instead of G?\",\n          a: \"Because the wire is physically bending as the coil tightens, even though the spring assembly provides torque.\"\n        },\n        {\n          q: \"What happens if the mandrel is too big?\",\n          a: \"The spring ID will shrink during operation, grip the mandrel, and cause the spring to lock or break (bind).\"\n        },\n        {\n          q: \"Can I load a torsion spring backwards (unwinding it)?\",\n          a: \"Not recommended. It fights against the residual stresses from manufacturing, significantly lowering the maximum load capacity.\"\n        }\n      ]\n    },\n    zh: {\n      h1: \"扭转弹簧计算器与弯曲应力分析\",\n      sections: [\n        {\n          title: \"名不副实：其实是“弯曲应力”\",\n          content: \"尽管名字叫“扭转弹簧”（Torsion Spring），但其线材实际承受的是 **弯曲应力 (Bending Stress)**，而非扭转剪切应力。当力臂旋转时，线圈被“卷得更紧”，线材发生弯曲变形。因此，计算时必须使用 **弹性模量 (E)**，而不是剪切模量 (G)。这是一个常见的工程误区。\"\n        },\n        {\n          title: \"扭矩 (Torque) 计算公式\",\n          content: \"扭矩 T = E * d⁴ * θ / (10.8 * D * Nₐ)。\\n注意公式中使用的是 E。常数 10.8 是针对圆丝的经验修正值。在弹性限度内，扭矩与转角 θ 成正比。\"\n        },\n        {\n          title: \"内径收缩效应 (极重要！)\",\n          content: \"扭转弹簧在工作（旋紧）时，其圈数增加，导致 **内径 (ID) 缩小**，体长 (Body Length) 增加。\\n收缩公式：D_new = (N * D) / (N + 圈数增加量)。\\n设计天条：必须在芯轴 (Mandrel) 和弹簧内径之间预留足够的“抱紧间隙”。如果弹簧抱死芯轴，会导致瞬间失效或磨损。\"\n        },\n        {\n          title: \"旋向选择：左旋 vs 右旋\",\n          content: \"扭转弹簧的设计必须使其在工作时处于“旋紧”方向。反向加载（旋松方向）会对抗制造时的残余应力，导致承载能力大幅下降。必须根据安装力矩方向明确指定 左旋 (Left Hand) 或 右旋 (Right Hand)。\"\n        },\n        {\n          title: \"力臂配置 (Leg Configurations)\",\n          content: \"常见的力臂形式包括：切向直臂 (Tangential)、轴向折弯臂 (Axial)、径向内折 (Radial)。力臂根部的折弯处是应力最集中的地方，应尽量保持较大的折弯半径。\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"计算扭转弹簧为什么要用弹性模量 E？\",\n          a: \"因为线材在微观上发生的是弯曲变形，只有宏观上表现为扭转力矩。\"\n        },\n        {\n          q: \"芯轴 (Mandrel) 尺寸怎么选？\",\n          a: \"芯轴直径通常建议为弹簧最大变形时内径的 90%，务必计算“缩径”后的尺寸。\"\n        },\n        {\n          q: \"扭转弹簧可以反向使用（旋松）吗？\",\n          a: \"不建议。反向使用会抵消冷卷工艺带来的有益残余应力，导致弹簧过早屈服。\"\n        }\n      ]\n    }\n  },\n  dieSpring: {\n    en: {\n      h1: \"Die Spring Calculator & ISO 10243 Standards\",\n      sections: [\n        {\n          title: \"Rectangular Wire Advantage\",\n          content: \"Die springs utilize a flattened, rectangular wire cross-section (unlike the round wire of standard springs). This geometry puts more metal into the same volume (higher packing density), allowing die springs to carry 30-50% more load than equivalent round-wire springs in the same space.\"\n        },\n        {\n          title: \"ISO 10243 Color Codes (Standard)\",\n          content: \"Globally recognized color coding for load classes:\\n• Green: Light Load\\n• Blue: Medium Load\\n• Red: Heavy Load\\n• Yellow: Extra Heavy Load\\nNote: Always verify the standard. ISO 10243 is the most common in Europe/Global, but Japanese JIS B 5012 uses different colors for similar loads (e.g., JIS Red is not ISO Red). Mixing these is dangerous.\"\n        },\n        {\n          title: \"Material Selection & Temperature Limits\",\n          content: \"• Chrome Vanadium (50CrV4): Good for general use, max operating temp approx 200°C (390°F).\\n• Chrome Silicon (55CrSi): Superior heat resistance and fatigue life, capable of operating up to 246°C (475°F). Most premium ISO die springs are now made of Chrome Silicon to prevent 'setting' (loss of height) under heat.\"\n        },\n        {\n          title: \"Life Expectancy vs Deflection\",\n          content: \"Die springs are rated for millions of cycles ONLY if operated within strict deflection limits.\\n• Long Life (1,000,000+ cycles): Use < 25% deflection.\\n• Average Life: Use ~30% deflection.\\n• Max Deflection: Pushing near 40% deflection drops life drastically to < 100,000 cycles. Never compress to solid height!\"\n        },\n        {\n          title: \"High-Speed Stamping Considerations\",\n          content: \"In high-speed presses (>500 SPM), 'Spring Surge' (resonance) becomes a killer. Friction generates massive heat. High-end die springs use a 'Trapezoidal' cross-section wire that deforms into a perfect rectangle only when coiled, ensuring optimal contact and heat dissipation.\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"Are ISO and JIS die springs interchangeable?\",\n          a: \"NO. While dimensions may look similar, the color codes mean completely different load ratings. Always check the catalog standard (ISO 10243 vs JIS B 5012).\"\n        },\n        {\n          q: \"Why use rectangular wire?\",\n          a: \"It maximizes the cross-sectional area in the available space, providing maximum energy storage density.\"\n        },\n        {\n          q: \"What is the max operating temperature for die springs?\",\n          a: \"Typically 200°C for Chrome Vanadium and up to 246°C for Chrome Silicon. Above this, the spring will permanently shorten (relax).\"\n        }\n      ]\n    },\n    zh: {\n      h1: \"模具弹簧计算器与 ISO 10243 标准分析\",\n      sections: [\n        {\n          title: \"矩形截面的优势\",\n          content: \"模具弹簧（Die Spring）采用扁平的矩形截面线材。这种几何结构使得在相同空间内可以容纳更多的金属材料（高填充密度）。因此，模具弹簧的承载能力比同体积圆丝弹簧高出 30% 到 50%，非常适合模具等空间受限的大力载场合。\"\n        },\n        {\n          title: \"ISO 10243 颜色代码标准\",\n          content: \"国际通用的载荷等级色标：\\n• 绿色 (Green)：轻载荷\\n• 蓝色 (Blue)：中载荷\\n• 红色 (Red)：重载荷\\n• 黄色 (Yellow)：超重载荷\\n警告：务必确认标准！ISO 10243 与日标 JIS B 5012 的颜色含义不同（例如 JIS 的红色可能对应不同的载荷等级），不可混用。\"\n        },\n        {\n          title: \"材料选择与耐温极限\",\n          content: \"• 铬钒钢 (50CrV4)：通用材料，最高工作温度约 200°C。\\n• 铬硅钢 (55CrSi)：具有更优异的抗疲劳和耐热性能，最高工作温度可达 246°C (475°F)。为了防止在高温下发生“热衰减”（自由长缩短），高端模具弹簧现多采用铬硅钢制造。\"\n        },\n        {\n          title: \"疲劳寿命与压缩量关系\",\n          content: \"模具弹簧只有在严格限制压缩量的前提下才能达到百万次寿命。\\n• 长寿命 (100万次+)：控制压缩量 < 25% 自由长。\\n• 一般寿命：压缩量 ~30%。\\n• 极限使用：若压缩量接近 40%，寿命将急剧下降至 <10万次。严禁压死（Solid）！\"\n        },\n        {\n          title: \"高速冲压中的共振问题\",\n          content: \"在高速冲床 (>500 SPM) 中，弹簧容易产生“驻波” (Surge)。为了减少内部摩擦生热，高端模具弹簧采用“梯形”截面线材卷绕，卷绕后内侧受压变形，截面才变为完美的矩形，从而由线接触变为面接触，散热更好。\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"ISO 模具弹簧和 JIS 模具弹簧能互换吗？\",\n          a: \"不能。虽然尺寸可能接近，但颜色代表的载荷等级完全不同。混用会导致模具受力不平衡或弹簧早期断裂。\"\n        },\n        {\n          q: \"模具弹簧的最高工作温度是多少？\",\n          a: \"铬钒钢通常为 200°C，铬硅钢可达 246°C。超过此温度弹簧会发生永久塑性变形（变短）。\"\n        },\n        {\n          q: \"模具弹簧能被压到底吗？\",\n          a: \"绝对不行。模具弹簧是针对高周疲劳设计的，压死瞬间的应力会远超屈服极限。\"\n        }\n      ]\n    }\n  },\n  wave: {\n    en: {\n      h1: \"Wave Spring Calculator & Space Saving Design\",\n      sections: [\n        {\n          title: \"The 50% Space Advantage\",\n          content: \"Wave springs are the ultimate problem solver for axial space constraints. They typically occupy only 50% of the compressed height of an equivalent helical coil spring while delivering the same force. Ideally suited for miniature devices, connectors, and seal pre-loading.\"\n        },\n        {\n          title: \"Mechanism of Action\",\n          content: \"Unlike coil springs (torsional stress), wave springs operate purely in bending (beam theory). As the waves flatten, the reaction force is generated. Since the wire is flat and the waves nest, the solid height is minimal—just the stack of wire thicknesses.\"\n        },\n        {\n          title: \"Multi-Turn Features\",\n          content: \"Gap or Overlap types allow for Multi-Turn designs (Crest-to-Crest). This stacking increases total deflection without increasing the spring rate, similar to series-stacked Belleville washers but in a single integrated piece.\"\n        },\n        {\n          title: \"Bore/Shaft Expansion Check\",\n          content: \"Similar to retaining rings, wave springs expand in diameter when compressed. Design must ensure the OD does not bind against the Bore wall at maximum compression.\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"How much space does a wave spring save?\",\n          a: \"Approximately 50% of the axial operating height compared to a standard coil spring.\"\n        },\n        {\n          q: \"Are wave springs made of stamped washers?\",\n          a: \"Usually no. High-performance wave springs are 'coiled' (edge-wound) from flat wire, preserving the metal grain structure for better fatigue strength than stamped variants.\"\n        }\n      ]\n    },\n    zh: {\n      h1: \"波形弹簧计算器与空间优化设计\",\n      sections: [\n        {\n          title: \"50% 的空间节省优势\",\n          content: \"波形弹簧 (Wave Spring) 是解决轴向空间不足的终极方案。与普通螺旋弹簧相比，在提供相同载荷的前提下，波形弹簧通常仅占用 50% 的工作高度。特别适用于精密仪器、连接器和机械密封预压。\"\n        },\n        {\n          title: \"力学原理：梁的弯曲\",\n          content: \"不同于螺旋弹簧的扭转应力，波形弹簧工作时主要发生 **弯曲变形**（类似简支梁）。随着波峰被压平，产生回弹力。由于采用扁丝且波纹可层叠，其压并高度极低（几乎等于线材厚度总和）。\"\n        },\n        {\n          title: \"对顶波簧 (Crest-to-Crest)\",\n          content: \"通过多层对顶堆叠（Multi-Turn），波簧可以在不增加刚度的情况下大幅增加行程。这类似于碟形弹簧的串联组合，但波簧是单体成型的，无需复杂的导向组件，安装更便捷。\"\n        },\n        {\n          title: \"直径膨胀效应\",\n          content: \"波簧在压平时，外径 (OD) 会略微变大。设计孔安装 (Bore) 时，必须预留间隙，防止压至最低点时波簧卡死在孔壁上。\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"波形弹簧可以节省多少空间？\",\n          a: \"通常可节省约 50% 的轴向高度空间。\"\n        },\n        {\n          q: \"波簧是冲压出来的吗？\",\n          a: \"高质量波簧通常采用扁钢丝‘绕制’（Edge-Winding）而成。绕制工艺保留了金属晶粒流线，疲劳强度优于冲压件。\"\n        }\n      ]\n    }\n  },\n  conical: {\n    en: {\n      h1: \"Conical Spring Calculator & Telescoping Design\",\n      sections: [\n        {\n          title: \"Telescoping Ability (Near-Zero Solid Height)\",\n          content: \"The defining feature of a conical spring is its ability to telescope. If designed correctly (coil pitch > wire diameter), the coils nest inside each other completely perfectly. This allows the Solid Height to be as low as a single wire diameter (1x d), solving extreme clearance problems.\"\n        },\n        {\n          title: \"Variable (Progressive) Rate\",\n          content: \"As a conical spring compresses, the larger outer coils are softer and compress first. Once they bottom out (touch), they become inactive. This reduces the number of active coils, causing the spring rate to stiffen progressively. The Force-Deflection curve is non-linear (curved).\"\n        },\n        {\n          title: \"Buckling Stability\",\n          content: \"The tapered shape provides inherent lateral stability. Conical springs are far less prone to buckling than cylindrical springs, often eliminating the need for a guide rod.\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"What is the solid height of a telescoping conical spring?\",\n          a: \"Ideally, it is just one wire diameter (or thickness), as all coils nest flat within each other.\"\n        },\n        {\n          q: \"Why is the spring rate non-linear?\",\n          a: \"Because the active coils gradually touch down and become inactive, stiffening the remaining spring.\"\n        }\n      ]\n    },\n    zh: {\n      h1: \"锥形弹簧计算器与套叠设计\",\n      sections: [\n        {\n          title: \"完全套叠 (Telescoping) 能力\",\n          content: \"锥形弹簧的核心优势是其套叠能力。如果设计得当（节距合适），各圈线圈可以完全嵌入下一圈内部。这意味着其 **压并高度 (Solid Height)** 可以低至仅为一个线径 (1x d)，完美解决极限压缩空间问题。\"\n        },\n        {\n          title: \"渐进式刚度 (Progressive Rate)\",\n          content: \"锥形弹簧受压时，大直径线圈较软，先发生变形并接触底部。一旦大圈接触“死掉”，有效圈数减少，剩余部分的刚度瞬间变大。因此，其 载荷-位移曲线 是非线性的（逐渐变硬），具有良好的缓冲特性。\"\n        },\n        {\n          title: \"抗侧弯自稳性\",\n          content: \"锥体几何形状天然具有极佳的侧向稳定性。与圆柱弹簧相比，锥形弹簧极难发生侧弯（Buckling），通常不需要导杆即可稳定工作。\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"锥形弹簧的压并高度是多少？\",\n          a: \"对于完全套叠设计，压并高度理论上仅等于一根钢丝的直径。\"\n        },\n        {\n          q: \"为什么刚度是变化的？\",\n          a: \"因为随着压缩，大线圈先着地失去弹性，剩余工作的线圈变少，整体刚度随之上升。\"\n        }\n      ]\n    }\n  },\n  spiralTorsion: {\n    en: {\n      h1: \"Spiral Torsion Spring Calculator (Clock Springs)\",\n      sections: [\n        {\n          title: \"Planar Torque Generation\",\n          content: \"Spiral torsion springs (or Clock Springs) are wound from flat strip material in a planar spiral. They produce torque usually for less than 360° rotation (standard) or multiple turns (power springs). Common in seat belts, retractors, and balance wheels.\"\n        },\n        {\n          title: \"Torque Formula\",\n          content: \"Torque M = (E * b * t³ * θ) / (6 * L). \\n• b: strip width\\n• t: strip thickness (most critical, cubic effect)\\n• L: Active length.\\nThe torque is generally linear for the first few turns until coil-to-coil friction interferes.\"\n        },\n        {\n          title: \"Power Springs vs Hairsprings\",\n          content: \"• Hairsprings: Spaced coils, zero friction, linear torque. Used in instruments.\\n• Power Springs: Tightly wound, coils touch. High friction (hysteresis). Used for retraction or energy storage (toys, seatbelts).\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"How does strip thickness affect torque?\",\n          a: \"Torque is proportional to the **cube** of thickness (t³). Doubling strip thickness increases torque by 8 times.\"\n        },\n        {\n          q: \"What causes hysteresis in spiral springs?\",\n          a: \"Friction between the coils as they slide against each other during winding/unwinding.\"\n        }\n      ]\n    },\n    zh: {\n      h1: \"螺旋扭转弹簧计算器（平面涡卷弹簧）\",\n      sections: [\n        {\n          title: \"平面扭矩发生器\",\n          content: \"螺旋扭转弹簧（又称发条弹簧、涡卷弹簧）由扁平带材在平面内卷绕而成。它们用于产生旋转扭矩，常见于安全带卷收器、电缆卷筒、钟表游丝等。\"\n        },\n        {\n          title: \"扭矩计算公式\",\n          content: \"扭矩 M = (E * b * t³ * θ) / (6 * L)。\\n• b: 带宽\\n• t: 带厚 (最关键，三次冥影响)\\n• L: 有效展开长度\\n通常在初始几圈旋转内，扭矩输出是线性的。\"\n        },\n        {\n          title: \"动力发条 vs 游丝\",\n          content: \"• 游丝 (Hairsprings)：圈与圈不接触，无摩擦，扭矩极度线性，用于精密仪表。\\n• 动力发条 (Power Springs)：圈与圈紧密接触，存在层间摩擦（滞后效应），用于储能或回收机构（如卷尺）。\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"带材厚度对扭矩影响有多大？\",\n          a: \"扭矩与厚度的 **立方** 成正比。厚度增加一倍，扭矩增加 8 倍。\"\n        },\n        {\n          q: \"什么是发条的滞后 (Hysteresis)？\",\n          a: \"由于层间摩擦，上发条需要的力比释放时发出的力要大，中间的差值即为摩擦损耗的能量。\"\n        }\n      ]\n    }\n  },\n  suspensionSpring: {\n    en: {\n      h1: \"Vehicle Shock Absorber Spring & Suspension Design\",\n      sections: [\n        {\n          title: \"Cold Coiling vs Hot Coiling\",\n          content: \"Manufacturing method depends on wire diameter.\\n• Cold Coiling: Used for d < 20mm. High precision, excellent surface finish. Ideal for passenger cars and light trucks.\\n• Hot Coiling: Used for d > 20mm (up to 65mm). The bar is heated to ~900°C to be malleable. Used for heavy trucks, trains, and industrial isolators.\"\n        },\n        {\n          title: \"Ride Frequency (Natural Frequency)\",\n          content: \"The single most important comfort metric. \\n• Comfort (Sedans): 1.0 - 1.2 Hz (Matches human walking cadence).\\n• Performance (Sports): 1.5 - 2.0 Hz.\\n• Racing (Downforce): > 3.0 Hz.\\nFrequency (Hz) ≈ 0.5 * √(Rate / Mass). To stiffen a car without ruining comfort, you must reduce unsprung mass along with increasing rate.\"\n        },\n        {\n          title: \"Progressive Rate Designs\",\n          content: \"Most modern stock springs are 'Progressive'. This is achieved by Tapered Wire (variable diameter) or Variable Pitch (changing gap). Soft initial coils absorb small road cracks (highway comfort), while stiffer final coils prevent bottoming out during hard cornering or potholes.\"\n        },\n        {\n          title: \"Corrosion Protection: 500h+ Salt Spray\",\n          content: \"Suspension springs face the harshest environment: road salt, gravel impact, and water. Automotive standards (e.g., ASTM B117) require passing 500 to 1000 hours of salt spray testing. This is achieved via a dual-layer coating: Zinc-Phosphate pretreatment followed by High-Performance Epoxy Powder Coating.\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"What is the difference between linear and progressive springs?\",\n          a: \"Linear springs have a constant stiffness (k). Progressive springs get stiffer as they compress, offering a dual-nature ride: soft for comfort, stiff for control.\"\n        },\n        {\n          q: \"Why are suspension springs shot peened?\",\n          a: \"Shot peening bombards the surface with steel beads to induce compressive stress. This prevents micro-cracks from opening, extending fatigue life by 5-10x.\"\n        },\n        {\n          q: \"How often should suspension springs be replaced?\",\n          a: \"They normally last the life of the vehicle, but should be replaced if they sag (ride height loss) or if the coating is compromised by rust.\"\n        }\n      ]\n    },\n    zh: {\n      h1: \"汽车减震弹簧计算器与悬挂工程设计\",\n      sections: [\n        {\n          title: \"冷卷 (Cold Coiling) vs 热卷 (Hot Coiling)\",\n          content: \"制造工艺取决于线径：\\n• 冷卷工艺：适用于线径 d < 20mm。精度极高，表面质量好，是轿车和轻卡悬挂的主流工艺。\\n• 热卷工艺：适用于线径 d > 20mm（最大可达 65mm）。钢棒需加热至 900°C 以上才能卷绕。主要用于重卡、火车和大型工业减震器。\"\n        },\n        {\n          title: \"行驶频率 (Ride Frequency) 与舒适度\",\n          content: \"这是衡量悬挂舒适度的核心指标（自然频率）。\\n• 舒适型 (轿车)：1.0 - 1.2 Hz (接近人类步行频率，大脑最适应)。\\n• 运动型 (跑车)：1.5 - 2.0 Hz。\\n• 赛车型 (下压力)：> 3.0 Hz。\\n频率 Hz ≈ 0.5 * √(刚度 / 簧上质量)。要想车身更稳而不颠，必须精确匹配刚度与质量比。\"\n        },\n        {\n          title: \"渐进式刚度 (Progressive Rate) 设计\",\n          content: \"现代原厂弹簧多为“渐进式”。通过 **变节距 (Variable Pitch)** 或 **变截面 (Tapered Wire)** 实现。疏松的线圈先工作，吸收细微震动（高速巡航）；密集的线圈后工作，在剧烈过弯或大坑洼时提供强大支撑，防止触底。\"\n        },\n        {\n          title: \"防腐蚀标准：500小时+ 盐雾测试\",\n          content: \"底盘环境极其恶劣（融雪剂、碎石）。汽车级标准（ASTM B117）通常要求通过 500-1000 小时的中性盐雾测试。标准工艺为：锌磷化前处理 + 高性能环氧粉末涂层 (Epoxy Powder Coating)，漆膜厚度需 > 80μm。\"\n        }\n      ],\n      faqs: [\n        {\n          q: \"线性弹簧和渐进式弹簧有什么区别？\",\n          a: \"线性弹簧刚度恒定。渐进式弹簧越压越硬，能兼顾“软”的初段舒适性和“硬”的末段支撑性。\"\n        },\n        {\n          q: \"为什么减震弹簧必须喷丸 (Shot Peening)？\",\n          a: \"喷丸能在金属表层产生压应力，抵消拉伸应力，防止微裂纹扩展。经过喷丸的弹簧疲劳寿命通常是未经处理的 5-10 倍。\"\n        },\n        {\n          q: \"减震弹簧大概多久更换？\",\n          a: \"通常与车同寿。但如果发现车身高度降低（弹簧塌陷）或涂层剥落生锈，应立即更换以免断裂刺破轮胎。\"\n        }\n      ]\n    }\n  }\n};\n\ninterface SpringSeoContentProps {\n  type: SpringType;\n  className?: string;\n}\n\nexport function SpringSeoContent({ type, className }: SpringSeoContentProps) {\n  const { language } = useLanguage();\n  const isZh = language === \"zh\";\n  \n  const contentMap = seoContent[type];\n  if (!contentMap) return null;\n\n  const content = isZh ? contentMap.zh : contentMap.en;\n\n  return (\n    <article className={cn(\"space-y-12 py-10\", className)}>\n      <div className=\"border-t border-slate-200 pt-10\">\n        <h1 className=\"text-3xl font-bold tracking-tight text-slate-900 mb-6\">\n          {content.h1}\n        </h1>\n        \n        <div className=\"grid gap-8 md:grid-cols-2 lg:grid-cols-3\">\n          {content.sections.map((section, i) => (\n            <section key={i} className=\"prose prose-sm prose-slate\">\n              <h2 className=\"text-lg font-semibold text-slate-800 mb-2\">{section.title}</h2>\n              <p className=\"text-slate-500 whitespace-pre-line leading-relaxed\">\n                {section.content}\n              </p>\n            </section>\n          ))}\n        </div>\n      </div>\n\n      {content.faqs.length > 0 && (\n        <div className=\"rounded-2xl bg-slate-50 p-8\">\n          <h2 className=\"text-2xl font-semibold mb-6\">\n            {isZh ? \"常见工程问题 (FAQ)\" : \"Frequently Asked Questions\"}\n          </h2>\n          <Accordion type=\"single\" collapsible className=\"w-full\">\n            {content.faqs.map((faq, i) => (\n              <AccordionItem key={i} value={`item-${i}`}>\n                <AccordionTrigger className=\"text-left font-medium text-slate-900\">\n                  {faq.q}\n                </AccordionTrigger>\n                <AccordionContent className=\"text-slate-600\">\n                  {faq.a}\n                </AccordionContent>\n              </AccordionItem>\n            ))}\n          </Accordion>\n        </div>\n      )}\n    </article>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/site-footer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/site-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/ArcSpringMesh.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'approxTauMax' is defined but never used.","line":98,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":98,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":178,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4925,4928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4925,4928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: This value cannot be modified\n\nModifying a value returned from a hook is not allowed. Consider moving the modification into the hook where the value is constructed.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/ArcSpringMesh.tsx:192:5\n  190 |\n  191 |     camera.position.set(center.x + dist * 0.8, center.y - dist * 0.6, center.z + dist * 0.8);\n> 192 |     camera.near = Math.max(0.1, maxDim / 100);\n      |     ^^^^^^ `camera` cannot be modified\n  193 |     camera.far = Math.max(5000, maxDim * 100);\n  194 |     camera.updateProjectionMatrix();\n  195 |","line":192,"column":5,"nodeType":null,"endLine":192,"endColumn":11}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useRef } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls, Edges, Line } from \"@react-three/drei\";\nimport * as THREE from \"three\";\nimport { previewTheme } from \"@/lib/three/previewTheme\";\nimport {\n  createArcSpringTubeGeometry,\n  validateArcSpringGeometry,\n  type ArcSpringGeometryParams,\n} from \"@/lib/spring3d/arcSpringGeometry\";\n\ntype ArcSpringColorMode = \"solid\" | \"approx_stress\";\n\nfunction lerp(a: number, b: number, t: number) {\n  return a + (b - a) * t;\n}\n\nfunction colorRampGyr(t: number): [number, number, number] {\n  const x = Math.max(0, Math.min(1, t));\n  if (x <= 0.5) {\n    const u = x / 0.5;\n    return [lerp(0.1, 1.0, u), lerp(0.8, 0.85, u), lerp(0.2, 0.05, u)];\n  }\n  const u = (x - 0.5) / 0.5;\n  return [lerp(1.0, 1.0, u), lerp(0.85, 0.15, u), lerp(0.05, 0.05, u)];\n}\n\nfunction applyApproxStressColors(geometry: THREE.BufferGeometry, beta: number) {\n  const posAttr = geometry.getAttribute(\"position\") as THREE.BufferAttribute | undefined;\n  const normalAttr = geometry.getAttribute(\"normal\") as THREE.BufferAttribute | undefined;\n  if (!posAttr || !normalAttr) return;\n\n  const count = posAttr.count;\n  const colors = new Float32Array(count * 3);\n  const b = Math.max(0, Math.min(0.9, beta));\n  const denom = b > 0 ? 2 * b : 1;\n\n  for (let i = 0; i < count; i++) {\n    const px = posAttr.getX(i);\n    const py = posAttr.getY(i);\n    const nx = normalAttr.getX(i);\n    const ny = normalAttr.getY(i);\n\n    const invLen = 1 / Math.max(1e-9, Math.hypot(px, py));\n    const dx = -px * invLen;\n    const dy = -py * invLen;\n\n    const nLen = 1 / Math.max(1e-9, Math.hypot(nx, ny));\n    const nnx = nx * nLen;\n    const nny = ny * nLen;\n\n    const dot = nnx * dx + nny * dy;\n    const factor = 1 + b * dot;\n    const t = b > 0 ? (factor - (1 - b)) / denom : 0.5;\n\n    const [r, g, bl] = colorRampGyr(t);\n    colors[i * 3 + 0] = r;\n    colors[i * 3 + 1] = g;\n    colors[i * 3 + 2] = bl;\n  }\n\n  geometry.setAttribute(\"color\", new THREE.BufferAttribute(colors, 3));\n}\n\nexport interface ArcSpringMeshProps {\n  d: number;\n  D: number;\n  n: number;\n  r: number;\n  alpha0Deg: number;\n  deadCoilsStart?: number;\n  deadCoilsEnd?: number;\n  deadTightnessK?: number;\n  deadTightnessSigma?: number;\n  colorMode?: ArcSpringColorMode;\n  approxTauMax?: number;\n  approxStressBeta?: number;\n  color?: string;\n  metalness?: number;\n  roughness?: number;\n  wireframe?: boolean;\n  showCenterline?: boolean;\n}\n\nexport function ArcSpringMesh({\n  d,\n  D,\n  n,\n  r,\n  alpha0Deg,\n  deadCoilsStart = 0,\n  deadCoilsEnd = 0,\n  deadTightnessK = 0,\n  deadTightnessSigma = 0,\n  colorMode = \"solid\",\n  approxTauMax,\n  approxStressBeta = 0.25,\n  color = \"#6b9bd1\",\n  metalness = previewTheme.material.spring.metalness,\n  roughness = previewTheme.material.spring.roughness,\n  wireframe = false,\n  showCenterline = false,\n}: ArcSpringMeshProps) {\n  const params: ArcSpringGeometryParams = useMemo(\n    () => ({ d, D, n, r, alpha0Deg }),\n    [d, D, n, r, alpha0Deg]\n  );\n\n  const validation = useMemo(() => validateArcSpringGeometry(params), [params]);\n\n  const { geometry, centerline } = useMemo(() => {\n    if (!validation.valid) {\n      return { geometry: new THREE.BoxGeometry(10, 10, 10), centerline: [] as THREE.Vector3[] };\n    }\n\n    const res = createArcSpringTubeGeometry(params, {\n      centerArc: true,\n      radialSegments: 16,\n      deadCoilsStart,\n      deadCoilsEnd,\n      deadDensityFactor: 4,\n      tightnessK: deadTightnessK,\n      tightnessSigma: deadTightnessSigma,\n    });\n    if (colorMode === \"approx_stress\") {\n      applyApproxStressColors(res.geometry, approxStressBeta);\n    }\n    return res;\n  }, [\n    params,\n    validation.valid,\n    deadCoilsStart,\n    deadCoilsEnd,\n    deadTightnessK,\n    deadTightnessSigma,\n    colorMode,\n    approxStressBeta,\n  ]);\n\n  useEffect(() => {\n    return () => {\n      geometry.dispose();\n    };\n  }, [geometry]);\n\n  return (\n    <group>\n      <mesh geometry={geometry} castShadow receiveShadow>\n        {colorMode === \"approx_stress\" ? (\n          <meshBasicMaterial\n            color={validation.valid ? \"#ffffff\" : \"#ff4444\"}\n            wireframe={wireframe}\n            side={THREE.DoubleSide}\n            vertexColors\n          />\n        ) : (\n          <meshStandardMaterial\n            color={validation.valid ? color : \"#ff4444\"}\n            metalness={metalness}\n            roughness={roughness}\n            wireframe={wireframe}\n            side={THREE.DoubleSide}\n          />\n        )}\n        <Edges threshold={35} color=\"#1a365d\" />\n      </mesh>\n      {showCenterline && centerline.length > 1 && (\n        <Line points={centerline} color=\"#93c5fd\" lineWidth={1} />\n      )}\n    </group>\n  );\n}\n\nfunction FitToObject({ groupRef, autoRotate }: { groupRef: React.RefObject<THREE.Group | null>; autoRotate: boolean }) {\n  const { camera } = useThree();\n  const controlsRef = useRef<any>(null);\n\n  useEffect(() => {\n    const obj = groupRef.current;\n    if (!obj) return;\n\n    const box = new THREE.Box3().setFromObject(obj);\n    const size = box.getSize(new THREE.Vector3());\n    const center = box.getCenter(new THREE.Vector3());\n\n    const maxDim = Math.max(size.x, size.y, size.z);\n    const dist = maxDim * 2.0;\n\n    camera.position.set(center.x + dist * 0.8, center.y - dist * 0.6, center.z + dist * 0.8);\n    camera.near = Math.max(0.1, maxDim / 100);\n    camera.far = Math.max(5000, maxDim * 100);\n    camera.updateProjectionMatrix();\n\n    if (controlsRef.current) {\n      controlsRef.current.target.copy(center);\n      controlsRef.current.update();\n    }\n  }, [camera, groupRef]);\n\n  return (\n    <OrbitControls\n      ref={controlsRef}\n      makeDefault\n      enablePan={true}\n      enableZoom={true}\n      enableRotate={true}\n      autoRotate={autoRotate}\n      autoRotateSpeed={0.8}\n    />\n  );\n}\n\nexport interface ArcSpringVisualizerProps {\n  d?: number;\n  D?: number;\n  n?: number;\n  r?: number;\n  alpha0Deg?: number;\n  useDeadCoils?: boolean;\n  deadCoilsPerEnd?: number;\n  deadTightnessK?: number;\n  deadTightnessSigma?: number;\n  colorMode?: ArcSpringColorMode;\n  approxTauMax?: number;\n  approxStressBeta?: number;\n  autoRotate?: boolean;\n  wireframe?: boolean;\n  showCenterline?: boolean;\n}\n\ntype ArcSpringSceneProps = {\n  d: number;\n  D: number;\n  n: number;\n  r: number;\n  alpha0Deg: number;\n  useDeadCoils: boolean;\n  deadCoilsPerEnd: number;\n  deadTightnessK: number;\n  deadTightnessSigma: number;\n  colorMode: ArcSpringColorMode;\n  approxTauMax?: number;\n  approxStressBeta: number;\n  autoRotate: boolean;\n  wireframe: boolean;\n  showCenterline: boolean;\n};\n\nfunction ArcSpringScene({\n  d,\n  D,\n  n,\n  r,\n  alpha0Deg,\n  useDeadCoils,\n  deadCoilsPerEnd,\n  deadTightnessK,\n  deadTightnessSigma,\n  colorMode,\n  approxTauMax,\n  approxStressBeta,\n  autoRotate,\n  wireframe,\n  showCenterline,\n}: ArcSpringSceneProps) {\n  const groupRef = useRef<THREE.Group>(null);\n\n  return (\n    <>\n      <color attach=\"background\" args={[previewTheme.background]} />\n      <ambientLight intensity={previewTheme.lights.ambient} />\n      <directionalLight position={previewTheme.lights.key.position} intensity={previewTheme.lights.key.intensity} />\n      <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n      <pointLight position={previewTheme.lights.point.position} intensity={previewTheme.lights.point.intensity} />\n\n      <group ref={groupRef}>\n        <ArcSpringMesh\n          d={d}\n          D={D}\n          n={n}\n          r={r}\n          alpha0Deg={alpha0Deg}\n          deadCoilsStart={useDeadCoils ? deadCoilsPerEnd : 0}\n          deadCoilsEnd={useDeadCoils ? deadCoilsPerEnd : 0}\n          deadTightnessK={useDeadCoils ? deadTightnessK : 0}\n          deadTightnessSigma={useDeadCoils ? deadTightnessSigma : 0}\n          colorMode={colorMode}\n          approxTauMax={approxTauMax}\n          approxStressBeta={approxStressBeta}\n          wireframe={wireframe}\n          showCenterline={showCenterline}\n        />\n      </group>\n\n      <FitToObject groupRef={groupRef} autoRotate={autoRotate} />\n    </>\n  );\n}\n\nexport function ArcSpringVisualizer({\n  d = 3,\n  D = 30,\n  n = 6,\n  r = 80,\n  alpha0Deg = 120,\n  useDeadCoils = false,\n  deadCoilsPerEnd = 1,\n  deadTightnessK = 0,\n  deadTightnessSigma = 0,\n  colorMode = \"solid\",\n  approxTauMax,\n  approxStressBeta = 0.25,\n  autoRotate = false,\n  wireframe = false,\n  showCenterline = false,\n}: ArcSpringVisualizerProps) {\n  return (\n    <Canvas camera={{ fov: 45, near: 0.1, far: 5000 }} style={{ width: \"100%\", height: \"100%\" }}>\n      <ArcSpringScene\n        d={d}\n        D={D}\n        n={n}\n        r={r}\n        alpha0Deg={alpha0Deg}\n        useDeadCoils={useDeadCoils}\n        deadCoilsPerEnd={Math.max(0, Math.round(deadCoilsPerEnd))}\n        deadTightnessK={Math.max(0, deadTightnessK)}\n        deadTightnessSigma={Math.max(0, deadTightnessSigma)}\n        colorMode={colorMode}\n        approxTauMax={approxTauMax}\n        approxStressBeta={approxStressBeta}\n        autoRotate={autoRotate}\n        wireframe={wireframe}\n        showCenterline={showCenterline}\n      />\n    </Canvas>\n  );\n}\n\nexport default ArcSpringMesh;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/BasicScene.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/CoilerArms.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/CoilerMachineScene.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CompressionSpringDesign' is defined but never used.","line":10,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":47},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isCompressionDesign' is defined but never used.","line":10,"column":49,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":68}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { Suspense } from \"react\";\nimport { Canvas } from \"@react-three/fiber\";\nimport { OrbitControls } from \"@react-three/drei\";\n\nimport { SpringModel } from \"@/components/three/SpringModel\";\nimport { CoilerArms } from \"@/components/three/CoilerArms\";\nimport { WireFeed } from \"@/components/three/WireFeed\";\nimport { SpringDesign, CompressionSpringDesign, isCompressionDesign } from \"@/lib/springTypes\";\nimport { getMeanDiameter } from \"@/lib/springMath\";\n\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\ntype CoilerMachineSceneProps = {\n  springDesign: SpringDesign;\n  pitch: number;\n  simulationSpeed: number;\n};\n\n/**\n * Placeholder canvas for the octopus-style coiling machine simulation.\n * Future work: port mandrel + guide roller kinematics, wire feed animation, and\n * machine frame motion from our standalone Vite + Three prototype into these components.\n */\nexport function CoilerMachineScene({ springDesign, pitch }: CoilerMachineSceneProps) {\n  return (\n    <div className=\"h-full w-full\">\n      <Canvas \n        camera={{ position: [2.5, 1.5, 3], fov: 45 }}\n        gl={{ \n          antialias: true,\n          preserveDrawingBuffer: true,\n        }}\n        frameloop=\"always\"\n        dpr={[1, 2]}\n      >\n        <color attach=\"background\" args={[previewTheme.background]} />\n        <ambientLight intensity={previewTheme.lights.ambient} />\n        <directionalLight position={previewTheme.lights.key.position} intensity={previewTheme.lights.key.intensity} />\n        <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n\n        <Suspense fallback={null}>\n          <group position={[0, -0.4, 0]}>\n            <WireFeed />\n            <CoilerArms position={[0, 0, 0]} />\n            <SpringModel\n              wireDiameter={springDesign.wireDiameter}\n              meanDiameter={getMeanDiameter(springDesign)}\n              activeCoils={springDesign.activeCoils}\n              pitch={pitch}\n            />\n          </group>\n        </Suspense>\n\n        <OrbitControls enableDamping enablePan enableZoom />\n\n        {/* TODO: hook up simulationSpeed to animation clocks when motion logic lands. */}\n      </Canvas>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/CompressionSpringVisualizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1653,1656],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1653,1656],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":310,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":310,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10402,10405],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10402,10405],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useMemo, useRef, useCallback, useState, useEffect } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls } from \"@react-three/drei\";\nimport * as THREE from \"three\";\nimport { \n  useSpringSimulationStore, \n  type CompressionDesignMeta \n} from \"@/lib/stores/springSimulationStore\";\nimport {\n  buildCompressionSpringGeometry,\n  type CompressionSpringParams,\n} from \"@/lib/spring3d/compressionSpringGeometry\";\nimport { useFeaStore } from \"@/lib/stores/feaStore\";\nimport { applyFeaColors, findMaxSigmaNodeIndex, findMaxDispNodeIndex } from \"@/lib/fea/feaTypes\";\nimport { Html } from \"@react-three/drei\";\nimport { Button } from \"@/components/ui/button\";\nimport { RotateCcw } from \"lucide-react\";\n\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\n// View presets - camera positions for different views\nconst VIEW_PRESETS = {\n  perspective: { position: [60, 40, 80], target: [0, 0, 25] },\n  front: { position: [0, 0, 100], target: [0, 0, 25] },      // 前视图 - 沿 Z 轴看\n  top: { position: [0, 100, 25], target: [0, 0, 25] },       // 俯视图 - 从上往下看\n  side: { position: [100, 0, 25], target: [0, 0, 25] },      // 侧视图 - 沿 X 轴看\n} as const;\n\ntype ViewType = keyof typeof VIEW_PRESETS;\n\n// Spring colors\nconst SPRING_COLOR = \"#3b82f6\"; // Blue for active coils\nconst SPRING_COLOR_BOTTOMED = \"#64748b\"; // Gray for bottomed coils\nconst END_CAP_COLOR = previewTheme.material.endCap.color; // Silver for ground ends\n\n/**\n * Camera controller component - must be inside Canvas\n */\nfunction CameraController({ \n  viewType, \n  controlsRef \n}: { \n  viewType: ViewType; \n  controlsRef: React.RefObject<any>;\n}) {\n  const { camera } = useThree();\n  \n  // Update camera when view type changes\n  useEffect(() => {\n    const preset = VIEW_PRESETS[viewType];\n    camera.position.set(...(preset.position as [number, number, number]));\n    camera.lookAt(...(preset.target as [number, number, number]));\n    camera.updateProjectionMatrix();\n    \n    // Update OrbitControls target after a small delay to ensure it's mounted\n    setTimeout(() => {\n      if (controlsRef.current) {\n        controlsRef.current.target.set(...(preset.target as [number, number, number]));\n        controlsRef.current.update();\n      }\n    }, 10);\n  }, [viewType, camera, controlsRef]);\n  \n  return null;\n}\n\n/**\n * Animated compression spring model with engineering-accurate geometry\n * \n * Features:\n * - Dead coils at both ends (ground & closed)\n * - Segmented pitch (dead vs active regions)\n * - Clipping planes for ground ends\n * - Dynamic compression animation\n */\nfunction AnimatedCompressionSpring() {\n  const design = useSpringSimulationStore((state) => state.design);\n  const currentDeflection = useSpringSimulationStore((state) => state.currentDeflection);\n  const currentStiffness = useSpringSimulationStore((state) => state.currentStiffness);\n\n  // FEA store state for coloring\n  const feaResult = useFeaStore((s) => s.feaResult);\n  const colorMode = useFeaStore((s) => s.colorMode);\n  const isFeaMode = colorMode !== \"formula\" && feaResult !== null;\n\n  // Type guard for compression design\n  const compressionDesign = design?.type === \"compression\" ? design as CompressionDesignMeta : null;\n\n  // Calculate scale factor for visualization\n  const scale = useMemo(() => {\n    if (!compressionDesign) return 1;\n    const maxDim = Math.max(compressionDesign.meanDiameter * 1.5, compressionDesign.freeLength);\n    return 50 / maxDim; // Normalize to ~50 units\n  }, [compressionDesign]);\n\n  // Build complete spring geometry with clipping planes\n  const springGeometry = useMemo(() => {\n    if (!compressionDesign) return null;\n\n    const {\n      wireDiameter,\n      meanDiameter,\n      activeCoils,\n      freeLength,\n    } = compressionDesign;\n\n    // Total coils = active coils + 2 dead coils (1 at each end for ground ends)\n    const totalCoils = activeCoils + 2;\n\n    const params: CompressionSpringParams = {\n      totalCoils,\n      activeCoils,\n      meanDiameter,\n      wireDiameter,\n      freeLength,\n      currentDeflection,\n      scale,\n    };\n\n    return buildCompressionSpringGeometry(params, currentStiffness);\n  }, [compressionDesign, currentDeflection, currentStiffness, scale]);\n\n  // Create material with clipping planes - must be called unconditionally\n  const springMaterial = useMemo(() => {\n    if (!springGeometry) return null;\n    const { clipPlanes, state } = springGeometry;\n    const mat = new THREE.MeshStandardMaterial({\n      // Use white base color when vertexColors is enabled so FEA colors show clearly\n      color: isFeaMode ? 0xffffff : (state.isAtSolidHeight ? SPRING_COLOR_BOTTOMED : SPRING_COLOR),\n      metalness: isFeaMode ? previewTheme.material.fea.metalness : previewTheme.material.spring.metalness,\n      roughness: isFeaMode ? previewTheme.material.fea.roughness : previewTheme.material.spring.roughness,\n      side: THREE.DoubleSide,\n      clippingPlanes: [clipPlanes.bottom, clipPlanes.top],\n      clipShadows: true,\n      vertexColors: isFeaMode,\n    });\n    return mat;\n  }, [springGeometry, isFeaMode]);\n\n  // Apply FEA colors to geometry when in FEA mode\n  useEffect(() => {\n    if (!springGeometry?.tubeGeometry) return;\n    \n    if (isFeaMode && feaResult) {\n      applyFeaColors(springGeometry.tubeGeometry, {\n        mode: colorMode,\n        feaResult,\n      });\n    }\n  }, [springGeometry, isFeaMode, feaResult, colorMode]);\n\n  // Early return after all hooks\n  if (!springGeometry || !compressionDesign || !springMaterial) {\n    return null;\n  }\n\n  const { tubeGeometry, endDiscs } = springGeometry;\n\n  return (\n    <group>\n      {/* Main spring tube with clipping - key forces re-render when FEA mode changes */}\n      <mesh key={`spring-${isFeaMode}-${colorMode}`} geometry={tubeGeometry} material={springMaterial} />\n      \n      {/* Bottom ground end disc */}\n      <mesh position={[0, 0, endDiscs.bottomPosition]}>\n        <ringGeometry args={[endDiscs.innerRadius, endDiscs.outerRadius, 32]} />\n        <meshStandardMaterial \n          color={END_CAP_COLOR} \n          metalness={previewTheme.material.endCap.metalness}\n          roughness={previewTheme.material.endCap.roughness}\n          side={THREE.DoubleSide}\n        />\n      </mesh>\n      \n      {/* Top ground end disc */}\n      <mesh position={[0, 0, endDiscs.topPosition]}>\n        <ringGeometry args={[endDiscs.innerRadius, endDiscs.outerRadius, 32]} />\n        <meshStandardMaterial \n          color={END_CAP_COLOR} \n          metalness={previewTheme.material.endCap.metalness}\n          roughness={previewTheme.material.endCap.roughness}\n          side={THREE.DoubleSide}\n        />\n      </mesh>\n      \n      {/* Ground plane shadow */}\n      <mesh position={[0, 0, -0.5]} rotation={[0, 0, 0]}>\n        <circleGeometry args={[endDiscs.outerRadius * 1.5, 32]} />\n        <meshStandardMaterial \n          color={previewTheme.material.groundShadow.color}\n          transparent \n          opacity={previewTheme.material.groundShadow.opacity}\n        />\n      </mesh>\n\n      {/* Max stress marker - only in FEA mode */}\n      {isFeaMode && feaResult && feaResult.nodes.length > 0 && (\n        <MaxStressMarker \n          feaResult={feaResult} \n          colorMode={colorMode} \n          scale={scale} \n        />\n      )}\n    </group>\n  );\n}\n\n/**\n * Marker showing the location of maximum stress or displacement\n */\nfunction MaxStressMarker({ \n  feaResult, \n  colorMode, \n  scale \n}: { \n  feaResult: NonNullable<ReturnType<typeof useFeaStore.getState>[\"feaResult\"]>;\n  colorMode: string;\n  scale: number;\n}) {\n  const nodes = feaResult.nodes;\n  \n  const markerData = useMemo(() => {\n    let nodeIndex: number;\n    let value: number;\n    let label: string;\n    let unit: string;\n    let color: string;\n\n    switch (colorMode) {\n      case \"fea_sigma\":\n        nodeIndex = findMaxSigmaNodeIndex(nodes);\n        value = nodes[nodeIndex].sigma_vm;\n        label = \"σ_max\";\n        unit = \"MPa\";\n        color = \"#ff0000\";\n        break;\n      case \"fea_disp\":\n        nodeIndex = findMaxDispNodeIndex(nodes);\n        const node = nodes[nodeIndex];\n        value = Math.sqrt(node.ux ** 2 + node.uy ** 2 + node.uz ** 2);\n        label = \"u_max\";\n        unit = \"mm\";\n        color = \"#ff6600\";\n        break;\n      default:\n        nodeIndex = findMaxSigmaNodeIndex(nodes);\n        value = nodes[nodeIndex].sigma_vm;\n        label = \"σ_max\";\n        unit = \"MPa\";\n        color = \"#ff0000\";\n    }\n\n    const targetNode = nodes[nodeIndex];\n    return {\n      position: [targetNode.x * scale, targetNode.y * scale, targetNode.z * scale] as [number, number, number],\n      value,\n      label,\n      unit,\n      color,\n    };\n  }, [nodes, colorMode, scale]);\n\n  const sphereRadius = 1.5;\n\n  return (\n    <group position={markerData.position}>\n      <mesh>\n        <sphereGeometry args={[sphereRadius, 16, 16]} />\n        <meshStandardMaterial\n          color={markerData.color}\n          emissive={markerData.color}\n          emissiveIntensity={0.5}\n          transparent\n          opacity={0.9}\n        />\n      </mesh>\n      <mesh rotation={[Math.PI / 2, 0, 0]}>\n        <ringGeometry args={[sphereRadius * 1.2, sphereRadius * 1.5, 32]} />\n        <meshBasicMaterial\n          color={markerData.color}\n          transparent\n          opacity={0.5}\n          side={THREE.DoubleSide}\n        />\n      </mesh>\n      <Html position={[0, sphereRadius * 2, 0]} center style={{ pointerEvents: \"none\" }}>\n        <div className=\"px-2 py-1 rounded bg-black/80 text-white text-xs whitespace-nowrap\">\n          <span className=\"font-medium\">{markerData.label}</span>\n          {\" = \"}\n          <span className=\"font-mono\">{markerData.value.toFixed(1)}</span>\n          {markerData.unit && <span className=\"text-gray-300\"> {markerData.unit}</span>}\n        </div>\n      </Html>\n    </group>\n  );\n}\n\n/**\n * Complete compression spring visualizer with Canvas and controls\n * Matches ConicalSpringVisualizer styling for consistency\n */\nexport function CompressionSpringVisualizer() {\n  const { design, currentDeflection, currentLoad, currentStiffness } = useSpringSimulationStore();\n  const compressionDesign = design?.type === \"compression\" ? design as CompressionDesignMeta : null;\n\n  // Note: useLanguage would require this to be a client component with LanguageProvider\n  // For now, we'll use bilingual labels or just show technical symbols\n  const controlsRef = useRef<any>(null);\n  const [currentView, setCurrentView] = useState<ViewType>(\"perspective\");\n\n  const handleViewChange = useCallback((view: ViewType) => {\n    setCurrentView(view);\n  }, []);\n\n  if (!compressionDesign) {\n    return (\n      <div className=\"h-full w-full flex items-center justify-center bg-slate-100 rounded-lg\">\n        <p className=\"text-sm text-muted-foreground\">暂无压簧数据</p>\n      </div>\n    );\n  }\n\n  // Calculate spring state\n  const totalCoils = compressionDesign.activeCoils + 2;\n  const deadCoils = 2;\n  const solidHeight = totalCoils * compressionDesign.wireDiameter;\n  const compressedLength = compressionDesign.freeLength - currentDeflection;\n  const isAtSolidHeight = compressedLength <= solidHeight * 1.01;\n\n  return (\n    <div className=\"relative h-full w-full\">\n      <Canvas\n        camera={{ position: [60, 40, 80], fov: 45 }}\n        gl={{ localClippingEnabled: true }}\n      >\n        <CameraController viewType={currentView} controlsRef={controlsRef} />\n\n        <color attach=\"background\" args={[previewTheme.background]} />\n        \n        <ambientLight intensity={previewTheme.lights.ambient} />\n        <directionalLight position={previewTheme.lights.key.position} intensity={previewTheme.lights.key.intensity} castShadow />\n        <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n        <pointLight position={previewTheme.lights.point.position} intensity={previewTheme.lights.point.intensity} />\n        \n        <AnimatedCompressionSpring />\n        \n        <OrbitControls \n          ref={controlsRef}\n          enablePan={true}\n          enableZoom={true}\n          enableRotate={true}\n          minDistance={20}\n          maxDistance={200}\n          target={[0, 0, 25]}\n        />\n        \n        {/* Ground grid */}\n        <gridHelper \n          args={[80, 16, previewTheme.grid.major, previewTheme.grid.minor]} \n          position={[0, 0, 0]} \n          rotation={[Math.PI / 2, 0, 0]}\n        />\n      </Canvas>\n\n      {/* View selector - bottom left */}\n      <div className=\"absolute bottom-2 left-2 flex gap-1\">\n        <Button\n          variant={currentView === \"perspective\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"perspective\")}\n          title=\"透视图 / Perspective\"\n        >\n          <RotateCcw className=\"h-3 w-3 mr-1\" />\n          3D\n        </Button>\n        <Button\n          variant={currentView === \"front\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"front\")}\n          title=\"前视图 / Front View\"\n        >\n          前\n        </Button>\n        <Button\n          variant={currentView === \"top\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"top\")}\n          title=\"俯视图 / Top View\"\n        >\n          顶\n        </Button>\n        <Button\n          variant={currentView === \"side\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"side\")}\n          title=\"侧视图 / Side View\"\n        >\n          侧\n        </Button>\n      </div>\n\n      {/* Legend overlay - top left */}\n      <div className=\"absolute top-2 left-2 rounded bg-white/90 px-2 py-1.5 text-xs shadow\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"h-3 w-3 rounded-full\" style={{ backgroundColor: SPRING_COLOR }} />\n          <span>有效圈</span>\n        </div>\n        <div className=\"flex items-center gap-2 mt-1\">\n          <div className=\"h-3 w-3 rounded-full\" style={{ backgroundColor: END_CAP_COLOR }} />\n          <span>并紧圈</span>\n        </div>\n        {isAtSolidHeight && (\n          <div className=\"mt-1 text-amber-600 font-medium\">\n            ⚠ 已达固体高度\n          </div>\n        )}\n      </div>\n\n      {/* Status overlay - uses technical symbols (international) */}\n      <div className=\"absolute top-2 right-2 rounded bg-white/90 px-2 py-1.5 text-xs shadow space-y-0.5\">\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">Δx:</span>\n          <span className=\"font-medium\">{currentDeflection.toFixed(2)} mm</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">F:</span>\n          <span className=\"font-medium\">{currentLoad.toFixed(2)} N</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">L:</span>\n          <span className=\"font-medium\">{compressedLength.toFixed(2)} mm</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">k:</span>\n          <span className=\"font-medium\">{currentStiffness.toFixed(2)} N/mm</span>\n        </div>\n        <div className=\"border-t border-slate-200 pt-1 mt-1\">\n          <div className=\"flex justify-between gap-4\">\n            <span className=\"text-slate-500\">Nt:</span>\n            <span className=\"font-medium\">{totalCoils}</span>\n          </div>\n          <div className=\"flex justify-between gap-4\">\n            <span className=\"text-slate-500\">Na:</span>\n            <span className=\"font-medium\">{compressionDesign.activeCoils}</span>\n          </div>\n          <div className=\"flex justify-between gap-4\">\n            <span className=\"text-slate-500\">Nc:</span>\n            <span className=\"font-medium\">{deadCoils}</span>\n          </div>\n          <div className=\"flex justify-between gap-4\">\n            <span className=\"text-slate-500\">Hs:</span>\n            <span className=\"font-medium\">{solidHeight.toFixed(1)} mm</span>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/ConicalSpringVisualizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1809,1812],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1809,1812],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalHeight' is assigned a value but never used.","line":144,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":144,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SPRING_COLOR' is assigned a value but never used.","line":154,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":154,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'END_CAP_COLOR' is assigned a value but never used.","line":155,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":155,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":370,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":370,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12242,12245],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12242,12245],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useMemo, useRef, useCallback, useState, useEffect } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls } from \"@react-three/drei\";\nimport * as THREE from \"three\";\nimport { useSpringSimulationStore, type ConicalDesignMeta } from \"@/lib/stores/springSimulationStore\";\nimport { \n  buildConicalSpringGeometry,\n  type ConicalSpringParams,\n} from \"@/lib/spring3d/conicalSpringGeometry\";\nimport { useFeaStore } from \"@/lib/stores/feaStore\";\nimport { applyFeaColors, findMaxSigmaNodeIndex, findMaxDispNodeIndex } from \"@/lib/fea/feaTypes\";\nimport { Html } from \"@react-three/drei\";\nimport { Button } from \"@/components/ui/button\";\nimport { RotateCcw, Play, Pause } from \"lucide-react\";\n\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\n// View presets - camera positions for different views\n// Target Y will be adjusted based on spring height\nconst getViewPresets = (springCenterY: number) => ({\n  perspective: { position: [60, 45 + springCenterY, 60], target: [0, springCenterY, 0] },\n  front: { position: [0, springCenterY, 100], target: [0, springCenterY, 0] },      // 前视图\n  top: { position: [0, 100 + springCenterY, 0], target: [0, springCenterY, 0] },    // 俯视图\n  side: { position: [100, springCenterY, 0], target: [0, springCenterY, 0] },       // 侧视图\n} as const);\n\ntype ViewType = 'perspective' | 'front' | 'top' | 'side';\n\n// Colors for coil states\nconst COLLAPSED_COLOR = \"#64748b\"; // Slate gray for collapsed coils\nconst ACTIVE_COLOR = \"#2563eb\";    // Blue for active coils\n\n/**\n * Camera controller component - must be inside Canvas\n * 方案 B: 相机目标调整到弹簧中心\n */\nfunction CameraController({ \n  viewType, \n  controlsRef,\n  springCenterY = 25, // Default center height\n}: { \n  viewType: ViewType; \n  controlsRef: React.RefObject<any>;\n  springCenterY?: number;\n}) {\n  const { camera } = useThree();\n  \n  useEffect(() => {\n    const presets = getViewPresets(springCenterY);\n    const preset = presets[viewType];\n    camera.position.set(...(preset.position as [number, number, number]));\n    camera.lookAt(...(preset.target as [number, number, number]));\n    camera.updateProjectionMatrix();\n    \n    setTimeout(() => {\n      if (controlsRef.current) {\n        controlsRef.current.target.set(...(preset.target as [number, number, number]));\n        controlsRef.current.autoRotate = viewType === \"perspective\";\n        controlsRef.current.update();\n      }\n    }, 10);\n  }, [viewType, camera, controlsRef, springCenterY]);\n  \n  return null;\n}\n\n/**\n * Conical spring model using new geometry generator with closed ground ends\n * 使用新几何生成器的锥形弹簧模型，支持并紧磨平端\n */\nfunction ConicalSpringModel() {\n  const { design, collapsedCoils, currentDeflection } = useSpringSimulationStore();\n\n  // FEA store state for coloring\n  const feaResult = useFeaStore((s) => s.feaResult);\n  const colorMode = useFeaStore((s) => s.colorMode);\n  const isFeaMode = colorMode !== \"formula\" && feaResult !== null;\n\n  // Type guard for conical design\n  const conicalDesign = design?.type === \"conical\" ? design as ConicalDesignMeta : null;\n\n  // Calculate scale factor for visualization\n  const scale = useMemo(() => {\n    if (!conicalDesign) return 1;\n    const maxDim = Math.max(conicalDesign.largeOuterDiameter, conicalDesign.freeLength);\n    return 50 / maxDim; // Normalize to ~50 units\n  }, [conicalDesign]);\n\n  // Generate spring geometry using new generator\n  const springGeometry = useMemo(() => {\n    if (!conicalDesign) return null;\n\n    const {\n      wireDiameter,\n      largeOuterDiameter,\n      smallOuterDiameter,\n      activeCoils,\n      freeLength,\n    } = conicalDesign;\n\n    const params: ConicalSpringParams = {\n      wireDiameter,\n      largeOuterDiameter,\n      smallOuterDiameter,\n      freeLength,\n      activeCoils,\n      endType: 'closed_ground', // 并紧磨平端\n      currentDeflection,\n      collapsedCoils,\n      scale,\n    };\n\n    return buildConicalSpringGeometry(params);\n  }, [conicalDesign, collapsedCoils, currentDeflection, scale]);\n\n  // Apply FEA colors to geometry when in FEA mode\n  useEffect(() => {\n    if (!springGeometry?.activeGeometry) return;\n    \n    if (isFeaMode && feaResult) {\n      applyFeaColors(springGeometry.activeGeometry, {\n        mode: colorMode,\n        feaResult,\n      });\n      // Also color collapsed geometry if present\n      if (springGeometry.collapsedGeometry) {\n        applyFeaColors(springGeometry.collapsedGeometry, {\n          mode: colorMode,\n          feaResult,\n        });\n      }\n    }\n  }, [springGeometry, isFeaMode, feaResult, colorMode]);\n\n  if (!design || !springGeometry) {\n    return null;\n  }\n\n  const { \n    activeGeometry, \n    collapsedGeometry, \n    totalHeight,\n    wireRadius,\n    clipPlanes,\n    endDiscs,\n  } = springGeometry;\n\n  // 方案 A: 不使用 yOffset，弹簧从 Y=0 开始向上生长\n  // 裁剪平面和端面位置直接使用几何计算的值\n\n  // Metallic spring material color\n  const SPRING_COLOR = \"#b8860b\"; // Dark golden rod - like real spring steel\n  const END_CAP_COLOR = \"#94a3b8\"; // Silver for ground ends\n\n  // 直接使用几何生成的裁剪平面（不需要调整）\n  const clippingPlanes = clipPlanes ? [clipPlanes.bottom, clipPlanes.top] : [];\n\n  return (\n    <group>\n      {/* Collapsed coils (gray) with clipping - key forces re-render when FEA mode changes */}\n      {collapsedGeometry && (\n        <mesh key={`collapsed-${isFeaMode}-${colorMode}`} geometry={collapsedGeometry}>\n          <meshStandardMaterial \n            color={isFeaMode ? 0xffffff : COLLAPSED_COLOR}\n            metalness={isFeaMode ? previewTheme.material.fea.metalness : previewTheme.material.spring.metalness}\n            roughness={isFeaMode ? previewTheme.material.fea.roughness : previewTheme.material.spring.roughness}\n            clippingPlanes={clippingPlanes}\n            clipShadows={true}\n            vertexColors={isFeaMode}\n          />\n        </mesh>\n      )}\n\n      {/* Active coils (blue) with clipping for ground ends - key forces re-render when FEA mode changes */}\n      {activeGeometry && (\n        <mesh key={`active-${isFeaMode}-${colorMode}`} geometry={activeGeometry}>\n          <meshStandardMaterial \n            color={isFeaMode ? 0xffffff : ACTIVE_COLOR}\n            metalness={isFeaMode ? previewTheme.material.fea.metalness : previewTheme.material.spring.metalness}\n            roughness={isFeaMode ? previewTheme.material.fea.roughness : previewTheme.material.spring.roughness}\n            clippingPlanes={clippingPlanes}\n            clipShadows={true}\n            vertexColors={isFeaMode}\n          />\n        </mesh>\n      )}\n\n      {/* Bottom ground flat surface (ring) - 像压缩弹簧一样 */}\n      {endDiscs && (\n        <mesh position={[0, endDiscs.bottomPosition, 0]} rotation={[-Math.PI / 2, 0, 0]}>\n          <ringGeometry args={[\n            endDiscs.largeRadius - endDiscs.wireRadius * 2, \n            endDiscs.largeRadius, \n            32\n          ]} />\n          <meshStandardMaterial \n            color={previewTheme.material.endCap.color} \n            metalness={previewTheme.material.endCap.metalness}\n            roughness={previewTheme.material.endCap.roughness}\n            side={THREE.DoubleSide}\n          />\n        </mesh>\n      )}\n\n      {/* Top ground flat surface (ring) */}\n      {endDiscs && (\n        <mesh position={[0, endDiscs.topPosition, 0]} rotation={[-Math.PI / 2, 0, 0]}>\n          <ringGeometry args={[\n            endDiscs.smallRadius - endDiscs.wireRadius * 2, \n            endDiscs.smallRadius, \n            32\n          ]} />\n          <meshStandardMaterial \n            color={previewTheme.material.endCap.color} \n            metalness={previewTheme.material.endCap.metalness}\n            roughness={previewTheme.material.endCap.roughness}\n            side={THREE.DoubleSide}\n          />\n        </mesh>\n      )}\n\n      {/* Ground plane shadow */}\n      <mesh position={[0, -0.5, 0]} rotation={[-Math.PI / 2, 0, 0]}>\n        <circleGeometry args={[endDiscs ? endDiscs.largeRadius * 1.5 : wireRadius * 15, 32]} />\n        <meshStandardMaterial \n          color={previewTheme.material.groundShadow.color}\n          transparent \n          opacity={previewTheme.material.groundShadow.opacity}\n        />\n      </mesh>\n\n      {/* Max stress marker - only in FEA mode */}\n      {isFeaMode && feaResult && feaResult.nodes.length > 0 && (\n        <ConicalMaxStressMarker \n          feaResult={feaResult} \n          colorMode={colorMode} \n          scale={scale} \n        />\n      )}\n    </group>\n  );\n}\n\n/**\n * Marker showing the location of maximum stress or displacement\n */\nfunction ConicalMaxStressMarker({ \n  feaResult, \n  colorMode, \n  scale \n}: { \n  feaResult: NonNullable<ReturnType<typeof useFeaStore.getState>[\"feaResult\"]>;\n  colorMode: string;\n  scale: number;\n}) {\n  const nodes = feaResult.nodes;\n  \n  const markerData = useMemo(() => {\n    let nodeIndex: number;\n    let value: number;\n    let label: string;\n    let unit: string;\n    let color: string;\n\n    switch (colorMode) {\n      case \"fea_sigma\":\n        nodeIndex = findMaxSigmaNodeIndex(nodes);\n        value = nodes[nodeIndex].sigma_vm;\n        label = \"σ_max\";\n        unit = \"MPa\";\n        color = \"#ff0000\";\n        break;\n      case \"fea_disp\":\n        nodeIndex = findMaxDispNodeIndex(nodes);\n        const node = nodes[nodeIndex];\n        value = Math.sqrt(node.ux ** 2 + node.uy ** 2 + node.uz ** 2);\n        label = \"u_max\";\n        unit = \"mm\";\n        color = \"#ff6600\";\n        break;\n      default:\n        nodeIndex = findMaxSigmaNodeIndex(nodes);\n        value = nodes[nodeIndex].sigma_vm;\n        label = \"σ_max\";\n        unit = \"MPa\";\n        color = \"#ff0000\";\n    }\n\n    const targetNode = nodes[nodeIndex];\n    // Conical spring uses Y as vertical axis\n    return {\n      position: [targetNode.x * scale, targetNode.z * scale, targetNode.y * scale] as [number, number, number],\n      value,\n      label,\n      unit,\n      color,\n    };\n  }, [nodes, colorMode, scale]);\n\n  const sphereRadius = 1.5;\n\n  return (\n    <group position={markerData.position}>\n      <mesh>\n        <sphereGeometry args={[sphereRadius, 16, 16]} />\n        <meshStandardMaterial\n          color={markerData.color}\n          emissive={markerData.color}\n          emissiveIntensity={0.5}\n          transparent\n          opacity={0.9}\n        />\n      </mesh>\n      <Html position={[0, sphereRadius * 2, 0]} center style={{ pointerEvents: \"none\" }}>\n        <div className=\"px-2 py-1 rounded bg-black/80 text-white text-xs whitespace-nowrap\">\n          <span className=\"font-medium\">{markerData.label}</span>\n          {\" = \"}\n          <span className=\"font-mono\">{markerData.value.toFixed(1)}</span>\n          {markerData.unit && <span className=\"text-gray-300\"> {markerData.unit}</span>}\n        </div>\n      </Html>\n    </group>\n  );\n}\n\n/**\n * Legend component showing color meanings and description\n */\nfunction Legend() {\n  return (\n    <div className=\"absolute top-2 left-2 bg-white/90 rounded-md px-2 py-1.5 text-xs text-slate-900 shadow\">\n      <div className=\"flex items-center gap-2\">\n        <div className=\"w-3 h-3 rounded-full flex-shrink-0\" style={{ backgroundColor: ACTIVE_COLOR }} />\n        <span>工作圈</span>\n      </div>\n      <div className=\"flex items-center gap-2 mt-1\">\n        <div className=\"w-3 h-3 rounded-full flex-shrink-0\" style={{ backgroundColor: COLLAPSED_COLOR }} />\n        <span>贴底圈</span>\n      </div>\n    </div>\n  );\n}\n\n/**\n * Status display showing current state\n */\nfunction StatusDisplay() {\n  const { currentDeflection, collapsedCoils, activeCoils, currentLoad, currentStiffness } = useSpringSimulationStore();\n  \n  return (\n    <div className=\"absolute top-2 right-2 bg-white/90 rounded-md px-3 py-2 text-xs text-slate-900 shadow\">\n      <div>Δx = {currentDeflection.toFixed(2)} mm</div>\n      <div>F = {currentLoad.toFixed(2)} N</div>\n      <div>k = {currentStiffness.toFixed(2)} N/mm</div>\n      <div className=\"mt-1 pt-1 border-t border-slate-200\">\n        <span className=\"text-blue-600\">{activeCoils}</span> active, \n        <span className=\"text-slate-500 ml-1\">{collapsedCoils}</span> collapsed\n      </div>\n    </div>\n  );\n}\n\n/**\n * Main visualizer component with Canvas\n */\nexport function ConicalSpringVisualizer() {\n  const { mode, design, maxDeflection, setDeflection } = useSpringSimulationStore();\n  const controlsRef = useRef<any>(null);\n  const [currentView, setCurrentView] = useState<ViewType>(\"perspective\");\n  \n  // 动画控制状态\n  const [isAnimating, setIsAnimating] = useState(false);\n  const animationRef = useRef<number | null>(null);\n  const lastTimeRef = useRef<number>(0);\n  const directionRef = useRef<1 | -1>(1); // 1 = 压缩, -1 = 释放\n\n  // 方案 B: 计算弹簧中心高度用于相机目标\n  const conicalDesign = design?.type === \"conical\" ? design as ConicalDesignMeta : null;\n  const springCenterY = useMemo(() => {\n    if (!conicalDesign) return 25;\n    const maxDim = Math.max(conicalDesign.largeOuterDiameter, conicalDesign.freeLength);\n    const scale = 50 / maxDim;\n    // 弹簧高度的一半作为中心\n    return (conicalDesign.freeLength * scale) / 2;\n  }, [conicalDesign]);\n\n  const handleViewChange = useCallback((view: ViewType) => {\n    setCurrentView(view);\n  }, []);\n\n  // 动画循环\n  useEffect(() => {\n    if (!isAnimating || maxDeflection <= 0) {\n      if (animationRef.current) {\n        cancelAnimationFrame(animationRef.current);\n        animationRef.current = null;\n      }\n      return;\n    }\n\n    const animate = (currentTime: number) => {\n      if (!lastTimeRef.current) {\n        lastTimeRef.current = currentTime;\n      }\n      \n      const deltaTime = currentTime - lastTimeRef.current;\n      lastTimeRef.current = currentTime;\n      \n      // 限制 deltaTime 防止跳帧\n      const clampedDelta = Math.min(deltaTime, 100);\n      \n      // 动画速度：每秒移动 maxDeflection 的 25%（稍慢一点更平滑）\n      const speed = maxDeflection * 0.25;\n      const delta = (clampedDelta / 1000) * speed * directionRef.current;\n      \n      const { currentDeflection } = useSpringSimulationStore.getState();\n      let newDeflection = currentDeflection + delta;\n      \n      // 到达边界时反向\n      if (newDeflection >= maxDeflection * 0.95) {\n        newDeflection = maxDeflection * 0.95; // 不要完全到底\n        directionRef.current = -1;\n      } else if (newDeflection <= maxDeflection * 0.05) {\n        newDeflection = maxDeflection * 0.05; // 不要完全释放\n        directionRef.current = 1;\n      }\n      \n      setDeflection(newDeflection);\n      \n      animationRef.current = requestAnimationFrame(animate);\n    };\n    \n    lastTimeRef.current = 0;\n    animationRef.current = requestAnimationFrame(animate);\n    \n    return () => {\n      if (animationRef.current) {\n        cancelAnimationFrame(animationRef.current);\n      }\n    };\n  }, [isAnimating, maxDeflection, setDeflection]);\n\n  // 切换动画播放/暂停\n  const toggleAnimation = useCallback(() => {\n    setIsAnimating(prev => !prev);\n  }, []);\n\n  if (mode !== \"conical-nonlinear\" || !design) {\n    return (\n      <div className=\"h-full w-full flex items-center justify-center bg-slate-100 rounded-lg\">\n        <p className=\"text-sm text-muted-foreground text-center px-4\">\n          Generate nonlinear curve first to enable 3D visualization.\n          <br />\n          <span className=\"text-slate-400\">请先计算非线性曲线以启用 3D 可视化。</span>\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"relative h-full w-full rounded-lg overflow-hidden\">\n      <Canvas\n        camera={{ position: [60, 45 + springCenterY, 60], fov: 50 }}\n        gl={{ \n          antialias: true,\n          preserveDrawingBuffer: true,\n          localClippingEnabled: true, // Enable clipping for ground ends\n        }}\n        frameloop=\"always\"\n        dpr={[1, 2]}\n      >\n        <CameraController \n          viewType={currentView} \n          controlsRef={controlsRef} \n          springCenterY={springCenterY}\n        />\n        \n        <color attach=\"background\" args={[previewTheme.background]} />\n        <ambientLight intensity={previewTheme.lights.ambient} />\n        <directionalLight position={previewTheme.lights.key.position} intensity={previewTheme.lights.key.intensity} castShadow />\n        <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n        <pointLight position={previewTheme.lights.point.position} intensity={previewTheme.lights.point.intensity} />\n        \n        <ConicalSpringModel />\n        \n        <OrbitControls \n          ref={controlsRef}\n          enablePan={false}\n          minDistance={20}\n          maxDistance={150}\n          target={[0, springCenterY, 0]}\n          autoRotate={currentView === \"perspective\"}\n          autoRotateSpeed={0.5}\n        />\n        \n        <gridHelper args={[80, 16, previewTheme.grid.major, previewTheme.grid.minor]} position={[0, -2, 0]} />\n      </Canvas>\n      \n      {/* Animation control - top center */}\n      <div className=\"absolute top-2 left-1/2 -translate-x-1/2\">\n        <Button\n          variant={isAnimating ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-8 px-3 text-xs gap-1\"\n          onClick={toggleAnimation}\n          title={isAnimating ? \"暂停动画 / Pause\" : \"播放动画 / Play\"}\n        >\n          {isAnimating ? (\n            <>\n              <Pause className=\"h-3 w-3\" />\n              暂停\n            </>\n          ) : (\n            <>\n              <Play className=\"h-3 w-3\" />\n              播放\n            </>\n          )}\n        </Button>\n      </div>\n\n      {/* View selector - bottom left */}\n      <div className=\"absolute bottom-2 left-2 flex gap-1\">\n        <Button\n          variant={currentView === \"perspective\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"perspective\")}\n          title=\"透视图 / Perspective\"\n        >\n          <RotateCcw className=\"h-3 w-3 mr-1\" />\n          3D\n        </Button>\n        <Button\n          variant={currentView === \"front\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"front\")}\n          title=\"前视图 / Front View\"\n        >\n          前\n        </Button>\n        <Button\n          variant={currentView === \"top\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"top\")}\n          title=\"俯视图 / Top View\"\n        >\n          顶\n        </Button>\n        <Button\n          variant={currentView === \"side\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"side\")}\n          title=\"侧视图 / Side View\"\n        >\n          侧\n        </Button>\n      </div>\n      \n      <Legend />\n      <StatusDisplay />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/DieSpringMesh.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/DieSpringVisualizer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/ExtensionSpringVisualizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Eye' is defined but never used.","line":19,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":19,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'state' is assigned a value but never used.","line":129,"column":62,"nodeType":null,"messageId":"unusedVar","endLine":129,"endColumn":67},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":257,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":257,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8040,8043],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8040,8043],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'initialTension' is assigned a value but never used.","line":284,"column":69,"nodeType":null,"messageId":"unusedVar","endLine":284,"endColumn":83},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":286,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9074,9077],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9074,9077],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useMemo, useRef, useCallback, useState, useEffect } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls } from \"@react-three/drei\";\nimport * as THREE from \"three\";\nimport { \n  useSpringSimulationStore, \n  type ExtensionDesignMeta \n} from \"@/lib/stores/springSimulationStore\";\nimport {\n  buildExtensionSpringGeometry,\n  type ExtensionSpringParams,\n} from \"@/lib/spring3d/extensionSpringGeometry\";\nimport { useFeaStore } from \"@/lib/stores/feaStore\";\nimport { applyFeaColors, findMaxSigmaNodeIndex, findMaxDispNodeIndex } from \"@/lib/fea/feaTypes\";\nimport { Html } from \"@react-three/drei\";\nimport { Button } from \"@/components/ui/button\";\nimport { Eye, RotateCcw } from \"lucide-react\";\n\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\n// View presets - camera positions for different views\nconst VIEW_PRESETS = {\n  perspective: { position: [60, 40, 80], target: [0, 0, 25] },\n  front: { position: [0, 0, 100], target: [0, 0, 25] },      // 前视图 - 沿 Z 轴看\n  top: { position: [0, 100, 25], target: [0, 0, 25] },       // 俯视图 - 从上往下看\n  side: { position: [100, 0, 25], target: [0, 0, 25] },      // 侧视图 - 沿 X 轴看\n} as const;\n\ntype ViewType = keyof typeof VIEW_PRESETS;\n\n// Spring colors\nconst SPRING_COLOR = \"#22c55e\"; // Green for extension springs\nconst HOOK_COLOR = previewTheme.material.endCap.color; // Silver for hooks\n\n/**\n * Animated extension spring model with engineering-accurate geometry\n * \n * Features:\n * - Close-wound helical body\n * - Hook geometry at both ends\n * - Dynamic extension animation\n */\nfunction AnimatedExtensionSpring() {\n  const design = useSpringSimulationStore((state) => state.design);\n  const currentDeflection = useSpringSimulationStore((state) => state.currentDeflection);\n\n  // FEA store state for coloring\n  const feaResult = useFeaStore((s) => s.feaResult);\n  const colorMode = useFeaStore((s) => s.colorMode);\n  const isFeaMode = colorMode !== \"formula\" && feaResult !== null;\n\n  // Type guard for extension design\n  const extensionDesign = design?.type === \"extension\" ? design as ExtensionDesignMeta : null;\n\n  // Calculate scale factor for visualization\n  const scale = useMemo(() => {\n    if (!extensionDesign) return 1;\n    const maxDim = Math.max(extensionDesign.outerDiameter * 1.5, extensionDesign.bodyLength);\n    return 50 / maxDim; // Normalize to ~50 units\n  }, [extensionDesign]);\n\n  // Build complete spring geometry\n  const springGeometry = useMemo(() => {\n    if (!extensionDesign) return null;\n\n    const {\n      wireDiameter,\n      outerDiameter,\n      activeCoils,\n      bodyLength,\n      freeLengthInsideHooks,\n      hookType,\n    } = extensionDesign;\n\n    const params: ExtensionSpringParams = {\n      wireDiameter,\n      outerDiameter,\n      activeCoils,\n      bodyLength,\n      freeLengthInsideHooks,\n      currentExtension: currentDeflection,\n      scale,\n      hookType,\n    };\n\n    return buildExtensionSpringGeometry(params);\n  }, [extensionDesign, currentDeflection, scale]);\n\n  // Create materials - MUST be before any conditional returns to maintain hooks order\n  const springMaterial = useMemo(() => {\n    return new THREE.MeshStandardMaterial({\n      // Use white base color when vertexColors is enabled so FEA colors show clearly\n      color: isFeaMode ? 0xffffff : SPRING_COLOR,\n      metalness: isFeaMode ? previewTheme.material.fea.metalness : previewTheme.material.spring.metalness,\n      roughness: isFeaMode ? previewTheme.material.fea.roughness : previewTheme.material.spring.roughness,\n      side: THREE.DoubleSide,\n      vertexColors: isFeaMode,\n    });\n  }, [isFeaMode]);\n\n  // Apply FEA colors to geometry when in FEA mode\n  useEffect(() => {\n    if (!springGeometry?.bodyGeometry) return;\n    \n    if (isFeaMode && feaResult) {\n      applyFeaColors(springGeometry.bodyGeometry, {\n        mode: colorMode,\n        feaResult,\n      });\n    }\n  }, [springGeometry, isFeaMode, feaResult, colorMode]);\n\n  const hookMaterial = useMemo(() => {\n    return new THREE.MeshStandardMaterial({\n      color: HOOK_COLOR,\n      metalness: previewTheme.material.endCap.metalness,\n      roughness: previewTheme.material.endCap.roughness,\n      side: THREE.DoubleSide,\n    });\n  }, []);\n\n  // Early return AFTER all hooks to maintain consistent hook order\n  if (!springGeometry || !extensionDesign) {\n    return null;\n  }\n\n  const { bodyGeometry, topHookGeometry, bottomHookGeometry, state } = springGeometry;\n\n  return (\n    <group>\n      {/* Main spring body - key forces re-render when FEA mode changes */}\n      <mesh key={`spring-${isFeaMode}-${colorMode}`} geometry={bodyGeometry} material={springMaterial} />\n      \n      {/* Bottom hook */}\n      {bottomHookGeometry && (\n        <mesh geometry={bottomHookGeometry} material={hookMaterial} />\n      )}\n      \n      {/* Top hook */}\n      {topHookGeometry && (\n        <mesh geometry={topHookGeometry} material={hookMaterial} />\n      )}\n      \n      {/* Ground plane shadow */}\n      <mesh position={[0, 0, -2]} rotation={[0, 0, 0]}>\n        <circleGeometry args={[extensionDesign.outerDiameter * scale * 0.8, 32]} />\n        <meshStandardMaterial \n          color={previewTheme.material.groundShadow.color}\n          transparent \n          opacity={previewTheme.material.groundShadow.opacity}\n        />\n      </mesh>\n\n      {/* Max stress marker - only in FEA mode */}\n      {isFeaMode && feaResult && feaResult.nodes.length > 0 && (\n        <ExtensionMaxStressMarker \n          feaResult={feaResult} \n          colorMode={colorMode} \n          scale={scale} \n        />\n      )}\n    </group>\n  );\n}\n\n/**\n * Marker showing the location of maximum stress or displacement\n */\nfunction ExtensionMaxStressMarker({ \n  feaResult, \n  colorMode, \n  scale \n}: { \n  feaResult: NonNullable<ReturnType<typeof useFeaStore.getState>[\"feaResult\"]>;\n  colorMode: string;\n  scale: number;\n}) {\n  const nodes = feaResult.nodes;\n  \n  const markerData = useMemo(() => {\n    let nodeIndex: number;\n    let value: number;\n    let label: string;\n    let unit: string;\n    let color: string;\n\n    switch (colorMode) {\n      case \"fea_sigma\":\n        nodeIndex = findMaxSigmaNodeIndex(nodes);\n        value = nodes[nodeIndex].sigma_vm;\n        label = \"σ_max\";\n        unit = \"MPa\";\n        color = \"#ff0000\";\n        break;\n      case \"fea_disp\":\n        nodeIndex = findMaxDispNodeIndex(nodes);\n        const node = nodes[nodeIndex];\n        value = Math.sqrt(node.ux ** 2 + node.uy ** 2 + node.uz ** 2);\n        label = \"u_max\";\n        unit = \"mm\";\n        color = \"#ff6600\";\n        break;\n      default:\n        nodeIndex = findMaxSigmaNodeIndex(nodes);\n        value = nodes[nodeIndex].sigma_vm;\n        label = \"σ_max\";\n        unit = \"MPa\";\n        color = \"#ff0000\";\n    }\n\n    const targetNode = nodes[nodeIndex];\n    return {\n      position: [targetNode.x * scale, targetNode.y * scale, targetNode.z * scale] as [number, number, number],\n      value,\n      label,\n      unit,\n      color,\n    };\n  }, [nodes, colorMode, scale]);\n\n  const sphereRadius = 1.5;\n\n  return (\n    <group position={markerData.position}>\n      <mesh>\n        <sphereGeometry args={[sphereRadius, 16, 16]} />\n        <meshStandardMaterial\n          color={markerData.color}\n          emissive={markerData.color}\n          emissiveIntensity={0.5}\n          transparent\n          opacity={0.9}\n        />\n      </mesh>\n      <Html position={[0, sphereRadius * 2, 0]} center style={{ pointerEvents: \"none\" }}>\n        <div className=\"px-2 py-1 rounded bg-black/80 text-white text-xs whitespace-nowrap\">\n          <span className=\"font-medium\">{markerData.label}</span>\n          {\" = \"}\n          <span className=\"font-mono\">{markerData.value.toFixed(1)}</span>\n          {markerData.unit && <span className=\"text-gray-300\"> {markerData.unit}</span>}\n        </div>\n      </Html>\n    </group>\n  );\n}\n\n/**\n * Camera controller component - must be inside Canvas\n */\nfunction CameraController({ \n  viewType, \n  controlsRef \n}: { \n  viewType: ViewType; \n  controlsRef: React.RefObject<any>;\n}) {\n  const { camera } = useThree();\n  \n  // Update camera when view type changes\n  useEffect(() => {\n    const preset = VIEW_PRESETS[viewType];\n    camera.position.set(...(preset.position as [number, number, number]));\n    camera.lookAt(...(preset.target as [number, number, number]));\n    camera.updateProjectionMatrix();\n    \n    // Update OrbitControls target after a small delay to ensure it's mounted\n    setTimeout(() => {\n      if (controlsRef.current) {\n        controlsRef.current.target.set(...(preset.target as [number, number, number]));\n        controlsRef.current.update();\n      }\n    }, 10);\n  }, [viewType, camera, controlsRef]);\n  \n  return null;\n}\n\n/**\n * Complete extension spring visualizer with Canvas and controls\n */\nexport function ExtensionSpringVisualizer() {\n  const { design, currentDeflection, currentLoad, currentStiffness, initialTension } = useSpringSimulationStore();\n  const extensionDesign = design?.type === \"extension\" ? design as ExtensionDesignMeta : null;\n  const controlsRef = useRef<any>(null);\n  const [currentView, setCurrentView] = useState<ViewType>(\"perspective\");\n\n  const handleViewChange = useCallback((view: ViewType) => {\n    setCurrentView(view);\n  }, []);\n\n  if (!extensionDesign) {\n    return (\n      <div className=\"h-full w-full flex items-center justify-center bg-slate-100 rounded-lg\">\n        <p className=\"text-sm text-muted-foreground\">暂无拉伸弹簧数据</p>\n      </div>\n    );\n  }\n\n  // Calculate spring state\n  const extendedLength = extensionDesign.bodyLength + currentDeflection;\n\n  return (\n    <div className=\"relative h-full w-full\">\n      {/* 3D Canvas */}\n      <Canvas\n        camera={{ position: [60, 40, 80], fov: 45 }}\n      >\n        <CameraController viewType={currentView} controlsRef={controlsRef} />\n\n        <color attach=\"background\" args={[previewTheme.background]} />\n        \n        <ambientLight intensity={previewTheme.lights.ambient} />\n        <directionalLight position={previewTheme.lights.key.position} intensity={previewTheme.lights.key.intensity} castShadow />\n        <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n        <pointLight position={previewTheme.lights.point.position} intensity={previewTheme.lights.point.intensity} />\n        \n        <AnimatedExtensionSpring />\n        \n        <OrbitControls \n          ref={controlsRef}\n          enablePan={true}\n          enableZoom={true}\n          enableRotate={true}\n          minDistance={20}\n          maxDistance={200}\n          target={[0, 0, 25]}\n        />\n        \n        {/* Ground grid */}\n        <gridHelper \n          args={[80, 16, previewTheme.grid.major, previewTheme.grid.minor]} \n          position={[0, 0, 0]} \n          rotation={[Math.PI / 2, 0, 0]}\n        />\n      </Canvas>\n\n      {/* View selector - bottom left */}\n      <div className=\"absolute bottom-2 left-2 flex gap-1\">\n        <Button\n          variant={currentView === \"perspective\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"perspective\")}\n          title=\"透视图 / Perspective\"\n        >\n          <RotateCcw className=\"h-3 w-3 mr-1\" />\n          3D\n        </Button>\n        <Button\n          variant={currentView === \"front\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"front\")}\n          title=\"前视图 / Front View\"\n        >\n          前\n        </Button>\n        <Button\n          variant={currentView === \"top\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"top\")}\n          title=\"俯视图 / Top View\"\n        >\n          顶\n        </Button>\n        <Button\n          variant={currentView === \"side\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"side\")}\n          title=\"侧视图 / Side View\"\n        >\n          侧\n        </Button>\n      </div>\n\n      {/* Legend overlay */}\n      <div className=\"absolute top-2 left-2 rounded bg-white/90 px-2 py-1.5 text-xs shadow\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"h-3 w-3 rounded-full\" style={{ backgroundColor: SPRING_COLOR }} />\n          <span>弹簧体</span>\n        </div>\n        <div className=\"flex items-center gap-2 mt-1\">\n          <div className=\"h-3 w-3 rounded-full\" style={{ backgroundColor: HOOK_COLOR }} />\n          <span>挂钩</span>\n        </div>\n      </div>\n\n      {/* Status overlay */}\n      <div className=\"absolute top-2 right-2 rounded bg-white/90 px-2 py-1.5 text-xs shadow space-y-0.5\">\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">Δx:</span>\n          <span className=\"font-medium text-blue-600\">{currentDeflection.toFixed(1)} mm</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">F:</span>\n          <span className=\"font-medium text-green-600\">{currentLoad.toFixed(2)} N</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">L:</span>\n          <span className=\"font-medium\">{extendedLength.toFixed(1)} mm</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">k:</span>\n          <span className=\"font-medium\">{currentStiffness.toFixed(2)} N/mm</span>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/FeaMaxStressMarker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/SpiralTorsionSpringMesh.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":156,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4415,4418],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4415,4418],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: This value cannot be modified\n\nModifying a value returned from a hook is not allowed. Consider moving the modification into the hook where the value is constructed.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/SpiralTorsionSpringMesh.tsx:177:5\n  175 |       center.z + dist * 0.8\n  176 |     );\n> 177 |     camera.near = maxDim / 100;\n      |     ^^^^^^ `camera` cannot be modified\n  178 |     camera.far = maxDim * 100;\n  179 |     camera.updateProjectionMatrix();\n  180 |","line":177,"column":5,"nodeType":null,"endLine":177,"endColumn":11}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spiral Torsion Spring 3D Mesh Component\n * 螺旋扭转弹簧（带材卷绕式）Three.js 网格组件\n * \n * 使用阿基米德螺线中心线 + 矩形截面 Sweep 生成实体\n * 用于 React Three Fiber 渲染\n */\n\n\"use client\";\n\nimport { useMemo, useRef, useEffect } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls, Edges } from \"@react-three/drei\";\nimport * as THREE from \"three\";\nimport { useFeaStore } from \"@/lib/stores/feaStore\";\nimport { applyFeaColors } from \"@/lib/fea/feaTypes\";\nimport { previewTheme } from \"@/lib/three/previewTheme\";\nimport {\n  createSpiralTorsionSpringGeometry,\n  validateSpiralTorsionGeometry,\n  type SpiralTorsionGeometryParams,\n} from \"@/lib/spring3d/spiralTorsionGeometry\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface SpiralTorsionSpringMeshProps {\n  /** 内径 Di (mm) */\n  innerDiameter: number;\n  /** 外径 Do (mm) */\n  outerDiameter: number;\n  /** 圈数 N (revolutions) */\n  turns: number;\n  /** 带材宽度 b (mm) */\n  stripWidth: number;\n  /** 带材厚度 t (mm) */\n  stripThickness: number;\n  /** 绕向：cw = 顺时针，ccw = 逆时针 */\n  handedness?: \"cw\" | \"ccw\";\n  /** 拉伸步数（默认 800） */\n  steps?: number;\n  /** 材质颜色（默认 #4a90d9） */\n  color?: string;\n  /** 金属度（默认 0.6） */\n  metalness?: number;\n  /** 粗糙度（默认 0.3） */\n  roughness?: number;\n  /** 是否显示线框（默认 false） */\n  wireframe?: boolean;\n  /** 位置偏移 */\n  position?: [number, number, number];\n  /** 旋转 */\n  rotation?: [number, number, number];\n  /** 缩放 */\n  scale?: number;\n}\n\n// ============================================================================\n// Component\n// ============================================================================\n\nexport function SpiralTorsionSpringMesh({\n  innerDiameter,\n  outerDiameter,\n  turns,\n  stripWidth,\n  stripThickness,\n  handedness = \"cw\",\n  steps = 800,\n  color = \"#6b9bd1\",\n  metalness = previewTheme.material.spring.metalness,\n  roughness = previewTheme.material.spring.roughness,\n  wireframe = false,\n  position = [0, 0, 0],\n  rotation = [0, 0, 0],\n  scale = 1,\n}: SpiralTorsionSpringMeshProps) {\n  const feaResult = useFeaStore((s) => s.feaResult);\n  const colorMode = useFeaStore((s) => s.colorMode);\n  const isFeaMode = colorMode !== \"formula\" && feaResult !== null;\n\n  // 构建几何参数\n  const params: SpiralTorsionGeometryParams = useMemo(() => ({\n    innerDiameter,\n    outerDiameter,\n    turns,\n    stripWidth,\n    stripThickness,\n    handedness,\n    zOffset: 0,\n  }), [innerDiameter, outerDiameter, turns, stripWidth, stripThickness, handedness]);\n\n  // 验证几何参数\n  const validation = useMemo(() => validateSpiralTorsionGeometry(params), [params]);\n\n  // 创建几何体并应用 FEA 颜色\n  const geometry = useMemo(() => {\n    if (!validation.valid) {\n      return new THREE.BoxGeometry(10, 10, 10);\n    }\n    const geom = createSpiralTorsionSpringGeometry(params, steps);\n    \n    // 在创建几何体时就应用 FEA 颜色\n    if (isFeaMode && feaResult) {\n      applyFeaColors(geom, {\n        mode: colorMode,\n        feaResult,\n      });\n    }\n    \n    return geom;\n  }, [params, steps, validation.valid, isFeaMode, feaResult, colorMode]);\n\n  const meshRef = useRef<THREE.Mesh>(null);\n\n  // 使用 key 强制在 FEA 模式切换时重新创建 mesh 和材质\n  const meshKey = `mesh-${isFeaMode ? 'fea' : 'normal'}-${colorMode}-${feaResult ? 'hasResult' : 'noResult'}`;\n\n  return (\n    <mesh\n      key={meshKey}\n      ref={meshRef}\n      geometry={geometry}\n      position={position}\n      rotation={rotation}\n      scale={scale}\n      castShadow\n      receiveShadow\n    >\n      <meshStandardMaterial\n        color={validation.valid ? (isFeaMode ? \"#ffffff\" : color) : \"#ff4444\"}\n        metalness={isFeaMode ? previewTheme.material.fea.metalness : metalness}\n        roughness={isFeaMode ? previewTheme.material.fea.roughness : roughness}\n        wireframe={wireframe}\n        side={THREE.DoubleSide}\n        vertexColors={isFeaMode}\n      />\n      {/* 添加轮廓线，提高可读性 */}\n      <Edges threshold={15} color=\"#1a365d\" />\n    </mesh>\n  );\n}\n\n// ============================================================================\n// FitToObject - 自动对焦相机到模型\n// ============================================================================\n\ninterface FitToObjectProps {\n  groupRef: React.RefObject<THREE.Group | null>;\n  autoRotate?: boolean;\n}\n\nfunction FitToObject({ groupRef, autoRotate = false }: FitToObjectProps) {\n  const { camera } = useThree();\n  const controlsRef = useRef<any>(null);\n\n  useEffect(() => {\n    const obj = groupRef.current;\n    if (!obj) return;\n\n    // 计算包围盒\n    const box = new THREE.Box3().setFromObject(obj);\n    const size = box.getSize(new THREE.Vector3());\n    const center = box.getCenter(new THREE.Vector3());\n\n    // 计算相机距离\n    const maxDim = Math.max(size.x, size.y, size.z);\n    const dist = maxDim * 2.0;\n\n    // 设置相机位置（斜上方视角）\n    camera.position.set(\n      center.x + dist * 0.8,\n      center.y - dist * 0.6,\n      center.z + dist * 0.8\n    );\n    camera.near = maxDim / 100;\n    camera.far = maxDim * 100;\n    camera.updateProjectionMatrix();\n\n    // 更新控制器目标点\n    if (controlsRef.current) {\n      controlsRef.current.target.copy(center);\n      controlsRef.current.update();\n    }\n  }, [camera, groupRef]);\n\n  return (\n    <OrbitControls\n      ref={controlsRef}\n      makeDefault\n      enablePan={true}\n      enableZoom={true}\n      enableRotate={true}\n      autoRotate={autoRotate}\n      autoRotateSpeed={1}\n    />\n  );\n}\n\n// ============================================================================\n// Visualizer Component (with controls)\n// ============================================================================\n\nexport interface SpiralTorsionSpringVisualizerProps {\n  /** 内径 Di (mm) */\n  innerDiameter?: number;\n  /** 外径 Do (mm) */\n  outerDiameter?: number;\n  /** 圈数 N (revolutions) */\n  turns?: number;\n  /** 带材宽度 b (mm) */\n  stripWidth?: number;\n  /** 带材厚度 t (mm) */\n  stripThickness?: number;\n  /** 绕向 */\n  handedness?: \"cw\" | \"ccw\";\n  /** 是否自动旋转 */\n  autoRotate?: boolean;\n  /** 缩放因子（用于适配视口） */\n  scaleFactor?: number;\n}\n\nfunction SpiralTorsionScene({\n  innerDiameter,\n  outerDiameter,\n  turns,\n  stripWidth,\n  stripThickness,\n  handedness,\n  autoRotate,\n  scaleFactor,\n}: Required<SpiralTorsionSpringVisualizerProps>) {\n  const groupRef = useRef<THREE.Group>(null);\n\n  return (\n    <>\n      <color attach=\"background\" args={[previewTheme.background]} />\n      \n      <ambientLight intensity={previewTheme.lights.ambient} />\n      <directionalLight position={previewTheme.lights.key.position} intensity={previewTheme.lights.key.intensity} castShadow />\n      <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n      <pointLight position={previewTheme.lights.point.position} intensity={previewTheme.lights.point.intensity} />\n      \n      {/* 螺旋扭转弹簧网格 */}\n      <group ref={groupRef} rotation={[Math.PI / 2, 0, 0]}>\n        <SpiralTorsionSpringMesh\n          innerDiameter={innerDiameter}\n          outerDiameter={outerDiameter}\n          turns={turns}\n          stripWidth={stripWidth}\n          stripThickness={stripThickness}\n          handedness={handedness}\n          scale={scaleFactor}\n          color=\"#6b9bd1\"\n          metalness={previewTheme.material.spring.metalness}\n          roughness={previewTheme.material.spring.roughness}\n        />\n      </group>\n\n      <gridHelper args={[100, 20, previewTheme.grid.major, previewTheme.grid.minor]} position={[0, -20, 0]} />\n      \n      {/* 自动对焦相机 */}\n      <FitToObject groupRef={groupRef} autoRotate={autoRotate} />\n    </>\n  );\n}\n\nexport function SpiralTorsionSpringVisualizer({\n  innerDiameter = 15,\n  outerDiameter = 50,\n  turns = 5,\n  stripWidth = 10,\n  stripThickness = 0.5,\n  handedness = \"cw\",\n  autoRotate = false,\n  scaleFactor = 1, // 不再需要手动缩放，FitToObject 会自动调整\n}: SpiralTorsionSpringVisualizerProps) {\n  return (\n    <Canvas\n      camera={{ fov: 45, near: 0.1, far: 5000 }}\n      style={{ width: \"100%\", height: \"100%\" }}\n    >\n      <SpiralTorsionScene\n        innerDiameter={innerDiameter}\n        outerDiameter={outerDiameter}\n        turns={turns}\n        stripWidth={stripWidth}\n        stripThickness={stripThickness}\n        handedness={handedness}\n        autoRotate={autoRotate}\n        scaleFactor={scaleFactor}\n      />\n    </Canvas>\n  );\n}\n\nexport default SpiralTorsionSpringMesh;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/SpringModel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'springHeight' is assigned a value but never used.","line":115,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":115,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport * as THREE from \"three\";\nimport { useMemo } from \"react\";\nimport { TubeGeometry, MeshStandardMaterial } from \"three\";\n\n/**\n * Engineering-accurate compression spring geometry generator\n * \n * Features:\n * - Dead coils at both ends (ground & closed)\n * - Segmented pitch: dead coils use pitch = wire diameter\n * - Active coils use normal pitch\n * - Clipping planes for ground flat ends\n * - End cap discs for visual reinforcement\n * \n * Structure (from bottom to top):\n * - Bottom dead coils: Nc/2 coils with pitch = d (wire diameter)\n * - Active coils: Na coils with pitch = normalPitch\n * - Top dead coils: Nc/2 coils with pitch = d (wire diameter)\n */\nfunction generateSpringCenterline(\n  radius: number,\n  normalPitch: number,\n  closedPitch: number,\n  activeCoils: number,\n  deadCoilsPerEnd: number,\n): { points: THREE.Vector3[]; minY: number; maxY: number } {\n  const totalCoils = activeCoils + 2 * deadCoilsPerEnd;\n  const numSamples = 800;\n  const totalAngle = 2 * Math.PI * totalCoils;\n\n  const points: THREE.Vector3[] = [];\n  let minY = Infinity;\n  let maxY = -Infinity;\n\n  for (let i = 0; i <= numSamples; i++) {\n    const t = i / numSamples;\n    const θ = t * totalAngle;\n    const n = θ / (2 * Math.PI); // Current coil number\n\n    // Calculate Y (height) based on which segment we're in\n    let y: number;\n\n    if (n <= deadCoilsPerEnd) {\n      // Bottom dead coils region - pitch = closedPitch (wire diameter)\n      y = n * closedPitch;\n    } else if (n >= totalCoils - deadCoilsPerEnd) {\n      // Top dead coils region\n      const bottomDeadHeight = deadCoilsPerEnd * closedPitch;\n      const activeHeight = activeCoils * normalPitch;\n      const nDeadTop = n - (totalCoils - deadCoilsPerEnd);\n      y = bottomDeadHeight + activeHeight + nDeadTop * closedPitch;\n    } else {\n      // Active coils region\n      const bottomDeadHeight = deadCoilsPerEnd * closedPitch;\n      const nActive = n - deadCoilsPerEnd;\n      y = bottomDeadHeight + nActive * normalPitch;\n    }\n\n    const x = radius * Math.cos(θ);\n    const z = radius * Math.sin(θ);\n\n    points.push(new THREE.Vector3(x, y, z));\n\n    minY = Math.min(minY, y);\n    maxY = Math.max(maxY, y);\n  }\n\n  return { points, minY, maxY };\n}\n\nexport function SpringModel({\n  wireDiameter,\n  meanDiameter,\n  activeCoils,\n  pitch,\n  totalCoils,\n  topGround = true,\n  bottomGround = true,\n}: {\n  wireDiameter: number;\n  meanDiameter: number;\n  activeCoils: number;\n  pitch: number;\n  totalCoils?: number;\n  topGround?: boolean;\n  bottomGround?: boolean;\n}) {\n  // Scale factor: 1 mm = 0.02 scene units (makes 24mm spring ~0.48 units wide)\n  const SCALE = 0.02;\n  const radius = (meanDiameter / 2) * SCALE;\n  const thickness = wireDiameter * SCALE;\n  const pitchScaled = pitch * SCALE;\n  const wireRadius = thickness / 2;\n\n  // Closed end coil pitch: wire diameter (coils touching each other)\n  const closedPitch = thickness;\n\n  // Dead coils per end (for ground ends)\n  const deadCoilsPerEnd = totalCoils ? Math.max(0.75, (totalCoils - activeCoils) / 2) : 1;\n\n  // Generate spring centerline using segmented pitch model\n  const springData = useMemo(() => {\n    return generateSpringCenterline(\n      radius,\n      pitchScaled,\n      closedPitch,\n      activeCoils,\n      deadCoilsPerEnd\n    );\n  }, [radius, pitchScaled, closedPitch, activeCoils, deadCoilsPerEnd]);\n\n  // Create curve and geometry from centerline points\n  const { springGeometry, springHeight, grindDepth } = useMemo(() => {\n    const curve = new THREE.CatmullRomCurve3(springData.points);\n    const geometry = new TubeGeometry(curve, springData.points.length - 1, wireRadius, 16, false);\n    const height = springData.maxY - springData.minY;\n    const grind = wireRadius * 0.7; // Grind depth for flat ends (0.35 × wire diameter)\n    return { springGeometry: geometry, springHeight: height, grindDepth: grind };\n  }, [springData, wireRadius]);\n\n  // Calculate cut positions in local Y coordinates\n  const bottomCutLocalY = springData.minY + grindDepth;\n  const topCutLocalY = springData.maxY - grindDepth;\n  \n  // Center offset to position spring centered at origin\n  const centerY = (springData.minY + springData.maxY) / 2;\n\n  // After rotation [Math.PI/2, 0, 0], local Y becomes world -Z\n  // So we need to clip in Z direction in world space\n  // bottomCutLocalY in local Y → -(bottomCutLocalY - centerY) in world Z\n  // topCutLocalY in local Y → -(topCutLocalY - centerY) in world Z\n  const bottomCutWorldZ = -(bottomCutLocalY - centerY);\n  const topCutWorldZ = -(topCutLocalY - centerY);\n\n  // Material with clipping planes for ground ends\n  // Clipping planes work in WORLD coordinates\n  const clippedMaterial = useMemo(() => {\n    const mat = new MeshStandardMaterial({\n      color: \"#c0c5cc\",\n      metalness: 0.9,\n      roughness: 0.2,\n      side: THREE.DoubleSide,\n    });\n\n    const planes: THREE.Plane[] = [];\n    if (bottomGround) {\n      // After rotation, bottom is at positive Z in world space\n      // Clip everything with Z > bottomCutWorldZ (plane normal points -Z)\n      planes.push(new THREE.Plane(new THREE.Vector3(0, 0, -1), bottomCutWorldZ));\n    }\n    if (topGround) {\n      // After rotation, top is at negative Z in world space  \n      // Clip everything with Z < topCutWorldZ (plane normal points +Z)\n      planes.push(new THREE.Plane(new THREE.Vector3(0, 0, 1), -topCutWorldZ));\n    }\n    mat.clippingPlanes = planes;\n    mat.clipShadows = true;\n\n    return mat;\n  }, [bottomCutWorldZ, topCutWorldZ, bottomGround, topGround]);\n\n  // End cap geometry for ground surfaces (ring shape)\n  const endCapGeometry = useMemo(() => {\n    const outerRadius = radius + wireRadius;\n    const innerRadius = Math.max(0, radius - wireRadius);\n    return new THREE.RingGeometry(innerRadius, outerRadius, 32);\n  }, [radius, wireRadius]);\n\n  return (\n    <group rotation={[Math.PI / 2, 0, 0]} position={[0, 0, 0]}>\n      {/* Complete spring with clipping for ground ends */}\n      <mesh geometry={springGeometry} material={clippedMaterial} position={[0, -centerY, 0]} />\n\n      {/* Bottom end cap (ground surface) - at local Y = bottomCutLocalY */}\n      {bottomGround && (\n        <mesh position={[0, bottomCutLocalY - centerY, 0]} rotation={[-Math.PI / 2, 0, 0]}>\n          <primitive object={endCapGeometry} attach=\"geometry\" />\n          <meshStandardMaterial color=\"#a0a5ac\" metalness={0.95} roughness={0.1} side={THREE.DoubleSide} />\n        </mesh>\n      )}\n\n      {/* Top end cap (ground surface) - at local Y = topCutLocalY */}\n      {topGround && (\n        <mesh position={[0, topCutLocalY - centerY, 0]} rotation={[Math.PI / 2, 0, 0]}>\n          <primitive object={endCapGeometry} attach=\"geometry\" />\n          <meshStandardMaterial color=\"#a0a5ac\" metalness={0.95} roughness={0.1} side={THREE.DoubleSide} />\n        </mesh>\n      )}\n    </group>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/StressSpringModel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'springHeight' is assigned a value but never used.","line":162,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":162,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'colorScale' is assigned a value but never used.","line":162,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":162,"endColumn":45},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `totalCoils`, but the source dependencies were [springData, wireRadius, showStress, axialForce, maxStress]. Inferred different dependency than source.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/StressSpringModel.tsx:162:58\n  160 |\n  161 |   // Create tube geometry with vertex colors\n> 162 |   const { geometry, springHeight, colorScale } = useMemo(() => {\n      |                                                          ^^^^^^^\n> 163 |     const curve = new THREE.CatmullRomCurve3(springData.points);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 164 |     const tubularSegments = springData.points.length - 1;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 215 |     };\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 216 |   }, [springData, wireRadius, showStress, axialForce, maxStress]);\n      | ^^^^ Could not preserve existing manual memoization\n  217 |\n  218 |   const centerY = (springData.minY + springData.maxY) / 2;\n  219 |","line":162,"column":58,"nodeType":null,"endLine":216,"endColumn":4},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `activeCoils`, but the source dependencies were [springData, wireRadius, showStress, axialForce, maxStress]. Inferred different dependency than source.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/StressSpringModel.tsx:162:58\n  160 |\n  161 |   // Create tube geometry with vertex colors\n> 162 |   const { geometry, springHeight, colorScale } = useMemo(() => {\n      |                                                          ^^^^^^^\n> 163 |     const curve = new THREE.CatmullRomCurve3(springData.points);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 164 |     const tubularSegments = springData.points.length - 1;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 215 |     };\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 216 |   }, [springData, wireRadius, showStress, axialForce, maxStress]);\n      | ^^^^ Could not preserve existing manual memoization\n  217 |\n  218 |   const centerY = (springData.minY + springData.maxY) / 2;\n  219 |","line":162,"column":58,"nodeType":null,"endLine":216,"endColumn":4},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `showCoilBind`, but the source dependencies were [springData, wireRadius, showStress, axialForce, maxStress]. Inferred different dependency than source.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/StressSpringModel.tsx:162:58\n  160 |\n  161 |   // Create tube geometry with vertex colors\n> 162 |   const { geometry, springHeight, colorScale } = useMemo(() => {\n      |                                                          ^^^^^^^\n> 163 |     const curve = new THREE.CatmullRomCurve3(springData.points);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 164 |     const tubularSegments = springData.points.length - 1;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 215 |     };\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 216 |   }, [springData, wireRadius, showStress, axialForce, maxStress]);\n      | ^^^^ Could not preserve existing manual memoization\n  217 |\n  218 |   const centerY = (springData.minY + springData.maxY) / 2;\n  219 |","line":162,"column":58,"nodeType":null,"endLine":216,"endColumn":4},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `wireDiameter`, but the source dependencies were [springData, wireRadius, showStress, axialForce, maxStress]. Inferred different dependency than source.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/StressSpringModel.tsx:162:58\n  160 |\n  161 |   // Create tube geometry with vertex colors\n> 162 |   const { geometry, springHeight, colorScale } = useMemo(() => {\n      |                                                          ^^^^^^^\n> 163 |     const curve = new THREE.CatmullRomCurve3(springData.points);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 164 |     const tubularSegments = springData.points.length - 1;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 215 |     };\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 216 |   }, [springData, wireRadius, showStress, axialForce, maxStress]);\n      | ^^^^ Could not preserve existing manual memoization\n  217 |\n  218 |   const centerY = (springData.minY + springData.maxY) / 2;\n  219 |","line":162,"column":58,"nodeType":null,"endLine":216,"endColumn":4},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `pitch`, but the source dependencies were [springData, wireRadius, showStress, axialForce, maxStress]. Inferred different dependency than source.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/StressSpringModel.tsx:162:58\n  160 |\n  161 |   // Create tube geometry with vertex colors\n> 162 |   const { geometry, springHeight, colorScale } = useMemo(() => {\n      |                                                          ^^^^^^^\n> 163 |     const curve = new THREE.CatmullRomCurve3(springData.points);\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 164 |     const tubularSegments = springData.points.length - 1;\n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 215 |     };\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 216 |   }, [springData, wireRadius, showStress, axialForce, maxStress]);\n      | ^^^^ Could not preserve existing manual memoization\n  217 |\n  218 |   const centerY = (springData.minY + springData.maxY) / 2;\n  219 |","line":162,"column":58,"nodeType":null,"endLine":216,"endColumn":4},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalCoilsVal' is assigned a value but never used.","line":190,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":190,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'freeLength' is assigned a value but never used.","line":191,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":191,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentHeight' is assigned a value but never used.","line":192,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":192,"endColumn":28},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has missing dependencies: 'activeCoils', 'pitch', 'showCoilBind', 'totalCoils', and 'wireDiameter'. Either include them or remove the dependency array.","line":216,"column":6,"nodeType":"ArrayExpression","endLine":216,"endColumn":65,"suggestions":[{"desc":"Update the dependencies array to be: [springData.points, springData.stresses, springData.maxY, springData.minY, wireRadius, maxStress, showStress, axialForce, activeCoils, totalCoils, pitch, wireDiameter, showCoilBind]","fix":{"range":[7280,7339],"text":"[springData.points, springData.stresses, springData.maxY, springData.minY, wireRadius, maxStress, showStress, axialForce, activeCoils, totalCoils, pitch, wireDiameter, showCoilBind]"}}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport * as THREE from \"three\";\nimport { useMemo } from \"react\";\n\n/**\n * Estimated Stress Spring Model with Vertex Color Visualization\n * \n * Calculates stress per segment using beam theory:\n * τ = 8 * F * K * D / (π * d³)\n * \n * Where:\n * - F = axial force (N)\n * - K = Wahl correction factor\n * - D = mean diameter (mm)\n * - d = wire diameter (mm)\n */\n\ninterface StressSpringModelProps {\n  wireDiameter: number;      // mm\n  meanDiameter: number;      // mm\n  activeCoils: number;\n  pitch: number;             // mm\n  totalCoils?: number;\n  axialForce: number;        // N - from FEA reaction force\n  maxStress?: number;        // MPa - for color scale max (optional)\n  showStress?: boolean;      // Toggle stress visualization\n  scale?: number;            // Scene scale factor (default: 50/max(D*1.5, L0))\n  showCoilBind?: boolean;    // Toggle coil bind visualization (red highlight)\n}\n\n// Color interpolation: blue (low) → green → yellow → red (high)\nfunction stressToColor(stress: number, minStress: number, maxStress: number): THREE.Color {\n  const t = Math.max(0, Math.min(1, (stress - minStress) / (maxStress - minStress)));\n  \n  // 4-color gradient: blue → cyan → yellow → red\n  if (t < 0.25) {\n    // Blue to Cyan\n    const u = t / 0.25;\n    return new THREE.Color(0, u, 1);\n  } else if (t < 0.5) {\n    // Cyan to Green\n    const u = (t - 0.25) / 0.25;\n    return new THREE.Color(0, 1, 1 - u);\n  } else if (t < 0.75) {\n    // Green to Yellow\n    const u = (t - 0.5) / 0.25;\n    return new THREE.Color(u, 1, 0);\n  } else {\n    // Yellow to Red\n    const u = (t - 0.75) / 0.25;\n    return new THREE.Color(1, 1 - u, 0);\n  }\n}\n\n// Generate spring centerline with stress values per point\nfunction generateStressedCenterline(\n  radius: number,\n  normalPitch: number,\n  closedPitch: number,\n  activeCoils: number,\n  deadCoilsPerEnd: number,\n  axialForce: number,\n  wireDiameter: number,\n  meanDiameter: number\n): { points: THREE.Vector3[]; stresses: number[]; minY: number; maxY: number } {\n  const totalCoils = activeCoils + 2 * deadCoilsPerEnd;\n  const numSamples = 800;\n  const totalAngle = 2 * Math.PI * totalCoils;\n\n  // Calculate Wahl correction factor\n  const c = meanDiameter / wireDiameter;  // Spring index\n  const K = (4 * c - 1) / (4 * c - 4) + 0.615 / c;\n  \n  // Calculate max shear stress τ = 8 * F * K * D / (π * d³)\n  const tauMax = (8 * axialForce * K * meanDiameter) / (Math.PI * Math.pow(wireDiameter, 3));\n\n  const points: THREE.Vector3[] = [];\n  const stresses: number[] = [];\n  let minY = Infinity;\n  let maxY = -Infinity;\n\n  for (let i = 0; i <= numSamples; i++) {\n    const t = i / numSamples;\n    const θ = t * totalAngle;\n    const n = θ / (2 * Math.PI);\n\n    // Calculate Y (height) based on segment\n    let y: number;\n    let stressFactor: number;\n\n    if (n <= deadCoilsPerEnd) {\n      // Bottom dead coils - stress tapers to ~20% at ends\n      y = n * closedPitch;\n      stressFactor = 0.2 + 0.8 * (n / deadCoilsPerEnd);\n    } else if (n >= totalCoils - deadCoilsPerEnd) {\n      // Top dead coils - stress tapers down\n      const bottomDeadHeight = deadCoilsPerEnd * closedPitch;\n      const activeHeight = activeCoils * normalPitch;\n      const nDeadTop = n - (totalCoils - deadCoilsPerEnd);\n      y = bottomDeadHeight + activeHeight + nDeadTop * closedPitch;\n      stressFactor = 0.2 + 0.8 * (1 - nDeadTop / deadCoilsPerEnd);\n    } else {\n      // Active coils - full stress\n      const bottomDeadHeight = deadCoilsPerEnd * closedPitch;\n      const nActive = n - deadCoilsPerEnd;\n      y = bottomDeadHeight + nActive * normalPitch;\n      stressFactor = 1.0;\n    }\n\n    const x = radius * Math.cos(θ);\n    const z = radius * Math.sin(θ);\n\n    points.push(new THREE.Vector3(x, y, z));\n    stresses.push(tauMax * stressFactor);\n\n    minY = Math.min(minY, y);\n    maxY = Math.max(maxY, y);\n  }\n\n  return { points, stresses, minY, maxY };\n}\n\nexport function StressSpringModel({\n  wireDiameter,\n  meanDiameter,\n  activeCoils,\n  pitch,\n  totalCoils,\n  axialForce,\n  maxStress,\n  showStress = true,\n  scale: scaleProp,\n  showCoilBind = true,\n}: StressSpringModelProps) {\n  // Scale factor: use prop if provided, otherwise calculate from geometry\n  const freeLength = pitch * activeCoils + wireDiameter * (totalCoils ?? activeCoils);\n  const SCALE = scaleProp ?? 50 / Math.max(meanDiameter * 1.5, freeLength);\n  const radius = (meanDiameter / 2) * SCALE;\n  const thickness = wireDiameter * SCALE;\n  const pitchScaled = pitch * SCALE;\n  const wireRadius = thickness / 2;\n  const closedPitch = thickness;\n\n  const deadCoilsPerEnd = totalCoils ? Math.max(0.75, (totalCoils - activeCoils) / 2) : 1;\n\n  // Generate spring with stress values\n  const springData = useMemo(() => {\n    return generateStressedCenterline(\n      radius,\n      pitchScaled,\n      closedPitch,\n      activeCoils,\n      deadCoilsPerEnd,\n      axialForce,\n      wireDiameter,\n      meanDiameter\n    );\n  }, [radius, pitchScaled, closedPitch, activeCoils, deadCoilsPerEnd, axialForce, wireDiameter, meanDiameter]);\n\n  // Create tube geometry with vertex colors\n  const { geometry, springHeight, colorScale } = useMemo(() => {\n    const curve = new THREE.CatmullRomCurve3(springData.points);\n    const tubularSegments = springData.points.length - 1;\n    const radialSegments = 16;\n    \n    const tubeGeometry = new THREE.TubeGeometry(curve, tubularSegments, wireRadius, radialSegments, false);\n    \n    // Calculate color scale\n    const stressMin = Math.min(...springData.stresses);\n    const stressMax = maxStress ?? Math.max(...springData.stresses);\n    \n    if (showStress && axialForce > 0) {\n      // Add vertex colors based on stress\n      const position = tubeGeometry.getAttribute('position');\n      const colors = new Float32Array(position.count * 3);\n      \n      // For each vertex, find the closest centerline point and get its stress\n      const verticesPerRing = radialSegments + 1;\n      \n      for (let i = 0; i < position.count; i++) {\n        // Which ring (axial segment) is this vertex on?\n        const ringIndex = Math.floor(i / verticesPerRing);\n        const stressIndex = Math.min(ringIndex, springData.stresses.length - 1);\n        const stress = springData.stresses[stressIndex] || stressMin;\n        \n        let color: THREE.Color;\n        \n        // Detect coil bind: If current pitch <= wireDiameter, color red\n        const totalCoilsVal = activeCoils + (totalCoils ? (totalCoils - activeCoils) : 2);\n        const freeLength = pitch * activeCoils + wireDiameter * (totalCoils ?? activeCoils + 2);\n        const currentHeight = pitch * activeCoils; // simplified\n        const isBindSegment = showCoilBind && (pitch <= wireDiameter * 1.05);\n\n        if (isBindSegment) {\n          color = new THREE.Color(1, 0, 0); // Pure Red for bind\n        } else {\n          color = stressToColor(stress, stressMin, stressMax);\n        }\n\n        colors[i * 3] = color.r;\n        colors[i * 3 + 1] = color.g;\n        colors[i * 3 + 2] = color.b;\n      }\n      \n      tubeGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));\n    }\n    \n    const height = springData.maxY - springData.minY;\n    \n    return { \n      geometry: tubeGeometry, \n      springHeight: height,\n      colorScale: { min: stressMin, max: stressMax }\n    };\n  }, [springData, wireRadius, showStress, axialForce, maxStress]);\n\n  const centerY = (springData.minY + springData.maxY) / 2;\n\n  // Material with vertex colors\n  const material = useMemo(() => {\n    if (showStress && axialForce > 0) {\n      return new THREE.MeshStandardMaterial({\n        vertexColors: true,\n        metalness: 0.6,\n        roughness: 0.4,\n        side: THREE.DoubleSide,\n      });\n    } else {\n      // Default metallic green\n      return new THREE.MeshStandardMaterial({\n        color: \"#22c55e\",\n        metalness: 0.9,\n        roughness: 0.2,\n        side: THREE.DoubleSide,\n      });\n    }\n  }, [showStress, axialForce]);\n\n  return (\n    <group rotation={[Math.PI / 2, 0, 0]} position={[0, 0, 0]}>\n      <mesh geometry={geometry} material={material} position={[0, -centerY, 0]} />\n    </group>\n  );\n}\n\n// Color legend component\nexport function StressColorLegend({ \n  minStress, \n  maxStress, \n  isZh = false \n}: { \n  minStress: number; \n  maxStress: number; \n  isZh?: boolean;\n}) {\n  const gradientStops = [\n    { pos: 0, color: 'rgb(0, 0, 255)' },      // Blue\n    { pos: 25, color: 'rgb(0, 255, 255)' },   // Cyan\n    { pos: 50, color: 'rgb(0, 255, 0)' },     // Green\n    { pos: 75, color: 'rgb(255, 255, 0)' },   // Yellow\n    { pos: 100, color: 'rgb(255, 0, 0)' },    // Red\n  ];\n  \n  const gradient = `linear-gradient(to right, ${gradientStops.map(s => `${s.color} ${s.pos}%`).join(', ')})`;\n\n  return (\n    <div className=\"flex flex-col gap-1 text-xs\">\n      <div className=\"flex items-center justify-between text-muted-foreground\">\n        <span>{minStress.toFixed(0)}</span>\n        <span>{isZh ? \"应力 (MPa)\" : \"Stress (MPa)\"}</span>\n        <span>{maxStress.toFixed(0)}</span>\n      </div>\n      <div \n        className=\"h-3 rounded-sm\"\n        style={{ background: gradient }}\n      />\n      <div className=\"text-center text-muted-foreground italic\">\n        {isZh ? \"估算应力 (梁理论)\" : \"Estimated stress (beam theory)\"}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/SuspensionSpringMesh.tsx","messages":[{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `compressedLength`, but the source dependencies were [wireDiameter, activeCoils, totalCoils, freeLength, currentDeflection, scale, pitchProfile, diameterProfile]. Inferred different dependency than source.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/SuspensionSpringMesh.tsx:60:28\n  58 |   const isAtSolid = compressedLength <= solidHeight * 1.01;\n  59 |\n> 60 |   const geometry = useMemo(() => {\n     |                            ^^^^^^^\n> 61 |     // Default profiles if not provided\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 62 |     const effectivePitchProfile: PitchProfile = pitchProfile ?? { mode: \"uniform\" };\n     …\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 87 |     };\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 88 |   }, [wireDiameter, activeCoils, totalCoils, freeLength, currentDeflection, scale, pitchProfile, diameterProfile]);\n     | ^^^^ Could not preserve existing manual memoization\n  89 |\n  90 |   const springColor = useMemo(() => getStressColor(stressRatio), [stressRatio]);\n  91 |","line":60,"column":28,"nodeType":null,"endLine":88,"endColumn":4},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'compressedLength'. Either include it or remove the dependency array.","line":88,"column":6,"nodeType":"ArrayExpression","endLine":88,"endColumn":114,"suggestions":[{"desc":"Update the dependencies array to be: [pitchProfile, diameterProfile, wireDiameter, activeCoils, totalCoils, freeLength, compressedLength, scale]","fix":{"range":[2887,2995],"text":"[pitchProfile, diameterProfile, wireDiameter, activeCoils, totalCoils, freeLength, compressedLength, scale]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useMemo, useRef } from \"react\";\nimport * as THREE from \"three\";\nimport { useFrame } from \"@react-three/fiber\";\nimport {\n  buildSuspensionSpringGeometry,\n} from \"@/lib/spring3d/suspensionSpringGeometry\";\nimport type { PitchProfile, DiameterProfile } from \"@/lib/springTypes\";\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\nexport interface SuspensionSpringMeshProps {\n  wireDiameter: number;\n  activeCoils: number;\n  totalCoils: number;\n  freeLength: number;\n  currentDeflection: number;\n  stressRatio: number;\n  solidHeight: number;\n  scale?: number;\n  pitchProfile?: PitchProfile;\n  diameterProfile?: DiameterProfile;\n}\n\nfunction getStressColor(ratio: number): THREE.Color {\n  if (ratio <= 0.6) {\n    return new THREE.Color(0x22c55e);\n  } else if (ratio <= 0.8) {\n    const t = (ratio - 0.6) / 0.2;\n    const color = new THREE.Color();\n    color.lerpColors(new THREE.Color(0x22c55e), new THREE.Color(0xeab308), t);\n    return color;\n  } else {\n    const t = Math.min(1, (ratio - 0.8) / 0.2);\n    const color = new THREE.Color();\n    color.lerpColors(new THREE.Color(0xeab308), new THREE.Color(0xef4444), t);\n    return color;\n  }\n}\n\nexport function SuspensionSpringMesh({\n  wireDiameter,\n  activeCoils,\n  totalCoils,\n  freeLength,\n  currentDeflection,\n  stressRatio,\n  solidHeight,\n  scale = 1,\n  pitchProfile,\n  diameterProfile,\n}: SuspensionSpringMeshProps) {\n  const meshRef = useRef<THREE.Mesh>(null);\n  const materialRef = useRef<THREE.MeshStandardMaterial>(null);\n\n  const compressedLength = freeLength - currentDeflection;\n  const isNearSolid = compressedLength <= solidHeight * 1.1;\n  const isAtSolid = compressedLength <= solidHeight * 1.01;\n\n  const geometry = useMemo(() => {\n    // Default profiles if not provided\n    const effectivePitchProfile: PitchProfile = pitchProfile ?? { mode: \"uniform\" };\n    const effectiveDiameterProfile: DiameterProfile = diameterProfile ?? { mode: \"constant\", DmStart: 100 }; // Fallback Dm if not provided? Actually Dm is usually passed.\n    // Wait, DmStart should likely default to meanDiameter if passed?\n    // SuspensionSpringMeshProps doesn't have meanDiameter anymore.\n    // We should rely on DiameterProfile being fully populated by the caller (Visualizer).\n    \n    const result = buildSuspensionSpringGeometry({\n      wireDiameter,\n      activeCoils,\n      totalCoils,\n      freeLength,\n      pitchProfile: effectivePitchProfile,\n      diameterProfile: effectiveDiameterProfile,\n      targetHeight: compressedLength, \n    });\n\n    // Scale geometry\n    if (scale !== 1) {\n      result.geometry.scale(scale, scale, scale);\n    }\n    \n    return {\n      tubeGeometry: result.geometry,\n      // Minimal dummy end discs to satisfy return type structure if needed, or we just use tubeGeometry\n      endDiscs: { bottomPosition: 0, topPosition: 0, innerRadius: 0, outerRadius: 0 } \n    };\n  }, [wireDiameter, activeCoils, totalCoils, freeLength, currentDeflection, scale, pitchProfile, diameterProfile]);\n\n  const springColor = useMemo(() => getStressColor(stressRatio), [stressRatio]);\n\n  useFrame((state) => {\n    if (materialRef.current && isNearSolid) {\n      const pulse = Math.sin(state.clock.elapsedTime * 4) * 0.3 + 0.3;\n      materialRef.current.emissiveIntensity = isAtSolid ? 0.5 + pulse : pulse * 0.5;\n    } else if (materialRef.current) {\n      materialRef.current.emissiveIntensity = 0;\n    }\n  });\n\n  const { tubeGeometry } = geometry;\n\n  return (\n    <group>\n      <mesh ref={meshRef} geometry={tubeGeometry}>\n        <meshStandardMaterial\n          ref={materialRef}\n          color={springColor}\n          emissive={isNearSolid ? new THREE.Color(0xff0000) : springColor}\n          emissiveIntensity={0}\n          metalness={0.3}\n          roughness={0.4}\n          side={THREE.DoubleSide}\n        />\n      </mesh>\n\n      {/* Shadows/Guides */}\n      <mesh position={[0, 0, -0.5]} rotation={[0, 0, 0]}>\n        <circleGeometry args={[100 * scale, 32]} />\n        <meshStandardMaterial\n          color={previewTheme.material.groundShadow.color}\n          transparent\n          opacity={previewTheme.material.groundShadow.opacity}\n        />\n      </mesh>\n    </group>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/SuspensionSpringVisualizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[905,908],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[905,908],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'displayMode' is assigned a value but never used.","line":85,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":85,"endColumn":14},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2540,2543],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2540,2543],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useRef, useState, useCallback, useEffect } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls } from \"@react-three/drei\";\nimport { Button } from \"@/components/ui/button\";\nimport { RotateCcw } from \"lucide-react\";\nimport { SuspensionSpringMesh } from \"./SuspensionSpringMesh\";\nimport { StressSpringModel, StressColorLegend } from \"./StressSpringModel\";\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\nconst VIEW_PRESETS = {\n  perspective: { position: [60, 40, 80], target: [0, 0, 25] },\n  front: { position: [0, 0, 100], target: [0, 0, 25] },\n  top: { position: [0, 100, 25], target: [0, 0, 25] },\n  side: { position: [100, 0, 25], target: [0, 0, 25] },\n} as const;\n\ntype ViewType = keyof typeof VIEW_PRESETS;\n\nfunction CameraController({\n  viewType,\n  controlsRef,\n}: {\n  viewType: ViewType;\n  controlsRef: React.RefObject<any>;\n}) {\n  const { camera } = useThree();\n\n  useEffect(() => {\n    const preset = VIEW_PRESETS[viewType];\n    camera.position.set(...(preset.position as [number, number, number]));\n    camera.lookAt(...(preset.target as [number, number, number]));\n    camera.updateProjectionMatrix();\n\n    setTimeout(() => {\n      if (controlsRef.current) {\n        controlsRef.current.target.set(...(preset.target as [number, number, number]));\n        controlsRef.current.update();\n      }\n    }, 10);\n  }, [viewType, camera, controlsRef]);\n\n  return null;\n}\n\nimport type { PitchProfile, DiameterProfile } from \"@/lib/springTypes\";\n\nexport interface SuspensionSpringVisualizerProps {\n  wireDiameter: number;\n  meanDiameter: number;\n  activeCoils: number;\n  totalCoils: number;\n  freeLength: number;\n  currentDeflection: number;\n  stressRatio: number;\n  solidHeight: number;\n  currentLoad: number;\n  springRate: number;\n  pitchProfile?: PitchProfile;\n  diameterProfile?: DiameterProfile;\n  // FEA stress visualization\n  feaForce?: number;          // FEA reaction force (N) for stress calculation\n  showStressContour?: boolean; // Toggle stress contour display\n  isZh?: boolean;             // Language for legend\n  displayMode?: \"geometry\" | \"engineering\";\n}\n\nexport function SuspensionSpringVisualizer({\n  wireDiameter,\n  meanDiameter,\n  activeCoils,\n  totalCoils,\n  freeLength,\n  currentDeflection,\n  stressRatio,\n  solidHeight,\n  currentLoad,\n  springRate,\n  pitchProfile,\n  diameterProfile,\n  feaForce,\n  showStressContour = false,\n  isZh = false,\n  displayMode = \"geometry\",\n}: SuspensionSpringVisualizerProps) {\n  const controlsRef = useRef<any>(null);\n  const [currentView, setCurrentView] = useState<ViewType>(\"perspective\");\n\n  const handleViewChange = useCallback((view: ViewType) => {\n    setCurrentView(view);\n  }, []);\n\n  const scale = 50 / Math.max(meanDiameter * 1.5, freeLength);\n  const compressedLength = freeLength - currentDeflection;\n  const isNearSolid = compressedLength <= solidHeight * 1.1;\n  const isAtSolid = compressedLength <= solidHeight * 1.01;\n\n  const getStatusColor = () => {\n    if (stressRatio >= 1.0) return \"text-red-600\";\n    if (stressRatio >= 0.8) return \"text-amber-600\";\n    return \"text-green-600\";\n  };\n\n  const getStressColorHex = () => {\n    if (stressRatio <= 0.6) return \"#22c55e\";\n    if (stressRatio <= 0.8) return \"#eab308\";\n    return \"#ef4444\";\n  };\n\n  return (\n    <div className=\"relative h-full w-full\">\n      <Canvas\n        camera={{ position: [60, 40, 80], fov: 45 }}\n        gl={{ localClippingEnabled: true }}\n      >\n        <CameraController viewType={currentView} controlsRef={controlsRef} />\n        <color attach=\"background\" args={[previewTheme.background]} />\n        <ambientLight intensity={previewTheme.lights.ambient} />\n        <directionalLight\n          position={previewTheme.lights.key.position}\n          intensity={previewTheme.lights.key.intensity}\n          castShadow\n        />\n        <directionalLight\n          position={previewTheme.lights.fill.position}\n          intensity={previewTheme.lights.fill.intensity}\n        />\n        <pointLight\n          position={previewTheme.lights.point.position}\n          intensity={previewTheme.lights.point.intensity}\n        />\n\n        {showStressContour && feaForce && feaForce > 0 ? (\n          <StressSpringModel\n            wireDiameter={wireDiameter}\n            meanDiameter={meanDiameter}\n            activeCoils={activeCoils}\n            pitch={(freeLength - wireDiameter * totalCoils) / activeCoils}\n            totalCoils={totalCoils}\n            axialForce={feaForce}\n            showStress={true}\n            scale={scale}\n            showCoilBind={true}\n          />\n        ) : (\n          <SuspensionSpringMesh\n            wireDiameter={wireDiameter}\n            activeCoils={activeCoils}\n            totalCoils={totalCoils}\n            freeLength={freeLength}\n            currentDeflection={currentDeflection}\n            stressRatio={stressRatio}\n            solidHeight={solidHeight}\n            scale={scale}\n            pitchProfile={pitchProfile}\n            diameterProfile={diameterProfile}\n          />\n        )}\n\n        <OrbitControls\n          ref={controlsRef}\n          enablePan\n          enableZoom\n          enableRotate\n          minDistance={20}\n          maxDistance={200}\n          target={[0, 0, 25]}\n        />\n\n        <gridHelper\n          args={[80, 16, previewTheme.grid.major, previewTheme.grid.minor]}\n          position={[0, 0, 0]}\n          rotation={[Math.PI / 2, 0, 0]}\n        />\n      </Canvas>\n\n      <div className=\"absolute bottom-2 right-2 flex gap-1\">\n        <Button\n          variant={currentView === \"perspective\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"perspective\")}\n          title=\"透视图 / Perspective\"\n        >\n          <RotateCcw className=\"h-3 w-3 mr-1\" />\n          3D\n        </Button>\n        <Button\n          variant={currentView === \"front\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"front\")}\n          title=\"前视图 / Front View\"\n        >\n          前\n        </Button>\n        <Button\n          variant={currentView === \"top\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"top\")}\n          title=\"俯视图 / Top View\"\n        >\n          顶\n        </Button>\n        <Button\n          variant={currentView === \"side\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"side\")}\n          title=\"侧视图 / Side View\"\n        >\n          侧\n        </Button>\n      </div>\n\n      <div className=\"absolute bottom-2 left-2 rounded bg-white/90 px-2 py-1.5 text-xs shadow\">\n        <div className=\"flex items-center gap-2\">\n          <div\n            className=\"h-3 w-3 rounded-full\"\n            style={{ backgroundColor: getStressColorHex() }}\n          />\n          <span>\n            应力比: <span className={getStatusColor()}>{(stressRatio * 100).toFixed(0)}%</span>\n          </span>\n        </div>\n        {isNearSolid && (\n          <div className=\"mt-1 text-amber-600 font-medium\">\n            ⚠ {isAtSolid ? \"已达固体高度\" : \"接近固体高度\"}\n          </div>\n        )}\n      </div>\n\n      <div className=\"absolute top-2 right-2 rounded bg-white/90 px-2 py-1.5 text-xs shadow space-y-0.5\">\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">Δx:</span>\n          <span className=\"font-medium\">{currentDeflection.toFixed(2)} mm</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">F:</span>\n          <span className=\"font-medium\">{currentLoad.toFixed(1)} N</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">L:</span>\n          <span className=\"font-medium\">{compressedLength.toFixed(2)} mm</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">k:</span>\n          <span className=\"font-medium\">{springRate.toFixed(2)} N/mm</span>\n        </div>\n        <div className=\"border-t border-slate-200 pt-1 mt-1\">\n          <div className=\"flex justify-between gap-4\">\n            <span className=\"text-slate-500\">Hs:</span>\n            <span className=\"font-medium\">{solidHeight.toFixed(1)} mm</span>\n          </div>\n        </div>\n      </div>\n\n      {/* Stress Color Legend when contour is active */}\n      {showStressContour && feaForce && feaForce > 0 && (() => {\n        // Calculate stress range for legend\n        const c = meanDiameter / wireDiameter;\n        const K = (4 * c - 1) / (4 * c - 4) + 0.615 / c;\n        const tauMax = (8 * feaForce * K * meanDiameter) / (Math.PI * Math.pow(wireDiameter, 3));\n        const tauMin = tauMax * 0.2; // Dead coil minimum\n        \n        return (\n          <div className=\"absolute bottom-14 left-2 right-2 rounded bg-white/95 px-2 py-2 shadow\">\n            <StressColorLegend\n              minStress={tauMin}\n              maxStress={tauMax}\n              isZh={isZh}\n            />\n          </div>\n        );\n      })()}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/TorsionSpringVisualizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1530,1533],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1530,1533],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'state' is assigned a value but never used.","line":172,"column":53,"nodeType":null,"messageId":"unusedVar","endLine":172,"endColumn":58},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":298,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":298,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9096,9099],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9096,9099],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useMemo, useRef, useCallback, useState, useEffect } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls } from \"@react-three/drei\";\nimport * as THREE from \"three\";\nimport { \n  useSpringSimulationStore, \n  type TorsionDesignMeta \n} from \"@/lib/stores/springSimulationStore\";\nimport {\n  buildTorsionSpringGeometry,\n  type TorsionSpringParams,\n} from \"@/lib/spring3d/torsionSpringGeometry\";\nimport { useFeaStore } from \"@/lib/stores/feaStore\";\nimport { applyFeaColors, findMaxSigmaNodeIndex, findMaxDispNodeIndex } from \"@/lib/fea/feaTypes\";\nimport { Html } from \"@react-three/drei\";\nimport { Button } from \"@/components/ui/button\";\nimport { RotateCcw } from \"lucide-react\";\n\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\n// View presets - camera positions for different views\nconst VIEW_PRESETS = {\n  perspective: { position: [80, 60, 80], target: [0, 0, 0] },\n  front: { position: [0, 0, 120], target: [0, 0, 0] },      // 前视图\n  top: { position: [0, 120, 0], target: [0, 0, 0] },        // 俯视图\n  side: { position: [120, 0, 0], target: [0, 0, 0] },       // 侧视图\n} as const;\n\ntype ViewType = keyof typeof VIEW_PRESETS;\n\n// Spring colors\nconst BODY_COLOR = \"#f59e0b\"; // Amber for torsion springs\nconst LEG_COLOR = previewTheme.material.endCap.color; // Silver for legs\n\n/**\n * Camera controller component - must be inside Canvas\n */\nfunction CameraController({ \n  viewType, \n  controlsRef \n}: { \n  viewType: ViewType; \n  controlsRef: React.RefObject<any>;\n}) {\n  const { camera } = useThree();\n  \n  useEffect(() => {\n    const preset = VIEW_PRESETS[viewType];\n    camera.position.set(...(preset.position as [number, number, number]));\n    camera.lookAt(...(preset.target as [number, number, number]));\n    camera.updateProjectionMatrix();\n    \n    setTimeout(() => {\n      if (controlsRef.current) {\n        controlsRef.current.target.set(...(preset.target as [number, number, number]));\n        controlsRef.current.update();\n      }\n    }, 10);\n  }, [viewType, camera, controlsRef]);\n  \n  return null;\n}\n\n/**\n * Animated torsion spring model with engineering-accurate geometry\n * \n * Features:\n * - Helical body coils\n * - Straight or bent legs\n * - Dynamic angle animation\n */\nfunction AnimatedTorsionSpring() {\n  const design = useSpringSimulationStore((state) => state.design);\n  const currentDeflection = useSpringSimulationStore((state) => state.currentDeflection);\n  \n  // FEA store state for coloring\n  const feaResult = useFeaStore((s) => s.feaResult);\n  const colorMode = useFeaStore((s) => s.colorMode);\n  const isFeaMode = colorMode !== \"formula\" && feaResult !== null;\n\n  // Type guard for torsion design\n  const torsionDesign = design?.type === \"torsion\" ? design as TorsionDesignMeta : null;\n\n  // Calculate scale factor for visualization\n  const scale = useMemo(() => {\n    if (!torsionDesign) return 1;\n    const maxDim = Math.max(\n      torsionDesign.meanDiameter * 1.5, \n      torsionDesign.bodyLength,\n      torsionDesign.legLength1,\n      torsionDesign.legLength2\n    );\n    return 50 / maxDim; // Normalize to ~50 units\n  }, [torsionDesign]);\n\n  // Build complete spring geometry\n  // Create materials - MUST be before any early returns to follow Rules of Hooks\n  const bodyMaterial = useMemo(() => {\n    return new THREE.MeshStandardMaterial({\n      // Use white base color when vertexColors is enabled so FEA colors show clearly\n      color: isFeaMode ? 0xffffff : BODY_COLOR,\n      metalness: isFeaMode ? previewTheme.material.fea.metalness : previewTheme.material.spring.metalness,\n      roughness: isFeaMode ? previewTheme.material.fea.roughness : previewTheme.material.spring.roughness,\n      side: THREE.DoubleSide,\n      vertexColors: isFeaMode,\n    });\n  }, [isFeaMode]);\n\n  const legMaterial = useMemo(() => {\n    return new THREE.MeshStandardMaterial({\n      color: LEG_COLOR,\n      metalness: previewTheme.material.endCap.metalness,\n      roughness: previewTheme.material.endCap.roughness,\n      side: THREE.DoubleSide,\n    });\n  }, []);\n\n  const springGeometry = useMemo(() => {\n    if (!torsionDesign) return null;\n\n    const {\n      wireDiameter,\n      meanDiameter,\n      activeCoils,\n      bodyLength,\n      pitch,\n      legLength1,\n      legLength2,\n      freeAngle,\n      windingDirection,\n    } = torsionDesign;\n\n    // Use pitch from design, or default to wire diameter (close-wound)\n    const effectivePitch = pitch || wireDiameter;\n\n    const params: TorsionSpringParams = {\n      wireDiameter,\n      meanDiameter,\n      activeCoils,\n      bodyLength,\n      pitch: effectivePitch,\n      legLength1,\n      legLength2,\n      freeAngle,\n      workingAngle: currentDeflection, // Deflection is working angle in degrees\n      windingDirection: windingDirection || \"right\",\n      scale,\n      legType: \"straight\",\n    };\n\n    return buildTorsionSpringGeometry(params);\n  }, [torsionDesign, currentDeflection, scale]);\n\n  // Apply FEA colors to geometry when in FEA mode\n  useEffect(() => {\n    if (!springGeometry?.bodyGeometry) return;\n    \n    if (isFeaMode && feaResult) {\n      applyFeaColors(springGeometry.bodyGeometry, {\n        mode: colorMode,\n        feaResult,\n      });\n    }\n  }, [springGeometry, isFeaMode, feaResult, colorMode]);\n\n  if (!springGeometry || !torsionDesign) {\n    return null;\n  }\n\n  const { bodyGeometry, leg1Geometry, leg2Geometry, state } = springGeometry;\n\n  return (\n    <group rotation={[Math.PI / 2, 0, 0]}>\n      {/* Main spring body - key forces re-render when FEA mode changes */}\n      <mesh key={`spring-${isFeaMode}-${colorMode}`} geometry={bodyGeometry} material={bodyMaterial} />\n      \n      {/* Leg 1 */}\n      {leg1Geometry && (\n        <mesh geometry={leg1Geometry} material={legMaterial} />\n      )}\n      \n      {/* Leg 2 */}\n      {leg2Geometry && (\n        <mesh geometry={leg2Geometry} material={legMaterial} />\n      )}\n      \n      {/* Center axis indicator */}\n      <mesh position={[0, 0, torsionDesign.bodyLength * scale / 2]}>\n        <cylinderGeometry args={[0.5, 0.5, torsionDesign.bodyLength * scale * 1.2, 16]} />\n        <meshStandardMaterial \n          color=\"#475569\" \n          transparent \n          opacity={0.3}\n        />\n      </mesh>\n\n      {/* Max stress marker - only in FEA mode */}\n      {isFeaMode && feaResult && feaResult.nodes.length > 0 && (\n        <TorsionMaxStressMarker \n          feaResult={feaResult} \n          colorMode={colorMode} \n          scale={scale} \n        />\n      )}\n    </group>\n  );\n}\n\n/**\n * Marker showing the location of maximum stress or displacement\n */\nfunction TorsionMaxStressMarker({ \n  feaResult, \n  colorMode, \n  scale \n}: { \n  feaResult: NonNullable<ReturnType<typeof useFeaStore.getState>[\"feaResult\"]>;\n  colorMode: string;\n  scale: number;\n}) {\n  const nodes = feaResult.nodes;\n  \n  const markerData = useMemo(() => {\n    let nodeIndex: number;\n    let value: number;\n    let label: string;\n    let unit: string;\n    let color: string;\n\n    switch (colorMode) {\n      case \"fea_sigma\":\n        nodeIndex = findMaxSigmaNodeIndex(nodes);\n        value = nodes[nodeIndex].sigma_vm;\n        label = \"σ_max\";\n        unit = \"MPa\";\n        color = \"#ff0000\";\n        break;\n      case \"fea_disp\":\n        nodeIndex = findMaxDispNodeIndex(nodes);\n        const node = nodes[nodeIndex];\n        value = Math.sqrt(node.ux ** 2 + node.uy ** 2 + node.uz ** 2);\n        label = \"u_max\";\n        unit = \"mm\";\n        color = \"#ff6600\";\n        break;\n      default:\n        nodeIndex = findMaxSigmaNodeIndex(nodes);\n        value = nodes[nodeIndex].sigma_vm;\n        label = \"σ_max\";\n        unit = \"MPa\";\n        color = \"#ff0000\";\n    }\n\n    const targetNode = nodes[nodeIndex];\n    return {\n      position: [targetNode.x * scale, targetNode.y * scale, targetNode.z * scale] as [number, number, number],\n      value,\n      label,\n      unit,\n      color,\n    };\n  }, [nodes, colorMode, scale]);\n\n  const sphereRadius = 1.5;\n\n  return (\n    <group position={markerData.position}>\n      <mesh>\n        <sphereGeometry args={[sphereRadius, 16, 16]} />\n        <meshStandardMaterial\n          color={markerData.color}\n          emissive={markerData.color}\n          emissiveIntensity={0.5}\n          transparent\n          opacity={0.9}\n        />\n      </mesh>\n      <Html position={[0, sphereRadius * 2, 0]} center style={{ pointerEvents: \"none\" }}>\n        <div className=\"px-2 py-1 rounded bg-black/80 text-white text-xs whitespace-nowrap\">\n          <span className=\"font-medium\">{markerData.label}</span>\n          {\" = \"}\n          <span className=\"font-mono\">{markerData.value.toFixed(1)}</span>\n          {markerData.unit && <span className=\"text-gray-300\"> {markerData.unit}</span>}\n        </div>\n      </Html>\n    </group>\n  );\n}\n\n/**\n * Complete torsion spring visualizer with Canvas and controls\n */\nexport function TorsionSpringVisualizer() {\n  const { design, currentDeflection, currentLoad, currentStiffness } = useSpringSimulationStore();\n  const torsionDesign = design?.type === \"torsion\" ? design as TorsionDesignMeta : null;\n  const controlsRef = useRef<any>(null);\n  const [currentView, setCurrentView] = useState<ViewType>(\"perspective\");\n\n  const handleViewChange = useCallback((view: ViewType) => {\n    setCurrentView(view);\n  }, []);\n\n  if (!torsionDesign) {\n    return (\n      <div className=\"h-full w-full flex items-center justify-center bg-slate-100 rounded-lg\">\n        <p className=\"text-sm text-muted-foreground\">暂无扭转弹簧数据</p>\n      </div>\n    );\n  }\n\n  // Calculate current angle\n  const currentAngle = torsionDesign.freeAngle - currentDeflection;\n\n  return (\n    <div className=\"relative h-full w-full\">\n      <Canvas\n        camera={{ position: [80, 60, 80], fov: 45 }}\n      >\n        <CameraController viewType={currentView} controlsRef={controlsRef} />\n\n        <color attach=\"background\" args={[previewTheme.background]} />\n        \n        <ambientLight intensity={previewTheme.lights.ambient} />\n        <directionalLight position={previewTheme.lights.key.position} intensity={previewTheme.lights.key.intensity} castShadow />\n        <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n        <pointLight position={previewTheme.lights.point.position} intensity={previewTheme.lights.point.intensity} />\n        \n        <AnimatedTorsionSpring />\n        \n        <OrbitControls \n          ref={controlsRef}\n          enablePan={true}\n          enableZoom={true}\n          enableRotate={true}\n          minDistance={30}\n          maxDistance={250}\n          target={[0, 0, 0]}\n        />\n        \n        {/* Ground grid */}\n        <gridHelper \n          args={[100, 20, previewTheme.grid.major, previewTheme.grid.minor]} \n          position={[0, -20, 0]} \n        />\n      </Canvas>\n\n      {/* View selector - bottom left */}\n      <div className=\"absolute bottom-2 left-2 flex gap-1\">\n        <Button\n          variant={currentView === \"perspective\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"perspective\")}\n          title=\"透视图 / Perspective\"\n        >\n          <RotateCcw className=\"h-3 w-3 mr-1\" />\n          3D\n        </Button>\n        <Button\n          variant={currentView === \"front\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"front\")}\n          title=\"前视图 / Front View\"\n        >\n          前\n        </Button>\n        <Button\n          variant={currentView === \"top\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"top\")}\n          title=\"俯视图 / Top View\"\n        >\n          顶\n        </Button>\n        <Button\n          variant={currentView === \"side\" ? \"default\" : \"secondary\"}\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs\"\n          onClick={() => handleViewChange(\"side\")}\n          title=\"侧视图 / Side View\"\n        >\n          侧\n        </Button>\n      </div>\n\n      {/* Legend overlay - top left */}\n      <div className=\"absolute top-2 left-2 rounded bg-white/90 px-2 py-1.5 text-xs shadow\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"h-3 w-3 rounded-full\" style={{ backgroundColor: BODY_COLOR }} />\n          <span>弹簧体</span>\n        </div>\n        <div className=\"flex items-center gap-2 mt-1\">\n          <div className=\"h-3 w-3 rounded-full\" style={{ backgroundColor: LEG_COLOR }} />\n          <span>弹簧脚</span>\n        </div>\n      </div>\n\n      {/* Status overlay */}\n      <div className=\"absolute top-2 right-2 rounded bg-white/90 px-2 py-1.5 text-xs shadow space-y-0.5\">\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">θ:</span>\n          <span className=\"font-medium\">{currentDeflection.toFixed(1)}°</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">M:</span>\n          <span className=\"font-medium\">{currentLoad.toFixed(2)} N·mm</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">角度:</span>\n          <span className=\"font-medium\">{currentAngle.toFixed(1)}°</span>\n        </div>\n        <div className=\"flex justify-between gap-4\">\n          <span className=\"text-slate-500\">k:</span>\n          <span className=\"font-medium\">{currentStiffness.toFixed(3)} N·mm/°</span>\n        </div>\n        <div className=\"border-t border-slate-200 pt-1 mt-1\">\n          <div className=\"flex justify-between gap-4\">\n            <span className=\"text-slate-500\">Na:</span>\n            <span className=\"font-medium\">{torsionDesign.activeCoils}</span>\n          </div>\n          <div className=\"flex justify-between gap-4\">\n            <span className=\"text-slate-500\">Dm:</span>\n            <span className=\"font-medium\">{torsionDesign.meanDiameter} mm</span>\n          </div>\n          <div className=\"flex justify-between gap-4\">\n            <span className=\"text-slate-500\">方向:</span>\n            <span className=\"font-medium\">\n              {torsionDesign.windingDirection === \"left\" ? \"左旋\" : \"右旋\"}\n            </span>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/VariablePitchCompressionSpringVisualizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2916,2919],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2916,2919],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: This value cannot be modified\n\nModifying a value returned from a hook is not allowed. Consider moving the modification into the hook where the value is constructed.\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/VariablePitchCompressionSpringVisualizer.tsx:105:5\n  103 |     // Put camera in a diagonal side-top view so pitch differences are visible.\n  104 |     camera.position.set(center.x + dist * 1.0, center.y + dist * 0.6, center.z + dist * 0.9);\n> 105 |     camera.near = Math.max(0.1, maxDim / 200);\n      |     ^^^^^^ `camera` cannot be modified\n  106 |     camera.far = Math.max(1000, maxDim * 50);\n  107 |     camera.updateProjectionMatrix();\n  108 |","line":105,"column":5,"nodeType":null,"endLine":105,"endColumn":11},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/VariablePitchCompressionSpringVisualizer.tsx:294:5\n  292 |\n  293 |   useEffect(() => {\n> 294 |     setMounted(true);\n      |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  295 |   }, []);\n  296 |\n  297 |   if (!mounted) return null;","line":294,"column":5,"nodeType":null,"endLine":294,"endColumn":15}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls } from \"@react-three/drei\";\nimport * as THREE from \"three\";\n\nimport { previewTheme } from \"@/lib/three/previewTheme\";\n\nimport type { VariablePitchSegment } from \"@/lib/springMath\";\nimport {\n  createVariablePitchCompressionSpringGeometry,\n} from \"@/lib/spring3d/variablePitchCompressionGeometry\";\n\nexport type VariablePitchCompressionSpringVisualizerProps = {\n  wireDiameter: number;\n  meanDiameter: number;\n  shearModulus: number;\n  activeCoils0: number;\n  totalCoils: number;\n  freeLength?: number;\n  segments: VariablePitchSegment[];\n  deflection: number;\n  autoRotate?: boolean;\n  showStressColors?: boolean;\n  stressUtilization?: number;\n  stressBeta?: number;\n};\n\nfunction lerp(a: number, b: number, t: number) {\n  return a + (b - a) * t;\n}\n\nfunction colorRampGyr(t: number): [number, number, number] {\n  const x = Math.max(0, Math.min(1, t));\n  if (x <= 0.5) {\n    const u = x / 0.5;\n    return [lerp(0.1, 1.0, u), lerp(0.8, 0.85, u), lerp(0.2, 0.05, u)];\n  }\n  const u = (x - 0.5) / 0.5;\n  return [lerp(1.0, 1.0, u), lerp(0.85, 0.15, u), lerp(0.05, 0.05, u)];\n}\n\nfunction mapUtilizationToRampT(utilization: number): number {\n  // Make the ramp more conservative so moderate utilization stays greener.\n  const u = Number.isFinite(utilization) ? Math.max(0, utilization) : 0;\n  const scaled = Math.max(0, Math.min(1, u / 1.25));\n  return Math.max(0, Math.min(1, Math.pow(scaled, 1.2)));\n}\n\nfunction applyStressColors(geometry: THREE.BufferGeometry, utilization: number, beta: number) {\n  const posAttr = geometry.getAttribute(\"position\") as THREE.BufferAttribute | undefined;\n  const normalAttr = geometry.getAttribute(\"normal\") as THREE.BufferAttribute | undefined;\n  if (!posAttr || !normalAttr) return;\n\n  const count = posAttr.count;\n  const colors = new Float32Array(count * 3);\n  const b = Math.max(0, Math.min(0.9, beta));\n  const u0 = mapUtilizationToRampT(utilization);\n\n  for (let i = 0; i < count; i++) {\n    const px = posAttr.getX(i);\n    const py = posAttr.getY(i);\n    const nx = normalAttr.getX(i);\n    const ny = normalAttr.getY(i);\n\n    const invLen = 1 / Math.max(1e-9, Math.hypot(px, py));\n    const dx = -px * invLen;\n    const dy = -py * invLen;\n\n    const nLen = 1 / Math.max(1e-9, Math.hypot(nx, ny));\n    const nnx = nx * nLen;\n    const nny = ny * nLen;\n\n    const dot = nnx * dx + nny * dy;\n    const factor = 1 + b * dot;\n    const t = Math.max(0, Math.min(1, u0 * factor));\n\n    const [r, g, bl] = colorRampGyr(t);\n    colors[i * 3 + 0] = r;\n    colors[i * 3 + 1] = g;\n    colors[i * 3 + 2] = bl;\n  }\n\n  geometry.setAttribute(\"color\", new THREE.BufferAttribute(colors, 3));\n}\n\nfunction FitToObject({ groupRef }: { groupRef: React.RefObject<THREE.Group | null> }) {\n  const { camera } = useThree();\n  const controlsRef = useRef<any>(null);\n\n  useEffect(() => {\n    const obj = groupRef.current;\n    if (!obj) return;\n\n    const box = new THREE.Box3().setFromObject(obj);\n    const size = box.getSize(new THREE.Vector3());\n    const center = box.getCenter(new THREE.Vector3());\n\n    const maxDim = Math.max(size.x, size.y, size.z);\n    const dist = maxDim * 2.2;\n\n    // Put camera in a diagonal side-top view so pitch differences are visible.\n    camera.position.set(center.x + dist * 1.0, center.y + dist * 0.6, center.z + dist * 0.9);\n    camera.near = Math.max(0.1, maxDim / 200);\n    camera.far = Math.max(1000, maxDim * 50);\n    camera.updateProjectionMatrix();\n\n    if (controlsRef.current) {\n      controlsRef.current.target.copy(center);\n      controlsRef.current.update();\n    }\n  }, [camera, groupRef]);\n\n  return (\n    <OrbitControls\n      ref={controlsRef}\n      makeDefault\n      enablePan={true}\n      enableZoom={true}\n      enableRotate={true}\n    />\n  );\n}\n\nfunction SpringMesh(props: VariablePitchCompressionSpringVisualizerProps) {\n  const groupRef = useRef<THREE.Group>(null);\n\n  const utilization = useMemo(() => {\n    const u = props.stressUtilization;\n    return Number.isFinite(u) ? Math.max(0, Math.min(2, u as number)) : 0;\n  }, [props.stressUtilization]);\n\n  const stressBeta = useMemo(() => {\n    const b = props.stressBeta;\n    return Number.isFinite(b) ? Math.max(0, Math.min(0.9, b as number)) : 0.25;\n  }, [props.stressBeta]);\n\n  const { geometry, zMin, zMax } = useMemo(() => {\n    const res = createVariablePitchCompressionSpringGeometry(\n      {\n        wireDiameter: props.wireDiameter,\n        meanDiameter: props.meanDiameter,\n        shearModulus: props.shearModulus,\n        activeCoils0: props.activeCoils0,\n        totalCoils: props.totalCoils,\n        freeLength: props.freeLength,\n        segments: props.segments,\n        deflection: props.deflection,\n      },\n      {\n        pointsPerTurn: 24,\n        radialSegments: 20,\n        tubeSegmentsPerTurn: 28,\n        closingTurns: 1.5,\n        contactGapRatio: 0.01,\n      }\n    );\n    if (props.showStressColors) {\n      applyStressColors(res.geometry, utilization, stressBeta);\n    }\n    return res;\n  }, [\n    props.wireDiameter,\n    props.meanDiameter,\n    props.shearModulus,\n    props.activeCoils0,\n    props.totalCoils,\n    props.freeLength,\n    props.segments,\n    props.deflection,\n    props.showStressColors,\n    utilization,\n    stressBeta,\n  ]);\n\n  useEffect(() => {\n    return () => {\n      geometry.dispose();\n    };\n  }, [geometry]);\n\n  const d = Math.max(0.01, props.wireDiameter);\n  const zBottom = zMin + d * 0.5;\n  const zTop = zMax - d * 0.5;\n\n  const clippingPlanes = useMemo(() => {\n    const bottom = new THREE.Plane().setFromNormalAndCoplanarPoint(\n      new THREE.Vector3(0, 0, 1),\n      new THREE.Vector3(0, 0, zBottom)\n    );\n    const top = new THREE.Plane().setFromNormalAndCoplanarPoint(\n      new THREE.Vector3(0, 0, -1),\n      new THREE.Vector3(0, 0, zTop)\n    );\n    return [bottom, top];\n  }, [zBottom, zTop]);\n\n  const material = useMemo(() => {\n    if (props.showStressColors) {\n      return new THREE.MeshBasicMaterial({\n        color: \"#ffffff\",\n        side: THREE.DoubleSide,\n        vertexColors: true,\n        clippingPlanes,\n      });\n    }\n    return new THREE.MeshStandardMaterial({\n      color: \"#6b9bd1\",\n      metalness: previewTheme.material.spring.metalness,\n      roughness: previewTheme.material.spring.roughness,\n      side: THREE.DoubleSide,\n      clippingPlanes,\n    });\n  }, [clippingPlanes, props.showStressColors]);\n\n  useEffect(() => {\n    return () => {\n      material.dispose();\n    };\n  }, [material]);\n\n  const capMaterial = useMemo(() => {\n    if (props.showStressColors) {\n      const [r, g, bl] = colorRampGyr(mapUtilizationToRampT(utilization));\n      return new THREE.MeshBasicMaterial({\n        color: new THREE.Color(r, g, bl),\n        side: THREE.DoubleSide,\n        polygonOffset: true,\n        polygonOffsetFactor: -1,\n        polygonOffsetUnits: -1,\n      });\n    }\n\n    return new THREE.MeshStandardMaterial({\n      color: \"#6b9bd1\",\n      metalness: previewTheme.material.endCap.metalness,\n      roughness: previewTheme.material.endCap.roughness,\n      side: THREE.DoubleSide,\n      polygonOffset: true,\n      polygonOffsetFactor: -1,\n      polygonOffsetUnits: -1,\n    });\n  }, [props.showStressColors, utilization]);\n\n  const capGeom = useMemo(() => {\n    const R = props.meanDiameter / 2;\n    const rInner = Math.max(0.01, R - props.wireDiameter / 2);\n    const rOuter = Math.max(rInner + 0.01, R + props.wireDiameter / 2);\n    return new THREE.RingGeometry(rInner, rOuter, 96, 1);\n  }, [props.meanDiameter, props.wireDiameter]);\n\n  useEffect(() => {\n    return () => {\n      capGeom.dispose();\n      capMaterial.dispose();\n    };\n  }, [capGeom, capMaterial]);\n\n  const capEps = Math.max(0.001, d * 0.002);\n  const bottomCapZ = zBottom + capEps;\n  const topCapZ = zTop - capEps;\n\n  return (\n    <>\n      <group ref={groupRef} rotation={[0, 0, 0]}>\n        <mesh geometry={geometry} material={material} castShadow receiveShadow />\n        <mesh\n          geometry={capGeom}\n          material={capMaterial}\n          position={[0, 0, bottomCapZ]}\n          rotation={[0, 0, 0]}\n          receiveShadow\n        />\n        <mesh\n          geometry={capGeom}\n          material={capMaterial}\n          position={[0, 0, topCapZ]}\n          rotation={[Math.PI, 0, 0]}\n          receiveShadow\n        />\n      </group>\n      <FitToObject groupRef={groupRef} />\n    </>\n  );\n}\n\nexport function VariablePitchCompressionSpringVisualizer(\n  props: VariablePitchCompressionSpringVisualizerProps\n) {\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  if (!mounted) return null;\n\n  return (\n    <Canvas\n      camera={{ fov: 45, near: 0.1, far: 5000 }}\n      style={{ width: \"100%\", height: \"100%\" }}\n      gl={{ localClippingEnabled: true, antialias: true }}\n    >\n      <color attach=\"background\" args={[previewTheme.background]} />\n\n      <ambientLight intensity={previewTheme.lights.ambient} />\n      <directionalLight position={previewTheme.lights.key.position} intensity={previewTheme.lights.key.intensity} castShadow />\n      <directionalLight position={previewTheme.lights.fill.position} intensity={previewTheme.lights.fill.intensity} />\n      <pointLight position={previewTheme.lights.point.position} intensity={previewTheme.lights.point.intensity} />\n\n      <SpringMesh {...props} />\n\n      <gridHelper args={[80, 16, previewTheme.grid.major, previewTheme.grid.minor]} position={[0, 0, 0]} rotation={[0, 0, 0]} />\n    </Canvas>\n  );\n}\n\nexport default VariablePitchCompressionSpringVisualizer;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/WaveSpringMesh.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/WaveSpringVisualizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":51,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1451,1454],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1451,1454],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":135,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3824,3827],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3824,3827],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Wave Spring 3D Visualizer\n * 波形弹簧 3D 可视化组件\n * \n * 白背景主题，与其他弹簧可视化组件风格一致\n */\n\n\"use client\";\n\nimport React, { useMemo, useRef, useEffect } from \"react\";\nimport { Canvas, useThree } from \"@react-three/fiber\";\nimport { OrbitControls, Grid } from \"@react-three/drei\";\nimport * as THREE from \"three\";\nimport { previewTheme } from \"@/lib/three/previewTheme\";\nimport { WaveSpringMesh } from \"./WaveSpringMesh\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface WaveSpringVisualizerProps {\n  /** Mean diameter Dm (mm) */\n  meanDiameter: number;\n  /** Strip thickness t (mm) - radial direction */\n  thickness: number;\n  /** Strip width b (mm) - axial direction */\n  width: number;\n  /** Wave amplitude A (mm) - half of peak-to-valley */\n  amplitude: number;\n  /** Number of waves per turn */\n  waves: number;\n  /** Number of turns (V1: typically 1) */\n  turns?: number;\n  /** Phase offset (radians) */\n  phase?: number;\n  /** Spring color */\n  color?: string;\n  /** Container className */\n  className?: string;\n}\n\n// ============================================================================\n// Camera Controller\n// ============================================================================\n\nfunction CameraController({ \n  meanDiameter,\n  controlsRef \n}: { \n  meanDiameter: number;\n  controlsRef: React.RefObject<any>;\n}) {\n  const { camera } = useThree();\n  \n  useEffect(() => {\n    // Position camera based on spring size\n    const distance = meanDiameter * 2.5;\n    camera.position.set(distance * 0.8, distance * 0.5, distance * 0.8);\n    camera.lookAt(0, 0, 0);\n    camera.updateProjectionMatrix();\n    \n    if (controlsRef.current) {\n      controlsRef.current.target.set(0, 0, 0);\n      controlsRef.current.update();\n    }\n  }, [meanDiameter, camera, controlsRef]);\n  \n  return null;\n}\n\n// ============================================================================\n// Scene Lighting\n// ============================================================================\n\nfunction SceneLighting() {\n  return (\n    <>\n      <ambientLight intensity={previewTheme.lights.ambient} />\n      <directionalLight\n        position={previewTheme.lights.key.position as unknown as THREE.Vector3Tuple}\n        intensity={previewTheme.lights.key.intensity}\n        castShadow\n      />\n      <directionalLight\n        position={previewTheme.lights.fill.position as unknown as THREE.Vector3Tuple}\n        intensity={previewTheme.lights.fill.intensity}\n      />\n      <pointLight\n        position={previewTheme.lights.point.position as unknown as THREE.Vector3Tuple}\n        intensity={previewTheme.lights.point.intensity}\n      />\n    </>\n  );\n}\n\n// ============================================================================\n// Scene Grid\n// ============================================================================\n\nfunction SceneGrid({ size }: { size: number }) {\n  return (\n    <Grid\n      args={[size * 2, size * 2]}\n      cellSize={size / 10}\n      cellThickness={0.5}\n      cellColor={previewTheme.grid.minor}\n      sectionSize={size / 2}\n      sectionThickness={1}\n      sectionColor={previewTheme.grid.major}\n      fadeDistance={size * 3}\n      fadeStrength={1}\n      followCamera={false}\n      infiniteGrid={false}\n      position={[0, 0, -5]}\n      rotation={[0, 0, 0]}\n    />\n  );\n}\n\n// ============================================================================\n// Main Component\n// ============================================================================\n\nexport function WaveSpringVisualizer({\n  meanDiameter,\n  thickness,\n  width,\n  amplitude,\n  waves,\n  turns = 1,\n  phase = 0,\n  color = \"#6b9bd1\",\n  className = \"\",\n}: WaveSpringVisualizerProps) {\n  const controlsRef = useRef<any>(null);\n\n  // Calculate scale for visualization\n  const scale = useMemo(() => {\n    const maxDim = Math.max(meanDiameter * 1.5, amplitude * 4);\n    return 30 / maxDim; // Normalize to ~30 units\n  }, [meanDiameter, amplitude]);\n\n  const gridSize = meanDiameter * 1.5;\n\n  return (\n    <div className={`w-full h-full min-h-[300px] ${className}`}>\n      <Canvas\n        camera={{\n          fov: 45,\n          near: 0.1,\n          far: 1000,\n          position: [50, 30, 50],\n        }}\n        gl={{ antialias: true, alpha: false }}\n        style={{ background: previewTheme.background }}\n      >\n        {/* Background color */}\n        <color attach=\"background\" args={[previewTheme.background]} />\n\n        {/* Camera controller */}\n        <CameraController \n          meanDiameter={meanDiameter} \n          controlsRef={controlsRef} \n        />\n\n        {/* Lighting */}\n        <SceneLighting />\n\n        {/* Grid */}\n        <SceneGrid size={gridSize} />\n\n        {/* Wave Spring Mesh */}\n        <WaveSpringMesh\n          meanDiameter={meanDiameter}\n          thickness={thickness}\n          width={width}\n          amplitude={amplitude}\n          waves={waves}\n          turns={turns}\n          phase={phase}\n          color={color}\n          scale={scale}\n          showEdges={true}\n        />\n\n        {/* Orbit Controls */}\n        <OrbitControls\n          ref={controlsRef}\n          enablePan={true}\n          enableZoom={true}\n          enableRotate={true}\n          minDistance={10}\n          maxDistance={200}\n          target={[0, 0, 0]}\n        />\n      </Canvas>\n    </div>\n  );\n}\n\nexport default WaveSpringVisualizer;\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/three/WireFeed.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/components/ui/textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/arcSpring/advanced.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArcSpringResult' is defined but never used.","line":10,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":46},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'material' is assigned a value but never used.","line":363,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":363,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Arc Spring Advanced Analysis Module\n * 弧形弹簧高级分析模块\n * \n * P1: Manufacturability check, Fatigue life prediction, Scoring system\n * P2: Natural frequency, Temperature effects, Centrifugal force (DMF)\n * P3: Creep/relaxation analysis\n */\n\nimport type { ArcSpringInput, ArcSpringResult } from \"./types\";\nimport { ARC_SPRING_MATERIALS } from \"./materials\";\n\nconst PI = Math.PI;\n\n// ============================================================================\n// P1: Manufacturability Check\n// ============================================================================\n\nexport interface ArcManufacturabilityIssue {\n  code: string;\n  severity: \"critical\" | \"major\" | \"minor\" | \"info\";\n  description: string;\n  descriptionZh: string;\n  parameter: string;\n  currentValue: number | string;\n  requiredValue: string;\n  suggestion: string;\n  suggestionZh: string;\n}\n\nexport interface ArcManufacturabilityResult {\n  isManufacturable: boolean;\n  difficultyScore: number;\n  issues: ArcManufacturabilityIssue[];\n  criticalCount: number;\n  majorCount: number;\n  minorCount: number;\n  recommendedProcess: string;\n  wireLengthMm: number;\n  coilPitchFree: number;\n  coilPitchWork: number;\n  summary: string;\n  summaryZh: string;\n}\n\nconst ARC_MANUFACTURING_LIMITS = {\n  minWireDiameter: 0.5,      // mm\n  maxWireDiameter: 12.0,     // mm\n  minSpringIndex: 4,         // D/d\n  maxSpringIndex: 16,        // D/d\n  optimalSpringIndexMin: 6,\n  optimalSpringIndexMax: 12,\n  minActiveCoils: 2,\n  maxActiveCoils: 25,\n  minWorkingAngle: 5,        // deg\n  maxWireLength: 5000,       // mm\n  minPitchToWireRatio: 1.1,  // pitch/d at work position\n};\n\nfunction checkWireDiameter(d: number): ArcManufacturabilityIssue | null {\n  if (d < ARC_MANUFACTURING_LIMITS.minWireDiameter) {\n    return {\n      code: \"WIRE_TOO_THIN\",\n      severity: \"critical\",\n      description: `Wire diameter ${d}mm is below minimum ${ARC_MANUFACTURING_LIMITS.minWireDiameter}mm`,\n      descriptionZh: `线径 ${d}mm 低于最小值 ${ARC_MANUFACTURING_LIMITS.minWireDiameter}mm`,\n      parameter: \"d\",\n      currentValue: d,\n      requiredValue: `≥ ${ARC_MANUFACTURING_LIMITS.minWireDiameter} mm`,\n      suggestion: \"Increase wire diameter\",\n      suggestionZh: \"增加线径\",\n    };\n  }\n  if (d > ARC_MANUFACTURING_LIMITS.maxWireDiameter) {\n    return {\n      code: \"WIRE_TOO_THICK\",\n      severity: \"critical\",\n      description: `Wire diameter ${d}mm exceeds maximum ${ARC_MANUFACTURING_LIMITS.maxWireDiameter}mm`,\n      descriptionZh: `线径 ${d}mm 超过最大值 ${ARC_MANUFACTURING_LIMITS.maxWireDiameter}mm`,\n      parameter: \"d\",\n      currentValue: d,\n      requiredValue: `≤ ${ARC_MANUFACTURING_LIMITS.maxWireDiameter} mm`,\n      suggestion: \"Reduce wire diameter or use specialized equipment\",\n      suggestionZh: \"减小线径或使用专用设备\",\n    };\n  }\n  return null;\n}\n\nfunction checkSpringIndex(D: number, d: number): ArcManufacturabilityIssue | null {\n  const C = D / d;\n  \n  if (C < ARC_MANUFACTURING_LIMITS.minSpringIndex) {\n    return {\n      code: \"SPRING_INDEX_TOO_LOW\",\n      severity: \"critical\",\n      description: `Spring index C=${C.toFixed(1)} is too low (< ${ARC_MANUFACTURING_LIMITS.minSpringIndex})`,\n      descriptionZh: `弹簧指数 C=${C.toFixed(1)} 过低 (< ${ARC_MANUFACTURING_LIMITS.minSpringIndex})`,\n      parameter: \"D/d\",\n      currentValue: C.toFixed(2),\n      requiredValue: `≥ ${ARC_MANUFACTURING_LIMITS.minSpringIndex}`,\n      suggestion: \"Increase mean diameter D or reduce wire diameter d\",\n      suggestionZh: \"增加中径 D 或减小线径 d\",\n    };\n  }\n  \n  if (C > ARC_MANUFACTURING_LIMITS.maxSpringIndex) {\n    return {\n      code: \"SPRING_INDEX_TOO_HIGH\",\n      severity: \"major\",\n      description: `Spring index C=${C.toFixed(1)} is high (> ${ARC_MANUFACTURING_LIMITS.maxSpringIndex})`,\n      descriptionZh: `弹簧指数 C=${C.toFixed(1)} 偏高 (> ${ARC_MANUFACTURING_LIMITS.maxSpringIndex})`,\n      parameter: \"D/d\",\n      currentValue: C.toFixed(2),\n      requiredValue: `≤ ${ARC_MANUFACTURING_LIMITS.maxSpringIndex}`,\n      suggestion: \"Reduce mean diameter D or increase wire diameter d\",\n      suggestionZh: \"减小中径 D 或增加线径 d\",\n    };\n  }\n  \n  if (C < ARC_MANUFACTURING_LIMITS.optimalSpringIndexMin || \n      C > ARC_MANUFACTURING_LIMITS.optimalSpringIndexMax) {\n    return {\n      code: \"SPRING_INDEX_SUBOPTIMAL\",\n      severity: \"minor\",\n      description: `Spring index C=${C.toFixed(1)} outside optimal range (${ARC_MANUFACTURING_LIMITS.optimalSpringIndexMin}-${ARC_MANUFACTURING_LIMITS.optimalSpringIndexMax})`,\n      descriptionZh: `弹簧指数 C=${C.toFixed(1)} 在最优范围外 (${ARC_MANUFACTURING_LIMITS.optimalSpringIndexMin}-${ARC_MANUFACTURING_LIMITS.optimalSpringIndexMax})`,\n      parameter: \"D/d\",\n      currentValue: C.toFixed(2),\n      requiredValue: `${ARC_MANUFACTURING_LIMITS.optimalSpringIndexMin} - ${ARC_MANUFACTURING_LIMITS.optimalSpringIndexMax}`,\n      suggestion: \"Adjust D/d ratio for optimal manufacturability\",\n      suggestionZh: \"调整 D/d 比例以获得最佳可制造性\",\n    };\n  }\n  \n  return null;\n}\n\nfunction checkActiveCoils(n: number): ArcManufacturabilityIssue | null {\n  if (n < ARC_MANUFACTURING_LIMITS.minActiveCoils) {\n    return {\n      code: \"TOO_FEW_COILS\",\n      severity: \"major\",\n      description: `Active coils n=${n} is below minimum ${ARC_MANUFACTURING_LIMITS.minActiveCoils}`,\n      descriptionZh: `有效圈数 n=${n} 低于最小值 ${ARC_MANUFACTURING_LIMITS.minActiveCoils}`,\n      parameter: \"n\",\n      currentValue: n,\n      requiredValue: `≥ ${ARC_MANUFACTURING_LIMITS.minActiveCoils}`,\n      suggestion: \"Increase number of active coils\",\n      suggestionZh: \"增加有效圈数\",\n    };\n  }\n  if (n > ARC_MANUFACTURING_LIMITS.maxActiveCoils) {\n    return {\n      code: \"MANY_COILS\",\n      severity: \"minor\",\n      description: `Active coils n=${n} is high - may require special handling`,\n      descriptionZh: `有效圈数 n=${n} 较多 - 可能需要特殊处理`,\n      parameter: \"n\",\n      currentValue: n,\n      requiredValue: `≤ ${ARC_MANUFACTURING_LIMITS.maxActiveCoils}`,\n      suggestion: \"Consider design optimization to reduce coil count\",\n      suggestionZh: \"考虑优化设计以减少圈数\",\n    };\n  }\n  return null;\n}\n\nfunction checkWorkingAngle(alpha0: number, alphaC: number): ArcManufacturabilityIssue | null {\n  const deltaMax = alpha0 - alphaC;\n  if (deltaMax < ARC_MANUFACTURING_LIMITS.minWorkingAngle) {\n    return {\n      code: \"WORKING_ANGLE_TOO_SMALL\",\n      severity: \"major\",\n      description: `Working angle range ${deltaMax.toFixed(1)}° is too small`,\n      descriptionZh: `工作角度范围 ${deltaMax.toFixed(1)}° 过小`,\n      parameter: \"alpha0-alphaC\",\n      currentValue: deltaMax.toFixed(1),\n      requiredValue: `≥ ${ARC_MANUFACTURING_LIMITS.minWorkingAngle}°`,\n      suggestion: \"Increase free angle or reduce coil bind angle\",\n      suggestionZh: \"增加自由角或减小压并角\",\n    };\n  }\n  return null;\n}\n\nfunction checkWireLength(wireLengthMm: number): ArcManufacturabilityIssue | null {\n  if (wireLengthMm > ARC_MANUFACTURING_LIMITS.maxWireLength) {\n    return {\n      code: \"WIRE_LENGTH_EXCESSIVE\",\n      severity: \"minor\",\n      description: `Wire length ${wireLengthMm.toFixed(0)}mm is very long - material handling challenges`,\n      descriptionZh: `线长 ${wireLengthMm.toFixed(0)}mm 过长 - 材料处理困难`,\n      parameter: \"wireLength\",\n      currentValue: wireLengthMm.toFixed(0),\n      requiredValue: `≤ ${ARC_MANUFACTURING_LIMITS.maxWireLength} mm`,\n      suggestion: \"Consider design optimization to reduce wire length\",\n      suggestionZh: \"考虑优化设计以减少线长\",\n    };\n  }\n  return null;\n}\n\nfunction checkCoilPitch(pitchWork: number, d: number): ArcManufacturabilityIssue | null {\n  const ratio = pitchWork / d;\n  if (ratio < ARC_MANUFACTURING_LIMITS.minPitchToWireRatio) {\n    return {\n      code: \"PITCH_TOO_TIGHT\",\n      severity: \"major\",\n      description: `Coil pitch at work position is too tight (p/d=${ratio.toFixed(2)})`,\n      descriptionZh: `工作位置圈距过紧 (p/d=${ratio.toFixed(2)})`,\n      parameter: \"pitch/d\",\n      currentValue: ratio.toFixed(2),\n      requiredValue: `≥ ${ARC_MANUFACTURING_LIMITS.minPitchToWireRatio}`,\n      suggestion: \"Increase arc angle or reduce coil count\",\n      suggestionZh: \"增加弧角或减少圈数\",\n    };\n  }\n  return null;\n}\n\nfunction calculateArcDifficultyScore(input: ArcSpringInput, wireLengthMm: number): number {\n  let score = 0;\n  const C = input.D / input.d;\n  \n  // Wire diameter difficulty\n  if (input.d < 1.0) score += 20;\n  else if (input.d < 2.0) score += 10;\n  else if (input.d > 8.0) score += 15;\n  \n  // Spring index difficulty\n  if (C < 5 || C > 14) score += 15;\n  else if (C < 6 || C > 12) score += 5;\n  \n  // Coil count difficulty\n  if (input.n > 15) score += 10;\n  else if (input.n > 10) score += 5;\n  \n  // Wire length difficulty\n  if (wireLengthMm > 3000) score += 15;\n  else if (wireLengthMm > 2000) score += 5;\n  \n  // Arc layout difficulty\n  if (input.alpha0 > 120) score += 10;\n  if ((input.countParallel ?? 1) > 4) score += 10;\n  \n  return Math.min(100, score);\n}\n\nexport function checkArcManufacturability(input: ArcSpringInput): ArcManufacturabilityResult {\n  const issues: ArcManufacturabilityIssue[] = [];\n  \n  // Calculate derived values\n  const deg2rad = (deg: number) => (deg * PI) / 180;\n  const nTotal = input.n + 2; // Assume 2 dead coils\n  const alpha0Rad = deg2rad(input.alpha0);\n  const alphaCRad = deg2rad(input.alphaC);\n  const lFree = input.r * alpha0Rad;\n  const lWork = input.r * alphaCRad;\n  const coilPitchFree = nTotal > 0 ? lFree / nTotal : 0;\n  const coilPitchWork = nTotal > 0 ? lWork / nTotal : 0;\n  const perTurn = Math.sqrt(Math.pow(PI * input.D, 2) + Math.pow(coilPitchFree, 2));\n  const wireLengthMm = perTurn * nTotal;\n  \n  // Run checks\n  const wireCheck = checkWireDiameter(input.d);\n  if (wireCheck) issues.push(wireCheck);\n  \n  const indexCheck = checkSpringIndex(input.D, input.d);\n  if (indexCheck) issues.push(indexCheck);\n  \n  const coilCheck = checkActiveCoils(input.n);\n  if (coilCheck) issues.push(coilCheck);\n  \n  const angleCheck = checkWorkingAngle(input.alpha0, input.alphaC);\n  if (angleCheck) issues.push(angleCheck);\n  \n  const lengthCheck = checkWireLength(wireLengthMm);\n  if (lengthCheck) issues.push(lengthCheck);\n  \n  const pitchCheck = checkCoilPitch(coilPitchWork, input.d);\n  if (pitchCheck) issues.push(pitchCheck);\n  \n  const criticalCount = issues.filter(i => i.severity === \"critical\").length;\n  const majorCount = issues.filter(i => i.severity === \"major\").length;\n  const minorCount = issues.filter(i => i.severity === \"minor\").length;\n  \n  const isManufacturable = criticalCount === 0;\n  const difficultyScore = calculateArcDifficultyScore(input, wireLengthMm);\n  \n  const recommendedProcess = input.d > 6 \n    ? \"Hot coiling with heat treatment\"\n    : input.d < 1.5 \n      ? \"Precision cold coiling\"\n      : \"Standard CNC cold coiling\";\n  \n  let summary: string;\n  let summaryZh: string;\n  \n  if (!isManufacturable) {\n    summary = `NOT MANUFACTURABLE: ${criticalCount} critical issue(s)`;\n    summaryZh = `不可制造：${criticalCount} 个严重问题`;\n  } else if (majorCount > 0) {\n    summary = `Manufacturable with ${majorCount} major concern(s). Difficulty: ${difficultyScore}/100`;\n    summaryZh = `可制造，有 ${majorCount} 个主要问题。难度：${difficultyScore}/100`;\n  } else if (minorCount > 0) {\n    summary = `Manufacturable with ${minorCount} minor note(s). Difficulty: ${difficultyScore}/100`;\n    summaryZh = `可制造，有 ${minorCount} 个次要问题。难度：${difficultyScore}/100`;\n  } else {\n    summary = `Fully manufacturable. Difficulty: ${difficultyScore}/100`;\n    summaryZh = `完全可制造。难度：${difficultyScore}/100`;\n  }\n  \n  return {\n    isManufacturable,\n    difficultyScore,\n    issues,\n    criticalCount,\n    majorCount,\n    minorCount,\n    recommendedProcess,\n    wireLengthMm,\n    coilPitchFree,\n    coilPitchWork,\n    summary,\n    summaryZh,\n  };\n}\n\n// ============================================================================\n// P1: Fatigue Life Prediction\n// ============================================================================\n\nexport interface ArcFatigueLifeResult {\n  estimatedCycles: number;\n  rating: \"infinite\" | \"high\" | \"medium\" | \"low\" | \"very_low\";\n  message: { en: string; zh: string };\n  tauA: number;           // Shear stress amplitude (MPa)\n  tauM: number;           // Mean shear stress (MPa)\n  tauMax: number;         // Max shear stress (MPa)\n  tauMin: number;         // Min shear stress (MPa)\n  Se: number | null;      // Endurance limit (MPa)\n  Su: number | null;      // Ultimate strength (MPa)\n  goodmanFoS: number | null;\n  gerberFoS: number | null;\n  snCurveData: Array<{ cycles: number; stress: number }>;\n}\n\nexport function calculateArcFatigueLife(params: {\n  tauMax_MPa: number;\n  tauMin_MPa?: number;\n  materialKey?: string;\n  Su_MPa?: number;\n  Se_MPa?: number;\n}): ArcFatigueLifeResult {\n  const tauMax = params.tauMax_MPa;\n  const tauMin = params.tauMin_MPa ?? 0;\n  \n  const tauA = (tauMax - tauMin) / 2;\n  const tauM = (tauMax + tauMin) / 2;\n  \n  // Get material properties\n  const material = ARC_SPRING_MATERIALS.find(m => m.key === params.materialKey);\n  \n  // Estimate Su from material or use provided value\n  // For spring steels: Su ≈ 1500-2000 MPa typically\n  const Su = params.Su_MPa ?? 1700;\n  \n  // Endurance limit for shear: Se ≈ 0.29 × Su (for torsion/shear)\n  const SePrime = params.Se_MPa ?? 0.29 * Su;\n  \n  // Apply Goodman correction for mean stress\n  const Se = SePrime / (1 + tauM / (0.577 * Su)); // Convert to shear\n  \n  // Goodman criterion: tauA/Se + tauM/(0.577*Su) = 1/FoS\n  const goodmanDen = tauA / Se + tauM / (0.577 * Su);\n  const goodmanFoS = goodmanDen > 0 ? 1 / goodmanDen : null;\n  \n  // Gerber criterion: tauA/Se + (tauM/(0.577*Su))² = 1/FoS\n  const gerberDen = tauA / Se + Math.pow(tauM / (0.577 * Su), 2);\n  const gerberFoS = gerberDen > 0 ? 1 / gerberDen : null;\n  \n  // Basquin equation for fatigue life\n  // S = A × N^(-b), typical b ≈ 0.1 for spring steels\n  let estimatedCycles = Infinity;\n  \n  if (Su && Se && Se > 0) {\n    const N1 = 1e3;\n    const N2 = 1e6;\n    const S1 = 0.9 * 0.577 * Su; // 90% of shear ultimate at 1e3 cycles\n    const S2 = Se;\n    \n    const b = Math.log(S1 / S2) / Math.log(N2 / N1);\n    const A = S1 * Math.pow(N1, b);\n    \n    // Effective stress amplitude with mean stress correction\n    const tauAEffective = tauA / (1 - tauM / (0.577 * Su));\n    \n    if (tauAEffective <= 0) {\n      estimatedCycles = Infinity;\n    } else if (tauAEffective >= S1) {\n      estimatedCycles = Math.max(100, Math.pow(A / tauAEffective, 1 / b));\n    } else if (tauAEffective <= S2) {\n      estimatedCycles = Infinity;\n    } else {\n      estimatedCycles = Math.pow(A / tauAEffective, 1 / b);\n    }\n  }\n  \n  // Generate S-N curve data\n  const snCurveData: Array<{ cycles: number; stress: number }> = [];\n  if (Su && Se) {\n    const S1 = 0.9 * 0.577 * Su;\n    const S2 = Se;\n    const b = Math.log(S1 / S2) / Math.log(1e6 / 1e3);\n    const A = S1 * Math.pow(1e3, b);\n    \n    for (let i = 0; i < 50; i++) {\n      const logN = 3 + (i / 49) * 5;\n      const N = Math.pow(10, logN);\n      const S = A * Math.pow(N, -b);\n      snCurveData.push({ cycles: N, stress: S });\n    }\n  }\n  \n  // Determine rating\n  let rating: ArcFatigueLifeResult[\"rating\"];\n  let message: { en: string; zh: string };\n  \n  if (!isFinite(estimatedCycles) || estimatedCycles >= 1e7) {\n    rating = \"infinite\";\n    message = { en: \"Infinite Life (N ≥ 10⁷)\", zh: \"无限寿命 (N ≥ 10⁷)\" };\n  } else if (estimatedCycles >= 1e6) {\n    rating = \"high\";\n    message = { en: \"High Cycle (10⁶ ≤ N < 10⁷)\", zh: \"高周疲劳 (10⁶ ≤ N < 10⁷)\" };\n  } else if (estimatedCycles >= 1e5) {\n    rating = \"medium\";\n    message = { en: \"Medium Cycle (10⁵ ≤ N < 10⁶)\", zh: \"中周疲劳 (10⁵ ≤ N < 10⁶)\" };\n  } else if (estimatedCycles >= 1e4) {\n    rating = \"low\";\n    message = { en: \"Low Cycle (10⁴ ≤ N < 10⁵)\", zh: \"低周疲劳 (10⁴ ≤ N < 10⁵)\" };\n  } else {\n    rating = \"very_low\";\n    message = { en: \"Very Low Cycle (N < 10⁴)\", zh: \"极低周疲劳 (N < 10⁴)\" };\n  }\n  \n  return {\n    estimatedCycles: isFinite(estimatedCycles) ? Math.round(estimatedCycles) : Infinity,\n    rating,\n    message,\n    tauA,\n    tauM,\n    tauMax,\n    tauMin,\n    Se,\n    Su,\n    goodmanFoS,\n    gerberFoS,\n    snCurveData,\n  };\n}\n\n// ============================================================================\n// P1: Comprehensive Scoring System\n// ============================================================================\n\nexport interface ArcDesignScore {\n  overallScore: number;\n  staticSafetyScore: number;\n  fatigueSafetyScore: number;\n  manufacturabilityScore: number;\n  geometryScore: number;\n  rating: \"excellent\" | \"good\" | \"acceptable\" | \"marginal\" | \"poor\";\n  ratingZh: string;\n  breakdown: {\n    category: string;\n    categoryZh: string;\n    score: number;\n    maxScore: number;\n    notes: string;\n  }[];\n}\n\nexport function calculateArcDesignScore(params: {\n  manufacturability: ArcManufacturabilityResult;\n  fatigueLife: ArcFatigueLifeResult;\n  staticSF: number;\n  fatigueSF: number | null;\n  springIndex: number;\n}): ArcDesignScore {\n  const breakdown: ArcDesignScore[\"breakdown\"] = [];\n  \n  // Static Safety (25 points max)\n  let staticSafetyScore = 25;\n  if (params.staticSF < 1.0) {\n    staticSafetyScore = 0;\n  } else if (params.staticSF < 1.2) {\n    staticSafetyScore = 10;\n  } else if (params.staticSF < 1.5) {\n    staticSafetyScore = 18;\n  }\n  breakdown.push({\n    category: \"Static Safety\",\n    categoryZh: \"静强度安全\",\n    score: staticSafetyScore,\n    maxScore: 25,\n    notes: `SF = ${params.staticSF.toFixed(2)}`,\n  });\n  \n  // Fatigue Safety (25 points max)\n  let fatigueSafetyScore = 25;\n  const fatigueSF = params.fatigueSF ?? params.fatigueLife.goodmanFoS;\n  if (fatigueSF === null || fatigueSF < 1.0) {\n    fatigueSafetyScore = 0;\n  } else if (fatigueSF < 1.2) {\n    fatigueSafetyScore = 10;\n  } else if (fatigueSF < 1.5) {\n    fatigueSafetyScore = 18;\n  }\n  breakdown.push({\n    category: \"Fatigue Safety\",\n    categoryZh: \"疲劳安全\",\n    score: fatigueSafetyScore,\n    maxScore: 25,\n    notes: `SF = ${fatigueSF?.toFixed(2) ?? \"N/A\"}`,\n  });\n  \n  // Manufacturability (30 points max)\n  let manufacturabilityScore = 30;\n  if (!params.manufacturability.isManufacturable) {\n    manufacturabilityScore = 0;\n  } else {\n    manufacturabilityScore -= params.manufacturability.criticalCount * 30;\n    manufacturabilityScore -= params.manufacturability.majorCount * 10;\n    manufacturabilityScore -= params.manufacturability.minorCount * 3;\n    manufacturabilityScore = Math.max(0, manufacturabilityScore);\n  }\n  breakdown.push({\n    category: \"Manufacturability\",\n    categoryZh: \"可制造性\",\n    score: manufacturabilityScore,\n    maxScore: 30,\n    notes: `Difficulty: ${params.manufacturability.difficultyScore}/100`,\n  });\n  \n  // Geometry (20 points max)\n  let geometryScore = 20;\n  const C = params.springIndex;\n  if (C < 4 || C > 16) {\n    geometryScore = 5;\n  } else if (C < 6 || C > 12) {\n    geometryScore = 15;\n  }\n  breakdown.push({\n    category: \"Geometry\",\n    categoryZh: \"几何设计\",\n    score: geometryScore,\n    maxScore: 20,\n    notes: `C = ${C.toFixed(2)}`,\n  });\n  \n  const overallScore = staticSafetyScore + fatigueSafetyScore + manufacturabilityScore + geometryScore;\n  \n  let rating: ArcDesignScore[\"rating\"];\n  let ratingZh: string;\n  \n  if (overallScore >= 90) {\n    rating = \"excellent\";\n    ratingZh = \"优秀\";\n  } else if (overallScore >= 75) {\n    rating = \"good\";\n    ratingZh = \"良好\";\n  } else if (overallScore >= 60) {\n    rating = \"acceptable\";\n    ratingZh = \"可接受\";\n  } else if (overallScore >= 40) {\n    rating = \"marginal\";\n    ratingZh = \"边缘\";\n  } else {\n    rating = \"poor\";\n    ratingZh = \"差\";\n  }\n  \n  return {\n    overallScore,\n    staticSafetyScore,\n    fatigueSafetyScore,\n    manufacturabilityScore,\n    geometryScore,\n    rating,\n    ratingZh,\n    breakdown,\n  };\n}\n\n// ============================================================================\n// P2: Natural Frequency Analysis\n// ============================================================================\n\nexport interface ArcVibrationResult {\n  naturalFrequency_Hz: number;\n  naturalFrequency_rpm: number;\n  criticalSpeed_rpm: number;\n  effectiveMass_kg: number;\n  momentOfInertia_kgmm2: number;\n  resonanceRisk: \"safe\" | \"warning\" | \"danger\";\n  operatingFrequencyRatio: number | null;\n  recommendations: string[];\n  recommendationsZh: string[];\n}\n\nexport function calculateArcVibration(params: {\n  R_NmmPerDeg: number;\n  d_mm: number;\n  D_mm: number;\n  n: number;\n  r_mm: number;\n  alpha0_deg: number;\n  materialDensity_kgm3?: number;\n  operatingRpm?: number;\n}): ArcVibrationResult {\n  const {\n    R_NmmPerDeg,\n    d_mm,\n    D_mm,\n    n,\n    r_mm,\n    alpha0_deg,\n    materialDensity_kgm3 = 7850,\n    operatingRpm,\n  } = params;\n  \n  const recommendations: string[] = [];\n  const recommendationsZh: string[] = [];\n  \n  // Convert rotational stiffness to N·mm/rad\n  const R_NmmPerRad = R_NmmPerDeg * (180 / PI);\n  \n  // Calculate wire length and mass\n  const deg2rad = (deg: number) => (deg * PI) / 180;\n  const arcLength = r_mm * deg2rad(alpha0_deg);\n  const pitchPerTurn = arcLength / n;\n  const perTurn = Math.sqrt(Math.pow(PI * D_mm, 2) + Math.pow(pitchPerTurn, 2));\n  const wireLength_mm = perTurn * n;\n  \n  // Wire cross-section area and volume\n  const wireArea_mm2 = PI * Math.pow(d_mm / 2, 2);\n  const wireVolume_mm3 = wireArea_mm2 * wireLength_mm;\n  const mass_kg = wireVolume_mm3 * 1e-9 * materialDensity_kgm3;\n  \n  // Moment of inertia about rotation axis\n  // J ≈ m × r² (simplified)\n  const J_kgmm2 = mass_kg * r_mm * r_mm;\n  const J_kgm2 = J_kgmm2 * 1e-6;\n  \n  // Natural frequency: fn = (1/2π) × √(R/J)\n  const R_Nm_per_rad = R_NmmPerRad / 1000;\n  const omega_n = Math.sqrt(R_Nm_per_rad / J_kgm2);\n  const fn_Hz = omega_n / (2 * PI);\n  const fn_rpm = fn_Hz * 60;\n  \n  // Critical speed (typically 0.7-0.8 of natural frequency)\n  const criticalSpeed_rpm = fn_rpm * 0.75;\n  \n  // Resonance risk assessment\n  let resonanceRisk: ArcVibrationResult[\"resonanceRisk\"] = \"safe\";\n  let operatingFrequencyRatio: number | null = null;\n  \n  if (operatingRpm !== undefined && operatingRpm > 0) {\n    operatingFrequencyRatio = operatingRpm / fn_rpm;\n    \n    if (operatingFrequencyRatio > 0.7 && operatingFrequencyRatio < 1.3) {\n      resonanceRisk = \"danger\";\n      recommendations.push(\"Operating speed is near resonance - redesign required\");\n      recommendationsZh.push(\"工作转速接近共振 - 需要重新设计\");\n    } else if (operatingFrequencyRatio > 0.5 && operatingFrequencyRatio < 1.5) {\n      resonanceRisk = \"warning\";\n      recommendations.push(\"Operating speed approaching resonance zone\");\n      recommendationsZh.push(\"工作转速接近共振区域\");\n    }\n  }\n  \n  if (fn_Hz < 20) {\n    recommendations.push(\"Low natural frequency - susceptible to external vibrations\");\n    recommendationsZh.push(\"固有频率较低 - 易受外部振动影响\");\n  }\n  \n  return {\n    naturalFrequency_Hz: fn_Hz,\n    naturalFrequency_rpm: fn_rpm,\n    criticalSpeed_rpm,\n    effectiveMass_kg: mass_kg,\n    momentOfInertia_kgmm2: J_kgmm2,\n    resonanceRisk,\n    operatingFrequencyRatio,\n    recommendations,\n    recommendationsZh,\n  };\n}\n\n// ============================================================================\n// P2: Temperature Effects\n// ============================================================================\n\nexport interface ArcTemperatureResult {\n  G_adjusted_MPa: number;\n  k_adjusted_Nmm: number;\n  R_adjusted_NmmPerDeg: number;\n  temperatureFactor: number;\n  stiffnessChange_percent: number;\n  warnings: string[];\n  warningsZh: string[];\n}\n\nexport function calculateArcTemperatureEffects(params: {\n  temperature_C: number;\n  G0_MPa: number;\n  k0_Nmm: number;\n  R0_NmmPerDeg: number;\n}): ArcTemperatureResult {\n  const { temperature_C, G0_MPa, k0_Nmm, R0_NmmPerDeg } = params;\n  \n  const warnings: string[] = [];\n  const warningsZh: string[] = [];\n  \n  // Temperature factor for shear modulus\n  // G decreases approximately 0.03% per °C above 20°C\n  const deltaT = temperature_C - 20;\n  let tempFactor = 1.0;\n  \n  if (temperature_C > 20) {\n    tempFactor = 1 - 0.0003 * deltaT;\n  } else if (temperature_C < -40) {\n    warnings.push(\"Temperature below -40°C: risk of cold brittleness\");\n    warningsZh.push(\"温度低于 -40°C：存在冷脆风险\");\n    tempFactor = 1 + 0.0001 * Math.abs(deltaT);\n  }\n  \n  tempFactor = Math.max(0.5, Math.min(1.1, tempFactor));\n  \n  if (temperature_C > 150) {\n    warnings.push(\"Temperature above 150°C: significant stiffness reduction\");\n    warningsZh.push(\"温度高于 150°C：刚度显著降低\");\n  }\n  if (temperature_C > 250) {\n    warnings.push(\"Temperature above 250°C: consider heat-resistant alloy\");\n    warningsZh.push(\"温度高于 250°C：建议使用耐热合金\");\n  }\n  \n  const G_adjusted = G0_MPa * tempFactor;\n  const k_adjusted = k0_Nmm * tempFactor;\n  const R_adjusted = R0_NmmPerDeg * tempFactor;\n  const stiffnessChange = (tempFactor - 1) * 100;\n  \n  return {\n    G_adjusted_MPa: G_adjusted,\n    k_adjusted_Nmm: k_adjusted,\n    R_adjusted_NmmPerDeg: R_adjusted,\n    temperatureFactor: tempFactor,\n    stiffnessChange_percent: stiffnessChange,\n    warnings,\n    warningsZh,\n  };\n}\n\n// ============================================================================\n// P2: Centrifugal Force Effects (DMF Application)\n// ============================================================================\n\nexport interface ArcCentrifugalResult {\n  centrifugalForce_N: number;\n  additionalFrictionTorque_Nmm: number;\n  totalFrictionTorque_Nmm: number;\n  frictionIncrease_percent: number;\n  effectiveDampingCapacity_percent: number;\n  warnings: string[];\n  warningsZh: string[];\n}\n\nexport function calculateArcCentrifugalEffects(params: {\n  rpm: number;\n  r_mm: number;\n  d_mm: number;\n  D_mm: number;\n  n: number;\n  alpha0_deg: number;\n  frictionCoeff?: number;\n  baseFrictionTorque_Nmm?: number;\n  materialDensity_kgm3?: number;\n}): ArcCentrifugalResult {\n  const {\n    rpm,\n    r_mm,\n    d_mm,\n    D_mm,\n    n,\n    alpha0_deg,\n    frictionCoeff = 0.15,\n    baseFrictionTorque_Nmm = 0,\n    materialDensity_kgm3 = 7850,\n  } = params;\n  \n  const warnings: string[] = [];\n  const warningsZh: string[] = [];\n  \n  // Calculate wire mass\n  const deg2rad = (deg: number) => (deg * PI) / 180;\n  const arcLength = r_mm * deg2rad(alpha0_deg);\n  const pitchPerTurn = arcLength / n;\n  const perTurn = Math.sqrt(Math.pow(PI * D_mm, 2) + Math.pow(pitchPerTurn, 2));\n  const wireLength_mm = perTurn * n;\n  const wireArea_mm2 = PI * Math.pow(d_mm / 2, 2);\n  const wireVolume_mm3 = wireArea_mm2 * wireLength_mm;\n  const mass_kg = wireVolume_mm3 * 1e-9 * materialDensity_kgm3;\n  \n  // Angular velocity\n  const omega = (rpm * 2 * PI) / 60; // rad/s\n  \n  // Centrifugal force: F_c = m × r × ω²\n  const r_m = r_mm / 1000;\n  const centrifugalForce_N = mass_kg * r_m * omega * omega;\n  \n  // Additional friction torque from centrifugal force\n  // M_f = μ × F_c × r\n  const additionalFrictionTorque_Nmm = frictionCoeff * centrifugalForce_N * r_mm;\n  const totalFrictionTorque_Nmm = baseFrictionTorque_Nmm + additionalFrictionTorque_Nmm;\n  \n  // Friction increase percentage\n  const frictionIncrease = baseFrictionTorque_Nmm > 0 \n    ? (additionalFrictionTorque_Nmm / baseFrictionTorque_Nmm) * 100 \n    : 0;\n  \n  // Effective damping capacity (simplified estimate)\n  const effectiveDampingCapacity = baseFrictionTorque_Nmm > 0\n    ? (totalFrictionTorque_Nmm / baseFrictionTorque_Nmm) * 100\n    : 100;\n  \n  if (rpm > 3000) {\n    warnings.push(\"High RPM: centrifugal effects are significant\");\n    warningsZh.push(\"高转速：离心力效应显著\");\n  }\n  if (frictionIncrease > 50) {\n    warnings.push(\"Centrifugal friction increase exceeds 50%\");\n    warningsZh.push(\"离心摩擦增加超过 50%\");\n  }\n  \n  return {\n    centrifugalForce_N,\n    additionalFrictionTorque_Nmm,\n    totalFrictionTorque_Nmm,\n    frictionIncrease_percent: frictionIncrease,\n    effectiveDampingCapacity_percent: effectiveDampingCapacity,\n    warnings,\n    warningsZh,\n  };\n}\n\n// ============================================================================\n// P3: Creep / Relaxation Analysis\n// ============================================================================\n\nexport interface ArcCreepResult {\n  torqueLoss_percent: number;\n  torqueLoss_Nmm: number;\n  finalTorque_Nmm: number;\n  creepRate_percentPerHour: number;\n  timeToRelax10Percent_hours: number | null;\n  relaxationCurve: Array<{ hours: number; torquePercent: number }>;\n  warnings: string[];\n  warningsZh: string[];\n}\n\nexport function calculateArcCreep(params: {\n  initialTorque_Nmm: number;\n  temperature_C: number;\n  duration_hours: number;\n  stressRatio?: number;\n}): ArcCreepResult {\n  const {\n    initialTorque_Nmm,\n    temperature_C,\n    duration_hours,\n    stressRatio = 0.5,\n  } = params;\n  \n  const warnings: string[] = [];\n  const warningsZh: string[] = [];\n  \n  // Base creep rate at 20°C (% per 1000 hours)\n  const baseCreepRate = 0.1;\n  \n  // Temperature acceleration\n  const tempFactor = Math.exp((temperature_C - 20) / 50);\n  \n  // Stress acceleration\n  const stressFactor = Math.pow(stressRatio, 2);\n  \n  // Effective creep rate (% per hour)\n  const creepRate = (baseCreepRate / 1000) * tempFactor * stressFactor;\n  \n  // Logarithmic relaxation model\n  const A = creepRate * 10;\n  const t0 = 1;\n  \n  const torqueLoss_percent = A * Math.log(1 + duration_hours / t0) * 100;\n  const torqueLoss_Nmm = initialTorque_Nmm * (torqueLoss_percent / 100);\n  const finalTorque_Nmm = initialTorque_Nmm - torqueLoss_Nmm;\n  \n  const timeToRelax10Percent = torqueLoss_percent > 0 \n    ? t0 * (Math.exp(0.1 / A) - 1)\n    : null;\n  \n  // Generate relaxation curve\n  const relaxationCurve: Array<{ hours: number; torquePercent: number }> = [];\n  for (let i = 0; i <= 20; i++) {\n    const t = (duration_hours * i) / 20;\n    const loss = A * Math.log(1 + t / t0) * 100;\n    relaxationCurve.push({\n      hours: t,\n      torquePercent: 100 - Math.min(loss, 50),\n    });\n  }\n  \n  if (temperature_C > 100) {\n    warnings.push(\"Elevated temperature accelerates creep\");\n    warningsZh.push(\"高温加速蠕变\");\n  }\n  if (torqueLoss_percent > 5) {\n    warnings.push(\"Significant torque loss expected\");\n    warningsZh.push(\"预计扭矩损失显著\");\n  }\n  \n  return {\n    torqueLoss_percent: Math.min(torqueLoss_percent, 50),\n    torqueLoss_Nmm,\n    finalTorque_Nmm: Math.max(0, finalTorque_Nmm),\n    creepRate_percentPerHour: creepRate * 100,\n    timeToRelax10Percent_hours: timeToRelax10Percent,\n    relaxationCurve,\n    warnings,\n    warningsZh,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/arcSpring/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/arcSpring/materials.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/arcSpring/math.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/arcSpring/reportGenerator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/arcSpring/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/cad/exportService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/cad/freecadGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/cad/hookParams.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'HookSpec' is defined but never used.","line":9,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Hook Parameters for CAD Export\n * 钩部参数用于 CAD 导出\n * \n * 将 HookBuilder 的参数转换为 CAD 导出格式\n */\n\nimport type { ExtensionHookType } from \"@/lib/springTypes\";\nimport { getHookSpec, type HookSpec } from \"@/lib/spring3d/HookBuilder\";\n\n/**\n * CAD 导出用钩部参数\n */\nexport interface CadHookParams {\n  /** 钩类型 */\n  hookType: ExtensionHookType;\n  \n  /** 环数量 (1 或 2) */\n  loopCount: 1 | 2;\n  \n  /** 环角度 (度) */\n  loopAngleDeg: number;\n  \n  /** 环半径 (mm) */\n  loopRadius: number;\n  \n  /** 轴向间隙 (mm) */\n  axialGap: number;\n  \n  /** 径向偏移 (mm) */\n  radialOffset: number;\n  \n  /** 是否有延长段 */\n  hasExtendedLeg: boolean;\n  \n  /** 延长段长度 (mm) */\n  extendedLegLength: number;\n  \n  /** 环平面类型 */\n  loopPlaneType: \"axis-plane\" | \"orthogonal-plane\";\n  \n  /** 环中心模式 */\n  centerMode: \"on-axis\" | \"radial-offset\" | \"crossover\";\n}\n\n/**\n * 从 HookSpec 和几何参数计算 CAD 钩部参数\n */\nexport function calculateCadHookParams(\n  hookType: ExtensionHookType,\n  wireDiameter: number,\n  meanDiameter: number\n): CadHookParams {\n  const spec = getHookSpec(hookType);\n  const meanRadius = meanDiameter / 2;\n  \n  return {\n    hookType,\n    loopCount: spec.loopCount,\n    loopAngleDeg: Math.abs(spec.loopAngleDeg),\n    loopRadius: spec.hookRadiusFactor * meanRadius,\n    axialGap: spec.axialGapFactor * wireDiameter,\n    radialOffset: spec.radialOffsetFactor * wireDiameter,\n    hasExtendedLeg: spec.hasExtendedLeg,\n    extendedLegLength: spec.extendedLegLengthFactor * meanDiameter,\n    loopPlaneType: spec.loopPlaneType,\n    centerMode: spec.centerMode,\n  };\n}\n\n/**\n * 钩类型标签（用于 CAD 图纸标注）\n */\nexport const HOOK_TYPE_LABELS: Record<ExtensionHookType, { en: string; zh: string }> = {\n  machine: { en: \"Machine Hook\", zh: \"机加工钩\" },\n  crossover: { en: \"Crossover Hook\", zh: \"交叉钩\" },\n  side: { en: \"Side Hook\", zh: \"侧钩\" },\n  extended: { en: \"Extended Hook\", zh: \"延长钩\" },\n  doubleLoop: { en: \"Double Loop\", zh: \"双环钩\" },\n};\n\n/**\n * 生成钩部参数的 CAD 标注文本\n */\nexport function generateHookAnnotation(\n  params: CadHookParams,\n  language: \"en\" | \"zh\" = \"en\"\n): string[] {\n  const label = HOOK_TYPE_LABELS[params.hookType];\n  const lines: string[] = [];\n  \n  lines.push(`Hook Type / 钩类型: ${label[language]}`);\n  lines.push(`Loop Count / 环数: ${params.loopCount}`);\n  lines.push(`Loop Angle / 环角度: ${params.loopAngleDeg}°`);\n  lines.push(`Loop Radius / 环半径: ${params.loopRadius.toFixed(2)} mm`);\n  lines.push(`Axial Gap / 轴向间隙: ${params.axialGap.toFixed(2)} mm`);\n  \n  if (params.radialOffset > 0) {\n    lines.push(`Radial Offset / 径向偏移: ${params.radialOffset.toFixed(2)} mm`);\n  }\n  \n  if (params.hasExtendedLeg) {\n    lines.push(`Extended Leg / 延长段: ${params.extendedLegLength.toFixed(2)} mm`);\n  }\n  \n  return lines;\n}\n\n/**\n * 将钩部参数转换为 Creo 参数格式\n * 用于 Creo Family Table 或 Relations\n */\nexport function toCreoParameters(params: CadHookParams): Record<string, string | number> {\n  return {\n    HOOK_TYPE: params.hookType.toUpperCase(),\n    HOOK_LOOP_COUNT: params.loopCount,\n    HOOK_LOOP_ANGLE: params.loopAngleDeg,\n    HOOK_LOOP_RADIUS: params.loopRadius,\n    HOOK_AXIAL_GAP: params.axialGap,\n    HOOK_RADIAL_OFFSET: params.radialOffset,\n    HOOK_HAS_EXTENDED_LEG: params.hasExtendedLeg ? \"YES\" : \"NO\",\n    HOOK_EXTENDED_LEG_LENGTH: params.extendedLegLength,\n    HOOK_PLANE_TYPE: params.loopPlaneType.toUpperCase().replace(\"-\", \"_\"),\n    HOOK_CENTER_MODE: params.centerMode.toUpperCase().replace(\"-\", \"_\"),\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/cad/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/cad/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/camera/captureFrame.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/camera/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/camera/useCameraStream.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/arcSpringRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/compressionRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/conicalRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/defaults.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/designRules.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/designRulesDefaults.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/dieSpringRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/extensionRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/spiralSpringRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/torsionRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/variablePitchRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/designRules/waveSpringRules.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'radialWallRatio' is assigned a value but never used.","line":101,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Wave Spring Design Rules\n * 波形弹簧设计规则\n * \n * Rule ID Prefixes:\n * - E* -> Engineering dimension\n * - M* -> Manufacturing dimension\n * - Q* -> Quality dimension\n */\n\nimport type { DesignRuleFinding, DesignRuleMetric, DesignRuleReport } from \"./types\";\nimport { summarizeRuleStatus } from \"./types\";\nimport type { WaveSpringInput, WaveSpringResult } from \"@/lib/waveSpring/math\";\nimport { calculateWaveSpring, DEFAULT_WAVE_SPRING_MATERIAL } from \"@/lib/waveSpring/math\";\n\n// ============================================================================\n// Rule Thresholds\n// ============================================================================\n\nconst WAVE_SPRING_THRESHOLDS = {\n  // Engineering thresholds\n  minSpringIndex: 4,\n  maxSpringIndex: 20,\n  maxStressRatio: 0.8,\n  minDeflectionRatio: 0.1,\n  maxDeflectionRatio: 0.85,\n  \n  // Manufacturing thresholds\n  minWavesPerTurn: 2,\n  maxWavesPerTurn: 8,\n  minTurns: 1,\n  maxTurns: 20,\n  minThicknessRatio: 3,\n  maxThicknessRatio: 20,\n  minRadialWallRatio: 0.1,\n  maxRadialWallRatio: 0.45,\n};\n\n// ============================================================================\n// Build Design Rule Report\n// ============================================================================\n\nexport function buildWaveSpringDesignRuleReport(params: {\n  input: WaveSpringInput | null | undefined;\n  result?: WaveSpringResult | null;\n}): DesignRuleReport {\n  const { input, result: providedResult } = params;\n  const findings: DesignRuleFinding[] = [];\n  const metrics: Record<string, DesignRuleMetric> = {};\n\n  // Handle null/undefined input\n  if (!input) {\n    findings.push({\n      id: \"WAVE_NO_INPUT\",\n      level: \"error\",\n      titleEn: \"No wave spring input provided\",\n      titleZh: \"未提供波形弹簧输入\",\n    });\n    return {\n      summary: { status: summarizeRuleStatus(findings) },\n      metrics,\n      findings,\n    };\n  }\n\n  const g = input.geometry;\n  const result = providedResult ?? calculateWaveSpring(input);\n\n  // Add errors from calculation\n  for (const err of result.errors) {\n    findings.push({\n      id: \"WAVE_E1_GEOM_INVALID\",\n      level: \"error\",\n      titleEn: \"Invalid geometry\",\n      titleZh: \"几何无效\",\n      detailEn: err,\n      detailZh: err,\n    });\n  }\n\n  // Add warnings from calculation\n  for (const warn of result.warnings) {\n    findings.push({\n      id: \"WAVE_M1_CALC_WARNING\",\n      level: \"warning\",\n      titleEn: \"Calculation warning\",\n      titleZh: \"计算警告\",\n      detailEn: warn,\n      detailZh: warn,\n    });\n  }\n\n  // ========== Metrics ==========\n  \n  const meanDiameter = (g.od + g.id) / 2;\n  const radialSpace = (g.od - g.id) / 2;\n  // Spring Index for wave spring: Dm/t (using thickness, not radial wall)\n  // This is analogous to D/d for coil springs\n  const springIndex = meanDiameter / g.thickness_t;\n  const thicknessRatio = g.radialWall_b / g.thickness_t;\n  const radialWallRatio = g.radialWall_b / radialSpace;\n  // Solid height estimate (conservative): Nt * t\n  // Note: actual solid height depends on wave geometry/contact\n  const solidHeight = g.turns_Nt * g.thickness_t;\n  \n  // Check for invalid free height (must be > solid height)\n  if (g.freeHeight_Hf <= solidHeight) {\n    findings.push({\n      id: \"WAVE_E0_HEIGHT_INVALID\",\n      level: \"error\",\n      titleEn: `Free height (${g.freeHeight_Hf.toFixed(2)}mm) <= solid height estimate (${solidHeight.toFixed(2)}mm)`,\n      titleZh: `自由高度 (${g.freeHeight_Hf.toFixed(2)}mm) <= 固态高度估算 (${solidHeight.toFixed(2)}mm)`,\n      detailEn: \"Free height must be greater than solid height for spring to function\",\n      detailZh: \"自由高度必须大于固态高度才能使弹簧正常工作\",\n    });\n    // Return early with error - deflectionRatio would be invalid\n    return {\n      summary: { status: summarizeRuleStatus(findings) },\n      metrics,\n      findings,\n    };\n  }\n  \n  const deflectionRatio = result.travel_mm / (g.freeHeight_Hf - solidHeight);\n  const yieldStrength = DEFAULT_WAVE_SPRING_MATERIAL.yieldStrength_MPa;\n  const stressRatio = result.stressMax_MPa / yieldStrength;\n\n  metrics[\"meanDiameter\"] = {\n    value: meanDiameter.toFixed(2),\n    unit: \"mm\",\n    labelEn: \"Mean Diameter Dm\",\n    labelZh: \"中径 Dm\",\n  };\n\n  metrics[\"springIndex\"] = {\n    value: springIndex.toFixed(2),\n    labelEn: \"Geometry Slenderness (Dm/t)\",\n    labelZh: \"几何细长比 (Dm/t)\",\n  };\n\n  metrics[\"thicknessRatio\"] = {\n    value: thicknessRatio.toFixed(2),\n    labelEn: \"b/t Ratio\",\n    labelZh: \"b/t 比\",\n  };\n\n  metrics[\"springRate\"] = {\n    value: result.springRate_Nmm.toFixed(3),\n    unit: \"N/mm\",\n    labelEn: \"Spring Rate k\",\n    labelZh: \"刚度 k\",\n  };\n\n  metrics[\"loadAtWorkingHeight\"] = {\n    value: result.loadAtWorkingHeight_N.toFixed(2),\n    unit: \"N\",\n    labelEn: \"Load @ Working Height\",\n    labelZh: \"工作高度载荷\",\n  };\n\n  metrics[\"travel\"] = {\n    value: result.travel_mm.toFixed(2),\n    unit: \"mm\",\n    labelEn: \"Travel (Hf - Hw)\",\n    labelZh: \"行程 (Hf - Hw)\",\n  };\n\n  metrics[\"stressMax\"] = {\n    value: result.stressMax_MPa.toFixed(1),\n    unit: \"MPa\",\n    labelEn: \"Max Stress σ\",\n    labelZh: \"最大应力 σ\",\n  };\n\n  metrics[\"stressRatio\"] = {\n    value: (stressRatio * 100).toFixed(1),\n    unit: \"%\",\n    labelEn: \"Stress / Yield\",\n    labelZh: \"应力/屈服比\",\n  };\n\n  metrics[\"deflectionRatio\"] = {\n    value: (deflectionRatio * 100).toFixed(1),\n    unit: \"%\",\n    labelEn: \"Deflection / Available\",\n    labelZh: \"变形/可用比\",\n  };\n\n  // ===== Crest-to-crest contact geometry (multi-turn wave spring) =====\n  const pitchPerTurn = g.freeHeight_Hf / g.turns_Nt; // P\n  const targetAmplitude = 0.5 * pitchPerTurn;        // A_target so that 2A = P\n  const contactRatio = (2 * targetAmplitude) / pitchPerTurn; // always 1 with this definition\n\n  metrics[\"pitchPerTurn\"] = {\n    value: pitchPerTurn.toFixed(3),\n    unit: \"mm/turn\",\n    labelEn: \"Helix Pitch per Turn P\",\n    labelZh: \"每圈螺旋节距 P\",\n  };\n\n  metrics[\"targetWaveAmplitude\"] = {\n    value: targetAmplitude.toFixed(3),\n    unit: \"mm\",\n    labelEn: \"Target Wave Amplitude A (crest-to-crest)\",\n    labelZh: \"目标波幅 A（波峰顶住）\",\n  };\n\n  metrics[\"crestContactRatio\"] = {\n    value: (contactRatio * 100).toFixed(1),\n    unit: \"%\",\n    labelEn: \"Crest Contact Ratio (2A/P)\",\n    labelZh: \"顶住比 (2A/P)\",\n  };\n\n  // ========== Engineering Rules (E*) ==========\n\n  // E1: Geometry validation (already handled above)\n\n  // E2: Spring index check\n  if (springIndex < WAVE_SPRING_THRESHOLDS.minSpringIndex) {\n    findings.push({\n      id: \"WAVE_E2_INDEX_LOW\",\n      level: \"error\",\n      titleEn: `Spring index too low (${springIndex.toFixed(1)} < ${WAVE_SPRING_THRESHOLDS.minSpringIndex})`,\n      titleZh: `弹簧指数过低 (${springIndex.toFixed(1)} < ${WAVE_SPRING_THRESHOLDS.minSpringIndex})`,\n      suggestionEn: \"Increase mean diameter or reduce radial wall width\",\n      suggestionZh: \"增加中径或减小径向壁宽\",\n    });\n  } else if (springIndex > WAVE_SPRING_THRESHOLDS.maxSpringIndex) {\n    findings.push({\n      id: \"WAVE_E2_INDEX_HIGH\",\n      level: \"warning\",\n      titleEn: `Spring index high (${springIndex.toFixed(1)} > ${WAVE_SPRING_THRESHOLDS.maxSpringIndex})`,\n      titleZh: `弹簧指数偏高 (${springIndex.toFixed(1)} > ${WAVE_SPRING_THRESHOLDS.maxSpringIndex})`,\n      suggestionEn: \"Reduce mean diameter or increase radial wall width\",\n      suggestionZh: \"减小中径或增加径向壁宽\",\n    });\n  }\n\n  // E3: Stress ratio check\n  if (stressRatio > WAVE_SPRING_THRESHOLDS.maxStressRatio) {\n    findings.push({\n      id: \"WAVE_E3_STRESS_HIGH\",\n      level: \"error\",\n      titleEn: `Stress exceeds ${WAVE_SPRING_THRESHOLDS.maxStressRatio * 100}% of yield (${(stressRatio * 100).toFixed(1)}%)`,\n      titleZh: `应力超过屈服强度的 ${WAVE_SPRING_THRESHOLDS.maxStressRatio * 100}% (${(stressRatio * 100).toFixed(1)}%)`,\n      suggestionEn: \"Reduce load, increase thickness, or use stronger material\",\n      suggestionZh: \"减小载荷、增加厚度或使用更强材料\",\n    });\n  }\n\n  // E4: Crest-to-crest contact requirement for multi-turn wave springs\n  if (g.turns_Nt >= 2) {\n    // Multi-turn wave spring should be designed with crest-to-crest contact\n    // Geometry builder uses: z = (P/2π)*θ + A*sin(Nw*θ)*s(θ), where s(θ) = (-1)^floor(θ/2π)\n    // With A = P/2, adjacent turns touch at wave peaks\n    findings.push({\n      id: \"WAVE_E4_CREST_CONTACT\",\n      level: \"info\",\n      titleEn: `Multi-turn wave spring designed for crest-to-crest contact (P=${pitchPerTurn.toFixed(2)}mm, A=${targetAmplitude.toFixed(2)}mm)`,\n      titleZh: `多圈波形弹簧按波峰顶住设计 (P=${pitchPerTurn.toFixed(2)}mm, A=${targetAmplitude.toFixed(2)}mm)`,\n      detailEn: \"Continuous helix with alternating wave phase per turn; wave amplitude A = P/2 ensures adjacent turn peaks touch in free state.\",\n      detailZh: \"采用连续螺旋上升并每圈波形交错；波幅 A = P/2，使相邻圈波峰在自由态接触。\",\n    });\n  }\n\n  // ========== Manufacturing Rules (M*) ==========\n\n  // M1: Waves per turn check\n  if (g.wavesPerTurn_Nw < WAVE_SPRING_THRESHOLDS.minWavesPerTurn) {\n    findings.push({\n      id: \"WAVE_M1_WAVES_LOW\",\n      level: \"warning\",\n      titleEn: `Waves per turn too low (${g.wavesPerTurn_Nw} < ${WAVE_SPRING_THRESHOLDS.minWavesPerTurn})`,\n      titleZh: `每圈波数过少 (${g.wavesPerTurn_Nw} < ${WAVE_SPRING_THRESHOLDS.minWavesPerTurn})`,\n      suggestionEn: \"Increase waves per turn for stability\",\n      suggestionZh: \"增加每圈波数以提高稳定性\",\n    });\n  } else if (g.wavesPerTurn_Nw > WAVE_SPRING_THRESHOLDS.maxWavesPerTurn) {\n    findings.push({\n      id: \"WAVE_M1_WAVES_HIGH\",\n      level: \"warning\",\n      titleEn: `Waves per turn high (${g.wavesPerTurn_Nw} > ${WAVE_SPRING_THRESHOLDS.maxWavesPerTurn})`,\n      titleZh: `每圈波数过多 (${g.wavesPerTurn_Nw} > ${WAVE_SPRING_THRESHOLDS.maxWavesPerTurn})`,\n      suggestionEn: \"Reduce waves per turn for easier manufacturing\",\n      suggestionZh: \"减少每圈波数以便于制造\",\n    });\n  }\n\n  // M2: Thickness ratio check\n  if (thicknessRatio < WAVE_SPRING_THRESHOLDS.minThicknessRatio) {\n    findings.push({\n      id: \"WAVE_M2_THICKNESS_RATIO_LOW\",\n      level: \"warning\",\n      titleEn: `b/t ratio too low (${thicknessRatio.toFixed(1)} < ${WAVE_SPRING_THRESHOLDS.minThicknessRatio})`,\n      titleZh: `b/t 比过低 (${thicknessRatio.toFixed(1)} < ${WAVE_SPRING_THRESHOLDS.minThicknessRatio})`,\n      suggestionEn: \"Increase radial wall width or reduce thickness\",\n      suggestionZh: \"增加径向壁宽或减小厚度\",\n    });\n  } else if (thicknessRatio > WAVE_SPRING_THRESHOLDS.maxThicknessRatio) {\n    findings.push({\n      id: \"WAVE_M2_THICKNESS_RATIO_HIGH\",\n      level: \"warning\",\n      titleEn: `b/t ratio high (${thicknessRatio.toFixed(1)} > ${WAVE_SPRING_THRESHOLDS.maxThicknessRatio})`,\n      titleZh: `b/t 比偏高 (${thicknessRatio.toFixed(1)} > ${WAVE_SPRING_THRESHOLDS.maxThicknessRatio})`,\n      suggestionEn: \"Reduce radial wall width or increase thickness\",\n      suggestionZh: \"减小径向壁宽或增加厚度\",\n    });\n  }\n\n  // M3: Turn count check\n  if (g.turns_Nt > WAVE_SPRING_THRESHOLDS.maxTurns) {\n    findings.push({\n      id: \"WAVE_M3_TURNS_HIGH\",\n      level: \"warning\",\n      titleEn: `Turn count high (${g.turns_Nt} > ${WAVE_SPRING_THRESHOLDS.maxTurns})`,\n      titleZh: `圈数过多 (${g.turns_Nt} > ${WAVE_SPRING_THRESHOLDS.maxTurns})`,\n      suggestionEn: \"Consider reducing turns or using nested design\",\n      suggestionZh: \"考虑减少圈数或使用嵌套设计\",\n    });\n  }\n\n  // ========== Quality Rules (Q*) ==========\n\n  // Q1: Deflection ratio check (near solid)\n  if (deflectionRatio > WAVE_SPRING_THRESHOLDS.maxDeflectionRatio) {\n    findings.push({\n      id: \"WAVE_Q1_NEAR_SOLID\",\n      level: \"warning\",\n      titleEn: `Working deflection near solid height (${(deflectionRatio * 100).toFixed(1)}% of available)`,\n      titleZh: `工作变形接近并紧高度 (可用的 ${(deflectionRatio * 100).toFixed(1)}%)`,\n      suggestionEn: \"Reduce working deflection or increase free height\",\n      suggestionZh: \"减小工作变形或增加自由高度\",\n    });\n  }\n\n  return {\n    summary: { status: summarizeRuleStatus(findings) },\n    metrics,\n    findings,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/dieSpring/__tests__/math.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/dieSpring/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/dieSpring/math.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DieSpringMaterialType' is defined but never used.","line":11,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Die Spring Math Engine (V1)\n * 模具弹簧计算引擎\n * \n * Engineering-safe approximations for rectangular wire die springs\n */\n\nimport type {\n  DieSpringInput,\n  DieSpringResult,\n  DieSpringMaterialType,\n} from \"./types\";\nimport { DIE_SPRING_MATERIALS } from \"./types\";\nimport { calculateDeratedLoad } from \"./temperatureLoadLoss\";\n\n// ============================================================================\n// Constants\n// ============================================================================\n\n/** Steel shear modulus (MPa) */\nconst G_STEEL = 79000;\n\n/** Conservative stress factor β for rectangular wire */\nconst BETA_CONSERVATIVE = 3.0;\n\n// ============================================================================\n// Validation\n// ============================================================================\n\nexport function validateDieSpringInput(input: DieSpringInput): {\n  isValid: boolean;\n  errors: string[];\n  warnings: string[];\n} {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n  const g = input.geometry;\n\n  // Basic geometry checks\n  if (g.od_mm <= 0) errors.push(\"OD must be > 0\");\n  if (g.freeLength_mm <= 0) errors.push(\"Free length must be > 0\");\n  if (g.workingLength_mm <= 0) errors.push(\"Working length must be > 0\");\n  if (g.workingLength_mm >= g.freeLength_mm) {\n    errors.push(\"Working length must be < free length\");\n  }\n  if (g.coils <= 0) errors.push(\"Coils must be > 0\");\n  if (g.wire_b_mm <= 0) errors.push(\"Wire width b must be > 0\");\n  if (g.wire_t_mm <= 0) errors.push(\"Wire thickness t must be > 0\");\n\n  // Derived geometry checks\n  const meanDiameter = g.od_mm - g.wire_t_mm;\n  if (meanDiameter <= 0) {\n    errors.push(\"Mean diameter (OD - t) must be > 0\");\n  }\n\n  // Spring index check\n  const springIndex = meanDiameter / g.wire_t_mm;\n  if (springIndex < 3) {\n    warnings.push(`Spring index ${springIndex.toFixed(1)} is very low (< 3)`);\n  } else if (springIndex > 12) {\n    warnings.push(`Spring index ${springIndex.toFixed(1)} is high (> 12)`);\n  }\n\n  // b/t ratio check\n  const btRatio = g.wire_b_mm / g.wire_t_mm;\n  if (btRatio < 1.5) {\n    warnings.push(`b/t ratio ${btRatio.toFixed(2)} is low (< 1.5)`);\n  } else if (btRatio > 4.5) {\n    warnings.push(`b/t ratio ${btRatio.toFixed(2)} is high (> 4.5)`);\n  }\n\n  // Compression ratio check\n  const travel = g.freeLength_mm - g.workingLength_mm;\n  const compressionRatio = travel / g.freeLength_mm;\n  if (compressionRatio > 0.35) {\n    errors.push(`Compression ratio ${(compressionRatio * 100).toFixed(1)}% exceeds 35%`);\n  } else if (compressionRatio > 0.25) {\n    warnings.push(`Compression ratio ${(compressionRatio * 100).toFixed(1)}% is high (> 25%)`);\n  }\n\n  // Temperature check\n  if (input.operating?.temperature_C) {\n    const mat = DIE_SPRING_MATERIALS[input.material];\n    if (input.operating.temperature_C > mat.maxTemperature_C) {\n      errors.push(\n        `Temperature ${input.operating.temperature_C}°C exceeds material limit ${mat.maxTemperature_C}°C`\n      );\n    }\n  }\n\n  return {\n    isValid: errors.length === 0,\n    errors,\n    warnings,\n  };\n}\n\n// ============================================================================\n// Core Calculation\n// ============================================================================\n\n/**\n * Calculate active coils based on end style\n * \n * | endStyle       | Na                    |\n * |----------------|----------------------|\n * | open           | Nt (all coils active)|\n * | closed         | Nt - 2               |\n * | closed_ground  | Nt - 2               |\n */\nfunction getActiveCoils(totalCoils: number, endStyle: string | undefined): number {\n  switch (endStyle) {\n    case \"open\":\n      return totalCoils;\n    case \"closed\":\n    case \"closed_ground\":\n    default:\n      return Math.max(1, totalCoils - 2);\n  }\n}\n\n/**\n * Calculate die spring properties\n * \n * Formulas (V1 approximate):\n * - d_eq = sqrt(b * t)  -- equivalent wire diameter\n * - k = (G * d_eq^4) / (8 * Dm^3 * Na)  -- spring rate\n * - σ = (P * D) / (b * t * sqrt(b*t)) * β  -- rectangular wire stress\n */\nexport function calculateDieSpring(input: DieSpringInput): DieSpringResult {\n  const validation = validateDieSpringInput(input);\n  \n  if (!validation.isValid) {\n    return {\n      ok: false,\n      errors: validation.errors,\n      warnings: validation.warnings,\n      travel_mm: 0,\n      springRate_Nmm: 0,\n      loadAtWorking_N: 0,\n      meanDiameter_mm: 0,\n      springIndex: 0,\n      equivalentWireDiameter_mm: 0,\n      stress_MPa: 0,\n      stressRatio: 0,\n      compressionRatio: 0,\n      slendernessRatio: 0,\n      activeCoils: 0,\n      solidHeight_mm: 0,\n    };\n  }\n\n  const g = input.geometry;\n  const mat = DIE_SPRING_MATERIALS[input.material];\n  const endStyle = g.endStyle ?? \"closed_ground\";\n\n  // Geometry calculations\n  const travel_mm = g.freeLength_mm - g.workingLength_mm;\n  const meanDiameter_mm = g.od_mm - g.wire_t_mm;\n  const springIndex = meanDiameter_mm / g.wire_t_mm;\n  const equivalentWireDiameter_mm = Math.sqrt(g.wire_b_mm * g.wire_t_mm);\n  const compressionRatio = travel_mm / g.freeLength_mm;\n  const slendernessRatio = g.freeLength_mm / meanDiameter_mm;\n\n  // Active coils based on end style\n  const activeCoils = getActiveCoils(g.coils, endStyle);\n\n  // Solid height: Hs = Nt * wire_t\n  const solidHeight_mm = g.coils * g.wire_t_mm;\n\n  // Spring rate: k = (G * d_eq^4) / (8 * Dm^3 * Na)\n  const d_eq4 = Math.pow(equivalentWireDiameter_mm, 4);\n  const Dm3 = Math.pow(meanDiameter_mm, 3);\n  const springRate_Nmm = (G_STEEL * d_eq4) / (8 * Dm3 * activeCoils);\n\n  // Load at working length\n  const loadAtWorking_N = springRate_Nmm * travel_mm;\n\n  // Stress calculation (rectangular wire)\n  // σ = (P * D) / (b * t * sqrt(b*t)) * β\n  const btProduct = g.wire_b_mm * g.wire_t_mm;\n  const btSqrt = Math.sqrt(btProduct);\n  const stress_MPa = (loadAtWorking_N * meanDiameter_mm) / (btProduct * btSqrt) * BETA_CONSERVATIVE;\n\n  // Stress ratio\n  const stressRatio = stress_MPa / mat.yieldStrength_MPa;\n\n  // Temperature derating\n  let tempLoadLossPct: number | undefined;\n  let deratedLoad_N: number | undefined;\n  \n  if (input.operating?.temperature_C && input.operating.temperature_C > 20) {\n    const derating = calculateDeratedLoad(\n      loadAtWorking_N,\n      input.material,\n      input.operating.temperature_C\n    );\n    tempLoadLossPct = derating.lossPct;\n    deratedLoad_N = derating.deratedLoad_N;\n  }\n\n  return {\n    ok: true,\n    errors: [],\n    warnings: validation.warnings,\n    travel_mm,\n    springRate_Nmm,\n    loadAtWorking_N,\n    meanDiameter_mm,\n    springIndex,\n    equivalentWireDiameter_mm,\n    stress_MPa,\n    stressRatio,\n    compressionRatio,\n    slendernessRatio,\n    tempLoadLossPct,\n    deratedLoad_N,\n    activeCoils,\n    solidHeight_mm,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/dieSpring/riskModel.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/dieSpring/temperatureLoadLoss.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/dieSpring/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/drawing/freecadInterface.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'radius' is assigned a value but never used.","line":44,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":44,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'radius' is assigned a value but never used.","line":104,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":104,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'radius' is assigned a value but never used.","line":180,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":180,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pitch' is assigned a value but never used.","line":181,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":181,"endColumn":14},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":530,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":530,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15036,15039],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15036,15039],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":583,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":583,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17161,17164],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17161,17164],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FreeCAD Interface\n * FreeCAD 接口模块\n * \n * 提供与 FreeCAD 后端服务的通信接口\n * 支持 STEP/IGES 导出和 3D 预览\n */\n\nimport type { FreeCADExportRequest, FreeCADExportResponse } from \"./types\";\nimport type { SpringGeometry, MaterialInfo } from \"@/lib/stores/springDesignStore\";\n\n// ============================================================================\n// FreeCAD 服务配置\n// ============================================================================\n\n/** FreeCAD 服务端点 */\nconst FREECAD_API_ENDPOINT = process.env.NEXT_PUBLIC_FREECAD_API_URL || \"/api/freecad\";\n\n/** FreeCAD 服务状态 */\nexport interface FreeCADServiceStatus {\n  available: boolean;\n  version?: string;\n  capabilities?: string[];\n  error?: string;\n}\n\n// ============================================================================\n// FreeCAD Python 脚本模板\n// ============================================================================\n\n/**\n * 生成压缩弹簧的 FreeCAD Python 脚本\n */\nexport function generateCompressionSpringScript(params: {\n  wireDiameter: number;\n  meanDiameter: number;\n  activeCoils: number;\n  totalCoils: number;\n  freeLength: number;\n  pitch?: number;\n}): string {\n  const { wireDiameter: d, meanDiameter: Dm, activeCoils: Na, totalCoils: Nt, freeLength: L0 } = params;\n  const pitch = params.pitch ?? L0 / Na;\n  const radius = Dm / 2;\n\n  return `\n# FreeCAD Compression Spring Generator\n# 压缩弹簧生成脚本\n\nimport FreeCAD\nimport Part\nimport math\n\n# Parameters / 参数\nd = ${d}        # Wire diameter / 线径 (mm)\nDm = ${Dm}      # Mean diameter / 中径 (mm)\nNa = ${Na}      # Active coils / 有效圈数\nNt = ${Nt}      # Total coils / 总圈数\nL0 = ${L0}      # Free length / 自由长度 (mm)\npitch = ${pitch}  # Pitch / 节距 (mm)\n\n# Derived values / 派生值\nradius = Dm / 2\nwire_radius = d / 2\n\n# Create helix / 创建螺旋线\nhelix = Part.makeHelix(pitch, L0, radius)\n\n# Create wire profile / 创建线材截面\nwire_profile = Part.makeCircle(wire_radius, FreeCAD.Vector(radius, 0, 0), FreeCAD.Vector(0, 1, 0))\nwire_face = Part.Face(Part.Wire(wire_profile))\n\n# Sweep to create spring body / 扫掠生成弹簧本体\nspring = Part.Wire(helix).makePipeShell([wire_face], True, True)\n\n# Create document and add shape / 创建文档并添加形状\ndoc = FreeCAD.newDocument(\"CompressionSpring\")\nobj = doc.addObject(\"Part::Feature\", \"Spring\")\nobj.Shape = spring\n\n# Export to STEP / 导出 STEP\nPart.export([obj], \"/tmp/spring_output.step\")\n\nprint(\"Spring generated successfully!\")\nprint(f\"Wire diameter: {d} mm\")\nprint(f\"Mean diameter: {Dm} mm\")\nprint(f\"Active coils: {Na}\")\nprint(f\"Free length: {L0} mm\")\n`;\n}\n\n/**\n * 生成拉伸弹簧的 FreeCAD Python 脚本\n */\nexport function generateExtensionSpringScript(params: {\n  wireDiameter: number;\n  outerDiameter: number;\n  activeCoils: number;\n  bodyLength: number;\n  hookType: string;\n}): string {\n  const { wireDiameter: d, outerDiameter: OD, activeCoils: Na, bodyLength: Lb, hookType } = params;\n  const Dm = OD - d;\n  const radius = Dm / 2;\n\n  return `\n# FreeCAD Extension Spring Generator\n# 拉伸弹簧生成脚本\n\nimport FreeCAD\nimport Part\nimport math\n\n# Parameters / 参数\nd = ${d}        # Wire diameter / 线径 (mm)\nOD = ${OD}      # Outer diameter / 外径 (mm)\nNa = ${Na}      # Active coils / 有效圈数\nLb = ${Lb}      # Body length / 本体长度 (mm)\nhook_type = \"${hookType}\"  # Hook type / 钩部类型\n\n# Derived values / 派生值\nDm = OD - d\nradius = Dm / 2\nwire_radius = d / 2\npitch = d  # Close-wound / 密绕\n\n# Create helix for body / 创建本体螺旋线\nhelix = Part.makeHelix(pitch, Lb, radius)\n\n# Create wire profile / 创建线材截面\nwire_profile = Part.makeCircle(wire_radius, FreeCAD.Vector(radius, 0, 0), FreeCAD.Vector(0, 1, 0))\nwire_face = Part.Face(Part.Wire(wire_profile))\n\n# Sweep to create spring body / 扫掠生成弹簧本体\nspring_body = Part.Wire(helix).makePipeShell([wire_face], True, True)\n\n# Create hooks (simplified) / 创建钩部（简化）\nhook_radius = radius\nhook_arc = Part.makeCircle(hook_radius, FreeCAD.Vector(0, 0, 0), FreeCAD.Vector(1, 0, 0), 0, 180)\nhook_profile = Part.makeCircle(wire_radius, FreeCAD.Vector(0, hook_radius, 0), FreeCAD.Vector(0, 0, 1))\nhook_face = Part.Face(Part.Wire(hook_profile))\n\n# Bottom hook\nbottom_hook = Part.Wire(hook_arc).makePipeShell([hook_face], True, True)\nbottom_hook.translate(FreeCAD.Vector(0, 0, -hook_radius))\n\n# Top hook\ntop_hook = bottom_hook.copy()\ntop_hook.rotate(FreeCAD.Vector(0, 0, 0), FreeCAD.Vector(0, 0, 1), 180)\ntop_hook.translate(FreeCAD.Vector(0, 0, Lb + hook_radius))\n\n# Combine all parts / 合并所有部件\nspring = spring_body.fuse(bottom_hook).fuse(top_hook)\n\n# Create document and add shape / 创建文档并添加形状\ndoc = FreeCAD.newDocument(\"ExtensionSpring\")\nobj = doc.addObject(\"Part::Feature\", \"Spring\")\nobj.Shape = spring\n\n# Export to STEP / 导出 STEP\nPart.export([obj], \"/tmp/spring_output.step\")\n\nprint(\"Extension spring generated successfully!\")\n`;\n}\n\n/**\n * 生成扭转弹簧的 FreeCAD Python 脚本\n */\nexport function generateTorsionSpringScript(params: {\n  wireDiameter: number;\n  meanDiameter: number;\n  activeCoils: number;\n  bodyLength: number;\n  legLength1: number;\n  legLength2: number;\n  windingDirection: \"left\" | \"right\";\n}): string {\n  const { wireDiameter: d, meanDiameter: Dm, activeCoils: Na, bodyLength: Lb, legLength1: L1, legLength2: L2, windingDirection } = params;\n  const radius = Dm / 2;\n  const pitch = Lb / Na;\n\n  return `\n# FreeCAD Torsion Spring Generator\n# 扭转弹簧生成脚本\n\nimport FreeCAD\nimport Part\nimport math\n\n# Parameters / 参数\nd = ${d}        # Wire diameter / 线径 (mm)\nDm = ${Dm}      # Mean diameter / 中径 (mm)\nNa = ${Na}      # Active coils / 有效圈数\nLb = ${Lb}      # Body length / 本体长度 (mm)\nL1 = ${L1}      # Leg length 1 / 腿长1 (mm)\nL2 = ${L2}      # Leg length 2 / 腿长2 (mm)\nwinding = \"${windingDirection}\"  # Winding direction / 旋向\n\n# Derived values / 派生值\nradius = Dm / 2\nwire_radius = d / 2\npitch = Lb / Na\n\n# Create helix for body / 创建本体螺旋线\nhelix = Part.makeHelix(pitch, Lb, radius, 0, ${windingDirection === \"left\" ? \"True\" : \"False\"})\n\n# Create wire profile / 创建线材截面\nwire_profile = Part.makeCircle(wire_radius, FreeCAD.Vector(radius, 0, 0), FreeCAD.Vector(0, 1, 0))\nwire_face = Part.Face(Part.Wire(wire_profile))\n\n# Sweep to create spring body / 扫掠生成弹簧本体\nspring_body = Part.Wire(helix).makePipeShell([wire_face], True, True)\n\n# Create legs / 创建腿部\nleg1_line = Part.makeLine(FreeCAD.Vector(radius, 0, 0), FreeCAD.Vector(radius + L1, 0, 0))\nleg1_profile = Part.makeCircle(wire_radius, FreeCAD.Vector(radius, 0, 0), FreeCAD.Vector(1, 0, 0))\nleg1_face = Part.Face(Part.Wire(leg1_profile))\nleg1 = Part.Wire(leg1_line).makePipeShell([leg1_face], True, True)\n\nleg2_line = Part.makeLine(FreeCAD.Vector(radius, 0, Lb), FreeCAD.Vector(radius + L2, 0, Lb))\nleg2_profile = Part.makeCircle(wire_radius, FreeCAD.Vector(radius, 0, Lb), FreeCAD.Vector(1, 0, 0))\nleg2_face = Part.Face(Part.Wire(leg2_profile))\nleg2 = Part.Wire(leg2_line).makePipeShell([leg2_face], True, True)\n\n# Combine all parts / 合并所有部件\nspring = spring_body.fuse(leg1).fuse(leg2)\n\n# Create document and add shape / 创建文档并添加形状\ndoc = FreeCAD.newDocument(\"TorsionSpring\")\nobj = doc.addObject(\"Part::Feature\", \"Spring\")\nobj.Shape = spring\n\n# Export to STEP / 导出 STEP\nPart.export([obj], \"/tmp/spring_output.step\")\n\nprint(\"Torsion spring generated successfully!\")\n`;\n}\n\n/**\n * 生成锥形弹簧的 FreeCAD Python 脚本\n */\nexport function generateConicalSpringScript(params: {\n  wireDiameter: number;\n  largeOuterDiameter: number;\n  smallOuterDiameter: number;\n  activeCoils: number;\n  freeLength: number;\n}): string {\n  const { wireDiameter: d, largeOuterDiameter: D1, smallOuterDiameter: D2, activeCoils: Na, freeLength: L0 } = params;\n\n  return `\n# FreeCAD Conical Spring Generator\n# 锥形弹簧生成脚本\n\nimport FreeCAD\nimport Part\nimport math\n\n# Parameters / 参数\nd = ${d}        # Wire diameter / 线径 (mm)\nD1 = ${D1}      # Large outer diameter / 大端外径 (mm)\nD2 = ${D2}      # Small outer diameter / 小端外径 (mm)\nNa = ${Na}      # Active coils / 有效圈数\nL0 = ${L0}      # Free length / 自由长度 (mm)\n\n# Derived values / 派生值\nR1 = (D1 - d) / 2  # Large mean radius\nR2 = (D2 - d) / 2  # Small mean radius\nwire_radius = d / 2\npitch = L0 / Na\n\n# Create conical helix points / 创建锥形螺旋线点\npoints = []\nsegments = int(Na * 36)  # 36 points per coil\nfor i in range(segments + 1):\n    t = i / segments\n    angle = t * Na * 2 * math.pi\n    z = t * L0\n    r = R1 + (R2 - R1) * t\n    x = r * math.cos(angle)\n    y = r * math.sin(angle)\n    points.append(FreeCAD.Vector(x, y, z))\n\n# Create spline from points / 从点创建样条曲线\nspline = Part.BSplineCurve()\nspline.interpolate(points)\n\n# Create wire profile / 创建线材截面\nwire_profile = Part.makeCircle(wire_radius, points[0], FreeCAD.Vector(0, 0, 1))\nwire_face = Part.Face(Part.Wire(wire_profile))\n\n# Sweep to create spring / 扫掠生成弹簧\nspring = Part.Wire([spline.toShape()]).makePipeShell([wire_face], True, True)\n\n# Create document and add shape / 创建文档并添加形状\ndoc = FreeCAD.newDocument(\"ConicalSpring\")\nobj = doc.addObject(\"Part::Feature\", \"Spring\")\nobj.Shape = spring\n\n# Export to STEP / 导出 STEP\nPart.export([obj], \"/tmp/spring_output.step\")\n\nprint(\"Conical spring generated successfully!\")\n`;\n}\n\n/**\n * 生成螺旋扭转弹簧的 FreeCAD Python 脚本\n * 与 Three.js spiralTorsionGeometry.ts 和 run_export.py 完全同步\n */\nexport function generateSpiralTorsionSpringScript(params: {\n  innerDiameter: number;\n  outerDiameter: number;\n  turns: number;\n  stripWidth: number;\n  stripThickness: number;\n  handedness: \"cw\" | \"ccw\";\n}): string {\n  const { innerDiameter: Di, outerDiameter: Do, turns: N, stripWidth: b, stripThickness: t, handedness } = params;\n\n  return `\n# FreeCAD Spiral Torsion Spring Generator\n# 螺旋扭转弹簧生成脚本\n# 与 Three.js spiralTorsionGeometry.ts 完全同步\n\nimport FreeCAD as App\nimport Part\nimport math\n\n# Parameters / 参数\nDi = ${Di}      # Inner diameter / 内径 (mm)\nDo = ${Do}      # Outer diameter / 外径 (mm)\nN = ${N}        # Turns / 圈数\nb = ${b}        # Strip width / 带材宽度 (mm)\nt = ${t}        # Strip thickness / 带材厚度 (mm)\nhandedness = \"${handedness}\"  # Winding direction / 绕向\n\n# Derived values / 派生值\ninner_radius = Di / 2.0\nouter_radius = Do / 2.0\ntotal_angle = 2.0 * math.pi * N\na = (outer_radius - inner_radius) / total_angle  # Spiral coefficient\n\n# End geometry parameters (matching Three.js)\ninner_leg_length = max(b * 1.2, 10.0)\nouter_leg_length = max(3.0 * b, 25.0)\nhook_depth = max(0.45 * b, 5.0)\nhook_gap = max(0.9 * b, 8.0)\nbend_radius = max(3.0 * t, 3.0)\ninner_arc_radius = max(2.0 * t, 2.0)\n\n# Sampling parameters\nspiral_pts_count = 400\n\n# Generate Archimedean spiral points\nspiral_pts = []\nfor i in range(spiral_pts_count + 1):\n    u = i / spiral_pts_count\n    theta = u * total_angle\n    r = inner_radius + a * theta\n    angle = theta if handedness == \"ccw\" else -theta\n    x = r * math.cos(angle)\n    y = r * math.sin(angle)\n    spiral_pts.append(App.Vector(x, y, 0))\n\n# Create B-Spline from points\nbs = Part.BSplineCurve()\nbs.interpolate(spiral_pts)\npath = bs.toShape()\npath_wire = Part.Wire([path])\n\n# Get start point and tangent for cross-section orientation\nstart_point = path_wire.Vertexes[0].Point\nfirst_edge = path_wire.Edges[0]\ntangent = first_edge.tangentAt(first_edge.FirstParameter)\n\n# Calculate cross-section orientation using radial projection\nradial = App.Vector(start_point.x, start_point.y, 0)\nif radial.Length < 1e-12:\n    radial = App.Vector(1, 0, 0)\nelse:\n    radial.normalize()\n\n# N = radial projected onto plane perpendicular to tangent\nnormal = radial - tangent * radial.dot(tangent)\nif normal.Length < 1e-9:\n    normal = App.Vector(-tangent.y, tangent.x, 0)\nnormal.normalize()\n\n# B = tangent x normal\nbinormal = tangent.cross(normal)\nbinormal.normalize()\n\n# Create rectangular cross-section (thickness along normal, width along binormal)\nhalf_t = t / 2.0\nhalf_b = b / 2.0\n\np1 = start_point - normal * half_t - binormal * half_b\np2 = start_point + normal * half_t - binormal * half_b\np3 = start_point + normal * half_t + binormal * half_b\np4 = start_point - normal * half_t + binormal * half_b\n\nrect_wire = Part.makePolygon([p1, p2, p3, p4, p1])\n\n# Sweep to create spring\nspring = path_wire.makePipeShell([rect_wire], True, True)\n\n# Create document and add shape\ndoc = App.newDocument(\"SpiralTorsionSpring\")\nobj = doc.addObject(\"Part::Feature\", \"Spring\")\nobj.Shape = spring\n\n# Export to STEP\nPart.export([obj], \"/tmp/spring_output.step\")\n\nprint(\"Spiral torsion spring generated successfully!\")\nprint(f\"Inner diameter: {Di} mm\")\nprint(f\"Outer diameter: {Do} mm\")\nprint(f\"Turns: {N}\")\nprint(f\"Strip width: {b} mm\")\nprint(f\"Strip thickness: {t} mm\")\n`;\n}\n\n// ============================================================================\n// API 接口函数\n// ============================================================================\n\n/**\n * 检查 FreeCAD 服务状态\n */\nexport async function checkFreeCADStatus(): Promise<FreeCADServiceStatus> {\n  try {\n    const response = await fetch(`${FREECAD_API_ENDPOINT}/status`);\n    if (!response.ok) {\n      return { available: false, error: \"Service unavailable\" };\n    }\n    const data = await response.json();\n    return {\n      available: true,\n      version: data.version,\n      capabilities: data.capabilities,\n    };\n  } catch (error) {\n    return {\n      available: false,\n      error: error instanceof Error ? error.message : \"Connection failed\"\n    };\n  }\n}\n\n/**\n * 请求 FreeCAD 导出\n */\nexport async function requestFreeCADExport(\n  request: FreeCADExportRequest\n): Promise<FreeCADExportResponse> {\n  try {\n    const response = await fetch(`${FREECAD_API_ENDPOINT}/export`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(request),\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      return {\n        status: \"failed\",\n        error: {\n          code: \"EXPORT_FAILED\",\n          message: error.message || \"Export failed\",\n        },\n      };\n    }\n\n    return await response.json();\n  } catch (error) {\n    return {\n      status: \"failed\",\n      error: {\n        code: \"CONNECTION_ERROR\",\n        message: error instanceof Error ? error.message : \"Connection failed\",\n      },\n    };\n  }\n}\n\n/**\n * 从设计数据构建 FreeCAD 导出请求\n */\nexport function buildFreeCADRequest(\n  geometry: SpringGeometry,\n  material: MaterialInfo,\n  outputFormats: (\"STEP\" | \"IGES\" | \"STL\" | \"OBJ\" | \"FCStd\")[] = [\"STEP\"]\n): FreeCADExportRequest | null {\n  // 螺旋扭转弹簧使用特殊参数\n  if (geometry.type === \"spiralTorsion\") {\n    return {\n      design: {\n        springType: \"spiral_torsion\",\n        innerDiameter: geometry.innerDiameter,\n        outerDiameter: geometry.outerDiameter,\n        turns: geometry.activeCoils,\n        stripWidth: geometry.stripWidth,\n        stripThickness: geometry.stripThickness,\n        handedness: \"ccw\",\n      },\n      outputFormats,\n      generateDrawing: false, // 螺旋扭转弹簧暂不支持 2D 工程图\n    };\n  }\n\n  const design: FreeCADExportRequest[\"design\"] = {\n    springType: geometry.type,\n    wireDiameter: geometry.wireDiameter,\n    activeCoils: geometry.activeCoils,\n  };\n\n  switch (geometry.type) {\n    case \"compression\":\n      design.meanDiameter = geometry.meanDiameter;\n      design.totalCoils = geometry.totalCoils;\n      design.freeLength = geometry.freeLength;\n      break;\n    case \"suspensionSpring\":\n      // Fallback to compression params for now\n      // Ideally we should pass pitch/diameter profiles, but FreeCAD script needs update\n      design.meanDiameter = (geometry as any).meanDiameter ?? (geometry.activeCoils > 0 ? 100 : 0); // Hack if meanDiameter missing from SuspensionGeometry type\n      // Actually SuspensionGeometry doesn't have meanDiameter field in new definition?\n      // It has diameterProfile.\n      // let's infer mean diameter from OD - d\n      // Store doesn't save OD in geometry, only diameterProfile.\n      // We can use diameterProfile.DmStart or 100 as fallback.\n      if ('diameterProfile' in geometry) {\n        design.meanDiameter = geometry.diameterProfile.DmStart ?? 100;\n        // Or if we want to be safe, calculation results usually have derived meanDiameter\n      }\n      design.totalCoils = geometry.totalCoils;\n      design.freeLength = geometry.freeLength;\n      break;\n    case \"extension\":\n      design.outerDiameter = geometry.outerDiameter;\n      design.hookType = geometry.hookType;\n      break;\n    case \"torsion\":\n      design.meanDiameter = geometry.meanDiameter;\n      design.legLength1 = geometry.legLength1;\n      design.legLength2 = geometry.legLength2;\n      design.windingDirection = geometry.windingDirection;\n      break;\n    case \"conical\":\n      design.largeOuterDiameter = geometry.largeOuterDiameter;\n      design.smallOuterDiameter = geometry.smallOuterDiameter;\n      design.freeLength = geometry.freeLength;\n      break;\n  }\n\n  return {\n    design,\n    outputFormats,\n    generateDrawing: true,\n  };\n}\n\n/**\n * 生成 FreeCAD Python 脚本\n */\nexport function generateFreeCADScript(geometry: SpringGeometry): string {\n  switch (geometry.type) {\n    case \"compression\":\n      return generateCompressionSpringScript({\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter: geometry.meanDiameter ?? (geometry as { outerDiameter?: number }).outerDiameter ?? 20 - geometry.wireDiameter,\n        activeCoils: geometry.activeCoils,\n        totalCoils: geometry.totalCoils ?? geometry.activeCoils + 2,\n        freeLength: geometry.freeLength ?? 50,\n      });\n    case \"suspensionSpring\":\n      // Temporary fallback to standard compression spring script\n      // TODO: Implement advanced parametric script\n      const susGeo = geometry as any;\n      const susDm = susGeo.diameterProfile?.DmStart ?? 100;\n      return generateCompressionSpringScript({\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter: susDm,\n        activeCoils: geometry.activeCoils,\n        totalCoils: geometry.totalCoils ?? geometry.activeCoils + 2,\n        freeLength: geometry.freeLength ?? 100,\n      });\n    case \"extension\":\n      return generateExtensionSpringScript({\n        wireDiameter: geometry.wireDiameter,\n        outerDiameter: geometry.outerDiameter,\n        activeCoils: geometry.activeCoils,\n        bodyLength: geometry.bodyLength,\n        hookType: geometry.hookType ?? \"machine\",\n      });\n    case \"torsion\":\n      return generateTorsionSpringScript({\n        wireDiameter: geometry.wireDiameter,\n        meanDiameter: geometry.meanDiameter,\n        activeCoils: geometry.activeCoils,\n        bodyLength: geometry.bodyLength ?? geometry.activeCoils * geometry.wireDiameter,\n        legLength1: geometry.legLength1,\n        legLength2: geometry.legLength2,\n        windingDirection: geometry.windingDirection ?? \"right\",\n      });\n    case \"conical\":\n      return generateConicalSpringScript({\n        wireDiameter: geometry.wireDiameter,\n        largeOuterDiameter: geometry.largeOuterDiameter,\n        smallOuterDiameter: geometry.smallOuterDiameter,\n        activeCoils: geometry.activeCoils,\n        freeLength: geometry.freeLength,\n      });\n    case \"spiralTorsion\":\n      return generateSpiralTorsionSpringScript({\n        innerDiameter: geometry.innerDiameter,\n        outerDiameter: geometry.outerDiameter,\n        turns: geometry.activeCoils,\n        stripWidth: geometry.stripWidth,\n        stripThickness: geometry.stripThickness,\n        handedness: \"ccw\",\n      });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/drawing/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/drawing/springDrawingGenerator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Point2D' is defined but never used.","line":16,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":16,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Spline2D' is defined but never used.","line":20,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ToleranceSpec' is defined but never used.","line":22,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":22,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TorsionGeometry' is defined but never used.","line":30,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":30,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ConicalGeometry' is defined but never used.","line":31,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'generateExtensionFrontView' is defined but never used.","line":212,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":212,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'hookType' is assigned a value but never used.","line":216,"column":80,"nodeType":null,"messageId":"unusedVar","endLine":216,"endColumn":88},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ID' is assigned a value but never used.","line":219,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":219,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Drawing Generator\n * 弹簧工程图生成器\n * \n * 从参数化弹簧设计生成 2D 工程图规格\n * 包括视图布局、尺寸标注、技术要求\n */\n\nimport type {\n  SpringDrawingSpec,\n  ViewSpec,\n  ViewGeometry,\n  DimensionSpec,\n  TechnicalNote,\n  TitleBlockSpec,\n  Point2D,\n  Line2D,\n  Arc2D,\n  Circle2D,\n  Spline2D,\n  GeometryElement,\n  ToleranceSpec,\n  DrawingStandard,\n  SheetSize,\n} from \"./types\";\nimport type { \n  SpringGeometry,\n  CompressionGeometry,\n  ExtensionGeometry,\n  TorsionGeometry,\n  ConicalGeometry,\n  MaterialInfo,\n  AnalysisResult,\n} from \"@/lib/stores/springDesignStore\";\n\n// ============================================================================\n// 默认公差规则\n// ============================================================================\n\nconst DEFAULT_TOLERANCES = {\n  wireDiameter: { type: \"symmetric\" as const, symmetric: 0.02 },\n  meanDiameter: { type: \"symmetric\" as const, symmetric: 0.3 },\n  freeLength: { type: \"deviation\" as const, upper: 1.0, lower: -1.0 },\n  bodyLength: { type: \"deviation\" as const, upper: 0.5, lower: -0.5 },\n  legLength: { type: \"symmetric\" as const, symmetric: 1.0 },\n  angle: { type: \"symmetric\" as const, symmetric: 3 },\n};\n\n// ============================================================================\n// 2D 投影算法\n// ============================================================================\n\n/**\n * 生成压缩弹簧主视图几何\n */\nfunction generateCompressionFrontView(\n  geometry: CompressionGeometry,\n  scale: number\n): GeometryElement[] {\n  const { wireDiameter: d, meanDiameter: Dm, activeCoils: Na, totalCoils: Nt = Na + 2, freeLength: L0 = 50 } = geometry;\n  const elements: GeometryElement[] = [];\n  \n  const OD = (Dm ?? 20) + d;\n  const ID = (Dm ?? 20) - d;\n  const pitch = L0 / Na;\n  \n  // 缩放因子\n  const s = scale;\n  \n  // 外轮廓线（左右两条竖线）\n  elements.push({\n    id: \"outline-left\",\n    start: { x: -OD/2 * s, y: 0 },\n    end: { x: -OD/2 * s, y: L0 * s },\n    style: \"solid\",\n    weight: 0.5,\n  });\n  \n  elements.push({\n    id: \"outline-right\",\n    start: { x: OD/2 * s, y: 0 },\n    end: { x: OD/2 * s, y: L0 * s },\n    style: \"solid\",\n    weight: 0.5,\n  });\n  \n  // 螺旋线投影（简化为锯齿线）\n  const coilLines: Line2D[] = [];\n  for (let i = 0; i < Nt; i++) {\n    const y1 = i * pitch * s;\n    const y2 = (i + 0.5) * pitch * s;\n    const y3 = (i + 1) * pitch * s;\n    \n    // 左侧螺旋\n    coilLines.push({\n      id: `coil-left-${i}-1`,\n      start: { x: -OD/2 * s, y: y1 },\n      end: { x: -ID/2 * s, y: y2 },\n      style: \"solid\",\n      weight: 0.35,\n    });\n    coilLines.push({\n      id: `coil-left-${i}-2`,\n      start: { x: -ID/2 * s, y: y2 },\n      end: { x: -OD/2 * s, y: y3 },\n      style: \"solid\",\n      weight: 0.35,\n    });\n    \n    // 右侧螺旋\n    coilLines.push({\n      id: `coil-right-${i}-1`,\n      start: { x: OD/2 * s, y: y1 },\n      end: { x: ID/2 * s, y: y2 },\n      style: \"solid\",\n      weight: 0.35,\n    });\n    coilLines.push({\n      id: `coil-right-${i}-2`,\n      start: { x: ID/2 * s, y: y2 },\n      end: { x: OD/2 * s, y: y3 },\n      style: \"solid\",\n      weight: 0.35,\n    });\n  }\n  elements.push(...coilLines);\n  \n  // 中心线\n  elements.push({\n    id: \"centerline-v\",\n    start: { x: 0, y: -5 * s },\n    end: { x: 0, y: (L0 + 5) * s },\n    style: \"centerline\",\n    weight: 0.25,\n  });\n  \n  // 顶部和底部端面线\n  elements.push({\n    id: \"end-bottom\",\n    start: { x: -OD/2 * s, y: 0 },\n    end: { x: OD/2 * s, y: 0 },\n    style: \"solid\",\n    weight: 0.5,\n  });\n  \n  elements.push({\n    id: \"end-top\",\n    start: { x: -OD/2 * s, y: L0 * s },\n    end: { x: OD/2 * s, y: L0 * s },\n    style: \"solid\",\n    weight: 0.5,\n  });\n  \n  return elements;\n}\n\n/**\n * 生成压缩弹簧俯视图几何\n */\nfunction generateCompressionTopView(\n  geometry: CompressionGeometry,\n  scale: number\n): GeometryElement[] {\n  const { wireDiameter: d, meanDiameter: Dm } = geometry;\n  const elements: GeometryElement[] = [];\n  \n  const OD = Dm + d;\n  const ID = Dm - d;\n  const s = scale;\n  \n  // 外圆\n  elements.push({\n    id: \"outer-circle\",\n    center: { x: 0, y: 0 },\n    radius: OD/2 * s,\n    style: \"solid\",\n    weight: 0.5,\n  } as Circle2D);\n  \n  // 内圆\n  elements.push({\n    id: \"inner-circle\",\n    center: { x: 0, y: 0 },\n    radius: ID/2 * s,\n    style: \"solid\",\n    weight: 0.5,\n  } as Circle2D);\n  \n  // 中心线\n  elements.push({\n    id: \"centerline-h\",\n    start: { x: -(OD/2 + 5) * s, y: 0 },\n    end: { x: (OD/2 + 5) * s, y: 0 },\n    style: \"centerline\",\n    weight: 0.25,\n  });\n  \n  elements.push({\n    id: \"centerline-v\",\n    start: { x: 0, y: -(OD/2 + 5) * s },\n    end: { x: 0, y: (OD/2 + 5) * s },\n    style: \"centerline\",\n    weight: 0.25,\n  });\n  \n  return elements;\n}\n\n/**\n * 生成拉伸弹簧主视图几何\n */\nfunction generateExtensionFrontView(\n  geometry: ExtensionGeometry,\n  scale: number\n): GeometryElement[] {\n  const { wireDiameter: d, outerDiameter: OD, activeCoils: Na, bodyLength: Lb, hookType } = geometry;\n  const elements: GeometryElement[] = [];\n  \n  const ID = OD - 2 * d;\n  const Dm = OD - d;\n  const s = scale;\n  \n  // 本体轮廓\n  elements.push({\n    id: \"body-left\",\n    start: { x: -OD/2 * s, y: 0 },\n    end: { x: -OD/2 * s, y: Lb * s },\n    style: \"solid\",\n    weight: 0.5,\n  });\n  \n  elements.push({\n    id: \"body-right\",\n    start: { x: OD/2 * s, y: 0 },\n    end: { x: OD/2 * s, y: Lb * s },\n    style: \"solid\",\n    weight: 0.5,\n  });\n  \n  // 密绕线圈（紧密排列）\n  for (let i = 0; i < Na; i++) {\n    const y = i * d * s;\n    elements.push({\n      id: `coil-${i}`,\n      start: { x: -OD/2 * s, y: y },\n      end: { x: OD/2 * s, y: y },\n      style: \"solid\",\n      weight: 0.25,\n    });\n  }\n  \n  // 钩部简化表示\n  const hookRadius = Dm / 2;\n  \n  // 底部钩\n  elements.push({\n    id: \"hook-bottom\",\n    center: { x: 0, y: -hookRadius * s },\n    radius: hookRadius * s,\n    startAngle: 0,\n    endAngle: 180,\n    style: \"solid\",\n    weight: 0.5,\n  } as Arc2D);\n  \n  // 顶部钩\n  elements.push({\n    id: \"hook-top\",\n    center: { x: 0, y: (Lb + hookRadius) * s },\n    radius: hookRadius * s,\n    startAngle: 180,\n    endAngle: 360,\n    style: \"solid\",\n    weight: 0.5,\n  } as Arc2D);\n  \n  // 中心线\n  elements.push({\n    id: \"centerline\",\n    start: { x: 0, y: (-hookRadius * 2 - 5) * s },\n    end: { x: 0, y: (Lb + hookRadius * 2 + 5) * s },\n    style: \"centerline\",\n    weight: 0.25,\n  });\n  \n  return elements;\n}\n\n// ============================================================================\n// 尺寸标注生成\n// ============================================================================\n\n/**\n * 生成压缩弹簧尺寸标注\n */\nfunction generateCompressionDimensions(\n  geometry: CompressionGeometry,\n  viewId: string,\n  scale: number\n): DimensionSpec[] {\n  const { wireDiameter: d, meanDiameter: Dm, activeCoils: Na, totalCoils: Nt, freeLength: L0 } = geometry;\n  const dimensions: DimensionSpec[] = [];\n  \n  const OD = Dm + d;\n  const s = scale;\n  \n  // 尺寸标注位置规划 (避免重叠)\n  // - 线径 d: 左侧上方\n  // - 外径 OD: 底部\n  // - 自由长度 L0: 右侧\n  // - Na, Nt: 右侧引出线\n  \n  // 线径 d (左侧，指向线圈截面)\n  dimensions.push({\n    id: \"dim-d\",\n    type: \"linear\",\n    label: \"d\",\n    value: d,\n    unit: \"mm\",\n    tolerance: DEFAULT_TOLERANCES.wireDiameter,\n    fromPoint: { x: -OD/2 * s - 5, y: L0 * 0.8 * s },\n    toPoint: { x: (-OD/2 + d) * s - 5, y: L0 * 0.8 * s },\n    orientation: \"horizontal\",\n    viewId,\n    offset: 25,\n  });\n  \n  // 外径 OD (底部，水平标注)\n  dimensions.push({\n    id: \"dim-OD\",\n    type: \"diameter\",\n    label: \"OD\",\n    value: OD,\n    unit: \"mm\",\n    tolerance: DEFAULT_TOLERANCES.meanDiameter,\n    fromPoint: { x: -OD/2 * s, y: -5 },\n    toPoint: { x: OD/2 * s, y: -5 },\n    orientation: \"horizontal\",\n    viewId,\n    offset: 15,\n    prefix: \"⌀\",\n  });\n  \n  // 自由长度 L0 (右侧，垂直标注)\n  dimensions.push({\n    id: \"dim-L0\",\n    type: \"linear\",\n    label: \"L₀\",\n    value: L0,\n    unit: \"mm\",\n    tolerance: DEFAULT_TOLERANCES.freeLength,\n    fromPoint: { x: OD/2 * s + 15, y: 0 },\n    toPoint: { x: OD/2 * s + 15, y: L0 * s },\n    orientation: \"vertical\",\n    viewId,\n    offset: 20,\n  });\n  \n  // 有效圈数 Na（参考尺寸，右上方引出）\n  dimensions.push({\n    id: \"dim-Na\",\n    type: \"leader\",\n    label: \"Na\",\n    value: Na,\n    fromPoint: { x: OD/2 * s + 35, y: L0 * 0.65 * s },\n    toPoint: { x: OD/2 * s + 55, y: L0 * 0.65 * s },\n    orientation: \"horizontal\",\n    viewId,\n    isReference: true,\n  });\n  \n  // 总圈数 Nt（参考尺寸，右下方引出）\n  dimensions.push({\n    id: \"dim-Nt\",\n    type: \"leader\",\n    label: \"Nt\",\n    value: Nt,\n    fromPoint: { x: OD/2 * s + 35, y: L0 * 0.35 * s },\n    toPoint: { x: OD/2 * s + 55, y: L0 * 0.35 * s },\n    orientation: \"horizontal\",\n    viewId,\n    isReference: true,\n  });\n  \n  return dimensions;\n}\n\n// ============================================================================\n// 技术要求生成\n// ============================================================================\n\n/**\n * 生成压缩弹簧技术要求\n */\nfunction generateCompressionTechnicalNotes(\n  geometry: CompressionGeometry,\n  material: MaterialInfo,\n  analysis?: AnalysisResult\n): TechnicalNote[] {\n  const notes: TechnicalNote[] = [];\n  let index = 1;\n  \n  // 材料\n  notes.push({\n    index: index++,\n    textEn: `Material: ${material.name}`,\n    textZh: `材料：${material.name}`,\n  });\n  \n  // 表面处理\n  notes.push({\n    index: index++,\n    textEn: \"Surface treatment: Zinc plating or as specified\",\n    textZh: \"表面处理：镀锌或按规定\",\n  });\n  \n  // 端面磨平\n  if (geometry.topGround || geometry.bottomGround) {\n    const groundText = geometry.topGround && geometry.bottomGround \n      ? \"both ends\" \n      : geometry.topGround ? \"top end\" : \"bottom end\";\n    notes.push({\n      index: index++,\n      textEn: `Ground ends: ${groundText}`,\n      textZh: `端面磨平：${groundText === \"both ends\" ? \"两端\" : groundText === \"top end\" ? \"顶端\" : \"底端\"}`,\n    });\n  }\n  \n  // 刚度\n  if (analysis?.springRate) {\n    notes.push({\n      index: index++,\n      textEn: `Spring rate: ${analysis.springRate.toFixed(2)} N/mm ±10%`,\n      textZh: `弹簧刚度：${analysis.springRate.toFixed(2)} N/mm ±10%`,\n    });\n  }\n  \n  // 旋向\n  notes.push({\n    index: index++,\n    textEn: \"Winding direction: Right hand (unless specified)\",\n    textZh: \"旋向：右旋（除非另有规定）\",\n  });\n  \n  // 未注公差\n  notes.push({\n    index: index++,\n    textEn: \"General tolerances: ISO 2768-mK\",\n    textZh: \"未注公差：ISO 2768-mK\",\n  });\n  \n  return notes;\n}\n\n// ============================================================================\n// 主生成函数\n// ============================================================================\n\n/**\n * 生成弹簧工程图规格\n */\nexport function generateSpringDrawingSpec(\n  geometry: SpringGeometry,\n  material: MaterialInfo,\n  analysis?: AnalysisResult,\n  options?: {\n    standard?: DrawingStandard;\n    sheetSize?: SheetSize;\n    language?: \"en\" | \"zh\" | \"de\" | \"bilingual\";\n    drawnBy?: string;\n  }\n): SpringDrawingSpec {\n  const {\n    standard = \"ISO\",\n    sheetSize = \"A4\",\n    language = \"bilingual\",\n    drawnBy = \"CAD System\",\n  } = options ?? {};\n  \n  const scale = 2; // 2:1 放大\n  const now = new Date().toISOString().split(\"T\")[0];\n  \n  // 标题栏\n  const titleBlock: TitleBlockSpec = {\n    partName: `${geometry.type.charAt(0).toUpperCase() + geometry.type.slice(1)} Spring`,\n    partNameZh: geometry.type === \"compression\" ? \"压缩弹簧\" \n      : geometry.type === \"extension\" ? \"拉伸弹簧\"\n      : geometry.type === \"torsion\" ? \"扭转弹簧\" : \"锥形弹簧\",\n    partNumber: `SP-${geometry.type.toUpperCase().slice(0, 2)}-${Date.now().toString(36).toUpperCase()}`,\n    material: material.name,\n    scale: `${scale}:1`,\n    drawnBy,\n    drawnDate: now,\n  };\n  \n  // 视图\n  const views: ViewSpec[] = [];\n  const viewGeometries: ViewGeometry[] = [];\n  const dimensions: DimensionSpec[] = [];\n  let technicalNotes: TechnicalNote[] = [];\n  \n  if (geometry.type === \"compression\") {\n    // 主视图\n    views.push({\n      id: \"front\",\n      name: \"Front View\",\n      nameZh: \"主视图\",\n      projection: \"front\",\n      scale,\n      position: { x: 80, y: 120 },\n      showCenterLines: true,\n    });\n    \n    const frontElements = generateCompressionFrontView(geometry, scale);\n    viewGeometries.push({\n      viewId: \"front\",\n      elements: frontElements,\n      boundingBox: calculateBoundingBox(frontElements),\n    });\n    \n    // 俯视图\n    views.push({\n      id: \"top\",\n      name: \"Top View\",\n      nameZh: \"俯视图\",\n      projection: \"top\",\n      scale,\n      position: { x: 200, y: 120 },\n      showCenterLines: true,\n    });\n    \n    const topElements = generateCompressionTopView(geometry, scale);\n    viewGeometries.push({\n      viewId: \"top\",\n      elements: topElements,\n      boundingBox: calculateBoundingBox(topElements),\n    });\n    \n    // 尺寸标注\n    dimensions.push(...generateCompressionDimensions(geometry, \"front\", scale));\n    \n    // 技术要求\n    technicalNotes = generateCompressionTechnicalNotes(geometry, material, analysis);\n  }\n  \n  // TODO: 添加其他弹簧类型的视图生成\n  \n  return {\n    standard,\n    sheetSize,\n    orientation: \"landscape\",\n    titleBlock,\n    views,\n    viewGeometries,\n    dimensions,\n    technicalNotes,\n    language,\n  };\n}\n\n/**\n * 计算几何元素的边界框\n */\nfunction calculateBoundingBox(elements: GeometryElement[]): {\n  minX: number;\n  minY: number;\n  maxX: number;\n  maxY: number;\n} {\n  let minX = Infinity, minY = Infinity;\n  let maxX = -Infinity, maxY = -Infinity;\n  \n  for (const el of elements) {\n    if (\"start\" in el && \"end\" in el) {\n      // Line\n      minX = Math.min(minX, el.start.x, el.end.x);\n      minY = Math.min(minY, el.start.y, el.end.y);\n      maxX = Math.max(maxX, el.start.x, el.end.x);\n      maxY = Math.max(maxY, el.start.y, el.end.y);\n    } else if (\"center\" in el && \"radius\" in el) {\n      // Circle or Arc\n      minX = Math.min(minX, el.center.x - el.radius);\n      minY = Math.min(minY, el.center.y - el.radius);\n      maxX = Math.max(maxX, el.center.x + el.radius);\n      maxY = Math.max(maxY, el.center.y + el.radius);\n    } else if (\"points\" in el) {\n      // Spline\n      for (const p of el.points) {\n        minX = Math.min(minX, p.x);\n        minY = Math.min(minY, p.y);\n        maxX = Math.max(maxX, p.x);\n        maxY = Math.max(maxY, p.y);\n      }\n    }\n  }\n  \n  return { minX, minY, maxX, maxY };\n}\n\nexport { DEFAULT_TOLERANCES };\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/drawing/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/eds/__tests__/compressionRegression.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/eds/compressionResolver.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/eds/engineeringDefinition.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/eds/legacyAdapters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/SpringAnalysisEngine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/__tests__/springAnalysisAudit.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculateSpringRate' is defined but never used.","line":10,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculateNominalShearStress' is defined but never used.","line":11,"column":55,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":82},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'expectedStress' is assigned a value but never used.","line":130,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":130,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Comprehensive Audit Test\n * 弹簧分析引擎 - 全面审计测试\n * \n * Validates calculations for all spring types against known formulas\n */\n\nimport { describe, test, expect, beforeAll } from 'vitest';\nimport { SpringAnalysisEngine } from '../SpringAnalysisEngine';\nimport { calculateSpringRate } from '../forceCurve';\nimport { calculateWahlFactor, calculateBendingStress, calculateNominalShearStress } from '../stress';\nimport type { \n  CompressionSpringGeometry, \n  ExtensionSpringGeometry, \n  TorsionSpringGeometry, \n  ConicalSpringGeometry,\n  WorkingConditions \n} from '../types';\n\nconst PI = Math.PI;\n\n// ============================================================================\n// Test Data - Standard Spring Configurations\n// ============================================================================\n\nconst compressionSpring: CompressionSpringGeometry = {\n  type: 'compression',\n  wireDiameter: 3.0,        // d = 3mm\n  meanDiameter: 24.0,       // Dm = 24mm\n  activeCoils: 8,           // Na = 8\n  totalCoils: 10,           // Nt = 10\n  freeLength: 50.0,         // L0 = 50mm\n  endType: 'closed_ground',\n  materialId: 'music_wire_a228',\n};\n\nconst extensionSpring: ExtensionSpringGeometry = {\n  type: 'extension',\n  wireDiameter: 2.0,        // d = 2mm\n  meanDiameter: 16.0,       // Dm = 16mm\n  activeCoils: 10,          // Na = 10\n  bodyLength: 30.0,         // Body length\n  initialTension: 10,       // F0 = 10N\n  hookType: 'machine',\n  materialId: 'music_wire_a228',\n};\n\nconst torsionSpring: TorsionSpringGeometry = {\n  type: 'torsion',\n  wireDiameter: 1.5,        // d = 1.5mm\n  meanDiameter: 12.0,       // Dm = 12mm\n  activeCoils: 6,           // Na = 6\n  bodyLength: 12.0,         // Body length\n  legLength1: 25.0,         // Leg 1\n  legLength2: 25.0,         // Leg 2\n  legAngle: 90,\n  materialId: 'music_wire_a228',\n};\n\nconst conicalSpring: ConicalSpringGeometry = {\n  type: 'conical',\n  wireDiameter: 2.5,        // d = 2.5mm\n  largeOuterDiameter: 30.0, // D1 = 30mm\n  smallOuterDiameter: 15.0, // D2 = 15mm\n  activeCoils: 6,           // Na = 6\n  freeLength: 40.0,         // L0 = 40mm\n  materialId: 'music_wire_a228',\n};\n\nconst workingConditions: WorkingConditions = {\n  minDeflection: 5,\n  maxDeflection: 20,\n  temperature: 20,\n  targetCycles: 1e6,\n};\n\n// ============================================================================\n// Compression Spring Tests\n// ============================================================================\n\ndescribe('Compression Spring Analysis', () => {\n  let engine: SpringAnalysisEngine;\n  \n  beforeAll(() => {\n    engine = new SpringAnalysisEngine(compressionSpring, workingConditions);\n  });\n\n  test('Spring rate formula: k = Gd⁴ / (8Dm³Na)', () => {\n    const G = 79300; // Music wire shear modulus (MPa)\n    const d = compressionSpring.wireDiameter;\n    const Dm = compressionSpring.meanDiameter;\n    const Na = compressionSpring.activeCoils;\n    \n    // Expected: k = 79300 × 3⁴ / (8 × 24³ × 8) = 79300 × 81 / (8 × 13824 × 8)\n    const expectedRate = (G * Math.pow(d, 4)) / (8 * Math.pow(Dm, 3) * Na);\n    const calculatedRate = engine.getSpringRate();\n    \n    console.log(`Compression Spring Rate: Expected=${expectedRate.toFixed(2)}, Calculated=${calculatedRate.toFixed(2)}`);\n    expect(calculatedRate).toBeCloseTo(expectedRate, 1);\n  });\n\n  test('Spring index: C = Dm/d', () => {\n    const geometry = engine.getGeometry();\n    const expectedIndex = compressionSpring.meanDiameter / compressionSpring.wireDiameter;\n    \n    expect(geometry.springIndex).toBeCloseTo(expectedIndex, 2);\n    expect(geometry.springIndex).toBe(8); // 24/3 = 8\n  });\n\n  test('Wahl factor formula: Kw = (4C-1)/(4C-4) + 0.615/C', () => {\n    const C = 8;\n    const expectedWahl = (4 * C - 1) / (4 * C - 4) + 0.615 / C;\n    const calculatedWahl = calculateWahlFactor(C);\n    \n    console.log(`Wahl Factor (C=8): Expected=${expectedWahl.toFixed(4)}, Calculated=${calculatedWahl.toFixed(4)}`);\n    expect(calculatedWahl).toBeCloseTo(expectedWahl, 4);\n  });\n\n  test('Shear stress formula: τ = 8FDm / (πd³) × Kw', () => {\n    const springRate = engine.getSpringRate();\n    const force = springRate * workingConditions.maxDeflection;\n    const stress = engine.getMaxStress();\n    \n    const d = compressionSpring.wireDiameter;\n    const Dm = compressionSpring.meanDiameter;\n    const C = Dm / d;\n    const Kw = calculateWahlFactor(C);\n    \n    const tauNominal = (8 * force * Dm) / (PI * Math.pow(d, 3));\n    const expectedStress = tauNominal * Kw;\n    \n    console.log(`Compression Stress: Force=${force.toFixed(1)}N, τ_nominal=${tauNominal.toFixed(1)}MPa, τ_effective=${stress.tauEffective.toFixed(1)}MPa`);\n    \n    // Note: tauEffective includes additional factors (surface, size, temp)\n    expect(stress.tauNominal).toBeCloseTo(tauNominal, 0);\n    expect(stress.wahlFactor).toBeCloseTo(Kw, 3);\n  });\n\n  test('Safety factor: SF = τ_allow / τ_effective', () => {\n    const safety = engine.getSafetyFactor();\n    const stress = engine.getMaxStress();\n    \n    // Music wire A228 allowable stress is around 600-700 MPa\n    expect(safety.staticSafetyFactor).toBeGreaterThan(0);\n    expect(safety.allowableStress).toBeGreaterThan(0);\n    \n    const expectedSF = safety.allowableStress / stress.tauEffective;\n    expect(safety.staticSafetyFactor).toBeCloseTo(expectedSF, 2);\n    \n    console.log(`Compression Safety: SF=${safety.staticSafetyFactor.toFixed(2)}, Status=${safety.status}`);\n  });\n\n  test('Buckling analysis available for compression springs', () => {\n    const buckling = engine.getBuckling();\n    expect(buckling).toBeDefined();\n    expect(buckling?.slendernessRatio).toBeGreaterThan(0);\n    \n    console.log(`Buckling: λ=${buckling?.slendernessRatio.toFixed(2)}, Status=${buckling?.status}`);\n  });\n});\n\n// ============================================================================\n// Extension Spring Tests\n// ============================================================================\n\ndescribe('Extension Spring Analysis', () => {\n  let engine: SpringAnalysisEngine;\n  \n  beforeAll(() => {\n    engine = new SpringAnalysisEngine(extensionSpring, workingConditions);\n  });\n\n  test('Spring rate same formula as compression', () => {\n    const G = 79300;\n    const d = extensionSpring.wireDiameter;\n    const Dm = extensionSpring.meanDiameter;\n    const Na = extensionSpring.activeCoils;\n    \n    const expectedRate = (G * Math.pow(d, 4)) / (8 * Math.pow(Dm, 3) * Na);\n    const calculatedRate = engine.getSpringRate();\n    \n    console.log(`Extension Spring Rate: Expected=${expectedRate.toFixed(2)}, Calculated=${calculatedRate.toFixed(2)}`);\n    expect(calculatedRate).toBeCloseTo(expectedRate, 1);\n  });\n\n  test('Force includes initial tension: F = F0 + k×δ', () => {\n    const springRate = engine.getSpringRate();\n    const maxDeflection = workingConditions.maxDeflection;\n    const initialTension = extensionSpring.initialTension;\n    \n    const expectedForce = initialTension + springRate * maxDeflection;\n    const stress = engine.getMaxStress();\n    \n    // Verify stress is calculated with total force\n    const d = extensionSpring.wireDiameter;\n    const Dm = extensionSpring.meanDiameter;\n    const tauNominal = (8 * expectedForce * Dm) / (PI * Math.pow(d, 3));\n    \n    console.log(`Extension Force: F0=${initialTension}N, k×δ=${(springRate * maxDeflection).toFixed(1)}N, Total=${expectedForce.toFixed(1)}N`);\n    expect(stress.tauNominal).toBeCloseTo(tauNominal, 0);\n  });\n\n  test('No buckling analysis for extension springs', () => {\n    const buckling = engine.getBuckling();\n    expect(buckling).toBeUndefined();\n  });\n});\n\n// ============================================================================\n// Torsion Spring Tests\n// ============================================================================\n\ndescribe('Torsion Spring Analysis', () => {\n  let engine: SpringAnalysisEngine;\n  \n  beforeAll(() => {\n    engine = new SpringAnalysisEngine(torsionSpring, workingConditions);\n  });\n\n  test('Spring rate formula: k = Ed⁴ / (10.8×Dm×Na) × (π/180)', () => {\n    const E = 207000; // Elastic modulus (MPa)\n    const d = torsionSpring.wireDiameter;\n    const Dm = torsionSpring.meanDiameter;\n    const Na = torsionSpring.activeCoils;\n    \n    // Rate in N·mm per radian, then convert to per degree\n    const k_rad = (E * Math.pow(d, 4)) / (10.8 * Dm * Na);\n    const expectedRate = k_rad * (PI / 180);\n    const calculatedRate = engine.getSpringRate();\n    \n    console.log(`Torsion Spring Rate: Expected=${expectedRate.toFixed(2)} N·mm/deg, Calculated=${calculatedRate.toFixed(2)} N·mm/deg`);\n    expect(calculatedRate).toBeCloseTo(expectedRate, 1);\n  });\n\n  test('Bending stress formula: σ = Ki × 32M / (πd³)', () => {\n    const d = torsionSpring.wireDiameter;\n    const Dm = torsionSpring.meanDiameter;\n    const C = Dm / d;\n    \n    // Inner fiber stress concentration factor\n    const Ki = (4 * C * C - C - 1) / (4 * C * (C - 1));\n    \n    const torque = 100; // Test torque in N·mm\n    const expectedBendingStress = Ki * (32 * torque) / (PI * Math.pow(d, 3));\n    const calculatedBendingStress = calculateBendingStress(torque, Dm, d);\n    \n    console.log(`Torsion Bending Stress: Ki=${Ki.toFixed(3)}, Expected=${expectedBendingStress.toFixed(1)}MPa, Calculated=${calculatedBendingStress.toFixed(1)}MPa`);\n    expect(calculatedBendingStress).toBeCloseTo(expectedBendingStress, 0);\n  });\n\n  test('No buckling analysis for torsion springs', () => {\n    const buckling = engine.getBuckling();\n    expect(buckling).toBeUndefined();\n  });\n});\n\n// ============================================================================\n// Conical Spring Tests\n// ============================================================================\n\ndescribe('Conical Spring Analysis', () => {\n  let engine: SpringAnalysisEngine;\n  \n  beforeAll(() => {\n    engine = new SpringAnalysisEngine(conicalSpring, workingConditions);\n  });\n\n  test('Spring rate formula: k = Gd⁴ / (2Na(D1+D2)(D1²+D2²))', () => {\n    const G = 79300;\n    const d = conicalSpring.wireDiameter;\n    const D1 = conicalSpring.largeOuterDiameter - d; // Large mean diameter\n    const D2 = conicalSpring.smallOuterDiameter - d; // Small mean diameter\n    const Na = conicalSpring.activeCoils;\n    \n    const expectedRate = (G * Math.pow(d, 4)) / \n                         (2 * Na * (D1 + D2) * (D1 * D1 + D2 * D2));\n    const calculatedRate = engine.getSpringRate();\n    \n    console.log(`Conical Spring Rate: Expected=${expectedRate.toFixed(2)}, Calculated=${calculatedRate.toFixed(2)}`);\n    expect(calculatedRate).toBeCloseTo(expectedRate, 1);\n  });\n\n  test('Maximum stress at large end', () => {\n    const stress = engine.getMaxStress();\n    const springRate = engine.getSpringRate();\n    const force = springRate * workingConditions.maxDeflection;\n    \n    const d = conicalSpring.wireDiameter;\n    const D1 = conicalSpring.largeOuterDiameter - d; // Large mean diameter\n    \n    // Stress should be calculated at large end (highest stress)\n    const tauNominalLarge = (8 * force * D1) / (PI * Math.pow(d, 3));\n    \n    console.log(`Conical Stress: Force=${force.toFixed(1)}N, τ_nominal(large)=${tauNominalLarge.toFixed(1)}MPa, τ_nominal(calc)=${stress.tauNominal.toFixed(1)}MPa`);\n    expect(stress.tauNominal).toBeCloseTo(tauNominalLarge, 0);\n  });\n\n  test('Nonlinear force curve with coil collapse', () => {\n    const curve = engine.getForceCurve(20);\n    \n    // Conical springs have increasing stiffness as coils collapse\n    expect(curve.length).toBeGreaterThan(0);\n    \n    // Check that stiffness increases (or stays same) as deflection increases\n    for (let i = 1; i < curve.length; i++) {\n      expect(curve[i].stiffness).toBeGreaterThanOrEqual(curve[i-1].stiffness * 0.99); // Allow small tolerance\n    }\n    \n    console.log(`Conical Force Curve: ${curve.length} points, Initial k=${curve[0].stiffness.toFixed(2)}, Final k=${curve[curve.length-1].stiffness.toFixed(2)}`);\n  });\n\n  test('No buckling analysis for conical springs', () => {\n    const buckling = engine.getBuckling();\n    expect(buckling).toBeUndefined();\n  });\n});\n\n// ============================================================================\n// Cross-Type Validation\n// ============================================================================\n\ndescribe('Cross-Type Validation', () => {\n  test('All spring types produce valid analysis results', () => {\n    const springs = [\n      { name: 'Compression', geometry: compressionSpring },\n      { name: 'Extension', geometry: extensionSpring },\n      { name: 'Torsion', geometry: torsionSpring },\n      { name: 'Conical', geometry: conicalSpring },\n    ];\n\n    for (const { name, geometry } of springs) {\n      const engine = new SpringAnalysisEngine(geometry, workingConditions);\n      const result = engine.analyze();\n\n      console.log(`\\n=== ${name} Spring Analysis ===`);\n      console.log(`  Spring Rate: ${result.springRate.toFixed(2)}`);\n      console.log(`  Max Stress: ${result.stress.tauEffective.toFixed(1)} MPa`);\n      console.log(`  Safety Factor: ${result.safety.staticSafetyFactor.toFixed(2)} (${result.safety.status})`);\n      console.log(`  Fatigue Life: ${result.fatigue.estimatedCycles.toExponential(1)} cycles (${result.fatigue.rating})`);\n      \n      // Validate all results are reasonable\n      expect(result.springRate).toBeGreaterThan(0);\n      expect(result.stress.tauEffective).toBeGreaterThan(0);\n      expect(result.safety.staticSafetyFactor).toBeGreaterThan(0);\n      expect(result.fatigue.estimatedCycles).toBeGreaterThan(0);\n      expect(result.forceCurve.length).toBeGreaterThan(0);\n    }\n  });\n\n  test('Safety factor correctly identifies unsafe designs', () => {\n    // Create an unsafe design with very high stress\n    const unsafeSpring: CompressionSpringGeometry = {\n      ...compressionSpring,\n      wireDiameter: 0.8,      // Very thin wire\n      meanDiameter: 25.0,     // Large diameter\n      activeCoils: 3,         // Few coils = high rate\n    };\n\n    const engine = new SpringAnalysisEngine(unsafeSpring, {\n      ...workingConditions,\n      maxDeflection: 40,      // Large deflection to create high stress\n    });\n\n    const result = engine.analyze();\n    \n    console.log(`\\nUnsafe Design Test:`);\n    console.log(`  Spring Rate: ${result.springRate.toFixed(2)}`);\n    console.log(`  Max Stress: ${result.stress.tauEffective.toFixed(1)} MPa`);\n    console.log(`  Safety Factor: ${result.safety.staticSafetyFactor.toFixed(2)}`);\n    console.log(`  Status: ${result.safety.status}`);\n\n    // This design should have low or dangerous safety factor (< 1.5)\n    expect(result.safety.staticSafetyFactor).toBeLessThan(1.5);\n  });\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/__tests__/springFormulas.test.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":14,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":14,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Formula Verification Tests\n * 弹簧公式验证测试\n * \n * 测试策略：\n * 1. 与手册标准值对比（DIN EN 13906, SMI Handbook）\n * 2. 与已知商业软件结果对比\n * 3. 边界条件测试\n * 4. 单位一致性测试\n * \n * @see docs/SPRING_FORMULAS_VERIFICATION.md\n */\n\n// @ts-nocheck\n// 注意：运行测试前需要安装 vitest: npm install -D vitest\nimport { describe, it, expect } from 'vitest';\nimport { \n  calculateCompressionSpringRate,\n  calculateExtensionSpringRate,\n  calculateTorsionSpringRate,\n  calculateConicalSpringRate,\n} from '../forceCurve';\nimport { \n  calculateWahlFactor,\n  calculateBergstrasserFactor,\n  calculateNominalShearStress,\n  calculateBendingStress,\n} from '../stress';\nimport { calculateTorsionFrequency, calculateTorsionMass } from '../torsionAdvancedAnalysis';\nimport type { \n  CompressionSpringGeometry, \n  ExtensionSpringGeometry,\n  TorsionSpringGeometry,\n  ConicalSpringGeometry,\n} from '../types';\n\nconst PI = Math.PI;\n\n// ============================================================================\n// 测试用例：标准弹簧参数（来自 SMI Handbook）\n// ============================================================================\n\n/**\n * 标准压缩弹簧测试用例\n * 来源: SMI Handbook Example 5.1\n */\nconst COMPRESSION_SPRING_STANDARD: CompressionSpringGeometry = {\n  type: 'compression',\n  wireDiameter: 2.0,        // mm\n  meanDiameter: 16.0,       // mm (OD=18, ID=14)\n  activeCoils: 8,\n  totalCoils: 10,\n  freeLength: 50.0,         // mm\n  materialId: 'music_wire_a228',\n  endType: 'closed_ground',\n};\n\n/**\n * 标准拉伸弹簧测试用例\n */\nconst EXTENSION_SPRING_STANDARD: ExtensionSpringGeometry = {\n  type: 'extension',\n  wireDiameter: 1.5,        // mm\n  meanDiameter: 12.0,       // mm\n  activeCoils: 10,\n  bodyLength: 15.0,         // mm\n  initialTension: 5.0,      // N\n  materialId: 'music_wire_a228',\n  hookType: 'machine',\n};\n\n/**\n * 标准扭转弹簧测试用例\n */\nconst TORSION_SPRING_STANDARD: TorsionSpringGeometry = {\n  type: 'torsion',\n  wireDiameter: 2.0,        // mm\n  meanDiameter: 20.0,       // mm\n  activeCoils: 6,\n  bodyLength: 12.0,         // mm\n  legLength1: 30.0,         // mm\n  legLength2: 30.0,         // mm\n  freeAngle: 90,            // degrees\n  materialId: 'music_wire_a228',\n};\n\n/**\n * 标准锥形弹簧测试用例\n */\nconst CONICAL_SPRING_STANDARD: ConicalSpringGeometry = {\n  type: 'conical',\n  wireDiameter: 2.5,        // mm\n  largeOuterDiameter: 30.0, // mm\n  smallOuterDiameter: 15.0, // mm\n  activeCoils: 6,\n  totalCoils: 8,\n  freeLength: 40.0,         // mm\n  materialId: 'music_wire_a228',\n};\n\n// ============================================================================\n// 1. 刚度公式测试\n// ============================================================================\n\ndescribe('Spring Rate Formulas / 刚度公式', () => {\n  \n  describe('Compression Spring Rate / 压缩弹簧刚度', () => {\n    it('should match SMI Handbook formula: k = Gd⁴/(8Dm³Na)', () => {\n      const k = calculateCompressionSpringRate(COMPRESSION_SPRING_STANDARD);\n      \n      // 手动计算验证\n      // G = 79300 MPa (music wire)\n      // k = 79300 × 2⁴ / (8 × 16³ × 8)\n      // k = 79300 × 16 / (8 × 4096 × 8)\n      // k = 1268800 / 262144 = 4.84 N/mm\n      const G = 79300;\n      const d = 2.0;\n      const Dm = 16.0;\n      const Na = 8;\n      const k_expected = (G * Math.pow(d, 4)) / (8 * Math.pow(Dm, 3) * Na);\n      \n      expect(k).toBeCloseTo(k_expected, 2);\n      expect(k).toBeCloseTo(4.84, 1); // 约 4.84 N/mm\n    });\n\n    it('should increase with wire diameter to the 4th power', () => {\n      const spring1 = { ...COMPRESSION_SPRING_STANDARD, wireDiameter: 1.0 };\n      const spring2 = { ...COMPRESSION_SPRING_STANDARD, wireDiameter: 2.0 };\n      \n      const k1 = calculateCompressionSpringRate(spring1);\n      const k2 = calculateCompressionSpringRate(spring2);\n      \n      // k2/k1 should be 2⁴ = 16\n      expect(k2 / k1).toBeCloseTo(16, 1);\n    });\n\n    it('should decrease with mean diameter to the 3rd power', () => {\n      const spring1 = { ...COMPRESSION_SPRING_STANDARD, meanDiameter: 10.0 };\n      const spring2 = { ...COMPRESSION_SPRING_STANDARD, meanDiameter: 20.0 };\n      \n      const k1 = calculateCompressionSpringRate(spring1);\n      const k2 = calculateCompressionSpringRate(spring2);\n      \n      // k1/k2 should be 2³ = 8\n      expect(k1 / k2).toBeCloseTo(8, 1);\n    });\n  });\n\n  describe('Extension Spring Rate / 拉伸弹簧刚度', () => {\n    it('should have same formula as compression spring', () => {\n      const compressionSpring: CompressionSpringGeometry = {\n        ...COMPRESSION_SPRING_STANDARD,\n        wireDiameter: 1.5,\n        meanDiameter: 12.0,\n        activeCoils: 10,\n      };\n      \n      const k_compression = calculateCompressionSpringRate(compressionSpring);\n      const k_extension = calculateExtensionSpringRate(EXTENSION_SPRING_STANDARD);\n      \n      expect(k_extension).toBeCloseTo(k_compression, 2);\n    });\n  });\n\n  describe('Torsion Spring Rate / 扭转弹簧刚度', () => {\n    it('should use correct formula: k_rad = Ed⁴/(10.8×Dm×Na)', () => {\n      const k_deg = calculateTorsionSpringRate(TORSION_SPRING_STANDARD);\n      \n      // 手动计算验证\n      // E = 207000 MPa (music wire elastic modulus)\n      // k_rad = 207000 × 2⁴ / (10.8 × 20 × 6)\n      // k_rad = 207000 × 16 / 1296 = 2555.56 N·mm/rad\n      // k_deg = k_rad × (π/180) = 44.6 N·mm/deg\n      const E = 207000;\n      const d = 2.0;\n      const Dm = 20.0;\n      const Na = 6;\n      const k_rad_expected = (E * Math.pow(d, 4)) / (10.8 * Dm * Na);\n      const k_deg_expected = k_rad_expected * (PI / 180);\n      \n      expect(k_deg).toBeCloseTo(k_deg_expected, 1);\n      expect(k_deg).toBeGreaterThan(40); // 约 44.6 N·mm/deg\n      expect(k_deg).toBeLessThan(50);\n    });\n\n    it('should NOT use old incorrect formula with 64', () => {\n      // 旧的错误公式会给出更小的值\n      const E = 207000;\n      const d = 2.0;\n      const Dm = 20.0;\n      const Na = 6;\n      \n      // 错误公式 (64)\n      const k_wrong = (E * Math.pow(d, 4)) / (64 * Dm * Na) * (PI / 180);\n      \n      // 正确公式 (10.8)\n      const k_correct = calculateTorsionSpringRate(TORSION_SPRING_STANDARD);\n      \n      // 正确值应该比错误值大约 64/10.8 ≈ 5.93 倍\n      expect(k_correct / k_wrong).toBeCloseTo(64 / 10.8, 1);\n    });\n\n    it('should use elastic modulus E, not shear modulus G', () => {\n      // 扭簧使用 E（约 207000 MPa），不是 G（约 79300 MPa）\n      // 如果错误使用 G，刚度会小约 2.6 倍\n      const k = calculateTorsionSpringRate(TORSION_SPRING_STANDARD);\n      \n      // 使用 G 的错误计算\n      const G = 79300;\n      const d = 2.0;\n      const Dm = 20.0;\n      const Na = 6;\n      const k_with_G = (G * Math.pow(d, 4)) / (10.8 * Dm * Na) * (PI / 180);\n      \n      // 正确值应该比使用 G 的值大约 207000/79300 ≈ 2.6 倍\n      expect(k / k_with_G).toBeCloseTo(207000 / 79300, 1);\n    });\n  });\n\n  describe('Conical Spring Rate / 锥形弹簧刚度', () => {\n    it('should use correct formula: k = Gd⁴/(2Na(D1+D2)(D1²+D2²))', () => {\n      const k = calculateConicalSpringRate(CONICAL_SPRING_STANDARD);\n      \n      // 手动计算验证\n      const G = 79300;\n      const d = 2.5;\n      const D1 = 30.0 - 2.5; // 大端中径 = 27.5\n      const D2 = 15.0 - 2.5; // 小端中径 = 12.5\n      const Na = 6;\n      \n      const k_expected = (G * Math.pow(d, 4)) / \n                         (2 * Na * (D1 + D2) * (D1*D1 + D2*D2));\n      \n      expect(k).toBeCloseTo(k_expected, 2);\n    });\n  });\n});\n\n// ============================================================================\n// 2. 应力修正系数测试\n// ============================================================================\n\ndescribe('Stress Correction Factors / 应力修正系数', () => {\n  \n  describe('Wahl Factor / Wahl 系数', () => {\n    it('should match formula: Kw = (4C-1)/(4C-4) + 0.615/C', () => {\n      const C = 8; // 典型旋绕比\n      const Kw = calculateWahlFactor(C);\n      \n      const Kw_expected = (4*C - 1) / (4*C - 4) + 0.615 / C;\n      \n      expect(Kw).toBeCloseTo(Kw_expected, 4);\n      expect(Kw).toBeCloseTo(1.184, 2); // C=8 时约 1.184\n    });\n\n    it('should increase as C decreases (tighter coils = higher stress)', () => {\n      const Kw_C4 = calculateWahlFactor(4);\n      const Kw_C8 = calculateWahlFactor(8);\n      const Kw_C12 = calculateWahlFactor(12);\n      \n      expect(Kw_C4).toBeGreaterThan(Kw_C8);\n      expect(Kw_C8).toBeGreaterThan(Kw_C12);\n    });\n\n    it('should approach 1.0 as C approaches infinity', () => {\n      const Kw_large = calculateWahlFactor(100);\n      expect(Kw_large).toBeCloseTo(1.0, 1);\n    });\n  });\n\n  describe('Bergsträsser Factor / Bergsträsser 系数', () => {\n    it('should match formula: Kb = (4C+2)/(4C-3)', () => {\n      const C = 8;\n      const Kb = calculateBergstrasserFactor(C);\n      \n      const Kb_expected = (4*C + 2) / (4*C - 3);\n      \n      expect(Kb).toBeCloseTo(Kb_expected, 4);\n    });\n\n    it('should be slightly different from Wahl factor', () => {\n      const C = 8;\n      const Kw = calculateWahlFactor(C);\n      const Kb = calculateBergstrasserFactor(C);\n      \n      // 两者应该接近但不完全相同\n      expect(Math.abs(Kw - Kb)).toBeLessThan(0.05);\n    });\n  });\n});\n\n// ============================================================================\n// 3. 应力计算测试\n// ============================================================================\n\ndescribe('Stress Calculations / 应力计算', () => {\n  \n  describe('Shear Stress / 剪切应力', () => {\n    it('should match formula: τ = 8FDm/(πd³)', () => {\n      const F = 100; // N\n      const Dm = 16; // mm\n      const d = 2;   // mm\n      \n      const tau = calculateNominalShearStress(F, Dm, d);\n      const tau_expected = (8 * F * Dm) / (PI * Math.pow(d, 3));\n      \n      expect(tau).toBeCloseTo(tau_expected, 2);\n    });\n  });\n\n  describe('Bending Stress (Torsion Spring) / 弯曲应力', () => {\n    it('should use bending formula with Ki correction', () => {\n      const M = 1000; // N·mm\n      const Dm = 20;  // mm\n      const d = 2;    // mm\n      \n      const sigma = calculateBendingStress(M, Dm, d);\n      \n      // Ki = (4C² - C - 1) / (4C(C-1))\n      const C = Dm / d;\n      const Ki = (4*C*C - C - 1) / (4*C*(C-1));\n      const sigma_expected = Ki * (32 * M) / (PI * Math.pow(d, 3));\n      \n      expect(sigma).toBeCloseTo(sigma_expected, 1);\n    });\n  });\n});\n\n// ============================================================================\n// 4. 扭簧高级分析测试\n// ============================================================================\n\ndescribe('Torsion Spring Advanced Analysis / 扭簧高级分析', () => {\n  \n  const torsionParams = {\n    wireDiameter: 2.0,\n    meanDiameter: 20.0,\n    activeCoils: 6,\n    bodyLength: 12.0,\n    legLength1: 30.0,\n    legLength2: 30.0,\n    freeAngle: 90,\n    workingAngle: 45,\n    materialId: 'music_wire_a' as const,\n  };\n\n  describe('Mass Calculation / 质量计算', () => {\n    it('should calculate total wire length correctly', () => {\n      const result = calculateTorsionMass(torsionParams);\n      \n      // L_coil = π × Dm × Na = π × 20 × 6 = 376.99 mm\n      // L_total = L_coil + L1 + L2 = 376.99 + 30 + 30 = 436.99 mm\n      const L_coil_expected = PI * 20 * 6;\n      const L_total_expected = L_coil_expected + 30 + 30;\n      \n      expect(result.totalWireLength).toBeCloseTo(L_total_expected, 1);\n    });\n\n    it('should calculate mass using density and volume', () => {\n      const result = calculateTorsionMass(torsionParams);\n      \n      // Volume = (π × d²/4) × L_total\n      // Mass = ρ × Volume (ρ = 7850 kg/m³ = 7.85e-6 g/mm³)\n      const wireArea = PI * Math.pow(2.0 / 2, 2);\n      const density_g_mm3 = 7850 * 1e-6;\n      const mass_expected = wireArea * result.totalWireLength * density_g_mm3;\n      \n      expect(result.totalMass).toBeCloseTo(mass_expected, 2);\n    });\n  });\n\n  describe('Natural Frequency / 固有频率', () => {\n    it('should use k_rad (not k_deg) in frequency calculation', () => {\n      const result = calculateTorsionFrequency(torsionParams);\n      \n      // k_rad = E × d⁴ / (10.8 × Dm × Na)\n      // 材料的 E 可能略有不同（206000 vs 207000）\n      const E = 206000; // 实际材料库中的值\n      const k_rad = (E * Math.pow(2, 4)) / (10.8 * 20 * 6);\n      \n      // 允许 1% 的误差\n      expect(result.torsionalStiffness).toBeCloseTo(k_rad, -1);\n    });\n\n    it('should calculate moment of inertia for legs', () => {\n      const result = calculateTorsionFrequency(torsionParams);\n      \n      // J = (1/3) × m_leg × L²\n      // 应该有正的转动惯量\n      expect(result.momentOfInertia).toBeGreaterThan(0);\n    });\n\n    it('should produce reasonable natural frequency', () => {\n      const result = calculateTorsionFrequency(torsionParams);\n      \n      // 典型扭簧固有频率在几十到几百 Hz\n      expect(result.naturalFrequency).toBeGreaterThan(10);\n      expect(result.naturalFrequency).toBeLessThan(10000);\n    });\n  });\n});\n\n// ============================================================================\n// 5. 单位一致性测试\n// ============================================================================\n\ndescribe('Unit Consistency / 单位一致性', () => {\n  \n  it('compression spring rate should be in N/mm', () => {\n    const k = calculateCompressionSpringRate(COMPRESSION_SPRING_STANDARD);\n    // 典型压缩弹簧刚度在 1-100 N/mm 范围\n    expect(k).toBeGreaterThan(0.1);\n    expect(k).toBeLessThan(1000);\n  });\n\n  it('torsion spring rate should be in N·mm/deg', () => {\n    const k = calculateTorsionSpringRate(TORSION_SPRING_STANDARD);\n    // 典型扭簧刚度在 10-1000 N·mm/deg 范围\n    expect(k).toBeGreaterThan(1);\n    expect(k).toBeLessThan(10000);\n  });\n\n  it('stress should be in MPa', () => {\n    const tau = calculateNominalShearStress(100, 16, 2);\n    // 典型应力在 100-2000 MPa 范围\n    expect(tau).toBeGreaterThan(10);\n    expect(tau).toBeLessThan(5000);\n  });\n});\n\n// ============================================================================\n// 6. 边界条件测试\n// ============================================================================\n\ndescribe('Boundary Conditions / 边界条件', () => {\n  \n  it('should handle minimum practical spring index C=4', () => {\n    const Kw = calculateWahlFactor(4);\n    expect(Kw).toBeGreaterThan(1);\n    expect(Kw).toBeLessThan(2);\n  });\n\n  it('should handle maximum practical spring index C=16', () => {\n    const Kw = calculateWahlFactor(16);\n    expect(Kw).toBeGreaterThan(1);\n    expect(Kw).toBeLessThan(1.2);\n  });\n\n  it('should throw error for invalid spring index C<=1', () => {\n    expect(() => calculateWahlFactor(1)).toThrow();\n    expect(() => calculateWahlFactor(0.5)).toThrow();\n  });\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/buckling.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'alpha' is assigned a value but never used.","line":149,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":149,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Buckling Module (Pro)\n * 弹簧分析引擎 - 屈曲模块（专业版）\n * \n * Critical buckling analysis for compression springs\n * Includes Wahl curvature effect and load eccentricity\n */\n\nimport type { BucklingResult, CompressionSpringGeometry } from './types';\nimport { getSpringMaterial } from '@/lib/materials/springMaterials';\n\nconst PI = Math.PI;\n\n/**\n * End condition factors for buckling analysis\n * 端部条件系数\n */\nexport const END_CONDITION_FACTORS = {\n  /** Both ends fixed (ground and squared) */\n  FIXED_FIXED: 0.5,\n  /** One end fixed, one end free */\n  FIXED_FREE: 2.0,\n  /** Both ends pinned */\n  PINNED_PINNED: 1.0,\n  /** One end fixed, one end guided */\n  FIXED_GUIDED: 0.7,\n};\n\n/**\n * Extended buckling result with Pro features\n */\nexport interface BucklingResultPro extends BucklingResult {\n  /** End condition coefficient Ke */\n  endConditionCoefficient: number;\n  /** Curvature correction factor Kc */\n  curvatureCorrectionFactor: number;\n  /** Load eccentricity factor */\n  eccentricityFactor: number;\n  /** Modified critical load (with corrections) */\n  modifiedCriticalLoad: number;\n  /** Buckling risk zone start deflection */\n  riskZoneStartDeflection?: number;\n  /** Buckling mode shape */\n  bucklingMode: 'lateral' | 'torsional' | 'combined';\n}\n\n/**\n * Calculate Wahl curvature correction for buckling\n * 计算屈曲的 Wahl 曲率修正\n * \n * Kc = 1 - 0.1 × (1/C) where C = Dm/d\n */\nexport function calculateCurvatureCorrectionFactor(\n  meanDiameter: number,\n  wireDiameter: number\n): number {\n  const C = meanDiameter / wireDiameter;\n  // Curvature reduces effective stiffness\n  const Kc = 1 - 0.1 / C;\n  return Math.max(0.85, Math.min(1.0, Kc));\n}\n\n/**\n * Calculate load eccentricity factor\n * 计算载荷偏心系数\n * \n * Eccentricity increases buckling risk\n */\nexport function calculateEccentricityFactor(\n  eccentricityRatio: number = 0 // e/Dm ratio\n): number {\n  // Secant formula approximation\n  // Ke = 1 / (1 + e/r × sec(π/2 × √(P/Pcr)))\n  // Simplified: Ke ≈ 1 - 2 × (e/Dm)\n  return Math.max(0.7, 1 - 2 * eccentricityRatio);\n}\n\n/**\n * Calculate slenderness ratio\n * 计算细长比\n * \n * λ = L0 / Dm\n */\nexport function calculateSlendernessRatio(\n  freeLength: number,\n  meanDiameter: number\n): number {\n  return freeLength / meanDiameter;\n}\n\n/**\n * Calculate critical buckling load using Euler formula\n * 使用欧拉公式计算临界屈曲载荷\n * \n * P_cr = π² × E × I / L_eff²\n * \n * where:\n * - E = elastic modulus\n * - I = moment of inertia of wire = π × d⁴ / 64\n * - L_eff = effective length = k × L0 (k depends on end conditions)\n */\nexport function calculateEulerBucklingLoad(\n  elasticModulus: number,\n  wireDiameter: number,\n  freeLength: number,\n  endConditionFactor: number = END_CONDITION_FACTORS.FIXED_FIXED\n): number {\n  // Moment of inertia for round wire\n  const I = (PI * Math.pow(wireDiameter, 4)) / 64;\n  \n  // Effective length\n  const Leff = endConditionFactor * freeLength;\n  \n  // Euler critical load\n  const Pcr = (PI * PI * elasticModulus * I) / (Leff * Leff);\n  \n  return Pcr;\n}\n\n/**\n * Calculate critical buckling load using modified Haringx formula\n * 使用修正 Haringx 公式计算临界屈曲载荷\n * \n * This is more accurate for helical springs as it accounts for\n * the spring's shear flexibility\n * \n * P_cr = (π² × E × I × n) / (L0² × α²)\n * \n * where α depends on end conditions and spring geometry\n */\nexport function calculateHaringxBucklingLoad(\n  geometry: CompressionSpringGeometry,\n  elasticModulus: number,\n  shearModulus: number,\n  endConditionFactor: number = END_CONDITION_FACTORS.FIXED_FIXED\n): number {\n  const { wireDiameter, meanDiameter, activeCoils, freeLength } = geometry;\n  \n  // Spring index\n  const C = meanDiameter / wireDiameter;\n  \n  // Moment of inertia\n  const I = (PI * Math.pow(wireDiameter, 4)) / 64;\n  \n  // Effective number of coils for buckling\n  const n = activeCoils;\n  \n  // Helix angle factor\n  const alpha = PI * meanDiameter * n / freeLength;\n  \n  // Shear correction factor\n  const Ks = 1 + 2 / (C * C);\n  \n  // Modified critical load\n  const Pcr = (PI * PI * elasticModulus * I * n) / \n              (freeLength * freeLength * endConditionFactor * endConditionFactor * Ks);\n  \n  return Pcr;\n}\n\n/**\n * Calculate critical deflection at which buckling occurs\n * 计算发生屈曲的临界压缩量\n * \n * For compression springs, buckling typically occurs when:\n * - Slenderness ratio λ > 4 (approximately)\n * - Deflection exceeds critical value\n */\nexport function calculateCriticalDeflection(\n  freeLength: number,\n  meanDiameter: number,\n  endConditionFactor: number = END_CONDITION_FACTORS.FIXED_FIXED\n): number {\n  const lambda = freeLength / meanDiameter;\n  \n  // Empirical formula for critical deflection ratio\n  // Based on spring design handbooks\n  const criticalRatio = 0.812 * Math.sqrt(1 - (endConditionFactor * PI / lambda) ** 2);\n  \n  // If lambda is too small, no buckling\n  if (lambda <= endConditionFactor * PI) {\n    return freeLength; // Can compress fully without buckling\n  }\n  \n  return freeLength * criticalRatio;\n}\n\n/**\n * Check if spring is at risk of buckling\n * 检查弹簧是否有屈曲风险\n */\nexport function checkBucklingRisk(\n  slendernessRatio: number,\n  endConditionFactor: number = END_CONDITION_FACTORS.FIXED_FIXED\n): {\n  atRisk: boolean;\n  criticalSlenderness: number;\n  recommendations: string[];\n} {\n  // Critical slenderness ratio depends on end conditions\n  // For fixed-fixed: λ_cr ≈ 4\n  // For fixed-free: λ_cr ≈ 2\n  const criticalSlenderness = 4 / endConditionFactor;\n  \n  const atRisk = slendernessRatio > criticalSlenderness;\n  \n  const recommendations: string[] = [];\n  if (atRisk) {\n    recommendations.push('Consider using a guide rod or tube to prevent buckling');\n    recommendations.push('Reduce free length or increase mean diameter');\n    recommendations.push('Use nested springs (one inside another)');\n    recommendations.push('Change end conditions to increase stability');\n  }\n  \n  return {\n    atRisk,\n    criticalSlenderness,\n    recommendations,\n  };\n}\n\n/**\n * Calculate complete buckling analysis\n * 计算完整屈曲分析\n */\nexport function calculateBuckling(\n  geometry: CompressionSpringGeometry,\n  workingLoad: number,\n  endConditionFactor: number = END_CONDITION_FACTORS.FIXED_FIXED\n): BucklingResult {\n  const material = getSpringMaterial(geometry.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${geometry.materialId}`);\n  }\n\n  const { wireDiameter, meanDiameter, freeLength } = geometry;\n  const elasticModulus = material.elasticModulus ?? 207000; // Default for steel\n\n  // Calculate slenderness ratio\n  const slendernessRatio = calculateSlendernessRatio(freeLength, meanDiameter);\n\n  // Calculate critical buckling load\n  const criticalLoad = calculateEulerBucklingLoad(\n    elasticModulus,\n    wireDiameter,\n    freeLength,\n    endConditionFactor\n  );\n\n  // Calculate buckling safety factor\n  const bucklingSafetyFactor = criticalLoad / workingLoad;\n\n  // Check risk and get recommendations\n  const { atRisk, recommendations } = checkBucklingRisk(slendernessRatio, endConditionFactor);\n\n  // Determine status\n  let status: BucklingResult['status'];\n  let message: { en: string; zh: string };\n\n  if (bucklingSafetyFactor >= 2.0 && !atRisk) {\n    status = 'safe';\n    message = {\n      en: 'No buckling risk (SF ≥ 2.0)',\n      zh: '无屈曲风险 (SF ≥ 2.0)',\n    };\n  } else if (bucklingSafetyFactor >= 1.5) {\n    status = 'warning';\n    message = {\n      en: 'Marginal buckling safety (1.5 ≤ SF < 2.0)',\n      zh: '屈曲安全临界 (1.5 ≤ SF < 2.0)',\n    };\n  } else {\n    status = 'danger';\n    message = {\n      en: 'High buckling risk (SF < 1.5)',\n      zh: '高屈曲风险 (SF < 1.5)',\n    };\n  }\n\n  return {\n    slendernessRatio,\n    criticalLoad,\n    workingLoad,\n    bucklingSafetyFactor,\n    status,\n    message,\n    recommendations: status !== 'safe' ? recommendations : undefined,\n  };\n}\n\n/**\n * Calculate buckling curve for plotting\n * 计算屈曲曲线用于绘图\n * \n * Returns deflection vs. critical load curve\n */\nexport function generateBucklingCurve(\n  geometry: CompressionSpringGeometry,\n  springRate: number,\n  numPoints: number = 20\n): Array<{ deflection: number; load: number; criticalLoad: number; safe: boolean }> {\n  const material = getSpringMaterial(geometry.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${geometry.materialId}`);\n  }\n\n  const { wireDiameter, freeLength } = geometry;\n  const totalCoils = geometry.totalCoils ?? geometry.activeCoils + 2;\n  const solidHeight = totalCoils * wireDiameter;\n  const maxDeflection = freeLength - solidHeight;\n  const elasticModulus = material.elasticModulus ?? 207000;\n\n  const points: Array<{ deflection: number; load: number; criticalLoad: number; safe: boolean }> = [];\n\n  for (let i = 0; i <= numPoints; i++) {\n    const deflection = (maxDeflection * i) / numPoints;\n    const currentLength = freeLength - deflection;\n    const load = springRate * deflection;\n\n    // Recalculate critical load for current compressed length\n    const criticalLoad = calculateEulerBucklingLoad(\n      elasticModulus,\n      wireDiameter,\n      currentLength,\n      END_CONDITION_FACTORS.FIXED_FIXED\n    );\n\n    points.push({\n      deflection,\n      load,\n      criticalLoad,\n      safe: load < criticalLoad,\n    });\n  }\n\n  return points;\n}\n\n/**\n * Calculate Pro buckling analysis with Wahl correction and eccentricity\n * 计算专业版屈曲分析（含 Wahl 修正和偏心）\n * \n * P_cr_mod = P_cr × Ke × Kc × Kecc\n */\nexport function calculateBucklingPro(\n  geometry: CompressionSpringGeometry,\n  workingLoad: number,\n  springRate: number,\n  endConditionFactor: number = END_CONDITION_FACTORS.FIXED_FIXED,\n  eccentricityRatio: number = 0\n): BucklingResultPro {\n  const material = getSpringMaterial(geometry.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${geometry.materialId}`);\n  }\n\n  const { wireDiameter, meanDiameter, freeLength } = geometry;\n  const elasticModulus = material.elasticModulus ?? 207000;\n\n  // Calculate base buckling load\n  const baseCriticalLoad = calculateEulerBucklingLoad(\n    elasticModulus,\n    wireDiameter,\n    freeLength,\n    endConditionFactor\n  );\n\n  // Calculate correction factors\n  const Kc = calculateCurvatureCorrectionFactor(meanDiameter, wireDiameter);\n  const Kecc = calculateEccentricityFactor(eccentricityRatio);\n\n  // Modified critical load\n  const modifiedCriticalLoad = baseCriticalLoad * Kc * Kecc;\n\n  // Calculate slenderness ratio\n  const slendernessRatio = calculateSlendernessRatio(freeLength, meanDiameter);\n\n  // Calculate buckling safety factor using modified load\n  const bucklingSafetyFactor = modifiedCriticalLoad / workingLoad;\n\n  // Determine buckling mode\n  let bucklingMode: 'lateral' | 'torsional' | 'combined';\n  const C = meanDiameter / wireDiameter;\n  if (slendernessRatio > 5 && C > 8) {\n    bucklingMode = 'lateral';\n  } else if (slendernessRatio < 3) {\n    bucklingMode = 'torsional';\n  } else {\n    bucklingMode = 'combined';\n  }\n\n  // Calculate risk zone start deflection\n  let riskZoneStartDeflection: number | undefined;\n  if (bucklingSafetyFactor < 2.0) {\n    // Find deflection where SF drops below 1.5\n    const targetLoad = modifiedCriticalLoad / 1.5;\n    riskZoneStartDeflection = targetLoad / springRate;\n  }\n\n  // Check risk and get recommendations\n  const { atRisk, recommendations } = checkBucklingRisk(slendernessRatio, endConditionFactor);\n\n  // Determine status\n  let status: BucklingResult['status'];\n  let message: { en: string; zh: string };\n\n  if (bucklingSafetyFactor >= 2.0 && !atRisk) {\n    status = 'safe';\n    message = {\n      en: `No buckling risk (SF = ${bucklingSafetyFactor.toFixed(2)} ≥ 2.0). Mode: ${bucklingMode}`,\n      zh: `无屈曲风险 (SF = ${bucklingSafetyFactor.toFixed(2)} ≥ 2.0)。模式：${bucklingMode === 'lateral' ? '横向' : bucklingMode === 'torsional' ? '扭转' : '组合'}`,\n    };\n  } else if (bucklingSafetyFactor >= 1.5) {\n    status = 'warning';\n    message = {\n      en: `Marginal buckling safety (SF = ${bucklingSafetyFactor.toFixed(2)}). Kc = ${Kc.toFixed(3)}, Kecc = ${Kecc.toFixed(3)}`,\n      zh: `屈曲安全临界 (SF = ${bucklingSafetyFactor.toFixed(2)})。Kc = ${Kc.toFixed(3)}，Kecc = ${Kecc.toFixed(3)}`,\n    };\n  } else {\n    status = 'danger';\n    message = {\n      en: `HIGH BUCKLING RISK (SF = ${bucklingSafetyFactor.toFixed(2)} < 1.5). Risk zone starts at Δx = ${riskZoneStartDeflection?.toFixed(1) ?? 'N/A'} mm`,\n      zh: `高屈曲风险 (SF = ${bucklingSafetyFactor.toFixed(2)} < 1.5)。风险区从 Δx = ${riskZoneStartDeflection?.toFixed(1) ?? 'N/A'} mm 开始`,\n    };\n  }\n\n  return {\n    slendernessRatio,\n    criticalLoad: baseCriticalLoad,\n    workingLoad,\n    bucklingSafetyFactor,\n    status,\n    message,\n    recommendations: status !== 'safe' ? recommendations : undefined,\n    endConditionCoefficient: endConditionFactor,\n    curvatureCorrectionFactor: Kc,\n    eccentricityFactor: Kecc,\n    modifiedCriticalLoad,\n    riskZoneStartDeflection,\n    bucklingMode,\n  };\n}\n\n/**\n * Generate buckling safety factor vs deflection curve\n * 生成屈曲安全系数与位移关系曲线\n */\nexport function generateBucklingSafetyFactorCurve(\n  geometry: CompressionSpringGeometry,\n  springRate: number,\n  numPoints: number = 50\n): Array<{\n  deflection: number;\n  load: number;\n  safetyFactor: number;\n  inRiskZone: boolean;\n}> {\n  const material = getSpringMaterial(geometry.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${geometry.materialId}`);\n  }\n\n  const { wireDiameter, meanDiameter, freeLength } = geometry;\n  const totalCoils = geometry.totalCoils ?? geometry.activeCoils + 2;\n  const solidHeight = totalCoils * wireDiameter;\n  const maxDeflection = freeLength - solidHeight;\n  const elasticModulus = material.elasticModulus ?? 207000;\n\n  const Kc = calculateCurvatureCorrectionFactor(meanDiameter, wireDiameter);\n\n  const points: Array<{\n    deflection: number;\n    load: number;\n    safetyFactor: number;\n    inRiskZone: boolean;\n  }> = [];\n\n  for (let i = 0; i <= numPoints; i++) {\n    const deflection = (maxDeflection * i) / numPoints;\n    const currentLength = freeLength - deflection;\n    const load = springRate * deflection;\n\n    // Critical load at current length with corrections\n    const baseCriticalLoad = calculateEulerBucklingLoad(\n      elasticModulus,\n      wireDiameter,\n      currentLength,\n      END_CONDITION_FACTORS.FIXED_FIXED\n    );\n    const modifiedCriticalLoad = baseCriticalLoad * Kc;\n\n    const safetyFactor = load > 0 ? modifiedCriticalLoad / load : Infinity;\n\n    points.push({\n      deflection,\n      load,\n      safetyFactor: Math.min(safetyFactor, 10), // Cap for plotting\n      inRiskZone: safetyFactor < 1.5,\n    });\n  }\n\n  return points;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/coilingProcess.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'elasticModulus' is defined but never used.","line":117,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":117,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'yieldStrength' is defined but never used.","line":118,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":118,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Coiling Process Simulator - Phase 6\n * 绕簧工艺仿真器\n * \n * Models residual stresses induced during wire coiling on CNC spring forming machines\n */\n\nimport type { SpringMaterialId } from '@/lib/materials/springMaterials';\nimport { getSpringMaterial } from '@/lib/materials/springMaterials';\n\n/**\n * Coiling process parameters\n */\nexport interface CoilingProcessParams {\n  /** Wire diameter (mm) */\n  wireDiameter: number;\n  /** Mandrel diameter for coiling (mm) */\n  mandrelDiameter: number;\n  /** Feed rate (mm/s) */\n  feedRate: number;\n  /** Pitch cam angle (degrees) */\n  pitchCamAngle: number;\n  /** Material ID */\n  materialId: SpringMaterialId;\n  /** Target mean diameter (mm) */\n  targetMeanDiameter: number;\n  /** Target pitch (mm) */\n  targetPitch: number;\n}\n\n/**\n * Coiling process result\n */\nexport interface CoilingProcessResult {\n  /** Residual bending stress from coiling (MPa) */\n  residualBendingStress: number;\n  /** Residual torsional stress (MPa) */\n  residualTorsionalStress: number;\n  /** Total residual stress (MPa) */\n  totalResidualStress: number;\n  /** Bending radius during coiling (mm) */\n  bendingRadius: number;\n  /** Springback angle (degrees) */\n  springbackAngle: number;\n  /** Compensated mandrel diameter (mm) */\n  compensatedMandrelDiameter: number;\n  /** Compensated pitch setting (mm) */\n  compensatedPitch: number;\n  /** Stress distribution along wire cross-section */\n  stressDistribution: {\n    position: number; // -1 to 1 (inner to outer)\n    stress: number;   // MPa\n  }[];\n  /** Impact on fatigue life factor */\n  fatigueLifeReductionFactor: number;\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Default coiling parameters for different wire sizes\n */\nexport const DEFAULT_COILING_PARAMS: Record<string, Partial<CoilingProcessParams>> = {\n  small: { // d < 2mm\n    feedRate: 50,\n    pitchCamAngle: 15,\n  },\n  medium: { // 2mm <= d < 6mm\n    feedRate: 30,\n    pitchCamAngle: 20,\n  },\n  large: { // d >= 6mm\n    feedRate: 15,\n    pitchCamAngle: 25,\n  },\n};\n\n/**\n * Calculate residual bending stress from elastic bending formulation\n * σ_residual = E * d / (2 * Rm)\n */\nexport function calculateResidualBendingStress(\n  wireDiameter: number,\n  bendingRadius: number,\n  elasticModulus: number\n): number {\n  if (bendingRadius <= 0) return 0;\n  return (elasticModulus * wireDiameter) / (2 * bendingRadius);\n}\n\n/**\n * Calculate springback angle based on material properties\n * Springback occurs when elastic strain recovers after forming\n */\nexport function calculateSpringbackAngle(\n  wireDiameter: number,\n  bendingRadius: number,\n  yieldStrength: number,\n  elasticModulus: number\n): number {\n  // Springback ratio K = 1 - (3*Sy*Rm)/(E*d) + (Sy*Rm)^3/(E*d)^3\n  const ratio = (yieldStrength * bendingRadius) / (elasticModulus * wireDiameter);\n  const K = 1 - 3 * ratio + Math.pow(ratio, 3);\n  \n  // Springback angle in degrees\n  const springbackAngle = (1 - K) * 360 / (2 * Math.PI);\n  return Math.max(0, springbackAngle);\n}\n\n/**\n * Calculate compensated mandrel diameter to achieve target mean diameter\n */\nexport function calculateCompensatedMandrelDiameter(\n  targetMeanDiameter: number,\n  wireDiameter: number,\n  springbackAngle: number,\n  elasticModulus: number,\n  yieldStrength: number\n): number {\n  // Compensation factor based on springback\n  const springbackFactor = 1 + springbackAngle / 360;\n  \n  // Compensated mandrel diameter\n  const compensatedDm = (targetMeanDiameter - wireDiameter) / springbackFactor;\n  \n  return Math.max(wireDiameter * 2, compensatedDm);\n}\n\n/**\n * Calculate stress distribution across wire cross-section during coiling\n */\nexport function calculateCoilingStressDistribution(\n  wireDiameter: number,\n  bendingRadius: number,\n  elasticModulus: number,\n  yieldStrength: number,\n  numPoints: number = 21\n): { position: number; stress: number }[] {\n  const distribution: { position: number; stress: number }[] = [];\n  \n  for (let i = 0; i < numPoints; i++) {\n    const position = -1 + (2 * i) / (numPoints - 1); // -1 to 1\n    const y = position * wireDiameter / 2; // Distance from neutral axis\n    \n    // Elastic bending stress: σ = E * y / Rm\n    let stress = (elasticModulus * y) / bendingRadius;\n    \n    // Cap at yield strength (plastic region)\n    if (Math.abs(stress) > yieldStrength) {\n      stress = Math.sign(stress) * yieldStrength;\n    }\n    \n    distribution.push({ position, stress });\n  }\n  \n  return distribution;\n}\n\n/**\n * Calculate fatigue life reduction factor due to residual stress\n */\nexport function calculateFatigueLifeReductionFactor(\n  residualStress: number,\n  ultimateStrength: number,\n  enduranceLimit: number\n): number {\n  // Using modified Goodman relation\n  // Residual tensile stress reduces fatigue life\n  if (residualStress <= 0) {\n    // Compressive residual stress improves fatigue life\n    return 1 + Math.abs(residualStress) / (2 * enduranceLimit);\n  }\n  \n  // Tensile residual stress reduces fatigue life\n  const factor = 1 - residualStress / ultimateStrength;\n  return Math.max(0.1, factor);\n}\n\n/**\n * Main coiling process simulation\n */\nexport function simulateCoilingProcess(params: CoilingProcessParams): CoilingProcessResult {\n  const {\n    wireDiameter,\n    mandrelDiameter,\n    feedRate,\n    pitchCamAngle,\n    materialId,\n    targetMeanDiameter,\n    targetPitch,\n  } = params;\n\n  // Get material properties\n  const material = getSpringMaterial(materialId);\n  const E = material?.elasticModulus ?? 206000; // MPa\n  const Sy = material?.allowShearStatic ? material.allowShearStatic * 1.5 : 1400; // Approximate yield\n  const Su = material?.tensileStrength ?? 1800; // MPa\n  const Se = material?.snCurve?.tau2 ?? 500; // MPa\n\n  // Calculate bending radius (mandrel radius + wire radius)\n  const bendingRadius = mandrelDiameter / 2 + wireDiameter / 2;\n\n  // Calculate residual bending stress\n  const residualBendingStress = calculateResidualBendingStress(\n    wireDiameter,\n    bendingRadius,\n    E\n  );\n\n  // Calculate residual torsional stress from pitch forming\n  // Approximation based on pitch angle and feed rate\n  const pitchAngleRad = (pitchCamAngle * Math.PI) / 180;\n  const residualTorsionalStress = 0.1 * residualBendingStress * Math.tan(pitchAngleRad);\n\n  // Total residual stress (von Mises combination)\n  const totalResidualStress = Math.sqrt(\n    Math.pow(residualBendingStress, 2) + 3 * Math.pow(residualTorsionalStress, 2)\n  );\n\n  // Calculate springback\n  const springbackAngle = calculateSpringbackAngle(wireDiameter, bendingRadius, Sy, E);\n\n  // Calculate compensated mandrel diameter\n  const compensatedMandrelDiameter = calculateCompensatedMandrelDiameter(\n    targetMeanDiameter,\n    wireDiameter,\n    springbackAngle,\n    E,\n    Sy\n  );\n\n  // Calculate compensated pitch (accounting for relaxation)\n  const pitchRelaxationFactor = 1.02 + 0.01 * (feedRate / 30);\n  const compensatedPitch = targetPitch * pitchRelaxationFactor;\n\n  // Calculate stress distribution\n  const stressDistribution = calculateCoilingStressDistribution(\n    wireDiameter,\n    bendingRadius,\n    E,\n    Sy\n  );\n\n  // Calculate fatigue life reduction factor\n  const fatigueLifeReductionFactor = calculateFatigueLifeReductionFactor(\n    residualBendingStress,\n    Su,\n    Se\n  );\n\n  // Generate recommendations\n  const recommendations: string[] = [];\n  \n  if (residualBendingStress > 0.3 * Sy) {\n    recommendations.push('Consider stress relief heat treatment after coiling');\n  }\n  \n  if (springbackAngle > 10) {\n    recommendations.push('High springback detected - verify mandrel compensation');\n  }\n  \n  if (mandrelDiameter < wireDiameter * 3) {\n    recommendations.push('Mandrel diameter may be too small - risk of wire damage');\n  }\n  \n  if (feedRate > 50 && wireDiameter > 3) {\n    recommendations.push('Reduce feed rate for better dimensional accuracy');\n  }\n\n  return {\n    residualBendingStress,\n    residualTorsionalStress,\n    totalResidualStress,\n    bendingRadius,\n    springbackAngle,\n    compensatedMandrelDiameter,\n    compensatedPitch,\n    stressDistribution,\n    fatigueLifeReductionFactor,\n    recommendations,\n  };\n}\n\n/**\n * Calculate effective stress including residual stress from coiling\n * τ_effective = τmax + σ_residual\n */\nexport function calculateEffectiveStressWithResidual(\n  maxShearStress: number,\n  residualStress: number\n): number {\n  // Convert residual bending stress to equivalent shear stress\n  // Using von Mises: τ_eq = σ / √3\n  const equivalentShearResidual = residualStress / Math.sqrt(3);\n  \n  return maxShearStress + equivalentShearResidual;\n}\n\n/**\n * Re-evaluate fatigue life with residual stress using Goodman-Basquin\n */\nexport function reevaluateFatigueWithResidual(\n  stressAmplitude: number,\n  meanStress: number,\n  residualStress: number,\n  ultimateStrength: number,\n  fatigueStrengthCoeff: number,\n  fatigueStrengthExponent: number\n): {\n  originalLife: number;\n  adjustedLife: number;\n  lifeReductionPercent: number;\n} {\n  // Original Basquin equation: N = (σa / σf')^(1/b)\n  const originalLife = Math.pow(stressAmplitude / fatigueStrengthCoeff, 1 / fatigueStrengthExponent);\n  \n  // Adjusted mean stress with residual\n  const adjustedMeanStress = meanStress + residualStress;\n  \n  // Goodman correction for mean stress\n  const goodmanFactor = 1 - adjustedMeanStress / ultimateStrength;\n  const adjustedAmplitude = stressAmplitude / Math.max(0.1, goodmanFactor);\n  \n  // Adjusted fatigue life\n  const adjustedLife = Math.pow(adjustedAmplitude / fatigueStrengthCoeff, 1 / fatigueStrengthExponent);\n  \n  // Life reduction percentage\n  const lifeReductionPercent = ((originalLife - adjustedLife) / originalLife) * 100;\n  \n  return {\n    originalLife,\n    adjustedLife,\n    lifeReductionPercent: Math.max(0, lifeReductionPercent),\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/creep.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/cyclicCreep.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getSpringMaterial' is defined but never used.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Cyclic Creep Model\n * 弹簧分析引擎 - 循环蠕变模型\n * \n * Calculates creep under cyclic loading conditions\n * ε_creep_cyclic = ∫ (A * σ^n) dt\n */\n\nimport { getSpringMaterial, type SpringMaterialId } from '@/lib/materials/springMaterials';\n\n/**\n * Cyclic creep parameters\n */\nexport interface CyclicCreepParams {\n  /** Creep coefficient A */\n  A: number;\n  /** Stress exponent n */\n  n: number;\n  /** Temperature activation energy Q (J/mol) */\n  Q: number;\n  /** Reference temperature (K) */\n  T_ref: number;\n}\n\n/**\n * Cyclic creep result\n */\nexport interface CyclicCreepResult {\n  /** Total creep strain */\n  totalCreepStrain: number;\n  /** Creep strain rate (per hour) */\n  creepStrainRate: number;\n  /** Dimensional drift (mm) */\n  dimensionalDrift: number;\n  /** Drift rate (mm/1000 hours) */\n  driftRate: number;\n  /** Time to threshold (hours) */\n  timeToThreshold: number;\n  /** Recommended maintenance interval (hours) */\n  maintenanceInterval: number;\n  /** Risk level */\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n  /** Service stability rating */\n  stabilityRating: number; // 0-100\n  /** Message */\n  message: { en: string; zh: string };\n}\n\n/**\n * Cyclic creep parameters by material\n */\nexport const CYCLIC_CREEP_PARAMS: Record<string, CyclicCreepParams> = {\n  music_wire_a228: {\n    A: 1e-20,\n    n: 4.5,\n    Q: 280000,\n    T_ref: 293,\n  },\n  oil_tempered: {\n    A: 2e-20,\n    n: 4.2,\n    Q: 270000,\n    T_ref: 293,\n  },\n  chrome_silicon: {\n    A: 0.5e-20,\n    n: 5.0,\n    Q: 300000,\n    T_ref: 293,\n  },\n  chrome_vanadium: {\n    A: 0.8e-20,\n    n: 4.8,\n    Q: 290000,\n    T_ref: 293,\n  },\n  ss_302: {\n    A: 3e-20,\n    n: 3.8,\n    Q: 250000,\n    T_ref: 293,\n  },\n};\n\n/**\n * Get cyclic creep parameters\n */\nexport function getCyclicCreepParams(materialId: SpringMaterialId): CyclicCreepParams {\n  return CYCLIC_CREEP_PARAMS[materialId] ?? {\n    A: 1e-20,\n    n: 4.5,\n    Q: 280000,\n    T_ref: 293,\n  };\n}\n\n/**\n * Calculate creep strain rate\n * ε̇ = A * σ^n * exp(-Q/RT)\n */\nexport function calculateCreepStrainRate(\n  stress: number, // MPa\n  temperature: number, // °C\n  params: CyclicCreepParams\n): number {\n  const { A, n, Q, T_ref } = params;\n  const R = 8.314; // Gas constant\n  const T_K = temperature + 273.15;\n  \n  // Arrhenius temperature factor\n  const tempFactor = Math.exp(-Q / (R * T_K) + Q / (R * T_ref));\n  \n  // Creep strain rate (per hour)\n  const strainRate = A * Math.pow(stress, n) * tempFactor;\n  \n  return strainRate;\n}\n\n/**\n * Calculate cyclic creep under repeated loading\n */\nexport function calculateCyclicCreep(\n  maxStress: number, // MPa\n  minStress: number, // MPa\n  temperature: number, // °C\n  operatingHours: number,\n  cyclesPerHour: number,\n  freeLength: number, // mm\n  materialId: SpringMaterialId,\n  creepThreshold: number = 0.002 // 0.2% strain threshold\n): CyclicCreepResult {\n  const params = getCyclicCreepParams(materialId);\n  \n  // Average stress for creep calculation\n  const avgStress = (maxStress + minStress) / 2;\n  const stressAmplitude = (maxStress - minStress) / 2;\n  \n  // Base creep strain rate\n  const baseStrainRate = calculateCreepStrainRate(avgStress, temperature, params);\n  \n  // Cyclic enhancement factor (cycling accelerates creep)\n  const cyclicFactor = 1 + 0.1 * Math.log10(1 + cyclesPerHour);\n  \n  // Stress amplitude enhancement\n  const amplitudeFactor = 1 + 0.5 * (stressAmplitude / avgStress);\n  \n  // Effective creep strain rate\n  const creepStrainRate = baseStrainRate * cyclicFactor * amplitudeFactor;\n  \n  // Total creep strain\n  const totalCreepStrain = creepStrainRate * operatingHours;\n  \n  // Dimensional drift\n  const dimensionalDrift = totalCreepStrain * freeLength;\n  const driftRate = (creepStrainRate * 1000) * freeLength; // mm per 1000 hours\n  \n  // Time to threshold\n  const timeToThreshold = creepThreshold / creepStrainRate;\n  \n  // Recommended maintenance interval (80% of time to threshold)\n  const maintenanceInterval = timeToThreshold * 0.8;\n  \n  // Determine risk level\n  let riskLevel: CyclicCreepResult['riskLevel'];\n  let stabilityRating: number;\n  \n  if (totalCreepStrain >= creepThreshold) {\n    riskLevel = 'critical';\n    stabilityRating = 10;\n  } else if (totalCreepStrain >= creepThreshold * 0.7) {\n    riskLevel = 'high';\n    stabilityRating = 30;\n  } else if (totalCreepStrain >= creepThreshold * 0.3) {\n    riskLevel = 'medium';\n    stabilityRating = 60;\n  } else {\n    riskLevel = 'low';\n    stabilityRating = 90;\n  }\n  \n  // Generate message\n  let message: { en: string; zh: string };\n  if (riskLevel === 'critical') {\n    message = {\n      en: `CRITICAL: Dimensional drift risk. Creep strain ${(totalCreepStrain * 100).toFixed(3)}% exceeds threshold.`,\n      zh: `严重：尺寸漂移风险。蠕变应变 ${(totalCreepStrain * 100).toFixed(3)}% 超过阈值。`,\n    };\n  } else if (riskLevel === 'high') {\n    message = {\n      en: `HIGH RISK: Approaching creep limit. Maintenance recommended within ${maintenanceInterval.toFixed(0)} hours.`,\n      zh: `高风险：接近蠕变极限。建议在 ${maintenanceInterval.toFixed(0)} 小时内维护。`,\n    };\n  } else if (riskLevel === 'medium') {\n    message = {\n      en: `Moderate creep accumulation. Monitor dimensional stability.`,\n      zh: `中等蠕变累积。监控尺寸稳定性。`,\n    };\n  } else {\n    message = {\n      en: `Low creep risk. Service stability is good.`,\n      zh: `低蠕变风险。服役稳定性良好。`,\n    };\n  }\n  \n  return {\n    totalCreepStrain,\n    creepStrainRate,\n    dimensionalDrift,\n    driftRate,\n    timeToThreshold,\n    maintenanceInterval,\n    riskLevel,\n    stabilityRating,\n    message,\n  };\n}\n\n/**\n * Generate creep accumulation curve\n */\nexport function generateCreepCurve(\n  maxStress: number,\n  minStress: number,\n  temperature: number,\n  cyclesPerHour: number,\n  freeLength: number,\n  materialId: SpringMaterialId,\n  maxHours: number = 10000,\n  numPoints: number = 50\n): Array<{\n  hours: number;\n  creepStrain: number;\n  dimensionalDrift: number;\n}> {\n  const points: Array<{\n    hours: number;\n    creepStrain: number;\n    dimensionalDrift: number;\n  }> = [];\n  \n  for (let i = 0; i <= numPoints; i++) {\n    const hours = (maxHours * i) / numPoints;\n    const result = calculateCyclicCreep(\n      maxStress, minStress, temperature, hours, cyclesPerHour, freeLength, materialId\n    );\n    \n    points.push({\n      hours,\n      creepStrain: result.totalCreepStrain,\n      dimensionalDrift: result.dimensionalDrift,\n    });\n  }\n  \n  return points;\n}\n\n/**\n * Calculate contact stress multiplier for end zones\n */\nexport function calculateContactStressMultiplier(\n  isEndZone: boolean,\n  isHookRegion: boolean,\n  coilContactRatio: number // 0-1\n): number {\n  let multiplier = 1.0;\n  \n  if (isEndZone) {\n    multiplier += 0.15; // 15% increase at end coils\n  }\n  \n  if (isHookRegion) {\n    multiplier += 0.20; // 20% increase at hooks\n  }\n  \n  if (coilContactRatio > 0) {\n    multiplier += 0.1 * coilContactRatio; // Up to 10% for coil contact\n  }\n  \n  return multiplier;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/designSuggestions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/dynamics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/environment.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'env' is assigned a value but never used.","line":289,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":289,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Environmental Effects Model\n * 弹簧分析引擎 - 环境效应模块\n * \n * Corrosion, salt spray, and environmental fatigue reduction\n */\n\nimport { type SpringMaterialId } from '@/lib/materials/springMaterials';\n\n/**\n * Environment types\n */\nexport type EnvironmentType = \n  | 'indoor'\n  | 'outdoor'\n  | 'humid'\n  | 'salt_spray'\n  | 'acidic'\n  | 'alkaline'\n  | 'marine'\n  | 'industrial';\n\n/**\n * Environment configuration\n */\nexport interface EnvironmentConfig {\n  type: EnvironmentType;\n  label: { en: string; zh: string };\n  description: { en: string; zh: string };\n  /** Base corrosion factor */\n  corrosionFactor: number;\n  /** Fatigue reduction factor */\n  fatigueReductionFactor: number;\n  /** Stress corrosion cracking risk */\n  sccRisk: 'none' | 'low' | 'medium' | 'high';\n}\n\n/**\n * Environment definitions\n */\nexport const ENVIRONMENTS: Record<EnvironmentType, EnvironmentConfig> = {\n  indoor: {\n    type: 'indoor',\n    label: { en: 'Indoor', zh: '室内' },\n    description: { \n      en: 'Controlled indoor environment, low humidity',\n      zh: '受控室内环境，低湿度',\n    },\n    corrosionFactor: 1.00,\n    fatigueReductionFactor: 1.00,\n    sccRisk: 'none',\n  },\n  outdoor: {\n    type: 'outdoor',\n    label: { en: 'Outdoor', zh: '室外' },\n    description: {\n      en: 'Outdoor exposure, normal weather conditions',\n      zh: '室外暴露，正常天气条件',\n    },\n    corrosionFactor: 0.90,\n    fatigueReductionFactor: 0.90,\n    sccRisk: 'low',\n  },\n  humid: {\n    type: 'humid',\n    label: { en: 'Humid', zh: '潮湿' },\n    description: {\n      en: 'High humidity environment (>70% RH)',\n      zh: '高湿度环境 (>70% RH)',\n    },\n    corrosionFactor: 0.85,\n    fatigueReductionFactor: 0.85,\n    sccRisk: 'medium',\n  },\n  salt_spray: {\n    type: 'salt_spray',\n    label: { en: 'Salt Spray', zh: '盐雾' },\n    description: {\n      en: 'Salt spray exposure (>5% NaCl)',\n      zh: '盐雾暴露 (>5% NaCl)',\n    },\n    corrosionFactor: 0.70,\n    fatigueReductionFactor: 0.65,\n    sccRisk: 'high',\n  },\n  acidic: {\n    type: 'acidic',\n    label: { en: 'Acidic', zh: '酸性' },\n    description: {\n      en: 'Acidic environment (pH < 5)',\n      zh: '酸性环境 (pH < 5)',\n    },\n    corrosionFactor: 0.60,\n    fatigueReductionFactor: 0.55,\n    sccRisk: 'high',\n  },\n  alkaline: {\n    type: 'alkaline',\n    label: { en: 'Alkaline', zh: '碱性' },\n    description: {\n      en: 'Alkaline environment (pH > 9)',\n      zh: '碱性环境 (pH > 9)',\n    },\n    corrosionFactor: 0.75,\n    fatigueReductionFactor: 0.70,\n    sccRisk: 'medium',\n  },\n  marine: {\n    type: 'marine',\n    label: { en: 'Marine', zh: '海洋' },\n    description: {\n      en: 'Marine/coastal environment',\n      zh: '海洋/沿海环境',\n    },\n    corrosionFactor: 0.65,\n    fatigueReductionFactor: 0.60,\n    sccRisk: 'high',\n  },\n  industrial: {\n    type: 'industrial',\n    label: { en: 'Industrial', zh: '工业' },\n    description: {\n      en: 'Industrial environment with pollutants',\n      zh: '含污染物的工业环境',\n    },\n    corrosionFactor: 0.80,\n    fatigueReductionFactor: 0.75,\n    sccRisk: 'medium',\n  },\n};\n\n/**\n * Material corrosion resistance ratings\n */\nexport const MATERIAL_CORROSION_RESISTANCE: Record<string, {\n  rating: 'poor' | 'fair' | 'good' | 'excellent';\n  modifier: number;\n}> = {\n  music_wire_a228: { rating: 'poor', modifier: 1.0 },\n  oil_tempered_a229: { rating: 'poor', modifier: 1.0 },\n  chrome_vanadium_a231: { rating: 'fair', modifier: 1.1 },\n  chrome_silicon_a401: { rating: 'fair', modifier: 1.15 },\n  stainless_302: { rating: 'good', modifier: 1.4 },\n  stainless_17_7ph: { rating: 'excellent', modifier: 1.6 },\n  phosphor_bronze: { rating: 'excellent', modifier: 1.5 },\n  beryllium_copper: { rating: 'excellent', modifier: 1.55 },\n};\n\n/**\n * Environmental effect result\n */\nexport interface EnvironmentEffectResult {\n  /** Environment type */\n  environment: EnvironmentType;\n  /** Environment label */\n  environmentLabel: { en: string; zh: string };\n  /** Base corrosion factor */\n  baseCorrosionFactor: number;\n  /** Material resistance modifier */\n  materialModifier: number;\n  /** Effective corrosion factor */\n  effectiveCorrosionFactor: number;\n  /** Fatigue reduction factor */\n  fatigueReductionFactor: number;\n  /** Adjusted endurance limit (MPa) */\n  adjustedEnduranceLimit: number;\n  /** Stress corrosion cracking risk */\n  sccRisk: 'none' | 'low' | 'medium' | 'high';\n  /** Recommendations */\n  recommendations: string[];\n  /** Warning message */\n  warning?: { en: string; zh: string };\n}\n\n/**\n * Get environment configuration\n */\nexport function getEnvironment(type: EnvironmentType): EnvironmentConfig {\n  return ENVIRONMENTS[type];\n}\n\n/**\n * Get all environment options\n */\nexport function getEnvironmentOptions(): Array<{\n  value: EnvironmentType;\n  labelEn: string;\n  labelZh: string;\n}> {\n  return Object.entries(ENVIRONMENTS).map(([key, config]) => ({\n    value: key as EnvironmentType,\n    labelEn: config.label.en,\n    labelZh: config.label.zh,\n  }));\n}\n\n/**\n * Get material corrosion resistance\n */\nexport function getMaterialCorrosionResistance(materialId: SpringMaterialId): {\n  rating: 'poor' | 'fair' | 'good' | 'excellent';\n  modifier: number;\n} {\n  if (materialId in MATERIAL_CORROSION_RESISTANCE) {\n    return MATERIAL_CORROSION_RESISTANCE[materialId];\n  }\n  return { rating: 'poor', modifier: 1.0 };\n}\n\n/**\n * Calculate environmental effects on fatigue\n * 计算环境对疲劳的影响\n * \n * Se_corroded = Se_corrected × k_corrosion × k_material\n */\nexport function calculateEnvironmentEffects(\n  materialId: SpringMaterialId,\n  environmentType: EnvironmentType,\n  baseEnduranceLimit: number\n): EnvironmentEffectResult {\n  const env = getEnvironment(environmentType);\n  const materialResistance = getMaterialCorrosionResistance(materialId);\n  \n  // Calculate effective corrosion factor\n  // Better material resistance improves the factor\n  const effectiveCorrosionFactor = Math.min(\n    1.0,\n    env.corrosionFactor * materialResistance.modifier\n  );\n  \n  // Fatigue reduction\n  const fatigueReductionFactor = Math.min(\n    1.0,\n    env.fatigueReductionFactor * (materialResistance.modifier * 0.8 + 0.2)\n  );\n  \n  // Adjusted endurance limit\n  const adjustedEnduranceLimit = baseEnduranceLimit * fatigueReductionFactor;\n  \n  // Generate recommendations\n  const recommendations: string[] = [];\n  \n  if (materialResistance.rating === 'poor' && env.corrosionFactor < 0.9) {\n    recommendations.push('Consider using corrosion-resistant material (stainless steel)');\n    recommendations.push('Apply protective coating (zinc, nickel, or epoxy)');\n  }\n  \n  if (env.sccRisk === 'high') {\n    recommendations.push('Monitor for stress corrosion cracking');\n    recommendations.push('Consider shot peening to introduce compressive residual stress');\n  }\n  \n  if (env.type === 'salt_spray' || env.type === 'marine') {\n    recommendations.push('Use marine-grade stainless steel (316 or 17-7 PH)');\n    recommendations.push('Regular inspection and maintenance required');\n  }\n  \n  // Warning for severe environments\n  let warning: { en: string; zh: string } | undefined;\n  if (effectiveCorrosionFactor < 0.7) {\n    warning = {\n      en: `WARNING: Severe environmental degradation expected. Fatigue life reduced by ${((1 - fatigueReductionFactor) * 100).toFixed(0)}%`,\n      zh: `警告：预计会有严重的环境退化。疲劳寿命降低 ${((1 - fatigueReductionFactor) * 100).toFixed(0)}%`,\n    };\n  }\n  \n  return {\n    environment: environmentType,\n    environmentLabel: env.label,\n    baseCorrosionFactor: env.corrosionFactor,\n    materialModifier: materialResistance.modifier,\n    effectiveCorrosionFactor,\n    fatigueReductionFactor,\n    adjustedEnduranceLimit,\n    sccRisk: env.sccRisk,\n    recommendations,\n    warning,\n  };\n}\n\n/**\n * Calculate corrosion rate\n * 计算腐蚀速率 (mm/year)\n */\nexport function calculateCorrosionRate(\n  materialId: SpringMaterialId,\n  environmentType: EnvironmentType\n): number {\n  const env = getEnvironment(environmentType);\n  const materialResistance = getMaterialCorrosionResistance(materialId);\n  \n  // Base corrosion rates (mm/year) for carbon steel\n  const baseRates: Record<EnvironmentType, number> = {\n    indoor: 0.01,\n    outdoor: 0.05,\n    humid: 0.08,\n    salt_spray: 0.15,\n    acidic: 0.25,\n    alkaline: 0.12,\n    marine: 0.18,\n    industrial: 0.10,\n  };\n  \n  const baseRate = baseRates[environmentType];\n  \n  // Adjust for material resistance\n  return baseRate / materialResistance.modifier;\n}\n\n/**\n * Estimate wire diameter loss over time\n * 估算线径随时间的损失\n */\nexport function estimateWireDiameterLoss(\n  materialId: SpringMaterialId,\n  environmentType: EnvironmentType,\n  years: number\n): {\n  diameterLoss: number;\n  percentLoss: number;\n  wireDiameter: number;\n} & { originalDiameter?: number } {\n  const corrosionRate = calculateCorrosionRate(materialId, environmentType);\n  \n  // Diameter loss from both sides\n  const diameterLoss = corrosionRate * years * 2;\n  \n  return {\n    diameterLoss,\n    percentLoss: 0, // Will be calculated with original diameter\n    wireDiameter: 0, // Will be calculated with original diameter\n  };\n}\n\n/**\n * Generate corrosion effect table for report\n */\nexport function generateCorrosionEffectTable(\n  materialId: SpringMaterialId\n): Array<{\n  environment: EnvironmentType;\n  label: string;\n  corrosionFactor: number;\n  fatigueReduction: number;\n  corrosionRate: number;\n}> {\n  return Object.keys(ENVIRONMENTS).map((envType) => {\n    const env = ENVIRONMENTS[envType as EnvironmentType];\n    const effects = calculateEnvironmentEffects(\n      materialId,\n      envType as EnvironmentType,\n      100 // Normalized\n    );\n    const corrosionRate = calculateCorrosionRate(materialId, envType as EnvironmentType);\n    \n    return {\n      environment: envType as EnvironmentType,\n      label: env.label.en,\n      corrosionFactor: effects.effectiveCorrosionFactor,\n      fatigueReduction: effects.fatigueReductionFactor,\n      corrosionRate,\n    };\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/failureDiagnostics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/fatigue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/fatigueDamage.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'g' is never reassigned. Use 'const' instead.","line":282,"column":13,"nodeType":"Identifier","messageId":"useConst","endLine":282,"endColumn":14},{"ruleId":"prefer-const","severity":2,"message":"'b' is never reassigned. Use 'const' instead.","line":282,"column":16,"nodeType":"Identifier","messageId":"useConst","endLine":282,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Fatigue Damage Model\n * 弹簧分析引擎 - 疲劳损伤模型\n * \n * Computes damage index D(θ) for fatigue hot-spot visualization\n * using Miner's rule and local stress analysis\n */\n\nimport type { StressSamplePoint, StressDistributionResult } from './stressDistribution';\nimport { getSpringMaterial, type SpringMaterialId } from '@/lib/materials/springMaterials';\n\n/**\n * Fatigue damage point\n */\nexport interface FatigueDamagePoint extends StressSamplePoint {\n  /** Damage index D = ni / Ni */\n  damageIndex: number;\n  /** Local fatigue life Ni (cycles) */\n  localFatigueLife: number;\n  /** Applied cycles ni */\n  appliedCycles: number;\n  /** Damage category */\n  damageCategory: 'safe' | 'moderate' | 'high' | 'failure';\n  /** Damage color RGB */\n  damageColor: [number, number, number];\n  /** Local safety factor */\n  localSafetyFactor: number;\n}\n\n/**\n * Fatigue damage result\n */\nexport interface FatigueDamageResult {\n  /** All damage points */\n  points: FatigueDamagePoint[];\n  /** Maximum damage index */\n  maxDamageIndex: number;\n  /** Minimum damage index */\n  minDamageIndex: number;\n  /** Average damage index */\n  avgDamageIndex: number;\n  /** Miner sum (total accumulated damage) */\n  minerSum: number;\n  /** High damage zone count (D > 0.5) */\n  highDamageZoneCount: number;\n  /** Failure predicted zones (D > 1.0) */\n  failurePredictedCount: number;\n  /** Critical damage locations */\n  criticalLocations: Array<{\n    theta: number;\n    coilNumber: number;\n    damageIndex: number;\n    fatigueLife: number;\n    position: [number, number, number];\n  }>;\n  /** Overall fatigue status */\n  status: 'safe' | 'warning' | 'danger' | 'failure';\n  /** Status message */\n  message: { en: string; zh: string };\n}\n\n/**\n * Damage color thresholds\n */\nexport const DAMAGE_THRESHOLDS = {\n  SAFE_MAX: 0.3,      // D < 0.3: safe (green)\n  MODERATE_MAX: 0.5,  // D < 0.5: moderate (yellow)\n  HIGH_MAX: 1.0,      // D < 1.0: high damage (orange)\n  // D >= 1.0: failure predicted (dark red)\n};\n\n/**\n * Get damage color for damage index\n */\nexport function getDamageColor(damageIndex: number): {\n  category: 'safe' | 'moderate' | 'high' | 'failure';\n  rgb: [number, number, number];\n} {\n  if (damageIndex < DAMAGE_THRESHOLDS.SAFE_MAX) {\n    // Safe: green\n    const t = damageIndex / DAMAGE_THRESHOLDS.SAFE_MAX;\n    return {\n      category: 'safe',\n      rgb: [t * 0.3, 0.8 - t * 0.2, 0.2],\n    };\n  } else if (damageIndex < DAMAGE_THRESHOLDS.MODERATE_MAX) {\n    // Moderate: yellow\n    const t = (damageIndex - DAMAGE_THRESHOLDS.SAFE_MAX) / \n              (DAMAGE_THRESHOLDS.MODERATE_MAX - DAMAGE_THRESHOLDS.SAFE_MAX);\n    return {\n      category: 'moderate',\n      rgb: [0.9, 0.8 - t * 0.3, 0.1],\n    };\n  } else if (damageIndex < DAMAGE_THRESHOLDS.HIGH_MAX) {\n    // High damage: orange to red\n    const t = (damageIndex - DAMAGE_THRESHOLDS.MODERATE_MAX) / \n              (DAMAGE_THRESHOLDS.HIGH_MAX - DAMAGE_THRESHOLDS.MODERATE_MAX);\n    return {\n      category: 'high',\n      rgb: [1, 0.5 - t * 0.3, 0],\n    };\n  } else {\n    // Failure predicted: dark red with pulse effect\n    const t = Math.min(1, (damageIndex - 1) / 0.5);\n    return {\n      category: 'failure',\n      rgb: [0.7 + t * 0.3, 0, 0],\n    };\n  }\n}\n\n/**\n * Calculate local fatigue life using Basquin equation\n * N = (τ_e / τ_a)^(1/b)\n * \n * With Goodman correction for mean stress\n */\nexport function calculateLocalFatigueLife(\n  stressAmplitude: number,\n  meanStress: number,\n  materialId: SpringMaterialId\n): number {\n  const material = getSpringMaterial(materialId);\n  if (!material) return 1e9;\n  \n  const { snCurve, tensileStrength } = material;\n  const Su = tensileStrength ?? 1500; // Ultimate strength\n  \n  // Goodman correction: τ_a_corrected = τ_a / (1 - τ_m / Su)\n  const goodmanFactor = 1 - meanStress / Su;\n  if (goodmanFactor <= 0) return 1; // Immediate failure\n  \n  const correctedAmplitude = stressAmplitude / goodmanFactor;\n  \n  // Basquin equation: N = (τ_e / τ_a)^(1/b)\n  // Using S-N curve data to determine b\n  const { N1, tau1, N2, tau2 } = snCurve;\n  const b = Math.log(tau1 / tau2) / Math.log(N2 / N1);\n  \n  // Endurance limit (at N2 cycles)\n  const enduranceLimit = tau2;\n  \n  if (correctedAmplitude <= enduranceLimit) {\n    return 1e9; // Infinite life\n  }\n  \n  // Calculate fatigue life\n  const N = N2 * Math.pow(enduranceLimit / correctedAmplitude, 1 / b);\n  \n  return Math.max(1, Math.min(N, 1e9));\n}\n\n/**\n * Calculate fatigue damage distribution\n */\nexport function calculateFatigueDamage(\n  stressDistribution: StressDistributionResult,\n  materialId: SpringMaterialId,\n  appliedCycles: number,\n  minStress: number,\n  maxStress: number\n): FatigueDamageResult {\n  const damagePoints: FatigueDamagePoint[] = [];\n  \n  // Calculate stress amplitude and mean\n  const stressAmplitude = (maxStress - minStress) / 2;\n  const meanStress = (maxStress + minStress) / 2;\n  \n  let totalDamage = 0;\n  let highDamageZoneCount = 0;\n  let failurePredictedCount = 0;\n  const criticalLocations: FatigueDamageResult['criticalLocations'] = [];\n  \n  for (const point of stressDistribution.points) {\n    // Scale stress amplitude by local normalized stress\n    const localAmplitude = stressAmplitude * point.normalizedStress;\n    const localMean = meanStress * point.normalizedStress;\n    \n    // Calculate local fatigue life\n    const localFatigueLife = calculateLocalFatigueLife(localAmplitude, localMean, materialId);\n    \n    // Calculate damage index D = ni / Ni\n    const damageIndex = appliedCycles / localFatigueLife;\n    \n    // Get damage color\n    const { category, rgb } = getDamageColor(damageIndex);\n    \n    // Calculate local safety factor\n    const localSafetyFactor = localFatigueLife / appliedCycles;\n    \n    const damagePoint: FatigueDamagePoint = {\n      ...point,\n      damageIndex,\n      localFatigueLife,\n      appliedCycles,\n      damageCategory: category,\n      damageColor: rgb,\n      localSafetyFactor,\n    };\n    \n    damagePoints.push(damagePoint);\n    totalDamage += damageIndex;\n    \n    // Track high damage and failure zones\n    if (damageIndex > 0.5) {\n      highDamageZoneCount++;\n    }\n    if (damageIndex >= 1.0) {\n      failurePredictedCount++;\n      criticalLocations.push({\n        theta: point.theta,\n        coilNumber: point.coilNumber,\n        damageIndex,\n        fatigueLife: localFatigueLife,\n        position: point.position,\n      });\n    }\n  }\n  \n  // Calculate statistics\n  const damageIndices = damagePoints.map(p => p.damageIndex);\n  const maxDamageIndex = Math.max(...damageIndices);\n  const minDamageIndex = Math.min(...damageIndices);\n  const avgDamageIndex = damageIndices.reduce((a, b) => a + b, 0) / damageIndices.length;\n  const minerSum = totalDamage / damagePoints.length; // Average Miner sum\n  \n  // Determine overall status\n  let status: FatigueDamageResult['status'];\n  let message: { en: string; zh: string };\n  \n  if (failurePredictedCount > 0) {\n    status = 'failure';\n    message = {\n      en: `FAILURE PREDICTED: ${failurePredictedCount} locations exceed damage limit (D ≥ 1.0)`,\n      zh: `预测失效：${failurePredictedCount} 个位置超过损伤极限 (D ≥ 1.0)`,\n    };\n  } else if (highDamageZoneCount > 0 || maxDamageIndex > 0.5) {\n    status = 'danger';\n    message = {\n      en: `HIGH DAMAGE RISK: ${highDamageZoneCount} high damage zones detected (D > 0.5)`,\n      zh: `高损伤风险：检测到 ${highDamageZoneCount} 个高损伤区域 (D > 0.5)`,\n    };\n  } else if (maxDamageIndex > 0.3) {\n    status = 'warning';\n    message = {\n      en: `Moderate fatigue damage accumulation (max D = ${maxDamageIndex.toFixed(3)})`,\n      zh: `中等疲劳损伤累积 (最大 D = ${maxDamageIndex.toFixed(3)})`,\n    };\n  } else {\n    status = 'safe';\n    message = {\n      en: `Fatigue damage within safe limits (max D = ${maxDamageIndex.toFixed(3)})`,\n      zh: `疲劳损伤在安全范围内 (最大 D = ${maxDamageIndex.toFixed(3)})`,\n    };\n  }\n  \n  return {\n    points: damagePoints,\n    maxDamageIndex,\n    minDamageIndex,\n    avgDamageIndex,\n    minerSum,\n    highDamageZoneCount,\n    failurePredictedCount,\n    criticalLocations,\n    status,\n    message,\n  };\n}\n\n/**\n * Generate damage vertex colors for Three.js\n */\nexport function generateDamageVertexColors(\n  damageResult: FatigueDamageResult,\n  pulsePhase: number = 0 // 0-1 for animation\n): Float32Array {\n  const colors = new Float32Array(damageResult.points.length * 3);\n  \n  for (let i = 0; i < damageResult.points.length; i++) {\n    const point = damageResult.points[i];\n    let [r, g, b] = point.damageColor;\n    \n    // Add pulse effect for failure zones\n    if (point.damageCategory === 'failure') {\n      const pulse = 0.3 * Math.sin(pulsePhase * Math.PI * 2);\n      r = Math.min(1, r + pulse);\n    }\n    \n    colors[i * 3] = r;\n    colors[i * 3 + 1] = g;\n    colors[i * 3 + 2] = b;\n  }\n  \n  return colors;\n}\n\n/**\n * Get tooltip data for a damage point\n */\nexport function getDamagePointTooltip(\n  point: FatigueDamagePoint,\n  language: 'en' | 'zh' = 'en'\n): string {\n  if (language === 'zh') {\n    return `位置: θ = ${(point.theta * 180 / Math.PI).toFixed(1)}°, 圈数 = ${point.coilNumber.toFixed(2)}\n局部应力: ${point.localStress.toFixed(1)} MPa\n疲劳寿命: ${point.localFatigueLife > 1e8 ? '∞' : point.localFatigueLife.toExponential(2)} 次\n损伤指数: ${point.damageIndex.toFixed(4)}\n安全系数: ${point.localSafetyFactor > 100 ? '>100' : point.localSafetyFactor.toFixed(2)}`;\n  }\n  \n  return `Location: θ = ${(point.theta * 180 / Math.PI).toFixed(1)}°, Coil = ${point.coilNumber.toFixed(2)}\nLocal Stress: ${point.localStress.toFixed(1)} MPa\nFatigue Life: ${point.localFatigueLife > 1e8 ? '∞' : point.localFatigueLife.toExponential(2)} cycles\nDamage Index: ${point.damageIndex.toFixed(4)}\nSafety Factor: ${point.localSafetyFactor > 100 ? '>100' : point.localSafetyFactor.toFixed(2)}`;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/feaExport.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'refineFactor' is assigned a value but never used.","line":141,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":141,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'geometry' is defined but never used.","line":493,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":493,"endColumn":11},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'mesh' is defined but never used.","line":531,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":531,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'geometry' is defined but never used.","line":532,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":532,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - FEA Mesh Export Module\n * 弹簧分析引擎 - FEA 网格导出模块\n * \n * Exports spring geometry for FEA analysis:\n * - STEP format\n * - IGES format\n * - Abaqus .inp mesh format\n * - ANSYS mesh format\n */\n\nimport type { SpringGeometry, CompressionSpringGeometry, ConicalSpringGeometry } from './types';\nimport type { CoilingProcessResult } from './coilingProcess';\nimport type { ShotPeeningResult } from './shotPeening';\n\n/**\n * FEA export format\n */\nexport type FEAExportFormat = 'step' | 'iges' | 'abaqus' | 'ansys' | 'nastran';\n\n/**\n * Residual stress field data for FEA\n */\nexport interface ResidualStressField {\n  /** Coiling process residual stresses */\n  coilingStress?: CoilingProcessResult;\n  /** Shot peening residual stresses */\n  shotPeeningStress?: ShotPeeningResult;\n  /** Combined residual stress at each node (MPa) */\n  nodalStress?: {\n    nodeId: number;\n    axial: number;\n    hoop: number;\n    radial: number;\n    vonMises: number;\n  }[];\n}\n\n/**\n * Mesh node\n */\nexport interface MeshNode {\n  id: number;\n  x: number;\n  y: number;\n  z: number;\n}\n\n/**\n * Mesh element\n */\nexport interface MeshElement {\n  id: number;\n  type: 'beam' | 'solid' | 'shell';\n  nodes: number[];\n}\n\n/**\n * FEA mesh data\n */\nexport interface FEAMeshData {\n  /** Mesh nodes */\n  nodes: MeshNode[];\n  /** Mesh elements */\n  elements: MeshElement[];\n  /** Total wire length (mm) */\n  wireLength: number;\n  /** Node count */\n  nodeCount: number;\n  /** Element count */\n  elementCount: number;\n  /** Mesh quality metrics */\n  quality: {\n    minElementLength: number;\n    maxElementLength: number;\n    avgElementLength: number;\n    aspectRatio: number;\n  };\n}\n\n/**\n * Export options\n */\nexport interface FEAExportOptions {\n  /** Export format */\n  format: FEAExportFormat;\n  /** Element type */\n  elementType: 'beam' | 'solid';\n  /** Nodes per coil */\n  nodesPerCoil: number;\n  /** Include material properties */\n  includeMaterial: boolean;\n  /** Include boundary conditions */\n  includeBoundaryConditions: boolean;\n  /** Mesh refinement at ends */\n  refineEnds: boolean;\n  /** Wire diameter for solid mesh */\n  wireDiameter?: number;\n  /** Circumferential divisions for solid mesh */\n  circumferentialDivisions?: number;\n  /** Include residual stress field (Phase 6) */\n  includeResidualStress?: boolean;\n  /** Residual stress data */\n  residualStressField?: ResidualStressField;\n}\n\n/**\n * Default export options\n */\nexport const DEFAULT_EXPORT_OPTIONS: FEAExportOptions = {\n  format: 'abaqus',\n  elementType: 'beam',\n  nodesPerCoil: 36,\n  includeMaterial: true,\n  includeBoundaryConditions: true,\n  refineEnds: true,\n};\n\n/**\n * Generate spring centerline points\n */\nexport function generateCenterlinePoints(\n  geometry: SpringGeometry,\n  nodesPerCoil: number = 36,\n  refineEnds: boolean = true\n): Array<{ x: number; y: number; z: number; theta: number }> {\n  const points: Array<{ x: number; y: number; z: number; theta: number }> = [];\n  \n  if (geometry.type === 'compression') {\n    const compGeom = geometry as CompressionSpringGeometry;\n    const { wireDiameter, meanDiameter, activeCoils, freeLength } = compGeom;\n    const totalCoils = compGeom.totalCoils ?? activeCoils + 2;\n    const deadCoils = totalCoils - activeCoils;\n    \n    const R = meanDiameter / 2;\n    const pitch = (freeLength - deadCoils * wireDiameter) / activeCoils;\n    const deadPitch = wireDiameter;\n    \n    // Calculate total points\n    const totalPoints = Math.ceil(totalCoils * nodesPerCoil);\n    const refineFactor = refineEnds ? 2 : 1;\n    \n    for (let i = 0; i <= totalPoints; i++) {\n      const t = i / totalPoints;\n      const theta = t * 2 * Math.PI * totalCoils;\n      const coilNum = theta / (2 * Math.PI);\n      \n      // Determine if in dead or active region\n      const deadBottom = deadCoils / 2;\n      const deadTop = totalCoils - deadCoils / 2;\n      \n      let z: number;\n      if (coilNum < deadBottom) {\n        z = coilNum * deadPitch;\n      } else if (coilNum > deadTop) {\n        z = deadBottom * deadPitch + activeCoils * pitch + (coilNum - deadTop) * deadPitch;\n      } else {\n        z = deadBottom * deadPitch + (coilNum - deadBottom) * pitch;\n      }\n      \n      const x = R * Math.cos(theta);\n      const y = R * Math.sin(theta);\n      \n      points.push({ x, y, z, theta });\n    }\n  } else if (geometry.type === 'conical') {\n    const conicalGeom = geometry as ConicalSpringGeometry;\n    const { wireDiameter, largeOuterDiameter, smallOuterDiameter, activeCoils, freeLength } = conicalGeom;\n    const totalCoils = conicalGeom.totalCoils ?? activeCoils + 2;\n    \n    const R_large = (largeOuterDiameter - wireDiameter) / 2;\n    const R_small = (smallOuterDiameter - wireDiameter) / 2;\n    \n    const totalPoints = Math.ceil(totalCoils * nodesPerCoil);\n    \n    for (let i = 0; i <= totalPoints; i++) {\n      const t = i / totalPoints;\n      const theta = t * 2 * Math.PI * totalCoils;\n      \n      // Linearly varying radius\n      const R = R_large - (R_large - R_small) * t;\n      const z = freeLength * t;\n      \n      const x = R * Math.cos(theta);\n      const y = R * Math.sin(theta);\n      \n      points.push({ x, y, z, theta });\n    }\n  }\n  \n  return points;\n}\n\n/**\n * Generate FEA mesh from geometry\n */\nexport function generateFEAMesh(\n  geometry: SpringGeometry,\n  options: Partial<FEAExportOptions> = {}\n): FEAMeshData {\n  const opts = { ...DEFAULT_EXPORT_OPTIONS, ...options };\n  \n  // Generate centerline points\n  const centerlinePoints = generateCenterlinePoints(geometry, opts.nodesPerCoil, opts.refineEnds);\n  \n  // Create nodes\n  const nodes: MeshNode[] = centerlinePoints.map((pt, i) => ({\n    id: i + 1,\n    x: pt.x,\n    y: pt.y,\n    z: pt.z,\n  }));\n  \n  // Create elements\n  const elements: MeshElement[] = [];\n  for (let i = 0; i < nodes.length - 1; i++) {\n    elements.push({\n      id: i + 1,\n      type: opts.elementType,\n      nodes: [nodes[i].id, nodes[i + 1].id],\n    });\n  }\n  \n  // Calculate wire length\n  let wireLength = 0;\n  for (let i = 0; i < nodes.length - 1; i++) {\n    const dx = nodes[i + 1].x - nodes[i].x;\n    const dy = nodes[i + 1].y - nodes[i].y;\n    const dz = nodes[i + 1].z - nodes[i].z;\n    wireLength += Math.sqrt(dx * dx + dy * dy + dz * dz);\n  }\n  \n  // Calculate mesh quality\n  const elementLengths: number[] = [];\n  for (let i = 0; i < nodes.length - 1; i++) {\n    const dx = nodes[i + 1].x - nodes[i].x;\n    const dy = nodes[i + 1].y - nodes[i].y;\n    const dz = nodes[i + 1].z - nodes[i].z;\n    elementLengths.push(Math.sqrt(dx * dx + dy * dy + dz * dz));\n  }\n  \n  const minElementLength = Math.min(...elementLengths);\n  const maxElementLength = Math.max(...elementLengths);\n  const avgElementLength = elementLengths.reduce((a, b) => a + b, 0) / elementLengths.length;\n  const aspectRatio = maxElementLength / minElementLength;\n  \n  return {\n    nodes,\n    elements,\n    wireLength,\n    nodeCount: nodes.length,\n    elementCount: elements.length,\n    quality: {\n      minElementLength,\n      maxElementLength,\n      avgElementLength,\n      aspectRatio,\n    },\n  };\n}\n\n/**\n * Export to Abaqus .inp format\n */\nexport function exportToAbaqus(\n  mesh: FEAMeshData,\n  geometry: SpringGeometry,\n  options: Partial<FEAExportOptions> = {}\n): string {\n  const opts = { ...DEFAULT_EXPORT_OPTIONS, ...options };\n  \n  let inp = `*HEADING\nSpring FEA Model - Generated by ISRI-SHUANGDI Platform\nSpring Type: ${geometry.type}\nWire Diameter: ${geometry.wireDiameter} mm\nActive Coils: ${geometry.activeCoils}\n**\n`;\n\n  // Nodes\n  inp += `*NODE\\n`;\n  for (const node of mesh.nodes) {\n    inp += `${node.id}, ${node.x.toFixed(6)}, ${node.y.toFixed(6)}, ${node.z.toFixed(6)}\\n`;\n  }\n  \n  // Elements\n  if (opts.elementType === 'beam') {\n    inp += `*ELEMENT, TYPE=B31, ELSET=SPRING_COIL\\n`;\n  } else {\n    inp += `*ELEMENT, TYPE=C3D8, ELSET=SPRING_COIL\\n`;\n  }\n  \n  for (const elem of mesh.elements) {\n    inp += `${elem.id}, ${elem.nodes.join(', ')}\\n`;\n  }\n  \n  // Material\n  if (opts.includeMaterial) {\n    inp += `**\n*MATERIAL, NAME=SPRING_STEEL\n*ELASTIC\n207000.0, 0.3\n*DENSITY\n7.85E-09\n**\n*BEAM SECTION, ELSET=SPRING_COIL, MATERIAL=SPRING_STEEL, SECTION=CIRC\n${geometry.wireDiameter / 2}\n**\n`;\n  }\n  \n  // Boundary conditions\n  if (opts.includeBoundaryConditions) {\n    inp += `**\n*BOUNDARY\n1, 1, 6\n${mesh.nodes.length}, 3, 3\n**\n`;\n  }\n\n  // Residual stress field (Phase 6)\n  if (opts.includeResidualStress && opts.residualStressField) {\n    const rsf = opts.residualStressField;\n    \n    inp += `** ============================================\n** RESIDUAL STRESS FIELD (Phase 6 Manufacturing)\n** ============================================\n`;\n    \n    // Coiling residual stress\n    if (rsf.coilingStress) {\n      inp += `** Coiling Process Residual Stresses:\n** - Bending Stress: ${rsf.coilingStress.residualBendingStress.toFixed(1)} MPa\n** - Torsional Stress: ${rsf.coilingStress.residualTorsionalStress.toFixed(1)} MPa\n** - Springback Angle: ${rsf.coilingStress.springbackAngle.toFixed(2)} deg\n**\n`;\n    }\n    \n    // Shot peening residual stress\n    if (rsf.shotPeeningStress) {\n      inp += `** Shot Peening Residual Stresses:\n** - Surface Compressive: ${rsf.shotPeeningStress.surfaceStress.toFixed(0)} MPa\n** - Effective Depth: ${rsf.shotPeeningStress.effectiveDepth.toFixed(3)} mm\n** - Endurance Enhancement: ${rsf.shotPeeningStress.enduranceEnhancementFactor.toFixed(2)}x\n**\n`;\n      \n      // Add shot peening stress profile as initial stress\n      inp += `*INITIAL CONDITIONS, TYPE=STRESS\n** Element, S11, S22, S33, S12, S13, S23\n`;\n      // Apply surface compressive stress to all elements\n      const surfaceStress = rsf.shotPeeningStress.surfaceStress;\n      for (const elem of mesh.elements) {\n        // Simplified: apply uniform compressive stress in hoop direction\n        inp += `${elem.id}, ${(-surfaceStress * 0.3).toFixed(1)}, ${(-surfaceStress).toFixed(1)}, 0.0, 0.0, 0.0, 0.0\\n`;\n      }\n      inp += `**\\n`;\n    }\n    \n    // Nodal residual stress field\n    if (rsf.nodalStress && rsf.nodalStress.length > 0) {\n      inp += `** Nodal Residual Stress Field (von Mises):\n*NSET, NSET=RESIDUAL_STRESS_NODES\n`;\n      const nodeIds = rsf.nodalStress.map(ns => ns.nodeId);\n      for (let i = 0; i < nodeIds.length; i += 10) {\n        inp += nodeIds.slice(i, i + 10).join(', ') + '\\n';\n      }\n      inp += `**\n** Node stress values stored as user-defined field\n*INITIAL CONDITIONS, TYPE=FIELD, VARIABLE=1\n`;\n      for (const ns of rsf.nodalStress) {\n        inp += `${ns.nodeId}, ${ns.vonMises.toFixed(1)}\\n`;\n      }\n      inp += `**\\n`;\n    }\n  }\n  \n  // Step\n  inp += `*STEP, NAME=LOAD\n*STATIC\n1.0, 1.0\n*CLOAD\n${mesh.nodes.length}, 3, -100.0\n*OUTPUT, FIELD\n*NODE OUTPUT\nU, RF\n*ELEMENT OUTPUT\nS, E\n*END STEP\n`;\n\n  return inp;\n}\n\n/**\n * Export to ANSYS format\n */\nexport function exportToANSYS(\n  mesh: FEAMeshData,\n  geometry: SpringGeometry\n): string {\n  let ansys = `/PREP7\n! Spring FEA Model - Generated by ISRI-SHUANGDI Platform\n! Spring Type: ${geometry.type}\n! Wire Diameter: ${geometry.wireDiameter} mm\n\n! Material Properties\nMP,EX,1,207000\nMP,PRXY,1,0.3\nMP,DENS,1,7.85E-9\n\n! Element Type\nET,1,BEAM188\nSECTYPE,1,BEAM,CSOLID\nSECDATA,${geometry.wireDiameter / 2}\n\n! Nodes\n`;\n\n  for (const node of mesh.nodes) {\n    ansys += `N,${node.id},${node.x.toFixed(6)},${node.y.toFixed(6)},${node.z.toFixed(6)}\\n`;\n  }\n  \n  ansys += `\\n! Elements\\n`;\n  for (const elem of mesh.elements) {\n    ansys += `E,${elem.nodes.join(',')}\\n`;\n  }\n  \n  ansys += `\n! Boundary Conditions\nD,1,ALL\nD,${mesh.nodes.length},UX,0\nD,${mesh.nodes.length},UY,0\n\n! Load\nF,${mesh.nodes.length},FZ,-100\n\nFINISH\n/SOLU\nSOLVE\nFINISH\n`;\n\n  return ansys;\n}\n\n/**\n * Export to NASTRAN format\n */\nexport function exportToNASTRAN(\n  mesh: FEAMeshData,\n  geometry: SpringGeometry\n): string {\n  let nastran = `$ Spring FEA Model - Generated by ISRI-SHUANGDI Platform\n$ Spring Type: ${geometry.type}\n$ Wire Diameter: ${geometry.wireDiameter} mm\nBEGIN BULK\n`;\n\n  // Grid points (nodes)\n  for (const node of mesh.nodes) {\n    nastran += `GRID    ${node.id.toString().padStart(8)}        ${node.x.toFixed(4).padStart(8)}${node.y.toFixed(4).padStart(8)}${node.z.toFixed(4).padStart(8)}\\n`;\n  }\n  \n  // CBAR elements\n  for (const elem of mesh.elements) {\n    nastran += `CBAR    ${elem.id.toString().padStart(8)}       1${elem.nodes[0].toString().padStart(8)}${elem.nodes[1].toString().padStart(8)}0.0     1.0     0.0\\n`;\n  }\n  \n  // Material\n  nastran += `MAT1           1  207000.             0.3   7.85-9\\n`;\n  \n  // Property\n  const area = Math.PI * Math.pow(geometry.wireDiameter / 2, 2);\n  const I = Math.PI * Math.pow(geometry.wireDiameter / 2, 4) / 4;\n  nastran += `PBAR           1       1${area.toFixed(4).padStart(8)}${I.toFixed(4).padStart(8)}${I.toFixed(4).padStart(8)}${(2 * I).toFixed(4).padStart(8)}\\n`;\n  \n  nastran += `ENDDATA\\n`;\n  \n  return nastran;\n}\n\n/**\n * Export to STEP format (simplified representation)\n */\nexport function exportToSTEP(\n  mesh: FEAMeshData,\n  geometry: SpringGeometry\n): string {\n  // STEP format is complex - this generates a simplified version\n  // In production, use a proper CAD kernel like OpenCascade\n  \n  let step = `ISO-10303-21;\nHEADER;\nFILE_DESCRIPTION(('Spring Geometry'),'2;1');\nFILE_NAME('spring.step','${new Date().toISOString()}',('ISRI-SHUANGDI'),(''),'',' ','');\nFILE_SCHEMA(('AUTOMOTIVE_DESIGN'));\nENDSEC;\nDATA;\n`;\n\n  // Add points as cartesian points\n  let entityId = 1;\n  const pointIds: number[] = [];\n  \n  for (const node of mesh.nodes) {\n    step += `#${entityId}=CARTESIAN_POINT('',( ${node.x.toFixed(6)}, ${node.y.toFixed(6)}, ${node.z.toFixed(6)} ));\\n`;\n    pointIds.push(entityId);\n    entityId++;\n  }\n  \n  // Create polyline\n  step += `#${entityId}=POLYLINE('Spring_Centerline',(${pointIds.map(id => `#${id}`).join(',')}));\\n`;\n  \n  step += `ENDSEC;\nEND-ISO-10303-21;\n`;\n\n  return step;\n}\n\n/**\n * Export to IGES format (simplified)\n */\nexport function exportToIGES(\n  mesh: FEAMeshData,\n  geometry: SpringGeometry\n): string {\n  const now = new Date();\n  const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}.${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;\n  \n  let iges = `                                                                        S      1\n1H,,1H;,7Hspring;,12Hspring.iges,44HISRI-SHUANGDI Spring Engineering Platform,G      1\n32,38,6,308,15,,1.,1,2HMM,1,0.001,${dateStr},0.0001,1000.,                    G      2\n5Hguest,11HISRI-SHUANGDI,11,0,${dateStr};                                    G      3\n`;\n\n  // Directory entries and parameter data would go here\n  // This is a simplified version\n  \n  iges += `S      1G      3D      0P      0                                        T      1\\n`;\n  \n  return iges;\n}\n\n/**\n * Export mesh to specified format\n */\nexport function exportFEAMesh(\n  geometry: SpringGeometry,\n  format: FEAExportFormat,\n  options: Partial<FEAExportOptions> = {}\n): {\n  content: string;\n  filename: string;\n  mimeType: string;\n  mesh: FEAMeshData;\n} {\n  const mesh = generateFEAMesh(geometry, options);\n  \n  let content: string;\n  let filename: string;\n  let mimeType: string;\n  \n  switch (format) {\n    case 'abaqus':\n      content = exportToAbaqus(mesh, geometry, options);\n      filename = 'spring_model.inp';\n      mimeType = 'text/plain';\n      break;\n    case 'ansys':\n      content = exportToANSYS(mesh, geometry);\n      filename = 'spring_model.ans';\n      mimeType = 'text/plain';\n      break;\n    case 'nastran':\n      content = exportToNASTRAN(mesh, geometry);\n      filename = 'spring_model.bdf';\n      mimeType = 'text/plain';\n      break;\n    case 'step':\n      content = exportToSTEP(mesh, geometry);\n      filename = 'spring_model.step';\n      mimeType = 'application/step';\n      break;\n    case 'iges':\n      content = exportToIGES(mesh, geometry);\n      filename = 'spring_model.igs';\n      mimeType = 'application/iges';\n      break;\n    default:\n      throw new Error(`Unknown export format: ${format}`);\n  }\n  \n  return { content, filename, mimeType, mesh };\n}\n\n/**\n * Download FEA mesh file\n */\nexport function downloadFEAMesh(\n  geometry: SpringGeometry,\n  format: FEAExportFormat,\n  options: Partial<FEAExportOptions> = {}\n): void {\n  const { content, filename, mimeType } = exportFEAMesh(geometry, format, options);\n  \n  const blob = new Blob([content], { type: mimeType });\n  const url = URL.createObjectURL(blob);\n  \n  const link = document.createElement('a');\n  link.href = url;\n  link.download = filename;\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  URL.revokeObjectURL(url);\n}\n\n/**\n * Generate residual stress field from manufacturing data (Phase 6)\n */\nexport function generateResidualStressField(\n  mesh: FEAMeshData,\n  coilingResult?: CoilingProcessResult,\n  shotPeeningResult?: ShotPeeningResult\n): ResidualStressField {\n  const nodalStress: ResidualStressField['nodalStress'] = [];\n  \n  for (const node of mesh.nodes) {\n    let axial = 0;\n    let hoop = 0;\n    const radial = 0;\n    \n    // Add coiling residual stress (varies through wire cross-section)\n    if (coilingResult) {\n      // Simplified: apply average residual stress\n      // In reality, this varies with position in wire cross-section\n      axial += coilingResult.residualBendingStress * 0.5;\n      hoop += coilingResult.residualTorsionalStress * 0.3;\n    }\n    \n    // Add shot peening residual stress (surface compressive)\n    if (shotPeeningResult) {\n      // Surface compressive stress (negative = compressive)\n      hoop -= shotPeeningResult.surfaceStress;\n      axial -= shotPeeningResult.surfaceStress * 0.3;\n    }\n    \n    // Calculate von Mises equivalent stress\n    const vonMises = Math.sqrt(\n      0.5 * (\n        Math.pow(axial - hoop, 2) +\n        Math.pow(hoop - radial, 2) +\n        Math.pow(radial - axial, 2)\n      )\n    );\n    \n    nodalStress.push({\n      nodeId: node.id,\n      axial,\n      hoop,\n      radial,\n      vonMises,\n    });\n  }\n  \n  return {\n    coilingStress: coilingResult,\n    shotPeeningStress: shotPeeningResult,\n    nodalStress,\n  };\n}\n\n/**\n * Export FEA mesh with residual stress field (Phase 6 enhanced)\n */\nexport function exportFEAMeshWithResidualStress(\n  geometry: SpringGeometry,\n  format: FEAExportFormat,\n  coilingResult?: CoilingProcessResult,\n  shotPeeningResult?: ShotPeeningResult,\n  options: Partial<FEAExportOptions> = {}\n): {\n  content: string;\n  filename: string;\n  mimeType: string;\n  mesh: FEAMeshData;\n  residualStressField: ResidualStressField;\n} {\n  const mesh = generateFEAMesh(geometry, options);\n  \n  // Generate residual stress field\n  const residualStressField = generateResidualStressField(\n    mesh,\n    coilingResult,\n    shotPeeningResult\n  );\n  \n  // Add residual stress to options\n  const enhancedOptions: Partial<FEAExportOptions> = {\n    ...options,\n    includeResidualStress: true,\n    residualStressField,\n  };\n  \n  const { content, filename, mimeType } = exportFEAMesh(geometry, format, enhancedOptions);\n  \n  return { content, filename, mimeType, mesh, residualStressField };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/forceCurve.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/friction.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/geometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/geometryAdapters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/hookStress.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringMaterialId' is defined but never used.","line":9,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":50}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Extension Spring Hook Stress Analyzer\n * 弹簧分析引擎 - 拉伸弹簧钩子应力分析器\n * \n * Hook stress calculation and fatigue safety factor\n */\n\nimport type { ExtensionSpringGeometry } from './types';\nimport { getSpringMaterial, type SpringMaterialId } from '@/lib/materials/springMaterials';\n\nconst PI = Math.PI;\n\n/**\n * Hook types\n */\nexport type HookType = \n  | 'machine'      // Standard machine hook\n  | 'crossover'    // Crossover center hook\n  | 'side'         // Side hook\n  | 'extended'     // Extended hook\n  | 'reduced'      // Reduced hook\n  | 'v_hook'       // V-hook\n  | 'double_loop'; // Double loop\n\n/**\n * Hook stress result\n */\nexport interface HookStressResult {\n  /** Hook type */\n  hookType: HookType;\n  /** Bending stress at hook (MPa) */\n  bendingStress: number;\n  /** Torsional stress at hook (MPa) */\n  torsionalStress: number;\n  /** Combined stress (von Mises) (MPa) */\n  combinedStress: number;\n  /** Hook stress concentration factor */\n  stressConcentrationFactor: number;\n  /** Hook safety factor */\n  hookSafetyFactor: number;\n  /** Body safety factor (for comparison) */\n  bodySafetyFactor: number;\n  /** Critical location */\n  criticalLocation: 'hook_bend' | 'hook_transition' | 'body';\n  /** Hook fatigue safety factor */\n  hookFatigueSafetyFactor: number;\n  /** Status */\n  status: 'safe' | 'warning' | 'danger';\n  /** Message */\n  message: { en: string; zh: string };\n}\n\n/**\n * Hook geometry factors\n */\nexport const HOOK_FACTORS: Record<HookType, {\n  /** Bending stress factor */\n  Kb: number;\n  /** Torsional stress factor */\n  Kt: number;\n  /** Stress concentration factor */\n  Kf: number;\n  /** Description */\n  description: { en: string; zh: string };\n}> = {\n  machine: {\n    Kb: 1.0,\n    Kt: 1.0,\n    Kf: 1.2,\n    description: { en: 'Standard machine hook', zh: '标准机械钩' },\n  },\n  crossover: {\n    Kb: 1.1,\n    Kt: 1.05,\n    Kf: 1.3,\n    description: { en: 'Crossover center hook', zh: '交叉中心钩' },\n  },\n  side: {\n    Kb: 1.15,\n    Kt: 1.1,\n    Kf: 1.35,\n    description: { en: 'Side hook', zh: '侧钩' },\n  },\n  extended: {\n    Kb: 0.95,\n    Kt: 0.95,\n    Kf: 1.15,\n    description: { en: 'Extended hook (lower stress)', zh: '加长钩（应力较低）' },\n  },\n  reduced: {\n    Kb: 1.25,\n    Kt: 1.2,\n    Kf: 1.5,\n    description: { en: 'Reduced hook (higher stress)', zh: '缩短钩（应力较高）' },\n  },\n  v_hook: {\n    Kb: 1.2,\n    Kt: 1.15,\n    Kf: 1.4,\n    description: { en: 'V-hook', zh: 'V型钩' },\n  },\n  double_loop: {\n    Kb: 0.9,\n    Kt: 0.9,\n    Kf: 1.1,\n    description: { en: 'Double loop (lowest stress)', zh: '双环（应力最低）' },\n  },\n};\n\n/**\n * Calculate hook bending stress\n * 计算钩子弯曲应力\n * \n * σ_hook = 32M / (π × d³) × Kb × Kf\n * \n * Where:\n * - M = F × r (moment from force at hook radius)\n * - r = hook radius ≈ mean diameter / 2\n */\nexport function calculateHookBendingStress(\n  force: number,\n  wireDiameter: number,\n  meanDiameter: number,\n  hookType: HookType = 'machine'\n): number {\n  const factors = HOOK_FACTORS[hookType];\n  \n  // Hook radius (typically same as mean coil radius)\n  const hookRadius = meanDiameter / 2;\n  \n  // Bending moment\n  const M = force * hookRadius;\n  \n  // Bending stress with factors\n  const sigma = (32 * M) / (PI * Math.pow(wireDiameter, 3));\n  \n  return sigma * factors.Kb * factors.Kf;\n}\n\n/**\n * Calculate hook torsional stress\n * 计算钩子扭转应力\n * \n * τ_hook = 8FD / (π × d³) × Kt × Kf\n */\nexport function calculateHookTorsionalStress(\n  force: number,\n  wireDiameter: number,\n  meanDiameter: number,\n  hookType: HookType = 'machine'\n): number {\n  const factors = HOOK_FACTORS[hookType];\n  \n  // Torsional stress (similar to body shear stress)\n  const tau = (8 * force * meanDiameter) / (PI * Math.pow(wireDiameter, 3));\n  \n  return tau * factors.Kt * factors.Kf;\n}\n\n/**\n * Calculate combined hook stress (von Mises)\n * 计算组合钩子应力（von Mises）\n * \n * σ_vm = √(σ² + 3τ²)\n */\nexport function calculateCombinedHookStress(\n  bendingStress: number,\n  torsionalStress: number\n): number {\n  return Math.sqrt(\n    bendingStress * bendingStress + 3 * torsionalStress * torsionalStress\n  );\n}\n\n/**\n * Calculate hook safety factor\n * 计算钩子安全系数\n */\nexport function calculateHookSafetyFactor(\n  combinedStress: number,\n  allowableStress: number\n): number {\n  if (combinedStress <= 0) return Infinity;\n  return allowableStress / combinedStress;\n}\n\n/**\n * Calculate complete hook stress analysis\n * 计算完整钩子应力分析\n */\nexport function calculateHookStress(\n  geometry: ExtensionSpringGeometry,\n  force: number,\n  bodyShearStress: number,\n  hookType: HookType = 'machine'\n): HookStressResult {\n  const material = getSpringMaterial(geometry.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${geometry.materialId}`);\n  }\n\n  const { wireDiameter, meanDiameter } = geometry;\n  const allowableStress = material.allowShearStatic;\n  \n  // Calculate hook stresses\n  const bendingStress = calculateHookBendingStress(\n    force,\n    wireDiameter,\n    meanDiameter,\n    hookType\n  );\n  \n  const torsionalStress = calculateHookTorsionalStress(\n    force,\n    wireDiameter,\n    meanDiameter,\n    hookType\n  );\n  \n  const combinedStress = calculateCombinedHookStress(bendingStress, torsionalStress);\n  \n  // Calculate safety factors\n  const hookSafetyFactor = calculateHookSafetyFactor(combinedStress, allowableStress);\n  const bodySafetyFactor = calculateHookSafetyFactor(bodyShearStress, allowableStress);\n  \n  // Determine critical location\n  let criticalLocation: 'hook_bend' | 'hook_transition' | 'body';\n  if (hookSafetyFactor < bodySafetyFactor * 0.9) {\n    criticalLocation = bendingStress > torsionalStress ? 'hook_bend' : 'hook_transition';\n  } else {\n    criticalLocation = 'body';\n  }\n  \n  // Hook fatigue safety factor (typically lower than static)\n  const hookFatigueSafetyFactor = hookSafetyFactor * 0.7; // Conservative estimate\n  \n  // Determine status\n  let status: 'safe' | 'warning' | 'danger';\n  const minSF = Math.min(hookSafetyFactor, bodySafetyFactor);\n  if (minSF >= 1.5) {\n    status = 'safe';\n  } else if (minSF >= 1.2) {\n    status = 'warning';\n  } else {\n    status = 'danger';\n  }\n  \n  // Generate message\n  let message: { en: string; zh: string };\n  if (criticalLocation === 'body') {\n    message = {\n      en: `Body is critical. Hook SF = ${hookSafetyFactor.toFixed(2)}, Body SF = ${bodySafetyFactor.toFixed(2)}`,\n      zh: `本体为关键位置。钩子 SF = ${hookSafetyFactor.toFixed(2)}，本体 SF = ${bodySafetyFactor.toFixed(2)}`,\n    };\n  } else {\n    message = {\n      en: `Hook is critical (${criticalLocation}). Hook SF = ${hookSafetyFactor.toFixed(2)} < Body SF = ${bodySafetyFactor.toFixed(2)}`,\n      zh: `钩子为关键位置（${criticalLocation === 'hook_bend' ? '弯曲处' : '过渡处'}）。钩子 SF = ${hookSafetyFactor.toFixed(2)} < 本体 SF = ${bodySafetyFactor.toFixed(2)}`,\n    };\n  }\n  \n  return {\n    hookType,\n    bendingStress,\n    torsionalStress,\n    combinedStress,\n    stressConcentrationFactor: HOOK_FACTORS[hookType].Kf,\n    hookSafetyFactor,\n    bodySafetyFactor,\n    criticalLocation,\n    hookFatigueSafetyFactor,\n    status,\n    message,\n  };\n}\n\n/**\n * Get hook type options\n */\nexport function getHookTypeOptions(): Array<{\n  value: HookType;\n  labelEn: string;\n  labelZh: string;\n}> {\n  return Object.entries(HOOK_FACTORS).map(([key, factors]) => ({\n    value: key as HookType,\n    labelEn: factors.description.en,\n    labelZh: factors.description.zh,\n  }));\n}\n\n/**\n * Recommend hook type based on safety requirements\n */\nexport function recommendHookType(\n  geometry: ExtensionSpringGeometry,\n  force: number,\n  targetSafetyFactor: number = 1.5\n): {\n  recommendedType: HookType;\n  achievedSafetyFactor: number;\n  alternatives: HookType[];\n} {\n  const hookTypes: HookType[] = ['double_loop', 'extended', 'machine', 'crossover', 'side', 'v_hook', 'reduced'];\n  \n  let recommendedType: HookType = 'machine';\n  let achievedSafetyFactor = 0;\n  const alternatives: HookType[] = [];\n  \n  for (const hookType of hookTypes) {\n    const result = calculateHookStress(geometry, force, 0, hookType);\n    \n    if (result.hookSafetyFactor >= targetSafetyFactor) {\n      if (achievedSafetyFactor === 0) {\n        recommendedType = hookType;\n        achievedSafetyFactor = result.hookSafetyFactor;\n      } else {\n        alternatives.push(hookType);\n      }\n    }\n  }\n  \n  return {\n    recommendedType,\n    achievedSafetyFactor,\n    alternatives,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/manufacturabilityCheck.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/manufacturingCompensation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/materialRecommendation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/mlFatiguePredictor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/multiSpringAssembly.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalForce' is assigned a value but never used.","line":380,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":380,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Multi-Spring Assembly Matching Analyzer - Phase 6\n * 多弹簧装配匹配分析器\n * \n * Analyzes multi-spring systems (e.g., valve springs, nested springs)\n */\n\n/**\n * Individual spring in assembly\n */\nexport interface AssemblySpring {\n  /** Spring identifier */\n  id: string;\n  /** Spring name/description */\n  name: string;\n  /** Wire diameter (mm) */\n  wireDiameter: number;\n  /** Mean diameter (mm) */\n  meanDiameter: number;\n  /** Outer diameter (mm) */\n  outerDiameter: number;\n  /** Inner diameter (mm) */\n  innerDiameter: number;\n  /** Free length (mm) */\n  freeLength: number;\n  /** Active coils */\n  activeCoils: number;\n  /** Spring rate (N/mm) */\n  springRate: number;\n  /** Solid height (mm) */\n  solidHeight: number;\n  /** Natural frequency (Hz) */\n  naturalFrequency: number;\n  /** Maximum stress at working deflection (MPa) */\n  maxStress: number;\n  /** Coil direction */\n  coilDirection: 'left' | 'right';\n  /** Position in assembly */\n  position: 'inner' | 'outer' | 'primary' | 'secondary';\n}\n\n/**\n * Assembly configuration\n */\nexport interface AssemblyConfig {\n  /** Assembly type */\n  assemblyType: 'nested' | 'series' | 'parallel' | 'valve_double';\n  /** Springs in assembly */\n  springs: AssemblySpring[];\n  /** Working deflection (mm) */\n  workingDeflection: number;\n  /** Preload deflection (mm) */\n  preloadDeflection: number;\n  /** Operating frequency (Hz) */\n  operatingFrequency?: number;\n  /** Shared housing ID (mm) */\n  housingInnerDiameter?: number;\n  /** Shared rod OD (mm) */\n  rodOuterDiameter?: number;\n}\n\n/**\n * Interference analysis result\n */\nexport interface InterferenceAnalysis {\n  /** Has interference */\n  hasInterference: boolean;\n  /** Minimum clearance (mm) */\n  minClearance: number;\n  /** Clearance location */\n  clearanceLocation: string;\n  /** Interference details */\n  details: string[];\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Resonance coupling analysis\n */\nexport interface ResonanceCouplingAnalysis {\n  /** Individual natural frequencies (Hz) */\n  individualFrequencies: { springId: string; frequency: number }[];\n  /** Combined system frequencies (Hz) */\n  systemFrequencies: number[];\n  /** Frequency ratios between springs */\n  frequencyRatios: { spring1: string; spring2: string; ratio: number }[];\n  /** Resonance coupling risk */\n  couplingRisk: 'low' | 'medium' | 'high';\n  /** Critical frequencies to avoid */\n  criticalFrequencies: number[];\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Load sharing analysis\n */\nexport interface LoadSharingAnalysis {\n  /** Load distribution at working deflection */\n  loadDistribution: { springId: string; load: number; percentage: number }[];\n  /** Combined spring rate */\n  combinedSpringRate: number;\n  /** Preload forces */\n  preloadForces: { springId: string; preload: number }[];\n  /** Preload compatibility */\n  preloadCompatible: boolean;\n  /** Stress distribution */\n  stressDistribution: { springId: string; stress: number; safetyFactor: number }[];\n  /** Weakest link */\n  weakestSpring: string;\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Assembly analysis result\n */\nexport interface AssemblyAnalysisResult {\n  /** Assembly configuration */\n  config: AssemblyConfig;\n  /** Combined stiffness (N/mm) */\n  combinedStiffness: number;\n  /** Combined preload (N) */\n  combinedPreload: number;\n  /** Working load (N) */\n  workingLoad: number;\n  /** Interference analysis */\n  interferenceAnalysis: InterferenceAnalysis;\n  /** Resonance coupling analysis */\n  resonanceCoupling: ResonanceCouplingAnalysis;\n  /** Load sharing analysis */\n  loadSharing: LoadSharingAnalysis;\n  /** Overall assembly rating */\n  assemblyRating: 'excellent' | 'good' | 'acceptable' | 'poor' | 'unacceptable';\n  /** Issues found */\n  issues: string[];\n  /** Summary */\n  summary: string;\n}\n\n/**\n * Calculate combined spring rate for series configuration\n * 1/k_total = 1/k1 + 1/k2 + ...\n */\nfunction calculateSeriesStiffness(springs: AssemblySpring[]): number {\n  const sumInverse = springs.reduce((sum, s) => sum + 1 / s.springRate, 0);\n  return 1 / sumInverse;\n}\n\n/**\n * Calculate combined spring rate for parallel configuration\n * k_total = k1 + k2 + ...\n */\nfunction calculateParallelStiffness(springs: AssemblySpring[]): number {\n  return springs.reduce((sum, s) => sum + s.springRate, 0);\n}\n\n/**\n * Analyze interference between nested springs\n */\nfunction analyzeInterference(config: AssemblyConfig): InterferenceAnalysis {\n  const details: string[] = [];\n  const recommendations: string[] = [];\n  let hasInterference = false;\n  let minClearance = Infinity;\n  let clearanceLocation = '';\n\n  if (config.assemblyType === 'nested' || config.assemblyType === 'valve_double') {\n    // Find inner and outer springs\n    const innerSpring = config.springs.find(s => s.position === 'inner');\n    const outerSpring = config.springs.find(s => s.position === 'outer');\n\n    if (innerSpring && outerSpring) {\n      // Check radial clearance\n      const radialClearance = outerSpring.innerDiameter - innerSpring.outerDiameter;\n      \n      if (radialClearance < innerSpring.wireDiameter * 0.5) {\n        hasInterference = true;\n        details.push(`Radial clearance (${radialClearance.toFixed(2)} mm) less than minimum`);\n        recommendations.push('Increase outer spring ID or decrease inner spring OD');\n      }\n      \n      if (radialClearance < minClearance) {\n        minClearance = radialClearance;\n        clearanceLocation = 'Radial (between inner OD and outer ID)';\n      }\n\n      // Check axial clearance at solid height\n      const innerSolidHeight = innerSpring.solidHeight;\n      const outerSolidHeight = outerSpring.solidHeight;\n      \n      if (Math.abs(innerSolidHeight - outerSolidHeight) > 2) {\n        details.push(`Solid heights differ by ${Math.abs(innerSolidHeight - outerSolidHeight).toFixed(1)} mm`);\n        recommendations.push('Consider matching solid heights for uniform bottoming');\n      }\n\n      // Check coil direction\n      if (innerSpring.coilDirection === outerSpring.coilDirection) {\n        details.push('Same coil direction - risk of coil interlocking');\n        recommendations.push('Use opposite coil directions (one left, one right hand)');\n      }\n    }\n\n    // Check housing clearance\n    if (config.housingInnerDiameter) {\n      const outerSpringOD = outerSpring?.outerDiameter ?? 0;\n      const housingClearance = config.housingInnerDiameter - outerSpringOD;\n      \n      if (housingClearance < 1) {\n        hasInterference = true;\n        details.push(`Housing clearance (${housingClearance.toFixed(2)} mm) too small`);\n        recommendations.push('Increase housing ID or decrease outer spring OD');\n      }\n      \n      if (housingClearance < minClearance) {\n        minClearance = housingClearance;\n        clearanceLocation = 'Housing (outer spring to housing)';\n      }\n    }\n\n    // Check rod clearance\n    if (config.rodOuterDiameter) {\n      const innerSpringID = innerSpring?.innerDiameter ?? Infinity;\n      const rodClearance = innerSpringID - config.rodOuterDiameter;\n      \n      if (rodClearance < 1) {\n        hasInterference = true;\n        details.push(`Rod clearance (${rodClearance.toFixed(2)} mm) too small`);\n        recommendations.push('Decrease rod OD or increase inner spring ID');\n      }\n      \n      if (rodClearance < minClearance) {\n        minClearance = rodClearance;\n        clearanceLocation = 'Rod (inner spring to rod)';\n      }\n    }\n  }\n\n  if (minClearance === Infinity) {\n    minClearance = 0;\n    clearanceLocation = 'N/A';\n  }\n\n  return {\n    hasInterference,\n    minClearance,\n    clearanceLocation,\n    details,\n    recommendations,\n  };\n}\n\n/**\n * Analyze resonance coupling between springs\n */\nfunction analyzeResonanceCoupling(config: AssemblyConfig): ResonanceCouplingAnalysis {\n  const individualFrequencies = config.springs.map(s => ({\n    springId: s.id,\n    frequency: s.naturalFrequency,\n  }));\n\n  // Calculate frequency ratios\n  const frequencyRatios: ResonanceCouplingAnalysis['frequencyRatios'] = [];\n  for (let i = 0; i < config.springs.length; i++) {\n    for (let j = i + 1; j < config.springs.length; j++) {\n      const ratio = config.springs[i].naturalFrequency / config.springs[j].naturalFrequency;\n      frequencyRatios.push({\n        spring1: config.springs[i].id,\n        spring2: config.springs[j].id,\n        ratio: ratio > 1 ? ratio : 1 / ratio,\n      });\n    }\n  }\n\n  // Calculate system frequencies (simplified - actual would need modal analysis)\n  const systemFrequencies: number[] = [];\n  \n  if (config.assemblyType === 'parallel' || config.assemblyType === 'nested') {\n    // Parallel: combined frequency\n    const combinedK = calculateParallelStiffness(config.springs);\n    const totalMass = config.springs.reduce((sum, s) => {\n      // Approximate mass from spring rate and frequency\n      const mass = s.springRate / Math.pow(2 * Math.PI * s.naturalFrequency, 2);\n      return sum + mass;\n    }, 0);\n    const combinedFreq = Math.sqrt(combinedK / totalMass) / (2 * Math.PI);\n    systemFrequencies.push(combinedFreq);\n  } else if (config.assemblyType === 'series') {\n    // Series: lower combined frequency\n    const combinedK = calculateSeriesStiffness(config.springs);\n    const avgMass = config.springs.reduce((sum, s) => {\n      const mass = s.springRate / Math.pow(2 * Math.PI * s.naturalFrequency, 2);\n      return sum + mass;\n    }, 0) / config.springs.length;\n    const combinedFreq = Math.sqrt(combinedK / avgMass) / (2 * Math.PI);\n    systemFrequencies.push(combinedFreq);\n  }\n\n  // Determine coupling risk\n  let couplingRisk: ResonanceCouplingAnalysis['couplingRisk'] = 'low';\n  const recommendations: string[] = [];\n  const criticalFrequencies: number[] = [];\n\n  // Check for problematic frequency ratios (near 1:1, 2:1, 3:1)\n  for (const fr of frequencyRatios) {\n    const nearInteger = Math.abs(fr.ratio - Math.round(fr.ratio));\n    if (nearInteger < 0.1) {\n      couplingRisk = 'high';\n      recommendations.push(`Frequency ratio ${fr.spring1}/${fr.spring2} near ${Math.round(fr.ratio)}:1 - high coupling risk`);\n      criticalFrequencies.push(\n        individualFrequencies.find(f => f.springId === fr.spring1)?.frequency ?? 0\n      );\n    } else if (nearInteger < 0.2) {\n      if (couplingRisk === 'low') couplingRisk = 'medium';\n      recommendations.push(`Frequency ratio ${fr.spring1}/${fr.spring2} = ${fr.ratio.toFixed(2)} - moderate coupling risk`);\n    }\n  }\n\n  // Check operating frequency\n  if (config.operatingFrequency) {\n    for (const sf of systemFrequencies) {\n      const ratio = config.operatingFrequency / sf;\n      if (ratio > 0.7 && ratio < 1.3) {\n        couplingRisk = 'high';\n        recommendations.push(`Operating frequency near system resonance (${sf.toFixed(0)} Hz)`);\n        criticalFrequencies.push(sf);\n      }\n    }\n  }\n\n  if (couplingRisk === 'low') {\n    recommendations.push('Frequency separation is adequate - low resonance coupling risk');\n  }\n\n  return {\n    individualFrequencies,\n    systemFrequencies,\n    frequencyRatios,\n    couplingRisk,\n    criticalFrequencies,\n    recommendations,\n  };\n}\n\n/**\n * Analyze load sharing between springs\n */\nfunction analyzeLoadSharing(config: AssemblyConfig): LoadSharingAnalysis {\n  const recommendations: string[] = [];\n  \n  // Calculate combined spring rate based on assembly type\n  let combinedSpringRate: number;\n  if (config.assemblyType === 'series') {\n    combinedSpringRate = calculateSeriesStiffness(config.springs);\n  } else {\n    combinedSpringRate = calculateParallelStiffness(config.springs);\n  }\n\n  // Calculate preload forces\n  const preloadForces = config.springs.map(s => ({\n    springId: s.id,\n    preload: s.springRate * config.preloadDeflection,\n  }));\n\n  // Calculate load distribution at working deflection\n  const totalDeflection = config.preloadDeflection + config.workingDeflection;\n  let loadDistribution: LoadSharingAnalysis['loadDistribution'];\n  \n  if (config.assemblyType === 'series') {\n    // Series: same force through all springs\n    const totalForce = combinedSpringRate * totalDeflection;\n    loadDistribution = config.springs.map(s => ({\n      springId: s.id,\n      load: totalForce,\n      percentage: 100 / config.springs.length,\n    }));\n  } else {\n    // Parallel: force proportional to stiffness\n    const totalForce = combinedSpringRate * totalDeflection;\n    loadDistribution = config.springs.map(s => ({\n      springId: s.id,\n      load: s.springRate * totalDeflection,\n      percentage: (s.springRate / combinedSpringRate) * 100,\n    }));\n  }\n\n  // Calculate stress distribution\n  const stressDistribution = config.springs.map(s => {\n    const load = loadDistribution.find(l => l.springId === s.id)?.load ?? 0;\n    // Approximate stress from load (simplified)\n    const stress = s.maxStress * (load / (s.springRate * config.workingDeflection));\n    const allowableStress = 560; // Simplified\n    return {\n      springId: s.id,\n      stress,\n      safetyFactor: allowableStress / stress,\n    };\n  });\n\n  // Find weakest spring\n  const weakestSpring = stressDistribution.reduce((min, s) => \n    s.safetyFactor < min.safetyFactor ? s : min\n  ).springId;\n\n  // Check preload compatibility\n  const preloadVariation = Math.max(...preloadForces.map(p => p.preload)) - \n    Math.min(...preloadForces.map(p => p.preload));\n  const avgPreload = preloadForces.reduce((sum, p) => sum + p.preload, 0) / preloadForces.length;\n  const preloadCompatible = preloadVariation / avgPreload < 0.2;\n\n  if (!preloadCompatible) {\n    recommendations.push('Preload forces vary significantly - consider matching spring rates');\n  }\n\n  // Check load balance\n  const loadVariation = Math.max(...loadDistribution.map(l => l.percentage)) - \n    Math.min(...loadDistribution.map(l => l.percentage));\n  if (loadVariation > 30) {\n    recommendations.push('Uneven load distribution - consider balancing spring rates');\n  }\n\n  // Check safety factors\n  const minSF = Math.min(...stressDistribution.map(s => s.safetyFactor));\n  if (minSF < 1.2) {\n    recommendations.push(`Low safety factor on ${weakestSpring} - consider strengthening`);\n  }\n\n  if (recommendations.length === 0) {\n    recommendations.push('Load sharing is well balanced');\n  }\n\n  return {\n    loadDistribution,\n    combinedSpringRate,\n    preloadForces,\n    preloadCompatible,\n    stressDistribution,\n    weakestSpring,\n    recommendations,\n  };\n}\n\n/**\n * Determine overall assembly rating\n */\nfunction determineAssemblyRating(\n  interference: InterferenceAnalysis,\n  resonance: ResonanceCouplingAnalysis,\n  loadSharing: LoadSharingAnalysis\n): AssemblyAnalysisResult['assemblyRating'] {\n  if (interference.hasInterference) return 'unacceptable';\n  \n  const minSF = Math.min(...loadSharing.stressDistribution.map(s => s.safetyFactor));\n  if (minSF < 1.0) return 'unacceptable';\n  \n  if (resonance.couplingRisk === 'high') return 'poor';\n  if (minSF < 1.2) return 'poor';\n  \n  if (resonance.couplingRisk === 'medium' || !loadSharing.preloadCompatible) return 'acceptable';\n  \n  if (minSF >= 1.5 && resonance.couplingRisk === 'low' && interference.minClearance >= 2) {\n    return 'excellent';\n  }\n  \n  return 'good';\n}\n\n/**\n * Main assembly analysis function\n */\nexport function analyzeMultiSpringAssembly(config: AssemblyConfig): AssemblyAnalysisResult {\n  // Run all analyses\n  const interferenceAnalysis = analyzeInterference(config);\n  const resonanceCoupling = analyzeResonanceCoupling(config);\n  const loadSharing = analyzeLoadSharing(config);\n\n  // Calculate combined properties\n  const combinedStiffness = loadSharing.combinedSpringRate;\n  const combinedPreload = loadSharing.preloadForces.reduce((sum, p) => sum + p.preload, 0);\n  const workingLoad = combinedStiffness * (config.preloadDeflection + config.workingDeflection);\n\n  // Determine rating\n  const assemblyRating = determineAssemblyRating(interferenceAnalysis, resonanceCoupling, loadSharing);\n\n  // Collect all issues\n  const issues: string[] = [\n    ...interferenceAnalysis.details,\n    ...resonanceCoupling.recommendations.filter(r => r.includes('risk')),\n    ...loadSharing.recommendations.filter(r => r.includes('consider') || r.includes('Low')),\n  ];\n\n  // Generate summary\n  let summary: string;\n  switch (assemblyRating) {\n    case 'excellent':\n      summary = 'Assembly design is excellent with good clearances, balanced loads, and low resonance risk.';\n      break;\n    case 'good':\n      summary = 'Assembly design is good. Minor optimizations possible.';\n      break;\n    case 'acceptable':\n      summary = 'Assembly design is acceptable but has some concerns that should be reviewed.';\n      break;\n    case 'poor':\n      summary = 'Assembly design has significant issues. Redesign recommended.';\n      break;\n    case 'unacceptable':\n      summary = 'Assembly design is unacceptable due to interference or safety concerns. Must be redesigned.';\n      break;\n  }\n\n  return {\n    config,\n    combinedStiffness,\n    combinedPreload,\n    workingLoad,\n    interferenceAnalysis,\n    resonanceCoupling,\n    loadSharing,\n    assemblyRating,\n    issues,\n    summary,\n  };\n}\n\n/**\n * Quick compatibility check for two springs\n */\nexport function checkSpringCompatibility(\n  spring1: AssemblySpring,\n  spring2: AssemblySpring,\n  assemblyType: AssemblyConfig['assemblyType']\n): {\n  compatible: boolean;\n  issues: string[];\n  recommendations: string[];\n} {\n  const issues: string[] = [];\n  const recommendations: string[] = [];\n\n  // Check for nested configuration\n  if (assemblyType === 'nested' || assemblyType === 'valve_double') {\n    // Determine inner/outer\n    const [inner, outer] = spring1.outerDiameter < spring2.outerDiameter \n      ? [spring1, spring2] : [spring2, spring1];\n\n    // Radial clearance\n    const clearance = outer.innerDiameter - inner.outerDiameter;\n    if (clearance < inner.wireDiameter * 0.5) {\n      issues.push('Insufficient radial clearance');\n      recommendations.push('Increase size difference between springs');\n    }\n\n    // Coil direction\n    if (spring1.coilDirection === spring2.coilDirection) {\n      issues.push('Same coil direction');\n      recommendations.push('Use opposite hand coils');\n    }\n\n    // Free length match\n    const lengthDiff = Math.abs(spring1.freeLength - spring2.freeLength);\n    if (lengthDiff > 5) {\n      issues.push(`Free lengths differ by ${lengthDiff.toFixed(1)} mm`);\n      recommendations.push('Match free lengths for uniform compression');\n    }\n  }\n\n  // Frequency ratio check\n  const freqRatio = spring1.naturalFrequency / spring2.naturalFrequency;\n  const normalizedRatio = freqRatio > 1 ? freqRatio : 1 / freqRatio;\n  if (Math.abs(normalizedRatio - Math.round(normalizedRatio)) < 0.1) {\n    issues.push(`Frequency ratio near ${Math.round(normalizedRatio)}:1`);\n    recommendations.push('Adjust spring rates to avoid resonance coupling');\n  }\n\n  return {\n    compatible: issues.length === 0,\n    issues,\n    recommendations,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/nonlinearBuckling.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/nonlinearMaterial.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Sy' is assigned a value but never used.","line":216,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":216,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'meanStress' is assigned a value but never used.","line":220,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":220,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'linearStrainAmplitude' is assigned a value but never used.","line":223,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":223,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Nonlinear Material Model (Ramberg-Osgood)\n * 弹簧分析引擎 - 非线性材料模型（Ramberg-Osgood）\n * \n * Implements elastic-plastic stress interpretation for high stress regions\n * ε = σ/E + K*(σ)^n\n */\n\nimport { getSpringMaterial, type SpringMaterialId } from '@/lib/materials/springMaterials';\n\n/**\n * Ramberg-Osgood material parameters\n */\nexport interface RambergOsgoodParams {\n  /** Young's modulus E (MPa) */\n  E: number;\n  /** Strength coefficient K */\n  K: number;\n  /** Strain hardening exponent n */\n  n: number;\n  /** Yield strength Sy (MPa) */\n  Sy: number;\n  /** Transition ratio (σ/Sy) for nonlinear activation */\n  transitionRatio: number;\n}\n\n/**\n * Nonlinear stress result\n */\nexport interface NonlinearStressResult {\n  /** Linear elastic stress (MPa) */\n  linearStress: number;\n  /** Nonlinear corrected stress (MPa) */\n  nonlinearStress: number;\n  /** Total strain */\n  totalStrain: number;\n  /** Elastic strain component */\n  elasticStrain: number;\n  /** Plastic strain component */\n  plasticStrain: number;\n  /** Is in nonlinear region */\n  isNonlinear: boolean;\n  /** Stress ratio σ/Sy */\n  stressRatio: number;\n  /** Correction factor applied */\n  correctionFactor: number;\n}\n\n/**\n * Ramberg-Osgood parameters for common spring materials\n */\nexport const RAMBERG_OSGOOD_PARAMS: Record<string, Omit<RambergOsgoodParams, 'E' | 'Sy'>> = {\n  music_wire_a228: {\n    K: 0.002,\n    n: 15,\n    transitionRatio: 0.75,\n  },\n  oil_tempered: {\n    K: 0.0025,\n    n: 12,\n    transitionRatio: 0.72,\n  },\n  chrome_silicon: {\n    K: 0.0018,\n    n: 18,\n    transitionRatio: 0.78,\n  },\n  chrome_vanadium: {\n    K: 0.002,\n    n: 16,\n    transitionRatio: 0.76,\n  },\n  ss_302: {\n    K: 0.003,\n    n: 10,\n    transitionRatio: 0.70,\n  },\n  phosphor_bronze: {\n    K: 0.004,\n    n: 8,\n    transitionRatio: 0.65,\n  },\n};\n\n/**\n * Get Ramberg-Osgood parameters for material\n */\nexport function getRambergOsgoodParams(materialId: SpringMaterialId): RambergOsgoodParams {\n  const material = getSpringMaterial(materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${materialId}`);\n  }\n\n  const baseParams = RAMBERG_OSGOOD_PARAMS[materialId] ?? {\n    K: 0.002,\n    n: 15,\n    transitionRatio: 0.75,\n  };\n\n  // Estimate yield strength from allowable shear stress\n  // Sy ≈ τ_allow / 0.577 (von Mises)\n  const Sy = material.allowShearStatic / 0.577;\n\n  return {\n    E: material.elasticModulus ?? 207000,\n    Sy,\n    ...baseParams,\n  };\n}\n\n/**\n * Calculate total strain using Ramberg-Osgood equation\n * ε = σ/E + K*(σ/E)^n\n */\nexport function calculateRambergOsgoodStrain(\n  stress: number,\n  params: RambergOsgoodParams\n): {\n  totalStrain: number;\n  elasticStrain: number;\n  plasticStrain: number;\n} {\n  const { E, K, n } = params;\n  \n  const elasticStrain = stress / E;\n  const plasticStrain = K * Math.pow(stress / E, n);\n  const totalStrain = elasticStrain + plasticStrain;\n  \n  return {\n    totalStrain,\n    elasticStrain,\n    plasticStrain,\n  };\n}\n\n/**\n * Calculate nonlinear stress correction\n * When stress exceeds transition ratio * Sy, apply nonlinear correction\n */\nexport function calculateNonlinearStress(\n  linearStress: number,\n  materialId: SpringMaterialId\n): NonlinearStressResult {\n  const params = getRambergOsgoodParams(materialId);\n  const { E, Sy, transitionRatio } = params;\n  \n  const stressRatio = linearStress / Sy;\n  const isNonlinear = stressRatio > transitionRatio;\n  \n  if (!isNonlinear) {\n    // Linear region - no correction needed\n    const elasticStrain = linearStress / E;\n    return {\n      linearStress,\n      nonlinearStress: linearStress,\n      totalStrain: elasticStrain,\n      elasticStrain,\n      plasticStrain: 0,\n      isNonlinear: false,\n      stressRatio,\n      correctionFactor: 1.0,\n    };\n  }\n  \n  // Nonlinear region - apply Ramberg-Osgood\n  const { totalStrain, elasticStrain, plasticStrain } = calculateRambergOsgoodStrain(linearStress, params);\n  \n  // Calculate effective stress considering plastic strain\n  // The \"true\" stress is higher due to strain hardening\n  const strainHardeningFactor = 1 + (plasticStrain / elasticStrain) * 0.5;\n  const nonlinearStress = linearStress * strainHardeningFactor;\n  \n  return {\n    linearStress,\n    nonlinearStress,\n    totalStrain,\n    elasticStrain,\n    plasticStrain,\n    isNonlinear: true,\n    stressRatio,\n    correctionFactor: strainHardeningFactor,\n  };\n}\n\n/**\n * Calculate SWT (Smith-Watson-Topper) fatigue parameter with nonlinear correction\n * SWT = σ_max * ε_a * E\n */\nexport function calculateSWTParameter(\n  maxStress: number,\n  strainAmplitude: number,\n  E: number\n): number {\n  return Math.sqrt(maxStress * strainAmplitude * E);\n}\n\n/**\n * Calculate nonlinear fatigue life using SWT approach\n */\nexport function calculateNonlinearFatigueLife(\n  maxStress: number,\n  minStress: number,\n  materialId: SpringMaterialId\n): {\n  linearLife: number;\n  nonlinearLife: number;\n  swtParameter: number;\n  reductionFactor: number;\n} {\n  const params = getRambergOsgoodParams(materialId);\n  const material = getSpringMaterial(materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${materialId}`);\n  }\n\n  const { E, Sy } = params;\n  \n  // Calculate strain amplitudes\n  const stressAmplitude = (maxStress - minStress) / 2;\n  const meanStress = (maxStress + minStress) / 2;\n  \n  // Linear strain amplitude\n  const linearStrainAmplitude = stressAmplitude / E;\n  \n  // Nonlinear strain amplitude (if in plastic region)\n  const maxResult = calculateNonlinearStress(maxStress, materialId);\n  const minResult = calculateNonlinearStress(Math.abs(minStress), materialId);\n  \n  const nonlinearStrainAmplitude = (maxResult.totalStrain - minResult.totalStrain) / 2;\n  \n  // SWT parameter\n  const swtParameter = calculateSWTParameter(maxStress, nonlinearStrainAmplitude, E);\n  \n  // Estimate fatigue life using Basquin relation\n  const { snCurve } = material;\n  const b = Math.log(snCurve.tau1 / snCurve.tau2) / Math.log(snCurve.N2 / snCurve.N1);\n  \n  // Linear life estimate\n  const linearLife = snCurve.N2 * Math.pow(snCurve.tau2 / stressAmplitude, 1 / b);\n  \n  // Nonlinear life (reduced due to plastic strain)\n  const plasticReduction = maxResult.isNonlinear ? \n    Math.pow(1 + maxResult.plasticStrain / maxResult.elasticStrain, -2) : 1;\n  const nonlinearLife = linearLife * plasticReduction;\n  \n  return {\n    linearLife: Math.min(linearLife, 1e9),\n    nonlinearLife: Math.min(nonlinearLife, 1e9),\n    swtParameter,\n    reductionFactor: plasticReduction,\n  };\n}\n\n/**\n * Calculate nonlinear safety factor\n */\nexport function calculateNonlinearSafetyFactor(\n  workingStress: number,\n  materialId: SpringMaterialId\n): {\n  linearSF: number;\n  nonlinearSF: number;\n  yieldMargin: number;\n} {\n  const params = getRambergOsgoodParams(materialId);\n  const material = getSpringMaterial(materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${materialId}`);\n  }\n\n  const { Sy } = params;\n  const allowableStress = material.allowShearStatic;\n  \n  // Linear safety factor\n  const linearSF = allowableStress / workingStress;\n  \n  // Nonlinear correction\n  const stressResult = calculateNonlinearStress(workingStress, materialId);\n  const effectiveStress = stressResult.nonlinearStress;\n  \n  // Nonlinear safety factor (considering strain hardening)\n  const nonlinearSF = allowableStress / effectiveStress;\n  \n  // Yield margin\n  const yieldMargin = (Sy - workingStress) / Sy;\n  \n  return {\n    linearSF,\n    nonlinearSF,\n    yieldMargin,\n  };\n}\n\n/**\n * Apply nonlinear correction to stress distribution\n */\nexport function applyNonlinearCorrection(\n  stressValues: number[],\n  materialId: SpringMaterialId\n): Array<{\n  original: number;\n  corrected: number;\n  isNonlinear: boolean;\n  plasticStrain: number;\n}> {\n  return stressValues.map(stress => {\n    const result = calculateNonlinearStress(stress, materialId);\n    return {\n      original: stress,\n      corrected: result.nonlinearStress,\n      isNonlinear: result.isNonlinear,\n      plasticStrain: result.plasticStrain,\n    };\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/nvhModel.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentLength' is assigned a value but never used.","line":80,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":80,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - NVH (Noise, Vibration, Harshness) Model\n * 弹簧分析引擎 - NVH（噪声、振动、粗糙度）模型\n * \n * Predicts acoustic energy and noise risk from coil contact\n */\n\nimport type { SpringGeometry, CompressionSpringGeometry } from './types';\n\n/**\n * NVH analysis result\n */\nexport interface NVHResult {\n  /** Estimated acoustic energy index */\n  acousticEnergyIndex: number;\n  /** Estimated noise level (dB) */\n  estimatedNoiseLevel: number;\n  /** Friction noise component */\n  frictionNoiseIndex: number;\n  /** Impact noise component */\n  impactNoiseIndex: number;\n  /** Harmonic squeal risk */\n  harmonicSquealRisk: 'low' | 'medium' | 'high';\n  /** Coil contact frequency */\n  coilContactFrequency: number;\n  /** Natural frequency (Hz) */\n  naturalFrequency: number;\n  /** Risk level */\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n  /** Recommendations */\n  recommendations: string[];\n  /** Message */\n  message: { en: string; zh: string };\n}\n\n/**\n * Coil contact analysis\n */\nexport interface CoilContactAnalysis {\n  /** Is coil contact occurring */\n  hasCoilContact: boolean;\n  /** Number of coils in contact */\n  contactingCoils: number;\n  /** Contact force (N) */\n  contactForce: number;\n  /** Contact pressure (MPa) */\n  contactPressure: number;\n  /** Friction energy per cycle */\n  frictionEnergyPerCycle: number;\n}\n\n/**\n * Calculate coil gap at given deflection\n */\nexport function calculateCoilGap(\n  freeLength: number,\n  solidHeight: number,\n  activeCoils: number,\n  deflection: number\n): number {\n  const currentLength = freeLength - deflection;\n  const availableSpace = currentLength - solidHeight;\n  const gapPerCoil = availableSpace / activeCoils;\n  return Math.max(0, gapPerCoil);\n}\n\n/**\n * Analyze coil contact\n */\nexport function analyzeCoilContact(\n  geometry: CompressionSpringGeometry,\n  deflection: number,\n  springRate: number,\n  frictionCoeff: number = 0.15\n): CoilContactAnalysis {\n  const { wireDiameter, activeCoils, freeLength } = geometry;\n  const totalCoils = geometry.totalCoils ?? activeCoils + 2;\n  const solidHeight = totalCoils * wireDiameter;\n  \n  const currentLength = freeLength - deflection;\n  const coilGap = calculateCoilGap(freeLength, solidHeight, activeCoils, deflection);\n  \n  // Check if coils are contacting\n  const hasCoilContact = coilGap <= wireDiameter * 0.1;\n  \n  if (!hasCoilContact) {\n    return {\n      hasCoilContact: false,\n      contactingCoils: 0,\n      contactForce: 0,\n      contactPressure: 0,\n      frictionEnergyPerCycle: 0,\n    };\n  }\n  \n  // Calculate contacting coils\n  const compressionRatio = deflection / (freeLength - solidHeight);\n  const contactingCoils = Math.min(activeCoils, Math.floor(compressionRatio * activeCoils * 1.5));\n  \n  // Contact force\n  const force = springRate * deflection;\n  const contactForce = force * (contactingCoils / activeCoils);\n  \n  // Contact pressure (Hertzian approximation)\n  const contactWidth = wireDiameter * 0.1;\n  const contactLength = Math.PI * (geometry.meanDiameter ?? 20);\n  const contactArea = contactWidth * contactLength * contactingCoils;\n  const contactPressure = contactForce / contactArea;\n  \n  // Friction energy per cycle\n  const slideDistance = coilGap * 0.5; // Approximate slide distance\n  const frictionEnergyPerCycle = frictionCoeff * contactForce * slideDistance;\n  \n  return {\n    hasCoilContact: true,\n    contactingCoils,\n    contactForce,\n    contactPressure,\n    frictionEnergyPerCycle,\n  };\n}\n\n/**\n * Calculate NVH prediction\n * E_nvh ∝ µ * F_contact^2 * fn\n */\nexport function calculateNVH(\n  geometry: SpringGeometry,\n  deflection: number,\n  springRate: number,\n  naturalFrequency: number,\n  operatingFrequency: number,\n  frictionCoeff: number = 0.15\n): NVHResult {\n  // Only compression springs have coil contact NVH\n  if (geometry.type !== 'compression') {\n    return {\n      acousticEnergyIndex: 0,\n      estimatedNoiseLevel: 0,\n      frictionNoiseIndex: 0,\n      impactNoiseIndex: 0,\n      harmonicSquealRisk: 'low',\n      coilContactFrequency: 0,\n      naturalFrequency,\n      riskLevel: 'low',\n      recommendations: [],\n      message: {\n        en: 'NVH analysis not applicable for this spring type',\n        zh: 'NVH 分析不适用于此弹簧类型',\n      },\n    };\n  }\n  \n  const compGeometry = geometry as CompressionSpringGeometry;\n  const contactAnalysis = analyzeCoilContact(compGeometry, deflection, springRate, frictionCoeff);\n  \n  if (!contactAnalysis.hasCoilContact) {\n    return {\n      acousticEnergyIndex: 0,\n      estimatedNoiseLevel: 20, // Ambient\n      frictionNoiseIndex: 0,\n      impactNoiseIndex: 0,\n      harmonicSquealRisk: 'low',\n      coilContactFrequency: 0,\n      naturalFrequency,\n      riskLevel: 'low',\n      recommendations: [],\n      message: {\n        en: 'No coil contact detected. NVH risk is minimal.',\n        zh: '未检测到线圈接触。NVH 风险最小。',\n      },\n    };\n  }\n  \n  // Calculate acoustic energy index\n  // E_nvh ∝ µ * F_contact^2 * fn\n  const acousticEnergyIndex = frictionCoeff * \n    Math.pow(contactAnalysis.contactForce, 2) * \n    naturalFrequency / 1e6;\n  \n  // Friction noise component\n  const frictionNoiseIndex = frictionCoeff * contactAnalysis.contactForce * \n    contactAnalysis.contactingCoils / 100;\n  \n  // Impact noise component (from coil clash)\n  const impactNoiseIndex = contactAnalysis.contactForce * operatingFrequency / 1000;\n  \n  // Estimate noise level (dB) - empirical formula\n  const baseNoise = 40; // dB ambient\n  const estimatedNoiseLevel = baseNoise + \n    10 * Math.log10(1 + acousticEnergyIndex) +\n    5 * Math.log10(1 + frictionNoiseIndex) +\n    3 * Math.log10(1 + impactNoiseIndex);\n  \n  // Harmonic squeal risk\n  const frequencyRatio = operatingFrequency / naturalFrequency;\n  let harmonicSquealRisk: NVHResult['harmonicSquealRisk'] = 'low';\n  if (Math.abs(frequencyRatio - 1) < 0.1 || Math.abs(frequencyRatio - 0.5) < 0.1) {\n    harmonicSquealRisk = 'high';\n  } else if (Math.abs(frequencyRatio - 1) < 0.2 || Math.abs(frequencyRatio - 0.5) < 0.2) {\n    harmonicSquealRisk = 'medium';\n  }\n  \n  // Coil contact frequency\n  const coilContactFrequency = operatingFrequency * contactAnalysis.contactingCoils;\n  \n  // Determine overall risk level\n  let riskLevel: NVHResult['riskLevel'];\n  if (estimatedNoiseLevel > 80 || harmonicSquealRisk === 'high') {\n    riskLevel = 'critical';\n  } else if (estimatedNoiseLevel > 65 || harmonicSquealRisk === 'medium') {\n    riskLevel = 'high';\n  } else if (estimatedNoiseLevel > 50) {\n    riskLevel = 'medium';\n  } else {\n    riskLevel = 'low';\n  }\n  \n  // Generate recommendations\n  const recommendations: string[] = [];\n  if (riskLevel !== 'low') {\n    if (contactAnalysis.contactingCoils > 2) {\n      recommendations.push('Reduce maximum deflection to prevent coil contact');\n    }\n    if (frictionCoeff > 0.1) {\n      recommendations.push('Apply low-friction coating (PTFE, phosphate)');\n    }\n    if (harmonicSquealRisk !== 'low') {\n      recommendations.push('Modify operating frequency to avoid resonance');\n    }\n    recommendations.push('Consider increasing coil pitch');\n    recommendations.push('Add damping element or guide rod');\n  }\n  \n  // Generate message\n  let message: { en: string; zh: string };\n  if (riskLevel === 'critical') {\n    message = {\n      en: `CRITICAL NVH RISK: Estimated ${estimatedNoiseLevel.toFixed(0)} dB. ${contactAnalysis.contactingCoils} coils in contact.`,\n      zh: `严重 NVH 风险：预估 ${estimatedNoiseLevel.toFixed(0)} dB。${contactAnalysis.contactingCoils} 圈接触。`,\n    };\n  } else if (riskLevel === 'high') {\n    message = {\n      en: `HIGH NVH RISK: Estimated ${estimatedNoiseLevel.toFixed(0)} dB. Consider design modifications.`,\n      zh: `高 NVH 风险：预估 ${estimatedNoiseLevel.toFixed(0)} dB。考虑设计修改。`,\n    };\n  } else if (riskLevel === 'medium') {\n    message = {\n      en: `Moderate NVH: Estimated ${estimatedNoiseLevel.toFixed(0)} dB. Monitor in service.`,\n      zh: `中等 NVH：预估 ${estimatedNoiseLevel.toFixed(0)} dB。服役中监控。`,\n    };\n  } else {\n    message = {\n      en: `Low NVH risk: Estimated ${estimatedNoiseLevel.toFixed(0)} dB.`,\n      zh: `低 NVH 风险：预估 ${estimatedNoiseLevel.toFixed(0)} dB。`,\n    };\n  }\n  \n  return {\n    acousticEnergyIndex,\n    estimatedNoiseLevel,\n    frictionNoiseIndex,\n    impactNoiseIndex,\n    harmonicSquealRisk,\n    coilContactFrequency,\n    naturalFrequency,\n    riskLevel,\n    recommendations,\n    message,\n  };\n}\n\n/**\n * Generate NVH vs deflection curve\n */\nexport function generateNVHCurve(\n  geometry: SpringGeometry,\n  springRate: number,\n  naturalFrequency: number,\n  operatingFrequency: number,\n  maxDeflection: number,\n  numPoints: number = 50\n): Array<{\n  deflection: number;\n  noiseLevel: number;\n  hasContact: boolean;\n}> {\n  const points: Array<{\n    deflection: number;\n    noiseLevel: number;\n    hasContact: boolean;\n  }> = [];\n  \n  for (let i = 0; i <= numPoints; i++) {\n    const deflection = (maxDeflection * i) / numPoints;\n    const result = calculateNVH(geometry, deflection, springRate, naturalFrequency, operatingFrequency);\n    \n    points.push({\n      deflection,\n      noiseLevel: result.estimatedNoiseLevel,\n      hasContact: result.acousticEnergyIndex > 0,\n    });\n  }\n  \n  return points;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/optimizer.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringGeometry' is defined but never used.","line":9,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculateDynamics' is defined but never used.","line":11,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculateBuckling' is defined but never used.","line":12,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Inverse Design Solver & Multi-Objective Optimizer\n * 弹簧分析引擎 - 逆向设计求解器与多目标优化器\n * \n * Solves for optimal spring parameters given target requirements\n * Uses genetic algorithm for multi-objective optimization\n */\n\nimport type { SpringGeometry, CompressionSpringGeometry, WorkingConditions } from './types';\nimport { SpringAnalysisEngine } from './SpringAnalysisEngine';\nimport { calculateDynamics } from './dynamics';\nimport { calculateBuckling } from './buckling';\nimport { SPRING_MATERIALS, type SpringMaterialId } from '@/lib/materials/springMaterials';\n\n/**\n * Design targets\n */\nexport interface DesignTargets {\n  /** Target spring rate (N/mm) */\n  targetStiffness?: number;\n  /** Minimum fatigue life (cycles) */\n  minFatigueLife?: number;\n  /** Maximum stress (MPa) */\n  maxStress?: number;\n  /** Minimum safety factor */\n  minSafetyFactor?: number;\n  /** Maximum free length (mm) */\n  maxFreeLength?: number;\n  /** Maximum outer diameter (mm) */\n  maxOuterDiameter?: number;\n  /** Minimum natural frequency (Hz) */\n  minNaturalFrequency?: number;\n  /** Target force at deflection (N) */\n  targetForce?: { deflection: number; force: number };\n}\n\n/**\n * Design constraints\n */\nexport interface DesignConstraints {\n  /** Wire diameter range [min, max] (mm) */\n  wireDiameterRange: [number, number];\n  /** Mean diameter range [min, max] (mm) */\n  meanDiameterRange: [number, number];\n  /** Active coils range [min, max] */\n  activeCoilsRange: [number, number];\n  /** Free length range [min, max] (mm) */\n  freeLengthRange: [number, number];\n  /** Allowed materials */\n  allowedMaterials: SpringMaterialId[];\n  /** Spring index range [min, max] */\n  springIndexRange: [number, number];\n}\n\n/**\n * Optimization weights\n */\nexport interface OptimizationWeights {\n  /** Weight for stress minimization */\n  stressWeight: number;\n  /** Weight for safety factor maximization */\n  safetyWeight: number;\n  /** Weight for fatigue life maximization */\n  fatigueWeight: number;\n  /** Weight for buckling safety */\n  bucklingWeight: number;\n  /** Weight for mass minimization */\n  massWeight: number;\n  /** Weight for cost minimization */\n  costWeight: number;\n}\n\n/**\n * Optimization result\n */\nexport interface OptimizationResult {\n  /** Best solution found */\n  bestSolution: {\n    wireDiameter: number;\n    meanDiameter: number;\n    activeCoils: number;\n    freeLength: number;\n    materialId: SpringMaterialId;\n  };\n  /** Expected performance */\n  expectedPerformance: {\n    springRate: number;\n    maxStress: number;\n    safetyFactor: number;\n    fatigueLife: number;\n    naturalFrequency: number;\n    mass: number;\n  };\n  /** Fitness score */\n  fitnessScore: number;\n  /** Convergence history */\n  convergenceHistory: Array<{ generation: number; bestFitness: number; avgFitness: number }>;\n  /** Pareto front solutions */\n  paretoFront: Array<{\n    solution: OptimizationResult['bestSolution'];\n    objectives: { stress: number; safety: number; fatigue: number; mass: number };\n  }>;\n  /** Optimization status */\n  status: 'success' | 'partial' | 'failed';\n  /** Message */\n  message: { en: string; zh: string };\n}\n\n/**\n * Individual in genetic algorithm\n */\ninterface Individual {\n  genes: {\n    wireDiameter: number;\n    meanDiameter: number;\n    activeCoils: number;\n    freeLength: number;\n    materialIndex: number;\n  };\n  fitness: number;\n  objectives: {\n    stress: number;\n    safety: number;\n    fatigue: number;\n    buckling: number;\n    mass: number;\n    cost: number;\n  };\n  feasible: boolean;\n}\n\n/**\n * Default constraints\n */\nexport const DEFAULT_CONSTRAINTS: DesignConstraints = {\n  wireDiameterRange: [0.5, 10],\n  meanDiameterRange: [5, 100],\n  activeCoilsRange: [3, 30],\n  freeLengthRange: [10, 300],\n  allowedMaterials: ['music_wire_a228', 'oil_tempered', 'chrome_silicon', 'chrome_vanadium', 'ss_302'],\n  springIndexRange: [4, 12],\n};\n\n/**\n * Default weights\n */\nexport const DEFAULT_WEIGHTS: OptimizationWeights = {\n  stressWeight: 1.0,\n  safetyWeight: 1.5,\n  fatigueWeight: 1.0,\n  bucklingWeight: 0.8,\n  massWeight: 0.3,\n  costWeight: 0.2,\n};\n\n/**\n * Material cost factors (relative)\n */\nconst MATERIAL_COSTS: Record<SpringMaterialId, number> = {\n  music_wire_a228: 1.0,\n  oil_tempered: 0.9,\n  ss_302: 2.5,\n  chrome_silicon: 1.5,\n  chrome_vanadium: 1.3,\n  phosphor_bronze: 3.0,\n};\n\n/**\n * Calculate spring rate for compression spring\n */\nfunction calculateSpringRate(\n  wireDiameter: number,\n  meanDiameter: number,\n  activeCoils: number,\n  shearModulus: number\n): number {\n  return (shearModulus * Math.pow(wireDiameter, 4)) / \n         (8 * Math.pow(meanDiameter, 3) * activeCoils);\n}\n\n/**\n * Calculate spring mass\n */\nfunction calculateMass(\n  wireDiameter: number,\n  meanDiameter: number,\n  totalCoils: number,\n  density: number\n): number {\n  const wireLength = Math.PI * meanDiameter * totalCoils;\n  const wireArea = Math.PI * Math.pow(wireDiameter / 2, 2);\n  const volume = wireArea * wireLength;\n  return volume * density * 1e-9; // Convert mm³ to m³, then to kg\n}\n\n/**\n * Create random individual\n */\nfunction createRandomIndividual(constraints: DesignConstraints): Individual {\n  const { wireDiameterRange, meanDiameterRange, activeCoilsRange, freeLengthRange, allowedMaterials } = constraints;\n  \n  return {\n    genes: {\n      wireDiameter: wireDiameterRange[0] + Math.random() * (wireDiameterRange[1] - wireDiameterRange[0]),\n      meanDiameter: meanDiameterRange[0] + Math.random() * (meanDiameterRange[1] - meanDiameterRange[0]),\n      activeCoils: Math.round(activeCoilsRange[0] + Math.random() * (activeCoilsRange[1] - activeCoilsRange[0])),\n      freeLength: freeLengthRange[0] + Math.random() * (freeLengthRange[1] - freeLengthRange[0]),\n      materialIndex: Math.floor(Math.random() * allowedMaterials.length),\n    },\n    fitness: 0,\n    objectives: { stress: 0, safety: 0, fatigue: 0, buckling: 0, mass: 0, cost: 0 },\n    feasible: false,\n  };\n}\n\n/**\n * Evaluate individual fitness\n */\nfunction evaluateIndividual(\n  individual: Individual,\n  targets: DesignTargets,\n  constraints: DesignConstraints,\n  weights: OptimizationWeights,\n  workingConditions: WorkingConditions\n): void {\n  const { wireDiameter, meanDiameter, activeCoils, freeLength, materialIndex } = individual.genes;\n  const materialId = constraints.allowedMaterials[materialIndex];\n  const material = SPRING_MATERIALS.find(m => m.id === materialId);\n  \n  if (!material) {\n    individual.fitness = -Infinity;\n    individual.feasible = false;\n    return;\n  }\n  \n  // Check spring index constraint\n  const springIndex = meanDiameter / wireDiameter;\n  if (springIndex < constraints.springIndexRange[0] || springIndex > constraints.springIndexRange[1]) {\n    individual.fitness = -Infinity;\n    individual.feasible = false;\n    return;\n  }\n  \n  // Create geometry\n  const totalCoils = activeCoils + 2;\n  const geometry: CompressionSpringGeometry = {\n    type: 'compression',\n    wireDiameter,\n    meanDiameter,\n    activeCoils,\n    totalCoils,\n    freeLength,\n    materialId,\n  };\n  \n  try {\n    // Run analysis\n    const result = SpringAnalysisEngine.analyze(geometry, workingConditions);\n    \n    // Calculate spring rate\n    const springRate = calculateSpringRate(wireDiameter, meanDiameter, activeCoils, material.shearModulus);\n    \n    // Calculate mass\n    const mass = calculateMass(wireDiameter, meanDiameter, totalCoils, material.density ?? 7850);\n    \n    // Calculate cost factor\n    const cost = mass * (MATERIAL_COSTS[materialId] ?? 1.0);\n    \n    // Store objectives\n    individual.objectives = {\n      stress: result.stress.tauEffective / material.allowShearStatic,\n      safety: 1 / result.safety.staticSafetyFactor,\n      fatigue: 1 / Math.log10(Math.max(result.fatigue.estimatedCycles, 1)),\n      buckling: result.buckling ? 1 / result.buckling.bucklingSafetyFactor : 0,\n      mass,\n      cost,\n    };\n    \n    // Check feasibility against targets\n    individual.feasible = true;\n    let penaltySum = 0;\n    \n    if (targets.targetStiffness) {\n      const stiffnessError = Math.abs(springRate - targets.targetStiffness) / targets.targetStiffness;\n      penaltySum += stiffnessError * 10;\n      if (stiffnessError > 0.1) individual.feasible = false;\n    }\n    \n    if (targets.maxStress && result.stress.tauEffective > targets.maxStress) {\n      penaltySum += (result.stress.tauEffective - targets.maxStress) / targets.maxStress * 5;\n      individual.feasible = false;\n    }\n    \n    if (targets.minSafetyFactor && result.safety.staticSafetyFactor < targets.minSafetyFactor) {\n      penaltySum += (targets.minSafetyFactor - result.safety.staticSafetyFactor) * 3;\n      individual.feasible = false;\n    }\n    \n    if (targets.minFatigueLife && result.fatigue.estimatedCycles < targets.minFatigueLife) {\n      penaltySum += Math.log10(targets.minFatigueLife / Math.max(result.fatigue.estimatedCycles, 1));\n      individual.feasible = false;\n    }\n    \n    if (targets.maxFreeLength && freeLength > targets.maxFreeLength) {\n      penaltySum += (freeLength - targets.maxFreeLength) / targets.maxFreeLength * 2;\n      individual.feasible = false;\n    }\n    \n    if (targets.maxOuterDiameter && (meanDiameter + wireDiameter) > targets.maxOuterDiameter) {\n      penaltySum += ((meanDiameter + wireDiameter) - targets.maxOuterDiameter) / targets.maxOuterDiameter * 2;\n      individual.feasible = false;\n    }\n    \n    // Calculate weighted fitness (lower is better)\n    const weightedCost = \n      weights.stressWeight * individual.objectives.stress +\n      weights.safetyWeight * individual.objectives.safety +\n      weights.fatigueWeight * individual.objectives.fatigue +\n      weights.bucklingWeight * individual.objectives.buckling +\n      weights.massWeight * individual.objectives.mass +\n      weights.costWeight * individual.objectives.cost +\n      penaltySum;\n    \n    individual.fitness = -weightedCost; // Negate because we maximize fitness\n    \n  } catch {\n    individual.fitness = -Infinity;\n    individual.feasible = false;\n  }\n}\n\n/**\n * Tournament selection\n */\nfunction tournamentSelect(population: Individual[], tournamentSize: number = 3): Individual {\n  let best: Individual | null = null;\n  \n  for (let i = 0; i < tournamentSize; i++) {\n    const idx = Math.floor(Math.random() * population.length);\n    const candidate = population[idx];\n    if (!best || candidate.fitness > best.fitness) {\n      best = candidate;\n    }\n  }\n  \n  return best!;\n}\n\n/**\n * Crossover two individuals\n */\nfunction crossover(parent1: Individual, parent2: Individual, constraints: DesignConstraints): Individual {\n  const child: Individual = {\n    genes: {\n      wireDiameter: Math.random() < 0.5 ? parent1.genes.wireDiameter : parent2.genes.wireDiameter,\n      meanDiameter: Math.random() < 0.5 ? parent1.genes.meanDiameter : parent2.genes.meanDiameter,\n      activeCoils: Math.random() < 0.5 ? parent1.genes.activeCoils : parent2.genes.activeCoils,\n      freeLength: Math.random() < 0.5 ? parent1.genes.freeLength : parent2.genes.freeLength,\n      materialIndex: Math.random() < 0.5 ? parent1.genes.materialIndex : parent2.genes.materialIndex,\n    },\n    fitness: 0,\n    objectives: { stress: 0, safety: 0, fatigue: 0, buckling: 0, mass: 0, cost: 0 },\n    feasible: false,\n  };\n  \n  // Blend crossover for continuous variables\n  if (Math.random() < 0.3) {\n    const alpha = Math.random();\n    child.genes.wireDiameter = alpha * parent1.genes.wireDiameter + (1 - alpha) * parent2.genes.wireDiameter;\n    child.genes.meanDiameter = alpha * parent1.genes.meanDiameter + (1 - alpha) * parent2.genes.meanDiameter;\n    child.genes.freeLength = alpha * parent1.genes.freeLength + (1 - alpha) * parent2.genes.freeLength;\n  }\n  \n  // Clamp to constraints\n  child.genes.wireDiameter = Math.max(constraints.wireDiameterRange[0], \n    Math.min(constraints.wireDiameterRange[1], child.genes.wireDiameter));\n  child.genes.meanDiameter = Math.max(constraints.meanDiameterRange[0], \n    Math.min(constraints.meanDiameterRange[1], child.genes.meanDiameter));\n  child.genes.freeLength = Math.max(constraints.freeLengthRange[0], \n    Math.min(constraints.freeLengthRange[1], child.genes.freeLength));\n  \n  return child;\n}\n\n/**\n * Mutate individual\n */\nfunction mutate(individual: Individual, constraints: DesignConstraints, mutationRate: number = 0.1): void {\n  const { wireDiameterRange, meanDiameterRange, activeCoilsRange, freeLengthRange, allowedMaterials } = constraints;\n  \n  if (Math.random() < mutationRate) {\n    const delta = (wireDiameterRange[1] - wireDiameterRange[0]) * 0.1 * (Math.random() - 0.5);\n    individual.genes.wireDiameter = Math.max(wireDiameterRange[0], \n      Math.min(wireDiameterRange[1], individual.genes.wireDiameter + delta));\n  }\n  \n  if (Math.random() < mutationRate) {\n    const delta = (meanDiameterRange[1] - meanDiameterRange[0]) * 0.1 * (Math.random() - 0.5);\n    individual.genes.meanDiameter = Math.max(meanDiameterRange[0], \n      Math.min(meanDiameterRange[1], individual.genes.meanDiameter + delta));\n  }\n  \n  if (Math.random() < mutationRate) {\n    const delta = Math.round((Math.random() - 0.5) * 4);\n    individual.genes.activeCoils = Math.max(activeCoilsRange[0], \n      Math.min(activeCoilsRange[1], individual.genes.activeCoils + delta));\n  }\n  \n  if (Math.random() < mutationRate) {\n    const delta = (freeLengthRange[1] - freeLengthRange[0]) * 0.1 * (Math.random() - 0.5);\n    individual.genes.freeLength = Math.max(freeLengthRange[0], \n      Math.min(freeLengthRange[1], individual.genes.freeLength + delta));\n  }\n  \n  if (Math.random() < mutationRate * 0.5) {\n    individual.genes.materialIndex = Math.floor(Math.random() * allowedMaterials.length);\n  }\n}\n\n/**\n * Check Pareto dominance\n */\nfunction dominates(a: Individual, b: Individual): boolean {\n  const objA = a.objectives;\n  const objB = b.objectives;\n  \n  let dominated = false;\n  let dominates = false;\n  \n  for (const key of Object.keys(objA) as (keyof typeof objA)[]) {\n    if (objA[key] < objB[key]) dominates = true;\n    if (objA[key] > objB[key]) dominated = true;\n  }\n  \n  return dominates && !dominated;\n}\n\n/**\n * Extract Pareto front\n */\nfunction extractParetoFront(population: Individual[]): Individual[] {\n  const paretoFront: Individual[] = [];\n  \n  for (const individual of population) {\n    if (!individual.feasible) continue;\n    \n    let dominated = false;\n    for (const other of population) {\n      if (other !== individual && dominates(other, individual)) {\n        dominated = true;\n        break;\n      }\n    }\n    \n    if (!dominated) {\n      paretoFront.push(individual);\n    }\n  }\n  \n  return paretoFront;\n}\n\n/**\n * Run genetic algorithm optimization\n */\nexport function optimizeSpringDesign(\n  targets: DesignTargets,\n  workingConditions: WorkingConditions,\n  constraints: DesignConstraints = DEFAULT_CONSTRAINTS,\n  weights: OptimizationWeights = DEFAULT_WEIGHTS,\n  options: {\n    populationSize?: number;\n    generations?: number;\n    eliteCount?: number;\n    mutationRate?: number;\n  } = {}\n): OptimizationResult {\n  const {\n    populationSize = 50,\n    generations = 100,\n    eliteCount = 5,\n    mutationRate = 0.15,\n  } = options;\n  \n  // Initialize population\n  let population: Individual[] = [];\n  for (let i = 0; i < populationSize; i++) {\n    population.push(createRandomIndividual(constraints));\n  }\n  \n  // Evaluate initial population\n  for (const individual of population) {\n    evaluateIndividual(individual, targets, constraints, weights, workingConditions);\n  }\n  \n  const convergenceHistory: OptimizationResult['convergenceHistory'] = [];\n  let bestEver: Individual | null = null;\n  \n  // Evolution loop\n  for (let gen = 0; gen < generations; gen++) {\n    // Sort by fitness\n    population.sort((a, b) => b.fitness - a.fitness);\n    \n    // Track best\n    if (!bestEver || population[0].fitness > bestEver.fitness) {\n      bestEver = { ...population[0], genes: { ...population[0].genes } };\n    }\n    \n    // Record convergence\n    const avgFitness = population.reduce((sum, ind) => sum + ind.fitness, 0) / populationSize;\n    convergenceHistory.push({\n      generation: gen,\n      bestFitness: population[0].fitness,\n      avgFitness,\n    });\n    \n    // Create next generation\n    const nextGen: Individual[] = [];\n    \n    // Elitism\n    for (let i = 0; i < eliteCount; i++) {\n      nextGen.push({ ...population[i], genes: { ...population[i].genes } });\n    }\n    \n    // Crossover and mutation\n    while (nextGen.length < populationSize) {\n      const parent1 = tournamentSelect(population);\n      const parent2 = tournamentSelect(population);\n      const child = crossover(parent1, parent2, constraints);\n      mutate(child, constraints, mutationRate);\n      evaluateIndividual(child, targets, constraints, weights, workingConditions);\n      nextGen.push(child);\n    }\n    \n    population = nextGen;\n  }\n  \n  // Final sort\n  population.sort((a, b) => b.fitness - a.fitness);\n  \n  // Extract Pareto front\n  const paretoIndividuals = extractParetoFront(population);\n  \n  // Build result\n  const best = bestEver ?? population[0];\n  const materialId = constraints.allowedMaterials[best.genes.materialIndex];\n  const material = SPRING_MATERIALS.find(m => m.id === materialId)!;\n  \n  const springRate = calculateSpringRate(\n    best.genes.wireDiameter,\n    best.genes.meanDiameter,\n    best.genes.activeCoils,\n    material.shearModulus\n  );\n  \n  const mass = calculateMass(\n    best.genes.wireDiameter,\n    best.genes.meanDiameter,\n    best.genes.activeCoils + 2,\n    material.density ?? 7850\n  );\n  \n  // Determine status\n  let status: OptimizationResult['status'] = 'success';\n  let message: { en: string; zh: string };\n  \n  if (!best.feasible) {\n    status = 'partial';\n    message = {\n      en: 'Optimization completed but no fully feasible solution found. Consider relaxing constraints.',\n      zh: '优化完成但未找到完全可行的解决方案。考虑放宽约束条件。',\n    };\n  } else if (best.fitness < -10) {\n    status = 'partial';\n    message = {\n      en: 'Solution found but with significant compromises. Review targets and constraints.',\n      zh: '找到解决方案但有显著折中。请审查目标和约束条件。',\n    };\n  } else {\n    message = {\n      en: `Optimization successful. Best fitness: ${best.fitness.toFixed(3)}`,\n      zh: `优化成功。最佳适应度：${best.fitness.toFixed(3)}`,\n    };\n  }\n  \n  return {\n    bestSolution: {\n      wireDiameter: Math.round(best.genes.wireDiameter * 100) / 100,\n      meanDiameter: Math.round(best.genes.meanDiameter * 100) / 100,\n      activeCoils: best.genes.activeCoils,\n      freeLength: Math.round(best.genes.freeLength * 10) / 10,\n      materialId,\n    },\n    expectedPerformance: {\n      springRate: Math.round(springRate * 100) / 100,\n      maxStress: Math.round(best.objectives.stress * material.allowShearStatic * 10) / 10,\n      safetyFactor: Math.round(1 / best.objectives.safety * 100) / 100,\n      fatigueLife: Math.pow(10, 1 / best.objectives.fatigue),\n      naturalFrequency: 0, // Would need dynamics calculation\n      mass: Math.round(mass * 1000) / 1000,\n    },\n    fitnessScore: best.fitness,\n    convergenceHistory,\n    paretoFront: paretoIndividuals.slice(0, 10).map(ind => ({\n      solution: {\n        wireDiameter: Math.round(ind.genes.wireDiameter * 100) / 100,\n        meanDiameter: Math.round(ind.genes.meanDiameter * 100) / 100,\n        activeCoils: ind.genes.activeCoils,\n        freeLength: Math.round(ind.genes.freeLength * 10) / 10,\n        materialId: constraints.allowedMaterials[ind.genes.materialIndex],\n      },\n      objectives: {\n        stress: ind.objectives.stress,\n        safety: 1 / ind.objectives.safety,\n        fatigue: Math.pow(10, 1 / ind.objectives.fatigue),\n        mass: ind.objectives.mass,\n      },\n    })),\n    status,\n    message,\n  };\n}\n\n/**\n * Quick inverse solve for single target\n */\nexport function inverseDesignSolve(\n  targetStiffness: number,\n  targetForce: number,\n  targetDeflection: number,\n  constraints: Partial<DesignConstraints> = {}\n): OptimizationResult {\n  const fullConstraints: DesignConstraints = {\n    ...DEFAULT_CONSTRAINTS,\n    ...constraints,\n  };\n  \n  const targets: DesignTargets = {\n    targetStiffness,\n    targetForce: { deflection: targetDeflection, force: targetForce },\n    minSafetyFactor: 1.5,\n    minFatigueLife: 1e6,\n  };\n  \n  const workingConditions: WorkingConditions = {\n    minDeflection: 0,\n    maxDeflection: targetDeflection,\n  };\n  \n  return optimizeSpringDesign(targets, workingConditions, fullConstraints);\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/cncReverseGuidance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/coatingSimulation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/corrosionModel.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/costYieldPredictor.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'wireDiameter' is defined but never used.","line":220,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":220,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'freeLength' is assigned a value but never used.","line":409,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":409,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Cost & Yield AI Predictor - Phase 7\n * 成本与良率AI预测器\n * \n * Predicts manufacturing cost, scrap rate, and process capability\n */\n\n/**\n * Material grade for cost calculation\n */\nexport type MaterialGrade = \n  | 'music_wire'\n  | 'hard_drawn'\n  | 'oil_tempered'\n  | 'chrome_vanadium'\n  | 'chrome_silicon'\n  | 'stainless_302'\n  | 'stainless_316'\n  | 'stainless_17_7ph'\n  | 'inconel'\n  | 'titanium'\n  | 'beryllium_copper';\n\n/**\n * Surface treatment type\n */\nexport type SurfaceTreatment = \n  | 'none'\n  | 'zinc_plate'\n  | 'zinc_yellow'\n  | 'cadmium'\n  | 'phosphate'\n  | 'black_oxide'\n  | 'passivate'\n  | 'powder_coat'\n  | 'epoxy';\n\n/**\n * Cost prediction input\n */\nexport interface CostPredictionInput {\n  /** Material grade */\n  materialGrade: MaterialGrade;\n  /** Wire diameter (mm) */\n  wireDiameter: number;\n  /** Mean diameter (mm) */\n  meanDiameter: number;\n  /** Active coils */\n  activeCoils: number;\n  /** Free length (mm) */\n  freeLength: number;\n  /** Tolerance class */\n  toleranceClass: 'standard' | 'precision' | 'ultra_precision';\n  /** Surface treatment */\n  surfaceTreatment: SurfaceTreatment;\n  /** Shot peening */\n  shotPeening: boolean;\n  /** Shot peening intensity */\n  shotPeeningIntensity?: 'light' | 'standard' | 'heavy';\n  /** Stress relief */\n  stressRelief: boolean;\n  /** Batch volume */\n  batchVolume: number;\n  /** End type */\n  endType: 'open' | 'closed' | 'ground' | 'closed_ground';\n}\n\n/**\n * Material cost data ($/kg)\n */\nconst MATERIAL_COSTS: Record<MaterialGrade, number> = {\n  music_wire: 3.5,\n  hard_drawn: 2.5,\n  oil_tempered: 4.0,\n  chrome_vanadium: 5.5,\n  chrome_silicon: 6.0,\n  stainless_302: 8.0,\n  stainless_316: 12.0,\n  stainless_17_7ph: 25.0,\n  inconel: 80.0,\n  titanium: 120.0,\n  beryllium_copper: 45.0,\n};\n\n/**\n * Material density (kg/m³)\n */\nconst MATERIAL_DENSITY: Record<MaterialGrade, number> = {\n  music_wire: 7850,\n  hard_drawn: 7850,\n  oil_tempered: 7850,\n  chrome_vanadium: 7850,\n  chrome_silicon: 7850,\n  stainless_302: 7900,\n  stainless_316: 8000,\n  stainless_17_7ph: 7800,\n  inconel: 8200,\n  titanium: 4500,\n  beryllium_copper: 8250,\n};\n\n/**\n * Surface treatment costs ($/piece base + $/kg)\n */\nconst TREATMENT_COSTS: Record<SurfaceTreatment, { base: number; perKg: number }> = {\n  none: { base: 0, perKg: 0 },\n  zinc_plate: { base: 0.02, perKg: 1.5 },\n  zinc_yellow: { base: 0.03, perKg: 2.0 },\n  cadmium: { base: 0.05, perKg: 4.0 },\n  phosphate: { base: 0.01, perKg: 0.8 },\n  black_oxide: { base: 0.02, perKg: 1.0 },\n  passivate: { base: 0.02, perKg: 1.2 },\n  powder_coat: { base: 0.10, perKg: 3.0 },\n  epoxy: { base: 0.08, perKg: 2.5 },\n};\n\n/**\n * Tolerance multipliers\n */\nconst TOLERANCE_MULTIPLIERS: Record<string, number> = {\n  standard: 1.0,\n  precision: 1.5,\n  ultra_precision: 2.5,\n};\n\n/**\n * Cost breakdown\n */\nexport interface CostBreakdown {\n  /** Material cost per piece ($) */\n  materialCost: number;\n  /** Labor cost per piece ($) */\n  laborCost: number;\n  /** Machine cost per piece ($) */\n  machineCost: number;\n  /** Surface treatment cost ($) */\n  treatmentCost: number;\n  /** Shot peening cost ($) */\n  shotPeeningCost: number;\n  /** Grinding cost (if applicable) ($) */\n  grindingCost: number;\n  /** Quality inspection cost ($) */\n  inspectionCost: number;\n  /** Setup cost amortized ($) */\n  setupCostPerPiece: number;\n  /** Total cost per piece ($) */\n  totalCostPerPiece: number;\n  /** Total batch cost ($) */\n  totalBatchCost: number;\n}\n\n/**\n * Yield prediction\n */\nexport interface YieldPrediction {\n  /** Expected yield (%) */\n  expectedYield: number;\n  /** Expected scrap rate (%) */\n  scrapRate: number;\n  /** First pass yield (%) */\n  firstPassYield: number;\n  /** Rework rate (%) */\n  reworkRate: number;\n  /** Process capability index (Cpk) */\n  cpk: number;\n  /** Process performance index (Ppk) */\n  ppk: number;\n  /** Defects per million opportunities */\n  dpmo: number;\n  /** Sigma level */\n  sigmaLevel: number;\n}\n\n/**\n * Risk factors\n */\nexport interface RiskFactors {\n  /** Wire curvature risk (0-1) */\n  wireCurvatureRisk: number;\n  /** Tolerance tightness risk (0-1) */\n  toleranceTightnessRisk: number;\n  /** Fatigue risk (0-1) */\n  fatigueRisk: number;\n  /** Surface defect risk (0-1) */\n  surfaceDefectRisk: number;\n  /** Dimensional risk (0-1) */\n  dimensionalRisk: number;\n  /** Overall risk score (0-100) */\n  overallRiskScore: number;\n  /** Risk level */\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n}\n\n/**\n * Cost and yield prediction result\n */\nexport interface CostYieldPredictionResult {\n  /** Cost breakdown */\n  costBreakdown: CostBreakdown;\n  /** Yield prediction */\n  yieldPrediction: YieldPrediction;\n  /** Risk factors */\n  riskFactors: RiskFactors;\n  /** Required inspection precision (mm) */\n  requiredInspectionPrecision: number;\n  /** Recommended batch size for optimal cost */\n  recommendedBatchSize: number;\n  /** Break-even quantity */\n  breakEvenQuantity: number;\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Calculate spring wire length\n */\nfunction calculateWireLength(\n  meanDiameter: number,\n  activeCoils: number,\n  wireDiameter: number\n): number {\n  const totalCoils = activeCoils + 2;  // Dead coils\n  const coilCircumference = Math.PI * meanDiameter;\n  return totalCoils * coilCircumference;\n}\n\n/**\n * Calculate spring weight\n */\nfunction calculateWeight(\n  wireDiameter: number,\n  wireLength: number,\n  density: number\n): number {\n  const wireArea = Math.PI * Math.pow(wireDiameter / 2, 2);  // mm²\n  const volume = wireArea * wireLength;  // mm³\n  return (volume / 1e9) * density;  // kg\n}\n\n/**\n * Calculate spring index complexity factor\n */\nfunction calculateComplexityFactor(\n  wireDiameter: number,\n  meanDiameter: number,\n  activeCoils: number\n): number {\n  const springIndex = meanDiameter / wireDiameter;\n  \n  let factor = 1.0;\n  \n  // Spring index effects\n  if (springIndex < 4) {\n    factor *= 1.5;  // Very tight coils - difficult\n  } else if (springIndex < 6) {\n    factor *= 1.2;\n  } else if (springIndex > 15) {\n    factor *= 1.3;  // Very loose - stability issues\n  }\n  \n  // Coil count effects\n  if (activeCoils < 3) {\n    factor *= 1.3;  // Few coils - precision critical\n  } else if (activeCoils > 20) {\n    factor *= 1.2;  // Many coils - handling issues\n  }\n  \n  // Wire diameter effects\n  if (wireDiameter < 0.5) {\n    factor *= 1.5;  // Fine wire - difficult handling\n  } else if (wireDiameter > 10) {\n    factor *= 1.3;  // Heavy wire - forming forces\n  }\n  \n  return factor;\n}\n\n/**\n * Predict process capability\n */\nfunction predictProcessCapability(\n  toleranceClass: string,\n  complexityFactor: number,\n  batchVolume: number\n): { cpk: number; ppk: number; dpmo: number; sigmaLevel: number } {\n  // Base Cpk for each tolerance class\n  const baseCpk: Record<string, number> = {\n    standard: 1.33,\n    precision: 1.0,\n    ultra_precision: 0.8,\n  };\n  \n  let cpk = baseCpk[toleranceClass] || 1.33;\n  \n  // Adjust for complexity\n  cpk /= complexityFactor;\n  \n  // Adjust for batch volume (learning curve)\n  if (batchVolume > 10000) {\n    cpk *= 1.1;  // Process stabilizes\n  } else if (batchVolume < 100) {\n    cpk *= 0.9;  // Less process optimization\n  }\n  \n  // Ppk is typically slightly lower than Cpk\n  const ppk = cpk * 0.95;\n  \n  // Calculate DPMO from Cpk\n  // DPMO ≈ 1,000,000 * (1 - Φ(3*Cpk))\n  // Simplified approximation\n  const dpmo = Math.max(1, 1000000 * Math.exp(-3 * cpk * cpk));\n  \n  // Sigma level\n  const sigmaLevel = 3 * cpk;\n  \n  return { cpk, ppk, dpmo, sigmaLevel };\n}\n\n/**\n * Calculate risk factors\n */\nfunction calculateRiskFactors(\n  input: CostPredictionInput,\n  complexityFactor: number\n): RiskFactors {\n  const springIndex = input.meanDiameter / input.wireDiameter;\n  \n  // Wire curvature risk\n  let wireCurvatureRisk = 0;\n  if (springIndex < 4) {\n    wireCurvatureRisk = 0.8;\n  } else if (springIndex < 6) {\n    wireCurvatureRisk = 0.4;\n  } else if (springIndex > 15) {\n    wireCurvatureRisk = 0.5;\n  } else {\n    wireCurvatureRisk = 0.2;\n  }\n  \n  // Tolerance tightness risk\n  const toleranceTightnessRisk = {\n    standard: 0.1,\n    precision: 0.4,\n    ultra_precision: 0.7,\n  }[input.toleranceClass] || 0.2;\n  \n  // Fatigue risk (based on material and treatment)\n  let fatigueRisk = 0.3;\n  if (input.shotPeening) {\n    fatigueRisk *= 0.5;\n  }\n  if (['inconel', 'chrome_silicon'].includes(input.materialGrade)) {\n    fatigueRisk *= 0.7;\n  }\n  \n  // Surface defect risk\n  let surfaceDefectRisk = 0.2;\n  if (input.wireDiameter < 1) {\n    surfaceDefectRisk = 0.4;\n  }\n  if (input.surfaceTreatment !== 'none') {\n    surfaceDefectRisk += 0.1;  // Treatment can introduce defects\n  }\n  \n  // Dimensional risk\n  const dimensionalRisk = Math.min(0.9, complexityFactor * 0.3);\n  \n  // Overall risk score\n  const overallRiskScore = (\n    wireCurvatureRisk * 20 +\n    toleranceTightnessRisk * 25 +\n    fatigueRisk * 20 +\n    surfaceDefectRisk * 15 +\n    dimensionalRisk * 20\n  );\n  \n  // Risk level\n  let riskLevel: RiskFactors['riskLevel'];\n  if (overallRiskScore < 25) {\n    riskLevel = 'low';\n  } else if (overallRiskScore < 50) {\n    riskLevel = 'medium';\n  } else if (overallRiskScore < 75) {\n    riskLevel = 'high';\n  } else {\n    riskLevel = 'critical';\n  }\n  \n  return {\n    wireCurvatureRisk,\n    toleranceTightnessRisk,\n    fatigueRisk,\n    surfaceDefectRisk,\n    dimensionalRisk,\n    overallRiskScore,\n    riskLevel,\n  };\n}\n\n/**\n * Predict manufacturing cost and yield\n */\nexport function predictCostAndYield(input: CostPredictionInput): CostYieldPredictionResult {\n  const {\n    materialGrade,\n    wireDiameter,\n    meanDiameter,\n    activeCoils,\n    freeLength,\n    toleranceClass,\n    surfaceTreatment,\n    shotPeening,\n    shotPeeningIntensity,\n    stressRelief,\n    batchVolume,\n    endType,\n  } = input;\n  \n  // Calculate wire properties\n  const wireLength = calculateWireLength(meanDiameter, activeCoils, wireDiameter);\n  const density = MATERIAL_DENSITY[materialGrade] || 7850;\n  const weight = calculateWeight(wireDiameter, wireLength, density);\n  \n  // Complexity factor\n  const complexityFactor = calculateComplexityFactor(wireDiameter, meanDiameter, activeCoils);\n  \n  // Material cost\n  const materialCostPerKg = MATERIAL_COSTS[materialGrade] || 5;\n  const materialCost = weight * materialCostPerKg * 1.1;  // 10% scrap allowance\n  \n  // Labor cost (base rate * complexity * tolerance)\n  const baseLabor = 0.05;  // $/piece base\n  const laborCost = baseLabor * complexityFactor * TOLERANCE_MULTIPLIERS[toleranceClass];\n  \n  // Machine cost\n  const machineRate = 0.50;  // $/minute\n  const cycleTime = 0.1 + activeCoils * 0.02;  // minutes per piece\n  const machineCost = machineRate * cycleTime * complexityFactor;\n  \n  // Surface treatment cost\n  const treatmentData = TREATMENT_COSTS[surfaceTreatment];\n  const treatmentCost = treatmentData.base + weight * treatmentData.perKg;\n  \n  // Shot peening cost\n  let shotPeeningCost = 0;\n  if (shotPeening) {\n    const intensityMultiplier = {\n      light: 0.8,\n      standard: 1.0,\n      heavy: 1.3,\n    }[shotPeeningIntensity || 'standard'];\n    shotPeeningCost = 0.03 * intensityMultiplier + weight * 2;\n  }\n  \n  // Grinding cost (for ground ends)\n  let grindingCost = 0;\n  if (endType === 'ground' || endType === 'closed_ground') {\n    grindingCost = 0.02 + wireDiameter * 0.01;\n  }\n  \n  // Stress relief cost\n  let stressReliefCost = 0;\n  if (stressRelief) {\n    stressReliefCost = 0.01 + weight * 0.5;\n  }\n  \n  // Inspection cost\n  const inspectionCost = {\n    standard: 0.01,\n    precision: 0.03,\n    ultra_precision: 0.08,\n  }[toleranceClass] || 0.02;\n  \n  // Setup cost\n  const setupCost = 150 + complexityFactor * 50;  // Base setup cost\n  const setupCostPerPiece = setupCost / batchVolume;\n  \n  // Total cost\n  const totalCostPerPiece = \n    materialCost + \n    laborCost + \n    machineCost + \n    treatmentCost + \n    shotPeeningCost + \n    grindingCost + \n    stressReliefCost +\n    inspectionCost + \n    setupCostPerPiece;\n  \n  const totalBatchCost = totalCostPerPiece * batchVolume + setupCost;\n  \n  const costBreakdown: CostBreakdown = {\n    materialCost,\n    laborCost,\n    machineCost,\n    treatmentCost,\n    shotPeeningCost,\n    grindingCost,\n    inspectionCost,\n    setupCostPerPiece,\n    totalCostPerPiece,\n    totalBatchCost,\n  };\n  \n  // Yield prediction\n  const processCapability = predictProcessCapability(toleranceClass, complexityFactor, batchVolume);\n  \n  // Expected yield based on Cpk\n  const expectedYield = Math.min(99.9, 100 * (1 - processCapability.dpmo / 1000000));\n  const scrapRate = 100 - expectedYield;\n  const firstPassYield = expectedYield * 0.95;  // Some rework\n  const reworkRate = expectedYield - firstPassYield;\n  \n  const yieldPrediction: YieldPrediction = {\n    expectedYield,\n    scrapRate,\n    firstPassYield,\n    reworkRate,\n    ...processCapability,\n  };\n  \n  // Risk factors\n  const riskFactors = calculateRiskFactors(input, complexityFactor);\n  \n  // Required inspection precision\n  const requiredInspectionPrecision = {\n    standard: 0.1,\n    precision: 0.05,\n    ultra_precision: 0.01,\n  }[toleranceClass] || 0.1;\n  \n  // Recommended batch size (minimize cost per piece)\n  const recommendedBatchSize = Math.max(100, Math.ceil(setupCost / (totalCostPerPiece * 0.1)));\n  \n  // Break-even quantity\n  const variableCost = totalCostPerPiece - setupCostPerPiece;\n  const breakEvenQuantity = Math.ceil(setupCost / variableCost);\n  \n  // Recommendations\n  const recommendations = generateCostRecommendations(\n    input,\n    costBreakdown,\n    yieldPrediction,\n    riskFactors\n  );\n  \n  return {\n    costBreakdown,\n    yieldPrediction,\n    riskFactors,\n    requiredInspectionPrecision,\n    recommendedBatchSize,\n    breakEvenQuantity,\n    recommendations,\n  };\n}\n\n/**\n * Generate cost optimization recommendations\n */\nfunction generateCostRecommendations(\n  input: CostPredictionInput,\n  cost: CostBreakdown,\n  yield_: YieldPrediction,\n  risk: RiskFactors\n): string[] {\n  const recommendations: string[] = [];\n  \n  // Batch size optimization\n  if (input.batchVolume < 500) {\n    recommendations.push(`Consider increasing batch size to ${Math.ceil(input.batchVolume * 2)} to reduce setup cost per piece`);\n  }\n  \n  // Material cost\n  if (cost.materialCost > cost.totalCostPerPiece * 0.4) {\n    recommendations.push('Material cost is high - consider alternative grades or wire diameter optimization');\n  }\n  \n  // Tolerance relaxation\n  if (input.toleranceClass === 'ultra_precision' && yield_.cpk > 1.5) {\n    recommendations.push('Process capability exceeds requirements - consider relaxing tolerances to reduce cost');\n  }\n  \n  // Shot peening\n  if (!input.shotPeening && risk.fatigueRisk > 0.4) {\n    recommendations.push('Consider shot peening to improve fatigue life and reduce warranty risk');\n  }\n  \n  // Surface treatment\n  if (input.surfaceTreatment === 'cadmium') {\n    recommendations.push('Consider zinc plating as environmentally-friendly alternative to cadmium');\n  }\n  \n  // Yield improvement\n  if (yield_.scrapRate > 3) {\n    recommendations.push(`High scrap rate (${yield_.scrapRate.toFixed(1)}%) - review process controls and tooling`);\n  }\n  \n  // Risk mitigation\n  if (risk.riskLevel === 'high' || risk.riskLevel === 'critical') {\n    recommendations.push('High manufacturing risk - consider design review or prototype testing');\n  }\n  \n  if (risk.wireCurvatureRisk > 0.5) {\n    recommendations.push('Adjust spring index to reduce wire curvature stress during coiling');\n  }\n  \n  if (recommendations.length === 0) {\n    recommendations.push('Manufacturing parameters are well-optimized for cost and quality');\n  }\n  \n  return recommendations;\n}\n\n/**\n * Compare cost across different batch sizes\n */\nexport function compareBatchCosts(\n  input: CostPredictionInput,\n  batchSizes: number[]\n): Map<number, CostBreakdown> {\n  const results = new Map<number, CostBreakdown>();\n  \n  for (const size of batchSizes) {\n    const result = predictCostAndYield({ ...input, batchVolume: size });\n    results.set(size, result.costBreakdown);\n  }\n  \n  return results;\n}\n\n/**\n * Find optimal batch size for target cost\n */\nexport function findOptimalBatchSize(\n  input: CostPredictionInput,\n  targetCostPerPiece: number\n): number {\n  let low = 10;\n  let high = 100000;\n  \n  while (high - low > 10) {\n    const mid = Math.floor((low + high) / 2);\n    const result = predictCostAndYield({ ...input, batchVolume: mid });\n    \n    if (result.costBreakdown.totalCostPerPiece > targetCostPerPiece) {\n      low = mid;\n    } else {\n      high = mid;\n    }\n  }\n  \n  return high;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/crackInitiationProbability.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/digitalTwinCalibration.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sumY2' is assigned a value but never used.","line":138,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":138,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Digital Twin Calibration Engine - Phase 7\n * 数字孪生校准引擎\n * \n * Calibrates simulation models with real experimental data\n */\n\n/**\n * Experimental data point\n */\nexport interface ExperimentalDataPoint {\n  /** Deflection (mm) */\n  deflection: number;\n  /** Force (N) */\n  force: number;\n  /** Cycle count (optional) */\n  cycles?: number;\n  /** Timestamp (optional) */\n  timestamp?: number;\n}\n\n/**\n * Experimental test data\n */\nexport interface ExperimentalTestData {\n  /** Force-deflection curve data */\n  forceDeflectionData: ExperimentalDataPoint[];\n  /** Measured spring rate (N/mm) */\n  measuredSpringRate?: number;\n  /** Measured free length (mm) */\n  measuredFreeLength?: number;\n  /** Measured solid height (mm) */\n  measuredSolidHeight?: number;\n  /** Height reduction after cycles (mm) */\n  heightReduction?: number;\n  /** Cycles completed */\n  cyclesCompleted?: number;\n  /** Operating frequency (Hz) */\n  frequency?: number;\n  /** Test temperature (°C) */\n  temperature?: number;\n}\n\n/**\n * Theoretical spring parameters\n */\nexport interface TheoreticalParameters {\n  /** Wire diameter (mm) */\n  wireDiameter: number;\n  /** Mean diameter (mm) */\n  meanDiameter: number;\n  /** Active coils */\n  activeCoils: number;\n  /** Free length (mm) */\n  freeLength: number;\n  /** Theoretical spring rate (N/mm) */\n  theoreticalSpringRate: number;\n  /** Material shear modulus (MPa) */\n  shearModulus: number;\n}\n\n/**\n * Calibration deviation analysis\n */\nexport interface DeviationAnalysis {\n  /** Spring rate deviation (%) */\n  springRateDeviation: number;\n  /** Free length deviation (mm) */\n  freeLengthDeviation: number;\n  /** Curve fit R² value */\n  curveRSquared: number;\n  /** Maximum force deviation (%) */\n  maxForceDeviation: number;\n  /** Average force deviation (%) */\n  avgForceDeviation: number;\n  /** Nonlinearity index */\n  nonlinearityIndex: number;\n  /** Hysteresis (if cyclic data) */\n  hysteresis?: number;\n}\n\n/**\n * Reverse-solved parameters\n */\nexport interface ReverseSolvedParameters {\n  /** Effective wire diameter (mm) */\n  effectiveWireDiameter: number;\n  /** Effective mean diameter (mm) */\n  effectiveMeanDiameter: number;\n  /** Effective active coils */\n  effectiveActiveCoils: number;\n  /** Pitch variation (mm) */\n  pitchVariation: number;\n  /** Coil diameter tolerance (mm) */\n  coilDiameterTolerance: number;\n  /** Residual stress compensation (MPa) */\n  residualStressCompensation: number;\n  /** Stiffness loss from micro-yielding (%) */\n  stiffnessLossPercent: number;\n  /** Effective shear modulus (MPa) */\n  effectiveShearModulus: number;\n}\n\n/**\n * Calibration result\n */\nexport interface CalibrationResult {\n  /** Deviation analysis */\n  deviationAnalysis: DeviationAnalysis;\n  /** Reverse-solved parameters */\n  reverseSolvedParameters: ReverseSolvedParameters;\n  /** Calibrated force-deflection curve */\n  calibratedCurve: ExperimentalDataPoint[];\n  /** Confidence level (0-1) */\n  confidenceLevel: number;\n  /** Calibration quality */\n  calibrationQuality: 'excellent' | 'good' | 'acceptable' | 'poor';\n  /** Identified issues */\n  identifiedIssues: string[];\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Curve fitting using least squares\n */\nfunction fitLinearCurve(data: ExperimentalDataPoint[]): { slope: number; intercept: number; rSquared: number } {\n  const n = data.length;\n  if (n < 2) return { slope: 0, intercept: 0, rSquared: 0 };\n  \n  let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;\n  \n  for (const point of data) {\n    sumX += point.deflection;\n    sumY += point.force;\n    sumXY += point.deflection * point.force;\n    sumX2 += point.deflection * point.deflection;\n    sumY2 += point.force * point.force;\n  }\n  \n  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);\n  const intercept = (sumY - slope * sumX) / n;\n  \n  // R² calculation\n  const yMean = sumY / n;\n  let ssTotal = 0, ssResidual = 0;\n  \n  for (const point of data) {\n    const yPredicted = slope * point.deflection + intercept;\n    ssTotal += Math.pow(point.force - yMean, 2);\n    ssResidual += Math.pow(point.force - yPredicted, 2);\n  }\n  \n  const rSquared = ssTotal > 0 ? 1 - ssResidual / ssTotal : 0;\n  \n  return { slope, intercept, rSquared };\n}\n\n/**\n * Calculate nonlinearity index\n */\nfunction calculateNonlinearity(data: ExperimentalDataPoint[], linearSlope: number): number {\n  if (data.length < 3) return 0;\n  \n  let maxDeviation = 0;\n  const maxForce = Math.max(...data.map(d => d.force));\n  \n  for (const point of data) {\n    const linearForce = linearSlope * point.deflection;\n    const deviation = Math.abs(point.force - linearForce) / maxForce;\n    maxDeviation = Math.max(maxDeviation, deviation);\n  }\n  \n  return maxDeviation;\n}\n\n/**\n * Detect hysteresis from cyclic data\n */\nfunction detectHysteresis(data: ExperimentalDataPoint[]): number {\n  // Simple hysteresis detection - compare loading vs unloading\n  // Assumes data contains both loading and unloading phases\n  \n  if (data.length < 10) return 0;\n  \n  const midIndex = Math.floor(data.length / 2);\n  const loadingData = data.slice(0, midIndex);\n  const unloadingData = data.slice(midIndex).reverse();\n  \n  let totalDiff = 0;\n  const numCompare = Math.min(loadingData.length, unloadingData.length);\n  \n  for (let i = 0; i < numCompare; i++) {\n    const loadPoint = loadingData[i];\n    // Find closest unloading point by deflection\n    const unloadPoint = unloadingData.reduce((closest, p) => \n      Math.abs(p.deflection - loadPoint.deflection) < Math.abs(closest.deflection - loadPoint.deflection) ? p : closest\n    );\n    \n    if (Math.abs(unloadPoint.deflection - loadPoint.deflection) < 0.5) {\n      totalDiff += Math.abs(loadPoint.force - unloadPoint.force);\n    }\n  }\n  \n  const avgForce = data.reduce((sum, p) => sum + p.force, 0) / data.length;\n  return avgForce > 0 ? (totalDiff / numCompare) / avgForce : 0;\n}\n\n/**\n * Reverse solve spring parameters from experimental data\n */\nfunction reverseSolveParameters(\n  experimental: ExperimentalTestData,\n  theoretical: TheoreticalParameters,\n  measuredSpringRate: number\n): ReverseSolvedParameters {\n  const { wireDiameter, meanDiameter, activeCoils, shearModulus } = theoretical;\n  \n  // Spring rate formula: k = G*d^4 / (8*D^3*Na)\n  // Solve for effective parameters\n  \n  const theoreticalK = theoretical.theoreticalSpringRate;\n  const actualK = measuredSpringRate;\n  const kRatio = actualK / theoreticalK;\n  \n  // Stiffness loss from micro-yielding\n  const stiffnessLossPercent = kRatio < 1 ? (1 - kRatio) * 100 : 0;\n  \n  // Effective shear modulus (accounts for material variation)\n  const effectiveShearModulus = shearModulus * kRatio;\n  \n  // Reverse solve wire diameter (most sensitive parameter)\n  // k ∝ d^4, so d_eff = d * (k_actual/k_theory)^0.25\n  const effectiveWireDiameter = wireDiameter * Math.pow(kRatio, 0.25);\n  \n  // Reverse solve mean diameter\n  // k ∝ 1/D^3, so D_eff = D * (k_theory/k_actual)^(1/3)\n  const effectiveMeanDiameter = meanDiameter * Math.pow(1/kRatio, 1/3);\n  \n  // Effective active coils\n  // k ∝ 1/Na, so Na_eff = Na / k_ratio\n  const effectiveActiveCoils = activeCoils / kRatio;\n  \n  // Pitch variation (from free length deviation)\n  const theoreticalPitch = (theoretical.freeLength - wireDiameter * 2) / activeCoils;\n  const measuredPitch = experimental.measuredFreeLength ? \n    (experimental.measuredFreeLength - wireDiameter * 2) / activeCoils : theoreticalPitch;\n  const pitchVariation = measuredPitch - theoreticalPitch;\n  \n  // Coil diameter tolerance\n  const coilDiameterTolerance = effectiveMeanDiameter - meanDiameter;\n  \n  // Residual stress compensation (estimated from stiffness loss)\n  // Higher stiffness loss suggests tensile residual stress\n  const residualStressCompensation = stiffnessLossPercent > 0 ? \n    -stiffnessLossPercent * 10 : 0;  // Rough estimate: 10 MPa per 1% loss\n  \n  return {\n    effectiveWireDiameter,\n    effectiveMeanDiameter,\n    effectiveActiveCoils,\n    pitchVariation,\n    coilDiameterTolerance,\n    residualStressCompensation,\n    stiffnessLossPercent,\n    effectiveShearModulus,\n  };\n}\n\n/**\n * Calibrate digital twin with experimental data\n */\nexport function calibrateDigitalTwin(\n  experimental: ExperimentalTestData,\n  theoretical: TheoreticalParameters\n): CalibrationResult {\n  const { forceDeflectionData } = experimental;\n  \n  // Fit experimental curve\n  const fit = fitLinearCurve(forceDeflectionData);\n  const measuredSpringRate = experimental.measuredSpringRate || fit.slope;\n  \n  // Calculate deviations\n  const springRateDeviation = ((measuredSpringRate - theoretical.theoreticalSpringRate) / \n    theoretical.theoreticalSpringRate) * 100;\n  \n  const freeLengthDeviation = experimental.measuredFreeLength ? \n    experimental.measuredFreeLength - theoretical.freeLength : 0;\n  \n  // Calculate force deviations\n  let maxForceDeviation = 0;\n  let totalForceDeviation = 0;\n  \n  for (const point of forceDeflectionData) {\n    const theoreticalForce = theoretical.theoreticalSpringRate * point.deflection;\n    const deviation = Math.abs((point.force - theoreticalForce) / theoreticalForce) * 100;\n    maxForceDeviation = Math.max(maxForceDeviation, deviation);\n    totalForceDeviation += deviation;\n  }\n  \n  const avgForceDeviation = totalForceDeviation / forceDeflectionData.length;\n  \n  // Nonlinearity and hysteresis\n  const nonlinearityIndex = calculateNonlinearity(forceDeflectionData, measuredSpringRate);\n  const hysteresis = detectHysteresis(forceDeflectionData);\n  \n  const deviationAnalysis: DeviationAnalysis = {\n    springRateDeviation,\n    freeLengthDeviation,\n    curveRSquared: fit.rSquared,\n    maxForceDeviation,\n    avgForceDeviation,\n    nonlinearityIndex,\n    hysteresis,\n  };\n  \n  // Reverse solve parameters\n  const reverseSolvedParameters = reverseSolveParameters(\n    experimental,\n    theoretical,\n    measuredSpringRate\n  );\n  \n  // Generate calibrated curve\n  const calibratedCurve: ExperimentalDataPoint[] = [];\n  const maxDeflection = Math.max(...forceDeflectionData.map(d => d.deflection));\n  \n  for (let i = 0; i <= 50; i++) {\n    const deflection = (maxDeflection / 50) * i;\n    const force = measuredSpringRate * deflection + fit.intercept;\n    calibratedCurve.push({ deflection, force });\n  }\n  \n  // Determine calibration quality\n  let calibrationQuality: CalibrationResult['calibrationQuality'];\n  let confidenceLevel: number;\n  \n  if (fit.rSquared > 0.99 && Math.abs(springRateDeviation) < 3) {\n    calibrationQuality = 'excellent';\n    confidenceLevel = 0.95;\n  } else if (fit.rSquared > 0.95 && Math.abs(springRateDeviation) < 5) {\n    calibrationQuality = 'good';\n    confidenceLevel = 0.85;\n  } else if (fit.rSquared > 0.90 && Math.abs(springRateDeviation) < 10) {\n    calibrationQuality = 'acceptable';\n    confidenceLevel = 0.70;\n  } else {\n    calibrationQuality = 'poor';\n    confidenceLevel = 0.50;\n  }\n  \n  // Identify issues\n  const identifiedIssues: string[] = [];\n  \n  if (Math.abs(springRateDeviation) > 5) {\n    identifiedIssues.push(`Spring rate deviation of ${springRateDeviation.toFixed(1)}% exceeds tolerance`);\n  }\n  if (nonlinearityIndex > 0.05) {\n    identifiedIssues.push('Significant nonlinearity detected - possible coil clash or material yielding');\n  }\n  if (hysteresis && hysteresis > 0.03) {\n    identifiedIssues.push('Hysteresis detected - friction or material damping present');\n  }\n  if (reverseSolvedParameters.stiffnessLossPercent > 5) {\n    identifiedIssues.push(`Stiffness loss of ${reverseSolvedParameters.stiffnessLossPercent.toFixed(1)}% - micro-yielding suspected`);\n  }\n  if (Math.abs(freeLengthDeviation) > 1) {\n    identifiedIssues.push(`Free length deviation of ${freeLengthDeviation.toFixed(2)}mm`);\n  }\n  \n  // Generate recommendations\n  const recommendations: string[] = [];\n  \n  if (reverseSolvedParameters.coilDiameterTolerance > 0.1) {\n    recommendations.push(`Adjust mandrel diameter by ${(-reverseSolvedParameters.coilDiameterTolerance).toFixed(3)}mm`);\n  }\n  if (Math.abs(reverseSolvedParameters.pitchVariation) > 0.1) {\n    recommendations.push(`Adjust pitch cam by ${(-reverseSolvedParameters.pitchVariation).toFixed(3)}mm`);\n  }\n  if (reverseSolvedParameters.stiffnessLossPercent > 3) {\n    recommendations.push('Consider stress relief heat treatment to recover stiffness');\n  }\n  if (nonlinearityIndex > 0.03) {\n    recommendations.push('Check for coil clash - may need to increase pitch or reduce deflection');\n  }\n  \n  if (recommendations.length === 0) {\n    recommendations.push('Spring performance matches design specifications');\n  }\n  \n  return {\n    deviationAnalysis,\n    reverseSolvedParameters,\n    calibratedCurve,\n    confidenceLevel,\n    calibrationQuality,\n    identifiedIssues,\n    recommendations,\n  };\n}\n\n/**\n * Parse CSV force-deflection data\n */\nexport function parseForceDeflectionCSV(csvContent: string): ExperimentalDataPoint[] {\n  const lines = csvContent.trim().split('\\n');\n  const data: ExperimentalDataPoint[] = [];\n  \n  // Skip header if present\n  const startIndex = lines[0].toLowerCase().includes('deflection') || \n    lines[0].toLowerCase().includes('force') ? 1 : 0;\n  \n  for (let i = startIndex; i < lines.length; i++) {\n    const parts = lines[i].split(/[,\\t;]/);\n    if (parts.length >= 2) {\n      const deflection = parseFloat(parts[0]);\n      const force = parseFloat(parts[1]);\n      \n      if (!isNaN(deflection) && !isNaN(force)) {\n        data.push({ deflection, force });\n      }\n    }\n  }\n  \n  return data;\n}\n\n/**\n * Export calibration report\n */\nexport function exportCalibrationReport(result: CalibrationResult): string {\n  return `\n================================================================================\nDIGITAL TWIN CALIBRATION REPORT\nGenerated by ISRI-SHUANGDI Spring Engineering Platform\n================================================================================\n\nCALIBRATION QUALITY: ${result.calibrationQuality.toUpperCase()}\nConfidence Level: ${(result.confidenceLevel * 100).toFixed(0)}%\n\n--------------------------------------------------------------------------------\nDEVIATION ANALYSIS\n--------------------------------------------------------------------------------\nSpring Rate Deviation: ${result.deviationAnalysis.springRateDeviation.toFixed(2)}%\nFree Length Deviation: ${result.deviationAnalysis.freeLengthDeviation.toFixed(3)} mm\nCurve Fit R²: ${result.deviationAnalysis.curveRSquared.toFixed(4)}\nMax Force Deviation: ${result.deviationAnalysis.maxForceDeviation.toFixed(2)}%\nAvg Force Deviation: ${result.deviationAnalysis.avgForceDeviation.toFixed(2)}%\nNonlinearity Index: ${result.deviationAnalysis.nonlinearityIndex.toFixed(4)}\n${result.deviationAnalysis.hysteresis ? `Hysteresis: ${(result.deviationAnalysis.hysteresis * 100).toFixed(2)}%` : ''}\n\n--------------------------------------------------------------------------------\nREVERSE-SOLVED PARAMETERS\n--------------------------------------------------------------------------------\nEffective Wire Diameter: ${result.reverseSolvedParameters.effectiveWireDiameter.toFixed(4)} mm\nEffective Mean Diameter: ${result.reverseSolvedParameters.effectiveMeanDiameter.toFixed(4)} mm\nEffective Active Coils: ${result.reverseSolvedParameters.effectiveActiveCoils.toFixed(2)}\nPitch Variation: ${result.reverseSolvedParameters.pitchVariation.toFixed(4)} mm\nCoil Diameter Tolerance: ${result.reverseSolvedParameters.coilDiameterTolerance.toFixed(4)} mm\nResidual Stress Compensation: ${result.reverseSolvedParameters.residualStressCompensation.toFixed(1)} MPa\nStiffness Loss: ${result.reverseSolvedParameters.stiffnessLossPercent.toFixed(2)}%\nEffective Shear Modulus: ${result.reverseSolvedParameters.effectiveShearModulus.toFixed(0)} MPa\n\n--------------------------------------------------------------------------------\nIDENTIFIED ISSUES\n--------------------------------------------------------------------------------\n${result.identifiedIssues.length > 0 ? result.identifiedIssues.map(i => `• ${i}`).join('\\n') : '• No significant issues identified'}\n\n--------------------------------------------------------------------------------\nRECOMMENDATIONS\n--------------------------------------------------------------------------------\n${result.recommendations.map(r => `• ${r}`).join('\\n')}\n\n================================================================================\n`;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/feaSolverScripts.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringMaterial' is defined but never used.","line":9,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'springRate' is assigned a value but never used.","line":71,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":71,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1714,1717],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1714,1717],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2419,2422],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2419,2422],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2459,2462],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2459,2462],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2578,2581],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2578,2581],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":474,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":474,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15100,15103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15100,15103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":475,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":475,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15140,15143],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15140,15143],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":477,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":477,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15259,15262],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15259,15262],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FEA Auto Solver Script Generator - Phase 7\n * FEA自动求解器脚本生成器\n * \n * Generates complete Python scripts for Abaqus CAE and ANSYS APDL\n */\n\nimport type { SpringGeometry } from '../types';\nimport type { SpringMaterial } from '@/lib/materials/springMaterials';\nimport { getSpringMaterial } from '@/lib/materials/springMaterials';\n\n/**\n * Load case definition\n */\nexport interface LoadCase {\n  name: string;\n  type: 'axial' | 'torsional' | 'combined';\n  axialForce?: number;      // N\n  axialDisplacement?: number; // mm\n  torque?: number;          // N·mm\n  rotation?: number;        // degrees\n}\n\n/**\n * Mesh settings\n */\nexport interface MeshSettings {\n  globalSize: number;       // mm\n  refinementFactor: number; // 1-5, higher = finer at curves\n  elementType: 'linear' | 'quadratic';\n  circumferentialDivisions: number;\n}\n\n/**\n * Material model type\n */\nexport type MaterialModel = 'elastic' | 'elastoplastic' | 'ramberg-osgood';\n\n/**\n * FEA solver options\n */\nexport interface FEASolverOptions {\n  geometry: SpringGeometry;\n  loadCases: LoadCase[];\n  meshSettings: MeshSettings;\n  materialModel: MaterialModel;\n  outputRequests: {\n    stress: boolean;\n    displacement: boolean;\n    strain: boolean;\n    fatigueLife: boolean;\n    safetyFactor: boolean;\n    contourImages: boolean;\n  };\n}\n\n/**\n * Default mesh settings\n */\nexport const DEFAULT_MESH_SETTINGS: MeshSettings = {\n  globalSize: 0.5,\n  refinementFactor: 3,\n  elementType: 'quadratic',\n  circumferentialDivisions: 16,\n};\n\n/**\n * Default load cases for compression spring\n */\nexport function getDefaultLoadCases(geometry: SpringGeometry): LoadCase[] {\n  const springRate = 10; // Approximate, will be calculated\n  const maxDeflection = (geometry as any).freeLength * 0.3;\n  \n  return [\n    {\n      name: 'Preload',\n      type: 'axial',\n      axialDisplacement: maxDeflection * 0.3,\n    },\n    {\n      name: 'Working_Load',\n      type: 'axial',\n      axialDisplacement: maxDeflection * 0.7,\n    },\n    {\n      name: 'Max_Load',\n      type: 'axial',\n      axialDisplacement: maxDeflection,\n    },\n  ];\n}\n\n/**\n * Generate Abaqus CAE Python script\n */\nexport function generateAbaqusScript(options: FEASolverOptions): string {\n  const { geometry, loadCases, meshSettings, materialModel, outputRequests } = options;\n  const material = getSpringMaterial(geometry.materialId);\n  \n  const wireDiameter = geometry.wireDiameter;\n  const meanDiameter = (geometry as any).meanDiameter || \n    ((geometry as any).largeOuterDiameter - wireDiameter);\n  const activeCoils = geometry.activeCoils;\n  const freeLength = (geometry as any).freeLength || 50;\n  const pitch = (freeLength - wireDiameter * 2) / activeCoils;\n\n  let script = `# -*- coding: utf-8 -*-\n\"\"\"\nAbaqus CAE Spring Analysis Script\nGenerated by ISRI-SHUANGDI Spring Engineering Platform\nPhase 7 - Digital Twin FEA Automation\n\nSpring Type: ${geometry.type}\nWire Diameter: ${wireDiameter} mm\nMean Diameter: ${meanDiameter} mm\nActive Coils: ${activeCoils}\nMaterial: ${material?.nameEn || geometry.materialId}\n\"\"\"\n\nfrom abaqus import *\nfrom abaqusConstants import *\nfrom caeModules import *\nimport math\nimport os\n\n# ============================================================\n# PARAMETERS\n# ============================================================\nWIRE_DIAMETER = ${wireDiameter}\nMEAN_DIAMETER = ${meanDiameter}\nACTIVE_COILS = ${activeCoils}\nTOTAL_COILS = ${activeCoils + 2}\nFREE_LENGTH = ${freeLength}\nPITCH = ${pitch.toFixed(4)}\nHELIX_RADIUS = MEAN_DIAMETER / 2.0\n\n# Material Properties\nE_MODULUS = ${material?.elasticModulus || 207000}  # MPa\nPOISSON = 0.3\nDENSITY = ${material?.density || 7850}e-12  # tonne/mm³ for mm units\nYIELD_STRESS = ${material?.tensileStrength ? material.tensileStrength * 0.85 : 1400}  # MPa\n\n# Mesh Settings\nGLOBAL_MESH_SIZE = ${meshSettings.globalSize}\nCIRC_DIVISIONS = ${meshSettings.circumferentialDivisions}\n\n# ============================================================\n# CREATE MODEL\n# ============================================================\nmodel_name = 'Spring_Analysis'\nmdb.Model(name=model_name)\nmodel = mdb.models[model_name]\n\n# ============================================================\n# CREATE GEOMETRY - Helical Spring\n# ============================================================\nprint(\"Creating spring geometry...\")\n\n# Create helix path using datum points\ns = model.ConstrainedSketch(name='helix_profile', sheetSize=200.0)\n\n# Wire cross-section\ns.CircleByCenterPerimeter(center=(0.0, 0.0), point1=(WIRE_DIAMETER/2, 0.0))\n\n# Create part\npart = model.Part(name='Spring', dimensionality=THREE_D, type=DEFORMABLE_BODY)\n\n# Create helix using sweep\n# First create helix curve points\nhelix_points = []\nnum_points = int(TOTAL_COILS * 36)  # 36 points per coil\nfor i in range(num_points + 1):\n    theta = 2 * math.pi * TOTAL_COILS * i / num_points\n    coil_num = theta / (2 * math.pi)\n    \n    # Dead coils at ends\n    if coil_num < 1:\n        z = coil_num * WIRE_DIAMETER\n    elif coil_num > TOTAL_COILS - 1:\n        z = WIRE_DIAMETER + (ACTIVE_COILS - 1) * PITCH + (coil_num - TOTAL_COILS + 1) * WIRE_DIAMETER\n    else:\n        z = WIRE_DIAMETER + (coil_num - 1) * PITCH\n    \n    x = HELIX_RADIUS * math.cos(theta)\n    y = HELIX_RADIUS * math.sin(theta)\n    helix_points.append((x, y, z))\n\n# Create wire using spline\npart.WireSpline(points=helix_points, mergeType=IMPRINT, smoothClosedSpline=ON)\n\n# Sweep circular section along helix\npart.SolidSweep(path=part.edges, profile=s, sketchUpEdge=part.edges[0])\n\n# ============================================================\n# MATERIAL DEFINITION\n# ============================================================\nprint(\"Defining material...\")\n\nmaterial = model.Material(name='Spring_Steel')\nmaterial.Elastic(table=((E_MODULUS, POISSON), ))\nmaterial.Density(table=((DENSITY, ), ))\n`;\n\n  // Add plasticity if needed\n  if (materialModel === 'elastoplastic' || materialModel === 'ramberg-osgood') {\n    script += `\n# Plasticity (isotropic hardening)\nmaterial.Plastic(table=(\n    (${material?.tensileStrength ? material.tensileStrength * 0.85 : 1400}, 0.0),\n    (${material?.tensileStrength || 1600}, 0.05),\n    (${material?.tensileStrength ? material.tensileStrength * 1.1 : 1800}, 0.10),\n))\n`;\n  }\n\n  if (materialModel === 'ramberg-osgood') {\n    script += `\n# Ramberg-Osgood parameters for cyclic analysis\n# σ = E*ε + K*(ε_p)^n\nK_RO = ${material?.tensileStrength ? material.tensileStrength * 1.2 : 1800}  # Strength coefficient\nn_RO = 0.15  # Strain hardening exponent\n`;\n  }\n\n  script += `\n# ============================================================\n# SECTION AND ASSIGNMENT\n# ============================================================\nmodel.HomogeneousSolidSection(name='Spring_Section', material='Spring_Steel')\npart.Set(name='All_Elements', cells=part.cells)\npart.SectionAssignment(region=part.sets['All_Elements'], sectionName='Spring_Section')\n\n# ============================================================\n# ASSEMBLY\n# ============================================================\nprint(\"Creating assembly...\")\n\nassembly = model.rootAssembly\nassembly.DatumCsysByDefault(CARTESIAN)\ninstance = assembly.Instance(name='Spring-1', part=part, dependent=ON)\n\n# ============================================================\n# MESH\n# ============================================================\nprint(\"Meshing...\")\n\n# Seed part\npart.seedPart(size=GLOBAL_MESH_SIZE, deviationFactor=0.1, minSizeFactor=0.1)\n\n# Refine mesh at high curvature regions\nedges_to_refine = part.edges.getByBoundingBox(\n    xMin=-MEAN_DIAMETER, xMax=MEAN_DIAMETER,\n    yMin=-MEAN_DIAMETER, yMax=MEAN_DIAMETER,\n    zMin=0, zMax=WIRE_DIAMETER * 2\n)\npart.seedEdgeBySize(edges=edges_to_refine, size=GLOBAL_MESH_SIZE/${meshSettings.refinementFactor})\n\n# Element type\n${meshSettings.elementType === 'quadratic' ? \n  \"elemType = mesh.ElemType(elemCode=C3D20R, elemLibrary=STANDARD)\" :\n  \"elemType = mesh.ElemType(elemCode=C3D8R, elemLibrary=STANDARD)\"}\npart.setElementType(regions=(part.cells,), elemTypes=(elemType,))\n\n# Generate mesh\npart.generateMesh()\n\nprint(f\"Mesh generated: {len(part.elements)} elements, {len(part.nodes)} nodes\")\n\n# ============================================================\n# BOUNDARY CONDITIONS\n# ============================================================\nprint(\"Applying boundary conditions...\")\n\n# Fixed end (bottom)\nbottom_face = instance.faces.getByBoundingBox(zMax=WIRE_DIAMETER*0.5)\nassembly.Set(name='Fixed_End', faces=bottom_face)\nmodel.EncastreBC(name='Fixed_BC', createStepName='Initial', region=assembly.sets['Fixed_End'])\n\n# Top surface for load application\ntop_face = instance.faces.getByBoundingBox(zMin=FREE_LENGTH - WIRE_DIAMETER*0.5)\nassembly.Set(name='Load_Surface', faces=top_face)\n\n# Reference point for load application\nrp = assembly.ReferencePoint(point=(0, 0, FREE_LENGTH + 5))\nassembly.Set(name='RP', referencePoints=(assembly.referencePoints[rp.id],))\n\n# Coupling constraint\nmodel.Coupling(name='Top_Coupling', controlPoint=assembly.sets['RP'],\n               surface=assembly.sets['Load_Surface'], influenceRadius=WHOLE_SURFACE,\n               couplingType=KINEMATIC, u1=ON, u2=ON, u3=ON, ur1=ON, ur2=ON, ur3=ON)\n\n`;\n\n  // Add load cases\n  loadCases.forEach((lc, index) => {\n    script += `\n# ============================================================\n# LOAD CASE ${index + 1}: ${lc.name}\n# ============================================================\nstep_name = '${lc.name}'\nmodel.StaticStep(name=step_name, previous='${ index === 0 ? 'Initial' : loadCases[index-1].name}',\n                 nlgeom=ON, maxNumInc=100, initialInc=0.1, minInc=1e-8, maxInc=0.5)\n\n`;\n    if (lc.axialDisplacement !== undefined) {\n      script += `model.DisplacementBC(name='Disp_${lc.name}', createStepName=step_name,\n                     region=assembly.sets['RP'], u3=-${lc.axialDisplacement})\n`;\n    } else if (lc.axialForce !== undefined) {\n      script += `model.ConcentratedForce(name='Force_${lc.name}', createStepName=step_name,\n                        region=assembly.sets['RP'], cf3=-${lc.axialForce})\n`;\n    }\n  });\n\n  // Output requests\n  script += `\n# ============================================================\n# OUTPUT REQUESTS\n# ============================================================\n`;\n\n  if (outputRequests.stress) {\n    script += `model.FieldOutputRequest(name='Stress_Output', createStepName='${loadCases[0].name}',\n                         variables=('S', 'MISES', 'TRESC', 'PRESS'))\n`;\n  }\n  if (outputRequests.displacement) {\n    script += `model.FieldOutputRequest(name='Disp_Output', createStepName='${loadCases[0].name}',\n                         variables=('U', 'RF'))\n`;\n  }\n  if (outputRequests.strain) {\n    script += `model.FieldOutputRequest(name='Strain_Output', createStepName='${loadCases[0].name}',\n                         variables=('E', 'PE', 'PEEQ'))\n`;\n  }\n\n  script += `\n# ============================================================\n# CREATE JOB AND SUBMIT\n# ============================================================\nprint(\"Creating analysis job...\")\n\njob_name = 'Spring_Analysis_Job'\nmdb.Job(name=job_name, model=model_name, type=ANALYSIS, \n        numCpus=4, numDomains=4, multiprocessingMode=DEFAULT)\n\n# Submit job\nprint(\"Submitting job...\")\nmdb.jobs[job_name].submit(consistencyChecking=OFF)\nmdb.jobs[job_name].waitForCompletion()\n\nprint(\"Analysis complete!\")\n\n# ============================================================\n# POST-PROCESSING\n# ============================================================\nprint(\"Post-processing results...\")\n\nfrom odbAccess import *\nodb = openOdb(path=job_name + '.odb')\n\n# Get last frame\nlast_step = odb.steps[odb.steps.keys()[-1]]\nlast_frame = last_step.frames[-1]\n\n# Extract stress results\nstress_field = last_frame.fieldOutputs['S']\nmises_field = last_frame.fieldOutputs['MISES']\n\n# Find maximum values\nmax_mises = 0\nmax_tresca = 0\nfor value in mises_field.values:\n    if value.mises > max_mises:\n        max_mises = value.mises\n\nprint(f\"Maximum von Mises stress: {max_mises:.2f} MPa\")\n\n# Displacement\ndisp_field = last_frame.fieldOutputs['U']\nmax_disp = max([abs(v.data[2]) for v in disp_field.values])\nprint(f\"Maximum displacement: {max_disp:.4f} mm\")\n\n# Reaction force\nrf_field = last_frame.fieldOutputs['RF']\ntotal_rf = sum([v.data[2] for v in rf_field.values if abs(v.data[2]) > 0.001])\nprint(f\"Total reaction force: {abs(total_rf):.2f} N\")\n\n# Calculate safety factor\nALLOWABLE_STRESS = ${material?.allowShearStatic || 600}  # MPa\nsafety_factor = ALLOWABLE_STRESS / max_mises if max_mises > 0 else 999\nprint(f\"Safety Factor: {safety_factor:.2f}\")\n\n`;\n\n  if (outputRequests.contourImages) {\n    script += `\n# ============================================================\n# GENERATE CONTOUR IMAGES\n# ============================================================\nprint(\"Generating contour images...\")\n\nsession.viewports['Viewport: 1'].setValues(displayedObject=odb)\nsession.viewports['Viewport: 1'].odbDisplay.display.setValues(plotState=(CONTOURS_ON_DEF,))\n\n# Mises stress contour\nsession.viewports['Viewport: 1'].odbDisplay.setPrimaryVariable(\n    variableLabel='S', outputPosition=INTEGRATION_POINT, refinement=(INVARIANT, 'Mises'))\nsession.printToFile(fileName='stress_mises_contour', format=PNG, canvasObjects=(session.viewports['Viewport: 1'],))\n\n# Displacement contour\nsession.viewports['Viewport: 1'].odbDisplay.setPrimaryVariable(\n    variableLabel='U', outputPosition=NODAL, refinement=(COMPONENT, 'U3'))\nsession.printToFile(fileName='displacement_contour', format=PNG, canvasObjects=(session.viewports['Viewport: 1'],))\n\nprint(\"Contour images saved!\")\n`;\n  }\n\n  if (outputRequests.fatigueLife) {\n    script += `\n# ============================================================\n# FATIGUE LIFE ESTIMATION\n# ============================================================\nprint(\"Estimating fatigue life...\")\n\n# Using Basquin equation: N = (σ_a / σ_f')^(-1/b)\nsigma_f_prime = ${material?.tensileStrength ? material.tensileStrength * 1.5 : 2400}  # Fatigue strength coefficient\nb = -0.085  # Fatigue strength exponent\n\n# Alternating stress (assuming fully reversed)\nsigma_a = max_mises / 2\nfatigue_life = (sigma_a / sigma_f_prime) ** (1/b)\nprint(f\"Estimated fatigue life: {fatigue_life:.2e} cycles\")\n`;\n  }\n\n  script += `\n# ============================================================\n# SAVE RESULTS\n# ============================================================\nresults = {\n    'max_mises_stress': max_mises,\n    'max_displacement': max_disp,\n    'reaction_force': abs(total_rf),\n    'safety_factor': safety_factor,\n}\n\nimport json\nwith open('fea_results.json', 'w') as f:\n    json.dump(results, f, indent=2)\n\nprint(\"Results saved to fea_results.json\")\nprint(\"=\" * 60)\nprint(\"FEA ANALYSIS COMPLETE\")\nprint(\"=\" * 60)\n\nodb.close()\n`;\n\n  return script;\n}\n\n/**\n * Generate ANSYS APDL script\n */\nexport function generateANSYSScript(options: FEASolverOptions): string {\n  const { geometry, loadCases, meshSettings, materialModel, outputRequests } = options;\n  const material = getSpringMaterial(geometry.materialId);\n  \n  const wireDiameter = geometry.wireDiameter;\n  const meanDiameter = (geometry as any).meanDiameter || \n    ((geometry as any).largeOuterDiameter - wireDiameter);\n  const activeCoils = geometry.activeCoils;\n  const freeLength = (geometry as any).freeLength || 50;\n  const pitch = (freeLength - wireDiameter * 2) / activeCoils;\n\n  let script = `! ============================================================\n! ANSYS APDL Spring Analysis Script\n! Generated by ISRI-SHUANGDI Spring Engineering Platform\n! Phase 7 - Digital Twin FEA Automation\n!\n! Spring Type: ${geometry.type}\n! Wire Diameter: ${wireDiameter} mm\n! Mean Diameter: ${meanDiameter} mm\n! Active Coils: ${activeCoils}\n! Material: ${material?.nameEn || geometry.materialId}\n! ============================================================\n\nFINISH\n/CLEAR,START\n\n! ============================================================\n! PARAMETERS\n! ============================================================\nd = ${wireDiameter}                    ! Wire diameter (mm)\nDm = ${meanDiameter}                   ! Mean diameter (mm)\nR = Dm/2                               ! Mean radius (mm)\nNa = ${activeCoils}                    ! Active coils\nNt = ${activeCoils + 2}                ! Total coils\nL0 = ${freeLength}                     ! Free length (mm)\npitch = ${pitch.toFixed(4)}            ! Pitch (mm)\n\n! Material properties\nE_mod = ${material?.elasticModulus || 207000}      ! Elastic modulus (MPa)\nnu = 0.3                               ! Poisson's ratio\ndens = ${material?.density || 7850}e-12            ! Density (tonne/mm³)\nSy = ${material?.tensileStrength ? material.tensileStrength * 0.85 : 1400}  ! Yield stress (MPa)\n\n! Mesh parameters\nmesh_size = ${meshSettings.globalSize}\ncirc_div = ${meshSettings.circumferentialDivisions}\n\n! ============================================================\n! PREPROCESSOR\n! ============================================================\n/PREP7\n\n! Element type - ${meshSettings.elementType === 'quadratic' ? 'SOLID186 (20-node)' : 'SOLID185 (8-node)'}\n${meshSettings.elementType === 'quadratic' ? 'ET,1,SOLID186' : 'ET,1,SOLID185'}\n\n! Material definition\nMP,EX,1,E_mod\nMP,PRXY,1,nu\nMP,DENS,1,dens\n`;\n\n  if (materialModel === 'elastoplastic' || materialModel === 'ramberg-osgood') {\n    script += `\n! Bilinear plasticity\nTB,BISO,1\nTBDATA,1,Sy,E_mod/100\n`;\n  }\n\n  script += `\n! ============================================================\n! CREATE GEOMETRY - Helical Spring\n! ============================================================\n! Create wire cross-section\nK,1,0,0,0\nK,2,d/2,0,0\nCIRCLE,1,d/2,,,,360\nAL,ALL\n\n! Create helix path\n*DEL,helix_pts\n*DIM,helix_pts,ARRAY,361,3\n\nnpts = 360\n*DO,i,0,npts\n    theta = 2*3.14159265*Nt*i/npts\n    coil = theta/(2*3.14159265)\n    \n    ! Z coordinate with dead coils\n    *IF,coil,LT,1,THEN\n        z_coord = coil*d\n    *ELSEIF,coil,GT,Nt-1\n        z_coord = d + (Na-1)*pitch + (coil-Nt+1)*d\n    *ELSE\n        z_coord = d + (coil-1)*pitch\n    *ENDIF\n    \n    x_coord = R*COS(theta)\n    y_coord = R*SIN(theta)\n    \n    helix_pts(i+1,1) = x_coord\n    helix_pts(i+1,2) = y_coord\n    helix_pts(i+1,3) = z_coord\n*ENDDO\n\n! Create spline through helix points\n*DO,i,1,npts+1\n    K,100+i,helix_pts(i,1),helix_pts(i,2),helix_pts(i,3)\n*ENDDO\n\nBSPLIN,101,102,103,104,105,106\n*DO,i,107,npts+101,6\n    BSPLIN,i,i+1,i+2,i+3,i+4,i+5\n*ENDDO\n\n! Sweep section along helix\nVDRAG,1,,,,,,ALL\n\n! ============================================================\n! MESHING\n! ============================================================\n! Global mesh size\nESIZE,mesh_size\n\n! Mesh refinement at ends\nASEL,S,LOC,Z,0,d*2\nAESIZE,ALL,mesh_size/${meshSettings.refinementFactor}\nASEL,ALL\n\n! Mesh volume\nVMESH,ALL\n\n! Report mesh statistics\n*GET,num_elem,ELEM,0,COUNT\n*GET,num_node,NODE,0,COUNT\n/COM, Mesh: %num_elem% elements, %num_node% nodes\n\n! ============================================================\n! BOUNDARY CONDITIONS\n! ============================================================\n! Fixed end (Z = 0)\nNSEL,S,LOC,Z,0,d/2\nD,ALL,ALL,0\nNSEL,ALL\n\n! Create node component for load application\nNSEL,S,LOC,Z,L0-d/2,L0+d/2\nCM,TOP_NODES,NODE\nNSEL,ALL\n\n! Create pilot node for load application\nN,999999,0,0,L0+5\n*GET,pilot_node,NODE,0,NUM,MAX\n\n! Couple top nodes to pilot\nCERIG,pilot_node,TOP_NODES,ALL\n\n`;\n\n  // Add load cases\n  loadCases.forEach((lc, index) => {\n    script += `\n! ============================================================\n! LOAD CASE ${index + 1}: ${lc.name}\n! ============================================================\n/SOLU\nANTYPE,STATIC\nNLGEOM,ON\nNSUBST,20,100,10\nOUTRES,ALL,ALL\n\n`;\n    if (lc.axialDisplacement !== undefined) {\n      script += `D,pilot_node,UZ,-${lc.axialDisplacement}\n`;\n    } else if (lc.axialForce !== undefined) {\n      script += `F,pilot_node,FZ,-${lc.axialForce}\n`;\n    }\n\n    script += `SOLVE\nFINISH\n\n`;\n  });\n\n  script += `\n! ============================================================\n! POST-PROCESSING\n! ============================================================\n/POST1\n\n! Get last load step results\nSET,LAST\n\n! Von Mises stress\nPLNSOL,S,EQV\n*GET,max_mises,PLNSOL,0,MAX\n\n! Maximum shear stress\nPLNSOL,S,INT\n*GET,max_tresca,PLNSOL,0,MAX\n\n! Displacement\nPLNSOL,U,SUM\n*GET,max_disp,PLNSOL,0,MAX\n\n! Reaction force at fixed end\nNSEL,S,LOC,Z,0,d/2\nFSUM\n*GET,react_fz,FSUM,0,ITEM,FZ\nNSEL,ALL\n\n! Calculate safety factor\nallow_stress = ${material?.allowShearStatic || 600}\nsafety_factor = allow_stress/max_mises\n\n/COM, ============================================================\n/COM, RESULTS SUMMARY\n/COM, ============================================================\n/COM, Maximum von Mises Stress: %max_mises% MPa\n/COM, Maximum Shear Stress: %max_tresca% MPa\n/COM, Maximum Displacement: %max_disp% mm\n/COM, Reaction Force: %react_fz% N\n/COM, Safety Factor: %safety_factor%\n/COM, ============================================================\n\n`;\n\n  if (outputRequests.contourImages) {\n    script += `\n! ============================================================\n! GENERATE CONTOUR IMAGES\n! ============================================================\n/VIEW,1,1,1,1\n/ANG,1\n/REP,FAST\n/SHOW,PNG\n\n! Mises stress contour\nPLNSOL,S,EQV\n/IMAGE,SAVE,stress_mises_contour,png\n\n! Displacement contour\nPLNSOL,U,SUM\n/IMAGE,SAVE,displacement_contour,png\n\n/SHOW,CLOSE\n`;\n  }\n\n  if (outputRequests.fatigueLife) {\n    script += `\n! ============================================================\n! FATIGUE LIFE ESTIMATION\n! ============================================================\n! Using Basquin equation\nsigma_f = ${material?.tensileStrength ? material.tensileStrength * 1.5 : 2400}\nb_exp = -0.085\n\nsigma_a = max_mises/2\nfatigue_life = (sigma_a/sigma_f)**(1/b_exp)\n\n/COM, Estimated Fatigue Life: %fatigue_life% cycles\n`;\n  }\n\n  script += `\n! ============================================================\n! EXPORT RESULTS\n! ============================================================\n/OUTPUT,fea_results,txt\n*VWRITE,'max_mises_stress',max_mises\n(A20,F12.2)\n*VWRITE,'max_shear_stress',max_tresca\n(A20,F12.2)\n*VWRITE,'max_displacement',max_disp\n(A20,F12.4)\n*VWRITE,'reaction_force',ABS(react_fz)\n(A20,F12.2)\n*VWRITE,'safety_factor',safety_factor\n(A20,F12.3)\n/OUTPUT\n\n/COM, Results saved to fea_results.txt\n/COM, ============================================================\n/COM, FEA ANALYSIS COMPLETE\n/COM, ============================================================\n\nFINISH\n`;\n\n  return script;\n}\n\n/**\n * FEA script generation result\n */\nexport interface FEAScriptResult {\n  abaqusScript: string;\n  ansysScript: string;\n  filename: {\n    abaqus: string;\n    ansys: string;\n  };\n}\n\n/**\n * Generate both FEA solver scripts\n */\nexport function generateFEAScripts(options: FEASolverOptions): FEAScriptResult {\n  return {\n    abaqusScript: generateAbaqusScript(options),\n    ansysScript: generateANSYSScript(options),\n    filename: {\n      abaqus: `spring_analysis_${Date.now()}.py`,\n      ansys: `spring_analysis_${Date.now()}.inp`,\n    },\n  };\n}\n\n/**\n * Download FEA script\n */\nexport function downloadFEAScript(\n  script: string, \n  filename: string, \n  type: 'abaqus' | 'ansys'\n): void {\n  const mimeType = type === 'abaqus' ? 'text/x-python' : 'text/plain';\n  const blob = new Blob([script], { type: mimeType });\n  const url = URL.createObjectURL(blob);\n  \n  const link = document.createElement('a');\n  link.href = url;\n  link.download = filename;\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  URL.revokeObjectURL(url);\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/fractureHotspot.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/harmonicResponse.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'wireDiameter' is assigned a value but never used.","line":171,"column":61,"nodeType":null,"messageId":"unusedVar","endLine":171,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Resonance Harmonic Response Analysis - Phase 7\n * 共振谐波响应分析\n * \n * Scans frequency domain to detect resonance risks\n */\n\n/**\n * Vibration mode type\n */\nexport type VibrationMode = \n  | 'axial_fundamental'\n  | 'axial_harmonic'\n  | 'torsional'\n  | 'lateral_bending'\n  | 'surge'\n  | 'coupled';\n\n/**\n * Spring dynamic properties\n */\nexport interface SpringDynamicProperties {\n  /** Wire diameter (mm) */\n  wireDiameter: number;\n  /** Mean diameter (mm) */\n  meanDiameter: number;\n  /** Active coils */\n  activeCoils: number;\n  /** Free length (mm) */\n  freeLength: number;\n  /** Spring rate (N/mm) */\n  springRate: number;\n  /** Material density (kg/m³) */\n  density: number;\n  /** Shear modulus (MPa) */\n  shearModulus: number;\n  /** Elastic modulus (MPa) */\n  elasticModulus: number;\n  /** Installed length (mm) - optional */\n  installedLength?: number;\n  /** End mass (kg) - optional */\n  endMass?: number;\n}\n\n/**\n * Operating conditions\n */\nexport interface OperatingConditions {\n  /** Operating frequency range (Hz) */\n  frequencyRange: { min: number; max: number };\n  /** Operating RPM (if applicable) */\n  operatingRPM?: number;\n  /** Excitation amplitude (mm) */\n  excitationAmplitude?: number;\n  /** Damping ratio */\n  dampingRatio?: number;\n}\n\n/**\n * Detected vibration mode\n */\nexport interface DetectedMode {\n  /** Mode type */\n  type: VibrationMode;\n  /** Natural frequency (Hz) */\n  frequency: number;\n  /** Mode number (1st, 2nd, etc.) */\n  modeNumber: number;\n  /** Modal mass participation (%) */\n  massParticipation: number;\n  /** Mode shape description */\n  description: string;\n  /** Damping ratio for this mode */\n  dampingRatio: number;\n}\n\n/**\n * Resonance risk assessment\n */\nexport interface ResonanceRisk {\n  /** Mode causing risk */\n  mode: DetectedMode;\n  /** Operating frequency causing resonance */\n  operatingFrequency: number;\n  /** Frequency ratio (operating/natural) */\n  frequencyRatio: number;\n  /** Amplification factor */\n  amplificationFactor: number;\n  /** Risk level */\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n  /** Recommended action */\n  recommendation: string;\n}\n\n/**\n * Frequency response point\n */\nexport interface FrequencyResponsePoint {\n  /** Frequency (Hz) */\n  frequency: number;\n  /** Amplitude ratio */\n  amplitudeRatio: number;\n  /** Phase angle (degrees) */\n  phaseAngle: number;\n  /** Transmissibility */\n  transmissibility: number;\n}\n\n/**\n * Harmonic response result\n */\nexport interface HarmonicResponseResult {\n  /** Detected vibration modes */\n  detectedModes: DetectedMode[];\n  /** Frequency response curve */\n  frequencyResponse: FrequencyResponsePoint[];\n  /** Resonance risks */\n  resonanceRisks: ResonanceRisk[];\n  /** Safe operating frequency bands */\n  safeFrequencyBands: { min: number; max: number }[];\n  /** Critical frequencies to avoid */\n  criticalFrequencies: number[];\n  /** Overall resonance risk */\n  overallRisk: 'low' | 'medium' | 'high' | 'critical';\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Calculate spring mass\n */\nfunction calculateSpringMass(props: SpringDynamicProperties): number {\n  const totalCoils = props.activeCoils + 2;\n  const coilCircumference = Math.PI * props.meanDiameter;\n  const wireLength = totalCoils * coilCircumference;\n  const wireArea = Math.PI * Math.pow(props.wireDiameter / 2, 2);\n  const volume = wireArea * wireLength;  // mm³\n  return (volume / 1e9) * props.density;  // kg\n}\n\n/**\n * Calculate axial natural frequency\n * f_n = (1/2π) * sqrt(k/m_eff)\n */\nfunction calculateAxialFrequency(\n  springRate: number,  // N/mm\n  springMass: number,  // kg\n  endMass: number = 0,  // kg\n  modeNumber: number = 1\n): number {\n  // Effective mass (1/3 of spring mass + end mass)\n  const effectiveMass = springMass / 3 + endMass;\n  \n  // Convert spring rate to N/m\n  const k = springRate * 1000;\n  \n  // Natural frequency\n  const fn = (modeNumber / (2 * Math.PI)) * Math.sqrt(k / effectiveMass);\n  \n  return fn;\n}\n\n/**\n * Calculate surge frequency (wave propagation)\n * f_surge = (n/4L) * sqrt(G*g / ρ)\n */\nfunction calculateSurgeFrequency(\n  props: SpringDynamicProperties,\n  modeNumber: number = 1\n): number {\n  const { shearModulus, density, activeCoils, meanDiameter, wireDiameter } = props;\n  \n  // Wave velocity in spring\n  const G = shearModulus * 1e6;  // Pa\n  const rho = density;  // kg/m³\n  const waveVelocity = Math.sqrt(G / rho);\n  \n  // Active length of wire\n  const wireLength = activeCoils * Math.PI * meanDiameter / 1000;  // m\n  \n  // Surge frequency\n  const fSurge = (modeNumber * waveVelocity) / (4 * wireLength);\n  \n  return fSurge;\n}\n\n/**\n * Calculate torsional natural frequency\n */\nfunction calculateTorsionalFrequency(\n  props: SpringDynamicProperties,\n  modeNumber: number = 1\n): number {\n  const { shearModulus, density, wireDiameter, meanDiameter, activeCoils } = props;\n  \n  // Torsional stiffness\n  const G = shearModulus * 1e6;  // Pa\n  const d = wireDiameter / 1000;  // m\n  const D = meanDiameter / 1000;  // m\n  const n = activeCoils;\n  \n  // Polar moment of inertia\n  const Ip = Math.PI * Math.pow(d, 4) / 32;\n  \n  // Torsional stiffness\n  const kt = (G * Ip) / (Math.PI * D * n);\n  \n  // Mass moment of inertia\n  const wireLength = n * Math.PI * D;\n  const mass = (Math.PI * Math.pow(d/2, 2) * wireLength) * density;\n  const J = mass * Math.pow(D/2, 2) / 2;\n  \n  // Torsional frequency\n  const ft = (modeNumber / (2 * Math.PI)) * Math.sqrt(kt / J);\n  \n  return ft;\n}\n\n/**\n * Calculate lateral bending frequency\n */\nfunction calculateBendingFrequency(\n  props: SpringDynamicProperties,\n  modeNumber: number = 1\n): number {\n  const { elasticModulus, density, wireDiameter, freeLength, activeCoils } = props;\n  \n  // Treat spring as equivalent beam\n  const E = elasticModulus * 1e6;  // Pa\n  const d = wireDiameter / 1000;  // m\n  const L = freeLength / 1000;  // m\n  \n  // Moment of inertia (equivalent)\n  const I = Math.PI * Math.pow(d, 4) / 64 * activeCoils;\n  \n  // Linear mass density\n  const wireLength = activeCoils * Math.PI * props.meanDiameter / 1000;\n  const mass = (Math.PI * Math.pow(d/2, 2) * wireLength) * density;\n  const mu = mass / L;\n  \n  // Bending frequency (simply supported beam)\n  const lambda = modeNumber * Math.PI;\n  const fb = (lambda * lambda / (2 * Math.PI * L * L)) * Math.sqrt(E * I / mu);\n  \n  return fb;\n}\n\n/**\n * Calculate frequency response (transmissibility)\n */\nfunction calculateFrequencyResponse(\n  naturalFrequency: number,\n  dampingRatio: number,\n  frequencyRange: { min: number; max: number },\n  numPoints: number = 200\n): FrequencyResponsePoint[] {\n  const response: FrequencyResponsePoint[] = [];\n  \n  for (let i = 0; i <= numPoints; i++) {\n    const f = frequencyRange.min + (frequencyRange.max - frequencyRange.min) * (i / numPoints);\n    const r = f / naturalFrequency;  // Frequency ratio\n    const zeta = dampingRatio;\n    \n    // Transmissibility\n    const numerator = Math.sqrt(1 + Math.pow(2 * zeta * r, 2));\n    const denominator = Math.sqrt(Math.pow(1 - r * r, 2) + Math.pow(2 * zeta * r, 2));\n    const T = numerator / denominator;\n    \n    // Amplitude ratio (for force excitation)\n    const H = 1 / Math.sqrt(Math.pow(1 - r * r, 2) + Math.pow(2 * zeta * r, 2));\n    \n    // Phase angle\n    const phi = Math.atan2(2 * zeta * r, 1 - r * r) * 180 / Math.PI;\n    \n    response.push({\n      frequency: f,\n      amplitudeRatio: H,\n      phaseAngle: phi,\n      transmissibility: T,\n    });\n  }\n  \n  return response;\n}\n\n/**\n * Assess resonance risk\n */\nfunction assessResonanceRisk(\n  mode: DetectedMode,\n  operatingFrequency: number,\n  dampingRatio: number\n): ResonanceRisk {\n  const frequencyRatio = operatingFrequency / mode.frequency;\n  \n  // Amplification factor at this frequency ratio\n  const r = frequencyRatio;\n  const zeta = dampingRatio;\n  const amplificationFactor = 1 / Math.sqrt(Math.pow(1 - r * r, 2) + Math.pow(2 * zeta * r, 2));\n  \n  // Risk level based on frequency ratio and amplification\n  let riskLevel: ResonanceRisk['riskLevel'];\n  let recommendation: string;\n  \n  if (frequencyRatio > 0.85 && frequencyRatio < 1.15) {\n    riskLevel = 'critical';\n    recommendation = `Operating frequency ${operatingFrequency.toFixed(0)} Hz is at resonance with ${mode.type} mode. Immediate design change required.`;\n  } else if (frequencyRatio > 0.7 && frequencyRatio < 1.3) {\n    riskLevel = 'high';\n    recommendation = `Operating frequency is near ${mode.type} resonance. Consider changing spring rate or mass.`;\n  } else if (amplificationFactor > 2) {\n    riskLevel = 'medium';\n    recommendation = `Moderate amplification at ${mode.type} mode. Monitor for vibration issues.`;\n  } else {\n    riskLevel = 'low';\n    recommendation = `${mode.type} mode is well separated from operating frequency.`;\n  }\n  \n  return {\n    mode,\n    operatingFrequency,\n    frequencyRatio,\n    amplificationFactor,\n    riskLevel,\n    recommendation,\n  };\n}\n\n/**\n * Perform harmonic response analysis\n */\nexport function analyzeHarmonicResponse(\n  props: SpringDynamicProperties,\n  conditions: OperatingConditions\n): HarmonicResponseResult {\n  const springMass = calculateSpringMass(props);\n  const dampingRatio = conditions.dampingRatio || 0.02;  // Default 2% damping\n  \n  // Detect all vibration modes\n  const detectedModes: DetectedMode[] = [];\n  \n  // Axial modes (1st through 3rd)\n  for (let n = 1; n <= 3; n++) {\n    const freq = calculateAxialFrequency(props.springRate, springMass, props.endMass || 0, n);\n    if (freq <= conditions.frequencyRange.max * 1.5) {\n      detectedModes.push({\n        type: n === 1 ? 'axial_fundamental' : 'axial_harmonic',\n        frequency: freq,\n        modeNumber: n,\n        massParticipation: n === 1 ? 85 : 10 / n,\n        description: `${n}${n === 1 ? 'st' : n === 2 ? 'nd' : 'rd'} axial mode - spring compression/extension`,\n        dampingRatio,\n      });\n    }\n  }\n  \n  // Surge modes\n  for (let n = 1; n <= 2; n++) {\n    const freq = calculateSurgeFrequency(props, n);\n    if (freq <= conditions.frequencyRange.max * 1.5) {\n      detectedModes.push({\n        type: 'surge',\n        frequency: freq,\n        modeNumber: n,\n        massParticipation: 5,\n        description: `${n}${n === 1 ? 'st' : 'nd'} surge mode - wave propagation along coils`,\n        dampingRatio: dampingRatio * 0.5,  // Surge has less damping\n      });\n    }\n  }\n  \n  // Torsional mode\n  const torsionalFreq = calculateTorsionalFrequency(props, 1);\n  if (torsionalFreq <= conditions.frequencyRange.max * 1.5) {\n    detectedModes.push({\n      type: 'torsional',\n      frequency: torsionalFreq,\n      modeNumber: 1,\n      massParticipation: 15,\n      description: '1st torsional mode - rotational oscillation',\n      dampingRatio,\n    });\n  }\n  \n  // Lateral bending modes\n  for (let n = 1; n <= 2; n++) {\n    const freq = calculateBendingFrequency(props, n);\n    if (freq <= conditions.frequencyRange.max * 1.5) {\n      detectedModes.push({\n        type: 'lateral_bending',\n        frequency: freq,\n        modeNumber: n,\n        massParticipation: 8 / n,\n        description: `${n}${n === 1 ? 'st' : 'nd'} lateral bending mode`,\n        dampingRatio: dampingRatio * 1.2,\n      });\n    }\n  }\n  \n  // Sort by frequency\n  detectedModes.sort((a, b) => a.frequency - b.frequency);\n  \n  // Calculate frequency response for fundamental mode\n  const fundamentalMode = detectedModes.find(m => m.type === 'axial_fundamental');\n  const frequencyResponse = fundamentalMode ? \n    calculateFrequencyResponse(fundamentalMode.frequency, dampingRatio, conditions.frequencyRange) :\n    [];\n  \n  // Assess resonance risks\n  const resonanceRisks: ResonanceRisk[] = [];\n  const operatingFrequencies: number[] = [];\n  \n  // Add operating RPM as frequency\n  if (conditions.operatingRPM) {\n    operatingFrequencies.push(conditions.operatingRPM / 60);  // Convert to Hz\n    // Add harmonics\n    operatingFrequencies.push(conditions.operatingRPM / 60 * 2);\n    operatingFrequencies.push(conditions.operatingRPM / 60 * 3);\n  }\n  \n  // Check each operating frequency against each mode\n  for (const opFreq of operatingFrequencies) {\n    for (const mode of detectedModes) {\n      const risk = assessResonanceRisk(mode, opFreq, dampingRatio);\n      if (risk.riskLevel !== 'low') {\n        resonanceRisks.push(risk);\n      }\n    }\n  }\n  \n  // Determine safe frequency bands\n  const safeFrequencyBands: { min: number; max: number }[] = [];\n  const criticalFrequencies = detectedModes.map(m => m.frequency);\n  \n  // Safe bands are regions away from natural frequencies\n  let lastCritical = 0;\n  for (const freq of criticalFrequencies) {\n    const safeMin = lastCritical * 1.3;\n    const safeMax = freq * 0.7;\n    if (safeMax > safeMin && safeMin >= conditions.frequencyRange.min) {\n      safeFrequencyBands.push({ min: safeMin, max: Math.min(safeMax, conditions.frequencyRange.max) });\n    }\n    lastCritical = freq;\n  }\n  \n  // Add band above last critical\n  if (lastCritical * 1.3 < conditions.frequencyRange.max) {\n    safeFrequencyBands.push({ \n      min: lastCritical * 1.3, \n      max: conditions.frequencyRange.max \n    });\n  }\n  \n  // Overall risk assessment\n  let overallRisk: HarmonicResponseResult['overallRisk'] = 'low';\n  if (resonanceRisks.some(r => r.riskLevel === 'critical')) {\n    overallRisk = 'critical';\n  } else if (resonanceRisks.some(r => r.riskLevel === 'high')) {\n    overallRisk = 'high';\n  } else if (resonanceRisks.some(r => r.riskLevel === 'medium')) {\n    overallRisk = 'medium';\n  }\n  \n  // Generate recommendations\n  const recommendations = generateResonanceRecommendations(\n    detectedModes,\n    resonanceRisks,\n    conditions,\n    props\n  );\n  \n  return {\n    detectedModes,\n    frequencyResponse,\n    resonanceRisks,\n    safeFrequencyBands,\n    criticalFrequencies,\n    overallRisk,\n    recommendations,\n  };\n}\n\n/**\n * Generate resonance recommendations\n */\nfunction generateResonanceRecommendations(\n  modes: DetectedMode[],\n  risks: ResonanceRisk[],\n  conditions: OperatingConditions,\n  props: SpringDynamicProperties\n): string[] {\n  const recommendations: string[] = [];\n  \n  // Critical risks\n  const criticalRisks = risks.filter(r => r.riskLevel === 'critical');\n  for (const risk of criticalRisks) {\n    recommendations.push(risk.recommendation);\n  }\n  \n  // Surge frequency warning\n  const surgeMode = modes.find(m => m.type === 'surge');\n  if (surgeMode && conditions.operatingRPM) {\n    const opFreq = conditions.operatingRPM / 60;\n    if (surgeMode.frequency < opFreq * 10) {\n      recommendations.push(\n        `Surge frequency (${surgeMode.frequency.toFixed(0)} Hz) is relatively low. ` +\n        `Consider increasing spring rate or reducing active coils.`\n      );\n    }\n  }\n  \n  // General design guidance\n  if (risks.length > 0) {\n    const fundamentalFreq = modes.find(m => m.type === 'axial_fundamental')?.frequency || 0;\n    \n    // Suggest stiffness change\n    if (conditions.operatingRPM) {\n      const opFreq = conditions.operatingRPM / 60;\n      if (fundamentalFreq < opFreq * 1.5) {\n        const requiredK = props.springRate * Math.pow(opFreq * 1.5 / fundamentalFreq, 2);\n        recommendations.push(\n          `To avoid resonance, increase spring rate to approximately ${requiredK.toFixed(1)} N/mm`\n        );\n      }\n    }\n    \n    // Suggest mass change\n    if (props.endMass && props.endMass > 0) {\n      recommendations.push(\n        `Reducing end mass will increase natural frequency and may help avoid resonance`\n      );\n    }\n    \n    // Damping suggestion\n    if (conditions.dampingRatio && conditions.dampingRatio < 0.05) {\n      recommendations.push(\n        `Consider adding damping (current: ${(conditions.dampingRatio * 100).toFixed(1)}%) to reduce resonance amplification`\n      );\n    }\n  }\n  \n  if (recommendations.length === 0) {\n    recommendations.push('No significant resonance risks detected for the specified operating conditions');\n  }\n  \n  return recommendations;\n}\n\n/**\n * Quick check for resonance risk at specific RPM\n */\nexport function checkResonanceAtRPM(\n  props: SpringDynamicProperties,\n  rpm: number\n): { safe: boolean; nearestMode: DetectedMode | null; margin: number } {\n  const result = analyzeHarmonicResponse(props, {\n    frequencyRange: { min: 1, max: 2000 },\n    operatingRPM: rpm,\n  });\n  \n  const opFreq = rpm / 60;\n  let nearestMode: DetectedMode | null = null;\n  let minMargin = Infinity;\n  \n  for (const mode of result.detectedModes) {\n    const margin = Math.abs(mode.frequency - opFreq) / mode.frequency;\n    if (margin < minMargin) {\n      minMargin = margin;\n      nearestMode = mode;\n    }\n  }\n  \n  return {\n    safe: minMargin > 0.3,  // 30% margin considered safe\n    nearestMode,\n    margin: minMargin,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/healthDegradation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/phase7/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/safety.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/scragTest.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'activeCoils' is defined but never used.","line":177,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":177,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'scragDeflection' is assigned a value but never used.","line":202,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":202,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Scrag Test & Heat Treatment Springback Model - Phase 6\n * 预压试验与热处理回弹模型\n * \n * Models the effects of scragging (presetting) and heat treatment on spring properties\n */\n\nimport type { SpringMaterialId } from '@/lib/materials/springMaterials';\nimport { getSpringMaterial } from '@/lib/materials/springMaterials';\nimport { getRambergOsgoodParams, calculateRambergOsgoodStrain } from './nonlinearMaterial';\n\n/**\n * Scrag test parameters\n */\nexport interface ScragTestParams {\n  /** Original free length (mm) */\n  originalFreeLength: number;\n  /** Original spring rate (N/mm) */\n  originalSpringRate: number;\n  /** Wire diameter (mm) */\n  wireDiameter: number;\n  /** Mean diameter (mm) */\n  meanDiameter: number;\n  /** Active coils */\n  activeCoils: number;\n  /** Scrag force applied (N) */\n  scragForce: number;\n  /** Scrag deflection (mm) */\n  scragDeflection: number;\n  /** Material ID */\n  materialId: SpringMaterialId;\n  /** Number of scrag cycles */\n  scragCycles: number;\n  /** Temperature during scrag (°C) */\n  scragTemperature: number;\n}\n\n/**\n * Heat treatment parameters\n */\nexport interface HeatTreatmentParams {\n  /** Treatment temperature (°C) */\n  temperature: number;\n  /** Soak time (hours) */\n  soakTime: number;\n  /** Cooling method */\n  coolingMethod: 'air' | 'oil' | 'water' | 'furnace';\n  /** Material ID */\n  materialId: SpringMaterialId;\n}\n\n/**\n * Scrag test result\n */\nexport interface ScragTestResult {\n  /** New free length after scrag (mm) */\n  newFreeLength: number;\n  /** Permanent set (mm) */\n  permanentSet: number;\n  /** Permanent set percentage (%) */\n  permanentSetPercent: number;\n  /** New spring rate (N/mm) */\n  newSpringRate: number;\n  /** Spring rate change (%) */\n  springRateChange: number;\n  /** Residual plastic strain */\n  residualPlasticStrain: number;\n  /** Stress at scrag deflection (MPa) */\n  scragStress: number;\n  /** Yield occurred during scrag */\n  yieldOccurred: boolean;\n  /** Stabilization achieved */\n  stabilizationAchieved: boolean;\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Heat treatment result\n */\nexport interface HeatTreatmentResult {\n  /** Modulus recovery factor */\n  modulusRecoveryFactor: number;\n  /** New elastic modulus (MPa) */\n  newElasticModulus: number;\n  /** Stress relief percentage (%) */\n  stressReliefPercent: number;\n  /** Hardness change (HRC) */\n  hardnessChange: number;\n  /** Fatigue life improvement factor */\n  fatigueLifeImprovement: number;\n  /** Dimensional stability improvement */\n  dimensionalStabilityImprovement: number;\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Combined scrag + heat treatment result\n */\nexport interface SpringbackModelResult {\n  /** Scrag test results */\n  scragResult: ScragTestResult;\n  /** Heat treatment results */\n  heatTreatmentResult: HeatTreatmentResult;\n  /** Final free length (mm) */\n  finalFreeLength: number;\n  /** Final spring rate (N/mm) */\n  finalSpringRate: number;\n  /** Total permanent set (mm) */\n  totalPermanentSet: number;\n  /** Recommended design compensation */\n  designCompensation: {\n    freeLengthCompensation: number;\n    coilCompensation: number;\n    pitchCompensation: number;\n  };\n}\n\n/**\n * Calculate scrag stress using spring formula\n */\nexport function calculateScragStress(\n  scragForce: number,\n  wireDiameter: number,\n  meanDiameter: number\n): number {\n  const springIndex = meanDiameter / wireDiameter;\n  const wahlFactor = (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;\n  \n  // Shear stress: τ = 8 * F * D / (π * d³) * K\n  const stress = (8 * scragForce * meanDiameter) / (Math.PI * Math.pow(wireDiameter, 3)) * wahlFactor;\n  \n  return stress;\n}\n\n/**\n * Calculate plastic strain using Ramberg-Osgood model\n */\nexport function calculatePlasticStrain(\n  stress: number,\n  materialId: SpringMaterialId\n): number {\n  const roParams = getRambergOsgoodParams(materialId);\n  const strainResult = calculateRambergOsgoodStrain(stress, roParams);\n  \n  return Math.max(0, strainResult.plasticStrain);\n}\n\n/**\n * Calculate permanent set from plastic strain\n */\nexport function calculatePermanentSet(\n  plasticStrain: number,\n  activeCoils: number,\n  meanDiameter: number,\n  wireDiameter: number\n): number {\n  // Wire length in active coils\n  const wireLength = Math.PI * meanDiameter * activeCoils;\n  \n  // Permanent set is related to plastic strain and geometry\n  // Approximation: δ_permanent ≈ ε_plastic * L_wire * sin(helix_angle)\n  const helixAngle = Math.atan(wireDiameter / (Math.PI * meanDiameter));\n  const permanentSet = plasticStrain * wireLength * Math.sin(helixAngle);\n  \n  return permanentSet;\n}\n\n/**\n * Calculate spring rate change after scrag\n */\nexport function calculateSpringRateChange(\n  originalRate: number,\n  permanentSet: number,\n  originalFreeLength: number,\n  activeCoils: number\n): { newRate: number; changePercent: number } {\n  // Spring rate change due to geometry change\n  // k ∝ d⁴ / (D³ * Na)\n  // After scrag, effective pitch decreases slightly\n  \n  const pitchReductionFactor = 1 - permanentSet / (originalFreeLength * 0.5);\n  const newRate = originalRate * Math.pow(pitchReductionFactor, 0.1); // Small effect\n  \n  const changePercent = ((newRate - originalRate) / originalRate) * 100;\n  \n  return { newRate, changePercent };\n}\n\n/**\n * Simulate scrag test\n */\nexport function simulateScragTest(params: ScragTestParams): ScragTestResult {\n  const {\n    originalFreeLength,\n    originalSpringRate,\n    wireDiameter,\n    meanDiameter,\n    activeCoils,\n    scragForce,\n    scragDeflection,\n    materialId,\n    scragCycles,\n    scragTemperature,\n  } = params;\n\n  // Get material properties\n  const material = getSpringMaterial(materialId);\n  const allowableStress = material?.allowShearStatic ?? 560;\n  const yieldStress = allowableStress * 1.5;\n\n  // Calculate scrag stress\n  const scragStress = calculateScragStress(scragForce, wireDiameter, meanDiameter);\n\n  // Check if yield occurred\n  const yieldOccurred = scragStress > yieldStress * 0.9;\n\n  // Calculate plastic strain\n  const plasticStrain = calculatePlasticStrain(scragStress, materialId);\n\n  // Calculate permanent set\n  let permanentSet = calculatePermanentSet(plasticStrain, activeCoils, meanDiameter, wireDiameter);\n\n  // Multiple cycles increase permanent set (diminishing returns)\n  const cyclesFactor = 1 + 0.1 * Math.log(scragCycles + 1);\n  permanentSet *= cyclesFactor;\n\n  // Temperature effect on permanent set\n  const tempFactor = 1 + (scragTemperature - 20) * 0.001;\n  permanentSet *= tempFactor;\n\n  // New free length\n  const newFreeLength = originalFreeLength - permanentSet;\n  const permanentSetPercent = (permanentSet / originalFreeLength) * 100;\n\n  // Spring rate change\n  const { newRate, changePercent } = calculateSpringRateChange(\n    originalSpringRate,\n    permanentSet,\n    originalFreeLength,\n    activeCoils\n  );\n\n  // Check stabilization (typically after 3-5 cycles with <0.5% additional set)\n  const stabilizationAchieved = scragCycles >= 3 && permanentSetPercent < 2;\n\n  // Recommendations\n  const recommendations: string[] = [];\n\n  if (!yieldOccurred) {\n    recommendations.push('Scrag stress below yield - consider increasing scrag force for better presetting');\n  }\n\n  if (permanentSetPercent > 3) {\n    recommendations.push('High permanent set - verify design allows for this deformation');\n  }\n\n  if (!stabilizationAchieved && scragCycles < 3) {\n    recommendations.push('Increase scrag cycles to achieve dimensional stability');\n  }\n\n  if (scragTemperature > 100) {\n    recommendations.push('Hot scragging detected - verify material properties at temperature');\n  }\n\n  return {\n    newFreeLength,\n    permanentSet,\n    permanentSetPercent,\n    newSpringRate: newRate,\n    springRateChange: changePercent,\n    residualPlasticStrain: plasticStrain,\n    scragStress,\n    yieldOccurred,\n    stabilizationAchieved,\n    recommendations,\n  };\n}\n\n/**\n * Simulate heat treatment effects\n */\nexport function simulateHeatTreatment(params: HeatTreatmentParams): HeatTreatmentResult {\n  const {\n    temperature,\n    soakTime,\n    coolingMethod,\n    materialId,\n  } = params;\n\n  // Get material properties\n  const material = getSpringMaterial(materialId);\n  const baseModulus = material?.elasticModulus ?? 207000;\n\n  // Modulus recovery based on temperature and time\n  // Higher temperature and longer time = more recovery\n  const tempFactor = Math.min(1.0, temperature / 350);\n  const timeFactor = Math.min(1.0, Math.log(soakTime + 1) / Math.log(5));\n  const modulusRecoveryFactor = 1 + 0.02 * tempFactor * timeFactor;\n\n  const newElasticModulus = baseModulus * modulusRecoveryFactor;\n\n  // Stress relief percentage\n  const stressReliefPercent = Math.min(95, 50 + 30 * tempFactor + 15 * timeFactor);\n\n  // Hardness change (slight decrease with stress relief)\n  const hardnessChange = -2 * tempFactor * timeFactor;\n\n  // Fatigue life improvement from stress relief\n  const fatigueLifeImprovement = 1 + 0.2 * (stressReliefPercent / 100);\n\n  // Dimensional stability improvement\n  const coolingFactors: Record<string, number> = {\n    furnace: 1.0,\n    air: 0.9,\n    oil: 0.8,\n    water: 0.7,\n  };\n  const dimensionalStabilityImprovement = 1 + 0.15 * tempFactor * (coolingFactors[coolingMethod] ?? 0.9);\n\n  // Recommendations\n  const recommendations: string[] = [];\n\n  if (temperature < 200) {\n    recommendations.push('Low treatment temperature - stress relief may be incomplete');\n  }\n\n  if (temperature > 400) {\n    recommendations.push('High temperature may affect material hardness and strength');\n  }\n\n  if (soakTime < 0.5) {\n    recommendations.push('Short soak time - consider extending for better stress relief');\n  }\n\n  if (coolingMethod === 'water' && temperature > 300) {\n    recommendations.push('Water quench from high temperature may cause distortion');\n  }\n\n  return {\n    modulusRecoveryFactor,\n    newElasticModulus,\n    stressReliefPercent,\n    hardnessChange,\n    fatigueLifeImprovement,\n    dimensionalStabilityImprovement,\n    recommendations,\n  };\n}\n\n/**\n * Combined springback model (scrag + heat treatment)\n */\nexport function calculateSpringbackModel(\n  scragParams: ScragTestParams,\n  heatTreatmentParams: HeatTreatmentParams\n): SpringbackModelResult {\n  // Run scrag test simulation\n  const scragResult = simulateScragTest(scragParams);\n\n  // Run heat treatment simulation\n  const heatTreatmentResult = simulateHeatTreatment(heatTreatmentParams);\n\n  // Final properties after both processes\n  // Heat treatment may cause slight additional relaxation\n  const heatTreatmentRelaxation = scragResult.permanentSet * 0.05 * (heatTreatmentParams.temperature / 300);\n  \n  const finalFreeLength = scragResult.newFreeLength - heatTreatmentRelaxation;\n  const finalSpringRate = scragResult.newSpringRate * heatTreatmentResult.modulusRecoveryFactor;\n  const totalPermanentSet = scragResult.permanentSet + heatTreatmentRelaxation;\n\n  // Calculate design compensation to achieve target after manufacturing\n  const designCompensation = {\n    freeLengthCompensation: totalPermanentSet * 1.1, // Add 10% margin\n    coilCompensation: totalPermanentSet / (scragParams.wireDiameter * 1.5), // Approximate coil adjustment\n    pitchCompensation: totalPermanentSet / scragParams.activeCoils,\n  };\n\n  return {\n    scragResult,\n    heatTreatmentResult,\n    finalFreeLength,\n    finalSpringRate,\n    totalPermanentSet,\n    designCompensation,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/shockFatigue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/shotPeening.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'baseEnduranceLimit' is defined but never used.","line":139,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":139,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Shot Peening Residual Stress Model - Phase 6\n * 喷丸残余应力模型\n * \n * Models residual compressive stress profile from shot peening process\n */\n\n/**\n * Shot peening parameters\n */\nexport interface ShotPeeningParams {\n  /** Peak compressive stress at surface (MPa) - typically 400-800 MPa */\n  peakStress: number;\n  /** Attenuation depth factor (mm) - typically 0.05-0.2 mm */\n  attenuationDepth: number;\n  /** Coverage percentage (%) */\n  coverage: number;\n  /** Shot diameter (mm) */\n  shotDiameter: number;\n  /** Almen intensity (A, N, or C scale) */\n  almenIntensity: string;\n  /** Wire diameter for depth calculation (mm) */\n  wireDiameter: number;\n}\n\n/**\n * Shot peening result\n */\nexport interface ShotPeeningResult {\n  /** Surface compressive stress (MPa) */\n  surfaceStress: number;\n  /** Stress profile vs depth */\n  stressProfile: {\n    depth: number;  // mm from surface\n    stress: number; // MPa (negative = compressive)\n  }[];\n  /** Effective depth of compressive layer (mm) */\n  effectiveDepth: number;\n  /** Fatigue endurance enhancement factor */\n  enduranceEnhancementFactor: number;\n  /** New endurance limit (MPa) */\n  newEnduranceLimit: number;\n  /** Corrected effective stress (MPa) */\n  correctedEffectiveStress: number;\n  /** Surface roughness increase factor */\n  roughnessIncreaseFactor: number;\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/**\n * Default shot peening parameters for different applications\n */\nexport const SHOT_PEENING_PRESETS: Record<string, Partial<ShotPeeningParams>> = {\n  light: {\n    peakStress: 400,\n    attenuationDepth: 0.05,\n    coverage: 100,\n    almenIntensity: '0.15A',\n  },\n  standard: {\n    peakStress: 600,\n    attenuationDepth: 0.1,\n    coverage: 200,\n    almenIntensity: '0.25A',\n  },\n  heavy: {\n    peakStress: 800,\n    attenuationDepth: 0.15,\n    coverage: 300,\n    almenIntensity: '0.35A',\n  },\n  aerospace: {\n    peakStress: 700,\n    attenuationDepth: 0.12,\n    coverage: 400,\n    almenIntensity: '0.30A',\n  },\n};\n\n/**\n * Calculate residual stress at depth z\n * τ_shot(z) = τ_peak * exp(-z / a)\n * \n * @param depth - Depth from surface (mm)\n * @param peakStress - Peak compressive stress at surface (MPa)\n * @param attenuationDepth - Attenuation depth factor (mm)\n * @returns Residual stress at depth (MPa, negative = compressive)\n */\nexport function calculateResidualStressAtDepth(\n  depth: number,\n  peakStress: number,\n  attenuationDepth: number\n): number {\n  if (depth < 0) return 0;\n  return -peakStress * Math.exp(-depth / attenuationDepth);\n}\n\n/**\n * Generate stress profile from surface to depth\n */\nexport function generateStressProfile(\n  peakStress: number,\n  attenuationDepth: number,\n  maxDepth: number,\n  numPoints: number = 50\n): { depth: number; stress: number }[] {\n  const profile: { depth: number; stress: number }[] = [];\n  \n  for (let i = 0; i < numPoints; i++) {\n    const depth = (i / (numPoints - 1)) * maxDepth;\n    const stress = calculateResidualStressAtDepth(depth, peakStress, attenuationDepth);\n    profile.push({ depth, stress });\n  }\n  \n  return profile;\n}\n\n/**\n * Calculate effective depth where compressive stress drops to 10% of peak\n */\nexport function calculateEffectiveDepth(\n  peakStress: number,\n  attenuationDepth: number,\n  threshold: number = 0.1\n): number {\n  // Solve: τ_peak * exp(-z/a) = threshold * τ_peak\n  // z = -a * ln(threshold)\n  return -attenuationDepth * Math.log(threshold);\n}\n\n/**\n * Calculate fatigue endurance enhancement factor\n * Based on empirical data from shot peening studies\n */\nexport function calculateEnduranceEnhancement(\n  peakStress: number,\n  coverage: number,\n  baseEnduranceLimit: number\n): number {\n  // Enhancement factor increases with peak stress and coverage\n  // Typical range: 1.1 to 1.5 (10% to 50% improvement)\n  const stressFactor = Math.min(1.0, peakStress / 800);\n  const coverageFactor = Math.min(1.0, coverage / 200);\n  \n  // Combined enhancement factor\n  const enhancement = 0.1 + 0.3 * stressFactor + 0.1 * coverageFactor;\n  \n  return 1 + enhancement;\n}\n\n/**\n * Calculate corrected effective stress with shot peening\n * τ_corrected = τ_effective - τ_shot(0)\n */\nexport function calculateCorrectedStress(\n  effectiveStress: number,\n  surfaceCompressiveStress: number\n): number {\n  // Surface compressive stress reduces effective tensile stress\n  return effectiveStress - Math.abs(surfaceCompressiveStress);\n}\n\n/**\n * Calculate surface roughness increase from shot peening\n */\nexport function calculateRoughnessIncrease(\n  shotDiameter: number,\n  almenIntensity: string\n): number {\n  // Parse Almen intensity (e.g., \"0.25A\" -> 0.25)\n  const intensityValue = parseFloat(almenIntensity) || 0.2;\n  \n  // Roughness increase factor (Ra increase)\n  // Larger shots and higher intensity = more roughness\n  const roughnessFactor = 1 + 0.5 * (shotDiameter / 0.5) * intensityValue;\n  \n  return Math.min(2.0, roughnessFactor);\n}\n\n/**\n * Main shot peening simulation\n */\nexport function simulateShotPeening(\n  params: ShotPeeningParams,\n  baseEnduranceLimit: number,\n  effectiveStress: number\n): ShotPeeningResult {\n  const {\n    peakStress,\n    attenuationDepth,\n    coverage,\n    shotDiameter,\n    almenIntensity,\n    wireDiameter,\n  } = params;\n\n  // Calculate surface stress\n  const surfaceStress = -peakStress; // Compressive = negative\n\n  // Generate stress profile (to 1/4 wire diameter depth)\n  const maxDepth = wireDiameter / 4;\n  const stressProfile = generateStressProfile(peakStress, attenuationDepth, maxDepth);\n\n  // Calculate effective depth\n  const effectiveDepth = calculateEffectiveDepth(peakStress, attenuationDepth);\n\n  // Calculate endurance enhancement\n  const enduranceEnhancementFactor = calculateEnduranceEnhancement(\n    peakStress,\n    coverage,\n    baseEnduranceLimit\n  );\n\n  // New endurance limit\n  const newEnduranceLimit = baseEnduranceLimit * enduranceEnhancementFactor;\n\n  // Corrected effective stress\n  const correctedEffectiveStress = calculateCorrectedStress(effectiveStress, peakStress);\n\n  // Surface roughness increase\n  const roughnessIncreaseFactor = calculateRoughnessIncrease(shotDiameter, almenIntensity);\n\n  // Generate recommendations\n  const recommendations: string[] = [];\n\n  if (effectiveDepth < wireDiameter * 0.05) {\n    recommendations.push('Consider increasing shot peening intensity for deeper compressive layer');\n  }\n\n  if (roughnessIncreaseFactor > 1.5) {\n    recommendations.push('High surface roughness - consider post-peening polishing for critical applications');\n  }\n\n  if (coverage < 100) {\n    recommendations.push('Coverage below 100% - ensure full surface treatment');\n  }\n\n  if (peakStress > 0.5 * baseEnduranceLimit) {\n    recommendations.push('Excellent compressive stress level for fatigue improvement');\n  }\n\n  return {\n    surfaceStress,\n    stressProfile,\n    effectiveDepth,\n    enduranceEnhancementFactor,\n    newEnduranceLimit,\n    correctedEffectiveStress,\n    roughnessIncreaseFactor,\n    recommendations,\n  };\n}\n\n/**\n * Combined stress analysis with shot peening\n */\nexport function analyzeStressWithShotPeening(\n  maxShearStress: number,\n  meanStress: number,\n  shotPeeningParams: ShotPeeningParams,\n  baseEnduranceLimit: number,\n  ultimateStrength: number\n): {\n  originalSafetyFactor: number;\n  improvedSafetyFactor: number;\n  fatigueLifeImprovement: number;\n  shotPeeningResult: ShotPeeningResult;\n} {\n  // Original Goodman safety factor\n  const originalSF = 1 / (maxShearStress / baseEnduranceLimit + meanStress / ultimateStrength);\n\n  // Simulate shot peening\n  const shotPeeningResult = simulateShotPeening(\n    shotPeeningParams,\n    baseEnduranceLimit,\n    maxShearStress\n  );\n\n  // Improved safety factor with shot peening\n  const improvedEndurance = shotPeeningResult.newEnduranceLimit;\n  const improvedStress = shotPeeningResult.correctedEffectiveStress;\n  const improvedMeanStress = meanStress - shotPeeningResult.surfaceStress * 0.3; // Partial mean stress reduction\n\n  const improvedSF = 1 / (\n    improvedStress / improvedEndurance + \n    Math.max(0, improvedMeanStress) / ultimateStrength\n  );\n\n  // Fatigue life improvement (approximate using S-N slope)\n  const fatigueLifeImprovement = Math.pow(improvedSF / originalSF, 5); // Typical S-N slope ~5\n\n  return {\n    originalSafetyFactor: originalSF,\n    improvedSafetyFactor: improvedSF,\n    fatigueLifeImprovement,\n    shotPeeningResult,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/standardsCheck.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/stress.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpringMaterialId' is defined but never used.","line":13,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Stress Module\n * 弹簧分析引擎 - 应力模块\n * \n * Calculates shear stress with Wahl correction for all spring types\n */\n\nimport type { SpringGeometry, StressResult } from './types';\nimport { \n  getSpringMaterial, \n  getSizeFactor, \n  getTemperatureFactor,\n  type SpringMaterialId \n} from '@/lib/materials/springMaterials';\n\nconst PI = Math.PI;\n\n/**\n * Calculate Wahl stress correction factor\n * 计算 Wahl 应力修正系数\n * \n * K_w = (4C - 1)/(4C - 4) + 0.615/C\n * \n * @param springIndex Spring index C = Dm/d\n * @returns Wahl factor\n */\nexport function calculateWahlFactor(springIndex: number): number {\n  if (springIndex <= 1) {\n    throw new Error('Spring index must be greater than 1');\n  }\n  return (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;\n}\n\n/**\n * Calculate Bergsträsser stress correction factor (alternative to Wahl)\n * 计算 Bergsträsser 应力修正系数\n * \n * K_B = (4C + 2)/(4C - 3)\n * \n * @param springIndex Spring index C = Dm/d\n * @returns Bergsträsser factor\n */\nexport function calculateBergstrasserFactor(springIndex: number): number {\n  if (springIndex <= 0.75) {\n    throw new Error('Spring index must be greater than 0.75');\n  }\n  return (4 * springIndex + 2) / (4 * springIndex - 3);\n}\n\n/**\n * Calculate nominal shear stress for helical spring\n * 计算螺旋弹簧的名义剪应力\n * \n * τ = (8 × F × Dm) / (π × d³)\n * \n * @param force Applied force (N)\n * @param meanDiameter Mean diameter Dm (mm)\n * @param wireDiameter Wire diameter d (mm)\n * @returns Nominal shear stress (MPa)\n */\nexport function calculateNominalShearStress(\n  force: number,\n  meanDiameter: number,\n  wireDiameter: number\n): number {\n  if (wireDiameter <= 0) {\n    throw new Error('Wire diameter must be positive');\n  }\n  return (8 * force * meanDiameter) / (PI * Math.pow(wireDiameter, 3));\n}\n\n/**\n * Calculate bending stress for torsion spring\n * 计算扭转弹簧的弯曲应力\n * \n * σ = (32 × M × Dm) / (π × d³)\n * \n * For round wire, using bending stress formula\n * \n * @param torque Applied torque M (N·mm)\n * @param meanDiameter Mean diameter Dm (mm)\n * @param wireDiameter Wire diameter d (mm)\n * @returns Bending stress (MPa)\n */\nexport function calculateBendingStress(\n  torque: number,\n  meanDiameter: number,\n  wireDiameter: number\n): number {\n  if (wireDiameter <= 0) {\n    throw new Error('Wire diameter must be positive');\n  }\n  // For torsion springs, the stress is primarily bending\n  // σ = 32M / (πd³) for round wire\n  // With curvature correction: K_i = (4C² - C - 1) / (4C(C - 1)) for inner fiber\n  const springIndex = meanDiameter / wireDiameter;\n  const Ki = (4 * springIndex * springIndex - springIndex - 1) / \n             (4 * springIndex * (springIndex - 1));\n  \n  const nominalBendingStress = (32 * torque) / (PI * Math.pow(wireDiameter, 3));\n  return Ki * nominalBendingStress;\n}\n\n/**\n * Calculate stress for conical spring at a specific coil\n * 计算锥形弹簧在特定线圈处的应力\n * \n * @param force Applied force (N)\n * @param localDiameter Local mean diameter at coil (mm)\n * @param wireDiameter Wire diameter d (mm)\n * @returns Shear stress at that coil (MPa)\n */\nexport function calculateConicalCoilStress(\n  force: number,\n  localDiameter: number,\n  wireDiameter: number\n): number {\n  const springIndex = localDiameter / wireDiameter;\n  const wahlFactor = calculateWahlFactor(springIndex);\n  const nominalStress = calculateNominalShearStress(force, localDiameter, wireDiameter);\n  return wahlFactor * nominalStress;\n}\n\n/**\n * Calculate complete stress result for a spring\n * 计算弹簧的完整应力结果\n */\nexport function calculateStress(\n  geometry: SpringGeometry,\n  force: number,\n  temperature: number = 20\n): StressResult {\n  const material = getSpringMaterial(geometry.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${geometry.materialId}`);\n  }\n\n  let meanDiameter: number;\n  let tauNominal: number;\n  let bendingStress: number | undefined;\n\n  // Calculate mean diameter based on spring type\n  if (geometry.type === 'conical') {\n    // For conical springs, use average mean diameter\n    const largeMean = geometry.largeOuterDiameter - geometry.wireDiameter;\n    const smallMean = geometry.smallOuterDiameter - geometry.wireDiameter;\n    meanDiameter = (largeMean + smallMean) / 2;\n    \n    // For stress calculation, use the large end (highest stress)\n    tauNominal = calculateNominalShearStress(force, largeMean, geometry.wireDiameter);\n  } else if (geometry.type === 'torsion') {\n    meanDiameter = geometry.meanDiameter;\n    // For torsion springs, force is actually torque\n    bendingStress = calculateBendingStress(force, meanDiameter, geometry.wireDiameter);\n    // Also calculate equivalent shear stress for comparison\n    tauNominal = bendingStress * 0.577; // von Mises conversion\n  } else {\n    meanDiameter = geometry.meanDiameter;\n    tauNominal = calculateNominalShearStress(force, meanDiameter, geometry.wireDiameter);\n  }\n\n  // Calculate spring index and Wahl factor\n  const springIndex = meanDiameter / geometry.wireDiameter;\n  const wahlFactor = calculateWahlFactor(springIndex);\n\n  // Get correction factors\n  const surfaceFactor = material.surfaceFactor ?? 1.0;\n  const sizeFactor = getSizeFactor(geometry.wireDiameter);\n  const tempFactor = getTemperatureFactor(temperature, geometry.materialId);\n\n  // Total correction factor\n  const totalCorrectionFactor = wahlFactor * surfaceFactor * sizeFactor * tempFactor;\n\n  // Effective stress\n  const tauEffective = tauNominal * totalCorrectionFactor;\n\n  return {\n    tauNominal,\n    wahlFactor,\n    surfaceFactor,\n    sizeFactor,\n    tempFactor,\n    totalCorrectionFactor,\n    tauEffective,\n    bendingStress,\n  };\n}\n\n/**\n * Calculate stress at minimum and maximum deflection\n * 计算最小和最大位移处的应力\n */\nexport function calculateStressRange(\n  geometry: SpringGeometry,\n  springRate: number,\n  minDeflection: number,\n  maxDeflection: number,\n  temperature: number = 20,\n  initialTension: number = 0\n): {\n  stressMin: StressResult;\n  stressMax: StressResult;\n  stressMean: number;\n  stressAmplitude: number;\n  stressRatio: number;\n} {\n  // Calculate forces\n  const forceMin = springRate * minDeflection + initialTension;\n  const forceMax = springRate * maxDeflection + initialTension;\n\n  // Calculate stresses\n  const stressMin = calculateStress(geometry, forceMin, temperature);\n  const stressMax = calculateStress(geometry, forceMax, temperature);\n\n  // Calculate mean and amplitude\n  const stressMean = (stressMax.tauEffective + stressMin.tauEffective) / 2;\n  const stressAmplitude = (stressMax.tauEffective - stressMin.tauEffective) / 2;\n  const stressRatio = stressMin.tauEffective / stressMax.tauEffective;\n\n  return {\n    stressMin,\n    stressMax,\n    stressMean,\n    stressAmplitude,\n    stressRatio,\n  };\n}\n\n/**\n * Calculate maximum stress for conical spring (at large end)\n * 计算锥形弹簧的最大应力（在大端）\n */\nexport function calculateConicalMaxStress(\n  geometry: SpringGeometry & { type: 'conical' },\n  force: number,\n  temperature: number = 20\n): StressResult {\n  const material = getSpringMaterial(geometry.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${geometry.materialId}`);\n  }\n\n  // Maximum stress occurs at the large end\n  const largeMeanDiameter = geometry.largeOuterDiameter - geometry.wireDiameter;\n  const tauNominal = calculateNominalShearStress(force, largeMeanDiameter, geometry.wireDiameter);\n\n  const springIndex = largeMeanDiameter / geometry.wireDiameter;\n  const wahlFactor = calculateWahlFactor(springIndex);\n\n  const surfaceFactor = material.surfaceFactor ?? 1.0;\n  const sizeFactor = getSizeFactor(geometry.wireDiameter);\n  const tempFactor = getTemperatureFactor(temperature, geometry.materialId);\n\n  const totalCorrectionFactor = wahlFactor * surfaceFactor * sizeFactor * tempFactor;\n  const tauEffective = tauNominal * totalCorrectionFactor;\n\n  return {\n    tauNominal,\n    wahlFactor,\n    surfaceFactor,\n    sizeFactor,\n    tempFactor,\n    totalCorrectionFactor,\n    tauEffective,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/stressDistribution.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'solidHeight' is assigned a value but never used.","line":160,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":160,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'theta' is assigned a value but never used.","line":373,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":373,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Spring Analysis Engine - Stress Distribution Model\n * 弹簧分析引擎 - 应力分布模型\n * \n * Computes local stress at multiple sample points along coil profile\n * for stress color mapping visualization\n */\n\nimport type { SpringGeometry, CompressionSpringGeometry, ConicalSpringGeometry, TorsionSpringGeometry, ExtensionSpringGeometry } from './types';\nimport { calculateWahlFactor } from './stress';\n\nconst PI = Math.PI;\n\n/**\n * Stress sample point\n */\nexport interface StressSamplePoint {\n  /** Angular position θ (radians) */\n  theta: number;\n  /** Coil number (0-indexed) */\n  coilNumber: number;\n  /** Local mean diameter at this point (mm) */\n  localDiameter: number;\n  /** Local wire diameter (mm) - usually constant */\n  localWireDiameter: number;\n  /** Local stress (MPa) */\n  localStress: number;\n  /** Normalized stress (0-1) */\n  normalizedStress: number;\n  /** Stress color category */\n  colorCategory: 'blue' | 'green' | 'yellow' | 'red';\n  /** RGB color values */\n  color: [number, number, number];\n  /** 3D position (x, y, z) */\n  position: [number, number, number];\n}\n\n/**\n * Stress distribution result\n */\nexport interface StressDistributionResult {\n  /** All sample points */\n  points: StressSamplePoint[];\n  /** Maximum local stress (MPa) */\n  maxStress: number;\n  /** Minimum local stress (MPa) */\n  minStress: number;\n  /** Average stress (MPa) */\n  avgStress: number;\n  /** Critical zone points (normalized > 0.9) */\n  criticalZoneCount: number;\n  /** Hot spot locations */\n  hotSpots: Array<{\n    theta: number;\n    coilNumber: number;\n    stress: number;\n    position: [number, number, number];\n  }>;\n}\n\n/**\n * Color mapping thresholds\n */\nexport const STRESS_COLOR_THRESHOLDS = {\n  BLUE_MAX: 0.4,\n  GREEN_MAX: 0.7,\n  YELLOW_MAX: 0.9,\n  // Above 0.9 is RED\n};\n\n/**\n * Get color for normalized stress value\n */\nexport function getStressColor(normalizedStress: number): {\n  category: 'blue' | 'green' | 'yellow' | 'red';\n  rgb: [number, number, number];\n} {\n  if (normalizedStress < STRESS_COLOR_THRESHOLDS.BLUE_MAX) {\n    // Blue: low stress\n    const t = normalizedStress / STRESS_COLOR_THRESHOLDS.BLUE_MAX;\n    return {\n      category: 'blue',\n      rgb: [0, t * 0.5, 1 - t * 0.3],\n    };\n  } else if (normalizedStress < STRESS_COLOR_THRESHOLDS.GREEN_MAX) {\n    // Green: moderate stress\n    const t = (normalizedStress - STRESS_COLOR_THRESHOLDS.BLUE_MAX) / \n              (STRESS_COLOR_THRESHOLDS.GREEN_MAX - STRESS_COLOR_THRESHOLDS.BLUE_MAX);\n    return {\n      category: 'green',\n      rgb: [t * 0.5, 0.8 - t * 0.2, 0.3 - t * 0.3],\n    };\n  } else if (normalizedStress < STRESS_COLOR_THRESHOLDS.YELLOW_MAX) {\n    // Yellow: elevated stress\n    const t = (normalizedStress - STRESS_COLOR_THRESHOLDS.GREEN_MAX) / \n              (STRESS_COLOR_THRESHOLDS.YELLOW_MAX - STRESS_COLOR_THRESHOLDS.GREEN_MAX);\n    return {\n      category: 'yellow',\n      rgb: [0.9 + t * 0.1, 0.8 - t * 0.4, 0],\n    };\n  } else {\n    // Red: critical stress\n    const t = Math.min(1, (normalizedStress - STRESS_COLOR_THRESHOLDS.YELLOW_MAX) / \n              (1 - STRESS_COLOR_THRESHOLDS.YELLOW_MAX));\n    return {\n      category: 'red',\n      rgb: [1, 0.4 - t * 0.4, 0],\n    };\n  }\n}\n\n/**\n * Calculate local stress for compression/extension spring\n * τ(θ) = K(θ) × (8 × F × D(θ)) / (π × d³)\n */\nexport function calculateLocalShearStress(\n  force: number,\n  localDiameter: number,\n  wireDiameter: number\n): number {\n  const C = localDiameter / wireDiameter;\n  const K = calculateWahlFactor(C);\n  return K * (8 * force * localDiameter) / (PI * Math.pow(wireDiameter, 3));\n}\n\n/**\n * Calculate local bending stress for torsion spring\n * σ(θ) = (32 × M × D(θ)) / (π × d³)\n */\nexport function calculateLocalBendingStress(\n  moment: number,\n  localDiameter: number,\n  wireDiameter: number\n): number {\n  const C = localDiameter / wireDiameter;\n  // Bending stress correction factor\n  const Ki = (4 * C * C - C - 1) / (4 * C * (C - 1));\n  return Ki * (32 * moment) / (PI * Math.pow(wireDiameter, 3));\n}\n\n/**\n * Calculate stress distribution for compression spring\n */\nexport function calculateCompressionStressDistribution(\n  geometry: CompressionSpringGeometry,\n  force: number,\n  deflection: number,\n  pointsPerCoil: number = 50\n): StressDistributionResult {\n  const { wireDiameter, meanDiameter, activeCoils, freeLength } = geometry;\n  const totalCoils = geometry.totalCoils ?? activeCoils + 2;\n  const deadCoils = totalCoils - activeCoils;\n  const deadCoilsBottom = deadCoils / 2;\n  const deadCoilsTop = deadCoils / 2;\n  \n  const totalPoints = Math.max(200, totalCoils * pointsPerCoil);\n  const points: StressSamplePoint[] = [];\n  \n  // Calculate solid height and current length\n  const solidHeight = totalCoils * wireDiameter;\n  const currentLength = freeLength - deflection;\n  const scale = 1;\n  \n  // First pass: calculate all local stresses to find max\n  const stressValues: number[] = [];\n  \n  for (let i = 0; i < totalPoints; i++) {\n    const t = i / totalPoints;\n    const theta = t * 2 * PI * totalCoils;\n    const coilNumber = theta / (2 * PI);\n    \n    // Determine if in active or dead coil region\n    const isDeadCoil = coilNumber < deadCoilsBottom || coilNumber > (totalCoils - deadCoilsTop);\n    \n    // Local diameter is constant for cylindrical spring\n    const localDiameter = meanDiameter;\n    \n    // Calculate local stress (dead coils have reduced stress)\n    let localStress: number;\n    if (isDeadCoil) {\n      // Dead coils carry less stress\n      localStress = calculateLocalShearStress(force * 0.3, localDiameter, wireDiameter);\n    } else {\n      localStress = calculateLocalShearStress(force, localDiameter, wireDiameter);\n    }\n    \n    stressValues.push(localStress);\n  }\n  \n  // Find max stress for normalization\n  const maxStress = Math.max(...stressValues);\n  const minStress = Math.min(...stressValues);\n  const avgStress = stressValues.reduce((a, b) => a + b, 0) / stressValues.length;\n  \n  // Second pass: create sample points with normalized values\n  const hotSpots: StressDistributionResult['hotSpots'] = [];\n  let criticalZoneCount = 0;\n  \n  for (let i = 0; i < totalPoints; i++) {\n    const t = i / totalPoints;\n    const theta = t * 2 * PI * totalCoils;\n    const coilNumber = theta / (2 * PI);\n    \n    const localStress = stressValues[i];\n    const normalizedStress = maxStress > 0 ? localStress / maxStress : 0;\n    \n    // Get color\n    const { category, rgb } = getStressColor(normalizedStress);\n    \n    // Calculate 3D position\n    const R = (meanDiameter / 2) * scale;\n    const x = R * Math.cos(theta);\n    const y = R * Math.sin(theta);\n    \n    // Z position based on pitch and deflection\n    const pitch = (currentLength - deadCoils * wireDiameter) / activeCoils;\n    const deadHeight = deadCoils * wireDiameter;\n    let z: number;\n    \n    if (coilNumber < deadCoilsBottom) {\n      z = coilNumber * wireDiameter;\n    } else if (coilNumber > totalCoils - deadCoilsTop) {\n      z = deadHeight + activeCoils * pitch + (coilNumber - totalCoils + deadCoilsTop) * wireDiameter;\n    } else {\n      z = deadCoilsBottom * wireDiameter + (coilNumber - deadCoilsBottom) * pitch;\n    }\n    \n    z *= scale;\n    \n    const point: StressSamplePoint = {\n      theta,\n      coilNumber,\n      localDiameter: meanDiameter,\n      localWireDiameter: wireDiameter,\n      localStress,\n      normalizedStress,\n      colorCategory: category,\n      color: rgb,\n      position: [x, y, z],\n    };\n    \n    points.push(point);\n    \n    // Track critical zones and hot spots\n    if (normalizedStress > 0.9) {\n      criticalZoneCount++;\n      if (normalizedStress > 0.95) {\n        hotSpots.push({\n          theta,\n          coilNumber,\n          stress: localStress,\n          position: [x, y, z],\n        });\n      }\n    }\n  }\n  \n  return {\n    points,\n    maxStress,\n    minStress,\n    avgStress,\n    criticalZoneCount,\n    hotSpots,\n  };\n}\n\n/**\n * Calculate stress distribution for conical spring\n * D varies with θ\n */\nexport function calculateConicalStressDistribution(\n  geometry: ConicalSpringGeometry,\n  force: number,\n  deflection: number,\n  pointsPerCoil: number = 50\n): StressDistributionResult {\n  const { wireDiameter, largeOuterDiameter, smallOuterDiameter, activeCoils, freeLength } = geometry;\n  const totalCoils = geometry.totalCoils ?? activeCoils + 2;\n  \n  const largeMeanDiameter = largeOuterDiameter - wireDiameter;\n  const smallMeanDiameter = smallOuterDiameter - wireDiameter;\n  \n  const totalPoints = Math.max(200, totalCoils * pointsPerCoil);\n  const points: StressSamplePoint[] = [];\n  const stressValues: number[] = [];\n  \n  // First pass: calculate stresses\n  for (let i = 0; i < totalPoints; i++) {\n    const t = i / totalPoints;\n    const theta = t * 2 * PI * totalCoils;\n    const coilNumber = theta / (2 * PI);\n    \n    // Linear interpolation of diameter along coil\n    const coilProgress = coilNumber / totalCoils;\n    const localDiameter = largeMeanDiameter - (largeMeanDiameter - smallMeanDiameter) * coilProgress;\n    \n    // Calculate local stress\n    const localStress = calculateLocalShearStress(force, localDiameter, wireDiameter);\n    stressValues.push(localStress);\n  }\n  \n  const maxStress = Math.max(...stressValues);\n  const minStress = Math.min(...stressValues);\n  const avgStress = stressValues.reduce((a, b) => a + b, 0) / stressValues.length;\n  \n  // Second pass: create points\n  const hotSpots: StressDistributionResult['hotSpots'] = [];\n  let criticalZoneCount = 0;\n  const currentLength = freeLength - deflection;\n  const scale = 1;\n  \n  for (let i = 0; i < totalPoints; i++) {\n    const t = i / totalPoints;\n    const theta = t * 2 * PI * totalCoils;\n    const coilNumber = theta / (2 * PI);\n    const coilProgress = coilNumber / totalCoils;\n    \n    const localDiameter = largeMeanDiameter - (largeMeanDiameter - smallMeanDiameter) * coilProgress;\n    const localStress = stressValues[i];\n    const normalizedStress = maxStress > 0 ? localStress / maxStress : 0;\n    \n    const { category, rgb } = getStressColor(normalizedStress);\n    \n    // 3D position for conical spring\n    const R = (localDiameter / 2) * scale;\n    const x = R * Math.cos(theta);\n    const y = R * Math.sin(theta);\n    const z = (currentLength * coilProgress) * scale;\n    \n    points.push({\n      theta,\n      coilNumber,\n      localDiameter,\n      localWireDiameter: wireDiameter,\n      localStress,\n      normalizedStress,\n      colorCategory: category,\n      color: rgb,\n      position: [x, y, z],\n    });\n    \n    if (normalizedStress > 0.9) {\n      criticalZoneCount++;\n      if (normalizedStress > 0.95) {\n        hotSpots.push({ theta, coilNumber, stress: localStress, position: [x, y, z] });\n      }\n    }\n  }\n  \n  return { points, maxStress, minStress, avgStress, criticalZoneCount, hotSpots };\n}\n\n/**\n * Calculate stress distribution for torsion spring\n */\nexport function calculateTorsionStressDistribution(\n  geometry: TorsionSpringGeometry,\n  moment: number,\n  angularDeflection: number,\n  pointsPerCoil: number = 50\n): StressDistributionResult {\n  const { wireDiameter, meanDiameter, activeCoils, bodyLength } = geometry;\n  const totalCoils = activeCoils;\n  \n  const totalPoints = Math.max(200, totalCoils * pointsPerCoil);\n  const points: StressSamplePoint[] = [];\n  const stressValues: number[] = [];\n  \n  // First pass\n  for (let i = 0; i < totalPoints; i++) {\n    const t = i / totalPoints;\n    const theta = t * 2 * PI * totalCoils;\n    \n    const localStress = calculateLocalBendingStress(moment, meanDiameter, wireDiameter);\n    stressValues.push(localStress);\n  }\n  \n  const maxStress = Math.max(...stressValues);\n  const minStress = Math.min(...stressValues);\n  const avgStress = stressValues.reduce((a, b) => a + b, 0) / stressValues.length;\n  \n  // Second pass\n  const hotSpots: StressDistributionResult['hotSpots'] = [];\n  let criticalZoneCount = 0;\n  const scale = 1;\n  \n  for (let i = 0; i < totalPoints; i++) {\n    const t = i / totalPoints;\n    const theta = t * 2 * PI * totalCoils;\n    const coilNumber = theta / (2 * PI);\n    \n    const localStress = stressValues[i];\n    const normalizedStress = maxStress > 0 ? localStress / maxStress : 0;\n    const { category, rgb } = getStressColor(normalizedStress);\n    \n    const R = (meanDiameter / 2) * scale;\n    const x = R * Math.cos(theta);\n    const y = R * Math.sin(theta);\n    const z = (bodyLength * t) * scale;\n    \n    points.push({\n      theta,\n      coilNumber,\n      localDiameter: meanDiameter,\n      localWireDiameter: wireDiameter,\n      localStress,\n      normalizedStress,\n      colorCategory: category,\n      color: rgb,\n      position: [x, y, z],\n    });\n    \n    if (normalizedStress > 0.9) {\n      criticalZoneCount++;\n      if (normalizedStress > 0.95) {\n        hotSpots.push({ theta, coilNumber, stress: localStress, position: [x, y, z] });\n      }\n    }\n  }\n  \n  return { points, maxStress, minStress, avgStress, criticalZoneCount, hotSpots };\n}\n\n/**\n * Calculate stress distribution for extension spring\n */\nexport function calculateExtensionStressDistribution(\n  geometry: ExtensionSpringGeometry,\n  force: number,\n  deflection: number,\n  pointsPerCoil: number = 50\n): StressDistributionResult {\n  const { wireDiameter, meanDiameter, activeCoils, bodyLength } = geometry;\n  const totalCoils = activeCoils;\n  \n  const totalPoints = Math.max(200, totalCoils * pointsPerCoil);\n  const points: StressSamplePoint[] = [];\n  const stressValues: number[] = [];\n  \n  // First pass\n  for (let i = 0; i < totalPoints; i++) {\n    const t = i / totalPoints;\n    const theta = t * 2 * PI * totalCoils;\n    const coilNumber = theta / (2 * PI);\n    \n    // Hook regions have higher stress concentration\n    const isNearHook = coilNumber < 0.5 || coilNumber > totalCoils - 0.5;\n    const stressMultiplier = isNearHook ? 1.3 : 1.0;\n    \n    const localStress = calculateLocalShearStress(force, meanDiameter, wireDiameter) * stressMultiplier;\n    stressValues.push(localStress);\n  }\n  \n  const maxStress = Math.max(...stressValues);\n  const minStress = Math.min(...stressValues);\n  const avgStress = stressValues.reduce((a, b) => a + b, 0) / stressValues.length;\n  \n  // Second pass\n  const hotSpots: StressDistributionResult['hotSpots'] = [];\n  let criticalZoneCount = 0;\n  const scale = 1;\n  const currentLength = bodyLength + deflection;\n  \n  for (let i = 0; i < totalPoints; i++) {\n    const t = i / totalPoints;\n    const theta = t * 2 * PI * totalCoils;\n    const coilNumber = theta / (2 * PI);\n    \n    const localStress = stressValues[i];\n    const normalizedStress = maxStress > 0 ? localStress / maxStress : 0;\n    const { category, rgb } = getStressColor(normalizedStress);\n    \n    const R = (meanDiameter / 2) * scale;\n    const x = R * Math.cos(theta);\n    const y = R * Math.sin(theta);\n    const z = (currentLength * t) * scale;\n    \n    points.push({\n      theta,\n      coilNumber,\n      localDiameter: meanDiameter,\n      localWireDiameter: wireDiameter,\n      localStress,\n      normalizedStress,\n      colorCategory: category,\n      color: rgb,\n      position: [x, y, z],\n    });\n    \n    if (normalizedStress > 0.9) {\n      criticalZoneCount++;\n      if (normalizedStress > 0.95) {\n        hotSpots.push({ theta, coilNumber, stress: localStress, position: [x, y, z] });\n      }\n    }\n  }\n  \n  return { points, maxStress, minStress, avgStress, criticalZoneCount, hotSpots };\n}\n\n/**\n * Calculate stress distribution for any spring type\n */\nexport function calculateStressDistribution(\n  geometry: SpringGeometry,\n  force: number,\n  deflection: number,\n  pointsPerCoil: number = 50\n): StressDistributionResult {\n  switch (geometry.type) {\n    case 'compression':\n      return calculateCompressionStressDistribution(\n        geometry as CompressionSpringGeometry,\n        force,\n        deflection,\n        pointsPerCoil\n      );\n    case 'conical':\n      return calculateConicalStressDistribution(\n        geometry as ConicalSpringGeometry,\n        force,\n        deflection,\n        pointsPerCoil\n      );\n    case 'torsion':\n      return calculateTorsionStressDistribution(\n        geometry as TorsionSpringGeometry,\n        force, // This is actually moment for torsion\n        deflection, // This is angular deflection\n        pointsPerCoil\n      );\n    case 'extension':\n      return calculateExtensionStressDistribution(\n        geometry as ExtensionSpringGeometry,\n        force,\n        deflection,\n        pointsPerCoil\n      );\n    default:\n      throw new Error(`Unknown spring type: ${(geometry as SpringGeometry).type}`);\n  }\n}\n\n/**\n * Generate vertex colors array for Three.js geometry\n */\nexport function generateVertexColors(\n  stressDistribution: StressDistributionResult\n): Float32Array {\n  const colors = new Float32Array(stressDistribution.points.length * 3);\n  \n  for (let i = 0; i < stressDistribution.points.length; i++) {\n    const point = stressDistribution.points[i];\n    colors[i * 3] = point.color[0];\n    colors[i * 3 + 1] = point.color[1];\n    colors[i * 3 + 2] = point.color[2];\n  }\n  \n  return colors;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/temperature.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/thermalEffects.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/topologyOptimizer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/torsionAdvancedAnalysis.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'material' is assigned a value but never used.","line":330,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":330,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'allowableStress' is assigned a value but never used.","line":382,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":382,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Torsion Spring Advanced Analysis Engine\n * 扭簧高级分析引擎\n * \n * Provides engineering calculations specific to torsion springs:\n * - Mass calculation (including legs)\n * - Natural frequency\n * - Stress distribution\n * - Fatigue analysis\n * - Dynamic analysis\n */\n\nimport { getSpringMaterial, type SpringMaterialId } from '@/lib/materials/springMaterials';\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface TorsionSpringParams {\n  /** Wire diameter d (mm) */\n  wireDiameter: number;\n  /** Mean diameter Dm (mm) */\n  meanDiameter: number;\n  /** Active coils Na */\n  activeCoils: number;\n  /** Body length Lb (mm) */\n  bodyLength: number;\n  /** Leg 1 length (mm) */\n  legLength1: number;\n  /** Leg 2 length (mm) */\n  legLength2: number;\n  /** Free angle between legs (degrees) */\n  freeAngle: number;\n  /** Working angle (degrees) */\n  workingAngle: number;\n  /** Material ID */\n  materialId: SpringMaterialId;\n}\n\nexport interface TorsionMassResult {\n  /** Total spring mass (g) */\n  totalMass: number;\n  /** Coil body mass (g) */\n  bodyMass: number;\n  /** Leg 1 mass (g) */\n  leg1Mass: number;\n  /** Leg 2 mass (g) */\n  leg2Mass: number;\n  /** Total wire length (mm) */\n  totalWireLength: number;\n}\n\nexport interface TorsionFrequencyResult {\n  /** Natural frequency (Hz) */\n  naturalFrequency: number;\n  /** Angular natural frequency (rad/s) */\n  angularFrequency: number;\n  /** Moment of inertia (kg·mm²) */\n  momentOfInertia: number;\n  /** Torsional stiffness (N·mm/rad) */\n  torsionalStiffness: number;\n  /** Shock wave velocity (m/s) */\n  shockWaveVelocity: number;\n}\n\nexport interface TorsionStressPoint {\n  /** Angular position (degrees) */\n  theta: number;\n  /** Coil number (0-based, fractional) */\n  coilNumber: number;\n  /** Bending stress at this point (MPa) */\n  bendingStress: number;\n  /** Stress ratio (stress / allowable) */\n  stressRatio: number;\n  /** Is this a hotspot? */\n  isHotspot: boolean;\n}\n\nexport interface TorsionStressDistribution {\n  /** Stress points along the spring */\n  points: TorsionStressPoint[];\n  /** Maximum stress (MPa) */\n  maxStress: number;\n  /** Average stress (MPa) */\n  avgStress: number;\n  /** Minimum stress (MPa) */\n  minStress: number;\n  /** Number of critical regions (>90% of allowable) */\n  criticalRegions: number;\n  /** Number of hotspots */\n  hotspotCount: number;\n  /** Stress correction factor Ki */\n  stressCorrectionFactor: number;\n}\n\nexport interface TorsionDynamicResult {\n  /** Temperature effect on modulus (%) */\n  temperatureEffect: number;\n  /** Creep factor */\n  creepFactor: number;\n  /** Environmental rating */\n  environmentalRating: 'PASS' | 'CAUTION' | 'FAIL';\n  /** Risk level */\n  riskLevel: 'LOW RISK' | 'MEDIUM RISK' | 'HIGH RISK';\n}\n\nexport interface TorsionFatigueResult {\n  /** Estimated fatigue life (cycles) */\n  estimatedLife: number;\n  /** Safety factor */\n  safetyFactor: number;\n  /** Safety factor percentage */\n  safetyFactorPercent: number;\n  /** Mean stress (MPa) */\n  meanStress: number;\n  /** Alternating stress (MPa) */\n  alternatingStress: number;\n  /** Is within safe limits */\n  isValid: boolean;\n}\n\nexport interface TorsionAdvancedAnalysisResult {\n  mass: TorsionMassResult;\n  frequency: TorsionFrequencyResult;\n  stressDistribution: TorsionStressDistribution;\n  dynamic: TorsionDynamicResult;\n  fatigue: TorsionFatigueResult;\n  /** Overall pass/fail status */\n  overallStatus: 'PASS' | 'CAUTION' | 'FAIL';\n}\n\n// ============================================================================\n// Mass Calculation\n// ============================================================================\n\n/**\n * Calculate torsion spring mass including legs\n * 计算扭簧质量（包括腿）\n */\nexport function calculateTorsionMass(params: TorsionSpringParams): TorsionMassResult {\n  const { wireDiameter, meanDiameter, activeCoils, legLength1, legLength2, materialId } = params;\n  \n  const material = getSpringMaterial(materialId);\n  const density = material?.density || 7850; // kg/m³\n  \n  // Wire cross-section area (mm²)\n  const wireArea = Math.PI * Math.pow(wireDiameter / 2, 2);\n  \n  // Coil body wire length (mm)\n  // L_coil = π × Dm × Na\n  const coilWireLength = Math.PI * meanDiameter * activeCoils;\n  \n  // Total wire length including legs\n  const totalWireLength = coilWireLength + legLength1 + legLength2;\n  \n  // Volume (mm³)\n  const coilVolume = wireArea * coilWireLength;\n  const leg1Volume = wireArea * legLength1;\n  const leg2Volume = wireArea * legLength2;\n  const totalVolume = wireArea * totalWireLength;\n  \n  // Mass (g) - density is kg/m³, volume is mm³\n  // 1 kg/m³ = 1e-9 kg/mm³ = 1e-6 g/mm³\n  const densityGPerMm3 = density * 1e-6;\n  \n  return {\n    totalMass: totalVolume * densityGPerMm3,\n    bodyMass: coilVolume * densityGPerMm3,\n    leg1Mass: leg1Volume * densityGPerMm3,\n    leg2Mass: leg2Volume * densityGPerMm3,\n    totalWireLength,\n  };\n}\n\n// ============================================================================\n// Natural Frequency Calculation\n// ============================================================================\n\n/**\n * Calculate torsion spring natural frequency\n * 计算扭簧固有频率\n * \n * For torsion springs:\n * fn = (1/2π) × √(k_θ / J)\n * \n * where:\n * k_θ = torsional stiffness (N·mm/rad)\n * J = moment of inertia of the rotating mass\n */\nexport function calculateTorsionFrequency(params: TorsionSpringParams): TorsionFrequencyResult {\n  const { wireDiameter, meanDiameter, activeCoils, legLength1, legLength2, materialId } = params;\n  \n  const material = getSpringMaterial(materialId);\n  const E = material?.elasticModulus || 206000; // MPa (N/mm²)\n  const G = material?.shearModulus || 79300; // MPa\n  const density = material?.density || 7850; // kg/m³\n  \n  // Spring rate (N·mm/rad) - 标准公式\n  // k_rad = E × d⁴ / (10.8 × Dm × Na)\n  // 来源: SMI Handbook, DIN EN 13906-3\n  const springRatePerRad = (E * Math.pow(wireDiameter, 4)) / (10.8 * meanDiameter * activeCoils);\n  \n  // Calculate moment of inertia of the legs (simplified as rods rotating about one end)\n  // J = (1/3) × m × L² for a rod rotating about one end\n  const wireArea = Math.PI * Math.pow(wireDiameter / 2, 2); // mm²\n  const densityKgPerMm3 = density * 1e-9;\n  \n  const leg1Mass = wireArea * legLength1 * densityKgPerMm3; // kg\n  const leg2Mass = wireArea * legLength2 * densityKgPerMm3; // kg\n  \n  // Moment of inertia (kg·mm²)\n  const J1 = (1/3) * leg1Mass * Math.pow(legLength1, 2);\n  const J2 = (1/3) * leg2Mass * Math.pow(legLength2, 2);\n  const totalJ = J1 + J2;\n  \n  // Natural frequency\n  // ω = √(k/J), f = ω/(2π)\n  const angularFrequency = Math.sqrt(springRatePerRad / (totalJ > 0 ? totalJ : 1e-6));\n  const naturalFrequency = angularFrequency / (2 * Math.PI);\n  \n  // Shock wave velocity in wire\n  // v = √(G/ρ)\n  const shockWaveVelocity = Math.sqrt((G * 1e6) / density); // m/s\n  \n  return {\n    naturalFrequency,\n    angularFrequency,\n    momentOfInertia: totalJ * 1e6, // Convert to kg·mm²\n    torsionalStiffness: springRatePerRad,\n    shockWaveVelocity,\n  };\n}\n\n// ============================================================================\n// Stress Distribution Calculation\n// ============================================================================\n\n/**\n * Calculate stress distribution along torsion spring\n * 计算扭簧应力分布\n */\nexport function calculateTorsionStressDistribution(\n  params: TorsionSpringParams,\n  torque: number // N·mm\n): TorsionStressDistribution {\n  const { wireDiameter, meanDiameter, activeCoils, materialId } = params;\n  \n  const material = getSpringMaterial(materialId);\n  const allowableStress = material?.tensileStrength ? material.tensileStrength * 0.7 : 1200; // MPa\n  \n  // Spring index\n  const C = meanDiameter / wireDiameter;\n  \n  // Stress correction factor for inner fiber (Wahl factor for bending)\n  // Ki = (4C² - C - 1) / (4C(C - 1))\n  const Ki = (4 * C * C - C - 1) / (4 * C * (C - 1));\n  \n  // Base bending stress\n  // σ = 32 × M / (π × d³)\n  const baseBendingStress = (32 * torque) / (Math.PI * Math.pow(wireDiameter, 3));\n  \n  // Corrected stress\n  const correctedStress = baseBendingStress * Ki;\n  \n  // Generate stress points along the spring\n  const numPoints = Math.ceil(activeCoils * 36); // 36 points per coil (every 10°)\n  const points: TorsionStressPoint[] = [];\n  \n  let maxStress = 0;\n  let minStress = Infinity;\n  let totalStress = 0;\n  let criticalCount = 0;\n  let hotspotCount = 0;\n  \n  for (let i = 0; i <= numPoints; i++) {\n    const t = i / numPoints;\n    const theta = t * 360 * activeCoils;\n    const coilNumber = t * activeCoils;\n    \n    // Stress varies slightly along the coil due to friction and contact\n    // Simplified model: stress is highest at the inner diameter\n    // Add small variation based on position\n    const positionFactor = 1 + 0.02 * Math.sin(theta * Math.PI / 180);\n    const stress = correctedStress * positionFactor;\n    \n    const stressRatio = stress / allowableStress;\n    const isHotspot = stressRatio > 0.9;\n    \n    if (isHotspot) hotspotCount++;\n    if (stressRatio > 0.9) criticalCount++;\n    \n    maxStress = Math.max(maxStress, stress);\n    minStress = Math.min(minStress, stress);\n    totalStress += stress;\n    \n    points.push({\n      theta: theta % 360,\n      coilNumber,\n      bendingStress: stress,\n      stressRatio,\n      isHotspot,\n    });\n  }\n  \n  return {\n    points,\n    maxStress,\n    avgStress: totalStress / points.length,\n    minStress,\n    criticalRegions: criticalCount,\n    hotspotCount,\n    stressCorrectionFactor: Ki,\n  };\n}\n\n// ============================================================================\n// Dynamic Analysis\n// ============================================================================\n\n/**\n * Perform dynamic analysis for torsion spring\n * 扭簧动力学分析\n */\nexport function analyzeTorsionDynamics(\n  params: TorsionSpringParams,\n  operatingTemperature: number = 20 // °C\n): TorsionDynamicResult {\n  const { materialId } = params;\n  \n  const material = getSpringMaterial(materialId);\n  \n  // Temperature effect on elastic modulus\n  // Approximately -0.03% per °C above 20°C\n  const tempDiff = operatingTemperature - 20;\n  const temperatureEffect = tempDiff * 0.03;\n  \n  // Creep factor (simplified)\n  // Higher temperature = more creep\n  const creepFactor = 1 + Math.max(0, tempDiff) * 0.001;\n  \n  // Environmental rating\n  let environmentalRating: 'PASS' | 'CAUTION' | 'FAIL' = 'PASS';\n  if (operatingTemperature > 150) {\n    environmentalRating = 'FAIL';\n  } else if (operatingTemperature > 100) {\n    environmentalRating = 'CAUTION';\n  }\n  \n  // Risk level based on material and temperature\n  let riskLevel: 'LOW RISK' | 'MEDIUM RISK' | 'HIGH RISK' = 'LOW RISK';\n  if (environmentalRating === 'FAIL') {\n    riskLevel = 'HIGH RISK';\n  } else if (environmentalRating === 'CAUTION') {\n    riskLevel = 'MEDIUM RISK';\n  }\n  \n  return {\n    temperatureEffect,\n    creepFactor,\n    environmentalRating,\n    riskLevel,\n  };\n}\n\n// ============================================================================\n// Fatigue Analysis\n// ============================================================================\n\n/**\n * Calculate fatigue life for torsion spring\n * 扭簧疲劳寿命计算\n */\nexport function calculateTorsionFatigue(\n  params: TorsionSpringParams,\n  installTorque: number, // N·mm at install angle\n  workingTorque: number  // N·mm at working angle\n): TorsionFatigueResult {\n  const { wireDiameter, meanDiameter, materialId } = params;\n  \n  const material = getSpringMaterial(materialId);\n  const tensileStrength = material?.tensileStrength || 1700; // MPa\n  const allowableStress = tensileStrength * 0.7;\n  \n  // Spring index\n  const C = meanDiameter / wireDiameter;\n  const Ki = (4 * C * C - C - 1) / (4 * C * (C - 1));\n  \n  // Calculate stresses\n  const stressAtInstall = (32 * installTorque * Ki) / (Math.PI * Math.pow(wireDiameter, 3));\n  const stressAtWorking = (32 * workingTorque * Ki) / (Math.PI * Math.pow(wireDiameter, 3));\n  \n  // Mean and alternating stress\n  const meanStress = (stressAtInstall + stressAtWorking) / 2;\n  const alternatingStress = Math.abs(stressAtWorking - stressAtInstall) / 2;\n  \n  // Goodman diagram approach for fatigue\n  // Se = endurance limit ≈ 0.5 × tensile strength for steel\n  const enduranceLimit = tensileStrength * 0.5;\n  \n  // Modified Goodman equation\n  // σa/Se + σm/Su = 1/SF\n  // SF = 1 / (σa/Se + σm/Su)\n  const safetyFactor = 1 / ((alternatingStress / enduranceLimit) + (meanStress / tensileStrength));\n  \n  // Estimate fatigue life using S-N curve approximation\n  // N = (Se/σa)^b where b ≈ 6-10 for steel\n  const b = 8;\n  let estimatedLife: number;\n  \n  if (alternatingStress < enduranceLimit * 0.5) {\n    estimatedLife = 1e9; // Infinite life\n  } else {\n    estimatedLife = Math.pow(enduranceLimit / alternatingStress, b) * 1e6;\n  }\n  \n  // Cap at 1e9\n  estimatedLife = Math.min(estimatedLife, 1e9);\n  \n  return {\n    estimatedLife,\n    safetyFactor,\n    safetyFactorPercent: safetyFactor * 100,\n    meanStress,\n    alternatingStress,\n    isValid: safetyFactor >= 1.0,\n  };\n}\n\n// ============================================================================\n// Complete Advanced Analysis\n// ============================================================================\n\n/**\n * Run complete advanced analysis for torsion spring\n * 运行扭簧完整高级分析\n */\nexport function runTorsionAdvancedAnalysis(\n  params: TorsionSpringParams,\n  operatingTemperature: number = 20\n): TorsionAdvancedAnalysisResult {\n  const { wireDiameter, meanDiameter, activeCoils, freeAngle, workingAngle, materialId } = params;\n  \n  const material = getSpringMaterial(materialId);\n  const E = material?.elasticModulus || 206000;\n  \n  // Calculate spring rate\n  const springRate = (E * Math.pow(wireDiameter, 4)) / (64 * meanDiameter * activeCoils);\n  \n  // Calculate torques\n  const installAngle = freeAngle > 0 ? freeAngle * 0.1 : 10; // 10% of free angle as install\n  const installTorque = springRate * installAngle;\n  const workingTorque = springRate * workingAngle;\n  \n  // Run all analyses\n  const mass = calculateTorsionMass(params);\n  const frequency = calculateTorsionFrequency(params);\n  const stressDistribution = calculateTorsionStressDistribution(params, workingTorque);\n  const dynamic = analyzeTorsionDynamics(params, operatingTemperature);\n  const fatigue = calculateTorsionFatigue(params, installTorque, workingTorque);\n  \n  // Determine overall status\n  let overallStatus: 'PASS' | 'CAUTION' | 'FAIL' = 'PASS';\n  \n  if (!fatigue.isValid || dynamic.environmentalRating === 'FAIL') {\n    overallStatus = 'FAIL';\n  } else if (fatigue.safetyFactor < 1.5 || dynamic.environmentalRating === 'CAUTION') {\n    overallStatus = 'CAUTION';\n  }\n  \n  return {\n    mass,\n    frequency,\n    stressDistribution,\n    dynamic,\n    fatigue,\n    overallStatus,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/torsionArm.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/verdict.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engine/wireGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engineering/dieSpring/analysis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engineering/dieSpring/catalog.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engineering/dieSpring/materialAdapter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engines/__tests__/spiralTorsionSpringEngine.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/engines/spiralTorsionSpringEngine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/fea/feaCalculator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/fea/feaTypes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/geometry/conicalSpringCurve.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/liveRiskBrain/__tests__/engine.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/liveRiskBrain/correlation.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'radarScore' is assigned a value but never used.","line":18,"column":33,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { MachineCard } from \"@/lib/production/types\";\nimport { PRODUCTION_CONFIG } from \"@/lib/production/config\";\nimport type { Driver, BilingualText, LiveRiskStatus } from \"./types\";\n\nexport type CorrelationInput = {\n  machine: MachineCard;\n  radarStatus?: \"ENGINEERING_OK\" | \"MANUFACTURING_RISK\" | \"HIGH_RISK\";\n  radarScore?: number;\n};\n\nexport type CorrelationResult = {\n  liveRiskStatus: LiveRiskStatus;\n  liveRiskScore: number;\n  drivers: Driver[];\n};\n\nexport function correlate(input: CorrelationInput): CorrelationResult {\n  const { machine, radarStatus, radarScore } = input;\n  const drivers: Driver[] = [];\n  let score = 100;\n\n  if (machine.status === \"ALARM\") {\n    score -= 35;\n    drivers.push({\n      dimension: \"manufacturing\",\n      title: bt(\"Machine in ALARM state\", \"机台处于报警状态\"),\n      confidence: 1.0,\n      evidence: { metricRefs: [\"status\"] },\n      recommendedActions: [bt(\"Investigate alarm cause immediately\", \"立即排查报警原因\")],\n    });\n  }\n\n  if (machine.lastCpk !== null && machine.lastCpk < PRODUCTION_CONFIG.cpkHighThreshold) {\n    score -= 30;\n    drivers.push({\n      dimension: \"quality\",\n      title: bt(`Cpk critically low (${machine.lastCpk.toFixed(2)})`, `Cpk 严重偏低 (${machine.lastCpk.toFixed(2)})`),\n      confidence: 0.95,\n      evidence: { metricRefs: [\"lastCpk\"] },\n      recommendedActions: [\n        bt(\"Review process parameters\", \"复核工艺参数\"),\n        bt(\"Increase inspection frequency\", \"加大检验频次\"),\n      ],\n    });\n  } else if (machine.lastCpk !== null && machine.lastCpk < PRODUCTION_CONFIG.cpkWarnThreshold) {\n    score -= 12;\n    drivers.push({\n      dimension: \"quality\",\n      title: bt(`Cpk below target (${machine.lastCpk.toFixed(2)})`, `Cpk 低于目标 (${machine.lastCpk.toFixed(2)})`),\n      confidence: 0.8,\n      evidence: { metricRefs: [\"lastCpk\"] },\n      recommendedActions: [bt(\"Monitor trend closely\", \"密切关注趋势\")],\n    });\n  }\n\n  if (machine.lastNelsonViolations >= PRODUCTION_CONFIG.nelsonViolationsHighThreshold) {\n    score -= 25;\n    drivers.push({\n      dimension: \"quality\",\n      title: bt(`Multiple Nelson rule violations (${machine.lastNelsonViolations})`, `多项 Nelson 规则违反 (${machine.lastNelsonViolations})`),\n      confidence: 0.9,\n      evidence: { metricRefs: [\"lastNelsonViolations\"] },\n      recommendedActions: [bt(\"Investigate special cause variation\", \"排查特殊原因变异\")],\n    });\n  } else if (machine.lastNelsonViolations >= PRODUCTION_CONFIG.nelsonViolationsWarnThreshold) {\n    score -= 10;\n    drivers.push({\n      dimension: \"quality\",\n      title: bt(`Nelson rule violation detected`, `检测到 Nelson 规则违反`),\n      confidence: 0.75,\n      evidence: { metricRefs: [\"lastNelsonViolations\"] },\n      recommendedActions: [bt(\"Review control chart\", \"复核控制图\")],\n    });\n  }\n\n  if (machine.scrapRate > PRODUCTION_CONFIG.scrapRateHighThreshold) {\n    score -= 15;\n    drivers.push({\n      dimension: \"manufacturing\",\n      title: bt(`High scrap rate (${(machine.scrapRate * 100).toFixed(1)}%)`, `高报废率 (${(machine.scrapRate * 100).toFixed(1)}%)`),\n      confidence: 0.85,\n      evidence: { metricRefs: [\"scrapRate\"] },\n      recommendedActions: [bt(\"Analyze defect patterns\", \"分析缺陷模式\")],\n    });\n  } else if (machine.scrapRate > PRODUCTION_CONFIG.scrapRateWarnThreshold) {\n    score -= 7;\n    drivers.push({\n      dimension: \"manufacturing\",\n      title: bt(`Elevated scrap rate`, `报废率偏高`),\n      confidence: 0.7,\n      evidence: { metricRefs: [\"scrapRate\"] },\n      recommendedActions: [bt(\"Monitor scrap trend\", \"监控报废趋势\")],\n    });\n  }\n\n  if (machine.cycleTimeDeltaPct > PRODUCTION_CONFIG.cycleTimeDeltaHighPct) {\n    score -= 10;\n    drivers.push({\n      dimension: \"manufacturing\",\n      title: bt(`Cycle time significantly elevated (+${(machine.cycleTimeDeltaPct * 100).toFixed(0)}%)`, `节拍时间显著延长 (+${(machine.cycleTimeDeltaPct * 100).toFixed(0)}%)`),\n      confidence: 0.8,\n      evidence: { metricRefs: [\"cycleTimeDeltaPct\"] },\n      recommendedActions: [bt(\"Check for mechanical issues\", \"检查机械问题\")],\n    });\n  } else if (machine.cycleTimeDeltaPct > PRODUCTION_CONFIG.cycleTimeDeltaWarnPct) {\n    score -= 5;\n    drivers.push({\n      dimension: \"manufacturing\",\n      title: bt(`Cycle time elevated`, `节拍时间偏长`),\n      confidence: 0.6,\n      evidence: { metricRefs: [\"cycleTimeDeltaPct\"] },\n      recommendedActions: [bt(\"Monitor cycle time trend\", \"监控节拍趋势\")],\n    });\n  }\n\n  if (machine.tempDrift) {\n    score -= 10;\n    drivers.push({\n      dimension: \"manufacturing\",\n      title: bt(\"Temperature drift detected\", \"检测到温度漂移\"),\n      confidence: 0.75,\n      evidence: { metricRefs: [\"tempC\", \"tempDrift\"] },\n      recommendedActions: [\n        bt(\"Check cooling system\", \"检查冷却系统\"),\n        bt(\"Correlate with quality metrics\", \"关联质量指标\"),\n      ],\n    });\n  }\n\n  if (radarStatus === \"HIGH_RISK\") {\n    score -= 20;\n    drivers.push({\n      dimension: \"engineering\",\n      title: bt(\"Engineering Risk Radar: HIGH_RISK\", \"工程风险雷达：高风险\"),\n      confidence: 0.9,\n      evidence: { metricRefs: [\"radarStatus\", \"radarScore\"] },\n      recommendedActions: [bt(\"Review design parameters\", \"复核设计参数\")],\n    });\n  } else if (radarStatus === \"MANUFACTURING_RISK\") {\n    score -= 8;\n    drivers.push({\n      dimension: \"engineering\",\n      title: bt(\"Engineering Risk Radar: MANUFACTURING_RISK\", \"工程风险雷达：制造风险\"),\n      confidence: 0.7,\n      evidence: { metricRefs: [\"radarStatus\", \"radarScore\"] },\n      recommendedActions: [bt(\"Review manufacturability\", \"复核可制造性\")],\n    });\n  }\n\n  score = Math.max(0, Math.min(100, score));\n\n  let liveRiskStatus: LiveRiskStatus = \"ENGINEERING_OK\";\n  if (\n    machine.status === \"ALARM\" ||\n    (machine.lastCpk !== null && machine.lastCpk < PRODUCTION_CONFIG.cpkHighThreshold) ||\n    machine.lastNelsonViolations >= PRODUCTION_CONFIG.nelsonViolationsHighThreshold ||\n    radarStatus === \"HIGH_RISK\"\n  ) {\n    liveRiskStatus = \"HIGH_RISK\";\n  } else if (\n    machine.scrapRate > PRODUCTION_CONFIG.scrapRateHighThreshold ||\n    machine.cycleTimeDeltaPct > PRODUCTION_CONFIG.cycleTimeDeltaWarnPct ||\n    machine.tempDrift ||\n    radarStatus === \"MANUFACTURING_RISK\"\n  ) {\n    liveRiskStatus = \"MANUFACTURING_RISK\";\n  }\n\n  const topDrivers = drivers\n    .sort((a, b) => b.confidence - a.confidence)\n    .slice(0, 3);\n\n  return {\n    liveRiskStatus,\n    liveRiskScore: score,\n    drivers: topDrivers,\n  };\n}\n\nfunction bt(en: string, zh: string): BilingualText {\n  return { en, zh };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/liveRiskBrain/engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/liveRiskBrain/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/liveRiskBrain/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/manufacturing/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/manufacturing/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/manufacturing/mock.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'runningCount' is assigned a value but never used.","line":234,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":234,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalMachines' is assigned a value but never used.","line":235,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":235,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Manufacturing Mock Data Generator\n * 生产制造模拟数据生成器\n * \n * 用于演示和开发，无需真实 PLC 连接\n */\n\nimport type {\n  MachineState,\n  MachineTile,\n  KpiSummary,\n  AndonEvent,\n  AndonSeverity,\n  AndonEventType,\n  TrendPoint,\n  ThroughputPoint,\n  ParetoItem,\n  WorkOrderRow,\n  WorkOrderStatus,\n  DashboardSummaryResponse,\n  TimeRange,\n  PlantConfig,\n  ShiftConfig,\n} from \"./types\";\n\n// ============================================================================\n// Seeded Random Generator\n// ============================================================================\n\nfunction mulberry32(seed: number) {\n  return function () {\n    let t = (seed += 0x6d2b79f5);\n    t = Math.imul(t ^ (t >>> 15), t | 1);\n    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);\n    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;\n  };\n}\n\n// ============================================================================\n// Configuration\n// ============================================================================\n\nexport const MOCK_PLANTS: PlantConfig[] = [\n  {\n    plantId: \"P01\",\n    name: { en: \"Main Plant\", zh: \"主工厂\" },\n    lines: [\n      { lineId: \"L01\", name: { en: \"Line 1 - Compression\", zh: \"1号线-压簧\" }, machineIds: [\"M01\", \"M02\", \"M03\", \"M04\"] },\n      { lineId: \"L02\", name: { en: \"Line 2 - Extension\", zh: \"2号线-拉簧\" }, machineIds: [\"M05\", \"M06\", \"M07\", \"M08\"] },\n      { lineId: \"L03\", name: { en: \"Line 3 - Torsion\", zh: \"3号线-扭簧\" }, machineIds: [\"M09\", \"M10\", \"M11\", \"M12\"] },\n    ],\n  },\n];\n\nexport const MOCK_SHIFTS: ShiftConfig[] = [\n  { shiftId: \"DAY\", name: { en: \"Day Shift\", zh: \"白班\" }, startHour: 8, endHour: 20 },\n  { shiftId: \"NIGHT\", name: { en: \"Night Shift\", zh: \"夜班\" }, startHour: 20, endHour: 8 },\n];\n\nconst MACHINE_NAMES: Record<string, string> = {\n  M01: \"CNC-A1\",\n  M02: \"CNC-A2\",\n  M03: \"CNC-A3\",\n  M04: \"CNC-A4\",\n  M05: \"EXT-B1\",\n  M06: \"EXT-B2\",\n  M07: \"EXT-B3\",\n  M08: \"EXT-B4\",\n  M09: \"TOR-C1\",\n  M10: \"TOR-C2\",\n  M11: \"TOR-C3\",\n  M12: \"TOR-C4\",\n};\n\nconst DESIGN_CODES = [\n  \"CS-2024-001\",\n  \"CS-2024-002\",\n  \"CS-2024-003\",\n  \"EX-2024-001\",\n  \"EX-2024-002\",\n  \"TS-2024-001\",\n  \"TS-2024-002\",\n  \"CN-2024-001\",\n  \"AS-2024-001\",\n];\n\nconst PART_NOS = [\n  \"SP-A100\",\n  \"SP-A200\",\n  \"SP-B100\",\n  \"SP-B200\",\n  \"SP-C100\",\n  \"SP-C200\",\n];\n\nconst STOP_REASONS = [\"MATERIAL\", \"WIRE_BREAK\", \"SETUP\", \"WAITING\", \"ALARM\", \"QUALITY\", \"MAINTENANCE\", \"OTHER\"];\n\n// ============================================================================\n// Mock Data Generation\n// ============================================================================\n\nexport interface MockGeneratorOptions {\n  seed?: number;\n  plantId?: string;\n  lineId?: string;\n  range?: TimeRange;\n  riskLevel?: \"low\" | \"medium\" | \"high\";\n}\n\n/**\n * Generate mock dashboard data\n */\nexport function generateMockDashboard(options: MockGeneratorOptions = {}): DashboardSummaryResponse {\n  const {\n    seed = Date.now(),\n    plantId = \"P01\",\n    lineId,\n    range = \"1h\",\n    riskLevel = \"low\",\n  } = options;\n\n  const rand = mulberry32(seed);\n  const now = new Date();\n\n  // Get machines for the selected plant/line\n  const plant = MOCK_PLANTS.find((p) => p.plantId === plantId) ?? MOCK_PLANTS[0];\n  const lines = lineId ? plant.lines.filter((l) => l.lineId === lineId) : plant.lines;\n  const machineIds = lines.flatMap((l) => l.machineIds);\n\n  // Generate machines\n  const machines = generateMachines(rand, machineIds, lines, riskLevel);\n\n  // Get current shift\n  const currentHour = now.getHours();\n  const currentShift = MOCK_SHIFTS.find((s) => {\n    if (s.startHour < s.endHour) {\n      return currentHour >= s.startHour && currentHour < s.endHour;\n    }\n    return currentHour >= s.startHour || currentHour < s.endHour;\n  }) ?? MOCK_SHIFTS[0];\n  const isNightShift = currentShift.shiftId === \"NIGHT\";\n\n  // Generate KPIs\n  const kpis = generateKpis(rand, machines, riskLevel, isNightShift);\n\n  // Generate Andon events\n  const andon = generateAndonEvents(rand, machines, riskLevel);\n\n  // Generate trends\n  const ctTrend = generateCtTrend(rand, machineIds, range);\n  const throughputTrend = generateThroughputTrend(rand, range);\n\n  // Generate downtime pareto\n  const downtimePareto = generateDowntimePareto(rand, riskLevel);\n\n  // Generate work orders\n  const workOrders = generateWorkOrders(rand, machines);\n\n  return {\n    kpis,\n    machines,\n    andon,\n    ctTrend,\n    throughputTrend,\n    downtimePareto,\n    workOrders,\n    shift: {\n      id: currentShift.shiftId,\n      name: currentShift.name.zh,\n      startTime: `${String(currentShift.startHour).padStart(2, \"0\")}:00`,\n      endTime: `${String(currentShift.endHour).padStart(2, \"0\")}:00`,\n    },\n  };\n}\n\nfunction generateMachines(\n  rand: () => number,\n  machineIds: string[],\n  lines: PlantConfig[\"lines\"],\n  riskLevel: string\n): MachineTile[] {\n  const stateWeights: Record<string, number[]> = {\n    low: [0.75, 0.10, 0.08, 0.05, 0.02],    // RUN heavy\n    medium: [0.55, 0.20, 0.12, 0.08, 0.05], // More stops\n    high: [0.35, 0.35, 0.15, 0.10, 0.05],   // Many stops\n  };\n\n  const weights = stateWeights[riskLevel] ?? stateWeights.low;\n  const states: MachineState[] = [\"RUN\", \"STOP\", \"SETUP\", \"WAIT\", \"OFF\"];\n\n  return machineIds.map((machineId, idx) => {\n    const r = rand();\n    let cumulative = 0;\n    let state: MachineState = \"RUN\";\n    for (let i = 0; i < weights.length; i++) {\n      cumulative += weights[i];\n      if (r < cumulative) {\n        state = states[i];\n        break;\n      }\n    }\n\n    const line = lines.find((l) => l.machineIds.includes(machineId));\n    const designIdx = Math.floor(rand() * DESIGN_CODES.length);\n    const partIdx = Math.floor(rand() * PART_NOS.length);\n\n    const tile: MachineTile = {\n      machineId,\n      name: MACHINE_NAMES[machineId] ?? machineId,\n      state,\n      lineId: line?.lineId,\n      workOrderId: state !== \"OFF\" ? `WO-${String(1000 + idx).slice(-3)}` : undefined,\n      designCode: state !== \"OFF\" ? DESIGN_CODES[designIdx] : undefined,\n      partNo: state !== \"OFF\" ? PART_NOS[partIdx] : undefined,\n      ctSec: state === \"RUN\" ? 2.5 + rand() * 1.5 : undefined,\n      lastEventAt: new Date(Date.now() - Math.floor(rand() * 300000)).toISOString(),\n      currentQty: state !== \"OFF\" ? Math.floor(rand() * 500) + 100 : undefined,\n      targetQty: state !== \"OFF\" ? 800 : undefined,\n    };\n\n    if (state === \"STOP\") {\n      tile.stopReasonCode = STOP_REASONS[Math.floor(rand() * STOP_REASONS.length)];\n    }\n\n    if (state === \"STOP\" && rand() < 0.3) {\n      tile.alarmCode = `ALM-${String(Math.floor(rand() * 100)).padStart(3, \"0\")}`;\n    }\n\n    return tile;\n  });\n}\n\nfunction generateKpis(rand: () => number, machines: MachineTile[], riskLevel: string, isNightShift: boolean): KpiSummary {\n  const runningCount = machines.filter((m) => m.state === \"RUN\").length;\n  const totalMachines = machines.filter((m) => m.state !== \"OFF\").length;\n\n  // Night shift typically has slightly lower efficiency\n  const shiftFactor = isNightShift ? 0.95 : 1.0;\n\n  const baseOee = (riskLevel === \"high\" ? 0.55 : riskLevel === \"medium\" ? 0.72 : 0.85) * shiftFactor;\n  const baseFpy = (riskLevel === \"high\" ? 0.88 : riskLevel === \"medium\" ? 0.94 : 0.98) * shiftFactor;\n\n  // Night shift has lower plan qty\n  const planQty = isNightShift ? 4000 : 5000;\n  const actualQty = Math.floor(planQty * (0.6 + rand() * 0.35));\n\n  return {\n    planQty,\n    actualQty,\n    oee: Math.min(baseOee + (rand() - 0.5) * 0.1, 0.99),\n    fpy: Math.min(baseFpy + (rand() - 0.5) * 0.04, 0.995),\n    activeAlarmsCount: machines.filter((m) => m.alarmCode).length,\n    uph: Math.floor(actualQty / 8),\n    ctAvgSec: 2.8 + rand() * 0.8 + (isNightShift ? 0.2 : 0),\n    lastUpdatedAt: new Date().toISOString(),\n  };\n}\n\nfunction generateAndonEvents(rand: () => number, machines: MachineTile[], riskLevel: string): AndonEvent[] {\n  const events: AndonEvent[] = [];\n  const eventCount = riskLevel === \"high\" ? 8 : riskLevel === \"medium\" ? 4 : 2;\n\n  const types: AndonEventType[] = [\"STOP_TOO_LONG\", \"FPY_DROP\", \"CT_SPIKE\", \"ALARM\", \"MATERIAL_LOW\", \"QUALITY_ISSUE\"];\n  const severities: AndonSeverity[] = [\"INFO\", \"WARN\", \"CRIT\"];\n  const severityWeights = riskLevel === \"high\" ? [0.2, 0.4, 0.4] : riskLevel === \"medium\" ? [0.4, 0.4, 0.2] : [0.6, 0.3, 0.1];\n\n  for (let i = 0; i < eventCount; i++) {\n    const r = rand();\n    let severity: AndonSeverity = \"INFO\";\n    let cumulative = 0;\n    for (let j = 0; j < severityWeights.length; j++) {\n      cumulative += severityWeights[j];\n      if (r < cumulative) {\n        severity = severities[j];\n        break;\n      }\n    }\n\n    const type = types[Math.floor(rand() * types.length)];\n    const machine = machines[Math.floor(rand() * machines.length)];\n\n    events.push({\n      eventId: `EVT-${String(i + 1).padStart(4, \"0\")}`,\n      severity,\n      type,\n      machineId: machine.machineId,\n      workOrderId: machine.workOrderId,\n      message: getAndonMessage(type, machine.machineId),\n      startedAt: new Date(Date.now() - Math.floor(rand() * 3600000)).toISOString(),\n      durationSec: Math.floor(rand() * 600) + 60,\n      acknowledged: rand() < 0.3,\n    });\n  }\n\n  // Sort by severity (CRIT first)\n  return events.sort((a, b) => {\n    const order: Record<AndonSeverity, number> = { CRIT: 0, WARN: 1, INFO: 2 };\n    return order[a.severity] - order[b.severity];\n  });\n}\n\nfunction getAndonMessage(type: AndonEventType, machineId: string): string {\n  const messages: Record<AndonEventType, string> = {\n    STOP_TOO_LONG: `${machineId} 停机超过 10 分钟`,\n    FPY_DROP: `${machineId} 首次合格率下降至 92%`,\n    CT_SPIKE: `${machineId} 节拍时间异常升高`,\n    ALARM: `${machineId} 设备报警`,\n    MATERIAL_LOW: `${machineId} 材料即将耗尽`,\n    QUALITY_ISSUE: `${machineId} 检测到质量问题`,\n  };\n  return messages[type];\n}\n\nfunction generateCtTrend(rand: () => number, machineIds: string[], range: TimeRange): TrendPoint[] {\n  const points: TrendPoint[] = [];\n  const rangeMinutes: Record<TimeRange, number> = { \"15m\": 15, \"1h\": 60, \"8h\": 480, \"24h\": 1440 };\n  const minutes = rangeMinutes[range];\n  const interval = Math.max(1, Math.floor(minutes / 60));\n\n  const now = Date.now();\n  for (let i = 0; i < 60; i++) {\n    const t = new Date(now - (60 - i) * interval * 60000).toISOString();\n    const machineId = machineIds[Math.floor(rand() * machineIds.length)];\n    points.push({\n      t,\n      value: 2.5 + rand() * 1.5 + Math.sin(i / 10) * 0.3,\n      machineId,\n    });\n  }\n\n  return points;\n}\n\nfunction generateThroughputTrend(rand: () => number, range: TimeRange): ThroughputPoint[] {\n  const points: ThroughputPoint[] = [];\n  const rangeMinutes: Record<TimeRange, number> = { \"15m\": 15, \"1h\": 60, \"8h\": 480, \"24h\": 1440 };\n  const minutes = rangeMinutes[range];\n  const interval = Math.max(1, Math.floor(minutes / 30));\n\n  const now = Date.now();\n  let cumGood = 0;\n  let cumScrap = 0;\n\n  for (let i = 0; i < 30; i++) {\n    const t = new Date(now - (30 - i) * interval * 60000).toISOString();\n    const good = Math.floor(50 + rand() * 30);\n    const scrap = Math.floor(rand() * 5);\n    cumGood += good;\n    cumScrap += scrap;\n    points.push({ t, qtyGood: cumGood, qtyScrap: cumScrap });\n  }\n\n  return points;\n}\n\nfunction generateDowntimePareto(rand: () => number, riskLevel: string): ParetoItem[] {\n  const baseMinutes = riskLevel === \"high\" ? 60 : riskLevel === \"medium\" ? 30 : 15;\n\n  return STOP_REASONS.slice(0, 6).map((reasonCode) => ({\n    reasonCode,\n    minutes: Math.floor(rand() * baseMinutes) + 5,\n    count: Math.floor(rand() * 10) + 1,\n  })).sort((a, b) => b.minutes - a.minutes);\n}\n\nfunction generateWorkOrders(rand: () => number, machines: MachineTile[]): WorkOrderRow[] {\n  const orders: WorkOrderRow[] = [];\n  const statuses: WorkOrderStatus[] = [\"PLANNED\", \"RUNNING\", \"HOLD\", \"DONE\"];\n\n  for (let i = 0; i < 8; i++) {\n    const status = i < 2 ? \"RUNNING\" : statuses[Math.floor(rand() * statuses.length)];\n    const targetQty = Math.floor(rand() * 500) + 500;\n    const progress = status === \"DONE\" ? 1 : status === \"RUNNING\" ? 0.3 + rand() * 0.5 : rand() * 0.3;\n\n    orders.push({\n      workOrderId: `WO-${String(1000 + i).slice(-3)}`,\n      designCode: DESIGN_CODES[i % DESIGN_CODES.length],\n      partNo: PART_NOS[i % PART_NOS.length],\n      targetQty,\n      goodQty: Math.floor(targetQty * progress),\n      scrapQty: Math.floor(targetQty * progress * (rand() * 0.03)),\n      status,\n      startedAt: status !== \"PLANNED\" ? new Date(Date.now() - Math.floor(rand() * 28800000)).toISOString() : undefined,\n      etaAt: status === \"RUNNING\" ? new Date(Date.now() + Math.floor(rand() * 14400000)).toISOString() : undefined,\n      machineId: status === \"RUNNING\" ? machines[i % machines.length]?.machineId : undefined,\n      priority: i < 2 ? 1 : Math.floor(rand() * 3) + 1,\n    });\n  }\n\n  // Sort: RUNNING first, then by priority\n  return orders.sort((a, b) => {\n    if (a.status === \"RUNNING\" && b.status !== \"RUNNING\") return -1;\n    if (a.status !== \"RUNNING\" && b.status === \"RUNNING\") return 1;\n    return (a.priority ?? 99) - (b.priority ?? 99);\n  });\n}\n\n// ============================================================================\n// Tick Function for Real-time Updates\n// ============================================================================\n\nlet tickSeed = Date.now();\n\n/**\n * Generate a new dashboard state (simulates real-time updates)\n */\nexport function tick(options: MockGeneratorOptions = {}): DashboardSummaryResponse {\n  tickSeed += 1;\n  return generateMockDashboard({ ...options, seed: tickSeed });\n}\n\n/**\n * Reset the tick seed\n */\nexport function resetTick(): void {\n  tickSeed = Date.now();\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/manufacturing/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/materials/springMaterials.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/pipeline/springPipelines.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/production/__tests__/demoGenerator.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/production/config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/production/demoGenerator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/production/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/production/stateEngine.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_callback' is defined but never used.","line":76,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":76,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ProductionDataSource, ProductionSnapshot, ProductionState, RiskLevel } from \"./types\";\nimport { generateDemoProductionSnapshot } from \"./demoGenerator\";\n\nexport type StateEngineMode = \"demo\" | \"real\";\n\nexport type StateEngineOptions = {\n  mode: StateEngineMode;\n  demoRiskPreset?: RiskLevel;\n  demoSeed?: number;\n  demoPollIntervalMs?: number;\n};\n\nclass DemoDataSource implements ProductionDataSource {\n  private riskPreset: RiskLevel;\n  private seed: number;\n  private pollIntervalMs: number;\n\n  constructor(options: { riskPreset?: RiskLevel; seed?: number; pollIntervalMs?: number }) {\n    this.riskPreset = options.riskPreset ?? \"OK\";\n    this.seed = options.seed ?? Date.now();\n    this.pollIntervalMs = options.pollIntervalMs ?? 5000;\n  }\n\n  subscribe(callback: (state: ProductionState) => void): () => void {\n    let running = true;\n    let timeoutId: ReturnType<typeof setTimeout> | null = null;\n\n    const poll = () => {\n      if (!running) return;\n      const snapshot = generateDemoProductionSnapshot({\n        seed: this.seed++,\n        riskPreset: this.riskPreset,\n        includeTimeseries: false,\n      });\n      for (const machine of snapshot.machines) {\n        if (!running) break;\n        callback({\n          timestamp: snapshot.timestamp,\n          lineId: machine.lineId,\n          machineId: machine.machineId,\n          productId: machine.productId,\n          springType: machine.springType,\n          status: machine.status,\n          cycleTimeMs: machine.cycleTimeMs,\n          throughputPerHour: Math.round((3600 * 1000) / machine.cycleTimeMs),\n          scrapRate: machine.scrapRate,\n          processParams: { tempC: machine.tempC ?? undefined },\n          qualitySignals: {\n            lastCpk: machine.lastCpk ?? undefined,\n            lastNelsonViolations: machine.lastNelsonViolations,\n            lastDefectRate: machine.scrapRate,\n          },\n        });\n      }\n      timeoutId = setTimeout(poll, this.pollIntervalMs);\n    };\n\n    poll();\n\n    return () => {\n      running = false;\n      if (timeoutId) clearTimeout(timeoutId);\n    };\n  }\n\n  async getSnapshot(): Promise<ProductionSnapshot> {\n    return generateDemoProductionSnapshot({\n      seed: this.seed,\n      riskPreset: this.riskPreset,\n      includeTimeseries: true,\n    });\n  }\n}\n\nclass RealDataSource implements ProductionDataSource {\n  subscribe(_callback: (state: ProductionState) => void): () => void {\n    console.warn(\"[ProductionStateEngine] Real data source not implemented yet. Use demo mode.\");\n    return () => {};\n  }\n\n  async getSnapshot(): Promise<ProductionSnapshot> {\n    console.warn(\"[ProductionStateEngine] Real data source not implemented yet. Returning empty snapshot.\");\n    return {\n      timestamp: new Date().toISOString(),\n      factorySummary: {\n        runningCount: 0,\n        stoppedCount: 0,\n        alarmCount: 0,\n        setupCount: 0,\n        throughputNow: 0,\n        scrapRateNow: 0,\n      },\n      machines: [],\n    };\n  }\n}\n\nlet currentDataSource: ProductionDataSource | null = null;\nlet currentMode: StateEngineMode = \"demo\";\n\nexport function initStateEngine(options: StateEngineOptions): ProductionDataSource {\n  currentMode = options.mode;\n\n  if (options.mode === \"demo\") {\n    currentDataSource = new DemoDataSource({\n      riskPreset: options.demoRiskPreset,\n      seed: options.demoSeed,\n      pollIntervalMs: options.demoPollIntervalMs,\n    });\n  } else {\n    currentDataSource = new RealDataSource();\n  }\n\n  return currentDataSource;\n}\n\nexport function getProductionDataSource(): ProductionDataSource {\n  if (!currentDataSource) {\n    currentDataSource = new DemoDataSource({});\n  }\n  return currentDataSource;\n}\n\nexport function getCurrentMode(): StateEngineMode {\n  return currentMode;\n}\n\nexport async function getProductionSnapshot(options?: { mode?: StateEngineMode; riskPreset?: RiskLevel; seed?: number }): Promise<ProductionSnapshot> {\n  const mode = options?.mode ?? \"demo\";\n\n  if (mode === \"demo\") {\n    return generateDemoProductionSnapshot({\n      seed: options?.seed ?? Date.now(),\n      riskPreset: options?.riskPreset ?? \"OK\",\n      includeTimeseries: true,\n    });\n  }\n\n  const ds = getProductionDataSource();\n  return ds.getSnapshot();\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/production/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/__tests__/qualitySidecarRegression.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/analytics/analyzeDataset.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/analytics/capability.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/analytics/imr.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/analytics/msa.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/analytics/nelson.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/analytics/xbarr.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/firewall/normalize.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/firewall/validate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/ingestion/inferMapping.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/ingestion/parseCsv.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/report/qualityAnalysisReport.ts","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from '@typescript-eslint/no-explicit-any').","line":652,"column":11,"severity":1,"nodeType":null,"fix":{"range":[27787,27849],"text":" "}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":654,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":654,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27886,27889],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27886,27889],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { createElement } from \"react\";\nimport { Document, Page, Text, View, StyleSheet, Svg, Path, Line } from \"@react-pdf/renderer\";\n\nimport type { FieldMapping, QualityAnalysisResult, QualityDataset } from \"../types\";\nimport { buildQualityReportNarrative } from \"./reportNarrator\";\n\nexport type QualityAnalysisReportModel = {\n  dataset: Pick<QualityDataset, \"id\" | \"name\" | \"createdAtISO\" | \"source\" | \"headers\">;\n  mapping: FieldMapping;\n  analysis: QualityAnalysisResult;\n  meta?: {\n    title?: string;\n    projectName?: string;\n    engineer?: string;\n    customer?: string;\n    supplier?: string;\n    partNumber?: string;\n    partName?: string;\n    rev?: string;\n    preparedBy?: string;\n    approvedBy?: string;\n    approvedAtISO?: string;\n    language?: \"en\" | \"zh\" | \"bilingual\";\n  };\n};\n\nfunction t(lang: NonNullable<QualityAnalysisReportModel[\"meta\"]>[\"language\"], en: string, zh: string): string {\n  if (lang === \"zh\") return zh;\n  if (lang === \"en\") return en;\n  return `${en} / ${zh}`;\n}\n\nfunction fmt(value: unknown, decimals = 3): string {\n  const n = typeof value === \"number\" ? value : Number.NaN;\n  if (!isFinite(n)) return \"—\";\n  return Number(n.toFixed(decimals)).toLocaleString();\n}\n\ntype XY = { x: number; y: number };\n\nfunction linePath(points: XY[], xScale: (x: number) => number, yScale: (y: number) => number): string {\n  if (points.length < 2) return \"\";\n  return points\n    .map((p, i) => {\n      const x = xScale(p.x);\n      const y = yScale(p.y);\n      return `${i === 0 ? \"M\" : \"L\"} ${x.toFixed(1)} ${y.toFixed(1)}`;\n    })\n    .join(\" \");\n}\n\nconst styles = StyleSheet.create({\n  page: { padding: 40, fontSize: 10, fontFamily: \"Helvetica\", color: \"#0f172a\" },\n  header: { marginBottom: 16, borderBottom: \"2px solid #2563eb\", paddingBottom: 10 },\n  title: { fontSize: 18, fontWeight: \"bold\", color: \"#1d4ed8\" },\n  subtitle: { fontSize: 9, color: \"#64748b\", marginTop: 4 },\n  section: { marginBottom: 14 },\n  sectionTitle: {\n    fontSize: 12,\n    fontWeight: \"bold\",\n    color: \"#1e293b\",\n    borderBottom: \"1px solid #e2e8f0\",\n    paddingBottom: 4,\n    marginBottom: 8,\n  },\n  row: { flexDirection: \"row\", justifyContent: \"space-between\", marginBottom: 3 },\n  label: { color: \"#64748b\", flexGrow: 1 },\n  value: { fontWeight: \"bold\", textAlign: \"right\", flexShrink: 0, marginLeft: 8 },\n  card: { border: \"1px solid #e2e8f0\", borderRadius: 4, padding: 8, backgroundColor: \"#f8fafc\" },\n  chartWrap: { marginTop: 6, border: \"1px solid #e2e8f0\", borderRadius: 4, backgroundColor: \"#ffffff\", padding: 8 },\n  chartTitle: { fontSize: 9, color: \"#334155\", marginBottom: 4, fontWeight: \"bold\" },\n  footer: { position: \"absolute\", bottom: 28, left: 40, right: 40, textAlign: \"center\", color: \"#94a3b8\", fontSize: 8 },\n});\n\nfunction kv(label: string, value: string) {\n  return createElement(\n    View,\n    { style: styles.row },\n    createElement(Text, { style: styles.label }, label),\n    createElement(Text, { style: styles.value }, value)\n  );\n}\n\nfunction SimpleLineChart({ title, points }: { title: string; points: XY[] }) {\n  const width = 520;\n  const height = 180;\n  const padding = { left: 30, right: 10, top: 12, bottom: 22 };\n  const innerW = width - padding.left - padding.right;\n  const innerH = height - padding.top - padding.bottom;\n\n  const xs = points.map((p) => p.x);\n  const ys = points.map((p) => p.y);\n  const xMin = xs.length ? Math.min(...xs) : 0;\n  const xMax = xs.length ? Math.max(...xs) : 1;\n  const yMin = ys.length ? Math.min(...ys) : 0;\n  const yMax = ys.length ? Math.max(...ys) : 1;\n\n  const xSpan = Math.max(1e-9, xMax - xMin);\n  const ySpan = Math.max(1e-9, yMax - yMin);\n\n  const xScale = (x: number) => padding.left + ((x - xMin) / xSpan) * innerW;\n  const yScale = (y: number) => padding.top + innerH - ((y - yMin) / ySpan) * innerH;\n\n  return createElement(\n    View,\n    { style: styles.chartWrap },\n    createElement(Text, { style: styles.chartTitle }, title),\n    createElement(\n      Svg,\n      { width, height, viewBox: `0 0 ${width} ${height}` },\n      createElement(Line, {\n        x1: padding.left,\n        y1: padding.top + innerH,\n        x2: width - padding.right,\n        y2: padding.top + innerH,\n        stroke: \"#94a3b8\",\n        strokeWidth: 1,\n      }),\n      createElement(Line, {\n        x1: padding.left,\n        y1: padding.top,\n        x2: padding.left,\n        y2: padding.top + innerH,\n        stroke: \"#94a3b8\",\n        strokeWidth: 1,\n      }),\n      createElement(Path, {\n        d: linePath(points, xScale, yScale),\n        fill: \"none\",\n        stroke: \"#2563eb\",\n        strokeWidth: 2,\n      })\n    )\n  );\n}\n\nexport function generateQualityAnalysisReportHTML(model: QualityAnalysisReportModel): string {\n  const lang = model.meta?.language ?? \"bilingual\";\n\n  const title = model.meta?.title ?? t(lang, \"Quality Analysis Report\", \"质量分析报告\");\n  const generatedAt = new Date().toLocaleString();\n\n  const narrative = buildQualityReportNarrative({ analysis: model.analysis, lang });\n\n\n\n  const executiveReasonsHtml = narrative.executiveSummary.keyReasons\n    .map((r) => `<li>${t(lang, r.en, r.zh)}</li>`)\n    .join(\"\\n\");\n\n  const executiveDispositionHtml = narrative.executiveSummary.disposition\n    .map((x) => `<li>${t(lang, x.en, x.zh)}</li>`)\n    .join(\"\\n\");\n\n  const criticalByCharacteristicHtml = (() => {\n    const items = narrative.criticalFindingsByCharacteristic.items\n      .map((it) => {\n        const stability = it.stability.length\n          ? `<ul>${it.stability.map((b) => `<li>${t(lang, b.en, b.zh)}</li>`).join(\"\\n\")}</ul>`\n          : \"\";\n        const capability = it.capability.length\n          ? `<ul>${it.capability.map((b) => `<li>${t(lang, b.en, b.zh)}</li>`).join(\"\\n\")}</ul>`\n          : \"\";\n        const rec = it.recommendation.length\n          ? `<ul>${it.recommendation.map((b) => `<li>${t(lang, b.en, b.zh)}</li>`).join(\"\\n\")}</ul>`\n          : \"\";\n\n        return `\n          <div style=\"margin-bottom:12px\">\n            <div style=\"font-weight:800;color:#0f172a;margin-bottom:6px\">${it.characteristic}</div>\n            ${stability ? `<div style=\"margin-top:6px\"><div style=\"font-weight:700\">${t(lang, it.stabilityLabel.en, it.stabilityLabel.zh)}</div>${stability}</div>` : \"\"}\n            ${capability ? `<div style=\"margin-top:6px\"><div style=\"font-weight:700\">${t(lang, it.capabilityLabel.en, it.capabilityLabel.zh)}</div>${capability}</div>` : \"\"}\n            <div style=\"margin-top:6px\"><div style=\"font-weight:700\">${t(lang, it.assessmentLabel.en, it.assessmentLabel.zh)}</div><div>${t(lang, it.assessment.en, it.assessment.zh)}</div></div>\n            ${rec ? `<div style=\"margin-top:6px\"><div style=\"font-weight:700\">${t(lang, it.recommendationLabel.en, it.recommendationLabel.zh)}</div>${rec}</div>` : \"\"}\n          </div>\n        `;\n      })\n      .join(\"\\n\");\n\n    return items ? items : \"\";\n  })();\n\n  const spcInterpretationHtml = (() => {\n    const items = narrative.controlChartInterpretation.items\n      .map((it) => {\n        const bullets = it.bullets.map((b) => `<li>${t(lang, b.en, b.zh)}</li>`).join(\"\\n\");\n        return `<li><strong>${it.characteristic}</strong><ul>${bullets}</ul></li>`;\n      })\n      .join(\"\\n\");\n    return items ? `<ul>${items}</ul>` : \"\";\n  })();\n\n  const measurementHtml = (() => {\n    const findings = narrative.measurementSystem.findings.map((x) => `<li>${t(lang, x.en, x.zh)}</li>`).join(\"\\n\");\n    const rec = narrative.measurementSystem.recommendation.map((x) => `<li>${t(lang, x.en, x.zh)}</li>`).join(\"\\n\");\n\n    const msaRows = narrative.measurementSystem.msaSummary\n      .map((m) => {\n        const pct = m.pctGrr === null || !isFinite(m.pctGrr) ? \"—\" : `${m.pctGrr.toFixed(1)}%`;\n        const ndc = m.ndc === null || !isFinite(m.ndc) ? \"—\" : String(m.ndc);\n        return `<tr><td>${m.characteristic}</td><td style=\\\"text-align:right\\\">${pct}</td><td style=\\\"text-align:right\\\">${ndc}</td><td>${m.assessment}</td></tr>`;\n      })\n      .join(\"\\n\");\n\n    const msaTable = msaRows\n      ? `\n        <div style=\\\"margin-bottom:8px\\\">\n          <div style=\\\"font-weight:700\\\">${t(lang, narrative.measurementSystem.msaSummaryLabel.en, narrative.measurementSystem.msaSummaryLabel.zh)}</div>\n          <table>\n            <thead>\n              <tr>\n                <th>${t(lang, \"Characteristic\", \"特性\")}</th>\n                <th style=\\\"text-align:right\\\">%GRR</th>\n                <th style=\\\"text-align:right\\\">ndc</th>\n                <th>${t(lang, \"Assessment\", \"评价\")}</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${msaRows}\n            </tbody>\n          </table>\n        </div>\n      `\n      : \"\";\n\n    return `\n      <div style=\"margin-bottom:8px\">\n        <div style=\"font-weight:700\">${t(lang, narrative.measurementSystem.findingsLabel.en, narrative.measurementSystem.findingsLabel.zh)}</div>\n        <ul>${findings}</ul>\n      </div>\n      <div style=\"margin-bottom:8px\">\n        <div style=\"font-weight:700\">${t(lang, narrative.measurementSystem.riskLabel.en, narrative.measurementSystem.riskLabel.zh)}</div>\n        <div>${t(lang, narrative.measurementSystem.risk.en, narrative.measurementSystem.risk.zh)}</div>\n      </div>\n      ${msaTable}\n      <div>\n        <div style=\"font-weight:700\">${t(lang, narrative.measurementSystem.recommendationLabel.en, narrative.measurementSystem.recommendationLabel.zh)}</div>\n        <ul>${rec}</ul>\n      </div>\n    `;\n  })();\n\n  const xbarrSummaryHtml = (() => {\n    const items = model.analysis.characteristics\n      .map((c) => {\n        const xb = c.xbarr;\n        if (!xb) return \"\";\n        const xOoc = xb.points.filter((p) => p.xOutOfControl).length;\n        const rOoc = xb.points.filter((p) => p.rOutOfControl).length;\n        return `<li><strong>${c.name}</strong>: n=${xb.subgroupSize}, subgroups=${xb.points.length}, X OOC=${xOoc}, R OOC=${rOoc}</li>`;\n      })\n      .filter(Boolean)\n      .join(\"\\n\");\n\n    return items ? `<ul>${items}</ul>` : \"\";\n  })();\n\n  const stratificationSummaryHtml = (() => {\n    const s = narrative.stratification;\n    if (!s) return \"\";\n    const items = s.lines.map((x) => `<li><strong>${x.key}</strong>: ${x.status} / ${x.score} / n=${x.n}</li>`).join(\"\\n\");\n    return items\n      ? `<div>\n          <div style=\"color:#334155;margin-bottom:6px\">${t(lang, \"By\", \"维度\")}: ${s.by}</div>\n          <div style=\"color:#334155;margin-bottom:6px\">${t(lang, s.interpretation.en, s.interpretation.zh)}</div>\n          <ul>${items}</ul>\n        </div>`\n      : \"\";\n  })();\n\n  const charsHtml = narrative.capability.rows\n    .map((r) => {\n      const cpk = r.cpk === null ? \"—\" : fmt(r.cpk, 3);\n      const cp = r.cp === null ? \"—\" : fmt(r.cp, 3);\n      const assess = t(lang, r.assessment.en, r.assessment.zh);\n      const note = r.note ? t(lang, r.note.en, r.note.zh) : \"\";\n      return `\n        <tr>\n          <td>${r.characteristic}</td>\n          <td style=\"text-align:right\">${r.n}</td>\n          <td style=\"text-align:right\">${fmt(r.mean, 3)}</td>\n          <td style=\"text-align:right\">${fmt(r.std, 3)}</td>\n          <td style=\"text-align:right\">${cp}</td>\n          <td style=\"text-align:right\">${cpk}</td>\n          <td>${assess}${note ? `<div style=\\\"color:#64748b;font-size:11px;margin-top:2px\\\">${note}</div>` : \"\"}</td>\n        </tr>\n      `;\n    })\n    .join(\"\\n\");\n\n  return `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <title>${title}</title>\n  <style>\n    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;padding:24px;color:#0f172a}\n    h1{margin:0 0 6px 0;color:#1d4ed8}\n    .meta{color:#64748b;font-size:12px;margin-bottom:18px}\n    .card{border:1px solid #e2e8f0;border-radius:10px;padding:14px;background:#f8fafc;margin-bottom:14px}\n    table{width:100%;border-collapse:collapse}\n    th,td{border-bottom:1px solid #e2e8f0;padding:8px;font-size:12px}\n    th{text-align:left;color:#334155;background:#f1f5f9}\n  </style>\n</head>\n<body>\n  <h1>${title}</h1>\n  <div class=\"meta\">${t(lang, \"Generated\", \"生成\")}: ${generatedAt} | ${t(lang, \"Dataset\", \"数据集\")}: ${model.dataset.name}</div>\n\n  <div class=\"card\">\n    <strong>${t(lang, \"PPAP / Report Info\", \"PPAP / 报告信息\")}</strong>\n    <table style=\"margin-top:8px\">\n      <tbody>\n        <tr><td style=\"width:180px;color:#64748b\">${t(lang, \"Customer\", \"客户\")}</td><td>${model.meta?.customer ?? \"—\"}</td></tr>\n        <tr><td style=\"color:#64748b\">${t(lang, \"Supplier\", \"供应商\")}</td><td>${model.meta?.supplier ?? \"—\"}</td></tr>\n        <tr><td style=\"color:#64748b\">${t(lang, \"Part No.\", \"零件号\")}</td><td>${model.meta?.partNumber ?? \"—\"}</td></tr>\n        <tr><td style=\"color:#64748b\">${t(lang, \"Part Name\", \"零件名称\")}</td><td>${model.meta?.partName ?? \"—\"}</td></tr>\n        <tr><td style=\"color:#64748b\">${t(lang, \"Rev\", \"版本\")}</td><td>${model.meta?.rev ?? \"—\"}</td></tr>\n        <tr><td style=\"color:#64748b\">${t(lang, \"Prepared By\", \"编制\")}</td><td>${model.meta?.preparedBy ?? model.meta?.engineer ?? \"—\"}</td></tr>\n        <tr><td style=\"color:#64748b\">${t(lang, \"Approved By\", \"批准\")}</td><td>${model.meta?.approvedBy ?? \"—\"}</td></tr>\n        <tr><td style=\"color:#64748b\">${t(lang, \"Approved Date\", \"批准日期\")}</td><td>${model.meta?.approvedAtISO ?? \"—\"}</td></tr>\n      </tbody>\n    </table>\n  </div>\n\n  <div class=\"card\">\n    <strong>${t(lang, narrative.executiveSummary.title.en, narrative.executiveSummary.title.zh)}</strong>\n    <div style=\"margin-top:8px;color:#334155\">\n      <div><span style=\"font-weight:700\">${t(lang, narrative.executiveSummary.overallStatusLabel.en, narrative.executiveSummary.overallStatusLabel.zh)}</span>: ${model.analysis.status}</div>\n      <div><span style=\"font-weight:700\">${t(lang, \"Score\", \"评分\")}</span>: ${model.analysis.score}</div>\n      <div style=\"margin-top:8px\"><span style=\"font-weight:700\">${t(lang, narrative.executiveSummary.conclusionLabel.en, narrative.executiveSummary.conclusionLabel.zh)}</span>: ${t(lang, narrative.executiveSummary.conclusion.en, narrative.executiveSummary.conclusion.zh)}</div>\n      <div style=\"margin-top:8px\"><span style=\"font-weight:700\">${t(lang, narrative.executiveSummary.keyReasonsLabel.en, narrative.executiveSummary.keyReasonsLabel.zh)}</span><ul>${executiveReasonsHtml}</ul></div>\n      <div style=\"margin-top:8px\"><span style=\"font-weight:700\">${t(lang, narrative.executiveSummary.dispositionLabel.en, narrative.executiveSummary.dispositionLabel.zh)}</span><ul>${executiveDispositionHtml}</ul></div>\n      <div style=\"margin-top:6px;color:#64748b;font-size:11px\">${t(lang, narrative.executiveSummary.scoreExplain.en, narrative.executiveSummary.scoreExplain.zh)}</div>\n    </div>\n  </div>\n\n  <div class=\"card\">\n    <strong>${t(lang, narrative.criticalFindingsByCharacteristic.title.en, narrative.criticalFindingsByCharacteristic.title.zh)}</strong>\n    ${criticalByCharacteristicHtml || \"\"}\n  </div>\n\n  ${spcInterpretationHtml ? `\n  <div class=\"card\">\n    <strong>${t(lang, narrative.controlChartInterpretation.title.en, narrative.controlChartInterpretation.title.zh)}</strong>\n    ${spcInterpretationHtml}\n  </div>\n  ` : \"\"}\n\n  <div class=\"card\">\n    <strong>${t(lang, narrative.measurementSystem.title.en, narrative.measurementSystem.title.zh)}</strong>\n    ${measurementHtml}\n  </div>\n\n  ${xbarrSummaryHtml ? `\n  <div class=\"card\">\n    <strong>${t(lang, \"Xbar-R\", \"Xbar-R\")}</strong>\n    ${xbarrSummaryHtml}\n  </div>\n  ` : \"\"}\n\n  ${stratificationSummaryHtml ? `\n  <div class=\"card\">\n    <strong>${t(lang, \"Stratification\", \"分层\")}</strong>\n    ${stratificationSummaryHtml}\n  </div>\n  ` : \"\"}\n\n  <div class=\"card\">\n    <strong>${t(lang, narrative.engineeringJudgment.title.en, narrative.engineeringJudgment.title.zh)}</strong>\n    <div style=\"margin-top:6px\">${t(lang, narrative.engineeringJudgment.text.en, narrative.engineeringJudgment.text.zh)}</div>\n  </div>\n\n  <div class=\"card\">\n    <strong>${t(lang, narrative.recommendedActions.title.en, narrative.recommendedActions.title.zh)}</strong>\n    <ul>\n      ${narrative.recommendedActions.items.map((x) => `<li>${t(lang, x.en, x.zh)}</li>`).join(\"\\n\")}\n    </ul>\n  </div>\n\n  <div class=\"card\">\n    <strong>${t(lang, narrative.capability.title.en, narrative.capability.title.zh)}</strong>\n    <table>\n      <thead>\n        <tr>\n          <th>${t(lang, \"Characteristic\", \"特性\")}</th>\n          <th style=\"text-align:right\">n</th>\n          <th style=\"text-align:right\">mean</th>\n          <th style=\"text-align:right\">std</th>\n          <th style=\"text-align:right\">Cp</th>\n          <th style=\"text-align:right\">Cpk</th>\n          <th>${t(lang, \"Assessment\", \"评价\")}</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${charsHtml}\n      </tbody>\n    </table>\n  </div>\n</body>\n</html>`;\n}\n\nexport function QualityAnalysisReportPDF({ model }: { model: QualityAnalysisReportModel }) {\n  const lang = model.meta?.language ?? \"bilingual\";\n  const title = model.meta?.title ?? t(lang, \"Quality Analysis Report\", \"质量分析报告\");\n  const generatedAt = new Date().toLocaleString();\n\n  const narrative = buildQualityReportNarrative({ analysis: model.analysis, lang });\n\n  const executiveLines = [\n    `${t(lang, narrative.executiveSummary.overallStatusLabel.en, narrative.executiveSummary.overallStatusLabel.zh)}: ${model.analysis.status}`,\n    `${t(lang, \"Score\", \"评分\")}: ${model.analysis.score}`,\n    `${t(lang, narrative.executiveSummary.conclusionLabel.en, narrative.executiveSummary.conclusionLabel.zh)}: ${t(lang, narrative.executiveSummary.conclusion.en, narrative.executiveSummary.conclusion.zh)}`,\n    `${t(lang, narrative.executiveSummary.keyReasonsLabel.en, narrative.executiveSummary.keyReasonsLabel.zh)}:`,\n    ...narrative.executiveSummary.keyReasons.map((r) => `- ${t(lang, r.en, r.zh)}`),\n    `${t(lang, narrative.executiveSummary.dispositionLabel.en, narrative.executiveSummary.dispositionLabel.zh)}:`,\n    ...narrative.executiveSummary.disposition.map((r) => `- ${t(lang, r.en, r.zh)}`),\n    t(lang, narrative.executiveSummary.scoreExplain.en, narrative.executiveSummary.scoreExplain.zh),\n  ];\n\n  const criticalByCharLines = narrative.criticalFindingsByCharacteristic.items.flatMap((it) => {\n    const out: string[] = [];\n    out.push(`${it.characteristic}`);\n    if (it.stability.length) {\n      out.push(`${t(lang, it.stabilityLabel.en, it.stabilityLabel.zh)}:`);\n      out.push(...it.stability.map((b) => `- ${t(lang, b.en, b.zh)}`));\n    }\n    if (it.capability.length) {\n      out.push(`${t(lang, it.capabilityLabel.en, it.capabilityLabel.zh)}:`);\n      out.push(...it.capability.map((b) => `- ${t(lang, b.en, b.zh)}`));\n    }\n    out.push(`${t(lang, it.assessmentLabel.en, it.assessmentLabel.zh)}: ${t(lang, it.assessment.en, it.assessment.zh)}`);\n    if (it.recommendation.length) {\n      out.push(`${t(lang, it.recommendationLabel.en, it.recommendationLabel.zh)}:`);\n      out.push(...it.recommendation.map((b) => `- ${t(lang, b.en, b.zh)}`));\n    }\n    return out;\n  });\n\n  const spcLines = narrative.controlChartInterpretation.items.flatMap((it) => {\n    return [`${it.characteristic}`, ...it.bullets.map((b) => `- ${t(lang, b.en, b.zh)}`)];\n  });\n\n  const measurementLines = [\n    `${t(lang, narrative.measurementSystem.findingsLabel.en, narrative.measurementSystem.findingsLabel.zh)}:`,\n    ...narrative.measurementSystem.findings.map((x) => `- ${t(lang, x.en, x.zh)}`),\n    `${t(lang, narrative.measurementSystem.riskLabel.en, narrative.measurementSystem.riskLabel.zh)}: ${t(lang, narrative.measurementSystem.risk.en, narrative.measurementSystem.risk.zh)}`,\n    `${t(lang, narrative.measurementSystem.recommendationLabel.en, narrative.measurementSystem.recommendationLabel.zh)}:`,\n    ...narrative.measurementSystem.recommendation.map((x) => `- ${t(lang, x.en, x.zh)}`),\n  ];\n\n  const msaLines = narrative.measurementSystem.msaSummary.flatMap((m) => {\n    const pct = m.pctGrr === null || !isFinite(m.pctGrr) ? \"—\" : `${m.pctGrr.toFixed(1)}%`;\n    const ndc = m.ndc === null || !isFinite(m.ndc) ? \"—\" : String(m.ndc);\n    return [`${m.characteristic}: %GRR=${pct}, ndc=${ndc}, ${m.assessment}`];\n  });\n\n  const ppapInfoLines = [\n    `${t(lang, \"Customer\", \"客户\")}: ${model.meta?.customer ?? \"—\"}`,\n    `${t(lang, \"Supplier\", \"供应商\")}: ${model.meta?.supplier ?? \"—\"}`,\n    `${t(lang, \"Part No.\", \"零件号\")}: ${model.meta?.partNumber ?? \"—\"}`,\n    `${t(lang, \"Part Name\", \"零件名称\")}: ${model.meta?.partName ?? \"—\"}`,\n    `${t(lang, \"Rev\", \"版本\")}: ${model.meta?.rev ?? \"—\"}`,\n    `${t(lang, \"Prepared By\", \"编制\")}: ${model.meta?.preparedBy ?? model.meta?.engineer ?? \"—\"}`,\n    `${t(lang, \"Approved By\", \"批准\")}: ${model.meta?.approvedBy ?? \"—\"}`,\n    `${t(lang, \"Approved Date\", \"批准日期\")}: ${model.meta?.approvedAtISO ?? \"—\"}`,\n  ];\n\n  const xbarrLines = model.analysis.characteristics\n    .map((c) => {\n      const xb = c.xbarr;\n      if (!xb) return null;\n      const xOoc = xb.points.filter((p) => p.xOutOfControl).length;\n      const rOoc = xb.points.filter((p) => p.rOutOfControl).length;\n      return `${c.name}: n=${xb.subgroupSize}, subgroups=${xb.points.length}, X OOC=${xOoc}, R OOC=${rOoc}`;\n    })\n    .filter((x): x is string => typeof x === \"string\");\n\n  const stratificationLines = (() => {\n    const s = narrative.stratification;\n    if (!s) return [] as string[];\n    return [\n      `${t(lang, \"By\", \"维度\")}: ${s.by}`,\n      t(lang, s.interpretation.en, s.interpretation.zh),\n      ...s.lines.map((x) => `${x.key}: ${x.status} / ${x.score} / n=${x.n}`),\n    ];\n  })();\n\n  const judgmentLines = [t(lang, narrative.engineeringJudgment.text.en, narrative.engineeringJudgment.text.zh)];\n  const actionLines = narrative.recommendedActions.items.map((x) => `- ${t(lang, x.en, x.zh)}`);\n\n  const first = model.analysis.characteristics[0];\n  const chartPoints: XY[] = first\n    ? first.imr.points.map((p) => ({ x: p.x, y: p.value }))\n    : [];\n\n  return createElement(\n    Document,\n    {},\n    createElement(\n      Page,\n      { size: \"A4\", style: styles.page },\n      createElement(\n        View,\n        { style: styles.header },\n        createElement(Text, { style: styles.title }, title),\n        createElement(Text, { style: styles.subtitle }, `${t(lang, \"Generated\", \"生成\")}: ${generatedAt}`),\n        createElement(Text, { style: styles.subtitle }, `${t(lang, \"Dataset\", \"数据集\")}: ${model.dataset.name}`)\n      ),\n      ppapInfoLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, \"PPAP / Report Info\", \"PPAP / 报告信息\")),\n        createElement(\n          View,\n          { style: styles.card },\n          ...ppapInfoLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, \"Summary\", \"概要\")),\n        createElement(View, { style: styles.card },\n          kv(`${t(lang, \"Status\", \"状态\")}`, model.analysis.status),\n          kv(`${t(lang, \"Score\", \"评分\")}`, String(model.analysis.score)),\n          kv(`${t(lang, \"Rows\", \"行数\")}`, String(model.analysis.dataQuality.stats.totalRows)),\n          kv(`${t(lang, \"Valid\", \"有效\")}`, String(model.analysis.dataQuality.stats.validMeasurements))\n        )\n      ),\n      executiveLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, narrative.executiveSummary.title.en, narrative.executiveSummary.title.zh)),\n        createElement(\n          View,\n          { style: styles.card },\n          ...executiveLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      criticalByCharLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, narrative.criticalFindingsByCharacteristic.title.en, narrative.criticalFindingsByCharacteristic.title.zh)),\n        createElement(\n          View,\n          { style: styles.card },\n          ...criticalByCharLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      spcLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, narrative.controlChartInterpretation.title.en, narrative.controlChartInterpretation.title.zh)),\n        createElement(\n          View,\n          { style: styles.card },\n          ...spcLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      measurementLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, narrative.measurementSystem.title.en, narrative.measurementSystem.title.zh)),\n        createElement(\n          View,\n          { style: styles.card },\n          ...measurementLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      msaLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, narrative.measurementSystem.msaSummaryLabel.en, narrative.measurementSystem.msaSummaryLabel.zh)),\n        createElement(\n          View,\n          { style: styles.card },\n          ...msaLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      xbarrLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, \"Xbar-R\", \"Xbar-R\")),\n        createElement(\n          View,\n          { style: styles.card },\n          ...xbarrLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      stratificationLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, \"Stratification\", \"分层\")),\n        createElement(\n          View,\n          { style: styles.card },\n          ...stratificationLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      judgmentLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, narrative.engineeringJudgment.title.en, narrative.engineeringJudgment.title.zh)),\n        createElement(\n          View,\n          { style: styles.card },\n          ...judgmentLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      actionLines.length > 0 &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(Text, { style: styles.sectionTitle }, t(lang, narrative.recommendedActions.title.en, narrative.recommendedActions.title.zh)),\n        createElement(\n          View,\n          { style: styles.card },\n          ...actionLines.map((line, idx) => createElement(Text, { key: `${idx}-${line}` }, line))\n        )\n      ),\n      first &&\n      createElement(\n        View,\n        { style: styles.section },\n        createElement(\n          Text,\n          { style: styles.sectionTitle },\n          `${t(lang, \"I Chart (first characteristic)\", \"I 图（首个特性）\")}: ${first.name}`\n        ),\n        createElement(SimpleLineChart, {\n          title: `${t(lang, \"Individuals\", \"单值\")}`,\n          points: chartPoints,\n        })\n      ),\n      createElement(\n        Text,\n        {\n          style: styles.footer,\n          render: ({ pageNumber, totalPages }: { pageNumber: number; totalPages: number }) => `${pageNumber} / ${totalPages}`,\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          fixed: true,\n        } as any,\n        \"\"\n      )\n    )\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/report/reportNarrator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/repository/fileRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/quality/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/AdvancedReportGenerator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'workingConditions' is assigned a value but never used.","line":957,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":957,"endColumn":46}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Advanced Spring Engineering Report Generator\n * 高级弹簧工程报告生成器\n * \n * Generates comprehensive PDF reports including Phase 4 analyses:\n * - Stress distribution\n * - Fatigue damage map\n * - Failure mode diagnostics\n * - Design suggestions\n * - Optimization results\n */\n\nimport type { SpringGeometry, WorkingConditions, SpringAnalysisResult } from '@/lib/engine/types';\nimport type { StressDistributionResult } from '@/lib/engine/stressDistribution';\nimport type { FatigueDamageResult } from '@/lib/engine/fatigueDamage';\nimport type { DiagnosticsResult } from '@/lib/engine/failureDiagnostics';\nimport type { SuggestionsResult } from '@/lib/engine/designSuggestions';\nimport type { OptimizationResult } from '@/lib/engine/optimizer';\nimport type { VerdictResult } from '@/lib/engine/verdict';\nimport type { DynamicsResult } from '@/lib/engine/dynamics';\nimport type { TemperatureEffectResult } from '@/lib/engine/temperature';\nimport type { CreepResult } from '@/lib/engine/creep';\nimport type { EnvironmentEffectResult } from '@/lib/engine/environment';\n// Phase 6 imports\nimport type { CoilingProcessResult } from '@/lib/engine/coilingProcess';\nimport type { ShotPeeningResult } from '@/lib/engine/shotPeening';\nimport type { ScragTestResult } from '@/lib/engine/scragTest';\nimport type { ManufacturabilityResult } from '@/lib/engine/manufacturabilityCheck';\nimport type { StandardCheckResult } from '@/lib/engine/standardsCheck';\nimport type { MaterialRecommendationResult } from '@/lib/engine/materialRecommendation';\nimport type { MLPredictionResult } from '@/lib/engine/mlFatiguePredictor';\n// Phase 7 imports\nimport type { CrackInitiationResult } from '@/lib/engine/phase7/crackInitiationProbability';\nimport type { CorrosionAnalysisResult } from '@/lib/engine/phase7/corrosionModel';\nimport type { CoatingSimulationResult } from '@/lib/engine/phase7/coatingSimulation';\nimport type { CostYieldPredictionResult } from '@/lib/engine/phase7/costYieldPredictor';\nimport type { HarmonicResponseResult } from '@/lib/engine/phase7/harmonicResponse';\nimport type { HealthDegradationResult } from '@/lib/engine/phase7/healthDegradation';\nimport type { HotspotTrackingResult } from '@/lib/engine/phase7/fractureHotspot';\nimport { getSpringMaterial } from '@/lib/materials/springMaterials';\n\n/**\n * Advanced report data\n */\nexport interface AdvancedReportData {\n  /** Basic report config */\n  config: {\n    companyName?: string;\n    language: 'en' | 'zh' | 'bilingual';\n    includeStressMap?: boolean;\n    includeDamageMap?: boolean;\n    includeDiagnostics?: boolean;\n    includeSuggestions?: boolean;\n    includeOptimization?: boolean;\n  };\n  /** Spring geometry */\n  geometry: SpringGeometry;\n  /** Working conditions */\n  workingConditions: WorkingConditions;\n  /** Basic analysis results */\n  results: SpringAnalysisResult;\n  /** Advanced analysis data */\n  advanced?: {\n    stressDistribution?: StressDistributionResult;\n    fatigueDamage?: FatigueDamageResult;\n    diagnostics?: DiagnosticsResult;\n    suggestions?: SuggestionsResult;\n    optimization?: OptimizationResult;\n    verdict?: VerdictResult;\n    dynamics?: DynamicsResult;\n    temperature?: TemperatureEffectResult;\n    creep?: CreepResult;\n    environment?: EnvironmentEffectResult;\n  };\n  /** Phase 6 manufacturing & AI data */\n  phase6?: {\n    coilingProcess?: CoilingProcessResult;\n    shotPeening?: ShotPeeningResult;\n    scragTest?: ScragTestResult;\n    manufacturability?: ManufacturabilityResult;\n    standardsCheck?: {\n      asme?: StandardCheckResult;\n      sae?: StandardCheckResult;\n      din?: StandardCheckResult;\n    };\n    materialRecommendation?: MaterialRecommendationResult;\n    mlFatiguePrediction?: MLPredictionResult;\n  };\n  /** Phase 7 digital twin data */\n  phase7?: {\n    crackInitiation?: CrackInitiationResult;\n    corrosion?: CorrosionAnalysisResult;\n    coating?: CoatingSimulationResult;\n    costYield?: CostYieldPredictionResult;\n    harmonicResponse?: HarmonicResponseResult;\n    healthDegradation?: HealthDegradationResult;\n    hotspotTracking?: HotspotTrackingResult;\n  };\n}\n\n/**\n * Format number\n */\nfunction fmt(n: number, decimals = 2): string {\n  return Number(n.toFixed(decimals)).toLocaleString();\n}\n\n/**\n * Get spring type name\n */\nfunction getTypeName(type: string, lang: 'en' | 'zh'): string {\n  const names: Record<string, { en: string; zh: string }> = {\n    compression: { en: 'Compression Spring', zh: '压缩弹簧' },\n    extension: { en: 'Extension Spring', zh: '拉伸弹簧' },\n    torsion: { en: 'Torsion Spring', zh: '扭转弹簧' },\n    conical: { en: 'Conical Spring', zh: '锥形弹簧' },\n  };\n  return names[type]?.[lang] ?? type;\n}\n\n/**\n * Generate stress distribution section HTML\n */\nfunction generateStressDistributionSection(\n  data: StressDistributionResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '应力分布分析' : 'Stress Distribution Analysis';\n  const labels = {\n    maxStress: lang === 'zh' ? '最大应力' : 'Maximum Stress',\n    minStress: lang === 'zh' ? '最小应力' : 'Minimum Stress',\n    avgStress: lang === 'zh' ? '平均应力' : 'Average Stress',\n    criticalZones: lang === 'zh' ? '临界区域数' : 'Critical Zones',\n    hotSpots: lang === 'zh' ? '热点数' : 'Hot Spots',\n  };\n\n  return `\n    <div class=\"section\">\n      <h2>${title}</h2>\n      <table>\n        <tr><td>${labels.maxStress}</td><td><strong>${fmt(data.maxStress, 1)} MPa</strong></td></tr>\n        <tr><td>${labels.minStress}</td><td>${fmt(data.minStress, 1)} MPa</td></tr>\n        <tr><td>${labels.avgStress}</td><td>${fmt(data.avgStress, 1)} MPa</td></tr>\n        <tr><td>${labels.criticalZones}</td><td class=\"${data.criticalZoneCount > 0 ? 'danger' : 'safe'}\">${data.criticalZoneCount}</td></tr>\n        <tr><td>${labels.hotSpots}</td><td>${data.hotSpots.length}</td></tr>\n      </table>\n      \n      ${data.hotSpots.length > 0 ? `\n        <h3>${lang === 'zh' ? '热点位置' : 'Hot Spot Locations'}</h3>\n        <table class=\"small\">\n          <thead>\n            <tr>\n              <th>${lang === 'zh' ? '位置' : 'Location'}</th>\n              <th>${lang === 'zh' ? '圈数' : 'Coil'}</th>\n              <th>${lang === 'zh' ? '应力' : 'Stress'}</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${data.hotSpots.slice(0, 5).map(spot => `\n              <tr>\n                <td>θ = ${(spot.theta * 180 / Math.PI).toFixed(0)}°</td>\n                <td>${spot.coilNumber.toFixed(1)}</td>\n                <td class=\"danger\">${fmt(spot.stress, 0)} MPa</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n      ` : ''}\n    </div>\n  `;\n}\n\n/**\n * Generate fatigue damage section HTML\n */\nfunction generateFatigueDamageSection(\n  data: FatigueDamageResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '疲劳损伤分析' : 'Fatigue Damage Analysis';\n  \n  return `\n    <div class=\"section\">\n      <h2>${title}</h2>\n      <div class=\"status-banner ${data.status}\">\n        ${lang === 'zh' ? data.message.zh : data.message.en}\n      </div>\n      <table>\n        <tr>\n          <td>${lang === 'zh' ? '最大损伤指数' : 'Max Damage Index'}</td>\n          <td class=\"${data.maxDamageIndex > 0.5 ? 'danger' : 'safe'}\"><strong>${data.maxDamageIndex.toFixed(4)}</strong></td>\n        </tr>\n        <tr>\n          <td>${lang === 'zh' ? '平均损伤指数' : 'Avg Damage Index'}</td>\n          <td>${data.avgDamageIndex.toFixed(4)}</td>\n        </tr>\n        <tr>\n          <td>${lang === 'zh' ? 'Miner 累积损伤' : 'Miner Sum'}</td>\n          <td class=\"${data.minerSum > 1 ? 'danger' : ''}\">${data.minerSum.toFixed(4)}</td>\n        </tr>\n        <tr>\n          <td>${lang === 'zh' ? '高损伤区域 (D>0.5)' : 'High Damage Zones (D>0.5)'}</td>\n          <td class=\"${data.highDamageZoneCount > 0 ? 'warning' : ''}\">${data.highDamageZoneCount}</td>\n        </tr>\n        <tr>\n          <td>${lang === 'zh' ? '预测失效区域' : 'Failure Predicted'}</td>\n          <td class=\"${data.failurePredictedCount > 0 ? 'danger' : 'safe'}\">${data.failurePredictedCount}</td>\n        </tr>\n      </table>\n    </div>\n  `;\n}\n\n/**\n * Generate diagnostics section HTML\n */\nfunction generateDiagnosticsSection(\n  data: DiagnosticsResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '失效模式诊断' : 'Failure Mode Diagnostics';\n  \n  if (data.failureModes.length === 0) {\n    return `\n      <div class=\"section\">\n        <h2>${title}</h2>\n        <div class=\"status-banner safe\">\n          ${lang === 'zh' ? '未检测到显著失效模式 ✓' : 'No significant failure modes detected ✓'}\n        </div>\n      </div>\n    `;\n  }\n  \n  return `\n    <div class=\"section\">\n      <h2>${title}</h2>\n      <div class=\"status-banner ${data.overallRisk}\">\n        ${lang === 'zh' ? data.summary.zh : data.summary.en}\n      </div>\n      <table>\n        <thead>\n          <tr>\n            <th>${lang === 'zh' ? '失效模式' : 'Failure Mode'}</th>\n            <th>${lang === 'zh' ? '严重程度' : 'Severity'}</th>\n            <th>${lang === 'zh' ? '概率' : 'Probability'}</th>\n            <th>${lang === 'zh' ? '数值依据' : 'Justification'}</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${data.failureModes.map(mode => `\n            <tr>\n              <td><strong>${lang === 'zh' ? mode.name.zh : mode.name.en}</strong></td>\n              <td class=\"${mode.severity}\">${mode.severity.toUpperCase()}</td>\n              <td>${(mode.probability * 100).toFixed(0)}%</td>\n              <td class=\"mono\">${mode.numericalJustification}</td>\n            </tr>\n          `).join('')}\n        </tbody>\n      </table>\n    </div>\n  `;\n}\n\n/**\n * Generate suggestions section HTML\n */\nfunction generateSuggestionsSection(\n  data: SuggestionsResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '设计改进建议' : 'Design Improvement Suggestions';\n  \n  if (data.suggestions.length === 0) {\n    return `\n      <div class=\"section\">\n        <h2>${title}</h2>\n        <p>${lang === 'zh' ? '当前设计满足所有要求，无需改进。' : 'Current design meets all requirements. No improvements needed.'}</p>\n      </div>\n    `;\n  }\n  \n  return `\n    <div class=\"section\">\n      <h2>${title}</h2>\n      <p>${lang === 'zh' ? data.summary.zh : data.summary.en}</p>\n      \n      ${data.topPriority.length > 0 ? `\n        <h3>${lang === 'zh' ? '高优先级建议' : 'Top Priority'}</h3>\n        <ul>\n          ${data.topPriority.map(s => `\n            <li>\n              <strong>${lang === 'zh' ? s.title.zh : s.title.en}</strong>\n              <br><span class=\"muted\">${lang === 'zh' ? s.description.zh : s.description.en}</span>\n              ${s.parameterChange ? `<br><code>${s.parameterChange.parameter}: ${s.parameterChange.currentValue.toFixed(2)} → ${s.parameterChange.suggestedValue.toFixed(2)} ${s.parameterChange.unit}</code>` : ''}\n            </li>\n          `).join('')}\n        </ul>\n      ` : ''}\n      \n      ${data.quickWins.length > 0 ? `\n        <h3>${lang === 'zh' ? '快速改进' : 'Quick Wins'}</h3>\n        <ul>\n          ${data.quickWins.filter(s => !data.topPriority.includes(s)).map(s => `\n            <li>\n              <strong>${lang === 'zh' ? s.title.zh : s.title.en}</strong>\n              <span class=\"badge\">${s.difficulty}</span>\n            </li>\n          `).join('')}\n        </ul>\n      ` : ''}\n    </div>\n  `;\n}\n\n/**\n * Generate optimization section HTML\n */\nfunction generateOptimizationSection(\n  data: OptimizationResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '优化结果' : 'Optimization Results';\n  \n  return `\n    <div class=\"section\">\n      <h2>${title}</h2>\n      <div class=\"status-banner ${data.status}\">\n        ${lang === 'zh' ? data.message.zh : data.message.en}\n      </div>\n      \n      <h3>${lang === 'zh' ? '最优解' : 'Best Solution'}</h3>\n      <table>\n        <tr><td>${lang === 'zh' ? '线径 d' : 'Wire Diameter d'}</td><td><strong>${data.bestSolution.wireDiameter} mm</strong></td></tr>\n        <tr><td>${lang === 'zh' ? '中径 Dm' : 'Mean Diameter Dm'}</td><td><strong>${data.bestSolution.meanDiameter} mm</strong></td></tr>\n        <tr><td>${lang === 'zh' ? '有效圈数 Na' : 'Active Coils Na'}</td><td><strong>${data.bestSolution.activeCoils}</strong></td></tr>\n        <tr><td>${lang === 'zh' ? '自由长度 L0' : 'Free Length L0'}</td><td><strong>${data.bestSolution.freeLength} mm</strong></td></tr>\n        <tr><td>${lang === 'zh' ? '材料' : 'Material'}</td><td>${data.bestSolution.materialId}</td></tr>\n      </table>\n      \n      <h3>${lang === 'zh' ? '预期性能' : 'Expected Performance'}</h3>\n      <table>\n        <tr><td>${lang === 'zh' ? '刚度 k' : 'Spring Rate k'}</td><td>${data.expectedPerformance.springRate} N/mm</td></tr>\n        <tr><td>${lang === 'zh' ? '安全系数' : 'Safety Factor'}</td><td>${data.expectedPerformance.safetyFactor}</td></tr>\n        <tr><td>${lang === 'zh' ? '质量' : 'Mass'}</td><td>${(data.expectedPerformance.mass * 1000).toFixed(1)} g</td></tr>\n      </table>\n      \n      ${data.paretoFront.length > 1 ? `\n        <h3>${lang === 'zh' ? 'Pareto 前沿解' : 'Pareto Front Solutions'}</h3>\n        <table class=\"small\">\n          <thead>\n            <tr>\n              <th>d (mm)</th>\n              <th>Dm (mm)</th>\n              <th>Na</th>\n              <th>SF</th>\n              <th>${lang === 'zh' ? '质量' : 'Mass'}</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${data.paretoFront.slice(0, 5).map(sol => `\n              <tr>\n                <td>${sol.solution.wireDiameter}</td>\n                <td>${sol.solution.meanDiameter}</td>\n                <td>${sol.solution.activeCoils}</td>\n                <td>${sol.objectives.safety.toFixed(2)}</td>\n                <td>${(sol.objectives.mass * 1000).toFixed(1)}g</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n      ` : ''}\n    </div>\n  `;\n}\n\n/**\n * Generate verdict section HTML\n */\nfunction generateVerdictSection(\n  data: VerdictResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '最终判定' : 'Final Verdict';\n  \n  return `\n    <div class=\"section verdict\">\n      <h2>${title}</h2>\n      <div class=\"verdict-banner ${data.status.toLowerCase().replace('_', '-')}\">\n        <div class=\"verdict-status\">${data.status}</div>\n        <div class=\"verdict-message\">${lang === 'zh' ? data.message.zh : data.message.en}</div>\n      </div>\n      \n      <h3>${lang === 'zh' ? '检查项目' : 'Criteria Check'}</h3>\n      <table>\n        <thead>\n          <tr>\n            <th></th>\n            <th>${lang === 'zh' ? '项目' : 'Criterion'}</th>\n            <th>${lang === 'zh' ? '实际值' : 'Actual'}</th>\n            <th>${lang === 'zh' ? '要求' : 'Required'}</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${data.criteria.map(c => `\n            <tr class=\"${c.passed ? '' : c.severity}\">\n              <td>${c.passed ? '✓' : '✗'}</td>\n              <td>${lang === 'zh' ? c.nameZh : c.name}</td>\n              <td>${c.actualValue}</td>\n              <td>${c.requiredValue}</td>\n            </tr>\n          `).join('')}\n        </tbody>\n      </table>\n      \n      ${data.recommendations.length > 0 ? `\n        <h3>${lang === 'zh' ? '建议' : 'Recommendations'}</h3>\n        <ul>\n          ${data.recommendations.map(r => `<li>${r}</li>`).join('')}\n        </ul>\n      ` : ''}\n    </div>\n  `;\n}\n\n/**\n * Generate manufacturing analysis section HTML (Phase 6)\n */\nfunction generateManufacturingSection(\n  coiling: CoilingProcessResult | undefined,\n  shotPeening: ShotPeeningResult | undefined,\n  scragTest: ScragTestResult | undefined,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '制造工艺分析' : 'Manufacturing Process Analysis';\n  \n  let content = `<div class=\"section\"><h2>${title}</h2>`;\n  \n  // Coiling process\n  if (coiling) {\n    content += `\n      <h3>${lang === 'zh' ? '卷绕工艺' : 'Coiling Process'}</h3>\n      <table>\n        <tr><td>${lang === 'zh' ? '残余弯曲应力' : 'Residual Bending Stress'}</td><td>${fmt(coiling.residualBendingStress, 1)} MPa</td></tr>\n        <tr><td>${lang === 'zh' ? '残余扭转应力' : 'Residual Torsional Stress'}</td><td>${fmt(coiling.residualTorsionalStress, 1)} MPa</td></tr>\n        <tr><td>${lang === 'zh' ? '回弹角' : 'Springback Angle'}</td><td>${fmt(coiling.springbackAngle, 2)}°</td></tr>\n        <tr><td>${lang === 'zh' ? '补偿芯棒直径' : 'Compensated Mandrel'}</td><td>${fmt(coiling.compensatedMandrelDiameter, 2)} mm</td></tr>\n        <tr><td>${lang === 'zh' ? '疲劳寿命折减系数' : 'Fatigue Life Reduction'}</td><td>${fmt(coiling.fatigueLifeReductionFactor, 3)}</td></tr>\n      </table>\n    `;\n  }\n  \n  // Shot peening\n  if (shotPeening) {\n    content += `\n      <h3>${lang === 'zh' ? '喷丸强化' : 'Shot Peening'}</h3>\n      <table>\n        <tr><td>${lang === 'zh' ? '表面残余压应力' : 'Surface Compressive Stress'}</td><td class=\"safe\">${fmt(shotPeening.surfaceStress, 0)} MPa</td></tr>\n        <tr><td>${lang === 'zh' ? '压应力层深度' : 'Compressive Layer Depth'}</td><td>${fmt(shotPeening.effectiveDepth, 3)} mm</td></tr>\n        <tr><td>${lang === 'zh' ? '疲劳寿命提升' : 'Fatigue Life Improvement'}</td><td class=\"safe\">${fmt(shotPeening.enduranceEnhancementFactor, 2)}×</td></tr>\n        <tr><td>${lang === 'zh' ? '新疲劳极限' : 'New Endurance Limit'}</td><td>${fmt(shotPeening.newEnduranceLimit, 0)} MPa</td></tr>\n        <tr><td>${lang === 'zh' ? '修正有效应力' : 'Corrected Effective Stress'}</td><td>${fmt(shotPeening.correctedEffectiveStress, 0)} MPa</td></tr>\n      </table>\n    `;\n  }\n  \n  // Scrag test\n  if (scragTest) {\n    content += `\n      <h3>${lang === 'zh' ? '立定处理' : 'Scrag Test / Setting'}</h3>\n      <table>\n        <tr><td>${lang === 'zh' ? '塑性应变' : 'Plastic Strain'}</td><td>${(scragTest.residualPlasticStrain * 100).toFixed(3)}%</td></tr>\n        <tr><td>${lang === 'zh' ? '永久变形' : 'Permanent Set'}</td><td>${fmt(scragTest.permanentSet, 3)} mm (${fmt(scragTest.permanentSetPercent, 2)}%)</td></tr>\n        <tr><td>${lang === 'zh' ? '新自由长度' : 'New Free Length'}</td><td>${fmt(scragTest.newFreeLength, 2)} mm</td></tr>\n        <tr><td>${lang === 'zh' ? '新刚度' : 'New Spring Rate'}</td><td>${fmt(scragTest.newSpringRate, 2)} N/mm (${scragTest.springRateChange > 0 ? '+' : ''}${fmt(scragTest.springRateChange, 2)}%)</td></tr>\n        <tr><td>${lang === 'zh' ? '立定应力' : 'Scrag Stress'}</td><td>${fmt(scragTest.scragStress, 0)} MPa</td></tr>\n        <tr><td>${lang === 'zh' ? '稳定化' : 'Stabilization'}</td><td class=\"${scragTest.stabilizationAchieved ? 'safe' : 'warning'}\">${scragTest.stabilizationAchieved ? '✓' : '✗'}</td></tr>\n      </table>\n    `;\n  }\n  \n  content += '</div>';\n  return content;\n}\n\n/**\n * Generate manufacturability check section HTML (Phase 6)\n */\nfunction generateManufacturabilitySection(\n  data: ManufacturabilityResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '可制造性评估' : 'Manufacturability Assessment';\n  \n  const statusClass = data.isManufacturable \n    ? (data.criticalCount === 0 && data.majorCount === 0 ? 'safe' : 'warning')\n    : 'danger';\n  \n  return `\n    <div class=\"section\">\n      <h2>${title}</h2>\n      <div class=\"status-banner ${statusClass}\">\n        ${data.summary}\n      </div>\n      <table>\n        <tr><td>${lang === 'zh' ? '可制造性' : 'Manufacturable'}</td><td class=\"${data.isManufacturable ? 'safe' : 'danger'}\">${data.isManufacturable ? '✓' : '✗'}</td></tr>\n        <tr><td>${lang === 'zh' ? '难度评分' : 'Difficulty Score'}</td><td>${data.difficultyScore}/100</td></tr>\n        <tr><td>${lang === 'zh' ? '严重问题' : 'Critical Issues'}</td><td class=\"${data.criticalCount > 0 ? 'danger' : ''}\">${data.criticalCount}</td></tr>\n        <tr><td>${lang === 'zh' ? '主要问题' : 'Major Issues'}</td><td class=\"${data.majorCount > 0 ? 'warning' : ''}\">${data.majorCount}</td></tr>\n        <tr><td>${lang === 'zh' ? '推荐工艺' : 'Recommended Process'}</td><td>${data.recommendedProcess}</td></tr>\n      </table>\n      \n      ${data.issues.length > 0 ? `\n        <h3>${lang === 'zh' ? '问题清单' : 'Issues'}</h3>\n        <table class=\"small\">\n          <thead>\n            <tr>\n              <th>${lang === 'zh' ? '严重程度' : 'Severity'}</th>\n              <th>${lang === 'zh' ? '问题' : 'Issue'}</th>\n              <th>${lang === 'zh' ? '建议' : 'Suggestion'}</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${data.issues.map(issue => `\n              <tr class=\"${issue.severity}\">\n                <td>${issue.severity.toUpperCase()}</td>\n                <td>${issue.description}</td>\n                <td>${issue.suggestion}</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n      ` : ''}\n      \n      <h3>${lang === 'zh' ? '质量检查点' : 'QC Checkpoints'}</h3>\n      <ul>\n        ${data.qcCheckpoints.map(cp => `<li>${cp}</li>`).join('')}\n      </ul>\n    </div>\n  `;\n}\n\n/**\n * Generate standards compliance section HTML (Phase 6)\n */\nfunction generateStandardsSection(\n  standards: { asme?: StandardCheckResult; sae?: StandardCheckResult; din?: StandardCheckResult },\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? '标准符合性检查' : 'Standards Compliance';\n  \n  const renderStandard = (std: StandardCheckResult) => {\n    const statusClass = std.overallStatus === 'pass' ? 'safe' : \n      std.overallStatus === 'warning' ? 'warning' : 'danger';\n    \n    return `\n      <div class=\"status-banner ${statusClass}\" style=\"margin: 5px 0; padding: 8px;\">\n        <strong>${std.standard}</strong>: ${std.summary}\n        <span class=\"badge\">${std.passCount}/${std.checks.length} ${lang === 'zh' ? '通过' : 'passed'}</span>\n      </div>\n    `;\n  };\n  \n  let content = `<div class=\"section\"><h2>${title}</h2>`;\n  \n  if (standards.asme) content += renderStandard(standards.asme);\n  if (standards.sae) content += renderStandard(standards.sae);\n  if (standards.din) content += renderStandard(standards.din);\n  \n  // Detailed checks table\n  const allChecks = [\n    ...(standards.asme?.checks || []).map(c => ({ ...c, standard: 'ASME' })),\n    ...(standards.sae?.checks || []).map(c => ({ ...c, standard: 'SAE J157' })),\n    ...(standards.din?.checks || []).map(c => ({ ...c, standard: 'DIN 2089' })),\n  ];\n  \n  if (allChecks.length > 0) {\n    content += `\n      <h3>${lang === 'zh' ? '详细检查结果' : 'Detailed Check Results'}</h3>\n      <table class=\"small\">\n        <thead>\n          <tr>\n            <th></th>\n            <th>${lang === 'zh' ? '标准' : 'Standard'}</th>\n            <th>${lang === 'zh' ? '检查项' : 'Check'}</th>\n            <th>${lang === 'zh' ? '实际值' : 'Actual'}</th>\n            <th>${lang === 'zh' ? '要求' : 'Required'}</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${allChecks.map(c => `\n            <tr class=\"${c.status === 'fail' ? 'danger' : c.status === 'warning' ? 'warning' : ''}\">\n              <td>${c.status === 'pass' ? '✓' : c.status === 'warning' ? '⚠' : '✗'}</td>\n              <td>${c.standard}</td>\n              <td>${c.name}</td>\n              <td>${c.actualValue}</td>\n              <td>${c.limitValue}</td>\n            </tr>\n          `).join('')}\n        </tbody>\n      </table>\n    `;\n  }\n  \n  content += '</div>';\n  return content;\n}\n\n/**\n * Generate ML fatigue prediction section HTML (Phase 6)\n */\nfunction generateMLFatigueSection(\n  data: MLPredictionResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? 'AI疲劳寿命预测' : 'AI Fatigue Life Prediction';\n  \n  return `\n    <div class=\"section\">\n      <h2>${title}</h2>\n      <table>\n        <tr><td>${lang === 'zh' ? 'ML预测寿命' : 'ML Predicted Life'}</td><td><strong>${data.predictedCycles.toExponential(2)} cycles</strong></td></tr>\n        <tr><td>${lang === 'zh' ? '95%置信区间' : '95% Confidence Interval'}</td><td>${data.confidenceInterval.lower.toExponential(1)} - ${data.confidenceInterval.upper.toExponential(1)}</td></tr>\n        <tr><td>${lang === 'zh' ? '传统计算寿命' : 'Traditional Calculated'}</td><td>${data.comparison.calculatedLife.toExponential(2)} cycles</td></tr>\n        <tr><td>${lang === 'zh' ? '差异' : 'Difference'}</td><td>${data.comparison.differencePercent > 0 ? '+' : ''}${fmt(data.comparison.differencePercent, 1)}%</td></tr>\n        <tr><td>${lang === 'zh' ? '预测可靠度' : 'Reliability Score'}</td><td>${data.reliabilityScore}/100</td></tr>\n        <tr><td>${lang === 'zh' ? '模型类型' : 'Model Type'}</td><td>${data.modelType}</td></tr>\n      </table>\n      \n      <h3>${lang === 'zh' ? '特征重要性' : 'Feature Importance'}</h3>\n      <table class=\"small\">\n        <tbody>\n          ${Object.entries(data.featureImportance)\n            .sort(([, a], [, b]) => b - a)\n            .slice(0, 5)\n            .map(([feature, importance]) => `\n              <tr>\n                <td>${feature}</td>\n                <td>\n                  <div style=\"background: #3182ce; height: 12px; width: ${importance * 300}px; border-radius: 2px;\"></div>\n                </td>\n                <td>${(importance * 100).toFixed(1)}%</td>\n              </tr>\n            `).join('')}\n        </tbody>\n      </table>\n    </div>\n  `;\n}\n\n/**\n * Generate material recommendation section HTML (Phase 6)\n */\nfunction generateMaterialRecommendationSection(\n  data: MaterialRecommendationResult,\n  lang: 'en' | 'zh'\n): string {\n  const title = lang === 'zh' ? 'AI材料推荐' : 'AI Material Recommendation';\n  \n  const statusClass = data.designFeasible ? 'safe' : 'warning';\n  \n  return `\n    <div class=\"section\">\n      <h2>${title}</h2>\n      <div class=\"status-banner ${statusClass}\">\n        ${data.summary}\n      </div>\n      \n      <h3>${lang === 'zh' ? '推荐材料' : 'Recommended Materials'}</h3>\n      <table>\n        <thead>\n          <tr>\n            <th>#</th>\n            <th>${lang === 'zh' ? '材料' : 'Material'}</th>\n            <th>${lang === 'zh' ? '评分' : 'Score'}</th>\n            <th>${lang === 'zh' ? '安全系数' : 'Safety Factor'}</th>\n            <th>${lang === 'zh' ? '满足要求' : 'Meets Req.'}</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${data.recommendations.slice(0, 5).map(rec => `\n            <tr>\n              <td>${rec.rank}</td>\n              <td><strong>${rec.material.nameEn}</strong><br><span class=\"muted\">${rec.material.nameZh}</span></td>\n              <td>${fmt(rec.performance.overallScore, 0)}/100</td>\n              <td>${fmt(rec.performance.safetyFactor, 2)}</td>\n              <td class=\"${rec.performance.meetsRequirements ? 'safe' : 'warning'}\">${rec.performance.meetsRequirements ? '✓' : '✗'}</td>\n            </tr>\n          `).join('')}\n        </tbody>\n      </table>\n      \n      ${data.generalSuggestions.length > 0 ? `\n        <h3>${lang === 'zh' ? '通用建议' : 'General Suggestions'}</h3>\n        <ul>\n          ${data.generalSuggestions.map(s => `<li>${s}</li>`).join('')}\n        </ul>\n      ` : ''}\n    </div>\n  `;\n}\n\n// ============================================================\n// Phase 7 Report Sections\n// ============================================================\n\n/**\n * Generate Digital Twin section (crack initiation, corrosion, health)\n */\nfunction generateDigitalTwinSection(\n  phase7: NonNullable<AdvancedReportData['phase7']>,\n  lang: 'en' | 'zh'\n): string {\n  const { crackInitiation, corrosion, healthDegradation } = phase7;\n  \n  return `\n    <div class=\"section\">\n      <h2>${lang === 'zh' ? '数字孪生分析 (Phase 7)' : 'Digital Twin Analysis (Phase 7)'}</h2>\n      \n      ${crackInitiation ? `\n        <h3>${lang === 'zh' ? '疲劳裂纹萌生概率' : 'Fatigue Crack Initiation Probability'}</h3>\n        <table>\n          <tr><td>${lang === 'zh' ? 'B10寿命 (10%失效)' : 'B10 Life (10% failure)'}</td><td><strong>${crackInitiation.B10Life.toExponential(2)} cycles</strong></td></tr>\n          <tr><td>${lang === 'zh' ? 'B50寿命 (中位数)' : 'B50 Life (median)'}</td><td>${crackInitiation.B50Life.toExponential(2)} cycles</td></tr>\n          <tr><td>${lang === 'zh' ? '特征寿命 η' : 'Characteristic Life η'}</td><td>${crackInitiation.characteristicLife.toExponential(2)} cycles</td></tr>\n          <tr><td>${lang === 'zh' ? 'Weibull形状参数 β' : 'Weibull Shape β'}</td><td>${fmt(crackInitiation.effectiveWeibull.beta, 2)}</td></tr>\n          <tr><td>${lang === 'zh' ? '风险等级' : 'Risk Level'}</td><td class=\"status-banner ${crackInitiation.riskLevel}\">${crackInitiation.riskLevel.toUpperCase()}</td></tr>\n        </table>\n        <p class=\"muted\">${lang === 'zh' ? '修正因子' : 'Modification Factors'}: \n          ${lang === 'zh' ? '表面' : 'Surface'}=${fmt(crackInitiation.modificationFactors.surface, 2)}, \n          ${lang === 'zh' ? '环境' : 'Environment'}=${fmt(crackInitiation.modificationFactors.environment, 2)}, \n          ${lang === 'zh' ? '平均应力' : 'Mean Stress'}=${fmt(crackInitiation.modificationFactors.meanStress, 2)}\n        </p>\n      ` : ''}\n      \n      ${corrosion ? `\n        <h3>${lang === 'zh' ? '腐蚀影响分析' : 'Corrosion Impact Analysis'}</h3>\n        <table>\n          <tr><td>${lang === 'zh' ? '有效腐蚀速率' : 'Effective Corrosion Rate'}</td><td>${fmt(corrosion.effectiveCorrosionRate, 4)} mm/year</td></tr>\n          <tr><td>${lang === 'zh' ? '腐蚀疲劳因子' : 'Corrosion Fatigue Factor'}</td><td>${fmt(corrosion.corrosionFatigueFactor, 2)}</td></tr>\n          <tr><td>${lang === 'zh' ? '腐蚀后耐久极限' : 'Corroded Endurance Limit'}</td><td>${fmt(corrosion.corrodedEnduranceLimit, 0)} MPa</td></tr>\n          <tr><td>${lang === 'zh' ? '临界厚度损失时间' : 'Time to Critical'}</td><td>${fmt(corrosion.timeToCritical, 1)} ${lang === 'zh' ? '年' : 'years'}</td></tr>\n          <tr><td>${lang === 'zh' ? '点蚀风险' : 'Pitting Risk'}</td><td class=\"status-banner ${corrosion.pittingRisk}\">${corrosion.pittingRisk.toUpperCase()}</td></tr>\n          <tr><td>${lang === 'zh' ? 'SCC风险' : 'SCC Risk'}</td><td class=\"status-banner ${corrosion.sccRisk}\">${corrosion.sccRisk.toUpperCase()}</td></tr>\n        </table>\n      ` : ''}\n      \n      ${healthDegradation ? `\n        <h3>${lang === 'zh' ? '结构健康退化预测' : 'Structural Health Degradation'}</h3>\n        <table>\n          <tr><td>${lang === 'zh' ? '预测寿命终点' : 'Predicted End of Life'}</td><td><strong>${fmt(healthDegradation.endOfLife.predictedEOL, 1)} ${lang === 'zh' ? '年' : 'years'}</strong></td></tr>\n          <tr><td>${lang === 'zh' ? '限制因素' : 'Limiting Factor'}</td><td>${healthDegradation.endOfLife.limitingFactor}</td></tr>\n          <tr><td>${lang === 'zh' ? '建议更换时间' : 'Recommended Replacement'}</td><td>${fmt(healthDegradation.endOfLife.recommendedReplacement, 1)} ${lang === 'zh' ? '年' : 'years'}</td></tr>\n          <tr><td>${lang === 'zh' ? '置信度' : 'Confidence'}</td><td>${fmt(healthDegradation.endOfLife.confidence * 100, 0)}%</td></tr>\n        </table>\n        ${healthDegradation.riskTimeline.length > 0 ? `\n          <h4>${lang === 'zh' ? '风险时间线' : 'Risk Timeline'}</h4>\n          <ul class=\"small\">\n            ${healthDegradation.riskTimeline.map(r => `\n              <li><strong>${fmt(r.years, 1)} ${lang === 'zh' ? '年' : 'yr'}</strong>: \n                <span class=\"status-banner ${r.riskLevel}\" style=\"padding: 2px 6px;\">${r.riskLevel}</span> \n                ${r.description}\n              </li>\n            `).join('')}\n          </ul>\n        ` : ''}\n      ` : ''}\n    </div>\n  `;\n}\n\n/**\n * Generate Cost & Yield section\n */\nfunction generateCostYieldSection(data: CostYieldPredictionResult, lang: 'en' | 'zh'): string {\n  return `\n    <div class=\"section\">\n      <h2>${lang === 'zh' ? '成本与良率预测' : 'Cost & Yield Prediction'}</h2>\n      \n      <h3>${lang === 'zh' ? '成本明细' : 'Cost Breakdown'}</h3>\n      <table>\n        <tr><td>${lang === 'zh' ? '材料成本' : 'Material Cost'}</td><td>$${fmt(data.costBreakdown.materialCost, 4)}</td></tr>\n        <tr><td>${lang === 'zh' ? '人工成本' : 'Labor Cost'}</td><td>$${fmt(data.costBreakdown.laborCost, 4)}</td></tr>\n        <tr><td>${lang === 'zh' ? '机器成本' : 'Machine Cost'}</td><td>$${fmt(data.costBreakdown.machineCost, 4)}</td></tr>\n        <tr><td>${lang === 'zh' ? '表面处理' : 'Surface Treatment'}</td><td>$${fmt(data.costBreakdown.treatmentCost, 4)}</td></tr>\n        <tr><td>${lang === 'zh' ? '喷丸处理' : 'Shot Peening'}</td><td>$${fmt(data.costBreakdown.shotPeeningCost, 4)}</td></tr>\n        <tr><td>${lang === 'zh' ? '检验成本' : 'Inspection Cost'}</td><td>$${fmt(data.costBreakdown.inspectionCost, 4)}</td></tr>\n        <tr><td><strong>${lang === 'zh' ? '单件总成本' : 'Total Cost/Piece'}</strong></td><td><strong>$${fmt(data.costBreakdown.totalCostPerPiece, 3)}</strong></td></tr>\n      </table>\n      \n      <h3>${lang === 'zh' ? '良率预测' : 'Yield Prediction'}</h3>\n      <table>\n        <tr><td>${lang === 'zh' ? '预期良率' : 'Expected Yield'}</td><td class=\"safe\"><strong>${fmt(data.yieldPrediction.expectedYield, 1)}%</strong></td></tr>\n        <tr><td>${lang === 'zh' ? '首次合格率' : 'First Pass Yield'}</td><td>${fmt(data.yieldPrediction.firstPassYield, 1)}%</td></tr>\n        <tr><td>${lang === 'zh' ? '报废率' : 'Scrap Rate'}</td><td>${fmt(data.yieldPrediction.scrapRate, 2)}%</td></tr>\n        <tr><td>Cpk</td><td>${fmt(data.yieldPrediction.cpk, 2)}</td></tr>\n        <tr><td>DPMO</td><td>${fmt(data.yieldPrediction.dpmo, 0)}</td></tr>\n        <tr><td>${lang === 'zh' ? 'Sigma水平' : 'Sigma Level'}</td><td>${fmt(data.yieldPrediction.sigmaLevel, 1)}σ</td></tr>\n      </table>\n      \n      <h3>${lang === 'zh' ? '风险评估' : 'Risk Assessment'}</h3>\n      <div class=\"status-banner ${data.riskFactors.riskLevel}\">\n        ${lang === 'zh' ? '总体风险等级' : 'Overall Risk Level'}: <strong>${data.riskFactors.riskLevel.toUpperCase()}</strong>\n        (${lang === 'zh' ? '评分' : 'Score'}: ${fmt(data.riskFactors.overallRiskScore, 0)}/100)\n      </div>\n      \n      ${data.recommendations.length > 0 ? `\n        <h3>${lang === 'zh' ? '优化建议' : 'Recommendations'}</h3>\n        <ul>\n          ${data.recommendations.map(r => `<li>${r}</li>`).join('')}\n        </ul>\n      ` : ''}\n    </div>\n  `;\n}\n\n/**\n * Generate Harmonic Response section\n */\nfunction generateHarmonicSection(data: HarmonicResponseResult, lang: 'en' | 'zh'): string {\n  return `\n    <div class=\"section\">\n      <h2>${lang === 'zh' ? '共振谐波响应分析' : 'Harmonic Response Analysis'}</h2>\n      \n      <h3>${lang === 'zh' ? '检测到的振动模态' : 'Detected Vibration Modes'}</h3>\n      <table>\n        <thead>\n          <tr>\n            <th>${lang === 'zh' ? '模态' : 'Mode'}</th>\n            <th>${lang === 'zh' ? '类型' : 'Type'}</th>\n            <th>${lang === 'zh' ? '频率' : 'Frequency'}</th>\n            <th>${lang === 'zh' ? '质量参与' : 'Mass Participation'}</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${data.detectedModes.slice(0, 6).map(mode => `\n            <tr>\n              <td>${mode.modeNumber}</td>\n              <td>${mode.type}</td>\n              <td><strong>${fmt(mode.frequency, 0)} Hz</strong></td>\n              <td>${fmt(mode.massParticipation, 0)}%</td>\n            </tr>\n          `).join('')}\n        </tbody>\n      </table>\n      \n      ${data.resonanceRisks.length > 0 ? `\n        <h3>${lang === 'zh' ? '共振风险' : 'Resonance Risks'}</h3>\n        ${data.resonanceRisks.map(risk => `\n          <div class=\"status-banner ${risk.riskLevel}\">\n            <strong>${risk.mode.type}</strong> @ ${fmt(risk.operatingFrequency, 0)} Hz: \n            ${lang === 'zh' ? '放大系数' : 'Amplification'} = ${fmt(risk.amplificationFactor, 1)}x\n            <br><span class=\"small\">${risk.recommendation}</span>\n          </div>\n        `).join('')}\n      ` : `\n        <div class=\"status-banner safe\">\n          ${lang === 'zh' ? '未检测到显著共振风险' : 'No significant resonance risks detected'}\n        </div>\n      `}\n      \n      <h3>${lang === 'zh' ? '安全频率范围' : 'Safe Frequency Bands'}</h3>\n      <ul>\n        ${data.safeFrequencyBands.map(band => `\n          <li>${fmt(band.min, 0)} - ${fmt(band.max, 0)} Hz</li>\n        `).join('')}\n      </ul>\n      \n      <div class=\"status-banner ${data.overallRisk}\">\n        ${lang === 'zh' ? '总体共振风险' : 'Overall Resonance Risk'}: <strong>${data.overallRisk.toUpperCase()}</strong>\n      </div>\n    </div>\n  `;\n}\n\n/**\n * Generate Hotspot Tracking section\n */\nfunction generateHotspotSection(data: HotspotTrackingResult, lang: 'en' | 'zh'): string {\n  return `\n    <div class=\"section\">\n      <h2>${lang === 'zh' ? '应力热点与断裂预测' : 'Stress Hotspots & Fracture Prediction'}</h2>\n      \n      <table>\n        <tr><td>${lang === 'zh' ? '总热点数' : 'Total Hotspots'}</td><td>${data.hotspots.length}</td></tr>\n        <tr><td>${lang === 'zh' ? '高风险热点' : 'Critical Hotspots'}</td><td class=\"${data.criticalHotspots.length > 0 ? 'danger' : ''}\">${data.criticalHotspots.length}</td></tr>\n        <tr><td>${lang === 'zh' ? '裂纹萌生点' : 'Nucleation Sites'}</td><td>${data.nucleationSites.length}</td></tr>\n      </table>\n      \n      ${data.criticalHotspots.length > 0 ? `\n        <h3>${lang === 'zh' ? '高风险热点详情' : 'Critical Hotspot Details'}</h3>\n        <table>\n          <thead>\n            <tr>\n              <th>${lang === 'zh' ? '位置' : 'Location'}</th>\n              <th>${lang === 'zh' ? '类型' : 'Type'}</th>\n              <th>${lang === 'zh' ? 'Von Mises应力' : 'Von Mises'}</th>\n              <th>Kt</th>\n              <th>${lang === 'zh' ? '风险' : 'Risk'}</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${data.criticalHotspots.slice(0, 5).map(h => `\n              <tr>\n                <td>${fmt(h.axialPosition * 100, 0)}%</td>\n                <td>${h.locationType}</td>\n                <td>${fmt(h.vonMisesStress, 0)} MPa</td>\n                <td>${fmt(h.stressConcentrationFactor, 2)}</td>\n                <td class=\"status-banner ${h.riskLevel}\">${h.riskLevel}</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n      ` : ''}\n      \n      ${data.nucleationSites.length > 0 ? `\n        <h3>${lang === 'zh' ? '裂纹萌生预测' : 'Crack Nucleation Prediction'}</h3>\n        <table>\n          <thead>\n            <tr>\n              <th>${lang === 'zh' ? '机制' : 'Mechanism'}</th>\n              <th>${lang === 'zh' ? '方向' : 'Direction'}</th>\n              <th>${lang === 'zh' ? '萌生周次' : 'Initiation Cycles'}</th>\n              <th>${lang === 'zh' ? '扩展速率' : 'Growth Rate'}</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${data.nucleationSites.slice(0, 3).map(site => `\n              <tr>\n                <td>${site.mechanism}</td>\n                <td>${site.growthDirection}</td>\n                <td>${site.initiationCycles.toExponential(1)}</td>\n                <td>${site.growthRate.toExponential(1)} mm/cycle</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n      ` : ''}\n      \n      <div class=\"status-banner ${data.overallRisk}\">\n        ${lang === 'zh' ? '总体断裂风险' : 'Overall Fracture Risk'}: <strong>${data.overallRisk.toUpperCase()}</strong>\n      </div>\n      \n      ${data.recommendations.length > 0 ? `\n        <h3>${lang === 'zh' ? '建议' : 'Recommendations'}</h3>\n        <ul>\n          ${data.recommendations.map(r => `<li>${r}</li>`).join('')}\n        </ul>\n      ` : ''}\n    </div>\n  `;\n}\n\n/**\n * Generate complete advanced report HTML\n */\nexport function generateAdvancedReportHTML(data: AdvancedReportData): string {\n  const { config, geometry, workingConditions, results, advanced, phase6, phase7 } = data;\n  const lang = config.language === 'en' ? 'en' : 'zh';\n  \n  const material = getSpringMaterial(geometry.materialId);\n  const materialName = material \n    ? (lang === 'zh' ? material.nameZh : material.nameEn)\n    : geometry.materialId;\n\n  const styles = `\n    <style>\n      * { box-sizing: border-box; margin: 0; padding: 0; }\n      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 12px; line-height: 1.5; color: #333; padding: 20px; }\n      h1 { font-size: 24px; margin-bottom: 10px; color: #1a365d; }\n      h2 { font-size: 16px; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 2px solid #3182ce; color: #2c5282; }\n      h3 { font-size: 14px; margin: 15px 0 8px; color: #4a5568; }\n      table { width: 100%; border-collapse: collapse; margin: 10px 0; }\n      th, td { padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0; }\n      th { background: #f7fafc; font-weight: 600; }\n      .section { margin-bottom: 25px; page-break-inside: avoid; }\n      .status-banner { padding: 12px; border-radius: 6px; margin: 10px 0; font-weight: 500; }\n      .status-banner.safe, .status-banner.success { background: #c6f6d5; color: #22543d; }\n      .status-banner.warning, .status-banner.medium { background: #fefcbf; color: #744210; }\n      .status-banner.danger, .status-banner.high, .status-banner.critical { background: #fed7d7; color: #742a2a; }\n      .status-banner.failure { background: #742a2a; color: white; }\n      .status-banner.low { background: #bee3f8; color: #2a4365; }\n      .verdict-banner { text-align: center; padding: 20px; border-radius: 8px; margin: 15px 0; }\n      .verdict-banner.pass { background: #c6f6d5; }\n      .verdict-banner.conditional-pass { background: #fefcbf; }\n      .verdict-banner.fail { background: #fed7d7; }\n      .verdict-status { font-size: 28px; font-weight: bold; }\n      .verdict-message { margin-top: 8px; }\n      .safe { color: #22543d; }\n      .warning { color: #744210; background: #fefcbf; }\n      .danger, .critical, .high { color: #742a2a; background: #fed7d7; }\n      .mono { font-family: monospace; font-size: 11px; }\n      .muted { color: #718096; font-size: 11px; }\n      .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; font-size: 10px; margin-left: 8px; }\n      .small { font-size: 11px; }\n      ul { margin: 10px 0; padding-left: 20px; }\n      li { margin: 5px 0; }\n      code { background: #edf2f7; padding: 2px 6px; border-radius: 3px; font-size: 11px; }\n      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #3182ce; }\n      .logo { font-size: 20px; font-weight: bold; color: #3182ce; }\n      .date { color: #718096; }\n      @media print { body { padding: 0; } .section { page-break-inside: avoid; } }\n    </style>\n  `;\n\n  let sectionsHTML = '';\n  \n  // Basic geometry and results sections\n  sectionsHTML += `\n    <div class=\"section\">\n      <h2>${lang === 'zh' ? '弹簧参数' : 'Spring Parameters'}</h2>\n      <table>\n        <tr><td>${lang === 'zh' ? '类型' : 'Type'}</td><td><strong>${getTypeName(geometry.type, lang)}</strong></td></tr>\n        <tr><td>${lang === 'zh' ? '材料' : 'Material'}</td><td>${materialName}</td></tr>\n        <tr><td>${lang === 'zh' ? '线径 d' : 'Wire Diameter d'}</td><td>${geometry.wireDiameter} mm</td></tr>\n        <tr><td>${lang === 'zh' ? '有效圈数 Na' : 'Active Coils Na'}</td><td>${geometry.activeCoils}</td></tr>\n      </table>\n    </div>\n    \n    <div class=\"section\">\n      <h2>${lang === 'zh' ? '应力分析' : 'Stress Analysis'}</h2>\n      <table>\n        <tr><td>${lang === 'zh' ? '有效应力 τ_eff' : 'Effective Stress τ_eff'}</td><td><strong>${fmt(results.stress.tauEffective, 1)} MPa</strong></td></tr>\n        <tr><td>${lang === 'zh' ? 'Wahl 系数' : 'Wahl Factor'}</td><td>${fmt(results.stress.wahlFactor, 3)}</td></tr>\n        <tr><td>${lang === 'zh' ? '静态安全系数' : 'Static Safety Factor'}</td><td class=\"${results.safety.staticSafetyFactor >= 1.5 ? 'safe' : 'warning'}\">${fmt(results.safety.staticSafetyFactor, 2)}</td></tr>\n      </table>\n    </div>\n    \n    <div class=\"section\">\n      <h2>${lang === 'zh' ? '疲劳分析' : 'Fatigue Analysis'}</h2>\n      <table>\n        <tr><td>${lang === 'zh' ? '平均应力 τ_m' : 'Mean Stress τ_m'}</td><td>${fmt(results.fatigue.tauMean, 1)} MPa</td></tr>\n        <tr><td>${lang === 'zh' ? '交变应力 τ_a' : 'Alternating Stress τ_a'}</td><td>${fmt(results.fatigue.tauAlt, 1)} MPa</td></tr>\n        <tr><td>${lang === 'zh' ? '疲劳安全系数' : 'Fatigue Safety Factor'}</td><td>${fmt(results.fatigue.infiniteLifeSafetyFactor, 2)}</td></tr>\n        <tr><td>${lang === 'zh' ? '预计寿命' : 'Estimated Life'}</td><td>${results.fatigue.estimatedCycles > 1e8 ? '∞' : results.fatigue.estimatedCycles.toExponential(2)} cycles</td></tr>\n      </table>\n    </div>\n  `;\n  \n  // Advanced sections\n  if (advanced?.stressDistribution && config.includeStressMap !== false) {\n    sectionsHTML += generateStressDistributionSection(advanced.stressDistribution, lang);\n  }\n  \n  if (advanced?.fatigueDamage && config.includeDamageMap !== false) {\n    sectionsHTML += generateFatigueDamageSection(advanced.fatigueDamage, lang);\n  }\n  \n  if (advanced?.diagnostics && config.includeDiagnostics !== false) {\n    sectionsHTML += generateDiagnosticsSection(advanced.diagnostics, lang);\n  }\n  \n  if (advanced?.suggestions && config.includeSuggestions !== false) {\n    sectionsHTML += generateSuggestionsSection(advanced.suggestions, lang);\n  }\n  \n  if (advanced?.optimization && config.includeOptimization !== false) {\n    sectionsHTML += generateOptimizationSection(advanced.optimization, lang);\n  }\n  \n  if (advanced?.verdict) {\n    sectionsHTML += generateVerdictSection(advanced.verdict, lang);\n  }\n\n  // Phase 6 sections\n  if (phase6?.coilingProcess || phase6?.shotPeening || phase6?.scragTest) {\n    sectionsHTML += generateManufacturingSection(\n      phase6.coilingProcess,\n      phase6.shotPeening,\n      phase6.scragTest,\n      lang\n    );\n  }\n\n  if (phase6?.manufacturability) {\n    sectionsHTML += generateManufacturabilitySection(phase6.manufacturability, lang);\n  }\n\n  if (phase6?.standardsCheck && (phase6.standardsCheck.asme || phase6.standardsCheck.sae || phase6.standardsCheck.din)) {\n    sectionsHTML += generateStandardsSection(phase6.standardsCheck, lang);\n  }\n\n  if (phase6?.mlFatiguePrediction) {\n    sectionsHTML += generateMLFatigueSection(phase6.mlFatiguePrediction, lang);\n  }\n\n  if (phase6?.materialRecommendation) {\n    sectionsHTML += generateMaterialRecommendationSection(phase6.materialRecommendation, lang);\n  }\n\n  // Phase 7 Digital Twin sections\n  if (phase7?.crackInitiation || phase7?.corrosion || phase7?.healthDegradation) {\n    sectionsHTML += generateDigitalTwinSection(phase7, lang);\n  }\n\n  if (phase7?.costYield) {\n    sectionsHTML += generateCostYieldSection(phase7.costYield, lang);\n  }\n\n  if (phase7?.harmonicResponse) {\n    sectionsHTML += generateHarmonicSection(phase7.harmonicResponse, lang);\n  }\n\n  if (phase7?.hotspotTracking) {\n    sectionsHTML += generateHotspotSection(phase7.hotspotTracking, lang);\n  }\n\n  return `\n<!DOCTYPE html>\n<html lang=\"${lang}\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>${lang === 'zh' ? '弹簧工程分析报告' : 'Spring Engineering Analysis Report'}</title>\n  ${styles}\n</head>\n<body>\n  <div class=\"header\">\n    <div class=\"logo\">${config.companyName || 'ISRI-SHUANGDI'}</div>\n    <div class=\"date\">${new Date().toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US')}</div>\n  </div>\n  \n  <h1>${lang === 'zh' ? '弹簧工程分析报告' : 'Spring Engineering Analysis Report'}</h1>\n  \n  ${sectionsHTML}\n  \n  <div class=\"section\" style=\"margin-top: 30px; padding-top: 15px; border-top: 1px solid #e2e8f0; color: #718096; font-size: 10px;\">\n    ${lang === 'zh' ? '本报告由 ISRI-SHUANGDI 弹簧工程平台自动生成' : 'This report was automatically generated by ISRI-SHUANGDI Spring Engineering Platform'}\n    <br>\n    ${lang === 'zh' ? '生成时间' : 'Generated'}: ${new Date().toISOString()}\n  </div>\n</body>\n</html>\n  `.trim();\n}\n\n/**\n * Print advanced report\n */\nexport function printAdvancedReport(data: AdvancedReportData): void {\n  const html = generateAdvancedReportHTML(data);\n  const printWindow = window.open('', '_blank');\n  if (printWindow) {\n    printWindow.document.write(html);\n    printWindow.document.close();\n    printWindow.focus();\n    setTimeout(() => printWindow.print(), 500);\n  }\n}\n\n/**\n * Download advanced report as HTML\n */\nexport function downloadAdvancedReport(data: AdvancedReportData, filename?: string): void {\n  const html = generateAdvancedReportHTML(data);\n  const blob = new Blob([html], { type: 'text/html' });\n  const url = URL.createObjectURL(blob);\n  const link = document.createElement('a');\n  link.href = url;\n  link.download = filename || `spring-advanced-report-${Date.now()}.html`;\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  URL.revokeObjectURL(url);\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/SpiralSpringReportDraftHtml.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/SpiralSpringReportDraftHtml.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/SpiralSpringReportTemplate.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/SpiralSpringReportTemplate.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/SpringReportGenerator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/compressionPpapReport.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/conicalReport.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ConicalNonlinearCurvePoint' is defined but never used.","line":6,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Conical Spring Design Report Data Structure and Utilities\n */\n\nimport type { \n  ConicalNonlinearCurvePoint, \n  ConicalNonlinearResult,\n  SafetyFactorResult,\n  FatigueLifeResult,\n  PreloadResult,\n} from \"@/lib/springMath\";\nimport type { SpringMaterialId } from \"@/lib/materials/springMaterials\";\n\n/**\n * Complete data structure for a conical spring design report.\n */\nexport interface ConicalDesignReportData {\n  designId?: string;\n  generatedAt: string;\n\n  // Basic parameters\n  largeDiameter: number;      // D1, mm\n  smallDiameter: number;      // D2, mm\n  wireDiameter: number;       // d, mm\n  activeCoils: number;        // Na\n  freeLength: number;         // L0, mm\n  shearModulus: number;       // G, MPa\n  maxDeflection: number;      // Δx_max, mm\n\n  // Derived geometry\n  solidHeight: number;        // H_solid = Na * d\n  totalDeflectionCapacity: number; // X_total = L0 - H_solid\n  pitch: number;              // mm per coil\n\n  // Final results\n  finalLoad: number;          // N\n  finalStiffness: number;     // N/mm\n  finalShearStress: number;   // MPa\n  finalActiveCoils: number;\n  finalCollapsedCoils: number;\n  safetyFactor?: number;      // If material allowable stress is known\n\n  // Stage transitions\n  stages: {\n    stage: number;\n    collapsedCoils: number;\n    activeCoils: number;\n    startDeflection: number;\n    stiffness: number;\n  }[];\n\n  // Key curve points (sampled)\n  curveKeyPoints: {\n    deflection: number;\n    load: number;\n    k: number;\n    activeCoils: number;\n  }[];\n\n  // Full curve (optional, for detailed export)\n  fullCurve?: {\n    deflection: number;\n    load: number;\n    k: number;\n    activeCoils: number;\n  }[];\n\n  // Notes\n  notes?: string;\n  exceededSolidHeight: boolean;\n\n  // Material and Safety (new fields)\n  material?: {\n    id: SpringMaterialId;\n    nameEn: string;\n    nameZh: string;\n    shearModulus: number;\n    allowShearStatic: number;\n  };\n\n  safetyAnalysis?: {\n    safetyFactor: SafetyFactorResult;\n    fatigueLife?: FatigueLifeResult;\n  };\n\n  preload?: PreloadResult;\n\n  // CAD export info\n  cadExport?: {\n    fileName?: string;\n    format?: string;\n    exportedAt?: string;\n  };\n}\n\n/**\n * Parameters for building the report data.\n */\nexport interface BuildReportParams {\n  largeDiameter: number;\n  smallDiameter: number;\n  wireDiameter: number;\n  activeCoils: number;\n  freeLength: number;\n  shearModulus: number;\n  maxDeflection: number;\n  nonlinearResult: ConicalNonlinearResult;\n  stages: {\n    stage: number;\n    deflection: number;\n    activeCoils: number;\n    stiffness: number;\n  }[];\n  allowableStress?: number; // MPa, for safety factor calculation\n}\n\n/**\n * Calculate shear stress for conical spring at a given load.\n * Uses Wahl factor correction.\n */\nfunction calculateShearStress(\n  load: number,\n  meanDiameter: number,\n  wireDiameter: number\n): number {\n  const springIndex = meanDiameter / wireDiameter;\n  const wahlFactor = (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;\n  const tau = wahlFactor * (8 * load * meanDiameter) / (Math.PI * Math.pow(wireDiameter, 3));\n  return tau;\n}\n\n/**\n * Build a complete ConicalDesignReportData object from calculation results.\n */\nexport function buildConicalDesignReportData(params: BuildReportParams): ConicalDesignReportData {\n  const {\n    largeDiameter,\n    smallDiameter,\n    wireDiameter,\n    activeCoils,\n    freeLength,\n    shearModulus,\n    maxDeflection,\n    nonlinearResult,\n    stages,\n    allowableStress,\n  } = params;\n\n  const curve = nonlinearResult.curve;\n  const finalPoint = curve[curve.length - 1];\n\n  // Calculate mean diameter at final state for stress calculation\n  // Use equivalent mean diameter based on remaining active coils\n  const collapseRatio = finalPoint.collapsedCoils / activeCoils;\n  const D1_mean = largeDiameter - wireDiameter;\n  const D2_mean = smallDiameter - wireDiameter;\n  const effectiveMeanDiameter = D1_mean - (D1_mean - D2_mean) * collapseRatio;\n\n  // Calculate final shear stress\n  const finalShearStress = calculateShearStress(\n    finalPoint.load,\n    effectiveMeanDiameter,\n    wireDiameter\n  );\n\n  // Calculate safety factor if allowable stress is provided\n  const safetyFactor = allowableStress ? allowableStress / finalShearStress : undefined;\n\n  // Sample key points from curve (0%, 25%, 50%, 75%, 100%)\n  const keyPointIndices = [0, 0.25, 0.5, 0.75, 1].map(pct => \n    Math.min(Math.floor(pct * (curve.length - 1)), curve.length - 1)\n  );\n  const curveKeyPoints = keyPointIndices.map(idx => ({\n    deflection: curve[idx].x,\n    load: curve[idx].load,\n    k: curve[idx].k,\n    activeCoils: curve[idx].activeCoils,\n  }));\n\n  // Map stages to report format\n  const reportStages = stages.map(s => ({\n    stage: s.stage,\n    collapsedCoils: s.stage, // stage number equals collapsed coils\n    activeCoils: s.activeCoils,\n    startDeflection: s.deflection,\n    stiffness: s.stiffness,\n  }));\n\n  return {\n    generatedAt: new Date().toISOString(),\n    \n    // Basic parameters\n    largeDiameter,\n    smallDiameter,\n    wireDiameter,\n    activeCoils,\n    freeLength,\n    shearModulus,\n    maxDeflection,\n\n    // Derived geometry\n    solidHeight: nonlinearResult.solidHeight,\n    totalDeflectionCapacity: nonlinearResult.totalDeflectionCapacity,\n    pitch: nonlinearResult.pitch,\n\n    // Final results\n    finalLoad: finalPoint.load,\n    finalStiffness: finalPoint.k,\n    finalShearStress,\n    finalActiveCoils: finalPoint.activeCoils,\n    finalCollapsedCoils: finalPoint.collapsedCoils,\n    safetyFactor,\n\n    // Stages\n    stages: reportStages,\n\n    // Key points\n    curveKeyPoints,\n\n    // Full curve (truncated to reasonable size)\n    fullCurve: curve.map(p => ({\n      deflection: p.x,\n      load: p.load,\n      k: p.k,\n      activeCoils: p.activeCoils,\n    })),\n\n    exceededSolidHeight: nonlinearResult.exceededSolidHeight,\n  };\n}\n\n/**\n * Generate a text summary for RFQ pre-fill.\n */\nexport function generateRfqSummary(data: ConicalDesignReportData): string {\n  return `Conical compression spring design:\n- Large OD: ${data.largeDiameter} mm, Small OD: ${data.smallDiameter} mm\n- Wire diameter: ${data.wireDiameter} mm\n- Active coils: ${data.activeCoils}, Free length: ${data.freeLength} mm\n- Max deflection: ${data.maxDeflection} mm\n- Final load: ${data.finalLoad.toFixed(2)} N at ${data.finalStiffness.toFixed(2)} N/mm\n- Progressive stiffness with ${data.finalCollapsedCoils} coils collapsed\n- Shear stress: ${data.finalShearStress.toFixed(1)} MPa${data.safetyFactor ? `, SF ≈ ${data.safetyFactor.toFixed(2)}` : \"\"}`;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/variablePitchCompressionReport.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/reports/variablePitchCompressionReportGenerator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/riskRadar/builders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/riskRadar/fromDesignRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/riskRadar/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/riskRadar/riskRadar.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/riskRadar/scoring.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/riskRadar/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spiralTorsion/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spiralTorsion/reportGenerator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/HookBuilder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/__tests__/waveSpringGeometry.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/arcSpringGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/compressionSpringGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/conicalSpringGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/extensionSpringGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/extrudeRectAlongCurve.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'startTheta' is assigned a value but never used.","line":467,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":467,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'endTheta' is assigned a value but never used.","line":468,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":468,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Rectangular Wire Extrusion Along Curve (Hard-Face + Bishop Frame)\n * 矩形线材沿曲线挤出（硬边版本 + 平行运输帧避免扭转）\n *\n * Goal:\n * - Die spring rectangular wire must look like real catalog: flat faces + sharp edges\n * - Avoid CatmullRom smoothing artifacts (use analytic helix)\n * - Use Bishop/Parallel-Transport frame instead of Frenet to prevent ribbon twist\n * - Non-indexed geometry ensures each face has its own vertices and flat normal\n */\n\nimport * as THREE from \"three\";\n\nexport interface ExtrudeRectParams {\n  curve: THREE.Curve<THREE.Vector3>;\n  width_b: number;       // radial width (mm)\n  thickness_t: number;   // axial thickness (mm)\n  segments?: number;\n  scale?: number;\n  caps?: boolean;\n  /** Global up vector for initial frame orientation */\n  up?: THREE.Vector3;\n}\n\n/**\n * Safe normalize that handles zero-length vectors\n */\nfunction safeNormalize(v: THREE.Vector3): THREE.Vector3 {\n  const len = v.length();\n  if (len < 1e-12) return v.set(1, 0, 0);\n  return v.multiplyScalar(1 / len);\n}\n\n/**\n * Compute Bishop/Parallel-Transport frames along a curve.\n * Unlike Frenet frames, Bishop frames don't \"spin\" on helices.\n * The cross-section orientation stays locked relative to the initial frame.\n */\nfunction computeBishopFrames(\n  curve: THREE.Curve<THREE.Vector3>,\n  segments: number,\n  upHint = new THREE.Vector3(0, 0, 1)\n): {\n  points: THREE.Vector3[];\n  tangents: THREE.Vector3[];\n  normals: THREE.Vector3[];\n  binormals: THREE.Vector3[];\n} {\n  const tangents: THREE.Vector3[] = [];\n  const normals: THREE.Vector3[] = [];\n  const binormals: THREE.Vector3[] = [];\n  const points: THREE.Vector3[] = [];\n\n  // Sample points + tangents\n  for (let i = 0; i <= segments; i++) {\n    const u = i / segments;\n    const p = curve.getPointAt(u);\n    points.push(p);\n\n    const t = curve.getTangentAt(u).clone();\n    safeNormalize(t);\n    tangents.push(t);\n  }\n\n  // Choose initial normal from upHint × tangent\n  let n0 = new THREE.Vector3().crossVectors(upHint, tangents[0]);\n  if (n0.length() < 1e-6) {\n    // Fallback if upHint parallel to tangent\n    n0 = new THREE.Vector3().crossVectors(new THREE.Vector3(0, 1, 0), tangents[0]);\n    if (n0.length() < 1e-6) {\n      n0 = new THREE.Vector3().crossVectors(new THREE.Vector3(1, 0, 0), tangents[0]);\n    }\n  }\n  safeNormalize(n0);\n\n  const b0 = new THREE.Vector3().crossVectors(tangents[0], n0);\n  safeNormalize(b0);\n\n  normals.push(n0);\n  binormals.push(b0);\n\n  // Parallel transport along segments\n  for (let i = 1; i <= segments; i++) {\n    const tPrev = tangents[i - 1];\n    const tCur = tangents[i];\n\n    // Rotation axis = tPrev × tCur\n    const axis = new THREE.Vector3().crossVectors(tPrev, tCur);\n    const axisLen = axis.length();\n\n    const nPrev = normals[i - 1].clone();\n\n    if (axisLen < 1e-8) {\n      // Tangents almost same -> keep normal\n      normals.push(nPrev);\n      const b = new THREE.Vector3().crossVectors(tCur, nPrev);\n      safeNormalize(b);\n      binormals.push(b);\n      continue;\n    }\n\n    axis.multiplyScalar(1 / axisLen);\n\n    // Angle between tangents\n    const dot = THREE.MathUtils.clamp(tPrev.dot(tCur), -1, 1);\n    const angle = Math.acos(dot);\n\n    // Rotate previous normal around axis by angle\n    const q = new THREE.Quaternion().setFromAxisAngle(axis, angle);\n    const nCur = nPrev.applyQuaternion(q);\n    safeNormalize(nCur);\n\n    normals.push(nCur);\n\n    const bCur = new THREE.Vector3().crossVectors(tCur, nCur);\n    safeNormalize(bCur);\n    binormals.push(bCur);\n  }\n\n  return { points, tangents, normals, binormals };\n}\n\n/**\n * Hard-face rectangular extrusion with Bishop frames:\n * - non-indexed geometry (each quad has its own vertices)\n * - each quad has a constant (flat) normal\n * - Bishop frame prevents ribbon twist on helices\n *\n * This guarantees the cross-section looks rectangular (not rounded or twisted).\n */\nexport function extrudeRectAlongCurve(params: ExtrudeRectParams): THREE.BufferGeometry {\n  const {\n    curve,\n    width_b,\n    thickness_t,\n    segments = 400,\n    scale = 1,\n    caps = true,\n    up = new THREE.Vector3(0, 0, 1),\n  } = params;\n\n  const hw = (width_b * scale) / 2;       // half width\n  const ht = (thickness_t * scale) / 2;   // half thickness\n\n  // Corners in local (N,B) plane order (CCW):\n  // 0: (-hw,-ht), 1:(+hw,-ht), 2:(+hw,+ht), 3:(-hw,+ht)\n  const corners = [\n    new THREE.Vector2(-hw, -ht),\n    new THREE.Vector2(+hw, -ht),\n    new THREE.Vector2(+hw, +ht),\n    new THREE.Vector2(-hw, +ht),\n  ];\n\n  // Use Bishop frames (no twist) instead of Frenet frames\n  const frames = computeBishopFrames(curve, segments, up);\n\n  // Ring points (world-space)\n  const ringPts: THREE.Vector3[][] = [];\n  for (let i = 0; i <= segments; i++) {\n    const P = frames.points[i];\n    const N = frames.normals[i];\n    const B = frames.binormals[i];\n\n    const ring: THREE.Vector3[] = [];\n    for (let k = 0; k < 4; k++) {\n      const c = corners[k];\n      ring.push(\n        new THREE.Vector3(\n          P.x + N.x * c.x + B.x * c.y,\n          P.y + N.y * c.x + B.y * c.y,\n          P.z + N.z * c.x + B.z * c.y\n        )\n      );\n    }\n    ringPts.push(ring);\n  }\n\n  // Build non-indexed triangles\n  const positions: number[] = [];\n  const normals: number[] = [];\n  const uvs: number[] = [];\n\n  const pushTri = (\n    a: THREE.Vector3, b: THREE.Vector3, c: THREE.Vector3,\n    n: THREE.Vector3,\n    ua: number, ub: number, uc: number,\n    va: number, vb: number, vc: number\n  ) => {\n    positions.push(a.x, a.y, a.z, b.x, b.y, b.z, c.x, c.y, c.z);\n    normals.push(n.x, n.y, n.z, n.x, n.y, n.z, n.x, n.y, n.z);\n    uvs.push(ua, va, ub, vb, uc, vc);\n  };\n\n  for (let i = 0; i < segments; i++) {\n    const u0 = i / segments;\n    const u1 = (i + 1) / segments;\n\n    const A = ringPts[i];\n    const B = ringPts[i + 1];\n\n    // 4 faces: (0-1), (1-2), (2-3), (3-0)\n    for (let f = 0; f < 4; f++) {\n      const f2 = (f + 1) % 4;\n\n      const a0 = A[f];\n      const a1 = A[f2];\n      const b1 = B[f2];\n      const b0 = B[f];\n\n      // Face normal (flat) from quad (a0->a1, a0->b0)\n      const e1 = new THREE.Vector3().subVectors(a1, a0);\n      const e2 = new THREE.Vector3().subVectors(b0, a0);\n      const n = new THREE.Vector3().crossVectors(e1, e2).normalize();\n\n      // Two triangles (a0,a1,b1) and (a0,b1,b0)\n      // UV: u along length, v around section\n      const v0 = f / 4;\n      const v1 = f2 / 4;\n\n      pushTri(a0, a1, b1, n, u0, u0, u1, v0, v1, v1);\n      pushTri(a0, b1, b0, n, u0, u1, u1, v0, v1, v0);\n    }\n  }\n\n  // Optional caps (also hard-face)\n  if (caps) {\n    // Start cap uses -tangent\n    {\n      const P = frames.points[0];\n      const t = frames.tangents[0].clone().normalize().multiplyScalar(-1);\n      const ring = ringPts[0];\n\n      for (let f = 0; f < 4; f++) {\n        const f2 = (f + 1) % 4;\n        const a = ring[f2];\n        const b = ring[f];\n        pushTri(P, a, b, t, 0, 0, 0, 0.5, 0, 1);\n      }\n    }\n\n    // End cap uses +tangent\n    {\n      const P = frames.points[segments];\n      const t = frames.tangents[segments].clone().normalize();\n      const ring = ringPts[segments];\n\n      for (let f = 0; f < 4; f++) {\n        const f2 = (f + 1) % 4;\n        const a = ring[f];\n        const b = ring[f2];\n        pushTri(P, a, b, t, 1, 1, 1, 0.5, 0, 1);\n      }\n    }\n  }\n\n  const geom = new THREE.BufferGeometry();\n  geom.setAttribute(\"position\", new THREE.Float32BufferAttribute(positions, 3));\n  geom.setAttribute(\"normal\", new THREE.Float32BufferAttribute(normals, 3));\n  geom.setAttribute(\"uv\", new THREE.Float32BufferAttribute(uvs, 2));\n  // non-indexed by design - each face has its own vertices\n  geom.computeBoundingSphere();\n\n  return geom;\n}\n\n/**\n * Analytic Helix Curve (strict)\n * 严格螺旋线（方程表达），避免 CatmullRom 平滑造成的 frame 漂移/形变\n */\nexport class HelixCurve extends THREE.Curve<THREE.Vector3> {\n  private R: number;\n  private L: number;\n  private turns: number;\n\n  constructor(params: { meanDiameter: number; coils: number; freeLength: number; scale?: number }) {\n    super();\n    const { meanDiameter, coils, freeLength, scale = 1 } = params;\n    this.R = (meanDiameter / 2) * scale;\n    this.L = freeLength * scale;\n    this.turns = Math.max(0.0001, coils);\n  }\n\n  getPoint(t: number, target = new THREE.Vector3()): THREE.Vector3 {\n    const theta = 2 * Math.PI * this.turns * t;\n    const z = this.L * t;\n    const x = this.R * Math.cos(theta);\n    const y = this.R * Math.sin(theta);\n    return target.set(x, y, z);\n  }\n\n  // Provide stable tangent (helps Frenet frames)\n  getTangent(t: number, target = new THREE.Vector3()): THREE.Vector3 {\n    const theta = 2 * Math.PI * this.turns * t;\n    const dTheta = 2 * Math.PI * this.turns;\n    // derivatives wrt t\n    const dx = -this.R * Math.sin(theta) * dTheta;\n    const dy = this.R * Math.cos(theta) * dTheta;\n    const dz = this.L;\n    return target.set(dx, dy, dz).normalize();\n  }\n}\n\n/**\n * Create a helix curve for die spring (analytic version)\n */\nexport function createHelixCurve(params: {\n  meanDiameter: number;\n  coils: number;\n  freeLength: number;\n  scale?: number;\n}): HelixCurve {\n  return new HelixCurve(params);\n}\n\nexport type DieSpringEndStyleGeom = \"open\" | \"closed\" | \"closed_ground\";\n\n/**\n * Build die spring geometry with FIXED FRAME (no rotation)\n * 固定坐标系挤出（截面不旋转）\n * \n * Key insight: For die springs, the cross-section should NOT rotate with Frenet/Bishop frames.\n * Instead, use a fixed coordinate system:\n * - R = radial direction [cos(θ), sin(θ), 0] - wire width direction\n * - U = axial direction [0, 0, 1] - wire thickness direction\n * \n * This ensures the rectangular wire looks like \"wound on edge\" with consistent orientation.\n * \n * End styles:\n * - open: No end treatment\n * - closed: Dead coils at ends (pitch reduces)\n * - closed_ground: Dead coils + ground flat (z-flatten at ends)\n */\nexport function buildDieSpringGeometryFixedFrame(params: {\n  meanDiameter: number;  // mm\n  coils: number;         // total coils\n  freeLength: number;    // mm\n  wire_b: number;        // radial width (mm)\n  wire_t: number;        // axial thickness (mm)\n  segmentsPerCoil?: number;\n  scale?: number;\n  caps?: boolean;\n  endStyle?: DieSpringEndStyleGeom;\n  endGrindTurns?: number;  // turns per end to grind flat (default 0.25)\n}): THREE.BufferGeometry {\n  const {\n    meanDiameter,\n    coils,\n    freeLength,\n    wire_b,\n    wire_t,\n    segmentsPerCoil = 120,\n    scale = 1,\n    caps = true,\n    endStyle = \"closed_ground\",\n  } = params;\n\n  const Rm = (meanDiameter * 0.5) * scale;\n  const L = freeLength * scale;\n\n  const hw = (wire_b * scale) / 2;   // half width (radial)\n  const ht = (wire_t * scale) / 2;   // half thickness (axial)\n\n  const Nt = coils;  // total coils\n\n  // End coil parameters - CRITICAL for realistic die spring appearance\n  // Real die springs have \"closed\" end coils where pitch → 0\n  const doGrind = endStyle === \"closed_ground\" || endStyle === \"closed\";\n\n  // closedTurnsPerEnd: how many turns at each end have pitch → 0 (closed/dead coils)\n  // Direct parameter: 1.5 turns gives realistic \"last coil lies flat\" appearance\n  // No indirect mapping - this is the actual number of closed turns per end\n  const closedTurnsPerEnd = doGrind ? 1.5 : 0;\n\n  // Active turns = total - 2 * closed turns per end\n  const activeTurns = Math.max(0.5, Nt - 2 * closedTurnsPerEnd);\n\n  // Total angle - full coils, NO reduction (real die springs have complete coils)\n  const totalAngle = 2 * Math.PI * Nt;\n  // Higher segment count for smoother end coil transitions\n  const segments = Math.max(60, Math.floor(Nt * Math.max(segmentsPerCoil, 200)));\n\n  // Closed zone angle (per end)\n  const thetaClosed = 2 * Math.PI * closedTurnsPerEnd;\n\n  // Active zone pitch: distribute remaining height over active turns\n  // seatHeight = height occupied by closed coils (approximately wire thickness)\n  const seatHeight = wire_t * scale * 0.9;  // closed coils occupy ~0.9t each\n  const activeHeight = Math.max(0, L - 2 * seatHeight);\n  const pActive = activeTurns > 0 ? activeHeight / activeTurns : L / Nt;\n\n  // Smoothstep function for smooth transition\n  const smoothstep = (edge0: number, edge1: number, x: number): number => {\n    const t = Math.max(0, Math.min(1, (x - edge0) / (edge1 - edge0)));\n    return t * t * (3 - 2 * t);\n  };\n\n  // Pitch function p(θ) - returns pitch at angle θ\n  // Start zone: θ ∈ [0, thetaClosed] → pitch ramps from 0 to pActive\n  // Active zone: θ ∈ [thetaClosed, totalAngle - thetaClosed] → pitch = pActive\n  // End zone: θ ∈ [totalAngle - thetaClosed, totalAngle] → pitch ramps from pActive to 0\n  const pitchAtTheta = (theta: number): number => {\n    if (!doGrind) return L / Nt;  // uniform pitch for open springs\n\n    if (theta < thetaClosed) {\n      // Start closed zone: ramp from 0 to pActive (w: 0→1)\n      const w = smoothstep(0, thetaClosed, theta);\n      return pActive * w;\n    }\n    if (theta > totalAngle - thetaClosed) {\n      // End closed zone: ramp from pActive to 0\n      // FIXED: Use forward interval smoothstep, then (1-w) to get pActive→0\n      const w = smoothstep(totalAngle - thetaClosed, totalAngle, theta);  // w: 0→1\n      return pActive * (1 - w);  // pitch: pActive→0\n    }\n    // Active zone\n    return pActive;\n  };\n\n  // 4 corners in local (R, U) plane - fixed orientation\n  const localCorners = [\n    { x: -hw, y: -ht }, // bottom-left\n    { x: +hw, y: -ht }, // bottom-right\n    { x: +hw, y: +ht }, // top-right\n    { x: -hw, y: +ht }, // top-left\n  ];\n\n  // Build non-indexed triangles (hard faces)\n  const positions: number[] = [];\n  const normals: number[] = [];\n  const uvs: number[] = [];\n\n  const pushTri = (\n    a: THREE.Vector3, b: THREE.Vector3, c: THREE.Vector3,\n    n: THREE.Vector3,\n    ua: number, ub: number, uc: number,\n    va: number, vb: number, vc: number\n  ) => {\n    positions.push(a.x, a.y, a.z, b.x, b.y, b.z, c.x, c.y, c.z);\n    normals.push(n.x, n.y, n.z, n.x, n.y, n.z, n.x, n.y, n.z);\n    uvs.push(ua, va, ub, vb, uc, vc);\n  };\n\n  // Compute z by integrating pitch function p(θ)\n  // z(θ) = ∫ (p(θ)/(2π)) dθ\n  // This ensures end coils \"close up\" when pitch → 0\n  const zValues: number[] = [];\n  let zAccum = 0;\n  const dTheta = totalAngle / segments;\n\n  for (let i = 0; i <= segments; i++) {\n    if (i === 0) {\n      zValues.push(0);\n    } else {\n      const theta = i * dTheta;\n      const thetaMid = theta - dTheta / 2;  // midpoint for better integration\n      const p = pitchAtTheta(thetaMid);\n      // dz = (pitch / 2π) * dθ\n      const dz = (p / (2 * Math.PI)) * dTheta;\n      zAccum += dz;\n      zValues.push(zAccum);\n    }\n  }\n\n\n\n  // Store first and last radial directions for frame locking at ends\n  const startTheta = 0;\n  const endTheta = totalAngle;\n\n\n  // Generate ring points with FIXED frame\n  // Lock frame direction at closed end zones to prevent twisting\n  const ringPts: THREE.Vector3[][] = [];\n  const ringRadDirs: THREE.Vector3[] = [];  // Store Rad directions for continuity check\n\n  for (let i = 0; i <= segments; i++) {\n    const s = i / segments;\n    const theta = s * totalAngle;\n    const z = zValues[i];\n\n    const cx = Rm * Math.cos(theta);\n    const cy = Rm * Math.sin(theta);\n\n    // Determine radial direction\n    // At closed ends, blend toward locked direction to prevent visual twisting\n    // Determine radial direction\n    // At closed ends, blend toward locked direction to prevent visual twisting\n    const Up = new THREE.Vector3(0, 0, 1);\n    const currentRad = new THREE.Vector3(Math.cos(theta), Math.sin(theta), 0);\n\n    // SIMPLIFIED: Always use currentRad (actual radial direction at this theta)\n    // The dot continuity check below prevents sign flips\n    // No need to lerp toward startRad/endRad - that can cause shape distortion\n    // especially when coils is not an integer\n    const Rad = currentRad.clone();\n\n    // CRITICAL: Normalize after lerp (lerp can produce non-unit vectors)\n    Rad.normalize();\n\n    // CRITICAL: Enforce continuous direction to prevent sign flip / face inversion\n    if (i > 0) {\n      const prevRad = ringRadDirs[i - 1];\n      if (prevRad.dot(Rad) < 0) {\n        Rad.multiplyScalar(-1);\n      }\n    }\n    ringRadDirs.push(Rad.clone());\n\n    const P = new THREE.Vector3(cx, cy, z);\n\n    const ring: THREE.Vector3[] = [];\n    for (let j = 0; j < 4; j++) {\n      const c = localCorners[j];\n      const V = new THREE.Vector3()\n        .copy(P)\n        .addScaledVector(Rad, c.x)\n        .addScaledVector(Up, c.y);\n      ring.push(V);\n    }\n    ringPts.push(ring);\n  }\n\n  // Build faces (non-indexed, each quad has its own vertices)\n  for (let i = 0; i < segments; i++) {\n    const u0 = i / segments;\n    const u1 = (i + 1) / segments;\n\n    const A = ringPts[i];\n    const B = ringPts[i + 1];\n\n    // 4 faces per segment: (0-1), (1-2), (2-3), (3-0)\n    for (let f = 0; f < 4; f++) {\n      const f2 = (f + 1) % 4;\n\n      const a0 = A[f];\n      const a1 = A[f2];\n      const b1 = B[f2];\n      const b0 = B[f];\n\n      // Face normal (flat)\n      const e1 = new THREE.Vector3().subVectors(a1, a0);\n      const e2 = new THREE.Vector3().subVectors(b0, a0);\n      const n = new THREE.Vector3().crossVectors(e1, e2).normalize();\n\n      const v0 = f / 4;\n      const v1 = f2 / 4;\n\n      pushTri(a0, a1, b1, n, u0, u0, u1, v0, v1, v1);\n      pushTri(a0, b1, b0, n, u0, u1, u1, v0, v1, v0);\n    }\n  }\n\n  // Caps (hard-face)\n  if (caps) {\n    // Start cap - at ground ends, the wire lies flat so cap normal is -Z\n    {\n      const theta = 0;\n      const cx = Rm * Math.cos(theta);\n      const cy = Rm * Math.sin(theta);\n      const zStart = zValues[0];\n      const P = new THREE.Vector3(cx, cy, zStart);\n\n      // For ground ends, cap faces down (-Z); for open ends, use tangent\n      const t = doGrind\n        ? new THREE.Vector3(0, 0, -1)\n        : new THREE.Vector3(\n          -Rm * Math.sin(theta) * 2 * Math.PI * Nt,\n          Rm * Math.cos(theta) * 2 * Math.PI * Nt,\n          L\n        ).normalize().multiplyScalar(-1);\n\n      const ring = ringPts[0];\n      for (let f = 0; f < 4; f++) {\n        const f2 = (f + 1) % 4;\n        const a = ring[f2];\n        const b = ring[f];\n        pushTri(P, a, b, t, 0, 0, 0, 0.5, 0, 1);\n      }\n    }\n\n    // End cap - at ground ends, the wire lies flat so cap normal is +Z\n    {\n      const theta = totalAngle;\n      const cx = Rm * Math.cos(theta);\n      const cy = Rm * Math.sin(theta);\n      const zEnd = zValues[segments];\n      const P = new THREE.Vector3(cx, cy, zEnd);\n\n      // For ground ends, cap faces up (+Z); for open ends, use tangent\n      const t = doGrind\n        ? new THREE.Vector3(0, 0, 1)\n        : new THREE.Vector3(\n          -Rm * Math.sin(theta) * 2 * Math.PI * Nt,\n          Rm * Math.cos(theta) * 2 * Math.PI * Nt,\n          L\n        ).normalize();\n\n      const ring = ringPts[segments];\n      for (let f = 0; f < 4; f++) {\n        const f2 = (f + 1) % 4;\n        const a = ring[f];\n        const b = ring[f2];\n        pushTri(P, a, b, t, 1, 1, 1, 0.5, 0, 1);\n      }\n    }\n  }\n\n  const geom = new THREE.BufferGeometry();\n  geom.setAttribute(\"position\", new THREE.Float32BufferAttribute(positions, 3));\n  geom.setAttribute(\"normal\", new THREE.Float32BufferAttribute(normals, 3));\n  geom.setAttribute(\"uv\", new THREE.Float32BufferAttribute(uvs, 2));\n  geom.computeBoundingSphere();\n\n  return geom;\n}\n\n/**\n * Build die spring geometry with rectangular wire cross-section\n * Uses fixed frame (no rotation) for proper die spring appearance\n */\nexport function buildDieSpringGeometry(params: {\n  meanDiameter: number;\n  coils: number;\n  freeLength: number;\n  wire_b: number;\n  wire_t: number;\n  scale?: number;\n  endStyle?: DieSpringEndStyleGeom;\n  endGrindTurns?: number;\n}): THREE.BufferGeometry {\n  return buildDieSpringGeometryFixedFrame({\n    ...params,\n    segmentsPerCoil: 140,\n    caps: true,\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringAdvanced.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringAnalysis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringCloseout.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringFatigue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringFormulas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringMaterials.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringModules.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringReview.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralSpringTolerance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/spiralTorsionGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/suspensionSpringGeometry.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'endSpec' is defined but never used.","line":352,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":352,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'yMax' is assigned a value but never used.","line":361,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":361,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Suspension Spring 3D Geometry Builder\n * 减震器弹簧/悬架弹簧几何生成器\n * \n * Capability:\n * - Variable Pitch (Progressive)\n * - Variable Diameter (Barrel, Conical)\n * - End Closed Coils (Dead Coils) with smooth transition\n * - Ground flattening (端面磨平贴合)\n * - Realistic Load Compression (Preload / Ride / Bump)\n */\n\nimport * as THREE from \"three\";\nimport type { PitchProfile, DiameterProfile, SuspensionEndSpec } from \"@/lib/springTypes\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface SuspensionSpringGeometryInput {\n    wireDiameter: number;\n    activeCoils: number;\n    totalCoils: number;\n    freeLength: number;\n    pitchProfile: PitchProfile;\n    diameterProfile: DiameterProfile;\n\n    // 3D Display Params\n    segmentsPerCoil?: number; // default 80\n    radialSegments?: number;  // default 12 for tube\n\n    // Load State\n    loadState?: \"free\" | \"preload\" | \"ride\" | \"bump\";\n    targetHeight?: number; // Override height for specific load state\n}\n\nexport interface SuspensionSpringGeometryResult {\n    geometry: THREE.BufferGeometry;\n    curvepoints: THREE.Vector3[];\n    wireLength: number;\n    boundingBox: THREE.Box3;\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\nfunction smoothstep01(x: number): number {\n    const t = Math.max(0, Math.min(1, x));\n    return t * t * (3 - 2 * t);\n}\n\nfunction lerp(a: number, b: number, t: number): number {\n    return a + (b - a) * t;\n}\n\n// ============================================================================\n// End Specification Resolver\n// ============================================================================\n\nfunction resolveEndSpec(prof: PitchProfile): SuspensionEndSpec {\n    // If endSpec is provided, use it\n    if (prof.endSpec) {\n        return prof.endSpec;\n    }\n\n    // Fallback to simple endType + endClosedTurns\n    const endType = prof.endType ?? \"closed_ground\";\n    const closedTurnsPerEnd = prof.endClosedTurns ?? 1.0;\n\n    return {\n        type: endType,\n        closedTurnsPerEnd,\n        groundTurnsPerEnd: endType === \"closed_ground\" ? 0.5 : 0,\n        seatDrop: 0,\n        endAngleExtra: 0,\n    };\n}\n\n// ============================================================================\n// Pitch Weight Function (wPitch)\n// ============================================================================\n\n/**\n * wPitch: Returns a weight from 0 to 1 for pitch scaling.\n * - At closed end zones: 0 → 1 (ramp up)\n * - In active zone: 1\n * - At closed end zones: 1 → 0 (ramp down)\n */\nfunction wPitch(theta: number, thetaClosed: number, thetaTotal: number): number {\n    if (thetaClosed <= 0) return 1; // No closed ends\n\n    // Start closed zone: 0 -> thetaClosed\n    if (theta < thetaClosed) {\n        return smoothstep01(theta / thetaClosed);\n    }\n\n    // End closed zone: (thetaTotal - thetaClosed) -> thetaTotal\n    if (theta > thetaTotal - thetaClosed) {\n        const u = (thetaTotal - theta) / thetaClosed;\n        return smoothstep01(u);\n    }\n\n    return 1;\n}\n\n/**\n * Calculate pitch at specific theta (radians)\n * Uses wPitch weight for proper closed-coil integration\n */\nfunction pitchAtTheta(\n    theta: number,\n    Nt: number,\n    prof: PitchProfile,\n    pitchActive: number,\n    endSpec: SuspensionEndSpec\n): number {\n    const thetaTotal = 2 * Math.PI * Nt;\n    const hasClosedEnds = endSpec.type === \"closed\" || endSpec.type === \"closed_ground\";\n\n    if (!hasClosedEnds) {\n        // Open ends: uniform pitch throughout (no dead coils)\n        if (prof.mode === \"uniform\") {\n            return pitchActive;\n        }\n        // Progressive open ends: use center pitch\n        return prof.pitchCenter ?? pitchActive;\n    }\n\n    // Closed ends: use wPitch weight\n    const thetaClosed = 2 * Math.PI * endSpec.closedTurnsPerEnd;\n    const w = wPitch(theta, thetaClosed, thetaTotal);\n\n    if (prof.mode === \"uniform\") {\n        return pitchActive * w;\n    }\n\n    // Two-Stage / Progressive: blend between pitchEnd and pitchCenter\n    const pCenter = prof.pitchCenter ?? pitchActive;\n    const pEnd = prof.pitchEnd ?? (pCenter * 0.15); // Very small pitch at ends\n\n    // Additional transition zone for progressive springs\n    const thetaTrans = 2 * Math.PI * (prof.transitionTurns ?? 0.75);\n\n    // In closed zone, pitch is pEnd (small but not zero for visual clarity)\n    if (theta < thetaClosed) {\n        return pEnd;\n    }\n\n    // Transition: pEnd -> pCenter\n    if (theta < thetaClosed + thetaTrans) {\n        const u = smoothstep01((theta - thetaClosed) / thetaTrans);\n        return pEnd + (pCenter - pEnd) * u;\n    }\n\n    // End transition (symmetric)\n    if (theta > thetaTotal - (thetaClosed + thetaTrans)) {\n        if (theta < thetaTotal - thetaClosed) {\n            const u = smoothstep01((thetaTotal - thetaClosed - theta) / thetaTrans);\n            return pEnd + (pCenter - pEnd) * u;\n        }\n        return pEnd;\n    }\n\n    return pCenter;\n}\n\n// ============================================================================\n// Ground Weight Function (端面磨平权重)\n// ============================================================================\n\n/**\n * groundWeight: Returns 0-1 weight for how much to \"flatten\" z toward end plane\n * - Near end: high weight (flatten toward 0 or zEnd)\n * - Away from end: 0 (no flattening)\n */\nfunction groundWeight(theta: number, thetaGround: number, thetaTotal: number): number {\n    if (thetaGround <= 0) return 0;\n\n    // Start ground zone\n    if (theta < thetaGround) {\n        const u = 1 - theta / thetaGround;\n        return smoothstep01(u);\n    }\n\n    // End ground zone\n    if (theta > thetaTotal - thetaGround) {\n        const u = 1 - (thetaTotal - theta) / thetaGround;\n        return smoothstep01(u);\n    }\n\n    return 0;\n}\n\n// ============================================================================\n// Diameter Profile Function\n// ============================================================================\n\nfunction diameterAtTheta(theta: number, Nt: number, prof: DiameterProfile): number {\n    const t = theta / (2 * Math.PI * Nt); // 0 to 1\n\n    if (prof.mode === \"constant\") {\n        return prof.DmStart ?? 100;\n    }\n\n    if (prof.mode === \"conical\") {\n        const dStart = prof.DmStart ?? 100;\n        const dEnd = prof.DmEnd ?? 100;\n        return dStart + (dEnd - dStart) * t;\n    }\n\n    if (prof.mode === \"barrel\") {\n        const dStart = prof.DmStart ?? 100;\n        const dMid = prof.DmMid ?? 120;\n        const dEnd = prof.DmEnd ?? 100;\n\n        if (t < 0.5) {\n            const u = smoothstep01(t / 0.5);\n            return dStart + (dMid - dStart) * u;\n        } else {\n            const u = smoothstep01((t - 0.5) / 0.5);\n            return dMid + (dEnd - dMid) * u;\n        }\n    }\n\n    return 100;\n}\n\n// ============================================================================\n// Numeric Average Helper (for pitchActive calculation)\n// ============================================================================\n\nfunction numericAvgWPitch(thetaClosed: number, thetaTotal: number, segments: number = 200): number {\n    let sum = 0;\n    const dTheta = thetaTotal / segments;\n    for (let i = 0; i < segments; i++) {\n        const theta = (i + 0.5) * dTheta;\n        sum += wPitch(theta, thetaClosed, thetaTotal);\n    }\n    return sum / segments;\n}\n\n// ============================================================================\n// Core Builder\n// ============================================================================\n\nexport function buildSuspensionSpringCurvePoints(\n    params: SuspensionSpringGeometryInput\n): { points: THREE.Vector3[]; totalHeightRaw: number } {\n    const {\n        activeCoils,\n        totalCoils,\n        freeLength,\n        pitchProfile,\n        diameterProfile,\n        segmentsPerCoil = 80,\n    } = params;\n\n    const endSpec = resolveEndSpec(pitchProfile);\n\n    // Use totalCoils for geometry + endAngleExtra\n    const Nt = (totalCoils > 0 ? totalCoils : activeCoils + 2) + (endSpec.endAngleExtra ?? 0);\n\n    const segs = Math.max(120, Math.floor(Nt * segmentsPerCoil));\n    const thetaTotal = 2 * Math.PI * Nt;\n    const dTheta = thetaTotal / segs;\n\n    const hasClosedEnds = endSpec.type === \"closed\" || endSpec.type === \"closed_ground\";\n    const thetaClosed = hasClosedEnds ? 2 * Math.PI * endSpec.closedTurnsPerEnd : 0;\n    const thetaGround = endSpec.type === \"closed_ground\" ? 2 * Math.PI * (endSpec.groundTurnsPerEnd ?? 0.5) : 0;\n\n    // Calculate pitchActive so that integrated height = freeLength\n    // total_height = integral( pitch(θ) / 2π dθ ) ≈ pitchActive * Nt * wAvg\n    // → pitchActive = freeLength / (Nt * wAvg)\n    const wAvg = numericAvgWPitch(thetaClosed, thetaTotal, segs);\n    const pitchActive = freeLength / (Nt * Math.max(wAvg, 0.1));\n\n    // 1. Generate Raw Z Profile (Integration)\n    const zRaw: number[] = [];\n    let zCurrent = 0;\n    zRaw.push(0);\n\n    for (let i = 1; i <= segs; i++) {\n        const thetaMid = (i - 0.5) * dTheta;\n        const p = pitchAtTheta(thetaMid, Nt, pitchProfile, pitchActive, endSpec);\n\n        // dz = (pitch / 2π) * dTheta\n        zCurrent += (p / (2 * Math.PI)) * dTheta;\n        zRaw.push(zCurrent);\n    }\n\n    const zEnd = zRaw[segs];\n\n    // 2. Apply Ground Flattening (for closed_ground)\n    // Start end: pull toward z=0\n    // End end: pull toward z=zEnd\n    const zFlattened: number[] = [];\n    for (let i = 0; i <= segs; i++) {\n        const theta = i * dTheta;\n        let z = zRaw[i];\n\n        if (endSpec.type === \"closed_ground\" && thetaGround > 0) {\n            const wg = groundWeight(theta, thetaGround, thetaTotal);\n\n            if (theta < thetaGround) {\n                // Start: flatten toward 0\n                z = lerp(z, 0, wg);\n            } else if (theta > thetaTotal - thetaGround) {\n                // End: flatten toward zEnd\n                z = lerp(z, zEnd, wg);\n            }\n        }\n\n        zFlattened.push(z);\n    }\n\n    // 3. Scale Z to match Free Length exactly (post-flattening)\n    const totalHeightFlat = zFlattened[segs] - zFlattened[0];\n    const scaleZ = totalHeightFlat > 1e-6 ? freeLength / totalHeightFlat : 1;\n\n    // 4. Generate 3D Points\n    const points: THREE.Vector3[] = [];\n    for (let i = 0; i <= segs; i++) {\n        const theta = i * dTheta;\n        const Dm = diameterAtTheta(theta, Nt, diameterProfile);\n        const R = Dm / 2;\n\n        const x = R * Math.cos(theta);\n        const zCoord = R * Math.sin(theta);\n        const yHelix = (zFlattened[i] - zFlattened[0]) * scaleZ;\n\n        points.push(new THREE.Vector3(x, yHelix, zCoord));\n    }\n\n    return { points, totalHeightRaw: freeLength };\n}\n\n// ============================================================================\n// Load Compression (非均匀压缩)\n// ============================================================================\n\n/**\n * Apply Load Compression with weighted approach\n * - Dead coils (small dy) compress less\n * - Active coils (large dy) compress more\n */\nfunction applyCompression(\n    originalPoints: THREE.Vector3[],\n    wireDiameter: number,\n    targetHeight: number,\n    freeLength: number,\n    endSpec: SuspensionEndSpec\n): THREE.Vector3[] {\n    if (targetHeight >= freeLength) return originalPoints;\n\n    const totalPoints = originalPoints.length;\n    if (totalPoints < 2) return originalPoints;\n\n    const delta = freeLength - targetHeight;\n    const yValues = originalPoints.map(p => p.y);\n    const yMax = yValues[totalPoints - 1] - yValues[0];\n\n    // Calculate weights based on local pitch (dy)\n    // Higher pitch = more compressible\n    const weights: number[] = [];\n    let totalWeight = 0;\n\n    for (let i = 0; i < totalPoints - 1; i++) {\n        const dy = yValues[i + 1] - yValues[i];\n\n        // Minimum compression for dead coils\n        // If dy is less than wireDiameter * 0.5, it's essentially solid\n        const minPitch = wireDiameter * 0.5;\n        const w = Math.max(0, dy - minPitch);\n\n        weights.push(w);\n        totalWeight += w;\n    }\n\n    // If no compressible sections, fall back to uniform scaling\n    if (totalWeight < 1e-6) {\n        const scale = targetHeight / freeLength;\n        return originalPoints.map(p => new THREE.Vector3(p.x, p.y * scale, p.z));\n    }\n\n    // Distribute compression proportionally to weights\n    const out: THREE.Vector3[] = [];\n    let cumulativeCompression = 0;\n    out.push(originalPoints[0].clone());\n\n    for (let i = 1; i < totalPoints; i++) {\n        const localWeight = weights[i - 1];\n        const localCompression = (localWeight / totalWeight) * delta;\n        cumulativeCompression += localCompression;\n\n        const newY = originalPoints[i].y - cumulativeCompression;\n        out.push(new THREE.Vector3(originalPoints[i].x, newY, originalPoints[i].z));\n    }\n\n    return out;\n}\n\n// ============================================================================\n// Main Geometry Builder\n// ============================================================================\n\nexport function buildSuspensionSpringGeometry(\n    input: SuspensionSpringGeometryInput\n): SuspensionSpringGeometryResult {\n\n    const endSpec = resolveEndSpec(input.pitchProfile);\n\n    // 1. Generate base curve points (at Free Length)\n    const { points: basePoints } = buildSuspensionSpringCurvePoints(input);\n\n    // 2. Determine target height based on Load State\n    let targetHeight = input.freeLength;\n    if (input.targetHeight !== undefined) {\n        targetHeight = input.targetHeight;\n    } else if (input.loadState) {\n        switch (input.loadState) {\n            case \"preload\":\n                targetHeight = input.freeLength * 0.95;\n                break;\n            case \"ride\":\n                targetHeight = input.freeLength * 0.85;\n                break;\n            case \"bump\":\n                targetHeight = input.freeLength * 0.65;\n                break;\n        }\n    }\n\n    // 3. Apply weighted compression\n    const finalPoints = applyCompression(\n        basePoints,\n        input.wireDiameter,\n        targetHeight,\n        input.freeLength,\n        endSpec\n    );\n\n    // 4. Generate Tube Geometry\n    const curve = new THREE.CatmullRomCurve3(finalPoints, false, \"catmullrom\", 0.05);\n\n    const tubeGeometry = new THREE.TubeGeometry(\n        curve,\n        Math.min(600, (input.totalCoils || input.activeCoils + 2) * 100),\n        input.wireDiameter / 2,\n        input.radialSegments ?? 12,\n        false\n    );\n\n    // Compute stats\n    tubeGeometry.computeBoundingBox();\n    const bbox = tubeGeometry.boundingBox || new THREE.Box3();\n\n    // Wire length estimation\n    let length = 0;\n    for (let i = 0; i < finalPoints.length - 1; i++) {\n        length += finalPoints[i].distanceTo(finalPoints[i + 1]);\n    }\n\n    return {\n        geometry: tubeGeometry,\n        curvepoints: finalPoints,\n        wireLength: length,\n        boundingBox: bbox\n    };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/torsionSpringGeometry.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'meanDiameter' is assigned a value but never used.","line":241,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":241,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'freeAngle' is assigned a value but never used.","line":244,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":244,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'workingAngle' is assigned a value but never used.","line":245,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":245,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Torsion Spring 3D Geometry Generator\n * \n * Engineering-accurate model with:\n * - Helical body coils\n * - Straight or bent legs at both ends\n * - Dynamic rotation based on working angle\n * - Left/right hand winding support\n */\n\nimport * as THREE from \"three\";\n\n// ================================================================\n// Angle Helpers\n// ================================================================\n\nconst TWO_PI = Math.PI * 2;\n\nfunction degToRad(deg: number): number {\n  return (deg * Math.PI) / 180;\n}\n\n/**\n * Normalize angle to (-π, π], used to get the minimal extra rotation.\n */\nfunction normalizeAngle(angle: number): number {\n  let a = angle % TWO_PI;\n  if (a <= -Math.PI) a += TWO_PI;\n  if (a > Math.PI) a -= TWO_PI;\n  return a;\n}\n\n/**\n * Calculate the total helix angle needed to achieve the desired leg angle.\n * \n * Key insight: Both legs are tangent to the helix.\n * - Leg1 tangent direction at θ=0: (0, 1) → leg points opposite: (0, -1) → angle = -π/2\n * - Leg2 tangent direction at θ=θ_total: (-sin(θ), cos(θ)) → leg points same direction\n *   → leg angle = atan2(cos(θ), -sin(θ)) = π/2 - θ\n * \n * Angle between legs = leg2_angle - leg1_angle = (π/2 - θ_total) - (-π/2) = π - θ_total\n * \n * To get desired currentLegAngle:\n *   π - θ_total = currentLegAngle (in radians)\n *   θ_total = π - currentLegAngle\n * \n * But we also need at least activeCoils full rotations:\n *   θ_total = 2π × activeCoils + extraAngle\n *   where extraAngle adjusts the final leg position\n */\nfunction calculateHelixTotalAngle(\n  activeCoils: number,\n  freeAngle: number,\n  workingAngle: number,\n  windingDirection: \"left\" | \"right\"\n): number {\n  const dirMult = windingDirection === \"right\" ? 1 : -1;\n\n  // Current angle between legs (degrees)\n  const currentLegAngleDeg = freeAngle - workingAngle;\n  const currentLegAngleRad = degToRad(currentLegAngleDeg);\n\n  // Base helix angle for full coils\n  const baseAngle = TWO_PI * activeCoils;\n\n  // For a helix with θ_total:\n  // - Leg1 at θ=0, tangent = (0, 1), leg direction = (0, -1), angle = -π/2\n  // - Leg2 at θ=θ_total, tangent = (-sin(θ), cos(θ)), leg direction same\n  //   leg2 angle = atan2(cos(θ), -sin(θ)) = π/2 - θ (mod 2π)\n  //\n  // Angle between legs = leg2_angle - leg1_angle\n  //                    = (π/2 - θ_total) - (-π/2)\n  //                    = π - θ_total (mod 2π)\n  //\n  // We want: π - θ_total ≡ currentLegAngleRad (mod 2π)\n  // So: θ_total ≡ π - currentLegAngleRad (mod 2π)\n\n  // Calculate the target ending angle (mod 2π)\n  const targetEndAngle = normalizeAngle(Math.PI - currentLegAngleRad);\n\n  // Current ending angle from base coils (mod 2π)\n  const baseEndAngle = normalizeAngle(baseAngle);\n\n  // Extra rotation needed\n  let extraAngle = targetEndAngle - baseEndAngle;\n\n  // Normalize to get the smallest adjustment\n  extraAngle = normalizeAngle(extraAngle);\n\n  // Total helix angle\n  const totalAngle = baseAngle + extraAngle;\n\n  return totalAngle * dirMult;\n}\n\n// ================================================================\n// PART #1 — Parameters Interface\n// ================================================================\n\nexport interface TorsionSpringParams {\n  /** Wire diameter (mm) */\n  wireDiameter: number;\n  /** Mean diameter (mm) */\n  meanDiameter: number;\n  /** Number of active coils */\n  activeCoils: number;\n  /** Body length (mm) - calculated from pitch × coils */\n  bodyLength: number;\n  /** Pitch between coils (mm) - must be >= wire diameter */\n  pitch: number;\n  /** Leg 1 length (mm) - fixed side arm */\n  legLength1: number;\n  /** Leg 2 length (mm) - force side arm */\n  legLength2: number;\n  /** Free angle between legs (degrees) - initial angle */\n  freeAngle: number;\n  /** Working angle deflection (degrees) - rotation from free position */\n  workingAngle: number;\n  /** Winding direction: 'left' or 'right' */\n  windingDirection: \"left\" | \"right\";\n  /** Scale factor for 3D scene */\n  scale: number;\n  /** Leg type: 'straight' | 'bent' | 'hook' */\n  legType?: \"straight\" | \"bent\" | \"hook\";\n}\n\nexport interface TorsionSpringState {\n  /** Current angle between legs (degrees) */\n  currentAngle: number;\n  /** Whether spring is at rest (no deflection) */\n  isAtRest: boolean;\n  /** Leg positions for reference */\n  leg1EndPosition: THREE.Vector3;\n  leg2EndPosition: THREE.Vector3;\n}\n\n// ================================================================\n// PART #2 — Body Centerline Generator\n// ================================================================\n\n/**\n * Generate the parametric centerline curve for torsion spring body\n * \n * Key insight: To control the angle between legs, we adjust the total helix angle.\n * Both legs are tangent to the helix, so by changing where the helix ends,\n * we control the direction of leg2 (and thus the angle between legs).\n * \n * Parameters:\n * - activeCoils: base number of coils\n * - freeAngle: initial angle between legs (degrees)\n * - workingAngle: current deflection from free position (degrees)\n * - pitch: distance between coils\n */\nexport function generateTorsionBodyCenterline(\n  params: TorsionSpringParams\n): { points: THREE.Vector3[]; startPoint: THREE.Vector3; endPoint: THREE.Vector3; startAngle: number; endAngle: number } {\n  const {\n    meanDiameter,\n    activeCoils,\n    freeAngle,\n    workingAngle,\n    pitch,\n    windingDirection,\n    scale,\n  } = params;\n\n  // Scaled dimensions\n  const R = (meanDiameter / 2) * scale;\n\n  // Use pitch to calculate body length\n  const scaledPitch = pitch * scale;\n\n  // Calculate the total helix angle to achieve desired leg angle\n  // This is the key: we adjust the helix ending angle to control leg2 direction\n  const totalAngle = calculateHelixTotalAngle(activeCoils, freeAngle, workingAngle, windingDirection);\n\n  // Body length is based on the actual rotation (may be slightly more/less than activeCoils)\n  const actualCoils = Math.abs(totalAngle) / TWO_PI;\n  const L = scaledPitch * actualCoils;\n\n  // Sampling parameters - more samples for smoother curve\n  const numSamples = Math.max(400, Math.ceil(actualCoils * 60));\n\n  const points: THREE.Vector3[] = [];\n\n  for (let i = 0; i <= numSamples; i++) {\n    const t = i / numSamples;\n    const θ = t * totalAngle; // totalAngle already includes direction\n\n    // Z position (height along spring axis)\n    const z = t * L;\n\n    // X/Y parametric (circular helix)\n    const x = R * Math.cos(θ);\n    const y = R * Math.sin(θ);\n\n    points.push(new THREE.Vector3(x, y, z));\n  }\n\n  const startPoint = points[0].clone();\n  const endPoint = points[points.length - 1].clone();\n\n  return {\n    points,\n    startPoint,\n    endPoint,\n    startAngle: 0,\n    endAngle: totalAngle, // Already includes direction from calculateHelixTotalAngle\n  };\n}\n\n// ================================================================\n// PART #3 — Leg Geometry Generator\n// ================================================================\n\nexport interface LegGeometry {\n  points: THREE.Vector3[];\n  endPosition: THREE.Vector3;\n}\n\n/**\n * Generate leg geometry for torsion spring\n * \n * Key concept for torsion spring legs:\n * - Leg1 (fixed side): extends from coil start, direction based on helix tangent\n * - Leg2 (force side): extends from coil end, rotated by working angle\n * - The angle between legs = freeAngle - workingAngle\n * \n * For a helix: x = R*cos(θ), y = R*sin(θ)\n * Tangent direction: (-sin(θ), cos(θ))\n * \n * Leg directions are calculated to achieve the correct angle between them.\n */\nexport function generateLegGeometry(\n  params: TorsionSpringParams,\n  isLeg1: boolean,\n  bodyEndPoint: THREE.Vector3,\n  bodyEndAngle: number\n): LegGeometry {\n  const {\n    meanDiameter,\n    legLength1,\n    legLength2,\n    freeAngle,\n    workingAngle,\n    windingDirection,\n    scale,\n  } = params;\n\n\n  const legLength = (isLeg1 ? legLength1 : legLength2) * scale;\n\n  const points: THREE.Vector3[] = [];\n\n  // Direction multiplier for winding\n  const dirMult = windingDirection === \"right\" ? 1 : -1;\n\n\n\n\n  // The position on the helix at this point\n  const posX = bodyEndPoint.x;\n  const posY = bodyEndPoint.y;\n  const posZ = bodyEndPoint.z;\n\n  // Calculate leg direction based on helix tangent at the connection point\n  // For helix: x = R*cos(θ), y = R*sin(θ)\n  // Tangent direction: dx/dθ = -R*sin(θ), dy/dθ = R*cos(θ)\n  // Normalized tangent: (-sin(θ), cos(θ))\n  //\n  // BOTH legs extend along the tangent direction:\n  // - Leg1: OPPOSITE to helix travel (backward from start)\n  // - Leg2: SAME as helix travel (forward from end)\n  //\n  // The angle between legs is controlled by the helix total angle,\n  // NOT by rotating the legs. This ensures both legs are always tangent.\n\n  let legDirX: number;\n  let legDirY: number;\n\n  if (isLeg1) {\n    // Leg1 at start of coil (θ = 0)\n    // Tangent at θ=0: (-sin(0), cos(0)) = (0, 1)\n    const tangentX = 0;\n    const tangentY = 1;\n\n    // Leg1 extends OPPOSITE to helix travel (backward from start)\n    // For right-hand: opposite of (0, 1) is (0, -1)\n    legDirX = -tangentX * dirMult;\n    legDirY = -tangentY * dirMult;\n  } else {\n    // Leg2 at end of coil - use the actual bodyEndAngle passed in\n    // This angle was calculated by calculateHelixTotalAngle to achieve\n    // the desired angle between legs\n    const helixEndAngle = bodyEndAngle;\n\n    // Tangent at helix end: (-sin(θ), cos(θ))\n    const tangentX = -Math.sin(helixEndAngle);\n    const tangentY = Math.cos(helixEndAngle);\n\n    // Leg2 extends in SAME direction as helix travel (forward from end)\n    // For right-hand winding, tangent direction is the travel direction\n    const sign = windingDirection === \"right\" ? 1 : -1;\n    legDirX = tangentX * sign;\n    legDirY = tangentY * sign;\n  }\n\n  // Generate straight leg points along leg direction\n  // Start from the body connection point and extend outward\n  const numSegments = 30;\n\n  // First point: exactly at body connection\n  points.push(new THREE.Vector3(posX, posY, posZ));\n\n  // Remaining points: extend along leg direction\n  for (let i = 1; i <= numSegments; i++) {\n    const t = i / numSegments;\n    const x = posX + t * legLength * legDirX;\n    const y = posY + t * legLength * legDirY;\n    const z = posZ; // Legs stay in the same Z plane as their connection point\n    points.push(new THREE.Vector3(x, y, z));\n  }\n\n  const endPosition = points.length > 0\n    ? points[points.length - 1].clone()\n    : bodyEndPoint.clone();\n\n  return { points, endPosition };\n}\n\n// ================================================================\n// PART #4 — Complete Geometry Builder\n// ================================================================\n\nexport interface TorsionSpringGeometry {\n  bodyGeometry: THREE.TubeGeometry;\n  leg1Geometry: THREE.TubeGeometry | null;\n  leg2Geometry: THREE.TubeGeometry | null;\n  totalHeight: number;\n  state: TorsionSpringState;\n}\n\n/**\n * Build complete torsion spring geometry\n * \n * The angle between legs is controlled by adjusting the helix total angle.\n * Both legs remain tangent to the helix at their connection points.\n */\nexport function buildTorsionSpringGeometry(\n  params: TorsionSpringParams\n): TorsionSpringGeometry {\n  const { wireDiameter, freeAngle, workingAngle, scale } = params;\n\n  // Generate body centerline - this calculates the adjusted helix angle\n  const { points, startPoint, endPoint, startAngle, endAngle } = generateTorsionBodyCenterline(params);\n\n  // Create body curve\n  const bodyCurve = new THREE.CatmullRomCurve3(points);\n\n  // Wire radius for tube\n  const wireRadius = (wireDiameter / 2) * scale;\n\n  // Create body tube geometry\n  const bodyGeometry = new THREE.TubeGeometry(\n    bodyCurve,\n    points.length - 1,\n    wireRadius,\n    16,\n    false\n  );\n\n  // Generate legs using the actual helix angles\n  // Leg1 at start (angle = 0), Leg2 at end (angle = endAngle from helix calculation)\n  const leg1 = generateLegGeometry(params, true, startPoint, startAngle);\n  const leg2 = generateLegGeometry(params, false, endPoint, endAngle);\n\n  let leg1Geometry: THREE.TubeGeometry | null = null;\n  let leg2Geometry: THREE.TubeGeometry | null = null;\n\n  if (leg1.points.length > 2) {\n    const leg1Curve = new THREE.CatmullRomCurve3(leg1.points);\n    leg1Geometry = new THREE.TubeGeometry(\n      leg1Curve,\n      leg1.points.length - 1,\n      wireRadius,\n      16,\n      false\n    );\n  }\n\n  if (leg2.points.length > 2) {\n    const leg2Curve = new THREE.CatmullRomCurve3(leg2.points);\n    leg2Geometry = new THREE.TubeGeometry(\n      leg2Curve,\n      leg2.points.length - 1,\n      wireRadius,\n      16,\n      false\n    );\n  }\n\n  // Calculate state\n  const currentAngle = freeAngle - workingAngle;\n  const isAtRest = workingAngle <= 0;\n\n  // Find min/max Z for total height\n  let minZ = Infinity;\n  let maxZ = -Infinity;\n  for (const p of points) {\n    minZ = Math.min(minZ, p.z);\n    maxZ = Math.max(maxZ, p.z);\n  }\n\n  return {\n    bodyGeometry,\n    leg1Geometry,\n    leg2Geometry,\n    totalHeight: maxZ - minZ,\n    state: {\n      currentAngle,\n      isAtRest,\n      leg1EndPosition: leg1.endPosition,\n      leg2EndPosition: leg2.endPosition,\n    },\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/variablePitchCompressionGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/waveSpringGeometry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/spring3d/waveSpringGeometryV2.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'innerDiameter' is assigned a value but never used.","line":414,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":414,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'radialPitch' is assigned a value but never used.","line":421,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":421,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Wave Spring 3D Geometry Builder V2\n * 波形弹簧 3D 几何生成器 V2\n * \n * Fixed issues from V1:\n * - Seam gaps: Use θ ∈ [0, 2π) not [0, 2π] to avoid duplicate end section\n * - Phase discontinuity: Use θ_local for wave function to ensure per-turn continuity\n * - Normal flipping: Use Parallel Transport Frame (PTF) for stable ribbon orientation\n * - End caps: Add optional end caps for multi-turn springs\n * \n * Based on OpenAI's engineering analysis and recommendations.\n */\n\nimport * as THREE from \"three\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type WaveSpringWinding = \"CW\" | \"CCW\";\nexport type WaveSpringStackingMode = \"axial\" | \"radial\" | \"nested\";\n\nexport interface WaveSpringGeometryInput {\n  /** Mean diameter Dm (mm) - for axial/nested modes */\n  meanDiameter: number;\n  /** Inner diameter (mm) - for radial spiral mode */\n  innerDiameter?: number;\n  /** Strip thickness t (mm) - axial direction (thin dimension) */\n  thickness: number;\n  /** Strip width b (mm) - radial direction (wide dimension, flat ribbon) */\n  width: number;\n  /** Wave amplitude A (mm) - half of peak-to-valley in axial direction */\n  amplitude: number;\n  /** Number of waves per turn (integer recommended for seamless closure) */\n  waves: number;\n  /** Number of turns */\n  turns: number;\n  /** Phase offset (radians) */\n  phase?: number;\n  /** Phase offset per turn (radians) - for crest-to-crest alignment */\n  phasePerTurn?: number;\n  /** Scale factor for 3D scene */\n  scale?: number;\n  /** Radial pitch - increment in radius per turn for radial stacking (mm) */\n  radialPitch?: number;\n  /** Axial pitch - z rise per turn for helix mode (mm). If 0, produces stacked rings. */\n  axialPitch?: number;\n  /** Total height (mm) - alternative to axialPitch. axialPitch = totalHeight / turns */\n  totalHeight?: number;\n  /** Stacking mode: axial (default), radial (spiral outward), or nested */\n  stackingMode?: WaveSpringStackingMode;\n  /** For nested mode: array of layer configurations */\n  nestedLayers?: WaveSpringNestedLayer[];\n  /** Segments per turn for smooth rendering (default 220) */\n  segmentsPerTurn?: number;\n  /** Add end caps to close the ribbon ends (default true) */\n  capEnds?: boolean;\n  /** Winding direction (default CCW) */\n  winding?: WaveSpringWinding;\n}\n\nexport interface WaveSpringNestedLayer {\n  /** Layer radius offset from meanDiameter (mm) */\n  radiusOffset: number;\n  /** Optional different wave count for this layer */\n  waves?: number;\n  /** Optional different amplitude for this layer */\n  amplitude?: number;\n  /** Optional phase offset for this layer */\n  phase?: number;\n}\n\nexport interface WaveSpringGeometryResult {\n  geometry: THREE.BufferGeometry;\n  wireLength: number;\n  boundingBox: {\n    min: THREE.Vector3;\n    max: THREE.Vector3;\n  };\n}\n\nexport interface WaveSpringGeometryValidation {\n  isValid: boolean;\n  errors: string[];\n  warnings: string[];\n}\n\n// ============================================================================\n// Validation\n// ============================================================================\n\nexport function validateWaveSpringGeometry(\n  input: WaveSpringGeometryInput\n): WaveSpringGeometryValidation {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n\n  const meanDiameter = input.meanDiameter ?? (input.innerDiameter ? input.innerDiameter + input.turns * (input.radialPitch ?? input.thickness) : 0);\n\n  if (meanDiameter <= 0 && !input.innerDiameter) errors.push(\"Mean diameter or inner diameter must be > 0\");\n  if (input.thickness <= 0) errors.push(\"Thickness must be > 0\");\n  if (input.width <= 0) errors.push(\"Width must be > 0\");\n  if (input.amplitude < 0) errors.push(\"Amplitude must be >= 0\");\n  if (input.waves < 2) errors.push(\"Waves must be >= 2\");\n  if (input.turns < 1) errors.push(\"Turns must be >= 1\");\n\n  // Non-integer waves warning\n  if (input.waves !== Math.floor(input.waves)) {\n    warnings.push(\"Non-integer waves per turn may cause phase discontinuity at seam\");\n  }\n\n  // Wave peak contact risk\n  if (input.amplitude * 2 >= input.width) {\n    warnings.push(\"Wave amplitude * 2 >= width - wave peaks may contact each other\");\n  }\n\n  if (input.waves > 12) {\n    warnings.push(\"High wave count may be difficult to manufacture\");\n  }\n\n  // Radial pitch validation\n  if (input.stackingMode === \"radial\" && input.turns > 1) {\n    const radialPitch = input.radialPitch ?? input.thickness;\n    if (radialPitch < input.thickness) {\n      errors.push(\"Radial pitch must be >= thickness to avoid radial overlap\");\n    }\n  }\n\n  // Axial pitch / layer collision validation\n  const axialPitch = input.axialPitch ?? (input.totalHeight ? input.totalHeight / input.turns : 0);\n  if (axialPitch > 0 && input.turns > 1) {\n    const minSafeAxialPitch = 2 * input.amplitude + 0.2 * input.thickness;\n    if (axialPitch <= minSafeAxialPitch) {\n      warnings.push(`Axial pitch (${axialPitch.toFixed(2)}mm) <= 2*amplitude + 0.2*thickness (${minSafeAxialPitch.toFixed(2)}mm) - risk of layer collision`);\n    }\n  }\n\n  // Nested mode validation\n  if (input.stackingMode === \"nested\" && input.nestedLayers) {\n    if (input.nestedLayers.length < 1) {\n      errors.push(\"Nested mode requires at least one layer\");\n    }\n    const sortedLayers = [...input.nestedLayers].sort((a, b) => a.radiusOffset - b.radiusOffset);\n    for (let i = 1; i < sortedLayers.length; i++) {\n      const gap = sortedLayers[i].radiusOffset - sortedLayers[i - 1].radiusOffset;\n      if (gap < input.width) {\n        warnings.push(`Nested layers ${i} and ${i + 1} may overlap radially`);\n      }\n    }\n  }\n\n  return {\n    isValid: errors.length === 0,\n    errors,\n    warnings,\n  };\n}\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\nconst EPS = 1e-9;\n\nfunction safeNormalize(v: THREE.Vector3): THREE.Vector3 {\n  const len = v.length();\n  if (len < EPS) return v.set(1, 0, 0);\n  return v.multiplyScalar(1 / len);\n}\n\n// ============================================================================\n// Core Geometry Builder (V2 - Continuous Helix with Sign-Flip Wave)\n// ============================================================================\n// \n// Wave spring is a CONTINUOUS strip wound into a helix, with wave pattern.\n// To achieve crest-to-crest contact between adjacent turns:\n// \n// z(θ) = z_base(θ) + z_wave(θ)\n//   z_base = (P / 2π) * θ           -- linear helix rise\n//   z_wave = A * sin(Nw * θ) * s(θ) -- wave with sign flip per turn\n//   s(θ) = (-1)^floor(θ / 2π)       -- alternates +1/-1 each turn\n//\n// WHY this works (crest-to-crest contact):\n// At same angular position (θ mod 2π), adjacent turns differ by:\n//   - Base height: P\n//   - Wave: sign flipped, so at crest: +A vs -A → difference = 2A\n// For contact: P = 2A → crests touch!\n//\n// WHY no discontinuity at turn boundaries:\n// At θ = 2πk, sin(Nw * θ) = sin(2πk * Nw) = 0 (for integer Nw)\n// So even though s(θ) flips, z_wave = 0 at boundaries → continuous!\n\ninterface BuildContinuousHelixParams {\n  /** Mean radius Rm (mm) */\n  meanRadius: number;\n  /** Pitch P (mm) - axial rise per turn */\n  pitch: number;\n  /** Wave amplitude A (mm) - should be P/2 for crest contact */\n  amplitude: number;\n  /** Waves per turn (integer recommended) */\n  waves: number;\n  /** Total turns */\n  turns: number;\n  /** Initial phase offset (radians) */\n  phase: number;\n  /** Strip thickness (mm) */\n  thickness: number;\n  /** Strip width (mm) */\n  width: number;\n  /** Segments per turn */\n  segmentsPerTurn: number;\n  /** Winding direction */\n  winding: WaveSpringWinding;\n  /** Add end caps */\n  capEnds: boolean;\n}\n\nfunction buildContinuousHelixGeometry(params: BuildContinuousHelixParams): {\n  geometry: THREE.BufferGeometry;\n  wireLength: number;\n} {\n  const {\n    meanRadius,\n    pitch,\n    amplitude,\n    waves,\n    turns,\n    phase,\n    thickness,\n    width,\n    segmentsPerTurn,\n    winding,\n    capEnds,\n  } = params;\n\n  const dirSign = winding === \"CCW\" ? 1 : -1;\n  const totalTheta = 2 * Math.PI * turns;\n  const totalSegments = Math.max(40, Math.floor(segmentsPerTurn * turns));\n  const dTheta = totalTheta / totalSegments;\n\n  const halfW = width / 2;\n  const halfT = thickness / 2;\n\n  const positions: number[] = [];\n  const normals: number[] = [];\n  const uvs: number[] = [];\n  const indices: number[] = [];\n\n  let wireLength = 0;\n\n  function pushVertex(pos: THREE.Vector3, normal: THREE.Vector3, u: number, v: number) {\n    positions.push(pos.x, pos.y, pos.z);\n    normals.push(normal.x, normal.y, normal.z);\n    uvs.push(u, v);\n  }\n\n  /**\n   * CORRECT Wave Spring Model: Continuous Helix with Sign-Flip Wave\n   * \n   * z(θ) = z_base(θ) + z_wave(θ)\n   *   z_base = (P / 2π) * θ           -- linear helix rise\n   *   z_wave = A * sin(Nw * θ) * s(θ) -- wave with sign flip per turn\n   *   s(θ) = (-1)^floor(θ / 2π)       -- alternates +1/-1 each turn\n   * \n   * With A = P/2: crests touch between adjacent turns!\n   * At θ = 2πk boundaries: sin(Nw * 2πk) = 0 → no discontinuity!\n   */\n  function centerlinePoint(theta: number): THREE.Vector3 {\n    const th = dirSign * theta;\n    const x = meanRadius * Math.cos(th);\n    const y = meanRadius * Math.sin(th);\n\n    // z_base: linear helix rise\n    const z_base = (pitch / (2 * Math.PI)) * theta;\n\n    // Sign flip per turn: s(θ) = (-1)^floor(θ / 2π)\n    const turnIndex = Math.floor(theta / (2 * Math.PI));\n    const s = (turnIndex % 2 === 0) ? 1 : -1;\n\n    // z_wave: wave with sign flip\n    const z_wave = amplitude * Math.sin(waves * theta + phase) * s;\n\n    const z = z_base + z_wave;\n\n    return new THREE.Vector3(x, y, z);\n  }\n\n  function centerlineTangent(theta: number): THREE.Vector3 {\n    const t0 = Math.max(0, theta - dTheta * 0.5);\n    const t1 = Math.min(totalTheta, theta + dTheta * 0.5);\n    const p0 = centerlinePoint(t0);\n    const p1 = centerlinePoint(t1);\n    return safeNormalize(p1.sub(p0));\n  }\n\n  // FIXED: Use fixed frame instead of PTF\n  // Wave spring cross-section should NOT rotate with the wave oscillation\n  // The strip should maintain constant orientation: width=radial, thickness=axial\n  // This is the same approach as Die Spring geometry\n\n  let prevP: THREE.Vector3 | null = null;\n  let firstSectionIdx = 0;\n  let lastSectionIdx = 0;\n\n  // Build continuous strip: i <= totalSegments (include endpoint)\n  for (let i = 0; i <= totalSegments; i++) {\n    const theta = i * dTheta;\n    const P = centerlinePoint(theta);\n    // Note: tangent is computed but not used for frame - we use fixed frame instead\n\n    // FIXED FRAME: radial direction based on angular position, axial always Z\n    // This ensures cross-section does not rotate with wave oscillation\n    const th = dirSign * theta;\n    const N = new THREE.Vector3(Math.cos(th), Math.sin(th), 0);  // radial (width direction)\n    const B = new THREE.Vector3(0, 0, 1);  // axial (thickness direction)\n\n    // Corner positions (rectangular cross-section)\n    // N = radial direction (for width), B = axial direction (for thickness)\n    const c0 = P.clone().add(N.clone().multiplyScalar(+halfW)).add(B.clone().multiplyScalar(+halfT));\n    const c1 = P.clone().add(N.clone().multiplyScalar(+halfW)).add(B.clone().multiplyScalar(-halfT));\n    const c2 = P.clone().add(N.clone().multiplyScalar(-halfW)).add(B.clone().multiplyScalar(-halfT));\n    const c3 = P.clone().add(N.clone().multiplyScalar(-halfW)).add(B.clone().multiplyScalar(+halfT));\n\n    // Smooth corner normals (blend of radial and axial)\n    const n0 = safeNormalize(N.clone().add(B.clone()));\n    const n1 = safeNormalize(N.clone().sub(B.clone()));\n    const n2 = safeNormalize(N.clone().negate().sub(B.clone()));\n    const n3 = safeNormalize(N.clone().negate().add(B.clone()));\n\n    const baseIdx = (positions.length / 3) | 0;\n    if (i === 0) firstSectionIdx = baseIdx;\n    if (i === totalSegments) lastSectionIdx = baseIdx;\n\n    const u = i / totalSegments;\n    pushVertex(c0, n0, u, 1);\n    pushVertex(c1, n1, u, 0.67);\n    pushVertex(c2, n2, u, 0.33);\n    pushVertex(c3, n3, u, 0);\n\n    // Connect to previous section\n    if (i > 0) {\n      const prevBase = baseIdx - 4;\n      indices.push(prevBase + 0, prevBase + 1, baseIdx + 1);\n      indices.push(prevBase + 0, baseIdx + 1, baseIdx + 0);\n      indices.push(prevBase + 1, prevBase + 2, baseIdx + 2);\n      indices.push(prevBase + 1, baseIdx + 2, baseIdx + 1);\n      indices.push(prevBase + 2, prevBase + 3, baseIdx + 3);\n      indices.push(prevBase + 2, baseIdx + 3, baseIdx + 2);\n      indices.push(prevBase + 3, prevBase + 0, baseIdx + 0);\n      indices.push(prevBase + 3, baseIdx + 0, baseIdx + 3);\n    }\n\n    // Wire length\n    if (prevP) {\n      wireLength += P.distanceTo(prevP);\n    }\n    prevP = P.clone();\n  }\n\n  // Add end caps if requested\n  if (capEnds) {\n    // Start cap\n    const startBase = firstSectionIdx;\n    const startCenter = new THREE.Vector3(\n      (positions[startBase * 3] + positions[(startBase + 2) * 3]) / 2,\n      (positions[startBase * 3 + 1] + positions[(startBase + 2) * 3 + 1]) / 2,\n      (positions[startBase * 3 + 2] + positions[(startBase + 2) * 3 + 2]) / 2\n    );\n    const startNormal = centerlineTangent(0).negate();\n    const startCenterIdx = (positions.length / 3) | 0;\n    pushVertex(startCenter, startNormal, 0, 0.5);\n    indices.push(startCenterIdx, startBase + 1, startBase + 0);\n    indices.push(startCenterIdx, startBase + 2, startBase + 1);\n    indices.push(startCenterIdx, startBase + 3, startBase + 2);\n    indices.push(startCenterIdx, startBase + 0, startBase + 3);\n\n    // End cap\n    const endBase = lastSectionIdx;\n    const endCenter = new THREE.Vector3(\n      (positions[endBase * 3] + positions[(endBase + 2) * 3]) / 2,\n      (positions[endBase * 3 + 1] + positions[(endBase + 2) * 3 + 1]) / 2,\n      (positions[endBase * 3 + 2] + positions[(endBase + 2) * 3 + 2]) / 2\n    );\n    const endNormal = centerlineTangent(totalTheta);\n    const endCenterIdx = (positions.length / 3) | 0;\n    pushVertex(endCenter, endNormal, 1, 0.5);\n    indices.push(endCenterIdx, endBase + 0, endBase + 1);\n    indices.push(endCenterIdx, endBase + 1, endBase + 2);\n    indices.push(endCenterIdx, endBase + 2, endBase + 3);\n    indices.push(endCenterIdx, endBase + 3, endBase + 0);\n  }\n\n  const geometry = new THREE.BufferGeometry();\n  geometry.setAttribute(\"position\", new THREE.Float32BufferAttribute(positions, 3));\n  geometry.setAttribute(\"normal\", new THREE.Float32BufferAttribute(normals, 3));\n  geometry.setAttribute(\"uv\", new THREE.Float32BufferAttribute(uvs, 2));\n  geometry.setIndex(indices);\n\n  geometry.computeVertexNormals();\n\n  return { geometry, wireLength };\n}\n\n// ============================================================================\n// Main Builder Function\n// ============================================================================\n\nexport function buildWaveSpringMeshGeometry(\n  input: WaveSpringGeometryInput\n): WaveSpringGeometryResult {\n  const scale = input.scale ?? 1;\n  const {\n    meanDiameter,\n    innerDiameter,\n    thickness,\n    width,\n    amplitude,\n    waves,\n    turns,\n    phase = 0,\n    radialPitch = 0,\n    axialPitch: inputAxialPitch,\n    totalHeight: inputTotalHeight,\n    stackingMode = \"axial\",\n    nestedLayers,\n    segmentsPerTurn = 220,\n    capEnds = true, // Default true for open helix strip\n    winding = \"CCW\",\n  } = input;\n\n  // Calculate total height: totalHeight takes precedence, then axialPitch * turns, then default\n  // Default: (2 * amplitude + thickness) * turns to show visible helix rise\n  const effectiveTotalHeight = inputTotalHeight\n    ?? (inputAxialPitch ? inputAxialPitch * turns : (2 * amplitude + thickness * 1.5) * turns);\n\n  // Calculate pitch per turn using corrected formula: p = Hf / (Nt + 1)\n  // This accounts for wave amplitude at both ends: Hf ≈ Nt * p + 2A, with p = 2A\n  // Solving: Hf = (Nt + 1) * p\n  const pitchPerTurn = effectiveTotalHeight / (turns + 1);\n\n  // Auto-calculate amplitude for crest-to-valley contact condition: A = p/2\n  // With safety clamp to avoid self-intersection: A <= 0.45 * p or A <= (p - t) / 2\n  const maxSafeAmplitude = Math.min(0.45 * pitchPerTurn, (pitchPerTurn - thickness) / 2);\n  const effectiveAmplitude = Math.min(amplitude, Math.max(0, maxSafeAmplitude));\n\n  // Determine inner/outer radius\n  // If innerDiameter provided, use it; otherwise derive from meanDiameter\n\n\n  // Outer radius: innerRadius + radialPitch * turns\n  // If no radialPitch, outer = inner (constant radius)\n\n\n  let geometry: THREE.BufferGeometry;\n  let totalWireLength = 0;\n\n  // Calculate mean radius\n  const meanRadius = meanDiameter / 2;\n\n  if (stackingMode === \"nested\" && nestedLayers && nestedLayers.length > 0) {\n    // Nested mode: multiple independent layers at different radii\n    const allGeometries: THREE.BufferGeometry[] = [];\n\n    for (let layerIdx = 0; layerIdx < nestedLayers.length; layerIdx++) {\n      const layer = nestedLayers[layerIdx];\n      const layerRadius = meanRadius + layer.radiusOffset;\n\n      const result = buildContinuousHelixGeometry({\n        meanRadius: layerRadius,\n        pitch: pitchPerTurn,\n        amplitude: layer.amplitude ?? effectiveAmplitude,\n        waves: layer.waves ?? waves,\n        turns: 1, // Each nested layer is single turn\n        phase: layer.phase ?? phase,\n        thickness,\n        width,\n        segmentsPerTurn,\n        winding,\n        capEnds,\n      });\n\n      allGeometries.push(result.geometry);\n      totalWireLength += result.wireLength;\n    }\n\n    geometry = allGeometries.length === 1\n      ? allGeometries[0]\n      : mergeBufferGeometries(allGeometries);\n  } else {\n    // Default mode: Continuous helix with sign-flip wave for crest-to-crest contact\n    // z(θ) = (P/2π)*θ + A*sin(Nw*θ)*s(θ), where s(θ) = (-1)^floor(θ/2π)\n    const result = buildContinuousHelixGeometry({\n      meanRadius,\n      pitch: pitchPerTurn,\n      amplitude: effectiveAmplitude,\n      waves,\n      turns,\n      phase,\n      thickness,\n      width,\n      segmentsPerTurn,\n      winding,\n      capEnds,\n    });\n\n    geometry = result.geometry;\n    totalWireLength = result.wireLength;\n  }\n\n  // Apply scale\n  if (scale !== 1) {\n    geometry.scale(scale, scale, scale);\n  }\n\n  geometry.computeBoundingBox();\n  const bbox = geometry.boundingBox!;\n\n  return {\n    geometry,\n    wireLength: totalWireLength,\n    boundingBox: {\n      min: bbox.min.clone(),\n      max: bbox.max.clone(),\n    },\n  };\n}\n\nfunction mergeBufferGeometries(geometries: THREE.BufferGeometry[]): THREE.BufferGeometry {\n  const merged = new THREE.BufferGeometry();\n\n  let totalVertices = 0;\n  for (const g of geometries) {\n    totalVertices += g.getAttribute(\"position\").count;\n  }\n\n  const positions = new Float32Array(totalVertices * 3);\n  const normals = new Float32Array(totalVertices * 3);\n  const uvs = new Float32Array(totalVertices * 2);\n  const indices: number[] = [];\n\n  let vertexOffset = 0;\n\n  for (const g of geometries) {\n    const pos = g.getAttribute(\"position\");\n    const norm = g.getAttribute(\"normal\");\n    const uv = g.getAttribute(\"uv\");\n    const idx = g.getIndex();\n\n    for (let i = 0; i < pos.count * 3; i++) {\n      positions[vertexOffset * 3 + i] = (pos.array as Float32Array)[i];\n    }\n\n    if (norm) {\n      for (let i = 0; i < norm.count * 3; i++) {\n        normals[vertexOffset * 3 + i] = (norm.array as Float32Array)[i];\n      }\n    }\n\n    if (uv) {\n      for (let i = 0; i < uv.count * 2; i++) {\n        uvs[vertexOffset * 2 + i] = (uv.array as Float32Array)[i];\n      }\n    }\n\n    if (idx) {\n      for (let i = 0; i < idx.count; i++) {\n        indices.push((idx.array as Uint16Array | Uint32Array)[i] + vertexOffset);\n      }\n    }\n\n    vertexOffset += pos.count;\n  }\n\n  merged.setAttribute(\"position\", new THREE.Float32BufferAttribute(positions, 3));\n  merged.setAttribute(\"normal\", new THREE.Float32BufferAttribute(normals, 3));\n  merged.setAttribute(\"uv\", new THREE.Float32BufferAttribute(uvs, 2));\n  merged.setIndex(indices);\n\n  return merged;\n}\n\n// ============================================================================\n// Utility Functions\n// ============================================================================\n\nexport function estimateWaveSpringWireLength(input: WaveSpringGeometryInput): number {\n  const { meanDiameter, amplitude, waves, turns } = input;\n  const R = meanDiameter / 2;\n\n  const segments = turns * waves * 64;\n  let length = 0;\n\n  for (let i = 1; i <= segments; i++) {\n    const t0 = ((i - 1) / segments) * turns * 2 * Math.PI;\n    const t1 = (i / segments) * turns * 2 * Math.PI;\n\n    const x0 = R * Math.cos(t0);\n    const y0 = R * Math.sin(t0);\n    const z0 = amplitude * Math.sin(waves * (t0 % (2 * Math.PI)));\n\n    const x1 = R * Math.cos(t1);\n    const y1 = R * Math.sin(t1);\n    const z1 = amplitude * Math.sin(waves * (t1 % (2 * Math.PI)));\n\n    length += Math.sqrt((x1 - x0) ** 2 + (y1 - y0) ** 2 + (z1 - z0) ** 2);\n  }\n\n  return length;\n}\n\nexport function getDefaultWaveSpringGeometryInput(): WaveSpringGeometryInput {\n  return {\n    meanDiameter: 30,\n    thickness: 0.5,\n    width: 5,\n    amplitude: 2.0,\n    waves: 4,\n    turns: 3,\n    phase: 0,\n    scale: 1,\n    stackingMode: \"axial\",\n    segmentsPerTurn: 220,\n    capEnds: false,\n    winding: \"CCW\",\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/springMath.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CompressionSpringDesign' is defined but never used.","line":3,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TorsionSpringDesign' is defined but never used.","line":6,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isCompressionDesign' is defined but never used.","line":7,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isTorsionDesign' is defined but never used.","line":10,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'prevCollapsed' is assigned a value but never used.","line":687,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":687,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { \n  SpringDesign, \n  CompressionSpringDesign,\n  ConicalSpringDesign,\n  ExtensionSpringDesign,\n  TorsionSpringDesign,\n  isCompressionDesign,\n  isConicalDesign,\n  isExtensionDesign,\n  isTorsionDesign,\n  LegacySpringDesign,\n} from \"@/lib/springTypes\";\nimport { \n  getSpringMaterial, \n  type SpringMaterialId \n} from \"@/lib/materials/springMaterials\";\n\nconst PI = Math.PI;\n\n/**\n * Input parameters for extension spring calculations.\n */\nexport interface ExtensionSpringInput {\n  outerDiameter: number;      // OD, mm\n  wireDiameter: number;       // d, mm\n  activeCoils: number;        // Na\n  shearModulus: number;       // G, MPa\n  initialTension?: number;    // Fi, N, optional, defaults to 0\n  workingDeflection: number;  // Δx, mm (extension from free length)\n}\n\n/**\n * Get mean diameter from any spring design type\n * 从任意弹簧设计类型获取中径\n */\nexport function getMeanDiameter(design: SpringDesign | LegacySpringDesign): number {\n  if (\"meanDiameter\" in design && design.meanDiameter) {\n    return design.meanDiameter;\n  }\n  if (isConicalDesign(design as SpringDesign)) {\n    const conical = design as ConicalSpringDesign;\n    // Use average of large and small mean diameters\n    const largeMean = conical.largeOuterDiameter - conical.wireDiameter;\n    const smallMean = conical.smallOuterDiameter - conical.wireDiameter;\n    return (largeMean + smallMean) / 2;\n  }\n  if (isExtensionDesign(design as SpringDesign)) {\n    const ext = design as ExtensionSpringDesign;\n    return ext.meanDiameter ?? (ext.outerDiameter - ext.wireDiameter);\n  }\n  throw new Error(\"Cannot determine mean diameter for this spring design\");\n}\n\n/**\n * Get active coils from any spring design type\n */\nexport function getActiveCoils(design: SpringDesign | LegacySpringDesign): number {\n  return design.activeCoils;\n}\n\n/**\n * Ensures required geometric fields are positive numbers.\n * Serves as a lightweight guard before running engineering approximations.\n */\nfunction validateGeometry(design: SpringDesign | LegacySpringDesign) {\n  if (design.wireDiameter <= 0) {\n    throw new Error(\"wireDiameter must be greater than zero\");\n  }\n  const meanDiameter = getMeanDiameter(design);\n  if (meanDiameter <= 0) {\n    throw new Error(\"meanDiameter must be greater than zero\");\n  }\n  if (design.activeCoils <= 0) {\n    throw new Error(\"activeCoils must be greater than zero\");\n  }\n}\n\n/**\n * Calculates the spring index C = Dm / d.\n *\n * @param design Spring geometry definition.\n * @returns Dimensionless spring index.\n */\nexport function calculateSpringIndex(design: SpringDesign | LegacySpringDesign): number {\n  validateGeometry(design);\n  const meanDiameter = getMeanDiameter(design);\n  return meanDiameter / design.wireDiameter;\n}\n\n/**\n * Calculates the Wahl correction factor based on the spring index.\n *\n * @param design Spring geometry definition.\n * @returns Wahl factor Kw for shear stress correction.\n */\nexport function calculateWahlFactor(design: SpringDesign | LegacySpringDesign): number {\n  const springIndex = calculateSpringIndex(design);\n  // Classical Wahl factor approximation for round-wire compression springs.\n  return (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;\n}\n\n/**\n * Estimates the spring rate k (N/mm) using: k = (G * d^4) / (8 * Dm^3 * Na).\n * Only applicable to compression springs under small deflection.\n *\n * @param design Spring geometry definition.\n * @returns Spring rate in N/mm.\n */\nexport function calculateSpringRate(design: SpringDesign): number {\n  validateGeometry(design);\n\n  if (design.type !== \"compression\") {\n    // Placeholder: torsion/extension require different formulations.\n    return 0;\n  }\n\n  const { shearModulus, wireDiameter, meanDiameter, activeCoils } = design;\n  const numerator = shearModulus * wireDiameter ** 4; // MPa ≈ N/mm²\n  const denominator = 8 * meanDiameter ** 3 * activeCoils;\n\n  return numerator / denominator;\n}\n\n/**\n * Calculates core load and stress values for a given deflection.\n *\n * @param design Spring geometry definition.\n * @param deflection Axial deflection in millimeters.\n * @returns Object containing rate k, load F, shear stress tau, spring index, and Wahl factor.\n */\nexport function calculateLoadAndStress(\n  design: SpringDesign,\n  deflection: number,\n): {\n  k: number;\n  load: number;\n  shearStress: number;\n  springIndex: number;\n  wahlFactor: number;\n} {\n  if (deflection < 0) {\n    throw new Error(\"deflection must be non-negative\");\n  }\n\n  const springIndex = calculateSpringIndex(design);\n  const wahlFactor = calculateWahlFactor(design);\n  const k = calculateSpringRate(design);\n  const meanDiameter = getMeanDiameter(design);\n\n  const load = k * deflection; // N, assuming linear elastic range.\n  const shearStress =\n    wahlFactor * ((8 * load * meanDiameter) / (PI * design.wireDiameter ** 3));\n\n  return { k, load, shearStress, springIndex, wahlFactor };\n}\n\n/**\n * Generates a simple force-deflection curve with uniform steps.\n *\n * @param params Object containing spring design, maximum deflection, and step size.\n * @returns Array of deflection-load pairs.\n */\nexport function generateForceDeflectionCurve(params: {\n  spring: SpringDesign;\n  maxDeflection: number;\n  step: number;\n}): { deflection: number; load: number }[] {\n  const { spring, maxDeflection, step } = params;\n  if (maxDeflection <= 0) {\n    throw new Error(\"maxDeflection must be greater than zero\");\n  }\n  if (step <= 0) {\n    throw new Error(\"step must be greater than zero\");\n  }\n\n  const points: { deflection: number; load: number }[] = [];\n  for (let deflection = 0; deflection <= maxDeflection + 1e-9; deflection += step) {\n    const { load } = calculateLoadAndStress(spring, deflection);\n    points.push({ deflection: Number(deflection.toFixed(6)), load });\n  }\n  return points;\n}\n\nexport type VariablePitchSegment = {\n  coils: number;\n  pitch: number;\n};\n\nexport type VariablePitchSegmentState = {\n  index: number;\n  coils: number;\n  pitch: number;\n  spacing: number;\n  capacity: number;\n  solidCoils: number;\n  status: \"free\" | \"partial\" | \"solid\" | \"invalid\";\n};\n\nexport function calculateVariablePitchCompressionAtDeflection(params: {\n  wireDiameter: number;\n  meanDiameter: number;\n  shearModulus: number;\n  activeCoils0: number;\n  totalCoils: number;\n  freeLength?: number;\n  segments: VariablePitchSegment[];\n  deflection: number;\n}): {\n  activeCoils: number;\n  springRate: number;\n  load: number;\n  springIndex: number;\n  wahlFactor: number;\n  shearStress: number;\n  deltaMax?: number;\n  segmentStates: VariablePitchSegmentState[];\n  issues: string[];\n} {\n  const {\n    wireDiameter,\n    meanDiameter,\n    shearModulus,\n    activeCoils0,\n    totalCoils,\n    freeLength,\n    segments,\n    deflection,\n  } = params;\n\n  const issues: string[] = [];\n\n  if (wireDiameter <= 0) issues.push(\"Wire diameter must be > 0\");\n  if (meanDiameter <= 0) issues.push(\"Mean diameter must be > 0\");\n  if (shearModulus <= 0) issues.push(\"Shear modulus must be > 0\");\n  if (activeCoils0 <= 0) issues.push(\"Active coils must be > 0\");\n  if (totalCoils <= 0) issues.push(\"Total coils must be > 0\");\n  if (deflection < 0) issues.push(\"Deflection must be ≥ 0\");\n\n  const deltaMax =\n    freeLength !== undefined && isFinite(freeLength)\n      ? Math.max(0, freeLength - totalCoils * wireDiameter)\n      : undefined;\n\n  const cleanSegments = segments\n    .map((s) => ({\n      coils: Number(s.coils),\n      pitch: Number(s.pitch),\n    }))\n    .filter((s) => isFinite(s.coils) && isFinite(s.pitch) && s.coils > 0);\n\n  const sumCoils = cleanSegments.reduce((acc, s) => acc + s.coils, 0);\n  if (sumCoils > activeCoils0 + 1e-6) {\n    issues.push(\"Sum of segment coils exceeds active coils Na0\");\n  }\n\n  const remainingCoils = Math.max(0, activeCoils0 - sumCoils);\n  let effectiveSegments = cleanSegments.slice();\n\n  if (remainingCoils > 1e-6) {\n    if (freeLength !== undefined && isFinite(freeLength)) {\n      const solidHeight = totalCoils * wireDiameter;\n      const usedLen = effectiveSegments.reduce((acc, s) => acc + s.coils * s.pitch, 0);\n      const restPitch = (freeLength - solidHeight - usedLen) / remainingCoils;\n      if (isFinite(restPitch) && restPitch > 0) {\n        effectiveSegments = effectiveSegments.concat({ coils: remainingCoils, pitch: restPitch });\n      } else {\n        issues.push(\"Cannot auto-fill remaining coils: free length constraint invalid\");\n      }\n    } else {\n      issues.push(\"Segment coils do not cover Na0 (remaining coils require free length to infer pitch)\");\n    }\n  }\n\n  const segmentStates: VariablePitchSegmentState[] = effectiveSegments.map((s, idx) => {\n    const spacing = s.pitch - wireDiameter;\n    const capacity = spacing > 0 ? s.coils * spacing : 0;\n    return {\n      index: idx,\n      coils: s.coils,\n      pitch: s.pitch,\n      spacing,\n      capacity,\n      solidCoils: 0,\n      status: \"free\",\n    };\n  });\n\n  let activeCoils = activeCoils0;\n  for (const st of segmentStates) {\n    if (st.spacing <= 0) {\n      st.status = \"invalid\";\n      st.solidCoils = st.coils;\n      activeCoils -= st.coils;\n      issues.push(\"One or more segments have pitch ≤ wire diameter (already solid)\");\n    }\n  }\n  activeCoils = Math.max(1e-9, activeCoils);\n\n  const validOrder = segmentStates\n    .map((s, idx) => ({ s, idx }))\n    .filter(({ s }) => s.spacing > 0)\n    .sort((a, b) => a.s.pitch - b.s.pitch);\n\n  const A = (shearModulus * wireDiameter ** 4) / (8 * meanDiameter ** 3);\n  let remaining = deflection;\n  let load = 0;\n\n  for (const { s } of validOrder) {\n    if (remaining <= 1e-12) break;\n\n    const naStart = activeCoils;\n    const maxDefl = s.capacity;\n\n    if (maxDefl <= 0) continue;\n\n    if (remaining >= maxDefl - 1e-12) {\n      const naEnd = Math.max(1e-9, naStart - s.coils);\n      load += A * s.spacing * Math.log(naStart / naEnd);\n      s.solidCoils = s.coils;\n      s.status = \"solid\";\n      activeCoils = naEnd;\n      remaining -= maxDefl;\n      continue;\n    }\n\n    const coilsSolid = remaining / s.spacing;\n    const naEnd = Math.max(1e-9, naStart - coilsSolid);\n    load += A * s.spacing * Math.log(naStart / naEnd);\n    s.solidCoils = coilsSolid;\n    s.status = \"partial\";\n    activeCoils = naEnd;\n    remaining = 0;\n    break;\n  }\n\n  for (const { s } of validOrder) {\n    if (s.status === \"free\") {\n      s.solidCoils = 0;\n    }\n  }\n\n  const springIndex = meanDiameter / wireDiameter;\n  const wahlFactor = (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;\n  const springRate = A / Math.max(1e-9, activeCoils);\n  const shearStress = wahlFactor * ((8 * load * meanDiameter) / (PI * wireDiameter ** 3));\n\n  return {\n    activeCoils,\n    springRate,\n    load,\n    springIndex,\n    wahlFactor,\n    shearStress,\n    deltaMax,\n    segmentStates,\n    issues,\n  };\n}\n\nexport function invertVariablePitchCompressionForce(params: {\n  wireDiameter: number;\n  meanDiameter: number;\n  shearModulus: number;\n  activeCoils0: number;\n  totalCoils: number;\n  freeLength?: number;\n  segments: VariablePitchSegment[];\n  load: number;\n}): {\n  deflection: number;\n  issues: string[];\n} {\n  const { load } = params;\n  const issues: string[] = [];\n  if (load < 0) issues.push(\"Load must be ≥ 0\");\n  if (!isFinite(load)) issues.push(\"Load must be finite\");\n  if (issues.length) return { deflection: 0, issues };\n\n  let lo = 0;\n  let hi = 1;\n  let hiRes = calculateVariablePitchCompressionAtDeflection({ ...params, deflection: hi });\n\n  const deltaMax = hiRes.deltaMax;\n  if (deltaMax !== undefined && deltaMax > 0) {\n    hi = deltaMax;\n    hiRes = calculateVariablePitchCompressionAtDeflection({ ...params, deflection: hi });\n  } else {\n    while (hiRes.load < load && hi < 1e6) {\n      hi *= 2;\n      hiRes = calculateVariablePitchCompressionAtDeflection({ ...params, deflection: hi });\n      if (hiRes.issues.length) break;\n    }\n  }\n\n  if (hiRes.load < load - 1e-9) {\n    issues.push(\"Target load exceeds curve range\");\n    return { deflection: hi, issues };\n  }\n\n  for (let iter = 0; iter < 60; iter++) {\n    const mid = 0.5 * (lo + hi);\n    const res = calculateVariablePitchCompressionAtDeflection({ ...params, deflection: mid });\n    if (res.load >= load) hi = mid;\n    else lo = mid;\n    if (Math.abs(hi - lo) <= 1e-6) break;\n  }\n\n  return { deflection: hi, issues };\n}\n\nexport function generateVariablePitchForceDeflectionCurve(params: {\n  wireDiameter: number;\n  meanDiameter: number;\n  shearModulus: number;\n  activeCoils0: number;\n  totalCoils: number;\n  freeLength?: number;\n  segments: VariablePitchSegment[];\n  maxDeflection: number;\n  step: number;\n}): {\n  deflection: number;\n  load: number;\n  springRate?: number;\n  shearStress?: number;\n  activeCoils?: number;\n}[] {\n  const { maxDeflection, step } = params;\n  if (maxDeflection <= 0 || step <= 0) return [];\n\n  const points: {\n    deflection: number;\n    load: number;\n    springRate?: number;\n    shearStress?: number;\n    activeCoils?: number;\n  }[] = [];\n  for (let deflection = 0; deflection <= maxDeflection + 1e-9; deflection += step) {\n    const res = calculateVariablePitchCompressionAtDeflection({\n      ...params,\n      deflection,\n    });\n    points.push({\n      deflection: Number(deflection.toFixed(6)),\n      load: res.load,\n      springRate: res.springRate,\n      shearStress: res.shearStress,\n      activeCoils: res.activeCoils,\n    });\n  }\n  return points;\n}\n\n/**\n * Calculates spring rate, load, and stress for an extension spring.\n * Uses the same helical spring formula as compression springs for the body coils.\n * Total load = initial tension + k * deflection.\n *\n * @param input Extension spring parameters.\n * @returns Object containing calculated values.\n */\nexport function calculateExtensionSpring(input: ExtensionSpringInput): {\n  meanDiameter: number;\n  springIndex: number;\n  wahlFactor: number;\n  springRate: number;\n  initialTension: number;\n  workingDeflection: number;\n  elasticLoad: number;\n  totalLoad: number;\n  shearStress: number;\n} {\n  const {\n    outerDiameter,\n    wireDiameter,\n    activeCoils,\n    shearModulus,\n    initialTension = 0,\n    workingDeflection,\n  } = input;\n\n  // Validate inputs\n  if (wireDiameter <= 0) {\n    throw new Error(\"Wire diameter must be greater than zero\");\n  }\n  if (outerDiameter <= wireDiameter) {\n    throw new Error(\"Outer diameter must be greater than wire diameter\");\n  }\n  if (activeCoils <= 0) {\n    throw new Error(\"Active coils must be greater than zero\");\n  }\n  if (shearModulus <= 0) {\n    throw new Error(\"Shear modulus must be greater than zero\");\n  }\n  if (workingDeflection < 0) {\n    throw new Error(\"Working deflection must be non-negative\");\n  }\n  if (initialTension < 0) {\n    throw new Error(\"Initial tension must be non-negative\");\n  }\n\n  // Calculate mean diameter: Dm = OD - d\n  const meanDiameter = outerDiameter - wireDiameter;\n\n  // Calculate spring index C = Dm / d\n  const springIndex = meanDiameter / wireDiameter;\n\n  // Calculate Wahl factor\n  const wahlFactor = (4 * springIndex - 1) / (4 * springIndex - 4) + 0.615 / springIndex;\n\n  // Calculate spring rate k = (G * d^4) / (8 * Dm^3 * Na)\n  const springRate = (shearModulus * Math.pow(wireDiameter, 4)) /\n    (8 * Math.pow(meanDiameter, 3) * activeCoils);\n\n  // Calculate loads\n  const elasticLoad = springRate * workingDeflection;\n  const totalLoad = initialTension + elasticLoad;\n\n  // Calculate shear stress using total load\n  // τ = Kw * (8 * F * Dm) / (π * d³)\n  const shearStress = wahlFactor * (8 * totalLoad * meanDiameter) /\n    (PI * Math.pow(wireDiameter, 3));\n\n  return {\n    meanDiameter,\n    springIndex,\n    wahlFactor,\n    springRate,\n    initialTension,\n    workingDeflection,\n    elasticLoad,\n    totalLoad,\n    shearStress,\n  };\n}\n\n/**\n * Input parameters for conical spring nonlinear analysis.\n */\nexport interface ConicalSpringNonlinearInput {\n  wireDiameter: number;        // d, mm\n  largeOuterDiameter: number;  // D1_out, large end outer diameter, mm\n  smallOuterDiameter: number;  // D2_out, small end outer diameter, mm\n  activeCoils: number;         // Na\n  shearModulus: number;        // G, MPa\n  freeLength: number;          // L0, free length, mm\n  maxDeflection: number;       // Maximum deflection to analyze, mm\n  samplePoints?: number;       // Number of curve sample points, default 50\n}\n\n/**\n * A single point on the conical spring nonlinear force-deflection curve.\n */\nexport interface ConicalNonlinearCurvePoint {\n  x: number;            // Current deflection (mm)\n  k: number;            // Current segment stiffness (N/mm)\n  load: number;         // Current load (N)\n  activeCoils: number;  // Coils still participating in deformation\n  collapsedCoils: number; // Number of coils that have bottomed out\n}\n\n/**\n * Result of conical spring nonlinear analysis.\n */\nexport interface ConicalNonlinearResult {\n  curve: ConicalNonlinearCurvePoint[];\n  solidHeight: number;           // H_solid = Na * d\n  totalDeflectionCapacity: number; // X_total = L0 - H_solid\n  pitch: number;                 // Deflection per coil collapse\n  exceededSolidHeight: boolean;  // True if maxDeflection > X_total\n  clampedMaxDeflection: number;  // Actual max deflection used (clamped to X_total)\n}\n\n/**\n * Calculates the nonlinear force-deflection curve for a conical compression spring.\n * \n * Conical springs exhibit nonlinear behavior because as the spring compresses,\n * the larger coils bottom out first (telescope), reducing the effective number\n * of active coils and increasing the instantaneous stiffness.\n * \n * The pitch calculation is based on free length L0:\n * - Solid height H_solid = Na * d\n * - Total deflection capacity X_total = L0 - H_solid\n * - Pitch per coil = X_total / Na\n * \n * @param input Conical spring parameters\n * @returns Result object containing curve points and metadata\n */\nexport function calculateConicalSpringNonlinear(\n  input: ConicalSpringNonlinearInput\n): ConicalNonlinearResult {\n  const {\n    wireDiameter: d,\n    largeOuterDiameter: D1_out,\n    smallOuterDiameter: D2_out,\n    activeCoils: n0,\n    shearModulus: G,\n    freeLength: L0,\n    maxDeflection: maxX,\n    samplePoints = 50,\n  } = input;\n\n  // Validate inputs\n  if (d <= 0) throw new Error(\"Wire diameter must be greater than zero\");\n  if (D1_out <= d) throw new Error(\"Large outer diameter must be greater than wire diameter\");\n  if (D2_out <= d) throw new Error(\"Small outer diameter must be greater than wire diameter\");\n  if (D1_out <= D2_out) throw new Error(\"Large diameter must be greater than small diameter\");\n  if (n0 <= 0) throw new Error(\"Active coils must be greater than zero\");\n  if (n0 < 2) throw new Error(\"Active coils must be at least 2 for nonlinear analysis\");\n  if (G <= 0) throw new Error(\"Shear modulus must be greater than zero\");\n  if (L0 <= 0) throw new Error(\"Free length must be greater than zero\");\n  if (maxX < 0) throw new Error(\"Max deflection must be non-negative\");\n\n  // Calculate mean diameters at each end\n  const D1 = D1_out - d; // Large end mean diameter\n  const D2 = D2_out - d; // Small end mean diameter\n\n  // Calculate solid height: H_solid = Na * d\n  const solidHeight = n0 * d;\n  \n  // Total deflection capacity: X_total = L0 - H_solid\n  const totalDeflectionCapacity = L0 - solidHeight;\n  \n  if (totalDeflectionCapacity <= 0) {\n    throw new Error(\n      `Free length is too short compared to solid height. ` +\n      `L0=${L0}mm, H_solid=${solidHeight.toFixed(2)}mm (Na×d=${n0}×${d}). ` +\n      `自由长度过短，无法压缩。`\n    );\n  }\n\n  // Pitch per coil: deflection needed to collapse one coil\n  // Using Na for equal pitch distribution\n  const pitch = totalDeflectionCapacity / n0;\n\n  // Check if maxDeflection exceeds total capacity\n  const exceededSolidHeight = maxX > totalDeflectionCapacity;\n  \n  // Clamp maxX to not exceed total deflection capacity\n  const effectiveMaxX = Math.min(maxX, totalDeflectionCapacity);\n\n  const curvePoints: ConicalNonlinearCurvePoint[] = [];\n  let cumulativeLoad = 0;\n  let prevCollapsed = 0;\n  let prevX = 0;\n\n  // Sample the deflection range\n  for (let i = 0; i <= samplePoints; i++) {\n    const x = effectiveMaxX * (i / samplePoints);\n\n    // Determine how many coils have collapsed (bottomed out)\n    // Larger coils collapse first in a conical spring\n    let collapsed = Math.floor(x / pitch);\n    collapsed = Math.min(collapsed, n0 - 1); // At least 1 coil must remain active\n\n    // Effective number of active coils\n    const n_eff = n0 - collapsed;\n\n    // Calculate instantaneous stiffness for current active coils\n    // Using conical spring formula: k = G * d^4 / (2 * n * (D1 + D2) * (D1^2 + D2^2))\n    // For progressive collapse, we interpolate the diameters based on which coils remain\n    \n    // As coils collapse, the remaining coils have smaller average diameter\n    // Linear interpolation of mean diameters for remaining coils\n    const collapseRatio = collapsed / n0;\n    const D1_eff = D1 - (D1 - D2) * collapseRatio; // Effective large diameter shrinks\n    const D2_eff = D2; // Small end stays the same\n    \n    // Conical spring stiffness formula\n    const k = (G * Math.pow(d, 4)) / \n      (2 * n_eff * (D1_eff + D2_eff) * (Math.pow(D1_eff, 2) + Math.pow(D2_eff, 2)));\n\n    // Calculate load using piecewise linear approximation\n    if (i > 0) {\n      const deltaX = x - prevX;\n      cumulativeLoad += k * deltaX;\n    }\n\n    curvePoints.push({\n      x: Number(x.toFixed(3)),\n      k: Number(k.toFixed(4)),\n      load: Number(cumulativeLoad.toFixed(3)),\n      activeCoils: n_eff,\n      collapsedCoils: collapsed,\n    });\n\n    prevCollapsed = collapsed;\n    prevX = x;\n  }\n\n  return {\n    curve: curvePoints,\n    solidHeight,\n    totalDeflectionCapacity,\n    pitch,\n    exceededSolidHeight,\n    clampedMaxDeflection: effectiveMaxX,\n  };\n}\n\n/**\n * Extracts the stage transition points from a nonlinear curve.\n * These are the points where coils collapse and stiffness changes.\n */\nexport function extractConicalStageTransitions(\n  curve: ConicalNonlinearCurvePoint[]\n): { stage: number; deflection: number; activeCoils: number; stiffness: number }[] {\n  const stages: { stage: number; deflection: number; activeCoils: number; stiffness: number }[] = [];\n  let prevCollapsed = -1;\n  let stageNum = 0;\n\n  for (const point of curve) {\n    if (point.collapsedCoils !== prevCollapsed) {\n      stages.push({\n        stage: stageNum,\n        deflection: point.x,\n        activeCoils: point.activeCoils,\n        stiffness: point.k,\n      });\n      prevCollapsed = point.collapsedCoils;\n      stageNum++;\n    }\n  }\n\n  return stages;\n}\n\n/**\n * Demo helper to ensure formulas run without throwing at runtime.\n * Useful for quick manual verification until a full test harness is added.\n */\nexport function runSpringMathDemo() {\n  const sampleSpring: SpringDesign = {\n    type: \"compression\",\n    wireDiameter: 3.2,\n    meanDiameter: 24,\n    activeCoils: 8,\n    shearModulus: 79000,\n  };\n\n  const response = calculateLoadAndStress(sampleSpring, 5);\n  const curve = generateForceDeflectionCurve({\n    spring: sampleSpring,\n    maxDeflection: 10,\n    step: 2.5,\n  });\n\n  return { response, curve };\n}\n\n// ============================================================================\n// STRESS CORRECTION, SAFETY FACTOR, AND FATIGUE LIFE CALCULATIONS\n// 应力修正、安全系数和疲劳寿命计算\n// ============================================================================\n\n/**\n * Parameters for stress correction calculation\n * 应力修正计算参数\n */\nexport interface StressCorrectionParams {\n  /** Nominal shear stress (before corrections), MPa */\n  tauNominal: number;\n  /** Wahl curvature correction factor K_w */\n  wahlFactor: number;\n  /** Surface roughness factor K_surface (default 1.0) */\n  surfaceFactor?: number;\n  /** Size factor K_size (default 1.0) */\n  sizeFactor?: number;\n  /** Temperature factor K_temp (default 1.0) */\n  tempFactor?: number;\n}\n\n/**\n * Result of stress correction calculation\n * 应力修正计算结果\n */\nexport interface StressCorrectionResult {\n  /** Original nominal stress, MPa */\n  tauNominal: number;\n  /** Effective stress after all corrections, MPa */\n  tauEffective: number;\n  /** Total correction factor K_total */\n  kTotal: number;\n  /** Individual factors breakdown */\n  factors: {\n    wahl: number;\n    surface: number;\n    size: number;\n    temp: number;\n  };\n}\n\n/**\n * Apply stress correction factors to nominal shear stress\n * 对名义剪应力应用修正系数\n * \n * τ_effective = τ_nominal × K_w × K_surface × K_size × K_temp\n * \n * @param params Stress correction parameters\n * @returns Corrected stress result\n */\nexport function applyStressCorrections(params: StressCorrectionParams): StressCorrectionResult {\n  const { \n    tauNominal, \n    wahlFactor, \n    surfaceFactor = 1.0, \n    sizeFactor = 1.0, \n    tempFactor = 1.0 \n  } = params;\n\n  const kTotal = wahlFactor * surfaceFactor * sizeFactor * tempFactor;\n  const tauEffective = tauNominal * kTotal;\n\n  return {\n    tauNominal,\n    tauEffective,\n    kTotal,\n    factors: {\n      wahl: wahlFactor,\n      surface: surfaceFactor,\n      size: sizeFactor,\n      temp: tempFactor,\n    },\n  };\n}\n\n/**\n * Static safety factor result\n * 静态安全系数结果\n */\nexport interface SafetyFactorResult {\n  materialId: SpringMaterialId;\n  /** Effective shear stress, MPa */\n  tauEffective: number;\n  /** Allowable static shear stress, MPa */\n  tauAllowStatic: number;\n  /** Static safety factor SF = τ_allow / τ_effective */\n  sfStatic: number;\n  /** Safety status */\n  status: \"safe\" | \"warning\" | \"danger\";\n  /** Status description */\n  statusText: {\n    en: string;\n    zh: string;\n  };\n}\n\n/**\n * Calculate static safety factor\n * 计算静态安全系数\n * \n * SF = τ_allow_static / τ_effective\n * \n * @param params Material ID and effective stress\n * @returns Safety factor result with status\n */\nexport function calculateSafetyFactorStatic(params: {\n  materialId: SpringMaterialId;\n  tauEffective: number;\n}): SafetyFactorResult {\n  const material = getSpringMaterial(params.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${params.materialId}`);\n  }\n\n  const tauAllow = material.allowShearStatic;\n  const sf = tauAllow / params.tauEffective;\n\n  let status: SafetyFactorResult[\"status\"];\n  let statusText: SafetyFactorResult[\"statusText\"];\n\n  if (sf >= 1.5) {\n    status = \"safe\";\n    statusText = { en: \"Safe (SF ≥ 1.5)\", zh: \"安全 (SF ≥ 1.5)\" };\n  } else if (sf >= 1.1) {\n    status = \"warning\";\n    statusText = { en: \"Marginal (1.1 ≤ SF < 1.5)\", zh: \"临界 (1.1 ≤ SF < 1.5)\" };\n  } else {\n    status = \"danger\";\n    statusText = { en: \"Unsafe (SF < 1.1)\", zh: \"不安全 (SF < 1.1)\" };\n  }\n\n  return {\n    materialId: material.id,\n    tauEffective: params.tauEffective,\n    tauAllowStatic: tauAllow,\n    sfStatic: sf,\n    status,\n    statusText,\n  };\n}\n\n/**\n * Fatigue life estimation result\n * 疲劳寿命估算结果\n */\nexport interface FatigueLifeResult {\n  materialId: SpringMaterialId;\n  /** Mean stress, MPa */\n  tauMean: number;\n  /** Alternating stress amplitude, MPa */\n  tauAlt: number;\n  /** Estimated fatigue life in cycles */\n  estimatedCycles: number;\n  /** Safety factor relative to infinite life (N2) */\n  sfInfiniteLife: number;\n  /** Life rating */\n  rating: \"infinite\" | \"high\" | \"medium\" | \"low\" | \"very_low\";\n  /** Rating description */\n  ratingText: {\n    en: string;\n    zh: string;\n  };\n}\n\n/**\n * Estimate fatigue life using Basquin equation with simplified Goodman correction\n * 使用 Basquin 方程和简化 Goodman 修正估算疲劳寿命\n * \n * Basquin equation: log(N) = A - m × log(τ_alt)\n * where A and m are derived from S-N curve data points\n * \n * @param params Material ID and stress range\n * @returns Fatigue life estimation result\n */\nexport function estimateFatigueLife(params: {\n  materialId: SpringMaterialId;\n  /** Maximum effective shear stress (with corrections), MPa */\n  tauMax: number;\n  /** Minimum effective shear stress (with corrections), MPa */\n  tauMin: number;\n}): FatigueLifeResult {\n  const material = getSpringMaterial(params.materialId);\n  if (!material) {\n    throw new Error(`Unknown material: ${params.materialId}`);\n  }\n\n  // Calculate mean and alternating stress\n  const tauMean = (params.tauMax + params.tauMin) / 2;\n  const tauAlt = (params.tauMax - params.tauMin) / 2;\n\n  // Get S-N curve data\n  const { N1, tau1, N2, tau2 } = material.snCurve;\n\n  // Basquin equation: log(N) = A - m × log(τ)\n  // Using two points: (N1, tau1) and (N2, tau2)\n  // m = (log(N1) - log(N2)) / (log(tau2) - log(tau1))\n  // A = log(N1) + m × log(tau1)\n  \n  const logN1 = Math.log10(N1);\n  const logN2 = Math.log10(N2);\n  const logTau1 = Math.log10(tau1);\n  const logTau2 = Math.log10(tau2);\n\n  const m = (logN1 - logN2) / (logTau2 - logTau1);\n  const A = logN1 + m * logTau1;\n\n  // Apply simplified Goodman correction for mean stress effect\n  // τ_alt_eff = τ_alt / (1 - τ_mean / τ_uts)\n  const tauUts = material.tensileStrength ?? material.allowShearStatic * 2;\n  const meanStressRatio = Math.min(tauMean / tauUts, 0.9); // Cap at 0.9 to avoid division issues\n  const tauAltEffective = tauAlt / (1 - meanStressRatio);\n\n  // Calculate estimated cycles\n  let estimatedCycles: number;\n  if (tauAltEffective <= 0) {\n    estimatedCycles = Infinity;\n  } else if (tauAltEffective >= tau1) {\n    // Very high stress, extrapolate below N1\n    const logN = A - m * Math.log10(tauAltEffective);\n    estimatedCycles = Math.max(Math.pow(10, logN), 100);\n  } else if (tauAltEffective <= tau2) {\n    // Below endurance limit, infinite life\n    estimatedCycles = Infinity;\n  } else {\n    // Interpolate on S-N curve\n    const logN = A - m * Math.log10(tauAltEffective);\n    estimatedCycles = Math.pow(10, logN);\n  }\n\n  // Safety factor for infinite life (relative to tau2 at N2)\n  const sfInfiniteLife = tau2 / (tauAltEffective || 1);\n\n  // Determine rating\n  let rating: FatigueLifeResult[\"rating\"];\n  let ratingText: FatigueLifeResult[\"ratingText\"];\n\n  if (estimatedCycles >= 1e7 || !isFinite(estimatedCycles)) {\n    rating = \"infinite\";\n    ratingText = { en: \"Infinite Life (N ≥ 10⁷)\", zh: \"无限寿命 (N ≥ 10⁷)\" };\n  } else if (estimatedCycles >= 1e6) {\n    rating = \"high\";\n    ratingText = { en: \"High Cycle (10⁶ ≤ N < 10⁷)\", zh: \"高周疲劳 (10⁶ ≤ N < 10⁷)\" };\n  } else if (estimatedCycles >= 1e5) {\n    rating = \"medium\";\n    ratingText = { en: \"Medium Cycle (10⁵ ≤ N < 10⁶)\", zh: \"中周疲劳 (10⁵ ≤ N < 10⁶)\" };\n  } else if (estimatedCycles >= 1e4) {\n    rating = \"low\";\n    ratingText = { en: \"Low Cycle (10⁴ ≤ N < 10⁵)\", zh: \"低周疲劳 (10⁴ ≤ N < 10⁵)\" };\n  } else {\n    rating = \"very_low\";\n    ratingText = { en: \"Very Low Cycle (N < 10⁴)\", zh: \"极低周疲劳 (N < 10⁴)\" };\n  }\n\n  return {\n    materialId: material.id,\n    tauMean,\n    tauAlt,\n    estimatedCycles: isFinite(estimatedCycles) ? Math.round(estimatedCycles) : Infinity,\n    sfInfiniteLife,\n    rating,\n    ratingText,\n  };\n}\n\n/**\n * Preload calculation result\n * 预紧计算结果\n */\nexport interface PreloadResult {\n  /** Preload deflection, mm */\n  preloadDeflection: number;\n  /** Preload force, N */\n  preloadForce: number;\n  /** Working force at specified deflection, N */\n  workingForce: number;\n  /** Preload ratio (F0 / F_work) */\n  preloadRatio: number;\n}\n\n/**\n * Calculate preload (initial compression/tension)\n * 计算预紧（初压缩/初拉力）\n * \n * @param params Spring rate, preload deflection, and working deflection\n * @returns Preload calculation result\n */\nexport function calculatePreload(params: {\n  /** Spring rate, N/mm */\n  springRate: number;\n  /** Preload deflection x0, mm */\n  preloadDeflection: number;\n  /** Working deflection, mm */\n  workingDeflection: number;\n}): PreloadResult {\n  const { springRate, preloadDeflection, workingDeflection } = params;\n\n  const preloadForce = springRate * preloadDeflection;\n  const workingForce = springRate * workingDeflection;\n  const preloadRatio = workingForce > 0 ? preloadForce / workingForce : 0;\n\n  return {\n    preloadDeflection,\n    preloadForce,\n    workingForce,\n    preloadRatio,\n  };\n}\n\n/**\n * Combined stress analysis result\n * 综合应力分析结果\n */\nexport interface StressAnalysisResult {\n  /** Stress correction result */\n  stressCorrection: StressCorrectionResult;\n  /** Static safety factor result */\n  safetyFactor: SafetyFactorResult;\n  /** Fatigue life result (if min/max stress provided) */\n  fatigueLife?: FatigueLifeResult;\n}\n\n/**\n * Perform complete stress analysis\n * 执行完整应力分析\n * \n * @param params Analysis parameters\n * @returns Combined stress analysis result\n */\nexport function performStressAnalysis(params: {\n  materialId: SpringMaterialId;\n  tauNominal: number;\n  wahlFactor: number;\n  surfaceFactor?: number;\n  sizeFactor?: number;\n  tempFactor?: number;\n  /** For fatigue analysis: minimum stress ratio (τ_min / τ_max) */\n  stressRatio?: number;\n}): StressAnalysisResult {\n  const {\n    materialId,\n    tauNominal,\n    wahlFactor,\n    surfaceFactor,\n    sizeFactor,\n    tempFactor,\n    stressRatio,\n  } = params;\n\n  // Apply stress corrections\n  const stressCorrection = applyStressCorrections({\n    tauNominal,\n    wahlFactor,\n    surfaceFactor,\n    sizeFactor,\n    tempFactor,\n  });\n\n  // Calculate static safety factor\n  const safetyFactor = calculateSafetyFactorStatic({\n    materialId,\n    tauEffective: stressCorrection.tauEffective,\n  });\n\n  // Calculate fatigue life if stress ratio provided\n  let fatigueLife: FatigueLifeResult | undefined;\n  if (stressRatio !== undefined && stressRatio >= 0 && stressRatio < 1) {\n    const tauMax = stressCorrection.tauEffective;\n    const tauMin = tauMax * stressRatio;\n    fatigueLife = estimateFatigueLife({\n      materialId,\n      tauMax,\n      tauMin,\n    });\n  }\n\n  return {\n    stressCorrection,\n    safetyFactor,\n    fatigueLife,\n  };\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/springTypes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/stores/feaStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/stores/springAnalysisStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/stores/springDesignStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/stores/springSimulationStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/stores/stressVisualizationStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/stores/variablePitchCompressionStore.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_get' is defined but never used.","line":107,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":107,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { create } from \"zustand\";\nimport { persist } from \"zustand/middleware\";\n\nimport type { VariablePitchSegment } from \"@/lib/springMath\";\nimport type { SpringMaterialId } from \"@/lib/materials/springMaterials\";\n\nexport type VariablePitchWorkingMode = \"deflection\" | \"load\";\n\nexport type VariablePitchCurveMode =\n  | \"force\"\n  | \"stiffness\"\n  | \"stress\"\n  | \"overlay_force_stress\"\n  | \"overlay_force_stiffness\";\n\nexport interface VariablePitchCompressionState {\n  wireDiameter: number;\n  meanDiameter: number;\n  shearModulus: number;\n  activeCoils0: number;\n  totalCoils: number;\n  freeLength?: number;\n\n  materialId: SpringMaterialId;\n\n  segments: VariablePitchSegment[];\n\n  mode: VariablePitchWorkingMode;\n  deflection: number;\n  load: number;\n\n  chartMode: VariablePitchCurveMode;\n\n  workingPoints: number[];\n\n  setWireDiameter: (v: number) => void;\n  setMeanDiameter: (v: number) => void;\n  setShearModulus: (v: number) => void;\n  setActiveCoils0: (v: number) => void;\n  setTotalCoils: (v: number) => void;\n  setFreeLength: (v: number | undefined) => void;\n\n  setMaterialId: (id: SpringMaterialId) => void;\n\n  setMode: (mode: VariablePitchWorkingMode) => void;\n  setDeflection: (v: number) => void;\n  setLoad: (v: number) => void;\n  setChartMode: (mode: VariablePitchCurveMode) => void;\n\n  setSegmentValue: (index: number, patch: Partial<VariablePitchSegment>) => void;\n  addSegment: () => void;\n  removeSegment: (index: number) => void;\n\n  addWorkingPoint: (suggested?: number) => void;\n  setWorkingPoint: (index: number, v: number) => void;\n  removeWorkingPoint: (index: number) => void;\n\n  reset: () => void;\n}\n\nconst initialState: Omit<\n  VariablePitchCompressionState,\n  | \"setWireDiameter\"\n  | \"setMeanDiameter\"\n  | \"setShearModulus\"\n  | \"setActiveCoils0\"\n  | \"setTotalCoils\"\n  | \"setFreeLength\"\n  | \"setMaterialId\"\n  | \"setMode\"\n  | \"setDeflection\"\n  | \"setLoad\"\n  | \"setChartMode\"\n  | \"setSegmentValue\"\n  | \"addSegment\"\n  | \"removeSegment\"\n  | \"addWorkingPoint\"\n  | \"setWorkingPoint\"\n  | \"removeWorkingPoint\"\n  | \"reset\"\n> = {\n  wireDiameter: 3.2,\n  meanDiameter: 24,\n  shearModulus: 79300,\n  activeCoils0: 8,\n  totalCoils: 10,\n  freeLength: 50,\n\n  materialId: \"music_wire_a228\",\n\n  segments: [\n    { coils: 2, pitch: 6 },\n    { coils: 6, pitch: 8 },\n  ],\n\n  mode: \"deflection\",\n  deflection: 10,\n  load: 0,\n\n  chartMode: \"force\",\n\n  workingPoints: [5, 10, 15],\n};\n\nexport const useVariablePitchCompressionStore = create<VariablePitchCompressionState>()(\n  persist(\n    (set, _get) => ({\n      ...initialState,\n\n      setWireDiameter: (wireDiameter) => set({ wireDiameter }),\n      setMeanDiameter: (meanDiameter) => set({ meanDiameter }),\n      setShearModulus: (shearModulus) => set({ shearModulus }),\n      setActiveCoils0: (activeCoils0) => set({ activeCoils0 }),\n      setTotalCoils: (totalCoils) => set({ totalCoils }),\n      setFreeLength: (freeLength) => set({ freeLength }),\n\n      setMaterialId: (materialId) => set({ materialId }),\n\n      setMode: (mode) => set({ mode }),\n      setDeflection: (deflection) => set({ deflection }),\n      setLoad: (load) => set({ load }),\n      setChartMode: (chartMode) => set({ chartMode }),\n\n      setSegmentValue: (index, patch) =>\n        set((state) => {\n          const next = state.segments.slice();\n          const cur = next[index];\n          if (!cur) return state;\n          next[index] = {\n            coils: patch.coils ?? cur.coils,\n            pitch: patch.pitch ?? cur.pitch,\n          };\n          return { segments: next };\n        }),\n\n      addSegment: () =>\n        set((state) => ({\n          segments: state.segments.concat({ coils: 1, pitch: Math.max(0, state.wireDiameter + 1) }),\n        })),\n\n      removeSegment: (index) =>\n        set((state) => ({\n          segments: state.segments.filter((_, i) => i !== index),\n        })),\n\n      addWorkingPoint: (suggested) =>\n        set((state) => {\n          const next = state.workingPoints.slice();\n          const candidate = typeof suggested === \"number\" && isFinite(suggested) ? suggested : state.deflection;\n          next.push(Number(candidate.toFixed(2)));\n          return { workingPoints: next };\n        }),\n\n      setWorkingPoint: (index, v) =>\n        set((state) => {\n          const next = state.workingPoints.slice();\n          next[index] = v;\n          return { workingPoints: next };\n        }),\n\n      removeWorkingPoint: (index) =>\n        set((state) => ({\n          workingPoints: state.workingPoints.filter((_, i) => i !== index),\n        })),\n\n      reset: () => set({ ...initialState }),\n    }),\n    {\n      name: \"variable-pitch-compression-storage\",\n      partialize: (state) => ({\n        wireDiameter: state.wireDiameter,\n        meanDiameter: state.meanDiameter,\n        shearModulus: state.shearModulus,\n        activeCoils0: state.activeCoils0,\n        totalCoils: state.totalCoils,\n        freeLength: state.freeLength,\n        materialId: state.materialId,\n        segments: state.segments,\n        mode: state.mode,\n        deflection: state.deflection,\n        load: state.load,\n        chartMode: state.chartMode,\n        workingPoints: state.workingPoints,\n      }),\n    }\n  )\n);\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/suspensionSpring/analysis.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'wireDiameter_mm' is assigned a value but never used.","line":86,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'shearModulus_G_MPa' is assigned a value but never used.","line":87,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":87,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'meanDiameter' is assigned a value but never used.","line":92,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":92,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'compressedHeight' is assigned a value but never used.","line":101,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'wireDiameter_mm' is assigned a value but never used.","line":233,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":233,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'activeCoils_Na' is assigned a value but never used.","line":233,"column":56,"nodeType":null,"messageId":"unusedVar","endLine":233,"endColumn":70},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'solidMargin_mm' is assigned a value but never used.","line":235,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":235,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Suspension Spring Engineering Analysis\n * 减震器弹簧工程分析模块\n * \n * Layer 0: Quick analytic check\n * Layer 1: k(x) nonlinear stiffness curve with coil contact detection\n * Layer 3: Fatigue estimation (Goodman/Gerber)\n */\n\nimport type { SuspensionSpringInput, SuspensionSpringResult } from \"./types\";\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface KxPoint {\n    /** Deflection (mm) */\n    x: number;\n    /** Spring rate at this deflection (N/mm) */\n    k: number;\n    /** Number of effective active coils at this deflection */\n    activeCoilsEff: number;\n    /** Whether any coil contact has occurred */\n    hasContact: boolean;\n}\n\nexport interface CoilContactInfo {\n    /** Deflection at which first contact occurs (mm) */\n    onsetDeflection: number;\n    /** Approximate coil index where contact starts (0-based) */\n    coilIndex: number;\n    /** Fraction of total travel at onset */\n    onsetFraction: number;\n}\n\nexport interface FatigueResult {\n    /** Analysis method */\n    method: \"goodman\" | \"gerber\";\n    /** Mean stress (MPa) */\n    meanStress: number;\n    /** Alternating stress (MPa) */\n    altStress: number;\n    /** Safety factor based on fatigue */\n    fatigueSF: number;\n    /** Life classification */\n    lifeClass: \"high\" | \"mid\" | \"low\" | \"fail\";\n    /** Estimated cycles (rough) */\n    estimatedCycles?: number;\n}\n\nexport interface SuspensionAnalysisResult {\n    /** k(x) curve points */\n    kxCurve: KxPoint[];\n    /** Coil contact detection */\n    contactInfo?: CoilContactInfo;\n    /** Fatigue assessment based on Ride ↔ Bump cycle */\n    fatigue?: FatigueResult;\n    /** Summary KPIs */\n    summary: {\n        kFree: number;       // Initial spring rate\n        kBump: number;       // Rate at bump (may be higher due to contact)\n        maxStress: number;   // Max shear stress at bump\n        sfBump: number;      // Safety factor at bump\n        coilBindMargin: number; // mm clearance at bump\n        bucklingRatio: number;  // L0 / Dm\n    };\n}\n\n// ============================================================================\n// k(x) Curve Computation\n// ============================================================================\n\n/**\n * Compute the k(x) stiffness curve for a suspension spring\n * \n * This models the nonlinear stiffness that occurs when:\n * 1. Variable pitch causes some coils to contact before others\n * 2. Dead coils don't contribute to deflection\n */\nexport function computeKxCurve(\n    input: SuspensionSpringInput,\n    result: SuspensionSpringResult,\n    steps: number = 20\n): KxPoint[] {\n    const {\n        geometry: { wireDiameter_mm, activeCoils_Na, freeLength_Hf_mm },\n        material: { shearModulus_G_MPa },\n    } = input;\n\n    const solidHeight = result.derived.solidHeight_Hs_mm;\n    const maxDeflection = freeLength_Hf_mm - solidHeight;\n    const meanDiameter = result.derived.meanDiameter_mm;\n\n    // Base spring rate (linear approximation)\n    const kBase = result.springRate_N_per_mm;\n\n    const points: KxPoint[] = [];\n\n    for (let i = 0; i <= steps; i++) {\n        const x = (i / steps) * maxDeflection;\n        const compressedHeight = freeLength_Hf_mm - x;\n\n        // Estimate effective active coils at this deflection\n        // As spring compresses, variable pitch means some coils may \"close\"\n        // before others, reducing effective Na\n\n        // Simple model: if pitch at any point < 1.1 * d, that coil is \"dead\"\n        // For uniform pitch, this happens near solid height\n        // For variable pitch, end coils close first\n\n        const compressionRatio = x / maxDeflection;\n\n        // Model: Na_eff starts at activeCoils and decreases as we approach solid\n        // This is a simplification - real behavior depends on pitch profile\n        let naEff = activeCoils_Na;\n        let hasContact = false;\n\n        // Crude contact model: after 60% compression, start losing coils\n        if (compressionRatio > 0.6) {\n            const lostCoils = (compressionRatio - 0.6) / 0.4 * (activeCoils_Na * 0.3);\n            naEff = Math.max(activeCoils_Na * 0.7, activeCoils_Na - lostCoils);\n            hasContact = true;\n        }\n\n        // Adjusted spring rate: k ∝ 1/Na\n        // As Na decreases, k increases\n        const kAdj = kBase * (activeCoils_Na / naEff);\n\n        points.push({\n            x,\n            k: kAdj,\n            activeCoilsEff: naEff,\n            hasContact,\n        });\n    }\n\n    return points;\n}\n\n/**\n * Detect when coil contact first occurs\n */\nexport function detectCoilContact(\n    kxCurve: KxPoint[],\n    maxDeflection: number\n): CoilContactInfo | undefined {\n    const contactPoint = kxCurve.find(p => p.hasContact);\n    if (!contactPoint) return undefined;\n\n    return {\n        onsetDeflection: contactPoint.x,\n        coilIndex: 0, // Simplified - would need pitch profile for accurate detection\n        onsetFraction: contactPoint.x / maxDeflection,\n    };\n}\n\n// ============================================================================\n// Fatigue Analysis\n// ============================================================================\n\n/**\n * Estimate fatigue life based on Ride ↔ Bump stress cycle\n * Uses Goodman criterion by default\n */\nexport function estimateFatigue(\n    stressRide: number,\n    stressBump: number,\n    yieldStrength: number,\n    tensileStrength?: number,\n    method: \"goodman\" | \"gerber\" = \"goodman\"\n): FatigueResult {\n    // Mean and alternating stress\n    const meanStress = (stressRide + stressBump) / 2;\n    const altStress = Math.abs(stressBump - stressRide) / 2;\n\n    // Tensile strength estimate if not provided (common for spring steel)\n    const Su = tensileStrength ?? yieldStrength * 1.15;\n\n    // Endurance limit estimate (for steel springs, typically 0.4-0.5 Su)\n    const Se = Su * 0.45;\n\n    // Fatigue safety factor\n    let fatigueSF: number;\n\n    if (method === \"goodman\") {\n        // Goodman: σa/Se + σm/Su = 1/SF\n        fatigueSF = 1 / (altStress / Se + meanStress / Su);\n    } else {\n        // Gerber: (σa/Se) + (σm/Su)² = 1/SF  (more conservative for ductile materials)\n        fatigueSF = 1 / (altStress / Se + (meanStress / Su) ** 2);\n    }\n\n    // Life classification\n    let lifeClass: FatigueResult[\"lifeClass\"];\n    let estimatedCycles: number | undefined;\n\n    if (fatigueSF >= 1.5) {\n        lifeClass = \"high\";\n        estimatedCycles = 1e7; // Essentially infinite life\n    } else if (fatigueSF >= 1.0) {\n        lifeClass = \"mid\";\n        estimatedCycles = 1e5;\n    } else if (fatigueSF >= 0.7) {\n        lifeClass = \"low\";\n        estimatedCycles = 1e4;\n    } else {\n        lifeClass = \"fail\";\n        estimatedCycles = 1000;\n    }\n\n    return {\n        method,\n        meanStress,\n        altStress,\n        fatigueSF,\n        lifeClass,\n        estimatedCycles,\n    };\n}\n\n// ============================================================================\n// Main Analysis Entry Point\n// ============================================================================\n\n/**\n * Run complete suspension spring engineering analysis\n */\nexport function runSuspensionAnalysis(\n    input: SuspensionSpringInput,\n    result: SuspensionSpringResult\n): SuspensionAnalysisResult {\n    const {\n        geometry: { wireDiameter_mm, freeLength_Hf_mm, activeCoils_Na },\n        material: { yieldStrength_MPa },\n        loadcase: { solidMargin_mm },\n    } = input;\n\n    const Dm = result.derived.meanDiameter_mm;\n    const Hs = result.derived.solidHeight_Hs_mm;\n    const maxDeflection = freeLength_Hf_mm - Hs;\n\n    // 1. Compute k(x) curve\n    const kxCurve = computeKxCurve(input, result);\n\n    // 2. Detect coil contact\n    const contactInfo = detectCoilContact(kxCurve, maxDeflection);\n\n    // 3. Fatigue analysis (Ride ↔ Bump)\n    const stressRide = result.stress.tauRide_MPa;\n    const stressBump = result.stress.tauBump_MPa;\n    const fatigue = estimateFatigue(stressRide, stressBump, yieldStrength_MPa);\n\n    // 4. Summary KPIs\n    const bumpHeight = result.bumpHeight_mm;\n    const coilBindMargin = bumpHeight - Hs;\n\n    const summary = {\n        kFree: result.springRate_N_per_mm,\n        kBump: kxCurve.length > 0 ? kxCurve[kxCurve.length - 1].k : result.springRate_N_per_mm,\n        maxStress: stressBump,\n        sfBump: result.stress.yieldSafetyFactor_bump,\n        coilBindMargin,\n        bucklingRatio: freeLength_Hf_mm / Dm,\n    };\n\n    return {\n        kxCurve,\n        contactInfo,\n        fatigue,\n        summary,\n    };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/suspensionSpring/designRules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/suspensionSpring/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/suspensionSpring/math.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/suspensionSpring/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/three/previewTheme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/variablePitch/advanced.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/variablePitch/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/waveSpring/__tests__/waveSpringRegression.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/waveSpring/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/src/lib/waveSpring/math.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/markying/CascadeProjects/isri-shuangdi-spring-platform/vitest.config.mts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
